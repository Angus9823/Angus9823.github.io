<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>å¹¶å‘ç¼–ç¨‹ | AngusğŸ¥</title><meta name="keywords" content="å¹¶å‘ç¼–ç¨‹"><meta name="author" content="AngusğŸ¥"><meta name="copyright" content="AngusğŸ¥"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="ã€å¹¶å‘ç¼–ç¨‹ã€‘">
<meta property="og:type" content="article">
<meta property="og:title" content="å¹¶å‘ç¼–ç¨‹">
<meta property="og:url" content="https://angus9823.github.io/posts/498cfd8e.html">
<meta property="og:site_name" content="AngusğŸ¥">
<meta property="og:description" content="ã€å¹¶å‘ç¼–ç¨‹ã€‘">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/TheCoverOfTheArticle/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230323110423.jpg">
<meta property="article:published_time" content="2025-09-30T03:33:07.000Z">
<meta property="article:modified_time" content="2025-09-30T06:12:34.989Z">
<meta property="article:author" content="AngusğŸ¥">
<meta property="article:tag" content="å¹¶å‘ç¼–ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/TheCoverOfTheArticle/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230323110423.jpg"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://angus9823.github.io/posts/498cfd8e"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"var(--theme-color)","bgDark":"#191919","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'å¹¶å‘ç¼–ç¨‹',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-30 14:12:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="AngusğŸ¥" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/favicon.jpg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">19</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">AngusğŸ¥</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">å¹¶å‘ç¼–ç¨‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2025-09-30T03:33:07.000Z" title="å‘è¡¨äº 2025-09-30 11:33:07">2025-09-30</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-09-30T06:12:34.989Z" title="æ›´æ–°äº 2025-09-30 14:12:34">2025-09-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">å¹¶å‘ç¼–ç¨‹</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">11.1w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>422åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="å¹¶å‘ç¼–ç¨‹"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>JUC</h1>
<h2 id="è¿›ç¨‹">è¿›ç¨‹</h2>
<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>
<p>è¿›ç¨‹ï¼šç¨‹åºæ˜¯é™æ­¢çš„ï¼Œè¿›ç¨‹å®ä½“çš„è¿è¡Œè¿‡ç¨‹å°±æ˜¯è¿›ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œ<strong>èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½</strong></p>
<p>è¿›ç¨‹çš„ç‰¹å¾ï¼šå¹¶å‘æ€§ã€å¼‚æ­¥æ€§ã€åŠ¨æ€æ€§ã€ç‹¬ç«‹æ€§ã€ç»“æ„æ€§</p>
<p><strong>çº¿ç¨‹</strong>ï¼šçº¿ç¨‹æ˜¯å±äºè¿›ç¨‹çš„ï¼Œæ˜¯ä¸€ä¸ªåŸºæœ¬çš„ CPU æ‰§è¡Œå•å…ƒï¼Œæ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•å…ƒã€‚çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯ç³»ç»Ÿ<strong>ç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½</strong>ï¼Œçº¿ç¨‹æœ¬èº«ä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œåªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æºï¼Œä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æº</p>
<p>å…³ç³»ï¼šä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹ï¼Œæ¯”å¦‚çœ‹è§†é¢‘æ˜¯è¿›ç¨‹ï¼Œå›¾ç”»ã€å£°éŸ³ã€å¹¿å‘Šç­‰å°±æ˜¯å¤šä¸ªçº¿ç¨‹</p>
<p>çº¿ç¨‹çš„ä½œç”¨ï¼šä½¿å¤šé“ç¨‹åºæ›´å¥½çš„å¹¶å‘æ‰§è¡Œï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡å’Œç³»ç»Ÿååé‡ï¼Œå¢å¼ºæ“ä½œç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½</p>
<p>å¹¶å‘å¹¶è¡Œï¼š</p>
<ul>
<li>å¹¶è¡Œï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªæŒ‡ä»¤åœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶æ‰§è¡Œ</li>
<li>å¹¶å‘ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªæŒ‡ä»¤åœ¨å•ä¸ª CPU ä¸Šäº¤æ›¿æ‰§è¡Œ</li>
</ul>
<p>åŒæ­¥å¼‚æ­¥ï¼š</p>
<ul>
<li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li>
<li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16J411h7Rd">https://www.bilibili.com/video/BV16J411h7Rd</a></p>
<p>ç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†</p>
<hr>
<h3 id="å¯¹æ¯”">å¯¹æ¯”</h3>
<p>çº¿ç¨‹è¿›ç¨‹å¯¹æ¯”ï¼š</p>
<ul>
<li>
<p>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†</p>
</li>
<li>
<p>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶<strong>å†…éƒ¨çš„çº¿ç¨‹å…±äº«</strong></p>
</li>
<li>
<p>è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚</p>
<p>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸º IPCï¼ˆInter-process communicationï¼‰</p>
<ul>
<li>ä¿¡å·é‡ï¼šä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºå¤šè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œè§£å†³åŒæ­¥ç›¸å…³çš„é—®é¢˜å¹¶é¿å…ç«äº‰æ¡ä»¶</li>
<li>å…±äº«å­˜å‚¨ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œéœ€è¦ä½¿ç”¨ä¿¡å·é‡ç”¨æ¥åŒæ­¥å¯¹å…±äº«å­˜å‚¨çš„è®¿é—®</li>
<li>ç®¡é“é€šä¿¡ï¼šç®¡é“æ˜¯ç”¨äºè¿æ¥ä¸€ä¸ªè¯»è¿›ç¨‹å’Œä¸€ä¸ªå†™è¿›ç¨‹ä»¥å®ç°å®ƒä»¬ä¹‹é—´é€šä¿¡çš„ä¸€ä¸ªå…±äº«æ–‡ä»¶ pipe æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®ï¼Œæ‰€ä»¥åªæ”¯æŒ<strong>åŠåŒå·¥é€šä¿¡</strong>
<ul>
<li>åŒ¿åç®¡é“ï¼ˆPipesï¼‰ï¼šç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„çˆ¶å­è¿›ç¨‹é—´æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</li>
<li>å‘½åç®¡é“ï¼ˆNames Pipesï¼‰ï¼šä»¥ç£ç›˜æ–‡ä»¶çš„æ–¹å¼å­˜åœ¨ï¼Œå¯ä»¥å®ç°æœ¬æœºä»»æ„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡ï¼Œéµå¾ª FIFO</li>
</ul>
</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­å­˜å‚¨æ¶ˆæ¯çš„é“¾è¡¨ï¼Œç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ï¼Œèƒ½åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´æä¾›<strong>å…¨åŒå·¥é€šä¿¡</strong>ï¼Œå¯¹æ¯”ç®¡é“ï¼š
<ul>
<li>åŒ¿åç®¡é“å­˜åœ¨äºå†…å­˜ä¸­çš„æ–‡ä»¶ï¼›å‘½åç®¡é“å­˜åœ¨äºå®é™…çš„ç£ç›˜ä»‹è´¨æˆ–è€…æ–‡ä»¶ç³»ç»Ÿï¼›æ¶ˆæ¯é˜Ÿåˆ—å­˜æ”¾åœ¨å†…æ ¸ä¸­ï¼Œåªæœ‰åœ¨å†…æ ¸é‡å¯ï¼ˆæ“ä½œç³»ç»Ÿé‡å¯ï¼‰æˆ–è€…æ˜¾ç¤ºåœ°åˆ é™¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—æ‰è¢«çœŸæ­£åˆ é™¤</li>
<li>è¯»è¿›ç¨‹å¯ä»¥æ ¹æ®æ¶ˆæ¯ç±»å‹æœ‰é€‰æ‹©åœ°æ¥æ”¶æ¶ˆæ¯ï¼Œè€Œä¸åƒ FIFO é‚£æ ·åªèƒ½é»˜è®¤åœ°æ¥æ”¶</li>
</ul>
</li>
</ul>
<p>ä¸åŒè®¡ç®—æœºä¹‹é—´çš„<strong>è¿›ç¨‹é€šä¿¡</strong>ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚ HTTP</p>
<ul>
<li>å¥—æ¥å­—ï¼šä¸å…¶å®ƒé€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå¯ç”¨äºä¸åŒæœºå™¨é—´çš„äº’ç›¸é€šä¿¡</li>
</ul>
</li>
<li>
<p>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºçº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡</p>
<p><strong>Java ä¸­çš„é€šä¿¡æœºåˆ¶</strong>ï¼švolatileã€ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€join æ–¹å¼ã€InheritableThreadLocalã€MappedByteBuffer</p>
</li>
<li>
<p>çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½</p>
</li>
</ul>
<hr>
<h2 id="çº¿ç¨‹">çº¿ç¨‹</h2>
<h3 id="åˆ›å»ºçº¿ç¨‹">åˆ›å»ºçº¿ç¨‹</h3>
<h4 id="Thread">Thread</h4>
<p>Thread åˆ›å»ºçº¿ç¨‹æ–¹å¼ï¼šåˆ›å»ºçº¿ç¨‹ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»æ–¹å¼</p>
<ul>
<li><strong>start() æ–¹æ³•åº•å±‚å…¶å®æ˜¯ç»™ CPU æ³¨å†Œå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”è§¦å‘ run() æ–¹æ³•æ‰§è¡Œ</strong></li>
<li>çº¿ç¨‹çš„å¯åŠ¨å¿…é¡»è°ƒç”¨ start() æ–¹æ³•ï¼Œå¦‚æœçº¿ç¨‹ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Œç›¸å½“äºå˜æˆäº†æ™®é€šç±»çš„æ‰§è¡Œï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹å°†åªæœ‰æ‰§è¡Œè¯¥çº¿ç¨‹</li>
<li>å»ºè®®çº¿ç¨‹å…ˆåˆ›å»ºå­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹çš„ä»»åŠ¡æ”¾åœ¨ä¹‹åï¼Œå¦åˆ™ä¸»çº¿ç¨‹ï¼ˆmainï¼‰æ°¸è¿œæ˜¯å…ˆæ‰§è¡Œå®Œ</li>
</ul>
<p>Thread æ„é€ å™¨ï¼š</p>
<ul>
<li><code>public Thread()</code></li>
<li><code>public Thread(String name)</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">        t.start();</span><br><span class="line">       	<span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">100</span> ; i++ )&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;mainçº¿ç¨‹&quot;</span> + i)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// mainçº¿ç¨‹è¾“å‡ºæ”¾åœ¨ä¸Šé¢ å°±å˜æˆæœ‰å…ˆåé¡ºåºäº†ï¼Œå› ä¸ºæ˜¯ main çº¿ç¨‹é©±åŠ¨çš„å­çº¿ç¨‹è¿è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">100</span> ; i++ ) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å­çº¿ç¨‹è¾“å‡ºï¼š&quot;</span>+i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§æ‰¿ Thread ç±»çš„ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç¼–ç ç®€å•</li>
<li>ç¼ºç‚¹ï¼šçº¿ç¨‹ç±»å·²ç»ç»§æ‰¿äº† Thread ç±»æ— æ³•ç»§æ‰¿å…¶ä»–ç±»äº†ï¼ŒåŠŸèƒ½ä¸èƒ½é€šè¿‡ç»§æ‰¿æ‹“å±•ï¼ˆå•ç»§æ‰¿çš„å±€é™æ€§ï¼‰</li>
</ul>
<hr>
<h4 id="Runnable">Runnable</h4>
<p>Runnable åˆ›å»ºçº¿ç¨‹æ–¹å¼ï¼šåˆ›å»ºçº¿ç¨‹ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»æ–¹å¼</p>
<p>Thread çš„æ„é€ å™¨ï¼š</p>
<ul>
<li><code>public Thread(Runnable target)</code></li>
<li><code>public Thread(Runnable target, String name)</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRunnable</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target,<span class="string">&quot;1å·çº¿ç¨‹&quot;</span>);</span><br><span class="line">		t1.start();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target);<span class="comment">//Thread-0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++ )&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;-&gt;&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Thread ç±»æœ¬èº«ä¹Ÿæ˜¯å®ç°äº† Runnable æ¥å£</strong>ï¼ŒThread ç±»ä¸­æŒæœ‰ Runnable çš„å±æ€§ï¼Œæ‰§è¡Œçº¿ç¨‹ run æ–¹æ³•åº•å±‚æ˜¯è°ƒç”¨ Runnable#runï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Runnable target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">          	<span class="comment">// åº•å±‚è°ƒç”¨çš„æ˜¯ Runnable çš„ run æ–¹æ³•</span></span><br><span class="line">            target.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Runnable æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li>
<p>ç¼ºç‚¹ï¼šä»£ç å¤æ‚ä¸€ç‚¹ã€‚</p>
</li>
<li>
<p>ä¼˜ç‚¹ï¼š</p>
<ol>
<li>
<p>çº¿ç¨‹ä»»åŠ¡ç±»åªæ˜¯å®ç°äº† Runnable æ¥å£ï¼Œå¯ä»¥ç»§ç»­ç»§æ‰¿å…¶ä»–ç±»ï¼Œé¿å…äº†å•ç»§æ‰¿çš„å±€é™æ€§</p>
</li>
<li>
<p>åŒä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å¯¹è±¡å¯ä»¥è¢«åŒ…è£…æˆå¤šä¸ªçº¿ç¨‹å¯¹è±¡</p>
</li>
<li>
<p>é€‚åˆå¤šä¸ªå¤šä¸ªçº¿ç¨‹å»å…±äº«åŒä¸€ä¸ªèµ„æº</p>
</li>
<li>
<p>å®ç°è§£è€¦æ“ä½œï¼Œçº¿ç¨‹ä»»åŠ¡ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œçº¿ç¨‹ä»»åŠ¡ä»£ç å’Œçº¿ç¨‹ç‹¬ç«‹</p>
</li>
<li>
<p>çº¿ç¨‹æ± å¯ä»¥æ”¾å…¥å®ç° Runnable æˆ– Callable çº¿ç¨‹ä»»åŠ¡å¯¹è±¡</p>
</li>
</ol>
</li>
</ul>
<hr>
<h4 id="Callable">Callable</h4>
<p>å®ç° Callable æ¥å£ï¼š</p>
<ol>
<li>å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ç±»å®ç° Callable æ¥å£ï¼Œç”³æ˜çº¿ç¨‹æ‰§è¡Œçš„ç»“æœç±»å‹</li>
<li>é‡å†™çº¿ç¨‹ä»»åŠ¡ç±»çš„ call æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç›´æ¥è¿”å›æ‰§è¡Œçš„ç»“æœ</li>
<li>åˆ›å»ºä¸€ä¸ª Callable çš„çº¿ç¨‹ä»»åŠ¡å¯¹è±¡</li>
<li>æŠŠ Callable çš„çº¿ç¨‹ä»»åŠ¡å¯¹è±¡<strong>åŒ…è£…æˆä¸€ä¸ªæœªæ¥ä»»åŠ¡å¯¹è±¡</strong></li>
<li>æŠŠæœªæ¥ä»»åŠ¡å¯¹è±¡åŒ…è£…æˆçº¿ç¨‹å¯¹è±¡</li>
<li>è°ƒç”¨çº¿ç¨‹çš„ start() æ–¹æ³•å¯åŠ¨çº¿ç¨‹</li>
</ol>
<p><code>public FutureTask(Callable&lt;V&gt; callable)</code>ï¼šæœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œå®Œåå¾—åˆ°çº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p>
<ul>
<li>FutureTask å°±æ˜¯ Runnable å¯¹è±¡ï¼Œå› ä¸º <strong>Thread ç±»åªèƒ½æ‰§è¡Œ Runnable å®ä¾‹çš„ä»»åŠ¡å¯¹è±¡</strong>ï¼Œæ‰€ä»¥æŠŠ Callable åŒ…è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡</li>
<li>çº¿ç¨‹æ± éƒ¨åˆ†è¯¦è§£äº† FutureTask çš„æºç </li>
</ul>
<p><code>public V get()</code>ï¼šåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœï¼Œå¦‚æœåœ¨çº¿ç¨‹ä¸­è·å–å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æœï¼Œä¼šé˜»å¡ç­‰å¾…ï¼Œç”¨äºçº¿ç¨‹åŒæ­¥</p>
<ul>
<li>get() çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</li>
<li>run() æ‰§è¡Œå®Œåä¼šæŠŠç»“æœè®¾ç½®åˆ° FutureTask çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œget() çº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥å˜é‡çš„å€¼</li>
</ul>
<p>ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šåŒ Runnableï¼Œå¹¶ä¸”èƒ½å¾—åˆ°çº¿ç¨‹æ‰§è¡Œçš„ç»“æœ</li>
<li>ç¼ºç‚¹ï¼šç¼–ç å¤æ‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Callable</span> <span class="variable">call</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyCallable</span>();</span><br><span class="line">        FutureTask&lt;String&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(call);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task);</span><br><span class="line">        t.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> task.get(); <span class="comment">// è·å–callæ–¹æ³•è¿”å›çš„ç»“æœï¼ˆæ­£å¸¸/å¼‚å¸¸ç»“æœï¼‰</span></span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallable</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//é‡å†™çº¿ç¨‹ä»»åŠ¡ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName() + <span class="string">&quot;-&gt;&quot;</span> + <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="çº¿ç¨‹æ–¹æ³•">çº¿ç¨‹æ–¹æ³•</h3>
<h4 id="API">API</h4>
<p>Thread ç±» APIï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public void start()</td>
<td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ŒJava è™šæ‹Ÿæœºè°ƒç”¨æ­¤çº¿ç¨‹çš„ run æ–¹æ³•</td>
</tr>
<tr>
<td>public void run()</td>
<td>çº¿ç¨‹å¯åŠ¨åè°ƒç”¨è¯¥æ–¹æ³•</td>
</tr>
<tr>
<td>public void setName(String name)</td>
<td>ç»™å½“å‰çº¿ç¨‹å–åå­—</td>
</tr>
<tr>
<td>public void getName()</td>
<td>è·å–å½“å‰çº¿ç¨‹çš„åå­—<br />çº¿ç¨‹å­˜åœ¨é»˜è®¤åç§°ï¼šå­çº¿ç¨‹æ˜¯ Thread-ç´¢å¼•ï¼Œä¸»çº¿ç¨‹æ˜¯ main</td>
</tr>
<tr>
<td>public static Thread currentThread()</td>
<td>è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œä»£ç åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</td>
</tr>
<tr>
<td>public static void sleep(long time)</td>
<td>è®©å½“å‰çº¿ç¨‹ä¼‘çœ å¤šå°‘æ¯«ç§’å†ç»§ç»­æ‰§è¡Œ<br /><strong>Thread.sleep(0)</strong> : è®©æ“ä½œç³»ç»Ÿç«‹åˆ»é‡æ–°è¿›è¡Œä¸€æ¬¡ CPU ç«äº‰</td>
</tr>
<tr>
<td>public static native void yield()</td>
<td>æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨</td>
</tr>
<tr>
<td>public final int getPriority()</td>
<td>è¿”å›æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td>public final void setPriority(int priority)</td>
<td>æ›´æ”¹æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¸¸ç”¨ 1 5 10</td>
</tr>
<tr>
<td>public void interrupt()</td>
<td>ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</td>
</tr>
<tr>
<td>public static boolean interrupted()</td>
<td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</td>
</tr>
<tr>
<td>public boolean isInterrupted()</td>
<td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°</td>
</tr>
<tr>
<td>public final void join()</td>
<td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</td>
</tr>
<tr>
<td>public final void join(long millis)</td>
<td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ­»äº¡ millis æ¯«ç§’ï¼Œ0 æ„å‘³ç€æ°¸è¿œç­‰å¾…</td>
</tr>
<tr>
<td>public final native boolean isAlive()</td>
<td>çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰</td>
</tr>
<tr>
<td>public final void setDaemon(boolean on)</td>
<td>å°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹æˆ–ç”¨æˆ·çº¿ç¨‹</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="run-start">run start</h4>
<p>runï¼šç§°ä¸ºçº¿ç¨‹ä½“ï¼ŒåŒ…å«äº†è¦æ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹çš„å†…å®¹ï¼Œæ–¹æ³•è¿è¡Œç»“æŸï¼Œæ­¤çº¿ç¨‹éšå³ç»ˆæ­¢ã€‚ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œéœ€è¦é¡ºåºæ‰§è¡Œ</p>
<p>startï¼šä½¿ç”¨ start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹å¤„äºå°±ç»ªï¼ˆå¯è¿è¡Œï¼‰çŠ¶æ€ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç </p>
<p>è¯´æ˜ï¼š<strong>çº¿ç¨‹æ§åˆ¶èµ„æºç±»</strong></p>
<p>run() æ–¹æ³•ä¸­çš„å¼‚å¸¸ä¸èƒ½æŠ›å‡ºï¼Œåªèƒ½ try/catch</p>
<ul>
<li>å› ä¸ºçˆ¶ç±»ä¸­æ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œå­ç±»ä¸èƒ½æ¯”çˆ¶ç±»æŠ›å‡ºæ›´å¤šçš„å¼‚å¸¸</li>
<li><strong>å¼‚å¸¸ä¸èƒ½è·¨çº¿ç¨‹ä¼ æ’­å› main() ä¸­</strong>ï¼Œå› æ­¤å¿…é¡»åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†</li>
</ul>
<hr>
<h4 id="sleep-yield">sleep yield</h4>
<p>sleepï¼š</p>
<ul>
<li>è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» <code>Running</code> è¿›å…¥ <code>Timed Waiting</code> çŠ¶æ€ï¼ˆé˜»å¡ï¼‰</li>
<li>sleep() æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>çº¿ç¨‹ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”</strong></li>
<li>å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException</li>
<li>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œï¼Œéœ€è¦æŠ¢å  CPU</li>
<li>å»ºè®®ç”¨ TimeUnit çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§</li>
</ul>
<p>yieldï¼š</p>
<ul>
<li>è°ƒç”¨ yield ä¼šè®©æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨</li>
<li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</li>
<li><strong>ä¼šæ”¾å¼ƒ CPU èµ„æºï¼Œé”èµ„æºä¸ä¼šé‡Šæ”¾</strong></li>
</ul>
<hr>
<h4 id="join">join</h4>
<p>public final void join()ï¼šç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</p>
<p>åŸç†ï¼šè°ƒç”¨è€…è½®è¯¢æ£€æŸ¥çº¿ç¨‹ alive çŠ¶æ€ï¼Œt1.join() ç­‰ä»·äºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">(<span class="type">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨è€…çº¿ç¨‹è¿›å…¥ thread çš„ waitSet ç­‰å¾…, ç›´åˆ°å½“å‰çº¿ç¨‹è¿è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>join æ–¹æ³•æ˜¯è¢« synchronized ä¿®é¥°çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡é”ï¼Œå…¶å†…éƒ¨çš„ wait æ–¹æ³•è°ƒç”¨ä¹Ÿæ˜¯é‡Šæ”¾é”çš„ï¼Œä½†æ˜¯<strong>é‡Šæ”¾çš„æ˜¯å½“å‰çš„çº¿ç¨‹å¯¹è±¡é”ï¼Œè€Œä¸æ˜¯å¤–é¢çš„é”</strong></p>
</li>
<li>
<p>å½“è°ƒç”¨æŸä¸ªçº¿ç¨‹ï¼ˆt1ï¼‰çš„ join æ–¹æ³•åï¼Œè¯¥çº¿ç¨‹ï¼ˆt1ï¼‰æŠ¢å åˆ° CPU èµ„æºï¼Œå°±ä¸å†é‡Šæ”¾ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</p>
</li>
</ul>
<p>çº¿ç¨‹åŒæ­¥ï¼š</p>
<ul>
<li>join å®ç°çº¿ç¨‹åŒæ­¥ï¼Œå› ä¸ºä¼šé˜»å¡ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç»“æŸï¼Œæ‰èƒ½ç»§ç»­å‘ä¸‹è¿è¡Œ
<ul>
<li>éœ€è¦å¤–éƒ¨å…±äº«å˜é‡ï¼Œä¸ç¬¦åˆé¢å‘å¯¹è±¡å°è£…çš„æ€æƒ³</li>
<li>å¿…é¡»ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œä¸èƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨</li>
</ul>
</li>
<li>Future å®ç°ï¼ˆåŒæ­¥ï¼‰ï¼šget() æ–¹æ³•é˜»å¡ç­‰å¾…æ‰§è¡Œç»“æœ
<ul>
<li>main çº¿ç¨‹æ¥æ”¶ç»“æœ</li>
<li>get æ–¹æ³•æ˜¯è®©è°ƒç”¨çº¿ç¨‹åŒæ­¥ç­‰å¾…</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            r = <span class="number">10</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();<span class="comment">//ä¸ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè¾“å‡ºçš„10</span></span><br><span class="line">        System.out.println(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="interrupt">interrupt</h4>
<h5 id="æ‰“æ–­çº¿ç¨‹">æ‰“æ–­çº¿ç¨‹</h5>
<p><code>public void interrupt()</code>ï¼šæ‰“æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</p>
<p><code>public static boolean interrupted()</code>ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ‰“æ–­è¿”å› trueï¼Œ<strong>æ¸…é™¤æ‰“æ–­æ ‡è®°</strong>ï¼Œè¿ç»­è°ƒç”¨ä¸¤æ¬¡ä¸€å®šè¿”å› false</p>
<p><code>public boolean isInterrupted()</code>ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°</p>
<p>æ‰“æ–­çš„çº¿ç¨‹ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ“ä½œç³»ç»Ÿä¼šä¿å­˜çº¿ç¨‹ä¿¡æ¯ï¼ŒæŠ¢å åˆ° CPU åä¼šä»ä¸­æ–­çš„åœ°æ–¹æ¥ç€è¿è¡Œï¼ˆæ‰“æ–­ä¸æ˜¯åœæ­¢ï¼‰</p>
<ul>
<li>
<p>sleepã€waitã€join æ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ‰“æ–­çº¿ç¨‹<strong>ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</strong>ï¼ˆfalseï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">    System.out.println(<span class="string">&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;</span> + t1.isInterrupted());<span class="comment">// æ‰“æ–­çŠ¶æ€: &#123;&#125;false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ï¼šä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼ˆtrueï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> current.isInterrupted();</span><br><span class="line">            <span class="keyword">if</span>(interrupted) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;</span> + interrupted);<span class="comment">//æ‰“æ–­çŠ¶æ€: &#123;&#125;true</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    t2.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ‰“æ–­-park">æ‰“æ–­ park</h5>
<p>park ä½œç”¨ç±»ä¼¼ sleepï¼Œæ‰“æ–­ park çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼ˆtrueï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        System.out.println(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰“æ–­çŠ¶æ€ï¼š&quot;</span> + Thread.currentThread().isInterrupted());<span class="comment">//æ‰“æ–­çŠ¶æ€ï¼štrue</span></span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LockSupport.park();</span><br><span class="line">System.out.println(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">LockSupport.park();<span class="comment">//å¤±æ•ˆï¼Œä¸ä¼šé˜»å¡</span></span><br><span class="line">System.out.println(<span class="string">&quot;unpark...&quot;</span>);<span class="comment">//å’Œä¸Šä¸€ä¸ªunparkåŒæ—¶æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä¿®æ”¹è·å–æ‰“æ–­çŠ¶æ€æ–¹æ³•ï¼Œä½¿ç”¨ <code>Thread.interrupted()</code>ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</p>
<p>LockSupport ç±»åœ¨ åŒæ­¥ â†’ park-un è¯¦è§£</p>
<hr>
<h5 id="ç»ˆæ­¢æ¨¡å¼">ç»ˆæ­¢æ¨¡å¼</h5>
<p>ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼šTwo Phase Termination</p>
<p>ç›®æ ‡ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•ä¼˜é›…ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿä¼˜é›…æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªåç½®å¤„ç†å™¨</p>
<p>é”™è¯¯æ€æƒ³ï¼š</p>
<ul>
<li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼šstop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li>
<li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼šç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li>
</ul>
<p>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼å›¾ç¤ºï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F.png" style="zoom: 67%;" />
<p>æ‰“æ–­çº¿ç¨‹å¯èƒ½åœ¨ä»»ä½•æ—¶é—´ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘åœ¨ä»»ä½•æ—¶åˆ»è¢«æ‰“æ–­çš„å¤„ç†æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">TwoPhaseTermination</span> <span class="variable">tpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TwoPhaseTermination</span>();</span><br><span class="line">        tpt.start();</span><br><span class="line">        Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">        tpt.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread monitor;</span><br><span class="line">    <span class="comment">// å¯åŠ¨ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                    <span class="keyword">if</span> (thread.isInterrupted()) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;åç½®å¤„ç†&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);					<span class="comment">// ç¡çœ </span></span><br><span class="line">                        System.out.println(<span class="string">&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;</span>);	<span class="comment">// åœ¨æ­¤è¢«æ‰“æ–­ä¸ä¼šå¼‚å¸¸</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;		<span class="comment">// åœ¨ç¡çœ æœŸé—´è¢«æ‰“æ–­ï¼Œè¿›å…¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘</span></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        <span class="comment">// é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­ sleep ä¼šæ¸…é™¤æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                        thread.interrupt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åœæ­¢ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="daemon">daemon</h4>
<p><code>public final void setDaemon(boolean on)</code>ï¼šå¦‚æœæ˜¯ true ï¼Œå°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹</p>
<p>çº¿ç¨‹<strong>å¯åŠ¨å‰</strong>è°ƒç”¨æ­¤æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">t.start();</span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·çº¿ç¨‹ï¼šå¹³å¸¸åˆ›å»ºçš„æ™®é€šçº¿ç¨‹</p>
<p>å®ˆæŠ¤çº¿ç¨‹ï¼šæœåŠ¡äºç”¨æˆ·çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚å®ˆæŠ¤è¿›ç¨‹æ˜¯<strong>è„±ç¦»äºç»ˆç«¯å¹¶ä¸”åœ¨åå°è¿è¡Œçš„è¿›ç¨‹</strong>ï¼Œè„±ç¦»ç»ˆç«¯æ˜¯ä¸ºäº†é¿å…åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­çš„ä¿¡æ¯åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤º</p>
<p>è¯´æ˜ï¼šå½“è¿è¡Œçš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼ŒJava è™šæ‹Ÿæœºå°†é€€å‡ºï¼Œå› ä¸ºæ™®é€šçº¿ç¨‹æ‰§è¡Œå®Œåï¼ŒJVM æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸ä¼šç»§ç»­è¿è¡Œä¸‹å»</p>
<p>å¸¸è§çš„å®ˆæŠ¤çº¿ç¨‹ï¼š</p>
<ul>
<li>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</li>
<li>Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</li>
</ul>
<hr>
<h4 id="ä¸æ¨è">ä¸æ¨è</h4>
<p>ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”ï¼š</p>
<ul>
<li>
<p><code>public final void stop()</code>ï¼šåœæ­¢çº¿ç¨‹è¿è¡Œ</p>
<p>åºŸå¼ƒåŸå› ï¼šæ–¹æ³•ç²—æš´ï¼Œé™¤éå¯èƒ½æ‰§è¡Œ finally ä»£ç å—ä»¥åŠé‡Šæ”¾ synchronized å¤–ï¼Œçº¿ç¨‹å°†ç›´æ¥è¢«ç»ˆæ­¢ï¼Œå¦‚æœçº¿ç¨‹æŒæœ‰ JUC çš„äº’æ–¥é”å¯èƒ½å¯¼è‡´é”æ¥ä¸åŠé‡Šæ”¾ï¼Œé€ æˆå…¶ä»–çº¿ç¨‹æ°¸è¿œç­‰å¾…çš„å±€é¢</p>
</li>
<li>
<p><code>public final void suspend()</code>ï¼š<strong>æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ</strong></p>
<p>åºŸå¼ƒåŸå› ï¼šå¦‚æœç›®æ ‡çº¿ç¨‹åœ¨æš‚åœæ—¶å¯¹ç³»ç»Ÿèµ„æºæŒæœ‰é”ï¼Œåˆ™åœ¨ç›®æ ‡çº¿ç¨‹æ¢å¤ä¹‹å‰æ²¡æœ‰çº¿ç¨‹å¯ä»¥è®¿é—®è¯¥èµ„æºï¼Œå¦‚æœ<strong>æ¢å¤ç›®æ ‡çº¿ç¨‹çš„çº¿ç¨‹</strong>åœ¨è°ƒç”¨ resume ä¹‹å‰ä¼šå°è¯•è®¿é—®æ­¤å…±äº«èµ„æºï¼Œåˆ™ä¼šå¯¼è‡´æ­»é”</p>
</li>
<li>
<p><code>public final void resume()</code>ï¼šæ¢å¤çº¿ç¨‹è¿è¡Œ</p>
</li>
</ul>
<hr>
<h3 id="çº¿ç¨‹åŸç†">çº¿ç¨‹åŸç†</h3>
<h4 id="è¿è¡Œæœºåˆ¶">è¿è¡Œæœºåˆ¶</h4>
<p>Java Virtual Machine Stacksï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰ï¼šæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜</p>
<ul>
<li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜</li>
<li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</li>
</ul>
<p>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰ï¼šä¸€äº›åŸå› å¯¼è‡´ CPU ä¸å†æ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹</p>
<ul>
<li>çº¿ç¨‹çš„ CPU æ—¶é—´ç‰‡ç”¨å®Œ</li>
<li>åƒåœ¾å›æ”¶</li>
<li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li>
<li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€park ç­‰æ–¹æ³•</li>
</ul>
<p>ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼šè®°ä½ä¸‹ä¸€æ¡ JVM æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„</p>
<p>å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼ˆPCB ä¸­ï¼‰ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</p>
<p>JVM è§„èŒƒå¹¶æ²¡æœ‰é™å®šçº¿ç¨‹æ¨¡å‹ï¼Œä»¥ HotSopot ä¸ºä¾‹ï¼š</p>
<ul>
<li>Java çš„çº¿ç¨‹æ˜¯å†…æ ¸çº§çº¿ç¨‹ï¼ˆ1:1 çº¿ç¨‹æ¨¡å‹ï¼‰ï¼Œæ¯ä¸ª Java çº¿ç¨‹éƒ½æ˜ å°„åˆ°ä¸€ä¸ªæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹ï¼Œéœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æºï¼ˆå †æ ˆï¼‰</li>
<li><strong>çº¿ç¨‹çš„è°ƒåº¦æ˜¯åœ¨å†…æ ¸æ€è¿è¡Œçš„ï¼Œè€Œçº¿ç¨‹ä¸­çš„ä»£ç æ˜¯åœ¨ç”¨æˆ·æ€è¿è¡Œ</strong>ï¼Œæ‰€ä»¥çº¿ç¨‹åˆ‡æ¢ï¼ˆçŠ¶æ€æ”¹å˜ï¼‰ä¼šå¯¼è‡´ç”¨æˆ·ä¸å†…æ ¸æ€è½¬æ¢è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½</li>
</ul>
<p>Java ä¸­ main æ–¹æ³•å¯åŠ¨çš„æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œmain æ–¹æ³•é‡Œé¢çš„å…¶ä»–çº¿ç¨‹å‡ä¸ºå­çº¿ç¨‹ï¼Œmain çº¿ç¨‹æ˜¯è¿™äº›çº¿ç¨‹çš„çˆ¶çº¿ç¨‹</p>
<hr>
<h4 id="çº¿ç¨‹è°ƒåº¦">çº¿ç¨‹è°ƒåº¦</h4>
<p>çº¿ç¨‹è°ƒåº¦æŒ‡ç³»ç»Ÿä¸ºçº¿ç¨‹åˆ†é…å¤„ç†å™¨ä½¿ç”¨æƒçš„è¿‡ç¨‹ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼šååŒå¼çº¿ç¨‹è°ƒåº¦ã€æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼ˆJava é€‰æ‹©ï¼‰</p>
<p>ååŒå¼çº¿ç¨‹è°ƒåº¦ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ§åˆ¶</p>
<ul>
<li>ä¼˜ç‚¹ï¼šçº¿ç¨‹åšå®Œä»»åŠ¡æ‰é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ï¼Œç›¸å½“äºæ‰€æœ‰çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹åŒæ­¥é—®é¢˜</li>
<li>ç¼ºç‚¹ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶é—´ä¸å¯æ§ï¼Œå¦‚æœä»£ç ç¼–å†™å‡ºç°é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºä¸€ç›´é˜»å¡ï¼Œå¼•èµ·ç³»ç»Ÿçš„å¥”æºƒ</li>
</ul>
<p>æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±ç³»ç»Ÿåˆ†é…</p>
<ul>
<li>ä¼˜ç‚¹ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶é—´å¯æ§ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªçº¿ç¨‹çš„é—®é¢˜è€Œå¯¼è‡´æ•´ä½“ç³»ç»Ÿä¸å¯ç”¨</li>
<li>ç¼ºç‚¹ï¼šæ— æ³•ä¸»åŠ¨ä¸ºæŸä¸ªçº¿ç¨‹å¤šåˆ†é…æ—¶é—´</li>
</ul>
<p>Java æä¾›äº†çº¿ç¨‹ä¼˜å…ˆçº§çš„æœºåˆ¶ï¼Œä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†è¿™ä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚åœ¨çº¿ç¨‹çš„å°±ç»ªçŠ¶æ€æ—¶ï¼Œå¦‚æœ CPU æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† CPU é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨</p>
<p>è¯´æ˜ï¼šå¹¶ä¸èƒ½é€šè¿‡ä¼˜å…ˆçº§æ¥åˆ¤æ–­çº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåº</p>
<hr>
<h4 id="æœªæ¥ä¼˜åŒ–">æœªæ¥ä¼˜åŒ–</h4>
<p>å†…æ ¸çº§çº¿ç¨‹è°ƒåº¦çš„æˆæœ¬è¾ƒå¤§ï¼Œæ‰€ä»¥å¼•å…¥äº†æ›´è½»é‡çº§çš„åç¨‹ã€‚ç”¨æˆ·çº¿ç¨‹çš„è°ƒåº¦ç”±ç”¨æˆ·è‡ªå·±å®ç°ï¼ˆå¤šå¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¤š<strong>ä¸ªç”¨æˆ·çº¿ç¨‹æ˜ å°„åˆ°ä¸€ä¸ªå†…æ ¸çº§çº¿ç¨‹</strong>ï¼‰ï¼Œè¢«è®¾è®¡ä¸ºååŒå¼è°ƒåº¦ï¼Œæ‰€ä»¥å«åç¨‹</p>
<ul>
<li>æœ‰æ ˆåç¨‹ï¼šåç¨‹ä¼šå®Œæ•´çš„åšè°ƒç”¨æ ˆçš„ä¿æŠ¤ã€æ¢å¤å·¥ä½œï¼Œæ‰€ä»¥å«æœ‰æ ˆåç¨‹</li>
<li>æ— æ ˆåç¨‹ï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœ‰é™çŠ¶æ€æœºï¼ŒçŠ¶æ€ä¿å­˜åœ¨é—­åŒ…é‡Œï¼Œæ¯”æœ‰æ ˆåç¨‹æ›´è½»é‡ï¼Œä½†æ˜¯åŠŸèƒ½æœ‰é™</li>
</ul>
<p>æœ‰æ ˆåç¨‹ä¸­æœ‰ä¸€ç§ç‰¹ä¾‹å«çº¤ç¨‹ï¼Œåœ¨æ–°å¹¶å‘æ¨¡å‹ä¸­ï¼Œä¸€æ®µçº¤ç¨‹çš„ä»£ç è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œæ‰§è¡Œè¿‡ç¨‹å’Œè°ƒåº¦å™¨ï¼š</p>
<ul>
<li>æ‰§è¡Œè¿‡ç¨‹ï¼šç”¨äºç»´æŠ¤æ‰§è¡Œç°åœºï¼Œä¿æŠ¤ã€æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€</li>
<li>è°ƒåº¦å™¨ï¼šè´Ÿè´£ç¼–æ’æ‰€æœ‰è¦æ‰§è¡Œçš„ä»£ç é¡ºåº</li>
</ul>
<hr>
<h3 id="çº¿ç¨‹çŠ¶æ€">çº¿ç¨‹çŠ¶æ€</h3>
<p>è¿›ç¨‹çš„çŠ¶æ€å‚è€ƒæ“ä½œç³»ç»Ÿï¼šåˆ›å»ºæ€ã€å°±ç»ªæ€ã€è¿è¡Œæ€ã€é˜»å¡æ€ã€ç»ˆæ­¢æ€</p>
<p>çº¿ç¨‹ç”±ç”Ÿåˆ°æ­»çš„å®Œæ•´è¿‡ç¨‹ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰ï¼šå½“çº¿ç¨‹è¢«åˆ›å»ºå¹¶å¯åŠ¨ä»¥åï¼Œæ—¢ä¸æ˜¯ä¸€å¯åŠ¨å°±è¿›å…¥äº†æ‰§è¡ŒçŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯ä¸€ç›´å¤„äºæ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨ API ä¸­ <code>java.lang.Thread.State</code> è¿™ä¸ªæšä¸¾ä¸­ç»™å‡ºäº†å…­ç§çº¿ç¨‹çŠ¶æ€ï¼š</p>
<table>
<thead>
<tr>
<th>çº¿ç¨‹çŠ¶æ€</th>
<th>å¯¼è‡´çŠ¶æ€å‘ç”Ÿæ¡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>NEWï¼ˆæ–°å»ºï¼‰</td>
<td>çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯å¹¶æœªå¯åŠ¨ï¼Œè¿˜æ²¡è°ƒç”¨ start æ–¹æ³•ï¼Œåªæœ‰çº¿ç¨‹å¯¹è±¡ï¼Œæ²¡æœ‰çº¿ç¨‹ç‰¹å¾</td>
</tr>
<tr>
<td>Runnableï¼ˆå¯è¿è¡Œï¼‰</td>
<td>çº¿ç¨‹å¯ä»¥åœ¨ Java è™šæ‹Ÿæœºä¸­è¿è¡Œçš„çŠ¶æ€ï¼Œå¯èƒ½æ­£åœ¨è¿è¡Œè‡ªå·±ä»£ç ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ï¼Œè¿™å–å†³äºæ“ä½œç³»ç»Ÿå¤„ç†å™¨ï¼Œè°ƒç”¨äº† t.start() æ–¹æ³•ï¼šå°±ç»ªï¼ˆç»å…¸å«æ³•ï¼‰</td>
</tr>
<tr>
<td>Blockedï¼ˆé˜»å¡ï¼‰</td>
<td>å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå¯¹è±¡é”ï¼Œè€Œè¯¥å¯¹è±¡é”è¢«å…¶ä»–çš„çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥ Blocked çŠ¶æ€ï¼›å½“è¯¥çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œè¯¥çº¿ç¨‹å°†å˜æˆ Runnable çŠ¶æ€</td>
</tr>
<tr>
<td>Waitingï¼ˆæ— é™ç­‰å¾…ï¼‰</td>
<td>ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªï¼ˆå”¤é†’ï¼‰åŠ¨ä½œæ—¶ï¼Œè¯¥çº¿ç¨‹è¿›å…¥ Waiting çŠ¶æ€ï¼Œè¿›å…¥è¿™ä¸ªçŠ¶æ€åä¸èƒ½è‡ªåŠ¨å”¤é†’ï¼Œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ notify æˆ–è€… notifyAll æ–¹æ³•æ‰èƒ½å”¤é†’</td>
</tr>
<tr>
<td>Timed Waiting ï¼ˆé™æœŸç­‰å¾…ï¼‰</td>
<td>æœ‰å‡ ä¸ªæ–¹æ³•æœ‰è¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨å°†è¿›å…¥ Timed Waiting çŠ¶æ€ï¼Œè¿™ä¸€çŠ¶æ€å°†ä¸€ç›´ä¿æŒåˆ°è¶…æ—¶æœŸæ»¡æˆ–è€…æ¥æ”¶åˆ°å”¤é†’é€šçŸ¥ã€‚å¸¦æœ‰è¶…æ—¶å‚æ•°çš„å¸¸ç”¨æ–¹æ³•æœ‰ Thread.sleep ã€Object.wait</td>
</tr>
<tr>
<td>Teminatedï¼ˆç»“æŸï¼‰</td>
<td>run æ–¹æ³•æ­£å¸¸é€€å‡ºè€Œæ­»äº¡ï¼Œæˆ–è€…å› ä¸ºæ²¡æœ‰æ•è·çš„å¼‚å¸¸ç»ˆæ­¢äº† run æ–¹æ³•è€Œæ­»äº¡</td>
</tr>
</tbody>
</table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E7%BA%BF%E7%A8%8B6%E7%A7%8D%E7%8A%B6%E6%80%81.png" alt=""></p>
<ul>
<li>
<p>NEW â†’ RUNNABLEï¼šå½“è°ƒç”¨ t.start() æ–¹æ³•æ—¶ï¼Œç”± NEW â†’ RUNNABLE</p>
</li>
<li>
<p>RUNNABLE &lt;â€“&gt; WAITINGï¼š</p>
<ul>
<li>
<p>è°ƒç”¨ obj.wait() æ–¹æ³•æ—¶</p>
<p>è°ƒç”¨ obj.notify()ã€obj.notifyAll()ã€t.interrupt()ï¼š</p>
<ul>
<li>ç«äº‰é”æˆåŠŸï¼Œt çº¿ç¨‹ä» WAITING â†’ RUNNABLE</li>
<li>ç«äº‰é”å¤±è´¥ï¼Œt çº¿ç¨‹ä» WAITING â†’ BLOCKED</li>
</ul>
</li>
<li>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ t.join() æ–¹æ³•ï¼Œæ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨ t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</p>
</li>
<li>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨ LockSupport.park() æ–¹æ³•</p>
</li>
</ul>
</li>
<li>
<p>RUNNABLE &lt;â€“&gt; TIMED_WAITINGï¼šè°ƒç”¨ obj.wait(long n) æ–¹æ³•ã€å½“å‰çº¿ç¨‹è°ƒç”¨ t.join(long n) æ–¹æ³•ã€å½“å‰çº¿ç¨‹è°ƒç”¨ Thread.sleep(long n)</p>
</li>
<li>
<p>RUNNABLE &lt;â€“&gt; BLOCKEDï¼št çº¿ç¨‹ç”¨ synchronized(obj) è·å–äº†å¯¹è±¡é”æ—¶ç«äº‰å¤±è´¥</p>
</li>
</ul>
<hr>
<h3 id="æŸ¥çœ‹çº¿ç¨‹">æŸ¥çœ‹çº¿ç¨‹</h3>
<p>Windowsï¼š</p>
<ul>
<li>ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹</li>
<li>tasklist æŸ¥çœ‹è¿›ç¨‹</li>
<li>taskkill æ€æ­»è¿›ç¨‹</li>
</ul>
<p>Linuxï¼š</p>
<ul>
<li>ps -ef æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li>
<li>ps -fT -p <PID> æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li>
<li>kill æ€æ­»è¿›ç¨‹</li>
<li>top æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹</li>
<li>top -H -p <PID> æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li>
</ul>
<p>Javaï¼š</p>
<ul>
<li>jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹</li>
<li>jstack <PID> æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li>
<li>jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰</li>
</ul>
<hr>
<h2 id="åŒæ­¥">åŒæ­¥</h2>
<h3 id="ä¸´ç•ŒåŒº">ä¸´ç•ŒåŒº</h3>
<p>ä¸´ç•Œèµ„æºï¼šä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºæˆä¸ºä¸´ç•Œèµ„æº</p>
<p>ä¸´ç•ŒåŒºï¼šè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç å—</p>
<p>ç«æ€æ¡ä»¶ï¼šå¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶</p>
<p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œå¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œåœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</p>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ˆè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰ï¼š</p>
<ul>
<li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œlock</li>
<li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li>
</ul>
<p>ç®¡ç¨‹ï¼ˆmonitorï¼‰ï¼šç”±å±€éƒ¨äºè‡ªå·±çš„è‹¥å¹²å…¬å…±å˜é‡å’Œæ‰€æœ‰è®¿é—®è¿™äº›å…¬å…±å˜é‡çš„è¿‡ç¨‹æ‰€ç»„æˆçš„è½¯ä»¶æ¨¡å—ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ç®¡ç¨‹å†…æ´»åŠ¨ï¼Œå³ç®¡ç¨‹å†…å®šä¹‰çš„æ“ä½œåœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ï¼ˆç”±ç¼–è¯‘å™¨å®ç°ï¼‰</p>
<p><strong>synchronizedï¼šå¯¹è±¡é”ï¼Œä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§</strong>ï¼Œé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å¯¹è±¡é”ï¼Œå…¶å®ƒçº¿ç¨‹è·å–è¿™ä¸ªå¯¹è±¡é”æ—¶ä¼šé˜»å¡ï¼Œä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
<p>äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼ŒåŒºåˆ«ï¼š</p>
<ul>
<li>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </li>
<li>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</li>
</ul>
<p>æ€§èƒ½ï¼š</p>
<ul>
<li>çº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½å·®</li>
<li>çº¿ç¨‹ä¸å®‰å…¨æ€§èƒ½å¥½ï¼Œå‡å¦‚å¼€å‘ä¸­ä¸ä¼šå­˜åœ¨å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨çš„è®¾è®¡ç±»</li>
</ul>
<hr>
<h3 id="syn-ed">syn-ed</h3>
<h4 id="ä½¿ç”¨é”">ä½¿ç”¨é”</h4>
<h5 id="åŒæ­¥å—">åŒæ­¥å—</h5>
<p>é”å¯¹è±¡ï¼šç†è®ºä¸Šå¯ä»¥æ˜¯<strong>ä»»æ„çš„å”¯ä¸€å¯¹è±¡</strong></p>
<p>synchronized æ˜¯å¯é‡å…¥ã€ä¸å…¬å¹³çš„é‡é‡çº§é”</p>
<p>åŸåˆ™ä¸Šï¼š</p>
<ul>
<li>é”å¯¹è±¡å»ºè®®ä½¿ç”¨å…±äº«èµ„æº</li>
<li>åœ¨å®ä¾‹æ–¹æ³•ä¸­ä½¿ç”¨ this ä½œä¸ºé”å¯¹è±¡ï¼Œé”ä½çš„ this æ­£å¥½æ˜¯å…±äº«èµ„æº</li>
<li>åœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨ç±»å .class å­—èŠ‚ç ä½œä¸ºé”å¯¹è±¡ï¼Œå› ä¸ºé™æ€æˆå‘˜å±äºç±»ï¼Œè¢«æ‰€æœ‰å®ä¾‹å¯¹è±¡å…±äº«ï¼Œæ‰€ä»¥éœ€è¦é”ä½ç±»</li>
</ul>
<p>åŒæ­¥ä»£ç å—æ ¼å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(é”å¯¹è±¡)&#123;</span><br><span class="line">	<span class="comment">// è®¿é—®å…±äº«èµ„æºçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//staticä¿®é¥°ï¼Œåˆ™å…ƒç´ æ˜¯å±äºç±»æœ¬èº«çš„ï¼Œä¸å±äºå¯¹è±¡  ï¼Œä¸ç±»ä¸€èµ·åŠ è½½ä¸€æ¬¡ï¼Œåªæœ‰ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    counter++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    counter--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println(counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="åŒæ­¥æ–¹æ³•">åŒæ­¥æ–¹æ³•</h5>
<p>æŠŠå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ ¸å¿ƒæ–¹æ³•é”èµ·æ¥ï¼Œæ¯æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥è®¿é—®</p>
<p>synchronized ä¿®é¥°çš„æ–¹æ³•çš„ä¸å…·å¤‡ç»§æ‰¿æ€§ï¼Œæ‰€ä»¥å­ç±»æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¦‚æœå­ç±»çš„æ–¹æ³•ä¹Ÿè¢« synchronized ä¿®é¥°ï¼Œä¸¤ä¸ªé”å¯¹è±¡å…¶å®æ˜¯ä¸€æŠŠé”ï¼Œè€Œä¸”æ˜¯<strong>å­ç±»å¯¹è±¡ä½œä¸ºé”</strong></p>
<p>ç”¨æ³•ï¼šç›´æ¥ç»™æ–¹æ³•åŠ ä¸Šä¸€ä¸ªä¿®é¥°ç¬¦ synchronized</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒæ­¥æ–¹æ³•</span></span><br><span class="line">ä¿®é¥°ç¬¦ <span class="keyword">synchronized</span> è¿”å›å€¼ç±»å‹ æ–¹æ³•å(æ–¹æ³•å‚æ•°) &#123;</span><br><span class="line">	æ–¹æ³•ä½“ï¼›</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒæ­¥é™æ€æ–¹æ³•</span></span><br><span class="line">ä¿®é¥°ç¬¦ <span class="keyword">static</span> <span class="keyword">synchronized</span> è¿”å›å€¼ç±»å‹ æ–¹æ³•å(æ–¹æ³•å‚æ•°) &#123;</span><br><span class="line">	æ–¹æ³•ä½“ï¼›</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ­¥æ–¹æ³•åº•å±‚ä¹Ÿæ˜¯æœ‰é”å¯¹è±¡çš„ï¼š</p>
<ul>
<li>
<p>å¦‚æœæ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼šåŒæ­¥æ–¹æ³•é»˜è®¤ç”¨ this ä½œä¸ºçš„é”å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;&#125; <span class="comment">//ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¦‚æœæ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼šåŒæ­¥æ–¹æ³•é»˜è®¤ç”¨ç±»å .class ä½œä¸ºçš„é”å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Test.class) &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="çº¿ç¨‹å…«é”">çº¿ç¨‹å…«é”</h5>
<p>çº¿ç¨‹å…«é”å°±æ˜¯è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡ï¼Œç›´æ¥ç™¾åº¦æœç´¢ç›¸å…³çš„å®ä¾‹</p>
<p>è¯´æ˜ï¼šä¸»è¦å…³æ³¨é”ä½çš„å¯¹è±¡æ˜¯ä¸æ˜¯åŒä¸€ä¸ª</p>
<ul>
<li>é”ä½ç±»å¯¹è±¡ï¼Œæ‰€æœ‰ç±»çš„å®ä¾‹çš„æ–¹æ³•éƒ½æ˜¯å®‰å…¨çš„ï¼Œç±»çš„æ‰€æœ‰å®ä¾‹éƒ½ç›¸å½“äºåŒä¸€æŠŠé”</li>
<li>é”ä½ this å¯¹è±¡ï¼Œåªæœ‰åœ¨å½“å‰å®ä¾‹å¯¹è±¡çš„çº¿ç¨‹å†…æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœæœ‰å¤šä¸ªå®ä¾‹å°±ä¸å®‰å…¨</li>
</ul>
<p>çº¿ç¨‹ä¸å®‰å…¨ï¼šå› ä¸ºé”ä½çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œçº¿ç¨‹ 1 è°ƒç”¨ a æ–¹æ³•é”ä½çš„ç±»å¯¹è±¡ï¼Œçº¿ç¨‹ 2 è°ƒç”¨ b æ–¹æ³•é”ä½çš„ n2 å¯¹è±¡ï¼Œä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span>&#123;</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹å®‰å…¨ï¼šå› ä¸º n1 è°ƒç”¨ a() æ–¹æ³•ï¼Œé”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œn2 è°ƒç”¨ b() æ–¹æ³•ï¼Œé”ä½çš„ä¹Ÿæ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span>&#123;</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é”åŸç†">é”åŸç†</h4>
<h5 id="Monitor">Monitor</h5>
<p>Monitor è¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹</p>
<p>æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼ŒMonitor ä¹Ÿæ˜¯ classï¼Œå…¶<strong>å®ä¾‹å­˜å‚¨åœ¨å †ä¸­</strong>ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™å°±æ˜¯é‡é‡çº§é”</p>
<ul>
<li>
<p>Mark Word ç»“æ„ï¼šæœ€åä¸¤ä½æ˜¯<strong>é”æ ‡å¿—ä½</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-Monitor-MarkWord%E7%BB%93%E6%9E%8432%E4%BD%8D.png" alt=""></p>
</li>
<li>
<p>64 ä½è™šæ‹Ÿæœº Mark Wordï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-Monitor-MarkWord%E7%BB%93%E6%9E%8464%E4%BD%8D.png" alt=""></p>
</li>
</ul>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>å¼€å§‹æ—¶ Monitor ä¸­ Owner ä¸º null</li>
<li>å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2ï¼ŒMonitor ä¸­åªèƒ½æœ‰ä¸€ä¸ª Ownerï¼Œ<strong>obj å¯¹è±¡çš„ Mark Word æŒ‡å‘ Monitor</strong>ï¼ŒæŠŠ<strong>å¯¹è±¡åŸæœ‰çš„ MarkWord å­˜å…¥çº¿ç¨‹æ ˆä¸­çš„é”è®°å½•</strong>ä¸­ï¼ˆè½»é‡çº§é”éƒ¨åˆ†è¯¦è§£ï¼‰<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-Monitor%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%861.png" style="zoom:67%;" /></li>
<li>åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ï¼ŒThread-3ã€Thread-4ã€Thread-5 ä¹Ÿæ‰§è¡Œ synchronized(obj)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKEDï¼ˆåŒå‘é“¾è¡¨ï¼‰</li>
<li>Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œæ ¹æ® obj å¯¹è±¡å¤´ä¸­ Monitor åœ°å€å¯»æ‰¾ï¼Œè®¾ç½® Owner ä¸ºç©ºï¼ŒæŠŠçº¿ç¨‹æ ˆçš„é”è®°å½•ä¸­çš„å¯¹è±¡å¤´çš„å€¼è®¾ç½®å› MarkWord</li>
<li>å”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰æ˜¯<strong>éå…¬å¹³çš„</strong>ï¼Œå¦‚æœè¿™æ—¶æœ‰æ–°çš„çº¿ç¨‹æƒ³è¦è·å–é”ï¼Œå¯èƒ½ç›´æ¥å°±æŠ¢å åˆ°äº†ï¼Œé˜»å¡é˜Ÿåˆ—çš„çº¿ç¨‹å°±ä¼šç»§ç»­é˜»å¡</li>
<li>WaitSet ä¸­çš„ Thread-0ï¼Œæ˜¯ä»¥å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼ˆwait-notify æœºåˆ¶ï¼‰</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-Monitor%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%862.png" alt=""></p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ Monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ</li>
<li>ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</li>
</ul>
<hr>
<h5 id="å­—èŠ‚ç ">å­—èŠ‚ç </h5>
<p>ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: 	<span class="keyword">new</span>				#<span class="number">2</span>		<span class="comment">// new Object</span></span><br><span class="line"><span class="number">3</span>: 	dup</span><br><span class="line"><span class="number">4</span>: 	invokespecial 	#<span class="number">1</span> 		<span class="comment">// invokespecial &lt;init&gt;:()Vï¼Œéè™šæ–¹æ³•</span></span><br><span class="line"><span class="number">7</span>: 	astore_1 				<span class="comment">// lockå¼•ç”¨ -&gt; lock</span></span><br><span class="line"><span class="number">8</span>: 	aload_1					<span class="comment">// lock ï¼ˆsynchronizedå¼€å§‹ï¼‰</span></span><br><span class="line"><span class="number">9</span>: 	dup						<span class="comment">// ä¸€ä»½ç”¨æ¥åˆå§‹åŒ–ï¼Œä¸€ä»½ç”¨æ¥å¼•ç”¨</span></span><br><span class="line"><span class="number">10</span>: astore_2 				<span class="comment">// lockå¼•ç”¨ -&gt; slot 2</span></span><br><span class="line"><span class="number">11</span>: monitorenter 			<span class="comment">// ã€å°† lockå¯¹è±¡ MarkWord ç½®ä¸º Monitor æŒ‡é’ˆã€‘</span></span><br><span class="line"><span class="number">12</span>: getstatic 		#<span class="number">3</span>		<span class="comment">// System.out</span></span><br><span class="line"><span class="number">15</span>: ldc 			#<span class="number">4</span>		<span class="comment">// &quot;ok&quot;</span></span><br><span class="line"><span class="number">17</span>: invokevirtual 	#<span class="number">5</span> 		<span class="comment">// invokevirtual println:(Ljava/lang/String;)V</span></span><br><span class="line"><span class="number">20</span>: aload_2 				<span class="comment">// slot 2(lockå¼•ç”¨)</span></span><br><span class="line"><span class="number">21</span>: monitorexit 			<span class="comment">// ã€å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryListã€‘</span></span><br><span class="line"><span class="number">22</span>: <span class="keyword">goto</span> <span class="number">30</span></span><br><span class="line"><span class="number">25</span>: astore_3 				<span class="comment">// any -&gt; slot 3</span></span><br><span class="line"><span class="number">26</span>: aload_2 				<span class="comment">// slot 2(lockå¼•ç”¨)</span></span><br><span class="line"><span class="number">27</span>: monitorexit 			<span class="comment">// ã€å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryListã€‘</span></span><br><span class="line"><span class="number">28</span>: aload_3</span><br><span class="line"><span class="number">29</span>: athrow</span><br><span class="line"><span class="number">30</span>: <span class="keyword">return</span></span><br><span class="line">Exception table:</span><br><span class="line">    from to target type</span><br><span class="line">      <span class="number">12</span> <span class="number">22</span> <span class="number">25</span> 		any</span><br><span class="line">      <span class="number">25</span> <span class="number">28</span> <span class="number">25</span> 		any</span><br><span class="line">LineNumberTable: ...</span><br><span class="line">LocalVariableTable:</span><br><span class="line">    Start Length Slot Name Signature</span><br><span class="line">    	<span class="number">0</span> 	<span class="number">31</span> 		<span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">    	<span class="number">8</span> 	<span class="number">23</span> 		<span class="number">1</span> lock Ljava/lang/Object;</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>é€šè¿‡å¼‚å¸¸ <strong>try-catch æœºåˆ¶</strong>ï¼Œç¡®ä¿ä¸€å®šä¼šè¢«è§£é”</li>
<li>æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°</li>
</ul>
<hr>
<h4 id="é”å‡çº§">é”å‡çº§</h4>
<h5 id="å‡çº§è¿‡ç¨‹">å‡çº§è¿‡ç¨‹</h5>
<p><strong>synchronized æ˜¯å¯é‡å…¥ã€ä¸å…¬å¹³çš„é‡é‡çº§é”</strong>ï¼Œæ‰€ä»¥å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ— é” -&gt; åå‘é” -&gt; è½»é‡çº§é” -&gt; é‡é‡çº§é”	<span class="comment">// éšç€ç«äº‰çš„å¢åŠ ï¼Œåªèƒ½é”å‡çº§ï¼Œä¸èƒ½é™çº§</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E9%94%81%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B.png" alt=""></p>
<hr>
<h5 id="åå‘é”">åå‘é”</h5>
<p>åå‘é”çš„æ€æƒ³æ˜¯åå‘äºè®©ç¬¬ä¸€ä¸ªè·å–é”å¯¹è±¡çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹‹åé‡æ–°è·å–è¯¥é”ä¸å†éœ€è¦åŒæ­¥æ“ä½œï¼š</p>
<ul>
<li>
<p>å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å¾—çš„æ—¶å€™è¿›å…¥åå‘çŠ¶æ€ï¼Œæ ‡è®°ä¸º 101ï¼ŒåŒæ—¶<strong>ä½¿ç”¨ CAS æ“ä½œå°†çº¿ç¨‹ ID è®°å½•åˆ° Mark Word</strong>ã€‚å¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œè¿™ä¸ªçº¿ç¨‹ä»¥åè¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—ï¼ŒæŸ¥çœ‹è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œå°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œ</p>
</li>
<li>
<p>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”å¯¹è±¡æ—¶ï¼Œåå‘çŠ¶æ€å°±å®£å‘Šç»“æŸï¼Œæ­¤æ—¶æ’¤é”€åå‘ï¼ˆRevoke Biasï¼‰åæ¢å¤åˆ°æœªé”å®šæˆ–è½»é‡çº§é”çŠ¶æ€</p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-Monitor-MarkWord%E7%BB%93%E6%9E%8464%E4%BD%8D-20250930141011963.png" style="zoom: 67%;" />
<p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p>
<ul>
<li>
<p>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMarkWord å€¼ä¸º 0x05 å³æœ€å 3 ä½ä¸º 101ï¼Œthreadã€epochã€age éƒ½ä¸º 0</p>
</li>
<li>
<p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•° <code>-XX:BiasedLockingStartupDelay=0</code> æ¥ç¦ç”¨å»¶è¿Ÿã€‚JDK 8 å»¶è¿Ÿ 4s å¼€å¯åå‘é”åŸå› ï¼šåœ¨åˆšå¼€å§‹æ‰§è¡Œä»£ç æ—¶ï¼Œä¼šæœ‰å¥½å¤šçº¿ç¨‹æ¥æŠ¢é”ï¼Œå¦‚æœå¼€åå‘é”æ•ˆç‡åè€Œé™ä½</p>
</li>
<li>
<p>å½“ä¸€ä¸ªå¯¹è±¡å·²ç»è®¡ç®—è¿‡ hashCodeï¼Œå°±å†ä¹Ÿæ— æ³•è¿›å…¥åå‘çŠ¶æ€äº†</p>
</li>
<li>
<p>æ·»åŠ  VM å‚æ•° <code>-XX:-UseBiasedLocking</code> ç¦ç”¨åå‘é”</p>
</li>
</ul>
<p>æ’¤é”€åå‘é”çš„çŠ¶æ€ï¼š</p>
<ul>
<li>è°ƒç”¨å¯¹è±¡çš„ hashCodeï¼šåå‘é”çš„å¯¹è±¡ MarkWord ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹ idï¼Œè°ƒç”¨ hashCode å¯¼è‡´åå‘é”è¢«æ’¤é”€</li>
<li>å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”</li>
<li>è°ƒç”¨ wait/notifyï¼Œéœ€è¦ç”³è¯· Monitorï¼Œè¿›å…¥ WaitSet</li>
</ul>
<p><strong>æ‰¹é‡æ’¤é”€</strong>ï¼šå¦‚æœå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID</p>
<ul>
<li>
<p>æ‰¹é‡é‡åå‘ï¼šå½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 20 æ¬¡åï¼ŒJVM ä¼šè§‰å¾—æ˜¯ä¸æ˜¯åå‘é”™äº†ï¼Œäºæ˜¯åœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹</p>
</li>
<li>
<p>æ‰¹é‡æ’¤é”€ï¼šå½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼ŒJVM ä¼šè§‰å¾—è‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ï¼Œäºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„</p>
</li>
</ul>
<hr>
<h5 id="è½»é‡çº§é”">è½»é‡çº§é”</h5>
<p>ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ï¼Œè½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼ˆä¸å¯è§ï¼‰</p>
<p>å¯é‡å…¥é”ï¼šçº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥ç€çš„ä»£ç å—ï¼Œå¯é‡å…¥é”æœ€å¤§çš„ä½œç”¨æ˜¯<strong>é¿å…æ­»é”</strong></p>
<p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆé”é‡å…¥æ—¶ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œï¼ŒJava 6 æ‰å¼•å…¥çš„åå‘é”æ¥ä¼˜åŒ–</p>
<p>é”é‡å…¥å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">    	<span class="comment">// åŒæ­¥å— B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„<strong>æ ˆå¸§</strong>éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%861.png" alt=""></p>
</li>
<li>
<p>è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”ä½çš„å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ CAS æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜å…¥é”è®°å½•</p>
</li>
<li>
<p>å¦‚æœ CAS æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00ï¼ˆè½»é‡çº§é”ï¼‰ ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%862.png" alt=""></p>
</li>
<li>
<p>å¦‚æœ CAS å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹</li>
<li>å¦‚æœæ˜¯çº¿ç¨‹è‡ªå·±æ‰§è¡Œäº† synchronized é”é‡å…¥ï¼Œå°±æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%863.png" alt=""></p>
</li>
<li>
<p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰</p>
<ul>
<li>å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ 1</li>
<li>å¦‚æœé”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨ CAS <strong>å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</strong>
<ul>
<li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li>
<li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h5 id="é”è†¨èƒ€">é”è†¨èƒ€</h5>
<p>åœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œå¯èƒ½æ˜¯å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸º<strong>é‡é‡çº§é”</strong></p>
<ul>
<li>
<p>å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%861.png" alt=""></p>
</li>
<li>
<p>Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹ï¼šä¸º Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œ<strong>é€šè¿‡ Object å¯¹è±¡å¤´è·å–åˆ°æŒé”çº¿ç¨‹</strong>ï¼Œå°† Monitor çš„ Owner ç½®ä¸º Thread-0ï¼Œå°† Object çš„å¯¹è±¡å¤´æŒ‡å‘é‡é‡çº§é”åœ°å€ï¼Œç„¶åè‡ªå·±è¿›å…¥ Monitor çš„ EntryList BLOCKED</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%862.png" alt=""></p>
</li>
<li>
<p>å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ CAS å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´å¤±è´¥ï¼Œè¿™æ—¶è¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹</p>
</li>
</ul>
<hr>
<h4 id="é”ä¼˜åŒ–">é”ä¼˜åŒ–</h4>
<h5 id="è‡ªæ—‹é”">è‡ªæ—‹é”</h5>
<p>é‡é‡çº§é”ç«äº‰æ—¶ï¼Œå°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œå¯ä»¥ä½¿ç”¨<strong>è‡ªæ—‹</strong>ï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰æ¥è¿›è¡Œä¼˜åŒ–ï¼Œé‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”</p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>è‡ªæ—‹å ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹æ—¶é—´ï¼Œå› ä¸ºåŒä¸€æ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿</li>
<li>è‡ªæ—‹å¤±è´¥çš„çº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€</li>
</ul>
<p>ä¼˜ç‚¹ï¼šä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ<strong>å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—</strong></p>
<p>ç¼ºç‚¹ï¼šå½“è‡ªæ—‹çš„çº¿ç¨‹è¶Šæ¥è¶Šå¤šæ—¶ï¼Œä¼šä¸æ–­çš„æ¶ˆè€— CPU èµ„æº</p>
<p>è‡ªæ—‹é”æƒ…å†µï¼š</p>
<ul>
<li>
<p>è‡ªæ—‹æˆåŠŸçš„æƒ…å†µï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E8%87%AA%E6%97%8B%E6%88%90%E5%8A%9F.png" style="zoom: 80%;" /></p>
</li>
<li>
<p>è‡ªæ—‹å¤±è´¥çš„æƒ…å†µï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-%E8%87%AA%E6%97%8B%E5%A4%B1%E8%B4%A5.png" style="zoom:80%;" />
</li>
</ul>
<p>è‡ªæ—‹é”è¯´æ˜ï¼š</p>
<ul>
<li>åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ¯”è¾ƒæ™ºèƒ½</li>
<li>Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½ï¼Œç”± JVM æ§åˆ¶</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰‹å†™è‡ªæ—‹é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">    <span class="comment">// æ³›å‹è£…çš„æ˜¯Threadï¼ŒåŸå­å¼•ç”¨çº¿ç¨‹</span></span><br><span class="line">    AtomicReference&lt;Thread&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; come in&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¼€å§‹è‡ªæ—‹ï¼ŒæœŸæœ›å€¼ä¸ºnullï¼Œæ›´æ–°å€¼æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">while</span> (!atomicReference.compareAndSet(<span class="literal">null</span>, thread)) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(thread.getName() + <span class="string">&quot; æ­£åœ¨è‡ªæ—‹&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; è‡ªæ—‹æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//çº¿ç¨‹ä½¿ç”¨å®Œé”æŠŠå¼•ç”¨å˜ä¸ºnull</span></span><br><span class="line">		atomicReference.compareAndSet(thread, <span class="literal">null</span>);</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; invoke unlock&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">SpinLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpinLock</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//å æœ‰é”</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®©mainçº¿ç¨‹æš‚åœ1ç§’ï¼Œä½¿å¾—t1çº¿ç¨‹ï¼Œå…ˆæ‰§è¡Œ</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="é”æ¶ˆé™¤">é”æ¶ˆé™¤</h5>
<p>é”æ¶ˆé™¤æ˜¯æŒ‡å¯¹äºè¢«æ£€æµ‹å‡ºä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„å…±äº«æ•°æ®çš„é”è¿›è¡Œæ¶ˆé™¤ï¼Œè¿™æ˜¯ JVM <strong>å³æ—¶ç¼–è¯‘å™¨çš„ä¼˜åŒ–</strong></p>
<p>é”æ¶ˆé™¤ä¸»è¦æ˜¯é€šè¿‡<strong>é€ƒé€¸åˆ†æ</strong>æ¥æ”¯æŒï¼Œå¦‚æœå †ä¸Šçš„å…±äº«æ•°æ®ä¸å¯èƒ½é€ƒé€¸å‡ºå»è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå®ƒä»¬å½“æˆç§æœ‰æ•°æ®å¯¹å¾…ï¼Œä¹Ÿå°±å¯ä»¥å°†å®ƒä»¬çš„é”è¿›è¡Œæ¶ˆé™¤ï¼ˆåŒæ­¥æ¶ˆé™¤ï¼šJVM é€ƒé€¸åˆ†æï¼‰</p>
<hr>
<h5 id="é”ç²—åŒ–">é”ç²—åŒ–</h5>
<p>å¯¹ç›¸åŒå¯¹è±¡å¤šæ¬¡åŠ é”ï¼Œå¯¼è‡´çº¿ç¨‹å‘ç”Ÿå¤šæ¬¡é‡å…¥ï¼Œé¢‘ç¹çš„åŠ é”æ“ä½œå°±ä¼šå¯¼è‡´æ€§èƒ½æŸè€—ï¼Œå¯ä»¥ä½¿ç”¨é”ç²—åŒ–æ–¹å¼ä¼˜åŒ–</p>
<p>å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°ä¸€ä¸²çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨</p>
<ul>
<li>
<p>ä¸€äº›çœ‹èµ·æ¥æ²¡æœ‰åŠ é”çš„ä»£ç ï¼Œå…¶å®éšå¼çš„åŠ äº†å¾ˆå¤šé”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s1 + s2 + s3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>String æ˜¯ä¸€ä¸ªä¸å¯å˜çš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šå¯¹ String çš„æ‹¼æ¥è‡ªåŠ¨ä¼˜åŒ–ã€‚åœ¨ JDK 1.5 ä¹‹å‰ï¼Œè½¬åŒ–ä¸º StringBuffer å¯¹è±¡çš„è¿ç»­ append() æ“ä½œï¼Œæ¯ä¸ª append() æ–¹æ³•ä¸­éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> &#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    sb.append(s3);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ‰©å±•åˆ°ç¬¬ä¸€ä¸ª append() æ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ª append() æ“ä½œä¹‹åï¼Œåªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥</p>
<hr>
<h4 id="å¤šæŠŠé”">å¤šæŠŠé”</h4>
<p>å¤šæŠŠä¸ç›¸å¹²çš„é”ï¼šä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚ç°åœ¨ä¸€äººè¦å­¦ä¹ ï¼Œä¸€äººè¦ç¡è§‰ï¼Œå¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½</p>
<p>å°†é”çš„ç²’åº¦ç»†åˆ†ï¼š</p>
<ul>
<li>å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦</li>
<li>åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”</li>
</ul>
<p>è§£å†³æ–¹æ³•ï¼šå‡†å¤‡å¤šä¸ªå¯¹è±¡é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">BigRoom</span> <span class="variable">bigRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigRoom</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; bigRoom.study(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; bigRoom.sleep(); &#125;).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BigRoom</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">studyRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">sleepRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sleepRoom) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;sleeping 2 å°æ—¶&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">study</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (studyRoom) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;study 1 å°æ—¶&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ´»è·ƒæ€§">æ´»è·ƒæ€§</h4>
<h5 id="æ­»é”">æ­»é”</h5>
<h6 id="å½¢æˆ">å½¢æˆ</h6>
<p>æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ï¼Œç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢</p>
<p>Java æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š</p>
<ol>
<li>äº’æ–¥æ¡ä»¶ï¼Œå³å½“èµ„æºè¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ˆå æœ‰ï¼‰æ—¶ï¼Œåˆ«çš„çº¿ç¨‹ä¸èƒ½ä½¿ç”¨</li>
<li>ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼Œèµ„æºè¯·æ±‚è€…ä¸èƒ½å¼ºåˆ¶ä»èµ„æºå æœ‰è€…æ‰‹ä¸­å¤ºå–èµ„æºï¼Œèµ„æºåªèƒ½ç”±èµ„æºå æœ‰è€…ä¸»åŠ¨é‡Šæ”¾</li>
<li>è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼Œå³å½“èµ„æºè¯·æ±‚è€…åœ¨è¯·æ±‚å…¶ä»–çš„èµ„æºçš„åŒæ—¶ä¿æŒå¯¹åŸæœ‰èµ„æºçš„å æœ‰</li>
<li>å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå³å­˜åœ¨ä¸€ä¸ªç­‰å¾…å¾ªç¯é˜Ÿåˆ—ï¼šp1 è¦ p2 çš„èµ„æºï¼Œp2 è¦ p1 çš„èµ„æºï¼Œå½¢æˆäº†ä¸€ä¸ªç­‰å¾…ç¯è·¯</li>
</ol>
<p>å››ä¸ªæ¡ä»¶éƒ½æˆç«‹çš„æ—¶å€™ï¼Œä¾¿å½¢æˆæ­»é”ã€‚æ­»é”æƒ…å†µä¸‹æ‰“ç ´ä¸Šè¿°ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œä¾¿å¯è®©æ­»é”æ¶ˆå¤±</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">resources1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">resources2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹1ï¼šå ç”¨èµ„æº1 ï¼Œè¯·æ±‚èµ„æº2</span></span><br><span class="line">            <span class="keyword">synchronized</span>(resources1)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹1å·²ç»å ç”¨äº†èµ„æº1ï¼Œå¼€å§‹è¯·æ±‚èµ„æº2&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);<span class="comment">//ä¼‘æ¯ä¸¤ç§’ï¼Œé˜²æ­¢çº¿ç¨‹1ç›´æ¥è¿è¡Œå®Œæˆã€‚</span></span><br><span class="line">                <span class="comment">//2ç§’å†…çº¿ç¨‹2è‚¯å®šå¯ä»¥é”ä½èµ„æº2</span></span><br><span class="line">                <span class="keyword">synchronized</span> (resources2)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹1å·²ç»å ç”¨äº†èµ„æº2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹2ï¼šå ç”¨èµ„æº2 ï¼Œè¯·æ±‚èµ„æº1</span></span><br><span class="line">            <span class="keyword">synchronized</span>(resources2)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹2å·²ç»å ç”¨äº†èµ„æº2ï¼Œå¼€å§‹è¯·æ±‚èµ„æº1&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (resources1)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹2å·²ç»å ç”¨äº†èµ„æº1&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h6 id="å®šä½">å®šä½</h6>
<p>å®šä½æ­»é”çš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ <code>jstack id</code> å®šä½æ­»é”ï¼Œæ‰¾åˆ°æ­»é”çš„çº¿ç¨‹å»æŸ¥çœ‹æºç ï¼Œè§£å†³ä¼˜åŒ–</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Thread-1&quot;</span> <span class="comment">#12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting formonitor entry [0x000000001f54f000]</span></span><br><span class="line">	java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line"><span class="comment">#çœç•¥</span></span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span> <span class="comment">#12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting for monitor entry [0x000000001f54f000]</span></span><br><span class="line">	java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line"><span class="comment">#çœç•¥</span></span><br><span class="line"></span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">    waiting to lock monitor 0x000000000361d378 (object 0x000000076b5bf1c0, a java.lang.Object),</span><br><span class="line">    <span class="built_in">which</span> is held by <span class="string">&quot;Thread-0&quot;</span></span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">    waiting to lock monitor 0x000000000361e768 (object 0x000000076b5bf1d0, a java.lang.Object),</span><br><span class="line">    <span class="built_in">which</span> is held by <span class="string">&quot;Thread-1&quot;</span></span><br><span class="line"></span><br><span class="line">Java stack information <span class="keyword">for</span> the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">    at thread.TestDeadLock.lambda$main<span class="variable">$1</span>(TestDeadLock.java:28)</span><br><span class="line">    - waiting to lock &lt;0x000000076b5bf1c0&gt; (a java.lang.Object)</span><br><span class="line">    - locked &lt;0x000000076b5bf1d0&gt; (a java.lang.Object)</span><br><span class="line">    at thread.TestDeadLock$$Lambda<span class="variable">$2</span>/883049899.run(Unknown Source)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">    at thread.TestDeadLock.lambda$main<span class="variable">$0</span>(TestDeadLock.java:15)</span><br><span class="line">    - waiting to lock &lt;0x000000076b5bf1d0&gt; (a java.lang.Object)</span><br><span class="line">    - locked &lt;0x000000076b5bf1c0&gt; (a java.lang.Object)</span><br><span class="line">    at thread.TestDeadLock$$Lambda<span class="variable">$1</span>/495053715</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ° CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ <code>top -Hp è¿›ç¨‹id</code> æ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ jstack <pid>çš„è¾“å‡ºæ¥çœ‹å„ä¸ªçº¿ç¨‹æ ˆ</p>
</li>
<li>
<p>é¿å…æ­»é”ï¼šé¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåº</p>
</li>
<li>
<p>å¯ä»¥ä½¿ç”¨ jconsole å·¥å…·ï¼Œåœ¨ <code>jdk\bin</code> ç›®å½•ä¸‹</p>
</li>
</ul>
<hr>
<h5 id="æ´»é”">æ´»é”</h5>
<p>æ´»é”ï¼šæŒ‡çš„æ˜¯ä»»åŠ¡æˆ–è€…æ‰§è¡Œè€…æ²¡æœ‰è¢«é˜»å¡ï¼Œç”±äºæŸäº›æ¡ä»¶æ²¡æœ‰æ»¡è¶³ï¼Œå¯¼è‡´ä¸€ç›´é‡å¤å°è¯•â€”å¤±è´¥â€”å°è¯•â€”å¤±è´¥çš„è¿‡ç¨‹</p>
<p>ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestLiveLock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                count--;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€count:&quot;</span> + count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                count++;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒcount:&quot;</span>+ count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="é¥¥é¥¿">é¥¥é¥¿</h5>
<p>é¥¥é¥¿ï¼šä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸ</p>
<hr>
<h3 id="wait-ify">wait-ify</h3>
<h4 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h4>
<p>éœ€è¦è·å–å¯¹è±¡é”åæ‰å¯ä»¥è°ƒç”¨ <code>é”å¯¹è±¡.wait()</code>ï¼Œnotify éšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼ŒnotifyAll å”¤é†’æ‰€æœ‰çº¿ç¨‹å»ç«äº‰ CPU</p>
<p>Object ç±» APIï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">()</span>:å”¤é†’æ­£åœ¨ç­‰å¾…å¯¹è±¡ç›‘è§†å™¨çš„å•ä¸ªçº¿ç¨‹ã€‚</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">notifyAll</span><span class="params">()</span>:å”¤é†’æ­£åœ¨ç­‰å¾…å¯¹è±¡ç›‘è§†å™¨çš„æ‰€æœ‰çº¿ç¨‹ã€‚</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">wait</span><span class="params">()</span>:å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¯¥å¯¹è±¡çš„ notify() æ–¹æ³•æˆ– notifyAll()æ–¹æ³•ã€‚</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">wait</span><span class="params">(<span class="type">long</span> timeout)</span>:æœ‰æ—¶é™çš„ç­‰å¾…, åˆ°næ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢«å”¤é†’</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š<strong>wait æ˜¯æŒ‚èµ·çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’çš„éƒ½æ˜¯æŒ‚èµ·æ“ä½œ</strong>ï¼Œé˜»å¡çº¿ç¨‹å¯ä»¥è‡ªå·±å»äº‰æŠ¢é”ï¼ŒæŒ‚èµ·çš„çº¿ç¨‹éœ€è¦å”¤é†’åå»äº‰æŠ¢é”</p>
<p>å¯¹æ¯” sleep()ï¼š</p>
<ul>
<li>åŸç†ä¸åŒï¼šsleep() æ–¹æ³•æ˜¯å±äº Thread ç±»ï¼Œæ˜¯çº¿ç¨‹ç”¨æ¥æ§åˆ¶è‡ªèº«æµç¨‹çš„ï¼Œä½¿æ­¤çº¿ç¨‹æš‚åœæ‰§è¡Œä¸€æ®µæ—¶é—´è€ŒæŠŠæ‰§è¡Œæœºä¼šè®©ç»™å…¶ä»–çº¿ç¨‹ï¼›wait() æ–¹æ³•å±äº Object ç±»ï¼Œç”¨äºçº¿ç¨‹é—´é€šä¿¡</li>
<li>å¯¹<strong>é”çš„å¤„ç†æœºåˆ¶</strong>ä¸åŒï¼šè°ƒç”¨ sleep() æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œå½“è°ƒç”¨ wait() æ–¹æ³•çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šæ”¾å¼ƒå¯¹è±¡é”ï¼Œè¿›å…¥ç­‰å¾…æ­¤å¯¹è±¡çš„ç­‰å¾…é”å®šæ± ï¼ˆä¸é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹æ€ä¹ˆæŠ¢å åˆ°é”æ‰§è¡Œå”¤é†’æ“ä½œï¼‰ï¼Œä½†æ˜¯éƒ½ä¼šé‡Šæ”¾ CPU</li>
<li>ä½¿ç”¨åŒºåŸŸä¸åŒï¼šwait() æ–¹æ³•å¿…é¡»æ”¾åœ¨**åŒæ­¥æ§åˆ¶æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ï¼ˆå…ˆè·å–é”ï¼‰**ä¸­ä½¿ç”¨ï¼Œsleep() æ–¹æ³•åˆ™å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨</li>
</ul>
<p>åº•å±‚åŸç†ï¼š</p>
<ul>
<li>Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€</li>
<li>BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡</li>
<li>BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’</li>
<li>WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’ï¼Œå”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œ<strong>éœ€è¦è¿›å…¥ EntryList é‡æ–°ç«äº‰</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-11--JUC-Monitor%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%862-20250930114517209.png" alt=""></p>
<hr>
<h4 id="ä»£ç ä¼˜åŒ–">ä»£ç ä¼˜åŒ–</h4>
<p>è™šå‡å”¤é†’ï¼šnotify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ç¨‹</p>
<p>è§£å†³æ–¹æ³•ï¼šé‡‡ç”¨ notifyAll</p>
<p>notifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œæ— æ³•é‡æ–°åˆ¤æ–­</p>
<p>è§£å†³æ–¹æ³•ï¼šç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;    <span class="comment">//æœ‰æ²¡æœ‰çƒŸ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">while</span> (!hasCigarette) &#123;<span class="comment">//whileé˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–é€åˆ°æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (!hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–é€åˆ°æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿ</span></span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                hasTakeout = <span class="literal">true</span>;</span><br><span class="line">				<span class="comment">//log.debug(&quot;çƒŸåˆ°äº†å™¢ï¼&quot;);</span></span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†å™¢ï¼&quot;</span>);</span><br><span class="line">                room.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;é€å¤–å–çš„&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="park-un">park-un</h3>
<p>LockSupport æ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„<strong>çº¿ç¨‹åŸè¯­</strong></p>
<p>LockSupport ç±»æ–¹æ³•ï¼š</p>
<ul>
<li><code>LockSupport.park()</code>ï¼šæš‚åœå½“å‰çº¿ç¨‹ï¼ŒæŒ‚èµ·åŸè¯­</li>
<li><code>LockSupport.unpark(æš‚åœçš„çº¿ç¨‹å¯¹è±¡)</code>ï¼šæ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;start...&quot;</span>);	<span class="comment">//1</span></span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);<span class="comment">// Thread.sleep(3000)</span></span><br><span class="line">        <span class="comment">// å…ˆ park å† unpark å’Œå…ˆ unpark å† park æ•ˆæœä¸€æ ·ï¼Œéƒ½ä¼šç›´æ¥æ¢å¤çº¿ç¨‹çš„è¿è¡Œ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;park...&quot;</span>);	<span class="comment">//2</span></span><br><span class="line">        LockSupport.park();</span><br><span class="line">        System.out.println(<span class="string">&quot;resume...&quot;</span>);<span class="comment">//4</span></span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">   	Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;unpark...&quot;</span>);	<span class="comment">//3</span></span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LockSupport å‡ºç°å°±æ˜¯ä¸ºäº†å¢å¼º wait &amp; notify çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ parkã€unpark ä¸éœ€è¦</li>
<li>park &amp; unpark <strong>ä»¥çº¿ç¨‹ä¸ºå•ä½</strong>æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</li>
<li>park &amp; unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait &amp; notify ä¸èƒ½å…ˆ notifyã€‚ç±»æ¯”ç”Ÿäº§æ¶ˆè´¹ï¼Œå…ˆæ¶ˆè´¹å‘ç°æœ‰äº§å“å°±æ¶ˆè´¹ï¼Œæ²¡æœ‰å°±ç­‰å¾…ï¼›å…ˆç”Ÿäº§å°±ç›´æ¥äº§ç”Ÿå•†å“ï¼Œç„¶åçº¿ç¨‹ç›´æ¥æ¶ˆè´¹</li>
<li>wait ä¼šé‡Šæ”¾é”èµ„æºè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ<strong>park ä¸ä¼šé‡Šæ”¾é”èµ„æº</strong>ï¼Œåªè´Ÿè´£é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¼šé‡Šæ”¾ CPU</li>
</ul>
<p>åŸç†ï¼šç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…</p>
<ul>
<li>å…ˆ parkï¼š
<ol>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li>
<li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 0ï¼Œè¿™æ—¶è·å¾— _mutex äº’æ–¥é”</li>
<li>çº¿ç¨‹è¿›å…¥ _cond æ¡ä»¶å˜é‡æŒ‚èµ·</li>
<li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li>
<li>å”¤é†’ _cond æ¡ä»¶å˜é‡ä¸­çš„ Thread_0ï¼ŒThread_0 æ¢å¤è¿è¡Œï¼Œè®¾ç½® _counter ä¸º 0</li>
</ol>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-park%E5%8E%9F%E7%90%861.png" alt=""></p>
<ul>
<li>
<p>å…ˆ unparkï¼š</p>
<ol>
<li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li>
<li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­è¿è¡Œï¼Œè®¾ç½® _counter ä¸º 0</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-park%E5%8E%9F%E7%90%862.png" alt=""></p>
</li>
</ul>
<hr>
<h3 id="å®‰å…¨åˆ†æ">å®‰å…¨åˆ†æ</h3>
<p>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡ï¼š</p>
<ul>
<li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š
<ul>
<li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜</li>
</ul>
</li>
</ul>
<p>å±€éƒ¨å˜é‡ï¼š</p>
<ul>
<li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡ä¸ä¸€å®šçº¿ç¨‹å®‰å…¨ï¼ˆé€ƒé€¸åˆ†æï¼‰ï¼š
<ul>
<li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆæ¯ä¸€ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªæ ˆå¸§ï¼‰</li>
<li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆæš´éœ²å¼•ç”¨ï¼‰</li>
</ul>
</li>
</ul>
<p>å¸¸è§çº¿ç¨‹å®‰å…¨ç±»ï¼šStringã€Integerã€StringBufferã€Randomã€Vectorã€Hashtableã€java.util.concurrent åŒ…</p>
<ul>
<li>
<p>çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</li>
<li>
<p><strong>æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„ï¼Œä½†å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„</strong>ï¼Œåªèƒ½ä¿è¯è°ƒç”¨çš„æ–¹æ³•å†…éƒ¨å®‰å…¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="comment">// çº¿ç¨‹1ï¼Œçº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span>(table.get(<span class="string">&quot;key&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">	table.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ— çŠ¶æ€ç±»çº¿ç¨‹å®‰å…¨ï¼Œå°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡çš„ç±»</p>
<p>ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨ï¼šStringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œ<strong>å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜</strong>ï¼Œæ‰€ä»¥æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨</p>
<ul>
<li>
<p>replace ç­‰æ–¹æ³•åº•å±‚æ˜¯æ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¤åˆ¶è¿‡å»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();	<span class="comment">// çº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="type">String</span> <span class="variable">S1</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;							<span class="comment">// çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">S2</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;					<span class="comment">// çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="type">Date</span> <span class="variable">D1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();						<span class="comment">// çº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Date</span> <span class="variable">D2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();					<span class="comment">// çº¿ç¨‹ä¸å®‰å…¨ï¼Œfinalè®©D2å¼•ç”¨çš„å¯¹è±¡ä¸èƒ½å˜ï¼Œä½†å¯¹è±¡çš„å†…å®¹å¯ä»¥å˜</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æŠ½è±¡æ–¹æ³•å¦‚æœæœ‰å‚æ•°ï¼Œè¢«é‡å†™åè¡Œä¸ºä¸ç¡®å®šå¯èƒ½é€ æˆçº¿ç¨‹ä¸å®‰å…¨ï¼Œè¢«ç§°ä¹‹ä¸ºå¤–æ˜Ÿæ–¹æ³•ï¼š<code>public abstract foo(Student s);</code></p>
<hr>
<h3 id="åŒæ­¥æ¨¡å¼">åŒæ­¥æ¨¡å¼</h3>
<h4 id="ä¿æŠ¤æ€§æš‚åœ">ä¿æŠ¤æ€§æš‚åœ</h4>
<h5 id="å•ä»»åŠ¡ç‰ˆ">å•ä»»åŠ¡ç‰ˆ</h5>
<p>Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p>
<ul>
<li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©å®ƒä»¬å…³è”åŒä¸€ä¸ª GuardedObject</li>
<li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰</li>
<li>JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GuardedObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObjectV2</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        object.complete(Arrays.asList(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>));</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> object.get(<span class="number">2500</span>);</span><br><span class="line">    <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;get response: [&#123;&#125;] lines&quot;</span>, ((List&lt;String&gt;) response).size());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;can&#x27;t get response&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ç»“æœ</span></span><br><span class="line">    <span class="comment">//timeout :æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> millis)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// 1) è®°å½•æœ€åˆæ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// 2) å·²ç»ç»å†çš„æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timePassed</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> millis - timePassed;</span><br><span class="line">                log.debug(<span class="string">&quot;waitTime: &#123;&#125;&quot;</span>, waitTime);</span><br><span class="line">                <span class="comment">//ç»å†æ—¶é—´è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´é€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (waitTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;break...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait(waitTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400</span></span><br><span class="line">                timePassed = System.currentTimeMillis() - begin;</span><br><span class="line">                log.debug(<span class="string">&quot;timePassed: &#123;&#125;, object is null &#123;&#125;&quot;</span>,</span><br><span class="line">                        timePassed, response == <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº§ç”Ÿç»“æœ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            log.debug(<span class="string">&quot;notify...&quot;</span>);</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="å¤šä»»åŠ¡ç‰ˆ">å¤šä»»åŠ¡ç‰ˆ</h5>
<p>å¤šä»»åŠ¡ç‰ˆä¿æŠ¤æ€§æš‚åœï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%89%88.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">People</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">for</span> (Integer id : Mailboxes.getIds()) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Postman</span>(id, id + <span class="string">&quot;å·å¿«é€’åˆ°äº†&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.People&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ”¶ä¿¡</span></span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> Mailboxes.createGuardedObject();</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹æ”¶ä¿¡i d:&#123;&#125;&quot;</span>, guardedObject.getId());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">mail</span> <span class="operator">=</span> guardedObject.get(<span class="number">5000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ”¶åˆ°ä¿¡id:&#123;&#125;ï¼Œå†…å®¹:&#123;&#125;&quot;</span>, guardedObject.getId(),mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Postman</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String mail;</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> Mailboxes.getGuardedObject(id);</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹é€ä¿¡i d:&#123;&#125;ï¼Œå†…å®¹:&#123;&#125;&quot;</span>, guardedObject.getId(),mail);</span><br><span class="line">        guardedObject.complete(mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span>  <span class="title class_">Mailboxes</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, GuardedObject&gt; boxes = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº§ç”Ÿå”¯ä¸€çš„id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">generateId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">getGuardedObject</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">createGuardedObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>(generateId());</span><br><span class="line">        boxes.put(go.getId(), go);</span><br><span class="line">        <span class="keyword">return</span> go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Integer&gt; <span class="title function_">getIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="comment">//æ ‡è¯†ï¼ŒGuarded Object</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;<span class="comment">//æ·»åŠ get setæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é¡ºåºè¾“å‡º">é¡ºåºè¾“å‡º</h4>
<p>é¡ºåºè¾“å‡º 2 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; &#125;</span></span><br><span class="line">            <span class="comment">// å½“æ²¡æœ‰è®¸å¯æ—¶ï¼Œå½“å‰çº¿ç¨‹æš‚åœè¿è¡Œï¼›æœ‰è®¸å¯æ—¶ï¼Œç”¨æ‰è¿™ä¸ªè®¸å¯ï¼Œå½“å‰çº¿ç¨‹æ¢å¤è¿è¡Œ</span></span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">            <span class="comment">// ç»™çº¿ç¨‹ t1 å‘æ”¾ã€è®¸å¯ã€ï¼ˆå¤šæ¬¡è¿ç»­è°ƒç”¨ unpark åªä¼šå‘æ”¾ä¸€ä¸ªã€è®¸å¯ã€ï¼‰</span></span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">            <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">500</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="äº¤æ›¿è¾“å‡º">äº¤æ›¿è¾“å‡º</h4>
<p>è¿ç»­è¾“å‡º 5 æ¬¡ abc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">day2_14</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">AwaitSignal</span> <span class="variable">awaitSignal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AwaitSignal</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">a</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">b</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">c</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;a&quot;</span>, a, b);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;b&quot;</span>, b, c);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;c&quot;</span>, c, a);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        awaitSignal.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            a.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            awaitSignal.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AwaitSignal</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwaitSignal</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‚æ•°1ï¼šæ‰“å°å†…å®¹  å‚æ•°äºŒï¼šæ¡ä»¶å˜é‡  å‚æ•°äºŒï¼šå”¤é†’ä¸‹ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, Condition condition, Condition next)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">                System.out.print(str);</span><br><span class="line">                next.signal();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å¼‚æ­¥æ¨¡å¼">å¼‚æ­¥æ¨¡å¼</h3>
<h4 id="ä¼ ç»Ÿç‰ˆ">ä¼ ç»Ÿç‰ˆ</h4>
<p>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShareData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­  é˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">            <span class="keyword">while</span>(number != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…ä¸èƒ½ç”Ÿäº§</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¹²æ´»</span></span><br><span class="line">            number++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t &quot;</span> + number);</span><br><span class="line">            <span class="comment">// é€šçŸ¥ å”¤é†’</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ é˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">            <span class="keyword">while</span>(number == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…ä¸èƒ½æ¶ˆè´¹</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¹²æ´»</span></span><br><span class="line">            number--;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t &quot;</span> + number);</span><br><span class="line">            <span class="comment">// é€šçŸ¥ å”¤é†’</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TraditionalProducerConsumer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ShareData</span> <span class="variable">shareData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShareData</span>();</span><br><span class="line">        <span class="comment">// t1çº¿ç¨‹ï¼Œç”Ÿäº§</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            	shareData.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// t2çº¿ç¨‹ï¼Œæ¶ˆè´¹</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">				shareData.decrement();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ”¹è¿›ç‰ˆ">æ”¹è¿›ç‰ˆ</h4>
<p>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼š</p>
<ul>
<li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æºï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”</li>
<li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li>
<li>JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                queue.put(<span class="keyword">new</span> <span class="title class_">Message</span>(id,<span class="string">&quot;å€¼&quot;</span>+id));</span><br><span class="line">            &#125;, <span class="string">&quot;ç”Ÿäº§è€…&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> queue.take();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;æ¶ˆè´¹è€…&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¶ˆæ¯é˜Ÿåˆ—ç±»ï¼ŒJavaé—´çº¿ç¨‹ä¹‹é—´é€šä¿¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageQueue</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Message&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();<span class="comment">//æ¶ˆæ¯çš„é˜Ÿåˆ—é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;<span class="comment">//é˜Ÿåˆ—å®¹é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span> (list.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sout(Thread.currentThread().getName() + <span class="string">&quot;:é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ä»é˜Ÿåˆ—çš„å¤´éƒ¨è·å–æ¶ˆæ¯è¿”å›</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> list.removeFirst();</span><br><span class="line">            sout(Thread.currentThread().getName() + <span class="string">&quot;ï¼šå·²æ¶ˆè´¹æ¶ˆæ¯--&quot;</span> + message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜å…¥æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="comment">//æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æ»¡</span></span><br><span class="line">            <span class="keyword">while</span> (list.size() == capacity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sout(Thread.currentThread().getName()+<span class="string">&quot;:é˜Ÿåˆ—ä¸ºå·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">            list.addLast(message);</span><br><span class="line">            sout(Thread.currentThread().getName() + <span class="string">&quot;:å·²ç”Ÿäº§æ¶ˆæ¯--&quot;</span> + message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line">	<span class="comment">//get set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é˜»å¡é˜Ÿåˆ—">é˜»å¡é˜Ÿåˆ—</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">consumer</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">producer</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    BlockingQueue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line">    producer.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            queue.put(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    consumer.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…æ¶ˆè´¹...&quot;</span>);</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> queue.take();</span><br><span class="line">            System.out.println(<span class="string">&quot;ç»“æœä¸º:&quot;</span> + result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="å†…å­˜">å†…å­˜</h2>
<h3 id="JMM">JMM</h3>
<h4 id="å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</h4>
<p>Java å†…å­˜æ¨¡å‹æ˜¯ Java Memory Modelï¼ˆJMMï¼‰ï¼Œæœ¬èº«æ˜¯ä¸€ç§<strong>æŠ½è±¡çš„æ¦‚å¿µ</strong>ï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œæè¿°çš„æ˜¯ä¸€ç»„è§„åˆ™æˆ–è§„èŒƒï¼Œé€šè¿‡è¿™ç»„è§„èŒƒå®šä¹‰äº†ç¨‹åºä¸­å„ä¸ªå˜é‡ï¼ˆåŒ…æ‹¬å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼‰çš„è®¿é—®æ–¹å¼</p>
<p>JMM ä½œç”¨ï¼š</p>
<ul>
<li>å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œå®ç°è®© Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœ</li>
<li>è§„å®šäº†çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´çš„ä¸€äº›å…³ç³»</li>
</ul>
<p>æ ¹æ® JMM çš„è®¾è®¡ï¼Œç³»ç»Ÿå­˜åœ¨ä¸€ä¸ªä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ï¼ŒJava ä¸­æ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å­˜ä¸­ï¼Œå¯¹äºæ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„ï¼›æ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆWorking Memoryï¼‰ï¼Œå·¥ä½œå†…å­˜ä¸­ä¿å­˜çš„æ˜¯ä¸»å­˜ä¸­æŸäº›<strong>å˜é‡çš„æ‹·è´</strong>ï¼Œçº¿ç¨‹å¯¹æ‰€æœ‰å˜é‡çš„æ“ä½œéƒ½æ˜¯å…ˆå¯¹å˜é‡è¿›è¡Œæ‹·è´ï¼Œç„¶ååœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å˜é‡ï¼›çº¿ç¨‹ä¹‹é—´æ— æ³•ç›¸äº’ç›´æ¥è®¿é—®ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼ˆä¼ é€’ï¼‰å¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<p>ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ï¼š</p>
<ul>
<li>ä¸»å†…å­˜ï¼šè®¡ç®—æœºçš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç»å¸¸æåˆ°çš„ 8G å†…å­˜ï¼Œ16G å†…å­˜ï¼Œå­˜å‚¨æ‰€æœ‰å…±äº«å˜é‡çš„å€¼</li>
<li>å·¥ä½œå†…å­˜ï¼šå­˜å‚¨è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å…±äº«å˜é‡åœ¨ä¸»å†…å­˜çš„çš„å€¼çš„å‰¯æœ¬æ‹·è´</li>
</ul>
<p><strong>JVM å’Œ JMM ä¹‹é—´çš„å…³ç³»</strong>ï¼šJMM ä¸­çš„ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸ JVM ä¸­çš„ Java å †ã€æ ˆã€æ–¹æ³•åŒºç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å†…å­˜åˆ’åˆ†ï¼Œè¿™ä¸¤è€…åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œå¦‚æœä¸¤è€…ä¸€å®šè¦å‹‰å¼ºå¯¹åº”èµ·æ¥ï¼š</p>
<ul>
<li>ä¸»å†…å­˜ä¸»è¦å¯¹åº”äº Java å †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯¹åº”äºè™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸ</li>
<li>ä»æ›´ä½å±‚æ¬¡ä¸Šè¯´ï¼Œä¸»å†…å­˜ç›´æ¥å¯¹åº”äºç‰©ç†ç¡¬ä»¶çš„å†…å­˜ï¼Œå·¥ä½œå†…å­˜å¯¹åº”å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜</li>
</ul>
<hr>
<h4 id="å†…å­˜äº¤äº’">å†…å­˜äº¤äº’</h4>
<p>Java å†…å­˜æ¨¡å‹å®šä¹‰äº† 8 ä¸ªæ“ä½œæ¥å®Œæˆä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„äº¤äº’æ“ä½œï¼Œæ¯ä¸ªæ“ä½œéƒ½æ˜¯<strong>åŸå­</strong>çš„</p>
<p>éåŸå­åå®šï¼šæ²¡æœ‰è¢« volatile ä¿®é¥°çš„ longã€double å¤–ï¼Œé»˜è®¤æŒ‰ç…§ä¸¤æ¬¡ 32 ä½çš„æ“ä½œ</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM-%E5%86%85%E5%AD%98%E4%BA%A4%E4%BA%92.png" style="zoom: 67%;" />
<ul>
<li>lockï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå°†ä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºè¢«ä¸€ä¸ªçº¿ç¨‹ç‹¬å çŠ¶æ€ï¼ˆå¯¹åº” monitorenterï¼‰</li>
<li>unclockï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå°†ä¸€ä¸ªå˜é‡ä»ç‹¬å çŠ¶æ€é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šï¼ˆå¯¹åº” monitorexitï¼‰</li>
<li>readï¼šä½œç”¨äºä¸»å†…å­˜ï¼ŒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°å·¥ä½œå†…å­˜ä¸­</li>
<li>loadï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œåœ¨ read ä¹‹åæ‰§è¡Œï¼ŒæŠŠ read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­</li>
<li>useï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™<strong>æ‰§è¡Œå¼•æ“</strong>ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªä½¿ç”¨åˆ°å˜é‡çš„æ“ä½œæ—¶éƒ½è¦ä½¿ç”¨è¯¥æŒ‡ä»¤</li>
<li>assignï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„ä¸€ä¸ªå€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡</li>
<li>storeï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­</li>
<li>writeï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œåœ¨ store ä¹‹åæ‰§è¡Œï¼ŒæŠŠ store å¾—åˆ°çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md">https://github.com/CyC2018/CS-Notes/blob/master/notes/Java å¹¶å‘.md</a></p>
<hr>
<h4 id="ä¸‰å¤§ç‰¹æ€§">ä¸‰å¤§ç‰¹æ€§</h4>
<h5 id="å¯è§æ€§">å¯è§æ€§</h5>
<p>å¯è§æ€§ï¼šæ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼</p>
<p>å­˜åœ¨ä¸å¯è§é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ç”±äºç¼“å­˜çš„å­˜åœ¨ï¼Œçº¿ç¨‹æŒæœ‰çš„æ˜¯å…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œæ— æ³•æ„ŸçŸ¥å…¶ä»–çº¿ç¨‹å¯¹äºå…±äº«å˜é‡çš„æ›´æ”¹ï¼Œå¯¼è‡´è¯»å–çš„å€¼ä¸æ˜¯æœ€æ–°çš„ã€‚ä½†æ˜¯ final ä¿®é¥°çš„å˜é‡æ˜¯<strong>ä¸å¯å˜</strong>çš„ï¼Œå°±ç®—æœ‰ç¼“å­˜ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ä¸å¯è§çš„é—®é¢˜</p>
<p>main çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">run</span> <span class="operator">=</span> <span class="literal">true</span>;	<span class="comment">//æ·»åŠ volatile</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(run)&#123;</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">        &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">    t.start();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    run = <span class="literal">false</span>; <span class="comment">// çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸå› ï¼š</p>
<ul>
<li>åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜</li>
<li>å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡</li>
<li>1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM-%E5%8F%AF%E8%A7%81%E6%80%A7%E4%BE%8B%E5%AD%90.png" alt=""></p>
<hr>
<h5 id="åŸå­æ€§">åŸå­æ€§</h5>
<p>åŸå­æ€§ï¼šä¸å¯åˆ†å‰²ï¼Œå®Œæ•´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ªçº¿ç¨‹æ­£åœ¨åšæŸä¸ªå…·ä½“ä¸šåŠ¡æ—¶ï¼Œä¸­é—´ä¸å¯ä»¥è¢«åˆ†å‰²ï¼Œéœ€è¦å…·ä½“å®Œæˆï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ï¼Œä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</p>
<p>å®šä¹‰åŸå­æ“ä½œçš„ä½¿ç”¨è§„åˆ™ï¼š</p>
<ol>
<li>ä¸å…è®¸ read å’Œ loadã€store å’Œ write æ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå¿…é¡»é¡ºåºæ‰§è¡Œï¼Œä½†æ˜¯ä¸è¦æ±‚è¿ç»­</li>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒ assign æ“ä½œï¼Œå¿…é¡»åŒæ­¥å›ä¸»å­˜</li>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥ä¼šä¸»å†…å­˜ä¸­</li>
<li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆassign æˆ–è€… loadï¼‰çš„å˜é‡ï¼Œå³å¯¹ä¸€ä¸ªå˜é‡å®æ–½ use å’Œ store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆè‡ªè¡Œ assign å’Œ load æ“ä½œ</li>
<li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰<strong>æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock</strong> æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ï¼Œ<strong>lock å’Œ unlock å¿…é¡»æˆå¯¹å‡ºç°</strong></li>
<li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼š<strong>æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼</strong>ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡ä¹‹å‰éœ€è¦é‡æ–°ä»ä¸»å­˜åŠ è½½</li>
<li>å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸æ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡</li>
<li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»<strong>å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜</strong>ä¸­ï¼ˆæ‰§è¡Œ store å’Œ write æ“ä½œï¼‰</li>
</ol>
<hr>
<h5 id="æœ‰åºæ€§">æœ‰åºæ€§</h5>
<p>æœ‰åºæ€§ï¼šåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›åœ¨ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ï¼Œæ— åºæ˜¯å› ä¸ºå‘ç”Ÿäº†æŒ‡ä»¤é‡æ’åº</p>
<p>CPU çš„åŸºæœ¬å·¥ä½œæ˜¯æ‰§è¡Œå­˜å‚¨çš„æŒ‡ä»¤åºåˆ—ï¼Œå³ç¨‹åºï¼Œç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹å®é™…ä¸Šæ˜¯ä¸æ–­åœ°å–å‡ºæŒ‡ä»¤ã€åˆ†ææŒ‡ä»¤ã€æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤é‡æ’ï¼Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æºä»£ç  -&gt; ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’ -&gt; æŒ‡ä»¤å¹¶è¡Œçš„é‡æ’ -&gt; å†…å­˜ç³»ç»Ÿçš„é‡æ’ -&gt; æœ€ç»ˆæ‰§è¡ŒæŒ‡ä»¤</span><br></pre></td></tr></table></figure>
<p>ç°ä»£ CPU æ”¯æŒå¤šçº§æŒ‡ä»¤æµæ°´çº¿ï¼Œå‡ ä¹æ‰€æœ‰çš„å†¯â€¢è¯ºä¼Šæ›¼å‹è®¡ç®—æœºçš„ CPUï¼Œå…¶å·¥ä½œéƒ½å¯ä»¥åˆ†ä¸º 5 ä¸ªé˜¶æ®µï¼šå–æŒ‡ä»¤ã€æŒ‡ä»¤è¯‘ç ã€æ‰§è¡ŒæŒ‡ä»¤ã€è®¿å­˜å–æ•°å’Œç»“æœå†™å›ï¼Œå¯ä»¥ç§°ä¹‹ä¸º<strong>äº”çº§æŒ‡ä»¤æµæ°´çº¿</strong>ã€‚CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„<strong>ä¸åŒé˜¶æ®µ</strong>ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸åŒçš„é˜¶æ®µï¼‰ï¼Œæœ¬è´¨ä¸Šæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å˜ç›¸åœ°æé«˜äº†æŒ‡ä»¤åœ°ååç‡</p>
<p>å¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶ï¼Œå¿…é¡»è¦è€ƒè™‘<strong>æŒ‡ä»¤ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§</strong></p>
<ul>
<li>å•çº¿ç¨‹ç¯å¢ƒä¹Ÿå­˜åœ¨æŒ‡ä»¤é‡æ’ï¼Œç”±äºå­˜åœ¨ä¾èµ–æ€§ï¼Œæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºçš„ç»“æœä¸€è‡´</li>
<li>å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ï¼Œä¼šè·å–å…¶ä»–çº¿ç¨‹å¤„åœ¨ä¸åŒé˜¶æ®µçš„æŒ‡ä»¤åŒæ—¶æ‰§è¡Œ</li>
</ul>
<p>è¡¥å……çŸ¥è¯†ï¼š</p>
<ul>
<li>æŒ‡ä»¤å‘¨æœŸæ˜¯å–å‡ºä¸€æ¡æŒ‡ä»¤å¹¶æ‰§è¡Œè¿™æ¡æŒ‡ä»¤çš„æ—¶é—´ï¼Œä¸€èˆ¬ç”±è‹¥å¹²ä¸ªæœºå™¨å‘¨æœŸç»„æˆ</li>
<li>æœºå™¨å‘¨æœŸä¹Ÿç§°ä¸º CPU å‘¨æœŸï¼Œä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé˜¶æ®µï¼ˆå¦‚å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œç­‰ï¼‰ï¼Œæ¯ä¸€é˜¶æ®µå®Œæˆä¸€ä¸ªåŸºæœ¬æ“ä½œï¼Œå®Œæˆä¸€ä¸ªåŸºæœ¬æ“ä½œæ‰€éœ€è¦çš„æ—¶é—´ç§°ä¸ºæœºå™¨å‘¨æœŸ</li>
<li>æŒ¯è¡å‘¨æœŸæŒ‡å‘¨æœŸæ€§ä¿¡å·ä½œå‘¨æœŸæ€§é‡å¤å˜åŒ–çš„æ—¶é—´é—´éš”</li>
</ul>
<hr>
<h3 id="cache">cache</h3>
<h4 id="ç¼“å­˜æœºåˆ¶">ç¼“å­˜æœºåˆ¶</h4>
<h5 id="ç¼“å­˜ç»“æ„">ç¼“å­˜ç»“æ„</h5>
<p>åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPU é«˜é€Ÿç¼“å­˜ï¼ˆCPU Cacheï¼Œç®€ç§°ç¼“å­˜ï¼‰æ˜¯ç”¨äºå‡å°‘å¤„ç†å™¨è®¿é—®å†…å­˜æ‰€éœ€å¹³å‡æ—¶é—´çš„éƒ¨ä»¶ï¼›åœ¨å­˜å‚¨ä½“ç³»ä¸­ä½äºè‡ªé¡¶å‘ä¸‹çš„ç¬¬äºŒå±‚ï¼Œä»…æ¬¡äº CPU å¯„å­˜å™¨ï¼›å…¶å®¹é‡è¿œå°äºå†…å­˜ï¼Œä½†é€Ÿåº¦å´å¯ä»¥æ¥è¿‘å¤„ç†å™¨çš„é¢‘ç‡</p>
<p>CPU å¤„ç†å™¨é€Ÿåº¦è¿œè¿œå¤§äºåœ¨ä¸»å†…å­˜ä¸­çš„ï¼Œä¸ºäº†è§£å†³é€Ÿåº¦å·®å¼‚ï¼Œåœ¨å®ƒä»¬ä¹‹é—´æ¶è®¾äº†å¤šçº§ç¼“å­˜ï¼Œå¦‚ L1ã€L2ã€L3 çº§åˆ«çš„ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜ç¦» CPU è¶Šè¿‘å°±è¶Šå¿«ï¼Œå°†é¢‘ç¹æ“ä½œçš„æ•°æ®ç¼“å­˜åˆ°è¿™é‡Œï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM-CPU%E7%BC%93%E5%AD%98%E7%BB%93%E6%9E%84.png" style="zoom: 50%;" />
<table>
<thead>
<tr>
<th>ä» CPU åˆ°</th>
<th>å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯„å­˜å™¨</td>
<td>1 cycle (4GHz çš„ CPU çº¦ä¸º 0.25ns)</td>
</tr>
<tr>
<td>L1</td>
<td>3~4 cycle</td>
</tr>
<tr>
<td>L2</td>
<td>10~20 cycle</td>
</tr>
<tr>
<td>L3</td>
<td>40~45 cycle</td>
</tr>
<tr>
<td>å†…å­˜</td>
<td>120~240 cycle</td>
</tr>
</tbody>
</table>
<h5 id="ç¼“å­˜ä½¿ç”¨">ç¼“å­˜ä½¿ç”¨</h5>
<p>å½“å¤„ç†å™¨å‘å‡ºå†…å­˜è®¿é—®è¯·æ±‚æ—¶ï¼Œä¼šå…ˆæŸ¥çœ‹ç¼“å­˜å†…æ˜¯å¦æœ‰è¯·æ±‚æ•°æ®ï¼Œå¦‚æœå­˜åœ¨ï¼ˆå‘½ä¸­ï¼‰ï¼Œåˆ™ä¸ç”¨è®¿é—®å†…å­˜ç›´æ¥è¿”å›è¯¥æ•°æ®ï¼›å¦‚æœä¸å­˜åœ¨ï¼ˆå¤±æ•ˆï¼‰ï¼Œåˆ™è¦å…ˆæŠŠå†…å­˜ä¸­çš„ç›¸åº”æ•°æ®è½½å…¥ç¼“å­˜ï¼Œå†å°†å…¶è¿”å›å¤„ç†å™¨</p>
<p>ç¼“å­˜ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œä¸»è¦å› ä¸ºç¨‹åºè¿è¡Œæ—¶å¯¹å†…å­˜çš„è®¿é—®å‘ˆç°å±€éƒ¨æ€§ï¼ˆLocalityï¼‰ç‰¹å¾ã€‚æ—¢åŒ…æ‹¬ç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial Localityï¼‰ï¼Œä¹ŸåŒ…æ‹¬æ—¶é—´å±€éƒ¨æ€§ï¼ˆTemporal Localityï¼‰ï¼Œæœ‰æ•ˆåˆ©ç”¨è¿™ç§å±€éƒ¨æ€§ï¼Œç¼“å­˜å¯ä»¥è¾¾åˆ°æé«˜çš„å‘½ä¸­ç‡</p>
<hr>
<h4 id="ä¼ªå…±äº«">ä¼ªå…±äº«</h4>
<p><strong>ç¼“å­˜ä»¥ç¼“å­˜è¡Œ cache line ä¸ºå•ä½</strong>ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰ï¼Œåœ¨ CPU ä»ä¸»å­˜è·å–æ•°æ®æ—¶ï¼Œä»¥ cache line ä¸ºå•ä½åŠ è½½ï¼Œäºæ˜¯ç›¸é‚»çš„æ•°æ®ä¼šä¸€å¹¶åŠ è½½åˆ°ç¼“å­˜ä¸­</p>
<p>ç¼“å­˜ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­ï¼ŒCPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦åšåˆ°æŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„<strong>æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ</strong>ï¼Œè¿™å°±æ˜¯ä¼ªå…±äº«</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E5%86%85%E5%AD%98%E4%BC%AA%E5%85%B1%E4%BA%AB.png" style="zoom: 67%;" />
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>paddingï¼šé€šè¿‡å¡«å……ï¼Œè®©æ•°æ®è½åœ¨ä¸åŒçš„ cache line ä¸­</p>
</li>
<li>
<p>@Contendedï¼šåŸç†å‚è€ƒ æ— é” â†’ Adder â†’ ä¼˜åŒ–æœºåˆ¶ â†’ ä¼ªå…±äº«</p>
</li>
</ul>
<p>Linux æŸ¥çœ‹ CPU ç¼“å­˜è¡Œï¼š</p>
<ul>
<li>å‘½ä»¤ï¼š<code>cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size64</code></li>
<li>å†…å­˜åœ°å€æ ¼å¼ï¼š[é«˜ä½ç»„æ ‡è®°] [ä½ä½ç´¢å¼•] [åç§»é‡]</li>
</ul>
<hr>
<h4 id="ç¼“å­˜ä¸€è‡´">ç¼“å­˜ä¸€è‡´</h4>
<p>ç¼“å­˜ä¸€è‡´æ€§ï¼šå½“å¤šä¸ªå¤„ç†å™¨è¿ç®—ä»»åŠ¡éƒ½æ¶‰åŠåˆ°åŒä¸€å—ä¸»å†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªçš„ç¼“å­˜æ•°æ®ä¸ä¸€æ ·</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7.png" style="zoom:80%;" />
<p>MESIï¼ˆModified Exclusive Shared Or Invalidï¼‰æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„<strong>æ”¯æŒå†™å›ç­–ç•¥çš„ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>ï¼ŒCPU ä¸­æ¯ä¸ªç¼“å­˜è¡Œï¼ˆcaceh lineï¼‰ä½¿ç”¨ 4 ç§çŠ¶æ€è¿›è¡Œæ ‡è®°ï¼ˆä½¿ç”¨é¢å¤–çš„ä¸¤ä½ bit è¡¨ç¤º)ï¼š</p>
<ul>
<li>
<p>Mï¼šè¢«ä¿®æ”¹ï¼ˆModifiedï¼‰</p>
<p>è¯¥ç¼“å­˜è¡Œåªè¢«ç¼“å­˜åœ¨è¯¥ CPU çš„ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯è¢«ä¿®æ”¹è¿‡çš„ï¼Œä¸ä¸»å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ (dirty)ï¼Œè¯¥ç¼“å­˜è¡Œä¸­çš„å†…å­˜éœ€è¦å†™å› (write back) ä¸»å­˜ã€‚è¯¥çŠ¶æ€çš„æ•°æ®å†æ¬¡è¢«ä¿®æ”¹ä¸ä¼šå‘é€å¹¿æ’­ï¼Œå› ä¸ºå…¶ä»–æ ¸å¿ƒçš„æ•°æ®å·²ç»åœ¨ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶å¤±æ•ˆä¸€æ¬¡</p>
<p>å½“è¢«å†™å›ä¸»å­˜ä¹‹åï¼Œè¯¥ç¼“å­˜è¡Œçš„çŠ¶æ€ä¼šå˜æˆç‹¬äº« (exclusive) çŠ¶æ€</p>
</li>
<li>
<p>Eï¼šç‹¬äº«çš„ï¼ˆExclusiveï¼‰</p>
<p>è¯¥ç¼“å­˜è¡Œåªè¢«ç¼“å­˜åœ¨è¯¥ CPU çš„ç¼“å­˜ä¸­ï¼Œæ˜¯æœªè¢«ä¿®æ”¹è¿‡çš„ (clear)ï¼Œä¸ä¸»å­˜ä¸­æ•°æ®ä¸€è‡´ï¼Œä¿®æ”¹æ•°æ®ä¸éœ€è¦é€šçŸ¥å…¶ä»– CPU æ ¸å¿ƒï¼Œè¯¥çŠ¶æ€å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»æœ‰å…¶å®ƒ CPU è¯»å–è¯¥å†…å­˜æ—¶å˜æˆå…±äº«çŠ¶æ€ (shared)</p>
<p>å½“ CPU ä¿®æ”¹è¯¥ç¼“å­˜è¡Œä¸­å†…å®¹æ—¶ï¼Œè¯¥çŠ¶æ€å¯ä»¥å˜æˆ Modified çŠ¶æ€</p>
</li>
<li>
<p>Sï¼šå…±äº«çš„ï¼ˆSharedï¼‰</p>
<p>è¯¥çŠ¶æ€æ„å‘³ç€è¯¥ç¼“å­˜è¡Œå¯èƒ½è¢«å¤šä¸ª CPU ç¼“å­˜ï¼Œå¹¶ä¸”å„ä¸ªç¼“å­˜ä¸­çš„æ•°æ®ä¸ä¸»å­˜æ•°æ®ä¸€è‡´ï¼Œå½“ CPU ä¿®æ”¹è¯¥ç¼“å­˜è¡Œä¸­ï¼Œä¼šå‘å…¶å®ƒ CPU æ ¸å¿ƒå¹¿æ’­ä¸€ä¸ªè¯·æ±‚ï¼Œä½¿è¯¥ç¼“å­˜è¡Œå˜æˆæ— æ•ˆçŠ¶æ€ (Invalid)ï¼Œç„¶åå†æ›´æ–°å½“å‰ Cache é‡Œçš„æ•°æ®</p>
</li>
<li>
<p>Iï¼šæ— æ•ˆçš„ï¼ˆInvalidï¼‰</p>
<p>è¯¥ç¼“å­˜æ˜¯æ— æ•ˆçš„ï¼Œå¯èƒ½æœ‰å…¶å®ƒ CPU ä¿®æ”¹äº†è¯¥ç¼“å­˜è¡Œ</p>
</li>
</ul>
<p>è§£å†³æ–¹æ³•ï¼šå„ä¸ªå¤„ç†å™¨è®¿é—®ç¼“å­˜æ—¶éƒ½éµå¾ªä¸€äº›åè®®ï¼Œåœ¨è¯»å†™æ—¶è¦æ ¹æ®åè®®è¿›è¡Œæ“ä½œï¼Œåè®®ä¸»è¦æœ‰ MSIã€MESI ç­‰</p>
<hr>
<h4 id="å¤„ç†æœºåˆ¶">å¤„ç†æœºåˆ¶</h4>
<p>å•æ ¸ CPU å¤„ç†å™¨ä¼šè‡ªåŠ¨ä¿è¯åŸºæœ¬å†…å­˜æ“ä½œçš„åŸå­æ€§</p>
<p>å¤šæ ¸ CPU å¤„ç†å™¨ï¼Œæ¯ä¸ª CPU å¤„ç†å™¨å†…ç»´æŠ¤äº†ä¸€å—å†…å­˜ï¼Œæ¯ä¸ªå†…æ ¸å†…éƒ¨ç»´æŠ¤ç€ä¸€å—ç¼“å­˜ï¼Œå½“å¤šçº¿ç¨‹å¹¶å‘è¯»å†™æ—¶ï¼Œå°±ä¼šå‡ºç°ç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚å¤„ç†å™¨æä¾›ï¼š</p>
<ul>
<li>æ€»çº¿é”å®šï¼šå½“å¤„ç†å™¨è¦æ“ä½œå…±äº«å˜é‡æ—¶ï¼Œåœ¨ BUS æ€»çº¿ä¸Šå‘å‡ºä¸€ä¸ª LOCK ä¿¡å·ï¼Œå…¶ä»–å¤„ç†å™¨å°±æ— æ³•æ“ä½œè¿™ä¸ªå…±äº«å˜é‡ï¼Œè¯¥æ“ä½œä¼šå¯¼è‡´å¤§é‡é˜»å¡ï¼Œä»è€Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ï¼ˆ<strong>å¹³å°çº§åˆ«çš„åŠ é”</strong>ï¼‰</li>
<li>ç¼“å­˜é”å®šï¼šå½“å¤„ç†å™¨å¯¹ç¼“å­˜ä¸­çš„å…±äº«å˜é‡è¿›è¡Œäº†æ“ä½œï¼Œå…¶ä»–å¤„ç†å™¨æœ‰å—…æ¢æœºåˆ¶ï¼Œå°†å„è‡ªç¼“å­˜ä¸­çš„è¯¥å…±äº«å˜é‡çš„å¤±æ•ˆï¼Œè¯»å–æ—¶ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®ï¼ŒåŸºäº MESI ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥å®ç°</li>
</ul>
<p>æœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µå¤„ç†å™¨ä¸ä¼šä½¿ç”¨ç¼“å­˜é”å®šï¼š</p>
<ul>
<li>
<p>å½“æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œï¼Œæˆ–æ²¡è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œåˆ™å¤„ç†å™¨ä¼šä½¿ç”¨æ€»çº¿é”å®š</p>
</li>
<li>
<p>æœ‰äº›å¤„ç†å™¨ä¸æ”¯æŒç¼“å­˜é”å®šï¼Œæ¯”å¦‚ï¼šIntel 486 å’Œ Pentium å¤„ç†å™¨ä¹Ÿä¼šè°ƒç”¨æ€»çº¿é”å®š</p>
</li>
</ul>
<p>æ€»çº¿æœºåˆ¶ï¼š</p>
<ul>
<li>
<p>æ€»çº¿å—…æ¢ï¼šæ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜å€¼æ˜¯å¦è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±çš„ç¼“å­˜å¯¹åº”çš„å†…å­˜åœ°å€çš„æ•°æ®è¢«ä¿®æ”¹ï¼Œå°±<strong>å°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®ä¸ºæ— æ•ˆçŠ¶æ€</strong>ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šé‡æ–°ä»å†…å­˜ä¸­æŠŠæ•°æ®è¯»å–åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­</p>
</li>
<li>
<p>æ€»çº¿é£æš´ï¼šå½“æŸä¸ª CPU æ ¸å¿ƒæ›´æ–°äº† Cache ä¸­çš„æ•°æ®ï¼Œè¦æŠŠè¯¥äº‹ä»¶å¹¿æ’­é€šçŸ¥åˆ°å…¶ä»–æ ¸å¿ƒï¼ˆ<strong>å†™ä¼ æ’­</strong>ï¼‰ï¼ŒCPU éœ€è¦æ¯æ—¶æ¯åˆ»ç›‘å¬æ€»çº¿ä¸Šçš„ä¸€åˆ‡æ´»åŠ¨ï¼Œä½†æ˜¯ä¸ç®¡åˆ«çš„æ ¸å¿ƒçš„ Cache æ˜¯å¦ç¼“å­˜ç›¸åŒçš„æ•°æ®ï¼Œéƒ½éœ€è¦å‘å‡ºä¸€ä¸ªå¹¿æ’­äº‹ä»¶ï¼Œä¸æ–­çš„ä»ä¸»å†…å­˜å—…æ¢å’Œ CAS å¾ªç¯ï¼Œæ— æ•ˆçš„äº¤äº’ä¼šå¯¼è‡´æ€»çº¿å¸¦å®½è¾¾åˆ°å³°å€¼ï¼›å› æ­¤ä¸è¦å¤§é‡ä½¿ç”¨ volatile å…³é”®å­—ï¼Œä½¿ç”¨ volatileã€syschonized éƒ½éœ€è¦æ ¹æ®å®é™…åœºæ™¯</p>
</li>
</ul>
<hr>
<h3 id="volatile">volatile</h3>
<h4 id="åŒæ­¥æœºåˆ¶">åŒæ­¥æœºåˆ¶</h4>
<p>volatile æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„<strong>è½»é‡çº§</strong>çš„åŒæ­¥æœºåˆ¶ï¼ˆä¸‰å¤§ç‰¹æ€§ï¼‰</p>
<ul>
<li>ä¿è¯å¯è§æ€§</li>
<li>ä¸ä¿è¯åŸå­æ€§</li>
<li>ä¿è¯æœ‰åºæ€§ï¼ˆç¦æ­¢æŒ‡ä»¤é‡æ’ï¼‰</li>
</ul>
<p>æ€§èƒ½ï¼švolatile ä¿®é¥°çš„å˜é‡è¿›è¡Œè¯»æ“ä½œä¸æ™®é€šå˜é‡å‡ ä¹æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œä½†æ˜¯å†™æ“ä½œç›¸å¯¹æ…¢ä¸€äº›ï¼Œå› ä¸ºéœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­æ’å…¥å¾ˆå¤šå†…å­˜å±éšœæ¥ä¿è¯æŒ‡ä»¤ä¸ä¼šå‘ç”Ÿä¹±åºæ‰§è¡Œï¼Œä½†æ˜¯å¼€é”€æ¯”é”è¦å°</p>
<p>synchronized æ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’å’Œå¤„ç†å™¨ä¼˜åŒ–ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä¿è¯æœ‰åºæ€§å¯è§æ€§</p>
<ul>
<li>åŠ äº†é”ä¹‹åï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—åˆ°äº†é”ï¼Œè·å¾—ä¸åˆ°é”çš„çº¿ç¨‹å°±è¦é˜»å¡ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œç›¸å½“äºå•çº¿ç¨‹ï¼Œç”±äºæ•°æ®ä¾èµ–æ€§çš„å­˜åœ¨ï¼Œå•çº¿ç¨‹çš„æŒ‡ä»¤é‡æ’æ˜¯æ²¡æœ‰é—®é¢˜çš„</li>
<li>çº¿ç¨‹åŠ é”å‰ï¼Œå°†<strong>æ¸…ç©ºå·¥ä½œå†…å­˜</strong>ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ï¼›çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼<strong>åˆ·æ–°åˆ°ä¸»å†…å­˜</strong>ä¸­ï¼ˆJMM å†…å­˜äº¤äº’ç« èŠ‚æœ‰è®²ï¼‰</li>
</ul>
<hr>
<h4 id="æŒ‡ä»¤é‡æ’">æŒ‡ä»¤é‡æ’</h4>
<p>volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’</p>
<p>æŒ‡ä»¤é‡æ’å®ä¾‹ï¼š</p>
<ul>
<li>
<p>example 1ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mySort</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">11</span>;	<span class="comment">//è¯­å¥1</span></span><br><span class="line">	<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">12</span>;	<span class="comment">//è¯­å¥2  è°å…ˆæ‰§è¡Œæ•ˆæœä¸€æ ·</span></span><br><span class="line">	x = x + <span class="number">5</span>;	<span class="comment">//è¯­å¥3</span></span><br><span class="line">	y = x * x;	<span class="comment">//è¯­å¥4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œé¡ºåºæ˜¯ï¼š1 2 3 4ã€2 1 3 4ã€1 3 2 4</p>
<p>æŒ‡ä»¤é‡æ’ä¹Ÿæœ‰é™åˆ¶ä¸ä¼šå‡ºç°ï¼š4321ï¼Œè¯­å¥ 4 éœ€è¦ä¾èµ–äº y ä»¥åŠ x çš„ç”³æ˜ï¼Œå› ä¸ºå­˜åœ¨æ•°æ®ä¾èµ–ï¼Œæ— æ³•é¦–å…ˆæ‰§è¡Œ</p>
</li>
<li>
<p>example 2ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">    	r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">	num = <span class="number">2</span>;</span><br><span class="line">	ready = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æƒ…å†µä¸€ï¼šçº¿ç¨‹ 1 å…ˆæ‰§è¡Œï¼Œready = falseï¼Œç»“æœä¸º r.r1 = 1</p>
<p>æƒ…å†µäºŒï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†è¿˜æ²¡æ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œç»“æœä¸º r.r1 = 1</p>
<p>æƒ…å†µä¸‰ï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿›å…¥ if åˆ†æ”¯ç»“æœä¸º r.r1 = 4</p>
<p>æƒ…å†µå››ï¼šçº¿ç¨‹ 2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹ 1ï¼Œè¿›å…¥ if åˆ†æ”¯ä¸º r.r1 = 0ï¼Œå†åˆ‡å›çº¿ç¨‹ 2 æ‰§è¡Œ num = 2ï¼Œå‘ç”ŸæŒ‡ä»¤é‡æ’</p>
</li>
</ul>
<hr>
<h4 id="åº•å±‚åŸç†">åº•å±‚åŸç†</h4>
<h5 id="ç¼“å­˜ä¸€è‡´-2">ç¼“å­˜ä¸€è‡´</h5>
<p>ä½¿ç”¨ volatile ä¿®é¥°çš„å…±äº«å˜é‡ï¼Œåº•å±‚é€šè¿‡æ±‡ç¼– lock å‰ç¼€æŒ‡ä»¤è¿›è¡Œç¼“å­˜é”å®šï¼Œåœ¨çº¿ç¨‹ä¿®æ”¹å®Œå…±äº«å˜é‡åå†™å›ä¸»å­˜ï¼Œå…¶ä»–çš„ CPU æ ¸å¿ƒä¸Šè¿è¡Œçš„çº¿ç¨‹é€šè¿‡ CPU æ€»çº¿å—…æ¢æœºåˆ¶ä¼šä¿®æ”¹å…¶å…±äº«å˜é‡ä¸ºå¤±æ•ˆçŠ¶æ€ï¼Œè¯»å–æ—¶ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®</p>
<p>lock å‰ç¼€æŒ‡ä»¤å°±ç›¸å½“äºå†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰</p>
<ul>
<li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ</li>
<li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ</li>
</ul>
<p>å†…å­˜å±éšœæœ‰ä¸‰ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>ç¡®ä¿å¯¹å†…å­˜çš„è¯»-æ”¹-å†™æ“ä½œåŸå­æ‰§è¡Œ</li>
<li>é˜»æ­¢å±éšœä¸¤ä¾§çš„æŒ‡ä»¤é‡æ’åº</li>
<li>å¼ºåˆ¶æŠŠç¼“å­˜ä¸­çš„è„æ•°æ®å†™å›ä¸»å†…å­˜ï¼Œè®©ç¼“å­˜è¡Œä¸­ç›¸åº”çš„æ•°æ®å¤±æ•ˆ</li>
</ul>
<hr>
<h5 id="å†…å­˜å±éšœ">å†…å­˜å±éšœ</h5>
<p>ä¿è¯<strong>å¯è§æ€§</strong>ï¼š</p>
<ul>
<li>
<p>å†™å±éšœï¼ˆsfenceï¼ŒStore Barrierï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>; <span class="comment">// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span></span><br><span class="line">    <span class="comment">// å†™å±éšœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¯»å±éšœï¼ˆlfenceï¼ŒLoad Barrierï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åçš„ï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼Œä»ä¸»å­˜åˆ·æ–°å˜é‡å€¼ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å±éšœ</span></span><br><span class="line">    <span class="comment">// ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">    	r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM-volatile%E4%BF%9D%E8%AF%81%E5%8F%AF%E8%A7%81%E6%80%A7.png" style="zoom:67%;" />
</li>
<li>
<p>å…¨èƒ½å±éšœï¼šmfenceï¼ˆmodify/mix Barrierï¼‰ï¼Œå…¼å…· sfence å’Œ lfence çš„åŠŸèƒ½</p>
</li>
</ul>
<p>ä¿è¯<strong>æœ‰åºæ€§</strong>ï¼š</p>
<ul>
<li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li>
<li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li>
</ul>
<p>ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š</p>
<ul>
<li>
<p>å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹çš„è¯»è·‘åˆ°å†™å±éšœä¹‹å‰</p>
</li>
<li>
<p>æœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">volatile</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;i++&#125;);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;i--&#125;);</span><br></pre></td></tr></table></figure>
<p>i++ åç¼–è¯‘åçš„æŒ‡ä»¤ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: iconst_1			<span class="comment">// å½“intå–å€¼ -1~5 æ—¶ï¼ŒJVMé‡‡ç”¨iconstæŒ‡ä»¤å°†å¸¸é‡å‹å…¥æ ˆä¸­</span></span><br><span class="line"><span class="number">1</span>: istore_1			<span class="comment">// å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1</span></span><br><span class="line"><span class="number">2</span>: iinc		<span class="number">1</span>, <span class="number">1</span></span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM-volatile%E4%B8%8D%E8%83%BD%E4%BF%9D%E8%AF%81%E5%8E%9F%E5%AD%90%E6%80%A7.png" style="zoom:67%;" />
</li>
</ul>
<hr>
<h5 id="äº¤äº’è§„åˆ™">äº¤äº’è§„åˆ™</h5>
<p>å¯¹äº volatile ä¿®é¥°çš„å˜é‡ï¼š</p>
<ul>
<li>çº¿ç¨‹å¯¹å˜é‡çš„ use ä¸ loadã€read æ“ä½œæ˜¯ç›¸å…³è”çš„ï¼Œæ‰€ä»¥å˜é‡ä½¿ç”¨å‰å¿…é¡»å…ˆä»ä¸»å­˜åŠ è½½</li>
<li>çº¿ç¨‹å¯¹å˜é‡çš„ assign ä¸ storeã€write æ“ä½œæ˜¯ç›¸å…³è”çš„ï¼Œæ‰€ä»¥å˜é‡ä½¿ç”¨åå¿…é¡»åŒæ­¥è‡³ä¸»å­˜</li>
<li>çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 è°å…ˆå¯¹å˜é‡æ‰§è¡Œ read æ“ä½œï¼Œå°±ä¼šå…ˆè¿›è¡Œ write æ“ä½œï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’</li>
</ul>
<hr>
<h4 id="åŒç«¯æ£€é”">åŒç«¯æ£€é”</h4>
<h5 id="æ£€é”æœºåˆ¶">æ£€é”æœºåˆ¶</h5>
<p>Double-Checked Lockingï¼šåŒç«¯æ£€é”æœºåˆ¶</p>
<p>DCLï¼ˆåŒç«¯æ£€é”ï¼‰æœºåˆ¶ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸå› æ˜¯æœ‰æŒ‡ä»¤é‡æ’çš„å­˜åœ¨ï¼ŒåŠ å…¥ volatile å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(INSTANCE == <span class="literal">null</span>) &#123; <span class="comment">// t2ï¼Œè¿™é‡Œçš„åˆ¤æ–­ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</span></span><br><span class="line">            <span class="comment">// é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized</span></span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton.class) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç­‰å¾…é”çš„æœŸé—´å®Œæˆäº†åˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸é” INSTANCE çš„åŸå› ï¼š</p>
<ul>
<li>INSTANCE è¦é‡æ–°èµ‹å€¼</li>
<li>INSTANCE æ˜¯ nullï¼Œçº¿ç¨‹åŠ é”ä¹‹å‰éœ€è¦è·å–å¯¹è±¡çš„å¼•ç”¨ï¼Œè®¾ç½®å¯¹è±¡å¤´ï¼Œnull æ²¡æœ‰å¼•ç”¨</li>
</ul>
<p>å®ç°ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ‡’æƒ°åˆå§‹åŒ–</li>
<li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li>
<li>ç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šäº§ç”Ÿé—®é¢˜</li>
</ul>
<hr>
<h5 id="DCL-é—®é¢˜">DCL é—®é¢˜</h5>
<p>getInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: 	getstatic 		#<span class="number">2</span> 		<span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">3</span>: 	ifnonnull 		<span class="number">37</span></span><br><span class="line"><span class="number">6</span>: 	ldc 			#<span class="number">3</span> 		<span class="comment">// class test/Singleton</span></span><br><span class="line"><span class="number">8</span>: 	dup</span><br><span class="line"><span class="number">9</span>: 	astore_0</span><br><span class="line"><span class="number">10</span>: monitorenter</span><br><span class="line"><span class="number">11</span>: getstatic 		#<span class="number">2</span> 		<span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">14</span>: ifnonnull <span class="number">27</span></span><br><span class="line"><span class="number">17</span>: <span class="keyword">new</span> 			#<span class="number">3</span> 		<span class="comment">// class test/Singleton</span></span><br><span class="line"><span class="number">20</span>: dup</span><br><span class="line"><span class="number">21</span>: invokespecial 	#<span class="number">4</span> 		<span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="number">24</span>: putstatic 		#<span class="number">2</span> 		<span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">27</span>: aload_0</span><br><span class="line"><span class="number">28</span>: monitorexit</span><br><span class="line"><span class="number">29</span>: <span class="keyword">goto</span> <span class="number">37</span></span><br><span class="line"><span class="number">32</span>: astore_1</span><br><span class="line"><span class="number">33</span>: aload_0</span><br><span class="line"><span class="number">34</span>: monitorexit</span><br><span class="line"><span class="number">35</span>: aload_1</span><br><span class="line"><span class="number">36</span>: athrow</span><br><span class="line"><span class="number">37</span>: getstatic 		#<span class="number">2</span> 		<span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">40</span>: areturn</span><br></pre></td></tr></table></figure>
<ul>
<li>17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ</li>
<li>20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ï¼Œå¼•ç”¨åœ°å€</li>
<li>21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³•åˆå§‹åŒ–å¯¹è±¡</li>
<li>24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE</li>
</ul>
<p><strong>æ­¥éª¤ 21 å’Œ 24 ä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»</strong>ï¼Œè€Œä¸”æ— è®ºé‡æ’å‰åï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¿™ç§é‡æ’ä¼˜åŒ–æ˜¯å…è®¸çš„</p>
<ul>
<li>å…³é”®åœ¨äº 0:getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå¯ä»¥è¶Šè¿‡ monitor è¯»å– INSTANCE å˜é‡çš„å€¼</li>
<li>å½“å…¶ä»–çº¿ç¨‹è®¿é—® INSTANCE ä¸ä¸º null æ—¶ï¼Œç”±äº INSTANCE å®ä¾‹æœªå¿…å·²åˆå§‹åŒ–ï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹è¿”å›ï¼Œè¿™å°±é€ æˆäº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JMM-DCL%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98.png" alt=""></p>
<hr>
<h5 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h5>
<p>æŒ‡ä»¤é‡æ’åªä¼šä¿è¯ä¸²è¡Œè¯­ä¹‰çš„æ‰§è¡Œä¸€è‡´æ€§ï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œä½†å¹¶ä¸ä¼šå…³ç³»å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¸€è‡´æ€§</p>
<p>å¼•å…¥ volatileï¼Œæ¥ä¿è¯å‡ºç°æŒ‡ä»¤é‡æ’çš„é—®é¢˜ï¼Œä»è€Œä¿è¯å•ä¾‹æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">SingletonDemo</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="ha-be">ha-be</h3>
<p>happens-before å…ˆè¡Œå‘ç”Ÿ</p>
<p>Java å†…å­˜æ¨¡å‹å…·å¤‡ä¸€äº›å…ˆå¤©çš„â€œæœ‰åºæ€§â€ï¼Œå³ä¸éœ€è¦é€šè¿‡ä»»ä½•åŒæ­¥æ‰‹æ®µï¼ˆvolatileã€synchronized ç­‰ï¼‰å°±èƒ½å¤Ÿå¾—åˆ°ä¿è¯çš„å®‰å…¨ï¼Œè¿™ä¸ªé€šå¸¸ä¹Ÿç§°ä¸º happens-before åŸåˆ™ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“</p>
<p>ä¸ç¬¦åˆ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„å¯è§æ€§å’Œæœ‰åºæ€§</p>
<ol>
<li>
<p>ç¨‹åºæ¬¡åºè§„åˆ™ (Program Order Rule)ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼Œé€»è¾‘ä¸Šä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œ ï¼Œå› ä¸ºå¤šä¸ªæ“ä½œä¹‹é—´æœ‰å…ˆåä¾èµ–å…³ç³»ï¼Œåˆ™ä¸å…è®¸å¯¹è¿™äº›æ“ä½œè¿›è¡Œé‡æ’åº</p>
</li>
<li>
<p>é”å®šè§„åˆ™ (Monitor Lock Rule)ï¼šä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢ï¼ˆæ—¶é—´çš„å…ˆåï¼‰å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œï¼Œæ‰€ä»¥çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼ˆè§£é”å‰ä¼šåˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼‰ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</p>
</li>
<li>
<p><strong>volatile å˜é‡è§„åˆ™</strong> (Volatile Variable Rule)ï¼šå¯¹ volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»</p>
</li>
<li>
<p>ä¼ é€’è§„åˆ™ (Transitivity)ï¼šå…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œè€Œæ“ä½œ B åˆå…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œåˆ™å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C</p>
</li>
<li>
<p>çº¿ç¨‹å¯åŠ¨è§„åˆ™ (Thread Start Rule)ï¼šThread å¯¹è±¡çš„ start()æ–¹ æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">10</span>;<span class="comment">//çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;	System.out.println(x);	&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çº¿ç¨‹ä¸­æ–­è§„åˆ™ (Thread Interruption Rule)ï¼šå¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿ</p>
</li>
<li>
<p>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ (Thread Termination Rule)ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œå¯ä»¥é€šè¿‡ Thread.join() æ–¹æ³•ç»“æŸã€Thread.isAlive() çš„è¿”å›å€¼æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œ</p>
</li>
<li>
<p>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼ˆFinaizer Ruleï¼‰ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹</p>
</li>
</ol>
<hr>
<h3 id="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</h3>
<h4 id="ç»ˆæ­¢æ¨¡å¼-2">ç»ˆæ­¢æ¨¡å¼</h4>
<p>ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼šåœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line">    <span class="comment">// ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> Thread monitor;</span><br><span class="line">    <span class="comment">// åœæ­¢æ ‡è®°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">stop</span> <span class="operator">=</span> <span class="literal">false</span>;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span> (stop) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;åç½®å¤„ç†&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);<span class="comment">// ç¡çœ </span></span><br><span class="line">                    System.out.println(thread.getName() + <span class="string">&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   	System.out.println(<span class="string">&quot;è¢«æ‰“æ–­ï¼Œé€€å‡ºç¡çœ &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        stop = <span class="literal">true</span>;</span><br><span class="line">        monitor.interrupt();<span class="comment">// è®©çº¿ç¨‹å°½å¿«é€€å‡ºTimed Waiting</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æµ‹è¯•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">TwoPhaseTermination</span> <span class="variable">tpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TwoPhaseTermination</span>();</span><br><span class="line">    tpt.start();</span><br><span class="line">    Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;åœæ­¢ç›‘æ§&quot;</span>);</span><br><span class="line">    tpt.stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Balking">Balking</h4>
<p>Balking ï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorService</span> &#123;</span><br><span class="line">    <span class="comment">// ç”¨æ¥è¡¨ç¤ºæ˜¯å¦å·²ç»æœ‰çº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œå¯åŠ¨äº†</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">starting</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å°è¯•å¯åŠ¨ç›‘æ§çº¿ç¨‹...&quot;</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (starting) &#123;</span><br><span class="line">            	<span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            starting = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœŸæ­£å¯åŠ¨ç›‘æ§çº¿ç¨‹...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹æ¯”ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ï¼šä¿æŠ¤æ€§æš‚åœæ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶çº¿ç¨‹ç­‰å¾…</p>
<p>ä¾‹å­ï¼šå¸Œæœ› doInit() æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°å‡ºç°çš„é—®é¢˜ï¼š</p>
<ul>
<li>å½“ t1 çº¿ç¨‹è¿›å…¥ init() å‡†å¤‡ doInit()ï¼Œt2 çº¿ç¨‹è¿›æ¥ï¼Œinitialized è¿˜ä¸º f alseï¼Œåˆ™ t2 å°±åˆåˆå§‹åŒ–ä¸€æ¬¡</li>
<li>volatile é€‚åˆä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå…¶ä»–çº¿ç¨‹è¯»çš„æƒ…å†µï¼Œè¿™ä¸ªä»£ç éœ€è¦åŠ é”</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestVolatile</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    	doInit();</span><br><span class="line">    	initialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doInit</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="æ— é”">æ— é”</h2>
<h3 id="CAS">CAS</h3>
<h4 id="åŸç†">åŸç†</h4>
<p>æ— é”ç¼–ç¨‹ï¼šLock Free</p>
<p>CAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œæ˜¯ <strong>CPU å¹¶å‘åŸè¯­</strong></p>
<ul>
<li>CAS å¹¶å‘åŸè¯­ä½“ç°åœ¨ Java è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ UnSafe ç±»ä¸­çš„ CAS æ–¹æ³•ï¼ŒJVM ä¼šå®ç°å‡º CAS æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œå®ç°äº†åŸå­æ“ä½œ</li>
<li>CAS æ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»ŸèŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆ ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œæ‰€ä»¥ CAS æ˜¯ä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
</ul>
<p>åº•å±‚åŸç†ï¼šCAS çš„åº•å±‚æ˜¯ <code>lock cmpxchg</code> æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯æ¯”è¾ƒäº¤æ¢çš„åŸå­æ€§</p>
<ul>
<li>
<p>ç¨‹åºæ˜¯åœ¨å•æ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šçœç•¥ lock å‰ç¼€ï¼Œå•å¤„ç†å™¨è‡ªèº«ä¼šç»´æŠ¤å¤„ç†å™¨å†…çš„é¡ºåºä¸€è‡´æ€§ï¼Œä¸éœ€è¦ lock å‰ç¼€çš„å†…å­˜å±éšœæ•ˆæœ</p>
</li>
<li>
<p>ç¨‹åºæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šä¸º cmpxchg æŒ‡ä»¤åŠ ä¸Š lock å‰ç¼€ã€‚å½“æŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šæ‰§è¡Œ<strong>æ€»çº¿é”å®šæˆ–ç¼“å­˜é”å®š</strong>ï¼Œå°†ä¿®æ”¹çš„å˜é‡å†™å…¥åˆ°ä¸»å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„åŸå­æ€§</p>
</li>
</ul>
<p>ä½œç”¨ï¼šæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»ç‰©ç†å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ‰§è¡Œè§„å®šæ“ä½œï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒç›´åˆ°ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„å€¼ä¸€è‡´ä¸ºæ­¢</p>
<p>CAS ç‰¹ç‚¹ï¼š</p>
<ul>
<li>CAS ä½“ç°çš„æ˜¯<strong>æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘</strong>ï¼Œçº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œçº¿ç¨‹ä¸éœ€è¦é¢‘ç¹åˆ‡æ¢çŠ¶æ€ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç³»ç»Ÿè°ƒç”¨ï¼‰</li>
<li>CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³</li>
</ul>
<p>CAS ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ‰§è¡Œçš„æ˜¯å¾ªç¯æ“ä½œï¼Œå¦‚æœæ¯”è¾ƒä¸æˆåŠŸä¸€ç›´åœ¨å¾ªç¯ï¼Œæœ€å·®çš„æƒ…å†µæŸä¸ªçº¿ç¨‹ä¸€ç›´å–åˆ°çš„å€¼å’Œé¢„æœŸå€¼éƒ½ä¸ä¸€æ ·ï¼Œå°±ä¼šæ— é™å¾ªç¯å¯¼è‡´é¥¥é¥¿ï¼Œ<strong>ä½¿ç”¨ CAS çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡ CPU çš„æ ¸å¿ƒæ•°</strong>ï¼Œé‡‡ç”¨åˆ†æ®µ CAS å’Œè‡ªåŠ¨è¿ç§»æœºåˆ¶</li>
<li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ
<ul>
<li>å¯¹äºä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä»¥é€šè¿‡å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œ</li>
<li>å¯¹äºå¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™<strong>åªèƒ½ç”¨é”æ¥ä¿è¯åŸå­æ€§</strong></li>
</ul>
</li>
<li>å¼•å‡ºæ¥ ABA é—®é¢˜</li>
</ul>
<hr>
<h4 id="ä¹è§‚é”">ä¹è§‚é”</h4>
<p>CAS ä¸ synchronized æ€»ç»“ï¼š</p>
<ul>
<li>synchronized æ˜¯ä»æ‚²è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ï¼ˆå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹ï¼‰ï¼Œå› æ­¤ synchronized ä¹Ÿç§°ä¹‹ä¸ºæ‚²è§‚é”ï¼ŒReentrantLock ä¹Ÿæ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œæ€§èƒ½è¾ƒå·®</li>
<li>CAS æ˜¯ä»ä¹è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ã€‚<strong>å¦‚æœåˆ«äººä¿®æ”¹è¿‡ï¼Œåˆ™è·å–ç°åœ¨æœ€æ–°çš„å€¼ï¼Œå¦‚æœåˆ«äººæ²¡ä¿®æ”¹è¿‡ï¼Œç›´æ¥ä¿®æ”¹å…±äº«æ•°æ®çš„å€¼</strong>ï¼ŒCAS è¿™ç§æœºåˆ¶ä¹Ÿç§°ä¹‹ä¸ºä¹è§‚é”ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½</li>
</ul>
<hr>
<h3 id="Atomic">Atomic</h3>
<h4 id="å¸¸ç”¨-API">å¸¸ç”¨ API</h4>
<p>å¸¸è§åŸå­ç±»ï¼šAtomicIntegerã€AtomicBooleanã€AtomicLong</p>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><code>public AtomicInteger()</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å€¼ä¸º 0 çš„åŸå­å‹ Integer</li>
<li><code>public AtomicInteger(int initialValue)</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªæŒ‡å®šå€¼çš„åŸå­å‹ Integer</li>
</ul>
<p>å¸¸ç”¨ APIï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>public final int get()</td>
<td>è·å– AtomicInteger çš„å€¼</td>
</tr>
<tr>
<td>public final int getAndIncrement()</td>
<td>ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼</td>
</tr>
<tr>
<td>public final int incrementAndGet()</td>
<td>ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢åçš„å€¼</td>
</tr>
<tr>
<td>public final int getAndSet(int value)</td>
<td>ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸º newValue çš„å€¼ï¼Œè¿”å›æ—§å€¼</td>
</tr>
<tr>
<td>public final int addAndGet(int data)</td>
<td>ä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ç›¸åŠ å¹¶è¿”å›<br />å®ä¾‹ï¼šAtomicInteger é‡Œçš„ value</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="åŸç†åˆ†æ">åŸç†åˆ†æ</h4>
<p><strong>AtomicInteger åŸç†</strong>ï¼šè‡ªæ—‹é” + CAS ç®—æ³•</p>
<p>CAS ç®—æ³•ï¼šæœ‰ 3 ä¸ªæ“ä½œæ•°ï¼ˆå†…å­˜å€¼ Vï¼Œ æ—§çš„é¢„æœŸå€¼ Aï¼Œè¦ä¿®æ”¹çš„å€¼ Bï¼‰</p>
<ul>
<li>å½“æ—§çš„é¢„æœŸå€¼ A == å†…å­˜å€¼ V æ­¤æ—¶å¯ä»¥ä¿®æ”¹ï¼Œå°† V æ”¹ä¸º B</li>
<li>å½“æ—§çš„é¢„æœŸå€¼ A != å†…å­˜å€¼ V æ­¤æ—¶ä¸èƒ½ä¿®æ”¹ï¼Œå¹¶é‡æ–°è·å–ç°åœ¨çš„æœ€æ–°å€¼ï¼Œé‡æ–°è·å–çš„åŠ¨ä½œå°±æ˜¯è‡ªæ—‹</li>
</ul>
<p>åˆ†æ getAndSet æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>AtomicIntegerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> newValue)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * this: 		å½“å‰å¯¹è±¡</span></span><br><span class="line"><span class="comment">    * valueOffset:	å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndSetInt(<span class="built_in">this</span>, valueOffset, newValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>valueOffsetï¼šåç§»é‡è¡¨ç¤ºè¯¥å˜é‡å€¼ç›¸å¯¹äºå½“å‰å¯¹è±¡åœ°å€çš„åç§»ï¼ŒUnsafe å°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line"><span class="comment">//è°ƒç”¨æœ¬åœ°æ–¹æ³•   --&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">objectFieldOffset</span><span class="params">(Field var1)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>unsafe ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// val1: AtomicIntegerå¯¹è±¡æœ¬èº«ï¼Œvar2: è¯¥å¯¹è±¡å€¼å¾—å¼•ç”¨åœ°å€ï¼Œvar4: éœ€è¦å˜åŠ¨çš„æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSetInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4)</span> &#123;</span><br><span class="line">    <span class="type">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// var5: ç”¨ var1 å’Œ var2 æ‰¾åˆ°çš„å†…å­˜ä¸­çš„çœŸå®å€¼</span></span><br><span class="line">        var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>var5ï¼šä»ä¸»å†…å­˜ä¸­æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼ˆæ¯æ¬¡éƒ½è¦ä»ä¸»å†…å­˜æ‹¿åˆ°æœ€æ–°çš„å€¼åˆ°æœ¬åœ°å†…å­˜ï¼‰ï¼Œç„¶åæ‰§è¡Œ <code>compareAndSwapInt()</code> å†å’Œä¸»å†…å­˜çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå‡è®¾æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆå°±ä¸€ç›´æ‰§è¡Œ while æ–¹æ³•ï¼Œç›´åˆ°æœŸæœ›çš„å€¼å’ŒçœŸå®å€¼ä¸€æ ·ï¼Œä¿®æ”¹æ•°æ®</p>
</li>
<li>
<p>å˜é‡ value ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œé¿å…çº¿ç¨‹ä»å·¥ä½œç¼“å­˜ä¸­è·å–å¤±æ•ˆçš„å˜é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value</span><br></pre></td></tr></table></figure>
<p><strong>CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°æ¯”è¾ƒå¹¶äº¤æ¢çš„æ•ˆæœ</strong></p>
</li>
</ul>
<p>åˆ†æ getAndUpdate æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>getAndUpdateï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndUpdate</span><span class="params">(IntUnaryOperator updateFunction)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prev, next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();	<span class="comment">//å½“å‰å€¼ï¼Œcasçš„æœŸæœ›å€¼</span></span><br><span class="line">        next = updateFunction.applyAsInt(prev);<span class="comment">//æœŸæœ›å€¼æ›´æ–°åˆ°è¯¥å€¼</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));<span class="comment">//è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">return</span> prev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°å¼æ¥å£ï¼šå¯ä»¥è‡ªå®šä¹‰æ“ä½œé€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">a.getAndUpdate(i -&gt; i + <span class="number">10</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>compareAndSetï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * this: 		å½“å‰å¯¹è±¡</span></span><br><span class="line"><span class="comment">    * valueOffset:	å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">    * expect:		æœŸæœ›çš„å€¼</span></span><br><span class="line"><span class="comment">    * update: 		æ›´æ–°çš„å€¼</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, valueOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="åŸå­å¼•ç”¨">åŸå­å¼•ç”¨</h4>
<p>åŸå­å¼•ç”¨ï¼šå¯¹ Object è¿›è¡ŒåŸå­æ“ä½œï¼Œæä¾›ä¸€ç§è¯»å’Œå†™éƒ½æ˜¯åŸå­æ€§çš„å¯¹è±¡å¼•ç”¨å˜é‡</p>
<p>åŸå­å¼•ç”¨ç±»ï¼šAtomicReferenceã€AtomicStampedReferenceã€AtomicMarkableReference</p>
<p>AtomicReference ç±»ï¼š</p>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼š<code>AtomicReference&lt;T&gt; atomicReference = new AtomicReference&lt;T&gt;()</code></p>
</li>
<li>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>public final boolean compareAndSet(V expectedValue, V newValue)</code>ï¼šCAS æ“ä½œ</li>
<li><code>public final void set(V newValue)</code>ï¼šå°†å€¼è®¾ç½®ä¸º newValue</li>
<li><code>public final V get()</code>ï¼šè¿”å›å½“å‰å€¼</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="number">33</span>, <span class="string">&quot;z3&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºåŸå­å¼•ç”¨åŒ…è£…ç±»</span></span><br><span class="line">        AtomicReference&lt;Student&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸»å†…å­˜å…±äº«å˜é‡ä¸ºs1</span></span><br><span class="line">        atomicReference.set(s1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œå¦‚æœç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å€¼ä¸º z3ï¼Œé‚£ä¹ˆäº¤æ¢æˆ l4</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="number">44</span>, <span class="string">&quot;l4&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (atomicReference.compareAndSet(s1, s2)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(atomicReference.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//ã€‚ã€‚ã€‚ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åŸå­æ•°ç»„">åŸå­æ•°ç»„</h4>
<p>åŸå­æ•°ç»„ç±»ï¼šAtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray</p>
<p>AtomicIntegerArray ç±»æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*   i		the index</span></span><br><span class="line"><span class="comment">* expect 	the expected value</span></span><br><span class="line"><span class="comment">* update 	the new value</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> compareAndSetRaw(checkedByteOffset(i), expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åŸå­æ›´æ–°å™¨">åŸå­æ›´æ–°å™¨</h4>
<p>åŸå­æ›´æ–°å™¨ç±»ï¼šAtomicReferenceFieldUpdaterã€AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdater</p>
<p>åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ <code>IllegalArgumentException: Must be volatile type</code></p>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>static &lt;U&gt; AtomicIntegerFieldUpdater&lt;U&gt; newUpdater(Class&lt;U&gt; c, String fieldName)</code>ï¼šæ„é€ æ–¹æ³•</li>
<li><code>abstract boolean compareAndSet(T obj, int expect, int update)</code>ï¼šCAS</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> field;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicIntegerFieldUpdater</span> <span class="variable">fieldUpdater</span> <span class="operator">=</span> AtomicIntegerFieldUpdater</span><br><span class="line">            		.newUpdater(UpdateDemo.class, <span class="string">&quot;field&quot;</span>);</span><br><span class="line">        <span class="type">UpdateDemo</span> <span class="variable">updateDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateDemo</span>();</span><br><span class="line">        fieldUpdater.compareAndSet(updateDemo, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(updateDemo.field);<span class="comment">//10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åŸå­ç´¯åŠ å™¨">åŸå­ç´¯åŠ å™¨</h4>
<p>åŸå­ç´¯åŠ å™¨ç±»ï¼šLongAdderã€DoubleAdderã€LongAccumulatorã€DoubleAccumulator</p>
<p>LongAdder å’Œ LongAccumulator åŒºåˆ«ï¼š</p>
<p>ç›¸åŒç‚¹ï¼š</p>
<ul>
<li>LongAddr ä¸ LongAccumulator ç±»éƒ½æ˜¯ä½¿ç”¨éé˜»å¡ç®—æ³• CAS å®ç°çš„</li>
<li>LongAddr ç±»æ˜¯ LongAccumulator ç±»çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œåªæ˜¯ LongAccumulator æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥è‡ªå®šä¹‰ç´¯åŠ è§„åˆ™ï¼Œå½“ accumulatorFunction ä¸º null æ—¶å°±ç­‰ä»·äº LongAddr</li>
</ul>
<p>ä¸åŒç‚¹ï¼š</p>
<ul>
<li>
<p>è°ƒç”¨ casBase æ—¶ï¼ŒLongAccumulator ä½¿ç”¨ function.applyAsLong(b = base, x) æ¥è®¡ç®—ï¼ŒLongAddr ä½¿ç”¨ casBase(b = base, b + x)</p>
</li>
<li>
<p>LongAccumulator ç±»åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œæ„é€ æ–¹æ³•å‚æ•°ä¸­</p>
<ul>
<li>accumulatorFunction æ˜¯ä¸€ä¸ªåŒç›®è¿ç®—å™¨æ¥å£ï¼Œå¯ä»¥æŒ‡å®šç´¯åŠ è§„åˆ™ï¼Œæ¯”å¦‚ç´¯åŠ æˆ–è€…ç›¸ä¹˜ï¼Œå…¶æ ¹æ®è¾“å…¥çš„ä¸¤ä¸ªå‚æ•°è¿”å›ä¸€ä¸ªè®¡ç®—å€¼ï¼ŒLongAdder å†…ç½®ç´¯åŠ è§„åˆ™</li>
<li>identity åˆ™æ˜¯ LongAccumulator ç´¯åŠ å™¨çš„åˆå§‹å€¼ï¼ŒLongAccumulator å¯ä»¥ä¸ºç´¯åŠ å™¨æä¾›é 0 çš„åˆå§‹å€¼ï¼Œè€Œ LongAdder åªèƒ½æä¾›é»˜è®¤çš„ 0</li>
</ul>
</li>
</ul>
<hr>
<h3 id="Adder">Adder</h3>
<h4 id="ä¼˜åŒ–æœºåˆ¶">ä¼˜åŒ–æœºåˆ¶</h4>
<p>LongAdder æ˜¯ Java8 æä¾›çš„ç±»ï¼Œè·Ÿ AtomicLong æœ‰ç›¸åŒçš„æ•ˆæœï¼Œä½†å¯¹ CAS æœºåˆ¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°è¯•ä½¿ç”¨åˆ†æ®µ CAS ä»¥åŠè‡ªåŠ¨åˆ†æ®µè¿ç§»çš„æ–¹å¼æ¥å¤§å¹…åº¦æå‡å¤šçº¿ç¨‹é«˜å¹¶å‘æ‰§è¡Œ CAS æ“ä½œçš„æ€§èƒ½</p>
<p>CAS åº•å±‚å®ç°æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸æ–­åœ°å°è¯•ä¿®æ”¹ç›®æ ‡å€¼ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚å¦‚æœç«äº‰ä¸æ¿€çƒˆä¿®æ”¹æˆåŠŸç‡å¾ˆé«˜ï¼Œå¦åˆ™å¤±è´¥ç‡å¾ˆé«˜ï¼Œå¤±è´¥åè¿™äº›é‡å¤çš„åŸå­æ€§æ“ä½œä¼šè€—è´¹æ€§èƒ½ï¼ˆå¯¼è‡´å¤§é‡çº¿ç¨‹<strong>ç©ºå¾ªç¯ï¼Œè‡ªæ—‹è½¬</strong>ï¼‰</p>
<p>ä¼˜åŒ–æ ¸å¿ƒæ€æƒ³ï¼šæ•°æ®åˆ†ç¦»ï¼Œå°† AtomicLong çš„<strong>å•ç‚¹çš„æ›´æ–°å‹åŠ›åˆ†æ‹…åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œç©ºé—´æ¢æ—¶é—´</strong>ï¼Œåœ¨ä½å¹¶å‘çš„æ—¶å€™ç›´æ¥æ›´æ–°ï¼Œå¯ä»¥ä¿éšœå’Œ AtomicLong çš„æ€§èƒ½åŸºæœ¬ä¸€è‡´ï¼Œè€Œåœ¨é«˜å¹¶å‘çš„æ—¶å€™é€šè¿‡åˆ†æ•£å‡å°‘ç«äº‰ï¼Œæé«˜äº†æ€§èƒ½</p>
<p><strong>åˆ†æ®µ CAS æœºåˆ¶</strong>ï¼š</p>
<ul>
<li>åœ¨å‘ç”Ÿç«äº‰æ—¶ï¼Œåˆ›å»º Cell æ•°ç»„ç”¨äºå°†ä¸åŒçº¿ç¨‹çš„æ“ä½œç¦»æ•£ï¼ˆé€šè¿‡ hash ç­‰ç®—æ³•æ˜ å°„ï¼‰åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Š</li>
<li>è®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ˆä¼šæ ¹æ®éœ€è¦æ‰©å®¹ï¼Œæœ€å¤§ä¸º CPU æ ¸æ•°ï¼‰ï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1] ç­‰ï¼Œæœ€åå°†ç»“æœæ±‡æ€»</li>
<li>åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½</li>
</ul>
<p><strong>è‡ªåŠ¨åˆ†æ®µè¿ç§»æœºåˆ¶</strong>ï¼šæŸä¸ª Cell çš„ value æ‰§è¡Œ CAS å¤±è´¥ï¼Œå°±ä¼šè‡ªåŠ¨å¯»æ‰¾å¦ä¸€ä¸ª Cell åˆ†æ®µå†…çš„ value å€¼è¿›è¡Œ CAS æ“ä½œ</p>
<hr>
<h4 id="ä¼ªå…±äº«-2">ä¼ªå…±äº«</h4>
<p>Cell ä¸ºç´¯åŠ å•å…ƒï¼šæ•°ç»„è®¿é—®ç´¢å¼•æ˜¯é€šè¿‡ Thread é‡Œçš„ threadLocalRandomProbe åŸŸå–æ¨¡å®ç°çš„ï¼Œè¿™ä¸ªåŸŸæ˜¯ ThreadLocalRandom æ›´æ–°çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Striped64.Cell</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> value;</span><br><span class="line">    Cell(<span class="type">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    <span class="comment">// ç”¨ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">cas</span><span class="params">(<span class="type">long</span> prev, <span class="type">long</span> next)</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="built_in">this</span>, valueOffset, prev, next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥ä¸é‡è¦ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œ<strong>åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„</strong>ï¼Œ64 ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œæ¯ä¸€ä¸ª cache line ä¸º 64 å­—èŠ‚ï¼Œå› æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ï¼Œå½“ Core-0 è¦ä¿®æ”¹ Cell[0]ã€Core-1 è¦ä¿®æ”¹ Cell[1]ï¼Œæ— è®ºè°ä¿®æ”¹æˆåŠŸéƒ½ä¼šå¯¼è‡´å½“å‰ç¼“å­˜è¡Œå¤±æ•ˆï¼Œä»è€Œå¯¼è‡´å¯¹æ–¹çš„æ•°æ®å¤±æ•ˆï¼Œéœ€è¦é‡æ–°å»ä¸»å­˜è·å–ï¼Œå½±å“æ•ˆç‡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E4%BC%AA%E5%85%B1%E4%BA%AB1.png" alt=""></p>
<p>@sun.misc.Contendedï¼šé˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«ï¼Œåœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä½¿ç”¨ 2 å€äºå¤§å¤šæ•°ç¡¬ä»¶ç¼“å­˜è¡Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶<strong>å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œ</strong>ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E4%BC%AA%E5%85%B1%E4%BA%AB2.png" alt=""></p>
<hr>
<h4 id="æºç è§£æ">æºç è§£æ</h4>
<p>Striped64 ç±»æˆå‘˜å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰è®¡ç®—æœºCPUæ•°é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NCPU</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors()</span><br><span class="line"><span class="comment">// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"><span class="comment">// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸï¼Œå½“ cells æ‰©å®¹æ—¶ï¼Œä¹Ÿä¼šå°†æ•°æ®å†™åˆ° base ä¸­</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> base;</span><br><span class="line"><span class="comment">// åœ¨ cells åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ, é€šè¿‡ CAS æ›´æ–° cellsBusy ç½®ä¸º 1 æ¥å®ç°ä¸€ä¸ªé”</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br></pre></td></tr></table></figure>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>
<p>cells å ç”¨å†…å­˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤§çš„ï¼Œæ˜¯æƒ°æ€§åŠ è½½çš„ï¼Œåœ¨æ— ç«äº‰æˆ–è€…å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ– cells æ•°ç»„çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æ›´æ–° base åŸŸ</p>
</li>
<li>
<p>åœ¨ç¬¬ä¸€æ¬¡å‘ç”Ÿç«äº‰æ—¶ï¼ˆcasBase å¤±è´¥ï¼‰ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 2 çš„ cells æ•°ç»„ï¼Œå°†å½“å‰ç´¯åŠ çš„å€¼åŒ…è£…ä¸º Cell å¯¹è±¡ï¼Œæ”¾å…¥æ˜ å°„çš„æ§½ä½ä¸Š</p>
</li>
<li>
<p>åˆ†æ®µç´¯åŠ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å¯¹åº”çš„ cells æ§½ä½ä¸ºç©ºï¼Œå°±ä¼šæ–°å»º Cell å¡«å……ï¼Œå¦‚æœå‡ºç°ç«äº‰ï¼Œå°±ä¼šé‡æ–°è®¡ç®—çº¿ç¨‹å¯¹åº”çš„æ§½ä½ï¼Œç»§ç»­è‡ªæ—‹å°è¯•ä¿®æ”¹</p>
</li>
<li>
<p>åˆ†æ®µè¿ç§»åè¿˜å‡ºç°ç«äº‰å°±ä¼šæ‰©å®¹ cells æ•°ç»„é•¿åº¦ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç„¶å rehashï¼Œ<strong>æ•°ç»„é•¿åº¦æ€»æ˜¯ 2 çš„ n æ¬¡å¹‚</strong>ï¼Œé»˜è®¤æœ€å¤§ä¸º CPU æ ¸æ•°ï¼Œä½†æ˜¯å¯ä»¥è¶…è¿‡ï¼Œå¦‚æœæ ¸æ•°æ˜¯ 6 æ ¸ï¼Œæ•°ç»„æœ€é•¿æ˜¯ 8</p>
</li>
</ul>
<p>æ–¹æ³•åˆ†æï¼š</p>
<ul>
<li>
<p>LongAdder#addï¼šç´¯åŠ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„çš„å¼•ç”¨ï¼Œb ä¸ºåŸºç¡€å€¼ï¼Œv è¡¨ç¤ºæœŸæœ›å€¼</span></span><br><span class="line">    <span class="comment">// m è¡¨ç¤º cells æ•°ç»„çš„é•¿åº¦ - 1ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cell å•å…ƒæ ¼</span></span><br><span class="line">    Cell[] as; <span class="type">long</span> b, v; <span class="type">int</span> m; Cell a;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cells ä¸ä¸ºç©ºè¯´æ˜ cells å·²ç»è¢«åˆå§‹åŒ–ï¼Œçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰ï¼Œå»æ›´æ–°å¯¹åº”çš„ cell æ§½ä½</span></span><br><span class="line">    <span class="comment">// è¿›å…¥ || åçš„é€»è¾‘å»æ›´æ–° base åŸŸï¼Œæ›´æ–°å¤±è´¥è¡¨ç¤ºå‘ç”Ÿç«äº‰è¿›å…¥æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">        <span class="comment">// uncontended ä¸º true è¡¨ç¤º cell æ²¡æœ‰ç«äº‰</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€: true è¯´æ˜ cells æœªåˆå§‹åŒ–ï¼Œå¤šçº¿ç¨‹å†™ base å‘ç”Ÿç«äº‰éœ€è¦è¿›è¡Œåˆå§‹åŒ– cells æ•°ç»„</span></span><br><span class="line">        <span class="comment">//		  fasle è¯´æ˜ cells å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶å¯»æ‰¾è‡ªå·±çš„ cell å»ç´¯åŠ </span></span><br><span class="line">        <span class="comment">// æ¡ä»¶äºŒ: getProbe() è·å– hash å€¼ï¼Œ&amp; m çš„é€»è¾‘å’Œ HashMap çš„é€»è¾‘ç›¸åŒï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§</span></span><br><span class="line">        <span class="comment">// 		  true è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”ä¸‹æ ‡çš„ cell ä¸ºç©ºï¼Œéœ€è¦åˆ›å»º cell</span></span><br><span class="line">        <span class="comment">//        false è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell ä¸ä¸ºç©ºï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶ã€å°† x å€¼ç´¯åŠ åˆ°å¯¹åº”çš„ cell ä¸­ã€‘</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸‰: æœ‰å–åç¬¦å·ï¼Œfalse è¯´æ˜ cas æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œtrue è¯´æ˜å¤±è´¥ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">            longAccumulate(x, <span class="literal">null</span>, uncontended);</span><br><span class="line">        	<span class="comment">// ã€uncontended åœ¨å¯¹åº”çš„ cell ä¸Šç´¯åŠ å¤±è´¥çš„æ—¶å€™æ‰ä¸º falseï¼Œå…¶ä½™æƒ…å†µå‡ä¸º trueã€‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Striped64#longAccumulateï¼šcell æ•°ç»„åˆ›å»º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">							<span class="comment">// x  			null 			false | true</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">longAccumulate</span><span class="params">(<span class="type">long</span> x, LongBinaryOperator fn, <span class="type">boolean</span> wasUncontended)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª hash å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell</span></span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– probeï¼Œè·å– hash å€¼</span></span><br><span class="line">        ThreadLocalRandom.current();</span><br><span class="line">        h = getProbe();</span><br><span class="line">        <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ å½“å‰çº¿ç¨‹è‚¯å®šæ˜¯å†™å…¥åˆ°äº† cells[0] ä½ç½®ï¼Œä¸æŠŠå®ƒå½“åšä¸€æ¬¡çœŸæ­£çš„ç«äº‰</span></span><br><span class="line">        wasUncontended = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºã€æ‰©å®¹æ„å‘ã€‘ï¼Œfalse ä¸€å®šä¸ä¼šæ‰©å®¹ï¼Œtrue å¯èƒ½ä¼šæ‰©å®¹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">collide</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// as è¡¨ç¤ºcellså¼•ç”¨ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cellï¼Œn è¡¨ç¤º cells æ•°ç»„é•¿åº¦ï¼Œv è¡¨ç¤º æœŸæœ›å€¼</span></span><br><span class="line">        Cell[] as; Cell a; <span class="type">int</span> n; <span class="type">long</span> v;</span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘: è¡¨ç¤º cells å·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„ cell ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// CASE1.1: true è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯¹åº”çš„ç´¢å¼•ä¸‹æ ‡çš„ Cell ä¸º nullï¼Œéœ€è¦åˆ›å»º new Cell</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ cellsBusy æ˜¯å¦è¢«é”</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// åˆ›å»º cell, åˆå§‹ç´¯åŠ å€¼ä¸º x</span></span><br><span class="line">                    <span class="type">Cell</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cell</span>(x);</span><br><span class="line">                    <span class="comment">// åŠ é”</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="comment">// åˆ›å»ºæˆåŠŸæ ‡è®°ï¼Œè¿›å…¥ã€åˆ›å»º cell é€»è¾‘ã€‘</span></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">created</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Cell[] rs; <span class="type">int</span> m, j;</span><br><span class="line">                            <span class="comment">// æŠŠå½“å‰ cells æ•°ç»„èµ‹å€¼ç»™ rsï¼Œå¹¶ä¸”ä¸ä¸º null</span></span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                <span class="comment">// å†æ¬¡åˆ¤æ–­é˜²æ­¢å…¶å®ƒçº¿ç¨‹åˆå§‹åŒ–è¿‡è¯¥ä½ç½®ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–è¯¥ä½ç½®ä¼šé€ æˆæ•°æ®ä¸¢å¤±</span></span><br><span class="line">                                <span class="comment">// å› ä¸ºè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œè¿›è¡Œçš„é€»è¾‘ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å½±å“</span></span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// æŠŠæ–°åˆ›å»ºçš„ cell å¡«å……è‡³å½“å‰ä½ç½®</span></span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="literal">true</span>;	<span class="comment">// è¡¨ç¤ºåˆ›å»ºå®Œæˆ</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;		<span class="comment">// è§£é”</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)			<span class="comment">// true è¡¨ç¤ºåˆ›å»ºå®Œæˆï¼Œå¯ä»¥æ¨å‡ºå¾ªç¯äº†</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// CASE1.2: æ¡ä»¶æˆç«‹è¯´æ˜çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)</span><br><span class="line">                wasUncontended = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// CASE 1.3: å½“å‰çº¿ç¨‹ rehash è¿‡ï¼Œå¦‚æœæ–°å‘½ä¸­çš„ cell ä¸ä¸ºç©ºï¼Œå°±å°è¯•ç´¯åŠ ï¼Œfalse è¯´æ˜æ–°å‘½ä¸­ä¹Ÿæœ‰ç«äº‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="literal">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// CASE 1.4: cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦ CPU å†…æ ¸çš„æ•°é‡æˆ–è€…å·²ç»æ‰©å®¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                collide = <span class="literal">false</span>; 		<span class="comment">// æ‰©å®¹æ„å‘æ”¹ä¸ºfalseï¼Œã€è¡¨ç¤ºä¸èƒ½æ‰©å®¹äº†ã€‘</span></span><br><span class="line">            <span class="comment">// CASE 1.5: æ›´æ”¹æ‰©å®¹æ„å‘ï¼Œå¦‚æœ n &gt;= NCPUï¼Œè¿™é‡Œå°±æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°ï¼Œcase1.4 æ°¸è¿œå…ˆäº 1.5 æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// CASE 1.6: ã€æ‰©å®¹é€»è¾‘ã€‘ï¼Œè¿›è¡ŒåŠ é”</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// çº¿ç¨‹å®‰å…¨çš„æ£€æŸ¥ï¼Œé˜²æ­¢æœŸé—´è¢«å…¶ä»–çº¿ç¨‹æ‰©å®¹äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                        <span class="comment">// æ‰©å®¹ä¸ºä»¥å‰çš„ 2 å€</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="comment">// éå†ç§»åŠ¨å€¼</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        <span class="comment">// æŠŠæ‰©å®¹åçš„å¼•ç”¨ç»™ cells</span></span><br><span class="line">                        cells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;	<span class="comment">// è§£é”</span></span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;	<span class="comment">// æ‰©å®¹æ„å‘æ”¹ä¸º falseï¼Œè¡¨ç¤ºä¸æ‰©å®¹äº†</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é‡ç½®å½“å‰çº¿ç¨‹ Hash å€¼ï¼Œè¿™å°±æ˜¯ã€åˆ†æ®µè¿ç§»æœºåˆ¶ã€‘</span></span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜ cells è¿˜æœªåˆå§‹åŒ–ï¼Œas ä¸ºnull</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æ²¡æœ‰åŠ é”ï¼Œæ²¡æœ‰åŠ é”å°±ç”¨ CAS åŠ é”</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶äºŒåˆ¤æ–­æ˜¯å¦å…¶å®ƒçº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç»™ as èµ‹å€¼ä¹‹åä¿®æ”¹äº† cellsï¼Œè¿™é‡Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–æ ‡å¿—ï¼Œå¼€å§‹ ã€åˆå§‹åŒ– cells æ•°ç»„ã€‘</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">init</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               	<span class="comment">// å†æ¬¡åˆ¤æ–­ cells == as é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»æå‰åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–å¯¼è‡´ä¸¢å¤±æ•°æ®</span></span><br><span class="line">                <span class="comment">// å› ä¸ºè¿™é‡Œæ˜¯ã€çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡æ–°æ£€æŸ¥ï¼Œç»å…¸ DCLã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[<span class="number">2</span>];	<span class="comment">// åˆå§‹åŒ–æ•°ç»„å¤§å°ä¸º2</span></span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Cell</span>(x);	<span class="comment">// å¡«å……çº¿ç¨‹å¯¹åº”çš„cell</span></span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="literal">true</span>;				<span class="comment">// åˆå§‹åŒ–æˆåŠŸï¼Œæ ‡è®°ç½®ä¸º true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;					<span class="comment">// è§£é”å•Š</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;							<span class="comment">// åˆå§‹åŒ–æˆåŠŸç›´æ¥è·³å‡ºè‡ªæ—‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜å…¶ä»–çº¿ç¨‹åœ¨åˆå§‹åŒ– cellsï¼Œå½“å‰çº¿ç¨‹å°†å€¼ç´¯åŠ åˆ° baseï¼Œç´¯åŠ æˆåŠŸç›´æ¥ç»“æŸè‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="literal">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>sumï¼šè·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ•´åˆï¼Œ<strong>ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸ä¿è¯å¼ºä¸€è‡´æ€§</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sum</span><span class="params">()</span> &#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// éå† ç´¯åŠ </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="literal">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="ABA">ABA</h3>
<p>ABA é—®é¢˜ï¼šå½“è¿›è¡Œè·å–ä¸»å†…å­˜å€¼æ—¶ï¼Œè¯¥å†…å­˜å€¼åœ¨å†™å…¥ä¸»å†…å­˜æ—¶å·²ç»è¢«ä¿®æ”¹äº† N æ¬¡ï¼Œä½†æ˜¯æœ€ç»ˆåˆæ”¹æˆåŸæ¥çš„å€¼</p>
<p>å…¶ä»–çº¿ç¨‹å…ˆæŠŠ A æ”¹æˆ B åˆæ”¹å› Aï¼Œä¸»çº¿ç¨‹<strong>ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒ</strong>ï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œè¿™æ—¶ CAS è™½ç„¶æˆåŠŸï¼Œä½†æ˜¯è¿‡ç¨‹å­˜åœ¨é—®é¢˜</p>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><code>public AtomicStampedReference(V initialRef, int initialStamp)</code>ï¼šåˆå§‹å€¼å’Œåˆå§‹ç‰ˆæœ¬å·</li>
</ul>
</li>
<li>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code> public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)</code>ï¼š<strong>æœŸæœ›å¼•ç”¨å’ŒæœŸæœ›ç‰ˆæœ¬å·éƒ½ä¸€è‡´</strong>æ‰è¿›è¡Œ CAS ä¿®æ”¹æ•°æ®</li>
<li><code>public void set(V newReference, int newStamp)</code>ï¼šè®¾ç½®å€¼å’Œç‰ˆæœ¬å·</li>
<li><code>public V getReference()</code>ï¼šè¿”å›å¼•ç”¨çš„å€¼</li>
<li><code>public int getStamp()</code>ï¼šè¿”å›å½“å‰ç‰ˆæœ¬å·</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    AtomicStampedReference&lt;Integer&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="number">100</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">startStamp</span> <span class="operator">=</span> atomicReference.getStamp();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> atomicReference.getStamp();</span><br><span class="line">        atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">        stamp = atomicReference.getStamp();</span><br><span class="line">        atomicReference.compareAndSet(<span class="number">101</span>, <span class="number">100</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">200</span>, startStamp, startStamp + <span class="number">1</span>)) &#123;</span><br><span class="line">            System.out.println(atomicReference.getReference());<span class="comment">//100</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;çº¿ç¨‹ä¿®æ”¹å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Unsafe">Unsafe</h3>
<p>Unsafe æ˜¯ CAS çš„æ ¸å¿ƒç±»ï¼Œç”±äº Java æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æ¥è®¿é—®</p>
<p>Unsafe ç±»å­˜åœ¨ sun.misc åŒ…ï¼Œå…¶ä¸­æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ native ä¿®é¥°çš„ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨<strong>æ“ä½œç³»ç»Ÿåº•å±‚èµ„æº</strong>æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šçš„å†…å­˜æ•°æ®ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œç±»ä¼¼ C çš„æŒ‡é’ˆ</p>
<p>æ¨¡æ‹Ÿå®ç°åŸå­æ•´æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MyAtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyAtomicInteger</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (atomicInteger.compareAndSwap(<span class="number">20</span>)) &#123;</span><br><span class="line">        System.out.println(atomicInteger.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyAtomicInteger</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> VALUE_OFFSET;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//Unsafe unsafe = Unsafe.getUnsafe()è¿™æ ·ä¼šæŠ¥é”™ï¼Œéœ€è¦åå°„è·å–</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            UNSAFE = (Unsafe) theUnsafe.get(<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// è·å– value å±æ€§çš„å†…å­˜åœ°å€ï¼Œvalue å±æ€§æŒ‡å‘è¯¥åœ°å€ï¼Œç›´æ¥è®¾ç½®è¯¥åœ°å€çš„å€¼å¯ä»¥ä¿®æ”¹ value çš„å€¼</span></span><br><span class="line">            VALUE_OFFSET = UNSAFE.objectFieldOffset(</span><br><span class="line">                		   MyAtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAtomicInteger</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">compareAndSwap</span><span class="params">(<span class="type">int</span> update)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">prev</span> <span class="operator">=</span> <span class="built_in">this</span>.value;</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> update;</span><br><span class="line">            <span class="comment">//							å½“å‰å¯¹è±¡  å†…å­˜åç§»é‡    æœŸæœ›å€¼ æ›´æ–°å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, VALUE_OFFSET, prev, update)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;CASæˆåŠŸ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="final">final</h3>
<h4 id="åŸç†-2">åŸç†</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinal</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­—èŠ‚ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: aload_0</span><br><span class="line"><span class="number">1</span>: invokespecial #<span class="number">1</span> <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="number">4</span>: aload_0</span><br><span class="line"><span class="number">5</span>: bipush <span class="number">20</span>		<span class="comment">// å°†å€¼ç›´æ¥æ”¾å…¥æ ˆä¸­</span></span><br><span class="line"><span class="number">7</span>: putfield #<span class="number">2</span> 		<span class="comment">// Field a:I</span></span><br><span class="line">&lt;-- å†™å±éšœ</span><br><span class="line"><span class="number">10</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>final å˜é‡çš„èµ‹å€¼é€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼Œåœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µ</p>
<p>å…¶ä»–çº¿ç¨‹è®¿é—® final ä¿®é¥°çš„å˜é‡</p>
<ul>
<li><strong>å¤åˆ¶ä¸€ä»½æ”¾å…¥æ ˆä¸­</strong>ç›´æ¥è®¿é—®ï¼Œæ•ˆç‡é«˜</li>
<li>å¤§äº short æœ€å¤§å€¼ä¼šå°†å…¶å¤åˆ¶åˆ°ç±»çš„å¸¸é‡æ± ï¼Œè®¿é—®æ—¶ä»å¸¸é‡æ± è·å–</li>
</ul>
<hr>
<h4 id="ä¸å¯å˜">ä¸å¯å˜</h4>
<p>ä¸å¯å˜ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯å˜å¯¹è±¡</p>
<p>ä¸å¯å˜å¯¹è±¡çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å’Œå¯è§æ€§é—®é¢˜ï¼Œæ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼</p>
<p>String ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œè¯¥ç±»å’Œç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„</p>
<ul>
<li>
<p>ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</p>
</li>
<li>
<p>æ— å†™å…¥æ–¹æ³•ï¼ˆsetï¼‰ç¡®ä¿å¤–éƒ¨ä¸èƒ½å¯¹å†…éƒ¨å±æ€§è¿›è¡Œä¿®æ”¹</p>
</li>
<li>
<p>å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="comment">/** The value is used for character storage. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">char</span> value[];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ›´æ”¹ String ç±»æ•°æ®æ—¶ï¼Œä¼šæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„ char[] valueï¼Œé€šè¿‡<strong>åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ–¹å¼ç§°ä¹‹ä¸ºä¿æŠ¤æ€§æ‹·è´</strong></p>
</li>
</ul>
<hr>
<h3 id="State">State</h3>
<p>æ— çŠ¶æ€ï¼šæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œæ— çŠ¶æ€å°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡</p>
<p>Servlet ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œä¸€èˆ¬ä¸ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<hr>
<h3 id="Local">Local</h3>
<h4 id="åŸºæœ¬ä»‹ç»">åŸºæœ¬ä»‹ç»</h4>
<p>ThreadLocal ç±»ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆé€šè¿‡ get å’Œ set æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ï¼Œåˆ†é…åœ¨å †å†…çš„ <strong>TLAB</strong> ä¸­</p>
<p>ThreadLocal å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ <code>private static</code> ç±»å‹çš„ï¼Œå±äºä¸€ä¸ªçº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåœ¨ ThreadLocal ä¸­ä¿å­˜ä¸€ä»½è¯¥çº¿ç¨‹ç‹¬æœ‰çš„æ•°æ®ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>ThreadLocal ä½œç”¨ï¼š</p>
<ul>
<li>
<p>çº¿ç¨‹å¹¶å‘ï¼šåº”ç”¨åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹</p>
</li>
<li>
<p>ä¼ é€’æ•°æ®ï¼šé€šè¿‡ ThreadLocal å®ç°åœ¨åŒä¸€çº¿ç¨‹ä¸åŒå‡½æ•°æˆ–ç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ï¼Œå‡å°‘ä¼ é€’å¤æ‚åº¦</p>
</li>
<li>
<p>çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šäº’ç›¸å½±å“</p>
</li>
</ul>
<p>å¯¹æ¯” synchronizedï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>synchronized</th>
<th>ThreadLocal</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŸç†</td>
<td>åŒæ­¥æœºåˆ¶é‡‡ç”¨<strong>ä»¥æ—¶é—´æ¢ç©ºé—´</strong>çš„æ–¹å¼ï¼Œåªæä¾›äº†ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—®</td>
<td>ThreadLocal é‡‡ç”¨<strong>ä»¥ç©ºé—´æ¢æ—¶é—´</strong>çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬ï¼Œä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œç›¸ä¸å¹²æ‰°</td>
</tr>
<tr>
<td>ä¾§é‡ç‚¹</td>
<td>å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥</td>
<td>å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="åŸºæœ¬ä½¿ç”¨-2">åŸºæœ¬ä½¿ç”¨</h4>
<h5 id="å¸¸ç”¨æ–¹æ³•">å¸¸ç”¨æ–¹æ³•</h5>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>ThreadLocal&lt;&gt;()</td>
<td>åˆ›å»º ThreadLocal å¯¹è±¡</td>
</tr>
<tr>
<td>protected T initialValue()</td>
<td>è¿”å›å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</td>
</tr>
<tr>
<td>public void set( T value)</td>
<td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td>
</tr>
<tr>
<td>public T get()</td>
<td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td>
</tr>
<tr>
<td>public void remove()</td>
<td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å˜é‡</span></span><br><span class="line">        <span class="keyword">return</span> tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="comment">// å˜é‡contentç»‘å®šåˆ°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        tl.set(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyDemo</span> <span class="variable">demo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyDemo</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®æ•°æ®</span></span><br><span class="line">                    demo.setContent(Thread.currentThread().getName() + <span class="string">&quot;çš„æ•°æ®&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;-----------------------&quot;</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;---&gt;&quot;</span> + demo.getContent());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.setName(<span class="string">&quot;çº¿ç¨‹&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h5>
<p>ThreadLocal é€‚ç”¨äºä¸‹é¢ä¸¤ç§åœºæ™¯ï¼š</p>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹éœ€è¦æœ‰è‡ªå·±å•ç‹¬çš„å®ä¾‹</li>
<li>å®ä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­å…±äº«ï¼Œä½†ä¸å¸Œæœ›è¢«å¤šçº¿ç¨‹å…±äº«</li>
</ul>
<p>ThreadLocal æ–¹æ¡ˆæœ‰ä¸¤ä¸ªçªå‡ºçš„ä¼˜åŠ¿ï¼š</p>
<ol>
<li>ä¼ é€’æ•°æ®ï¼šä¿å­˜æ¯ä¸ªçº¿ç¨‹ç»‘å®šçš„æ•°æ®ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å¯ä»¥ç›´æ¥è·å–ï¼Œé¿å…å‚æ•°ç›´æ¥ä¼ é€’å¸¦æ¥çš„ä»£ç è€¦åˆé—®é¢˜</li>
<li>çº¿ç¨‹éš”ç¦»ï¼šå„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»å´åˆå…·å¤‡å¹¶å‘æ€§ï¼Œé¿å…åŒæ­¥æ–¹å¼å¸¦æ¥çš„æ€§èƒ½æŸå¤±</li>
</ol>
<p>ThreadLocal ç”¨äºæ•°æ®è¿æ¥çš„äº‹åŠ¡ç®¡ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcUtils</span> &#123;</span><br><span class="line">    <span class="comment">// ThreadLocalå¯¹è±¡ï¼Œå°†connectionç»‘å®šåœ¨å½“å‰çº¿ç¨‹ä¸­</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Connection&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line">    <span class="comment">// c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComboPooledDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">    <span class="comment">// è·å–è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">//å–å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„connectionå¯¹è±¡</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> tl.get();</span><br><span class="line">        <span class="keyword">if</span> (conn == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± ä¸­å–å‡º</span></span><br><span class="line">            conn = ds.getConnection();</span><br><span class="line">            <span class="comment">//å†å°†connectionå¯¹è±¡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­ï¼Œéå¸¸é‡è¦çš„æ“ä½œ</span></span><br><span class="line">            tl.set(conn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨ ThreadLocal ä½¿ SimpleDateFormat ä»ç‹¬äº«å˜é‡å˜æˆå•ä¸ªçº¿ç¨‹å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalDateUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;DateFormat&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;DateFormat&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> DateFormat <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">parse</span><span class="params">(String dateStr)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get().parse(dateStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">format</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get().format(date);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å®ç°åŸç†">å®ç°åŸç†</h4>
<h5 id="åº•å±‚ç»“æ„">åº•å±‚ç»“æ„</h5>
<p>JDK8 ä»¥å‰ï¼šæ¯ä¸ª ThreadLocal éƒ½åˆ›å»ºä¸€ä¸ª Mapï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º Map çš„ keyï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º Map çš„ valueï¼Œè¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚è¿™ç§ç»“æ„ä¼šé€ æˆ Map ç»“æ„è¿‡å¤§å’Œå†…å­˜æ³„éœ²ï¼Œå› ä¸º Thread åœæ­¢åæ— æ³•é€šè¿‡ key åˆ é™¤å¯¹åº”çš„æ•°æ®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84JDK8%E5%89%8D.png" alt=""></p>
<p>JDK8 ä»¥åï¼šæ¯ä¸ª Thread ç»´æŠ¤ä¸€ä¸ª ThreadLocalMapï¼Œè¿™ä¸ª Map çš„ key æ˜¯ ThreadLocal å®ä¾‹æœ¬èº«ï¼Œvalue æ˜¯çœŸæ­£è¦å­˜å‚¨çš„å€¼</p>
<ul>
<li><strong>æ¯ä¸ª Thread çº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª Map (ThreadLocalMap)</strong></li>
<li>Map é‡Œé¢å­˜å‚¨ ThreadLocal å¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼ˆvalueï¼‰</li>
<li>Thread å†…éƒ¨çš„ Map æ˜¯ç”± ThreadLocal ç»´æŠ¤çš„ï¼Œç”± ThreadLocal è´Ÿè´£å‘ map è·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼</li>
<li>å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆå‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84JDK8%E5%90%8E.png" alt=""></p>
<p>JDK8 å‰åå¯¹æ¯”ï¼š</p>
<ul>
<li>æ¯ä¸ª Map å­˜å‚¨çš„ Entry æ•°é‡ä¼šå˜å°‘ï¼Œå› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”± Thread çš„æ•°é‡å†³å®šï¼Œç°åœ¨ç”± ThreadLocal çš„æ•°é‡å†³å®šï¼Œåœ¨å®é™…ç¼–ç¨‹å½“ä¸­ï¼Œå¾€å¾€ ThreadLocal çš„æ•°é‡è¦å°‘äº Thread çš„æ•°é‡</li>
<li>å½“ Thread é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„ ThreadLocalMap ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨ï¼Œ<strong>é˜²æ­¢å†…å­˜æ³„éœ²</strong></li>
</ul>
<hr>
<h5 id="æˆå‘˜å˜é‡">æˆå‘˜å˜é‡</h5>
<ul>
<li>
<p>Thread ç±»çš„ç›¸å…³å±æ€§ï¼š<strong>æ¯ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ª ThreadLocalMap å¯¹è±¡</strong>ï¼Œå­˜æ”¾ç”± ThreadLocal å’Œæ•°æ®ç»„æˆçš„ Entry é”®å€¼å¯¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¡ç®— ThreadLocal å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadLocalHashCode</span> <span class="operator">=</span> nextHashCode()</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>threadLocalHashCode &amp; (table.length - 1)</code> è®¡ç®—å½“å‰ entry éœ€è¦å­˜æ”¾çš„ä½ç½®</p>
</li>
<li>
<p>æ¯åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡å°±ä¼šä½¿ç”¨ nextHashCode åˆ†é…ä¸€ä¸ª hash å€¼ç»™è¿™ä¸ªå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">nextHashCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>()</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ï¼Œhash çš„<strong>å¢é‡</strong>å°±æ˜¯è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„æ˜¯ hash åˆ†å¸ƒéå¸¸å‡åŒ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•">æˆå‘˜æ–¹æ³•</h5>
<p>æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸º ThreadLocal å±äºä¸€ä¸ªçº¿ç¨‹çš„ï¼ŒThreadLocal ä¸­çš„æ–¹æ³•ï¼Œé€»è¾‘éƒ½æ˜¯è·å–å½“å‰çº¿ç¨‹ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åè¿›è¡Œæ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œæ²¡æœ‰æŒ‡å®šåˆå§‹å€¼çš„ threadlcoal å¯¹è±¡é»˜è®¤èµ‹å€¼ä¸º null</p>
<ul>
<li>
<p>initialValue()ï¼šè¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</p>
<ul>
<li>å»¶è¿Ÿè°ƒç”¨çš„æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ get æ–¹æ³•æ—¶æ‰æ‰§è¡Œ</li>
<li>è¯¥æ–¹æ³•ç¼ºçœï¼ˆé»˜è®¤ï¼‰å®ç°ç›´æ¥è¿”å›ä¸€ä¸ª null</li>
<li>å¦‚æœæƒ³è¦ä¸€ä¸ªåˆå§‹å€¼ï¼Œå¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œ è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª <code>protected</code> çš„æ–¹æ³•ï¼Œä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>nextHashCode()ï¼šè®¡ç®—å“ˆå¸Œå€¼ï¼ŒThreadLocal çš„æ•£åˆ—æ–¹å¼ç§°ä¹‹ä¸º<strong>æ–æ³¢é‚£å¥‘æ•£åˆ—</strong>ï¼Œæ¯æ¬¡è·å–å“ˆå¸Œå€¼éƒ½ä¼šåŠ ä¸Š HASH_INCREMENTï¼Œè¿™æ ·åšå¯ä»¥å°½é‡é¿å… hash å†²çªï¼Œè®©å“ˆå¸Œå€¼èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨ 2 çš„ n æ¬¡æ–¹çš„æ•°ç»„ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextHashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå€¼è‡ªå¢ä¸€ä¸ª HASH_INCREMENT æ•°å€¼</span></span><br><span class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>set()ï¼šä¿®æ”¹å½“å‰çº¿ç¨‹ä¸å½“å‰ threadlocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ map æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// è°ƒç”¨ threadLocalMap.set æ–¹æ³•è¿›è¡Œé‡å†™æˆ–è€…æ·»åŠ </span></span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// map ä¸ºç©ºï¼Œè°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ã€‚å‚æ•°1æ˜¯å½“å‰çº¿ç¨‹ï¼Œå‚æ•°2æ˜¯å±€éƒ¨å˜é‡</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹ Thread å¯¹åº”ç»´æŠ¤çš„ ThreadLocalMap</span></span><br><span class="line">ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ›å»ºå½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€è¿™é‡Œçš„ this æ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„ threadLocalã€‘ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Map å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>get()ï¼šè·å–å½“å‰çº¿ç¨‹ä¸å½“å‰ ThreadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// å¦‚æœæ­¤mapå­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e</span></span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// å¯¹ e è¿›è¡Œåˆ¤ç©º</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*æœ‰ä¸¤ç§æƒ…å†µæœ‰æ‰§è¡Œå½“å‰ä»£ç </span></span><br><span class="line"><span class="comment">      ç¬¬ä¸€ç§æƒ…å†µ: map ä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æ²¡æœ‰ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span></span><br><span class="line"><span class="comment">      ç¬¬äºŒç§æƒ…å†µ: map å­˜åœ¨, ä½†æ˜¯ã€æ²¡æœ‰ä¸å½“å‰ ThreadLocal å…³è”çš„ entryã€‘ï¼Œå°±ä¼šè®¾ç½®ä¸ºé»˜è®¤å€¼ */</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„ value</span></span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T <span class="title function_">setInitialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼ï¼Œæ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å› null</span></span><br><span class="line">    <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> initialValue();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ map æ˜¯å¦åˆå§‹åŒ–è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// å­˜åœ¨åˆ™è°ƒç”¨ map.set è®¾ç½®æ­¤å®ä½“ entryï¼Œvalue æ˜¯é»˜è®¤çš„å€¼</span></span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ä¸­</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="comment">// è¿”å›çº¿ç¨‹ä¸å½“å‰ threadLocal å…³è”çš„å±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>remove()ï¼šç§»é™¤å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">m</span> <span class="operator">=</span> getMap(Thread.currentThread());</span><br><span class="line">    <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// map å­˜åœ¨åˆ™è°ƒç”¨ map.removeï¼Œthisæ—¶å½“å‰ThreadLocalï¼Œä»¥thisä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“</span></span><br><span class="line">        m.remove(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="LocalMap">LocalMap</h4>
<h5 id="æˆå‘˜å±æ€§">æˆå‘˜å±æ€§</h5>
<p>ThreadLocalMap æ˜¯ ThreadLocal çš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç° Map æ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº† Map çš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨ Entry ä¹Ÿæ˜¯ç‹¬ç«‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–å½“å‰ map å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„çš„åˆå§‹é•¿åº¦ 16</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜æ”¾æ•°æ®çš„tableï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ã€‚</span></span><br><span class="line"><span class="keyword">private</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„é‡Œé¢ entrys çš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­ table å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> threshold;</span><br></pre></td></tr></table></figure>
<p>å­˜å‚¨ç»“æ„ Entryï¼š</p>
<ul>
<li>Entry ç»§æ‰¿ WeakReferenceï¼Œkey æ˜¯å¼±å¼•ç”¨ï¼Œç›®çš„æ˜¯å°† ThreadLocal å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè§£ç»‘</li>
<li>Entry é™åˆ¶åªèƒ½ç”¨ ThreadLocal ä½œä¸º keyï¼Œkey ä¸º null (entry.get() == null) æ„å‘³ç€ key ä¸å†è¢«å¼•ç”¨ï¼Œentry ä¹Ÿå¯ä»¥ä» table ä¸­æ¸…é™¤</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    Object value;</span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="comment">// this.referent = referent = key;</span></span><br><span class="line">        <span class="built_in">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ æ–¹æ³•ï¼šå»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œçº¿ç¨‹ç¬¬ä¸€æ¬¡å­˜å‚¨ threadLocal - value æ—¶æ‰ä¼šåˆ›å»º threadLocalMap å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–tableï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º16çš„Entryæ•°ç»„</span></span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">    <span class="comment">// ã€å¯»å€ç®—æ³•ã€‘è®¡ç®—ç´¢å¼•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»º entry å¯¹è±¡ï¼Œå­˜æ”¾åˆ°æŒ‡å®šä½ç½®çš„ slot ä¸­</span></span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">    <span class="comment">// æ•°æ®æ€»é‡æ˜¯ 1</span></span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å°†é˜ˆå€¼è®¾ç½®ä¸º ï¼ˆå½“å‰æ•°ç»„é•¿åº¦ * 2ï¼‰/ 3ã€‚</span></span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-2">æˆå‘˜æ–¹æ³•</h5>
<ul>
<li>
<p>set()ï¼šæ·»åŠ æ•°æ®ï¼ŒThreadLocalMap ä½¿ç”¨<strong>çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³å“ˆå¸Œå†²çª</strong></p>
<ul>
<li>
<p>è¯¥æ–¹æ³•ä¼šä¸€ç›´æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ’å…¥å Map æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œæ•°ç»„ä¼šæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€</p>
<p>å‡è®¾å½“å‰ table é•¿åº¦ä¸º 16ï¼Œè®¡ç®—å‡ºæ¥ key çš„ hash å€¼ä¸º 14ï¼Œå¦‚æœ table[14] ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶ key ä¸å½“å‰ key ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº† hash å†²çªï¼Œè¿™ä¸ªæ—¶å€™å°† 14 åŠ  1 å¾—åˆ° 15ï¼Œå– table[15] è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ° 0ï¼Œå– table[0]ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ï¼Œå¯ä»¥æŠŠ Entry[] table çœ‹æˆä¸€ä¸ª<strong>ç¯å½¢æ•°ç»„</strong></p>
</li>
<li>
<p>çº¿æ€§æ¢æµ‹æ³•ä¼šå‡ºç°<strong>å †ç§¯é—®é¢˜</strong>ï¼Œå¯ä»¥é‡‡å–å¹³æ–¹æ¢æµ‹æ³•è§£å†³</p>
</li>
<li>
<p>åœ¨æ¢æµ‹è¿‡ç¨‹ä¸­ ThreadLocal ä¼šå¤ç”¨ key ä¸º null çš„è„ Entry å¯¹è±¡ï¼Œå¹¶è¿›è¡Œåƒåœ¾æ¸…ç†ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„æ¼</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨</span></span><br><span class="line">    ThreadLocal.ThreadLocalMap.Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå¯»å€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•å‘åæŸ¥æ‰¾å…ƒç´ ï¼Œç¢°åˆ° entry ä¸ºç©ºæ—¶åœæ­¢æ¢æµ‹</span></span><br><span class="line">    <span class="keyword">for</span> (ThreadLocal.ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; e != <span class="literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰å…ƒç´  key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// ThreadLocal å¯¹åº”çš„ key å­˜åœ¨ï¼Œã€ç›´æ¥è¦†ç›–ä¹‹å‰çš„å€¼ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€è¿™ä¸¤ä¸ªæ¡ä»¶è°å…ˆæˆç«‹ä¸ä¸€å®šï¼Œæ‰€ä»¥ replaceStaleEntry ä¸­è¿˜éœ€è¦åˆ¤æ–­ k == key çš„æƒ…å†µã€‘</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// key ä¸º nullï¼Œä½†æ˜¯å€¼ä¸ä¸º nullï¼Œè¯´æ˜ä¹‹å‰çš„ ThreadLocal å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œå½“å‰æ˜¯ã€è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€ç¢°åˆ°ä¸€ä¸ªè¿‡æœŸçš„ slotï¼Œå½“å‰æ•°æ®å¤ç”¨è¯¥æ§½ä½ï¼Œæ›¿æ¢è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">            <span class="comment">// è¿™ä¸ªæ–¹æ³•è¿˜è¿›è¡Œäº†åƒåœ¾æ¸…ç†åŠ¨ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜ç¢°åˆ° slot == null çš„ä½ç½®ï¼Œåˆ™åœ¨ç©ºå…ƒç´ çš„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„ Entry</span></span><br><span class="line">    tab[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">    <span class="comment">// æ•°é‡ + 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sz</span> <span class="operator">=</span> ++size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ã€åšä¸€æ¬¡å¯å‘å¼æ¸…ç†ã€‘ï¼Œå¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½• entry å¹¶ä¸”ã€å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆè¿›è¡Œ rehash</span></span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        <span class="comment">// æ‰©å®¹</span></span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ã€ç¯å½¢æ•°ç»„ã€‘çš„ä¸‹ä¸€ä¸ªç´¢å¼•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextIndex</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="comment">// ç´¢å¼•è¶Šç•Œåä» 0 å¼€å§‹ç»§ç»­è·å–</span></span><br><span class="line">    <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„æ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceStaleEntry</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value, <span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    Entry e;</span><br><span class="line">	<span class="comment">// æ¢æµ‹å¼æ¸…ç†çš„å¼€å§‹ä¸‹æ ‡ï¼Œé»˜è®¤ä»å½“å‰ staleSlot å¼€å§‹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">slotToExpunge</span> <span class="operator">=</span> staleSlot;</span><br><span class="line">    <span class="comment">// ä»¥å½“å‰ staleSlot å¼€å§‹ã€å‘å‰è¿­ä»£æŸ¥æ‰¾ã€‘ï¼Œæ‰¾åˆ°ç´¢å¼•é å‰è¿‡æœŸæ•°æ®ï¼Œæ‰¾åˆ°ä»¥åæ›¿æ¢ slotToExpunge å€¼</span></span><br><span class="line">    <span class="comment">// ã€ä¿è¯åœ¨ä¸€ä¸ªåŒºé—´æ®µå†…ï¼Œä»æœ€å‰é¢çš„è¿‡æœŸæ•°æ®å¼€å§‹æ¸…ç†ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> prevIndex(staleSlot, len); (e = tab[i]) != <span class="literal">null</span>; i = prevIndex(i, len))</span><br><span class="line">        <span class="keyword">if</span> (e.get() == <span class="literal">null</span>)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»¥ staleSlot ã€å‘åå»æŸ¥æ‰¾ã€‘ï¼Œç›´åˆ°ç¢°åˆ° null ä¸ºæ­¢ï¼Œè¿˜æ˜¯çº¿æ€§æ¢æµ‹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nextIndex(staleSlot, len); (e = tab[i]) != <span class="literal">null</span>; i = nextIndex(i, len)) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">		<span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯ã€æ›¿æ¢é€»è¾‘ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="comment">// å› ä¸ºæœ¬æ¥è¦åœ¨ staleSlot ç´¢å¼•å¤„æ’å…¥è¯¥æ•°æ®ï¼Œç°åœ¨æ‰¾åˆ°äº†iç´¢å¼•å¤„çš„keyä¸æ•°æ®ä¸€è‡´</span></span><br><span class="line">            <span class="comment">// ä½†æ˜¯ i ä½ç½®è·ç¦»æ­£ç¡®çš„ä½ç½®æ›´è¿œï¼Œå› ä¸ºæ˜¯å‘åæŸ¥æ‰¾ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦åœ¨ staleSlot ä½ç½®æ’å…¥å½“å‰ entry</span></span><br><span class="line">            <span class="comment">// ç„¶åå°† table[staleSlot] è¿™ä¸ªè¿‡æœŸæ•°æ®æ”¾åˆ°å½“å‰å¾ªç¯åˆ°çš„ table[i] è¿™ä¸ªä½ç½®ï¼Œ</span></span><br><span class="line">            tab[i] = tab[staleSlot];</span><br><span class="line">            tab[staleSlot] = e;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å‘å‰æŸ¥æ‰¾è¿‡æœŸæ•°æ®å¹¶æœªæ‰¾åˆ°è¿‡æœŸçš„ entryï¼Œä½† staleSlot ä½ç½®å·²ç»ä¸æ˜¯è¿‡æœŸæ•°æ®äº†ï¼Œi ä½ç½®æ‰æ˜¯</span></span><br><span class="line">            <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">                slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ã€æ¸…ç†è¿‡æœŸæ•°æ®ï¼ŒexpungeStaleEntry æ¢æµ‹å¼æ¸…ç†ï¼ŒcleanSomeSlots å¯å‘å¼æ¸…ç†ã€‘</span></span><br><span class="line">            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰éå†çš„ entry æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œå¹¶ä¸”è¯¥ä½ç½®å‰é¢ä¹Ÿæ²¡æœ‰è¿‡æœŸæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">            <span class="comment">// æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ä¿®æ”¹ä¸ºå½“å‰å¾ªç¯çš„ indexï¼Œå› ä¸º staleSlot ä¼šæ”¾å…¥è¦æ·»åŠ çš„æ•°æ®</span></span><br><span class="line">            slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// å‘åæŸ¥æ‰¾è¿‡ç¨‹ä¸­å¹¶æœªå‘ç° k == key çš„ entryï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªã€å–ä»£è¿‡æœŸæ•°æ®é€»è¾‘ã€‘</span></span><br><span class="line">    <span class="comment">// åˆ é™¤åŸæœ‰çš„æ•°æ®å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²</span></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// staleSlot ä½ç½®æ·»åŠ æ•°æ®ï¼Œã€ä¸Šé¢çš„æ‰€æœ‰é€»è¾‘éƒ½ä¸ä¼šæ›´æ”¹ staleSlot çš„å€¼ã€‘</span></span><br><span class="line">    tab[staleSlot] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜é™¤äº† staleSlot ä»¥å¤–ï¼Œè¿˜å‘ç°å…¶å®ƒçš„è¿‡æœŸ slotï¼Œæ‰€ä»¥è¦ã€å¼€å¯æ¸…ç†æ•°æ®çš„é€»è¾‘ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-replaceStaleEntry%E6%B5%81%E7%A8%8B.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">prevIndex</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="comment">// å½¢æˆä¸€ä¸ªç¯ç»•å¼çš„è®¿é—®ï¼Œå¤´ç´¢å¼•è¶Šç•Œåç½®ä¸ºå°¾ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">return</span> ((i - <span class="number">1</span> &gt;= <span class="number">0</span>) ? i - <span class="number">1</span> : len - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>getEntry()ï¼šThreadLocal çš„ get æ–¹æ³•ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå¯»å€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¿é—®æ•£åˆ—è¡¨ä¸­æŒ‡å®šæŒ‡å®šä½ç½®çš„ slot</span></span><br><span class="line">    <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ slot æœ‰å€¼å¹¶ä¸” key å°±æ˜¯è¦å¯»æ‰¾çš„ keyï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è¿›è¡Œçº¿æ€§æ¢æµ‹</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿æ€§æ¢æµ‹å¯»å€</span></span><br><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="type">int</span> i, Entry e)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹éå†ï¼Œç¢°åˆ° slot == null çš„æƒ…å†µï¼Œæœç´¢ç»“æŸ</span></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// è·å–å½“å‰ slot ä¸­ entry å¯¹è±¡çš„ key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>)</span><br><span class="line">             <span class="comment">// è¿‡æœŸæ•°æ®ï¼Œã€æ¢æµ‹å¼è¿‡æœŸæ•°æ®å›æ”¶ã€‘</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ›´æ–° index ç»§ç»­å‘åèµ°</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        <span class="comment">// è·å–ä¸‹ä¸€ä¸ªæ§½ä½ä¸­çš„ entry</span></span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯´æ˜å½“å‰åŒºæ®µæ²¡æœ‰æ‰¾åˆ°ç›¸åº”æ•°æ®</span></span><br><span class="line">    <span class="comment">// ã€å› ä¸ºå­˜æ”¾æ•°æ®æ˜¯çº¿æ€§çš„å‘åå¯»æ‰¾æ§½ä½ï¼Œéƒ½æ˜¯ç´§æŒ¨ç€çš„ï¼Œä¸å¯èƒ½è¶Šè¿‡ä¸€ä¸ª ç©ºæ§½ä½ åœ¨åé¢æ”¾ã€‘ï¼Œå¯ä»¥å‡å°‘éå†çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>rehash()ï¼šè§¦å‘ä¸€æ¬¡å…¨é‡æ¸…ç†ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å¤§äºç­‰äºé•¿åº¦çš„ <code>2/3 * 3/4 = 1/2</code>ï¼Œåˆ™è¿›è¡Œ resize</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ¸…æ¥šå½“å‰æ•£åˆ—è¡¨å†…çš„ã€æ‰€æœ‰ã€‘è¿‡æœŸçš„æ•°æ®</span></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// threshold = len * 2 / 3ï¼Œå°±æ˜¯ 2/3 * (1 - 1/4)</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= threshold - threshold / <span class="number">4</span>)</span><br><span class="line">        resize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">expungeStaleEntries</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// ã€éå†æ‰€æœ‰çš„æ§½ä½ï¼Œæ¸…ç†è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>)</span><br><span class="line">            expungeStaleEntry(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Entry <strong>æ•°ç»„ä¸ºæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€</strong> ï¼Œé‡æ–°è®¡ç®— key çš„æ•£åˆ—å€¼ï¼Œå¦‚æœé‡åˆ° key ä¸º null çš„æƒ…å†µï¼Œä¼šå°†å…¶ value ä¹Ÿç½®ä¸º nullï¼Œå¸®åŠ© GC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resize</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] oldTab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldLen</span> <span class="operator">=</span> oldTab.length;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„çš„é•¿åº¦æ˜¯è€æ•°ç»„çš„äºŒå€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">newLen</span> <span class="operator">=</span> oldLen * <span class="number">2</span>;</span><br><span class="line">    Entry[] newTab = <span class="keyword">new</span> <span class="title class_">Entry</span>[newLen];</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡æ–°tableä¸­çš„entryæ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// éå†è€è¡¨ï¼Œè¿›è¡Œã€æ•°æ®è¿ç§»ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldLen; ++j) &#123;</span><br><span class="line">        <span class="comment">// è®¿é—®è€è¡¨çš„æŒ‡å®šä½ç½®çš„ entry</span></span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> oldTab[j];</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜è€è¡¨ä¸­è¯¥ä½ç½®æœ‰æ•°æ®ï¼Œå¯èƒ½æ˜¯è¿‡æœŸæ•°æ®ä¹Ÿå¯èƒ½ä¸æ˜¯</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">            <span class="comment">// è¿‡æœŸæ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">                e.value = <span class="literal">null</span>; <span class="comment">// Help the GC</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// éè¿‡æœŸæ•°æ®ï¼Œåœ¨æ–°è¡¨ä¸­è¿›è¡Œå“ˆå¸Œå¯»å€</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (newLen - <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// ã€çº¿ç¨‹æ¢æµ‹ã€‘</span></span><br><span class="line">                <span class="keyword">while</span> (newTab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, newLen);</span><br><span class="line">                <span class="comment">// å°†æ•°æ®å­˜æ”¾åˆ°æ–°è¡¨åˆé€‚çš„ slot ä¸­</span></span><br><span class="line">                newTab[h] = e;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// è®¾ç½®ä¸‹ä¸€æ¬¡è§¦å‘æ‰©å®¹çš„æŒ‡æ ‡ï¼šthreshold = len * 2 / 3;</span></span><br><span class="line">    setThreshold(newLen);</span><br><span class="line">    size = count;</span><br><span class="line">    <span class="comment">// å°†æ‰©å®¹åçš„æ–°è¡¨èµ‹å€¼ç»™ threadLocalMap å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„å¼•ç”¨</span></span><br><span class="line">    table = newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>remove()ï¼šåˆ é™¤ Entry</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå¯»å€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; e != <span class="literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°äº†å¯¹åº”çš„ key</span></span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½® key ä¸º null</span></span><br><span class="line">            e.clear();</span><br><span class="line">            <span class="comment">// æ¢æµ‹å¼æ¸…ç†</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ¸…ç†æ–¹æ³•">æ¸…ç†æ–¹æ³•</h5>
<ul>
<li>
<p>æ¢æµ‹å¼æ¸…ç†ï¼šæ²¿ç€å¼€å§‹ä½ç½®å‘åæ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œæ²¿é€”ä¸­ç¢°åˆ°æœªè¿‡æœŸæ•°æ®åˆ™å°†æ­¤æ•°æ® rehash åœ¨ table æ•°ç»„ä¸­çš„å®šä½ï¼Œé‡å®šä½åçš„å…ƒç´ ç†è®ºä¸Šæ›´æ¥è¿‘ <code>i = entry.key &amp; (table.length - 1)</code>ï¼Œè®©<strong>æ•°æ®çš„æ’åˆ—æ›´ç´§å‡‘</strong>ï¼Œä¼šä¼˜åŒ–æ•´ä¸ªæ•£åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// table[staleSlot] æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œä»¥è¿™ä¸ªä½ç½®å¼€å§‹ç»§ç»­å‘åæŸ¥æ‰¾è¿‡æœŸæ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">expungeStaleEntry</span><span class="params">(<span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨å’Œæ•°ç»„é•¿åº¦</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// help gcï¼Œå…ˆæŠŠå½“å‰è¿‡æœŸçš„ entry ç½®ç©ºï¼Œåœ¨å–æ¶ˆå¯¹ entry çš„å¼•ç”¨</span></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ•°é‡-1</span></span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="comment">// ä» staleSlot å¼€å§‹å‘åéå†ï¼Œç›´åˆ°ç¢°åˆ° slot == null ç»“æŸï¼Œã€åŒºé—´å†…æ¸…ç†è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len); (e = tab[i]) != <span class="literal">null</span>; i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// å½“å‰ entry æ˜¯è¿‡æœŸæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// help gc</span></span><br><span class="line">            e.value = <span class="literal">null</span>;</span><br><span class="line">            tab[i] = <span class="literal">null</span>;</span><br><span class="line">            size--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“å‰ entry ä¸æ˜¯è¿‡æœŸæ•°æ®çš„é€»è¾‘ï¼Œã€rehashã€‘</span></span><br><span class="line">            <span class="comment">// é‡æ–°è®¡ç®—å½“å‰ entry å¯¹åº”çš„ index</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ entry å­˜å‚¨æ—¶å‘ç”Ÿè¿‡ hash å†²çªï¼Œå‘ååç§»è¿‡äº†</span></span><br><span class="line">            <span class="keyword">if</span> (h != i) &#123;</span><br><span class="line">                <span class="comment">// å½“å‰ä½ç½®ç½®ç©º</span></span><br><span class="line">                tab[i] = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// ä»¥æ­£ç¡®ä½ç½® h å¼€å§‹ï¼Œå‘åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ä»¥å­˜æ”¾ entry çš„ä½ç½®</span></span><br><span class="line">                <span class="keyword">while</span> (tab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                <span class="comment">// å°†å½“å‰å…ƒç´ æ”¾å…¥åˆ°ã€è·ç¦»æ­£ç¡®ä½ç½®æ›´è¿‘çš„ä½ç½®ï¼Œæœ‰å¯èƒ½å°±æ˜¯æ­£ç¡®ä½ç½®ã€‘</span></span><br><span class="line">                tab[h] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å› slot = null çš„æ§½ä½ç´¢å¼•ï¼Œå›¾ä¾‹æ˜¯ 7ï¼Œè¿™ä¸ªç´¢å¼•ä»£è¡¨ã€ç´¢å¼•å‰é¢çš„åŒºé—´å·²ç»æ¸…ç†å®Œæˆåƒåœ¾äº†ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ThreadLocal%E6%8E%A2%E6%B5%8B%E5%BC%8F%E6%B8%85%E7%90%861.png" style="zoom:67%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ThreadLocal%E6%8E%A2%E6%B5%8B%E5%BC%8F%E6%B8%85%E7%90%862.png" style="zoom:67%;" />
</li>
<li>
<p>å¯å‘å¼æ¸…ç†ï¼šå‘åå¾ªç¯æ‰«æè¿‡æœŸæ•°æ®ï¼Œå‘ç°è¿‡æœŸæ•°æ®è°ƒç”¨æ¢æµ‹å¼æ¸…ç†æ–¹æ³•ï¼Œå¦‚æœè¿ç»­å‡ æ¬¡çš„å¾ªç¯éƒ½æ²¡æœ‰å‘ç°è¿‡æœŸæ•°æ®ï¼Œå°±åœæ­¢æ‰«æ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  i è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œå¼€å§‹ä½ç½®ï¼Œä¸€èˆ¬æ˜¯ç©º slotï¼Œn ä¸€èˆ¬ä¼ é€’çš„æ˜¯ table.length</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">cleanSomeSlots</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œæ˜¯å¦æ¸…é™¤äº†è¿‡æœŸæ•°æ®</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰ map çš„æ•£åˆ—è¡¨å¼•ç”¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œå› ä¸ºæ¢æµ‹å¼è¿”å›çš„ slot ä¸º null</span></span><br><span class="line">        i = nextIndex(i, len);</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯è¿‡æœŸçš„æ•°æ®ï¼Œkey è¢« gc äº†</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€å‘ç°è¿‡æœŸæ•°æ®é‡ç½® n ä¸ºæ•°ç»„çš„é•¿åº¦ã€‘</span></span><br><span class="line">            n = len;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºæ¸…ç†è¿‡è¿‡æœŸæ•°æ®</span></span><br><span class="line">            removed = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// ä»¥å½“å‰è¿‡æœŸçš„ slot ä¸ºå¼€å§‹èŠ‚ç‚¹ åšä¸€æ¬¡æ¢æµ‹å¼æ¸…ç†å·¥ä½œ</span></span><br><span class="line">            i = expungeStaleEntry(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‡è®¾ table é•¿åº¦ä¸º 16</span></span><br><span class="line">        <span class="comment">// 16 &gt;&gt;&gt; 1 ==&gt; 8ï¼Œ8 &gt;&gt;&gt; 1 ==&gt; 4ï¼Œ4 &gt;&gt;&gt; 1 ==&gt; 2ï¼Œ2 &gt;&gt;&gt; 1 ==&gt; 1ï¼Œ1 &gt;&gt;&gt; 1 ==&gt; 0</span></span><br><span class="line">        <span class="comment">// è¿ç»­ç»è¿‡è¿™ä¹ˆå¤šæ¬¡å¾ªç¯ã€æ²¡æœ‰æ‰«æåˆ°è¿‡æœŸæ•°æ®ã€‘ï¼Œå°±åœæ­¢å¾ªç¯ï¼Œæ‰«æåˆ°ç©º slot ä¸ç®—ï¼Œå› ä¸ºä¸æ˜¯è¿‡æœŸæ•°æ®</span></span><br><span class="line">    &#125; <span class="keyword">while</span> ((n &gt;&gt;&gt;= <span class="number">1</span>) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ¸…é™¤æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p>
<hr>
<h4 id="å†…å­˜æ³„æ¼">å†…å­˜æ³„æ¼</h4>
<p>Memory leakï¼šå†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› æœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœï¼Œå†…å­˜æ³„æ¼çš„å †ç§¯ç»ˆå°†å¯¼è‡´å†…å­˜æº¢å‡º</p>
<ul>
<li>
<p>å¦‚æœ key ä½¿ç”¨å¼ºå¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼Œä½†æ˜¯ threadLocalMap çš„ Entry å¼ºå¼•ç”¨äº† threadLocalï¼Œé€ æˆ threadLocal æ— æ³•è¢«å›æ”¶ï¼Œæ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%BC%BA%E5%BC%95%E7%94%A8.png" style="zoom:67%;" />
</li>
<li>
<p>å¦‚æœ key ä½¿ç”¨å¼±å¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼ŒThreadLocalMap åªæŒæœ‰ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œæ‰€ä»¥ threadlocal ä¹Ÿå¯ä»¥è¢«å›æ”¶ï¼Œæ­¤æ—¶ Entry ä¸­çš„ key = nullã€‚ä½†æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry æˆ–è€… CurrentThread ä¾ç„¶è¿è¡Œï¼Œä¾ç„¶å­˜åœ¨å¼ºå¼•ç”¨é“¾ï¼Œvalue ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œè¿™å— value æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œä¹Ÿä¼šå¯¼è‡´ value å†…å­˜æ³„æ¼</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%BC%B1%E5%BC%95%E7%94%A8.png" style="zoom:67%;" />
</li>
<li>
<p>ä¸¤ä¸ªä¸»è¦åŸå› ï¼š</p>
<ul>
<li>æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry</li>
<li>CurrentThread ä¾ç„¶è¿è¡Œ</li>
</ul>
</li>
</ul>
<p>æ ¹æœ¬åŸå› ï¼šThreadLocalMap æ˜¯ Thread çš„ä¸€ä¸ªå±æ€§ï¼Œ<strong>ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread ä¸€æ ·é•¿</strong>ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº” Entry å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</p>
<p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨å®Œ ThreadLocal ä¸­å­˜å‚¨çš„å†…å®¹åå°†å®ƒ remove æ‰å°±å¯ä»¥</p>
<p>ThreadLocal å†…éƒ¨è§£å†³æ–¹æ³•ï¼šåœ¨ ThreadLocalMap ä¸­çš„ set/getEntry æ–¹æ³•ä¸­ï¼Œé€šè¿‡çº¿æ€§æ¢æµ‹æ³•å¯¹ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ key ä¸º nullï¼ˆThreadLocal ä¸º nullï¼‰ä¼šå¯¹ Entry è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥<strong>ä½¿ç”¨å¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¤šä¸€å±‚ä¿éšœ</strong>ï¼Œå°±ç®—ä¸è°ƒç”¨ removeï¼Œä¹Ÿæœ‰æœºä¼šè¿›è¡Œ GC</p>
<hr>
<h4 id="å˜é‡ä¼ é€’">å˜é‡ä¼ é€’</h4>
<h5 id="åŸºæœ¬ä½¿ç”¨-3">åŸºæœ¬ä½¿ç”¨</h5>
<p>çˆ¶å­çº¿ç¨‹ï¼šåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹æ˜¯çˆ¶çº¿ç¨‹ï¼Œæ¯”å¦‚å®ä¾‹ä¸­çš„ main çº¿ç¨‹å°±æ˜¯çˆ¶çº¿ç¨‹</p>
<p>ThreadLocal ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œå¦‚æœæƒ³<strong>å®ç°çº¿ç¨‹é—´å±€éƒ¨å˜é‡ä¼ é€’</strong>å¯ä»¥ä½¿ç”¨ InheritableThreadLocal ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">    threadLocal.set(<span class="string">&quot;çˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; System.out.println(<span class="string">&quot;å­çº¿ç¨‹è¾“å‡ºï¼š&quot;</span> + threadLocal.get())).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å­çº¿ç¨‹è¾“å‡ºï¼šçˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼</span></span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å®ç°åŸç†-2">å®ç°åŸç†</h5>
<p>InheritableThreadLocal æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°çˆ¶å­çº¿ç¨‹é—´çš„å±€éƒ¨å˜é‡å…±äº«éœ€è¦è¿½æº¯åˆ° Thread å¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name, <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                  // è¯¥å‚æ•°é»˜è®¤æ˜¯ <span class="literal">true</span></span></span><br><span class="line"><span class="params">                  <span class="type">boolean</span> inheritThreadLocals)</span> &#123;</span><br><span class="line">  	<span class="comment">// ...</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">parent</span> <span class="operator">=</span> currentThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­çˆ¶çº¿ç¨‹ï¼ˆåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹ï¼‰çš„ inheritableThreadLocals å±æ€§ä¸ä¸º null</span></span><br><span class="line">    <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocals å±æ€§ï¼Œå®ç°çˆ¶å­çº¿ç¨‹å±€éƒ¨å˜é‡å…±äº«</span></span><br><span class="line">        <span class="built_in">this</span>.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ã€æœ¬è´¨ä¸Šè¿˜æ˜¯åˆ›å»º ThreadLocalMapï¼Œåªæ˜¯æŠŠçˆ¶ç±»ä¸­çš„å¯ç»§æ‰¿æ•°æ®è®¾ç½®è¿›å»äº†ã€‘</span></span><br><span class="line"><span class="keyword">static</span> ThreadLocalMap <span class="title function_">createInheritedMap</span><span class="params">(ThreadLocalMap parentMap)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(parentMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ThreadLocalMap</span><span class="params">(ThreadLocalMap parentMap)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çˆ¶çº¿ç¨‹çš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    Entry[] parentTable = parentMap.table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> parentTable.length;</span><br><span class="line">    setThreshold(len);</span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[len];</span><br><span class="line">	<span class="comment">// ã€é€ä¸ªå¤åˆ¶çˆ¶çº¿ç¨‹ ThreadLocalMap ä¸­çš„æ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> parentTable[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;Object&gt; key = (ThreadLocal&lt;Object&gt;) e.get();</span><br><span class="line">            <span class="keyword">if</span> (key != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨çš„æ˜¯ InheritableThreadLocal#childValue(T parentValue)</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> key.childValue(e.value);</span><br><span class="line">                <span class="type">Entry</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">                <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// çº¿æ€§æ¢æµ‹</span></span><br><span class="line">                <span class="keyword">while</span> (table[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                table[h] = c;</span><br><span class="line">                size++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/feichitianxia/article/details/110495764">https://blog.csdn.net/feichitianxia/article/details/110495764</a></p>
<hr>
<h2 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h2>
<h3 id="åŸºæœ¬æ¦‚è¿°">åŸºæœ¬æ¦‚è¿°</h3>
<p>çº¿ç¨‹æ± ï¼šä¸€ä¸ªå®¹çº³å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„çº¿ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œçœå»äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¯¹è±¡çš„æ“ä½œ</p>
<p>çº¿ç¨‹æ± ä½œç”¨ï¼š</p>
<ol>
<li>é™ä½èµ„æºæ¶ˆè€—ï¼Œå‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨ï¼Œå¯æ‰§è¡Œå¤šä¸ªä»»åŠ¡</li>
<li>æé«˜å“åº”é€Ÿåº¦ï¼Œå½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥ç”¨ï¼Œä¸ä¼šå‡ºç°ç³»ç»Ÿåƒµæ­»</li>
<li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºçº¿ç¨‹ï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§</li>
</ol>
<p>çº¿ç¨‹æ± çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>çº¿ç¨‹å¤ç”¨</strong>ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¢«é‡å¤ä½¿ç”¨ï¼Œæ¥å¤„ç†å¤šä¸ªä»»åŠ¡</p>
<p>æ± åŒ–æŠ€æœ¯ (Pool) ï¼šä¸€ç§ç¼–ç¨‹æŠ€å·§ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯èµ„æºå¤ç”¨ï¼Œåœ¨è¯·æ±‚é‡å¤§æ—¶èƒ½ä¼˜åŒ–åº”ç”¨æ€§èƒ½ï¼Œé™ä½ç³»ç»Ÿé¢‘ç¹å»ºè¿çš„èµ„æºå¼€é”€</p>
<hr>
<h3 id="é˜»å¡é˜Ÿåˆ—-2">é˜»å¡é˜Ÿåˆ—</h3>
<h4 id="åŸºæœ¬ä»‹ç»-2">åŸºæœ¬ä»‹ç»</h4>
<p>æœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ï¼š</p>
<ul>
<li>
<p>æœ‰ç•Œé˜Ÿåˆ—ï¼šæœ‰å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚è®¾å®šäº†å›ºå®šå¤§å°çš„ LinkedBlockingQueueï¼Œåˆæˆ–è€…å¤§å°ä¸º 0</p>
</li>
<li>
<p>æ— ç•Œé˜Ÿåˆ—ï¼šæ²¡æœ‰è®¾ç½®å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼Œè¿™äº›é˜Ÿåˆ—å¯ä»¥ç›´æ¥å…¥é˜Ÿï¼Œç›´åˆ°æº¢å‡ºï¼ˆè¶…è¿‡ Integer.MAX_VALUEï¼‰ï¼Œæ‰€ä»¥ç›¸å½“äºæ— ç•Œ</p>
</li>
</ul>
<p>java.util.concurrent.BlockingQueue æ¥å£æœ‰ä»¥ä¸‹é˜»å¡é˜Ÿåˆ—çš„å®ç°ï¼š<strong>FIFO é˜Ÿåˆ—</strong></p>
<ul>
<li>ArrayBlockQueueï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li>
<li>LinkedBlockingQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œï¼ˆé»˜è®¤å¤§å° Integer.MAX_VALUEï¼‰çš„é˜»å¡é˜Ÿåˆ—</li>
<li>PriorityBlockQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li>
<li>DelayedWorkQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—</li>
<li>SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªç”Ÿäº§çº¿ç¨‹ä¼šé˜»å¡åˆ°æœ‰ä¸€ä¸ª put çš„çº¿ç¨‹æ”¾å…¥å…ƒç´ ä¸ºæ­¢</li>
<li>LinkedTransferQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li>
<li>LinkedBlockingDequeï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„<strong>åŒå‘</strong>é˜»å¡é˜Ÿåˆ—</li>
</ul>
<p>ä¸æ™®é€šé˜Ÿåˆ—ï¼ˆLinkedListã€ArrayList ç­‰ï¼‰çš„ä¸åŒç‚¹åœ¨äºé˜»å¡é˜Ÿåˆ—ä¸­é˜»å¡æ·»åŠ å’Œé˜»å¡åˆ é™¤æ–¹æ³•ï¼Œä»¥åŠçº¿ç¨‹å®‰å…¨ï¼š</p>
<ul>
<li>é˜»å¡æ·»åŠ  put()ï¼šå½“é˜»å¡é˜Ÿåˆ—å…ƒç´ å·²æ»¡æ—¶ï¼Œæ·»åŠ é˜Ÿåˆ—å…ƒç´ çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—å…ƒç´ ä¸æ»¡æ—¶æ‰é‡æ–°å”¤é†’çº¿ç¨‹æ‰§è¡Œ</li>
<li>é˜»å¡åˆ é™¤ take()ï¼šåœ¨é˜Ÿåˆ—å…ƒç´ ä¸ºç©ºæ—¶ï¼Œåˆ é™¤é˜Ÿåˆ—å…ƒç´ çš„çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºå†æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆä¸€èˆ¬ä¼šè¿”å›è¢«åˆ é™¤çš„å…ƒç´ )</li>
</ul>
<hr>
<h4 id="æ ¸å¿ƒæ–¹æ³•">æ ¸å¿ƒæ–¹æ³•</h4>
<table>
<thead>
<tr>
<th>æ–¹æ³•ç±»å‹</th>
<th>æŠ›å‡ºå¼‚å¸¸</th>
<th>ç‰¹æ®Šå€¼</th>
<th>é˜»å¡</th>
<th>è¶…æ—¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ’å…¥ï¼ˆå°¾ï¼‰</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e,time,unit)</td>
</tr>
<tr>
<td>ç§»é™¤ï¼ˆå¤´ï¼‰</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time,unit)</td>
</tr>
<tr>
<td>æ£€æŸ¥ï¼ˆé˜Ÿé¦–å…ƒç´ ï¼‰</td>
<td>element()</td>
<td>peek()</td>
<td>ä¸å¯ç”¨</td>
<td>ä¸å¯ç”¨</td>
</tr>
</tbody>
</table>
<ul>
<li>æŠ›å‡ºå¼‚å¸¸ç»„ï¼š
<ul>
<li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼šåœ¨å¾€é˜Ÿåˆ—ä¸­ add æ’å…¥å…ƒç´ ä¼šæŠ›å‡º IIIegalStateException: Queue full</li>
<li>å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼šå†å¾€é˜Ÿåˆ—ä¸­ remove ç§»é™¤å…ƒç´ ï¼Œä¼šæŠ›å‡º NoSuchException</li>
</ul>
</li>
<li>ç‰¹æ®Šå€¼ç»„ï¼š
<ul>
<li>æ’å…¥æ–¹æ³•ï¼šæˆåŠŸ trueï¼Œå¤±è´¥ false</li>
<li>ç§»é™¤æ–¹æ³•ï¼šæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—å…ƒç´ ï¼Œé˜Ÿåˆ—æ²¡æœ‰å°±è¿”å› null</li>
</ul>
</li>
<li>é˜»å¡ç»„ï¼š
<ul>
<li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…ç»§ç»­å¾€é˜Ÿåˆ—é‡Œ put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºé—´ put æ•°æ®æˆ–å“åº”ä¸­æ–­é€€å‡º</li>
<li>å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨å…ƒç´ </li>
</ul>
</li>
<li>è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿé‡Œä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º</li>
</ul>
<hr>
<h4 id="é“¾è¡¨é˜Ÿåˆ—">é“¾è¡¨é˜Ÿåˆ—</h4>
<h5 id="å…¥é˜Ÿå‡ºé˜Ÿ">å…¥é˜Ÿå‡ºé˜Ÿ</h5>
<p>LinkedBlockingQueue æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">			<span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">        E item;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€</span></span><br><span class="line"><span class="comment">        * - çœŸæ­£çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">        * - è‡ªå·±, å‘ç”Ÿåœ¨å‡ºé˜Ÿæ—¶</span></span><br><span class="line"><span class="comment">        * - null, è¡¨ç¤ºæ˜¯æ²¡æœ‰åç»§èŠ‚ç‚¹, æ˜¯å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(E x) &#123; item = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¥é˜Ÿï¼š<strong>å°¾æ’æ³•</strong></p>
<ul>
<li>
<p>åˆå§‹åŒ–é“¾è¡¨ <code>last = head = new Node&lt;E&gt;(null)</code>ï¼Œ<strong>Dummy èŠ‚ç‚¹ç”¨æ¥å ä½</strong>ï¼Œitem ä¸º null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LinkedBlockingQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æ˜¯ Integer.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    last = head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»å³å‘å·¦è®¡ç®—</span></span><br><span class="line">    last = last.next = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-LinkedBlockingQueue%E5%85%A5%E9%98%9F%E6%B5%81%E7%A8%8B.png" alt=""></p>
</li>
<li>
<p>å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ <code>last = last.next = node</code></p>
</li>
</ul>
<p>å‡ºé˜Ÿï¼š<strong>å‡ºé˜Ÿå¤´èŠ‚ç‚¹</strong>ï¼ŒFIFO</p>
<ul>
<li>
<p>å‡ºé˜Ÿæºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> E <span class="title function_">dequeue</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;E&gt; h = head;</span><br><span class="line">    <span class="comment">// è·å–ä¸´å¤´èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; first = h.next;</span><br><span class="line">    <span class="comment">// è‡ªå·±æŒ‡å‘è‡ªå·±ï¼Œhelp GC</span></span><br><span class="line">    h.next = h;</span><br><span class="line">    head = first;</span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿçš„å…ƒç´ </span></span><br><span class="line">    <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> first.item;</span><br><span class="line">    <span class="comment">// ã€å½“å‰èŠ‚ç‚¹ç½®ä¸º Dummy èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    first.item = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>h = head</code> â†’ <code>first = h.next</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-LinkedBlockingQueue%E5%87%BA%E9%98%9F%E6%B5%81%E7%A8%8B1.png" alt=""></p>
</li>
<li>
<p><code>h.next = h</code> â†’ <code>head = first</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-LinkedBlockingQueue%E5%87%BA%E9%98%9F%E6%B5%81%E7%A8%8B2.png" alt=""></p>
<ul>
<li><code>first.item = null</code>ï¼šå½“å‰èŠ‚ç‚¹ç½®ä¸º Dummy èŠ‚ç‚¹</li>
</ul>
</li>
</ul>
<hr>
<h5 id="åŠ é”åˆ†æ">åŠ é”åˆ†æ</h5>
<p>ç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹ï¼š</p>
<ul>
<li>ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ</li>
<li>ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ
<ul>
<li>æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li>
<li>ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li>
</ul>
</li>
</ul>
<p>çº¿ç¨‹å®‰å…¨åˆ†æï¼š</p>
<ul>
<li>
<p>å½“èŠ‚ç‚¹æ€»æ•°å¤§äº 2 æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼Œ<strong>putLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯ head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨</strong>ï¼Œä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰</p>
</li>
<li>
<p>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 2 æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰</p>
</li>
<li>
<p>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 1 æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨äº put(é˜»å¡) offer(éé˜»å¡)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> putLock.newCondition();	<span class="comment">// é˜»å¡ç­‰å¾…ä¸æ»¡ï¼Œè¯´æ˜å·²ç»æ»¡äº†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äº take(é˜»å¡) poll(éé˜»å¡)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> takeLock.newCondition();	<span class="comment">// é˜»å¡ç­‰å¾…ä¸ç©ºï¼Œè¯´æ˜å·²ç»æ˜¯ç©ºçš„</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å…¥é˜Ÿå‡ºé˜Ÿï¼š</p>
<ul>
<li>
<p>put æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æŠŠå¾…æ·»åŠ çš„å…ƒç´ å°è£…ä¸º node èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">    <span class="comment">// è·å–å…¨å±€ç”Ÿäº§é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">    <span class="comment">// count ç”¨æ¥ç»´æŠ¤å…ƒç´ è®¡æ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="comment">// è·å–å¯æ‰“æ–­é”ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">// é˜Ÿåˆ—æ»¡äº†ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            <span class="comment">// ã€ç­‰å¾…é˜Ÿåˆ—ä¸æ»¡æ—¶ï¼Œå°±å¯ä»¥ç”Ÿäº§æ•°æ®ã€‘ï¼Œçº¿ç¨‹å¤„äº Waiting</span></span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ‰ç©ºä½, å…¥é˜Ÿä¸”è®¡æ•°åŠ ä¸€ï¼Œå°¾æ’æ³•</span></span><br><span class="line">        enqueue(node);</span><br><span class="line">        <span class="comment">// è¿”å›è‡ªå¢å‰çš„æ•°å­—</span></span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// put å®Œé˜Ÿåˆ—è¿˜æœ‰ç©ºä½, å”¤é†’å…¶ä»–ç”Ÿäº§ put çº¿ç¨‹ï¼Œå”¤é†’ä¸€ä¸ªå‡å°‘ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cè‡ªå¢å‰æ˜¯0ï¼Œè¯´æ˜ç”Ÿäº§äº†ä¸€ä¸ªå…ƒç´ ï¼Œå”¤é†’ä¸€ä¸ª take çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">signalNotEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ notEmpty.signal()ï¼Œè€Œä¸æ˜¯ notEmpty.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰ï¼Œå› ä¸ºåªå‰©ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>take æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    E x;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="comment">// è·å–å…¨å±€æ¶ˆè´¹é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">    <span class="comment">// å¯æ‰“æ–­é”</span></span><br><span class="line">    takeLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å…ƒç´ å¯ä»¥å‡ºé˜Ÿ</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€é˜»å¡ç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œå°±å¯ä»¥æ¶ˆè´¹æ•°æ®ã€‘ï¼Œçº¿ç¨‹å¤„äº Waiting</span></span><br><span class="line">            notEmpty.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‡ºé˜Ÿï¼Œè®¡æ•°å‡ä¸€ï¼ŒFIFOï¼Œå‡ºé˜Ÿå¤´èŠ‚ç‚¹</span></span><br><span class="line">        x = dequeue();</span><br><span class="line">        <span class="comment">// è¿”å›è‡ªå‡å‰çš„æ•°å­—</span></span><br><span class="line">        c = count.getAndDecrement();</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—è¿˜æœ‰å…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">            <span class="comment">// å”¤é†’ä¸€ä¸ªæ¶ˆè´¹takeçº¿ç¨‹</span></span><br><span class="line">            notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// c æ˜¯æ¶ˆè´¹å‰çš„æ•°æ®ï¼Œæ¶ˆè´¹å‰æ»¡äº†ï¼Œæ¶ˆè´¹ä¸€ä¸ªåè¿˜å‰©ä¸€ä¸ªç©ºä½ï¼Œå”¤é†’ç”Ÿäº§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        <span class="comment">// è°ƒç”¨çš„æ˜¯ notFull.signal() è€Œä¸æ˜¯ notFull.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰</span></span><br><span class="line">        signalNotFull();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ€§èƒ½æ¯”è¾ƒ">æ€§èƒ½æ¯”è¾ƒ</h5>
<p>ä¸»è¦åˆ—ä¸¾ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„æ€§èƒ½æ¯”è¾ƒï¼š</p>
<ul>
<li>Linked æ”¯æŒæœ‰ç•Œï¼ŒArray å¼ºåˆ¶æœ‰ç•Œ</li>
<li>Linked å®ç°æ˜¯é“¾è¡¨ï¼ŒArray å®ç°æ˜¯æ•°ç»„</li>
<li>Linked æ˜¯æ‡’æƒ°çš„ï¼Œè€Œ Array éœ€è¦æå‰åˆå§‹åŒ– Node æ•°ç»„</li>
<li>Linked æ¯æ¬¡å…¥é˜Ÿä¼šç”Ÿæˆæ–° Nodeï¼Œè€Œ Array çš„ Node æ˜¯æå‰åˆ›å»ºå¥½çš„</li>
<li>Linked ä¸¤æŠŠé”ï¼ŒArray ä¸€æŠŠé”</li>
</ul>
<hr>
<h4 id="åŒæ­¥é˜Ÿåˆ—">åŒæ­¥é˜Ÿåˆ—</h4>
<h5 id="æˆå‘˜å±æ€§-2">æˆå‘˜å±æ€§</h5>
<p>SynchronousQueue æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„ BlockingQueueï¼Œ<strong>æ¯ä¸€ä¸ªç”Ÿäº§è€…å¿…é¡»é˜»å¡åŒ¹é…åˆ°ä¸€ä¸ªæ¶ˆè´¹è€…</strong></p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li>
<p>è¿è¡Œå½“å‰ç¨‹åºçš„å¹³å°æ‹¥æœ‰ CPU çš„æ•°é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NCPUS</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors()</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŒ‡å®šè¶…æ—¶æ—¶é—´åï¼Œå½“å‰çº¿ç¨‹æœ€å¤§è‡ªæ—‹æ¬¡æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªæœ‰ä¸€ä¸ª CPU æ—¶è‡ªæ—‹æ¬¡æ•°ä¸º 0ï¼Œæ‰€æœ‰ç¨‹åºéƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œå¤šæ ¸ CPU æ—¶è‡ªæ—‹ 32 æ¬¡æ˜¯ä¸€ä¸ªç»éªŒå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxTimedSpins</span> <span class="operator">=</span> (NCPUS &lt; <span class="number">2</span>) ? <span class="number">0</span> : <span class="number">32</span>;</span><br></pre></td></tr></table></figure>
<p>è‡ªæ—‹çš„åŸå› ï¼šçº¿ç¨‹æŒ‚èµ·å”¤é†’éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬å˜ï¼Œæ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ã€‚è‡ªæ—‹æœŸé—´çº¿ç¨‹ä¼šä¸€ç›´æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€æ˜¯å¦è¢«åŒ¹é…åˆ°ï¼Œå¦‚æœè‡ªæ—‹æœŸé—´è¢«åŒ¹é…åˆ°ï¼Œé‚£ä¹ˆç›´æ¥å°±è¿”å›äº†ï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°è¾¾åˆ°æŸä¸ªæŒ‡æ ‡åï¼Œè¿˜æ˜¯ä¼šå°†å½“å‰çº¿ç¨‹æŒ‚èµ·</p>
</li>
<li>
<p>æœªæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹æœ€å¤§è‡ªæ—‹æ¬¡æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxUntimedSpins</span> <span class="operator">=</span> maxTimedSpins * <span class="number">16</span>;	<span class="comment">// maxTimedSpins çš„ 16 å€</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">spinForTimeoutThreshold</span> <span class="operator">=</span> <span class="number">1000L</span>;	<span class="comment">// çº³ç§’</span></span><br></pre></td></tr></table></figure>
<p>è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œé˜»å¡å†å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬</p>
</li>
<li>
<p>è½¬æ¢å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Transferer&lt;E&gt; transferer;</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Transferer</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‚æ•°ä¸€ï¼šå¯ä»¥ä¸º nullï¼Œnull æ—¶è¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ª REQUEST ç±»å‹çš„è¯·æ±‚ï¼Œåä¹‹æ˜¯ä¸€ä¸ª DATA ç±»å‹çš„è¯·æ±‚</span></span><br><span class="line"><span class="comment">    * å‚æ•°äºŒï¼šå¦‚æœä¸º true è¡¨ç¤ºæŒ‡å®šäº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœä¸º false è¡¨ç¤ºä¸æ”¯æŒè¶…æ—¶ï¼Œä¼šä¸€ç›´é˜»å¡åˆ°åŒ¹é…æˆ–è€…è¢«æ‰“æ–­</span></span><br><span class="line"><span class="comment">    * å‚æ•°ä¸‰ï¼šè¶…æ—¶æ—¶é—´é™åˆ¶ï¼Œå•ä½æ˜¯çº³ç§’</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    * è¿”å›å€¼ï¼šè¿”å›å€¼å¦‚æœä¸ä¸º null è¡¨ç¤ºåŒ¹é…æˆåŠŸï¼ŒDATA ç±»å‹çš„è¯·æ±‚è¿”å›å½“å‰çº¿ç¨‹ put çš„æ•°æ®</span></span><br><span class="line"><span class="comment">    * 	     å¦‚æœè¿”å› nullï¼Œè¡¨ç¤ºè¯·æ±‚è¶…æ—¶æˆ–è¢«ä¸­æ–­</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">abstract</span> E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SynchronousQueue</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    <span class="comment">// fair é»˜è®¤ false</span></span><br><span class="line">    <span class="comment">// éå…¬å¹³æ¨¡å¼å®ç°çš„æ•°æ®ç»“æ„æ˜¯æ ˆï¼Œå…¬å¹³æ¨¡å¼çš„æ•°æ®ç»“æ„æ˜¯é˜Ÿåˆ—</span></span><br><span class="line">    transferer = fair ? <span class="keyword">new</span> <span class="title class_">TransferQueue</span>&lt;E&gt;() : <span class="keyword">new</span> <span class="title class_">TransferStack</span>&lt;E&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">return</span> transferer.transfer(e, <span class="literal">true</span>, <span class="number">0</span>) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> transferer.transfer(<span class="literal">null</span>, <span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="éå…¬å®ç°">éå…¬å®ç°</h5>
<p>TransferStack æ˜¯éå…¬å¹³çš„åŒæ­¥é˜Ÿåˆ—ï¼Œå› ä¸ºæ‰€æœ‰çš„è¯·æ±‚éƒ½è¢«å‹å…¥æ ˆä¸­ï¼Œæ ˆé¡¶çš„å…ƒç´ ä¼šæœ€å…ˆå¾—åˆ°åŒ¹é…ï¼Œé€ æˆæ ˆåº•çš„ç­‰å¾…çº¿ç¨‹é¥¥é¥¿</p>
<p>TransferStack ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li>
<p>è¯·æ±‚ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤º Node ç±»å‹ä¸ºè¯·æ±‚ç±»å‹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REQUEST</span>    <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// è¡¨ç¤º Nodeç±» å‹ä¸ºæ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DATA</span>       <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// è¡¨ç¤º Node ç±»å‹ä¸ºåŒ¹é…ä¸­ç±»å‹</span></span><br><span class="line"><span class="comment">// å‡è®¾æ ˆé¡¶å…ƒç´ ä¸º REQUEST-NODEï¼Œå½“å‰è¯·æ±‚ç±»å‹ä¸º DATAï¼Œå…¥æ ˆä¼šä¿®æ”¹ç±»å‹ä¸º FULFILLING ã€æ ˆé¡¶ &amp; æ ˆé¡¶ä¹‹ä¸‹çš„ä¸€ä¸ªnodeã€‘</span></span><br><span class="line"><span class="comment">// å‡è®¾æ ˆé¡¶å…ƒç´ ä¸º DATA-NODEï¼Œå½“å‰è¯·æ±‚ç±»å‹ä¸º REQUESTï¼Œå…¥æ ˆä¼šä¿®æ”¹ç±»å‹ä¸º FULFILLING ã€æ ˆé¡¶ &amp; æ ˆé¡¶ä¹‹ä¸‹çš„ä¸€ä¸ªnodeã€‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FULFILLING</span> <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ ˆé¡¶å…ƒç´ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> SNode head;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å†…éƒ¨ç±» SNodeï¼š</p>
<ul>
<li>
<p>æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SNode</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªæ ˆå¸§</span></span><br><span class="line">    <span class="keyword">volatile</span> SNode next;</span><br><span class="line">    <span class="comment">// ä¸å½“å‰ node åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> SNode match;</span><br><span class="line">    <span class="comment">// å‡è®¾å½“å‰nodeå¯¹åº”çš„çº¿ç¨‹è‡ªæ—‹æœŸé—´æœªè¢«åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆnodeå¯¹åº”çš„çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œ</span></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å‰ waiter ä¿å­˜å¯¹åº”çš„çº¿ç¨‹å¼•ç”¨ï¼Œæ–¹ä¾¿åŒ¹é…æˆåŠŸåï¼Œè¢«å”¤é†’ã€‚</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®åŸŸï¼Œä¸ä¸ºç©ºè¡¨ç¤ºå½“å‰ Node å¯¹åº”çš„è¯·æ±‚ç±»å‹ä¸º DATA ç±»å‹ï¼Œåä¹‹åˆ™è¡¨ç¤º Node ä¸º REQUEST ç±»å‹</span></span><br><span class="line">    Object item;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰Nodeçš„æ¨¡å¼ ã€DATA/REQUEST/FULFILLINGã€‘</span></span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SNode(Object item) &#123;</span><br><span class="line">    <span class="built_in">this</span>.item = item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®æ–¹æ³•ï¼šè®¾ç½® Node å¯¹è±¡çš„ next å­—æ®µï¼Œæ­¤å¤„<strong>å¯¹ CAS è¿›è¡Œäº†ä¼˜åŒ–</strong>ï¼Œæå‡äº† CAS çš„æ•ˆç‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">casNext</span><span class="params">(SNode cmp, SNode val)</span> &#123;</span><br><span class="line">    <span class="comment">//ã€ä¼˜åŒ–ï¼šcmp == nextã€‘ï¼Œå¯ä»¥æå‡ä¸€éƒ¨åˆ†æ€§èƒ½ã€‚ cmp == next ä¸ç›¸ç­‰ï¼Œå°±æ²¡å¿…è¦èµ° casæŒ‡ä»¤ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> cmp == next &amp;&amp; UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, nextOffset, cmp, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åŒ¹é…æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">tryMatch</span><span class="params">(SNode s)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰ node å°šæœªä¸ä»»ä½•èŠ‚ç‚¹å‘ç”Ÿè¿‡åŒ¹é…ï¼ŒCAS è®¾ç½® match å­—æ®µä¸º s èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰ node å·²ç»è¢«åŒ¹é…</span></span><br><span class="line">    <span class="keyword">if</span> (match == <span class="literal">null</span> &amp;&amp; UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, matchOffset, <span class="literal">null</span>, s)) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰ node å¦‚æœè‡ªæ—‹ç»“æŸï¼Œä¼š park é˜»å¡ï¼Œé˜»å¡å‰å°† node å¯¹åº”çš„ Thread ä¿ç•™åˆ° waiter å­—æ®µ</span></span><br><span class="line">        <span class="comment">// è·å–å½“å‰ node å¯¹åº”çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">w</span> <span class="operator">=</span> waiter;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ node å¯¹åº”çš„ Thread æ­£åœ¨é˜»å¡</span></span><br><span class="line">        <span class="keyword">if</span> (w != <span class="literal">null</span>) &#123;</span><br><span class="line">            waiter = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ unpark æ–¹å¼å”¤é†’çº¿ç¨‹</span></span><br><span class="line">            LockSupport.unpark(w);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŒ¹é…æˆåŠŸè¿”å› true</span></span><br><span class="line">    <span class="keyword">return</span> match == s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å–æ¶ˆæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å–æ¶ˆèŠ‚ç‚¹çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">tryCancel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// match å­—æ®µæŒ‡å‘è‡ªå·±ï¼Œè¡¨ç¤ºè¿™ä¸ª node æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œå–æ¶ˆçŠ¶æ€çš„ nodeï¼Œæœ€ç»ˆä¼šè¢«å¼ºåˆ¶ç§»é™¤å‡ºæ ˆ</span></span><br><span class="line">    UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, matchOffset, <span class="literal">null</span>, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> match == <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>TransferStack ç±»æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>snode()ï¼šå¡«å……èŠ‚ç‚¹æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> SNode <span class="title function_">snode</span><span class="params">(SNode s, Object e, SNode next, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// å¼•ç”¨æŒ‡å‘ç©ºæ—¶ï¼Œsnode æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª SNode å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span>) s = <span class="keyword">new</span> <span class="title class_">SNode</span>(e);</span><br><span class="line">    <span class="comment">// å¡«å……æ•°æ®</span></span><br><span class="line">    s.mode = mode;</span><br><span class="line">    s.next = next;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>transfer()ï¼šæ ¸å¿ƒæ–¹æ³•ï¼Œè¯·æ±‚åŒ¹é…å‡ºæ ˆï¼Œä¸åŒ¹é…é˜»å¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">	<span class="comment">// åŒ…è£…å½“å‰çº¿ç¨‹çš„ node</span></span><br><span class="line">    <span class="type">SNode</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ®å…ƒç´ åˆ¤æ–­å½“å‰çš„è¯·æ±‚ç±»å‹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mode</span> <span class="operator">=</span> (e == <span class="literal">null</span>) ? REQUEST : DATA;</span><br><span class="line">	<span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ ˆé¡¶æŒ‡é’ˆ</span></span><br><span class="line">        <span class="type">SNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">       <span class="comment">// ã€CASE1ã€‘ï¼šå½“å‰æ ˆä¸ºç©ºæˆ–è€…æ ˆé¡¶ node æ¨¡å¼ä¸å½“å‰è¯·æ±‚æ¨¡å¼ä¸€è‡´æ— æ³•åŒ¹é…ï¼Œåšå…¥æ ˆæ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (h == <span class="literal">null</span> || h.mode == mode) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰è¯·æ±‚æ˜¯æ”¯æŒè¶…æ—¶çš„ï¼Œä½†æ˜¯ nanos &lt;= 0 è¯´æ˜è¿™ä¸ªè¯·æ±‚ä¸æ”¯æŒ â€œé˜»å¡ç­‰å¾…â€</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æ ˆé¡¶å…ƒç´ æ˜¯å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.isCancelled())</span><br><span class="line">                    <span class="comment">// æ ˆé¡¶å‡ºæ ˆï¼Œè®¾ç½®æ–°çš„æ ˆé¡¶</span></span><br><span class="line">                    casHead(h, h.next);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// è¡¨ç¤ºã€åŒ¹é…å¤±è´¥ã€‘</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// å…¥æ ˆ</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (casHead(h, s = snode(s, e, h, mode))) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…è¢«åŒ¹é…çš„é€»è¾‘ï¼Œæ­£å¸¸æƒ…å†µè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ï¼›å–æ¶ˆæƒ…å†µè¿”å›å½“å‰èŠ‚ç‚¹ï¼Œå°±æ˜¯ s</span></span><br><span class="line">                <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> awaitFulfill(s, timed, nanos);</span><br><span class="line">                <span class="comment">// è¯´æ˜å½“å‰ node æ˜¯ã€å–æ¶ˆçŠ¶æ€ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (m == s) &#123;</span><br><span class="line">                    <span class="comment">// å°†å–æ¶ˆèŠ‚ç‚¹å‡ºæ ˆ</span></span><br><span class="line">                    clean(s);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œåˆ°è¿™è¯´æ˜ã€åŒ¹é…æˆåŠŸã€‘äº†</span></span><br><span class="line">                <span class="comment">// æ ˆé¡¶æœ‰èŠ‚ç‚¹å¹¶ä¸” åŒ¹é…èŠ‚ç‚¹è¿˜æœªå‡ºæ ˆï¼Œéœ€è¦ååŠ©å‡ºæ ˆ</span></span><br><span class="line">                <span class="keyword">if</span> ((h = head) != <span class="literal">null</span> &amp;&amp; h.next == s)</span><br><span class="line">                    casHead(h, s.next);</span><br><span class="line">                <span class="comment">// å½“å‰ node æ¨¡å¼ä¸º REQUEST ç±»å‹ï¼Œè¿”å›åŒ¹é…èŠ‚ç‚¹çš„ m.item æ•°æ®åŸŸ</span></span><br><span class="line">                <span class="comment">// å½“å‰ node æ¨¡å¼ä¸º DATA ç±»å‹ï¼šè¿”å› node.item æ•°æ®åŸŸï¼Œå½“å‰è¯·æ±‚æäº¤çš„æ•°æ® e</span></span><br><span class="line">                <span class="keyword">return</span> (E) ((mode == REQUEST) ? m.item : s.item);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼šé€»è¾‘åˆ°è¿™è¯´æ˜è¯·æ±‚æ¨¡å¼ä¸ä¸€è‡´ï¼Œå¦‚æœæ ˆé¡¶ä¸æ˜¯ FULFILLING è¯´æ˜æ²¡è¢«å…¶ä»–èŠ‚ç‚¹åŒ¹é…ï¼Œã€å½“å‰å¯ä»¥åŒ¹é…ã€‘</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isFulfilling(h.mode)) &#123;</span><br><span class="line">            <span class="comment">// å¤´èŠ‚ç‚¹æ˜¯å–æ¶ˆèŠ‚ç‚¹ï¼Œmatch æŒ‡å‘è‡ªå·±ï¼ŒååŠ©å‡ºæ ˆ</span></span><br><span class="line">            <span class="keyword">if</span> (h.isCancelled())</span><br><span class="line">                casHead(h, h.next);</span><br><span class="line">            <span class="comment">// å…¥æ ˆå½“å‰è¯·æ±‚çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (casHead(h, s=snode(s, e, h, FULFILLING|mode))) &#123;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="comment">// m æ˜¯ s çš„åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> s.next;</span><br><span class="line">                    <span class="comment">// m èŠ‚ç‚¹åœ¨ awaitFulfill æ–¹æ³•ä¸­è¢«ä¸­æ–­ï¼Œclean äº†è‡ªå·±</span></span><br><span class="line">                    <span class="keyword">if</span> (m == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ¸…ç©ºæ ˆ</span></span><br><span class="line">                        casHead(s, <span class="literal">null</span>);</span><br><span class="line">                        s = <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">// è¿”å›åˆ°å¤–å±‚è‡ªæ—‹ä¸­</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è·å–åŒ¹é…èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                    <span class="type">SNode</span> <span class="variable">mn</span> <span class="operator">=</span> m.next;</span><br><span class="line">                    <span class="comment">// å°è¯•åŒ¹é…ï¼Œã€åŒ¹é…æˆåŠŸã€‘ï¼Œåˆ™å°† fulfilling å’Œ m ä¸€èµ·å‡ºæ ˆï¼Œå¹¶ä¸”å”¤é†’è¢«åŒ¹é…çš„èŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">                    <span class="keyword">if</span> (m.tryMatch(s)) &#123;</span><br><span class="line">                        casHead(s, mn);</span><br><span class="line">                        <span class="keyword">return</span> (E) ((mode == REQUEST) ? m.item : s.item);</span><br><span class="line">                    &#125; <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">// åŒ¹é…å¤±è´¥ï¼Œå‡ºæ ˆ m</span></span><br><span class="line">                        s.casNext(m, mn);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šæ ˆé¡¶æ¨¡å¼ä¸º FULFILLING æ¨¡å¼ï¼Œè¡¨ç¤ºã€æ ˆé¡¶å’Œæ ˆé¡¶ä¸‹é¢çš„èŠ‚ç‚¹æ­£åœ¨å‘ç”ŸåŒ¹é…ã€‘ï¼Œå½“å‰è¯·æ±‚éœ€è¦åšååŠ©å·¥ä½œ</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// h è¡¨ç¤ºçš„æ˜¯ fulfilling èŠ‚ç‚¹ï¼Œm è¡¨ç¤º fulfilling åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> h.next;</span><br><span class="line">            <span class="keyword">if</span> (m == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// æ¸…ç©ºæ ˆ</span></span><br><span class="line">                casHead(h, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">SNode</span> <span class="variable">mn</span> <span class="operator">=</span> m.next;</span><br><span class="line">                <span class="comment">// m å’Œ h åŒ¹é…ï¼Œå”¤é†’ m ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (m.tryMatch(h))</span><br><span class="line">                    casHead(h, mn);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    h.casNext(m, mn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>awaitFulfill()ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¢«åŒ¹é…ï¼Œè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ï¼Œæˆ–è€…è¢«å–æ¶ˆçš„èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">SNode <span class="title function_">awaitFulfill</span><span class="params">(SNode s, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="comment">// ç­‰å¾…çš„æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">w</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰è¯·æ±‚çº¿ç¨‹åœ¨ä¸‹é¢çš„ for(;;) è‡ªæ—‹æ£€æŸ¥çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">spins</span> <span class="operator">=</span> (shouldSpin(s) ? (timed ? maxTimedSpins : maxUntimedSpins) : <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è‡ªæ—‹æ£€æŸ¥é€»è¾‘ï¼šæ˜¯å¦åŒ¹é…ã€æ˜¯å¦è¶…æ—¶ã€æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œéœ€è¦è®¾ç½® node çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (w.isInterrupted())</span><br><span class="line">            s.tryCancel();</span><br><span class="line">        <span class="comment">// è·å–ä¸å½“å‰ s åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> s.match;</span><br><span class="line">        <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// å¯èƒ½æ˜¯æ­£å¸¸çš„åŒ¹é…çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å–æ¶ˆçš„</span></span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œäº†è¶…æ—¶é™åˆ¶å°±åˆ¤æ–­æ˜¯å¦è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="comment">// ã€è¶…æ—¶äº†ï¼Œå–æ¶ˆèŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                s.tryCancel();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯´æ˜å½“å‰çº¿ç¨‹è¿˜å¯ä»¥è¿›è¡Œè‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (spins &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// è‡ªæ—‹ä¸€æ¬¡ é€’å‡ 1</span></span><br><span class="line">            spins = shouldSpin(s) ? (spins - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// è¯´æ˜æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.waiter == <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">//ã€æŠŠå½“å‰ node å¯¹åº”çš„ Thread ä¿å­˜åˆ° node.waiter å­—æ®µä¸­ï¼Œè¦é˜»å¡äº†ã€‘</span></span><br><span class="line">            s.waiter = w;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¶…æ—¶é™åˆ¶ç›´æ¥é˜»å¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!timed)</span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// nanos &gt; 1000 çº³ç§’çš„æƒ…å†µä¸‹ï¼Œæ‰å…è®¸æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; spinForTimeoutThreshold)</span><br><span class="line">            LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">shouldSpin</span><span class="params">(SNode s)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ ˆé¡¶</span></span><br><span class="line">    <span class="type">SNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰ s å°±æ˜¯æ ˆé¡¶ï¼Œå…è®¸è‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶äºŒæˆç«‹è¯´æ˜å½“å‰ s èŠ‚ç‚¹è‡ªæ—‹æ£€æŸ¥æœŸé—´ï¼Œåˆæ¥äº†ä¸€ä¸ªä¸å½“å‰ s èŠ‚ç‚¹åŒ¹é…çš„è¯·æ±‚ï¼ŒåŒåŒå‡ºæ ˆåæ¡ä»¶ä¼šæˆç«‹</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸‰æˆç«‹å‰æå½“å‰ s ä¸æ˜¯æ ˆé¡¶å…ƒç´ ï¼Œå¹¶ä¸”å½“å‰æ ˆé¡¶æ­£åœ¨åŒ¹é…ä¸­ï¼Œè¿™ç§çŠ¶æ€æ ˆé¡¶ä¸‹é¢çš„å…ƒç´ ï¼Œéƒ½å…è®¸è‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> (h == s || h == <span class="literal">null</span> || isFulfilling(h.mode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>clear()ï¼šæŒ‡å®šèŠ‚ç‚¹å‡ºæ ˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">clean</span><span class="params">(SNode s)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ•°æ®åŸŸå’Œå…³è”çº¿ç¨‹</span></span><br><span class="line">    s.item = <span class="literal">null</span>;</span><br><span class="line">    s.waiter = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è·å–å–æ¶ˆèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">SNode</span> <span class="variable">past</span> <span class="operator">=</span> s.next;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­åç»§èŠ‚ç‚¹æ˜¯ä¸æ˜¯å–æ¶ˆèŠ‚ç‚¹ï¼Œæ˜¯å°±æ›´æ–° past</span></span><br><span class="line">    <span class="keyword">if</span> (past != <span class="literal">null</span> &amp;&amp; past.isCancelled())</span><br><span class="line">        past = past.next;</span><br><span class="line"></span><br><span class="line">    SNode p;</span><br><span class="line">    <span class="comment">// ä»æ ˆé¡¶å¼€å§‹å‘ä¸‹æ£€æŸ¥ï¼Œã€å°†æ ˆé¡¶å¼€å§‹å‘ä¸‹çš„ å–æ¶ˆçŠ¶æ€ çš„èŠ‚ç‚¹å…¨éƒ¨æ¸…ç†å‡ºå»ã€‘ï¼Œç›´åˆ°ç¢°åˆ° past æˆ–è€…ä¸æ˜¯å–æ¶ˆçŠ¶æ€ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">while</span> ((p = head) != <span class="literal">null</span> &amp;&amp; p != past &amp;&amp; p.isCancelled())</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çš„æ˜¯å†…å­˜åœ°å€å¯¹åº”çš„å€¼ï¼Œp æŒ‡å‘è¯¥å†…å­˜åœ°å€æ‰€ä»¥æ•°æ®ä¸€ç›´åœ¨å˜åŒ–</span></span><br><span class="line">        casHead(p, p.next);</span><br><span class="line">	<span class="comment">// è¯´æ˜ä¸­é—´é‡åˆ°äº†ä¸æ˜¯å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œç»§ç»­è¿­ä»£ä¸‹å»</span></span><br><span class="line">    <span class="keyword">while</span> (p != <span class="literal">null</span> &amp;&amp; p != past) &#123;</span><br><span class="line">        <span class="type">SNode</span> <span class="variable">n</span> <span class="operator">=</span> p.next;</span><br><span class="line">        <span class="keyword">if</span> (n != <span class="literal">null</span> &amp;&amp; n.isCancelled())</span><br><span class="line">            p.casNext(n, n.next);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å…¬å¹³å®ç°">å…¬å¹³å®ç°</h5>
<p>TransferQueue æ˜¯å…¬å¹³çš„åŒæ­¥é˜Ÿåˆ—ï¼Œé‡‡ç”¨ FIFO çš„é˜Ÿåˆ—å®ç°ï¼Œè¯·æ±‚èŠ‚ç‚¹ä¸é˜Ÿå°¾æ¨¡å¼ä¸åŒï¼Œéœ€è¦ä¸é˜Ÿå¤´å‘ç”ŸåŒ¹é…</p>
<p>TransferQueue ç±»æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li>
<p>æŒ‡å‘é˜Ÿåˆ—çš„ dummy èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> QNode head;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æŒ‡å‘é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> QNode tail;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¢«æ¸…ç†èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> QNode cleanMe;</span><br></pre></td></tr></table></figure>
<p>å…¥é˜Ÿæ“ä½œæ˜¯ä¸¤æ­¥å®Œæˆçš„ï¼Œç¬¬ä¸€æ­¥æ˜¯ t.next = newNodeï¼Œç¬¬äºŒæ­¥æ˜¯ tail = newNodeï¼Œæ‰€ä»¥é˜Ÿå°¾èŠ‚ç‚¹å‡ºé˜Ÿï¼Œæ˜¯ä¸€ç§éå¸¸ç‰¹æ®Šçš„æƒ…å†µ</p>
</li>
</ul>
<p>TransferQueue å†…éƒ¨ç±»ï¼š</p>
<ul>
<li>
<p>QNodeï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">QNode</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> QNode next;</span><br><span class="line">    <span class="comment">// æ•°æ®åŸŸï¼ŒNode ä»£è¡¨çš„æ˜¯ DATA ç±»å‹ item è¡¨ç¤ºæ•°æ®ï¼Œå¦åˆ™ Node ä»£è¡¨çš„ REQUEST ç±»å‹ï¼Œitem == null</span></span><br><span class="line">    <span class="keyword">volatile</span> Object item;</span><br><span class="line">    <span class="comment">// å‡è®¾å½“å‰ node å¯¹åº”çš„çº¿ç¨‹è‡ªæ—‹æœŸé—´æœªè¢«åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆ node å¯¹åº”çš„çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œ</span></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å‰ waiter ä¿å­˜å¯¹åº”çš„çº¿ç¨‹å¼•ç”¨ï¼Œæ–¹ä¾¿åŒ¹é…æˆåŠŸåè¢«å”¤é†’ã€‚</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">    <span class="comment">// true å½“å‰ Node æ˜¯ä¸€ä¸ª DATA ç±»å‹ï¼Œfalse è¡¨ç¤ºå½“å‰ Node æ˜¯ä¸€ä¸ª REQUEST ç±»å‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> isData;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ„å»ºæ–¹æ³•</span></span><br><span class="line">    QNode(Object item, <span class="type">boolean</span> isData) &#123;</span><br><span class="line">        <span class="built_in">this</span>.item = item;</span><br><span class="line">        <span class="built_in">this</span>.isData = isData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•å–æ¶ˆå½“å‰ nodeï¼Œå–æ¶ˆçŠ¶æ€çš„ node çš„ item åŸŸæŒ‡å‘è‡ªå·±</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tryCancel</span><span class="params">(Object cmp)</span> &#123;</span><br><span class="line">        UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, itemOffset, cmp, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰ node æ˜¯å¦ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> item == <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ â€œä¸åœ¨â€ é˜Ÿåˆ—å†…ï¼Œå½“ next æŒ‡å‘è‡ªå·±æ—¶ï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isOffList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> next == <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>TransferQueue ç±»æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>è®¾ç½®å¤´å°¾èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">advanceHead</span><span class="params">(QNode h, QNode nh)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®å¤´æŒ‡é’ˆæŒ‡å‘æ–°çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">    <span class="keyword">if</span> (h == head &amp;&amp; UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, headOffset, h, nh))</span><br><span class="line">        <span class="comment">// è€çš„å¤´èŠ‚ç‚¹å‡ºé˜Ÿ</span></span><br><span class="line">        h.next = h;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">advanceTail</span><span class="params">(QNode t, QNode nt)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tail == t)</span><br><span class="line">        <span class="comment">// æ›´æ–°é˜Ÿå°¾èŠ‚ç‚¹ä¸ºæ–°çš„é˜Ÿå°¾</span></span><br><span class="line">        UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, tailOffset, t, nt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>transfer()ï¼šæ ¸å¿ƒæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="comment">// s æŒ‡å‘å½“å‰è¯·æ±‚å¯¹åº”çš„ node</span></span><br><span class="line">    <span class="type">QNode</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯ DATA ç±»å‹çš„è¯·æ±‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isData</span> <span class="operator">=</span> (e != <span class="literal">null</span>);</span><br><span class="line">	<span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">QNode</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="type">QNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span> || h == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">		<span class="comment">// head å’Œ tail åŒæ—¶æŒ‡å‘ dummy èŠ‚ç‚¹ï¼Œè¯´æ˜æ˜¯ç©ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// é˜Ÿå°¾èŠ‚ç‚¹ä¸å½“å‰è¯·æ±‚ç±»å‹æ˜¯ä¸€è‡´çš„æƒ…å†µï¼Œè¯´æ˜é˜»å¡é˜Ÿåˆ—ä¸­éƒ½æ— æ³•åŒ¹é…ï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (h == t || t.isData == isData) &#123;</span><br><span class="line">            <span class="comment">// è·å–é˜Ÿå°¾ t çš„ next èŠ‚ç‚¹</span></span><br><span class="line">            <span class="type">QNode</span> <span class="variable">tn</span> <span class="operator">=</span> t.next;</span><br><span class="line">            <span class="comment">// å¤šçº¿ç¨‹ç¯å¢ƒä¸­å…¶ä»–çº¿ç¨‹å¯èƒ½ä¿®æ”¹å°¾èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (t != tail)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// å·²ç»æœ‰çº¿ç¨‹å…¥é˜Ÿäº†ï¼Œæ›´æ–° tail</span></span><br><span class="line">            <span class="keyword">if</span> (tn != <span class="literal">null</span>) &#123;</span><br><span class="line">                advanceTail(t, tn);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…è®¸è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´å°äº 0ï¼Œè¿™ç§æ–¹æ³•ä¸æ”¯æŒé˜»å¡ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// åˆ›å»º node çš„é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">                s = <span class="keyword">new</span> <span class="title class_">QNode</span>(e, isData);</span><br><span class="line">            <span class="comment">// å°† node æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">            <span class="keyword">if</span> (!t.casNext(<span class="literal">null</span>, s))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">// æ›´æ–°é˜Ÿå°¾æŒ‡é’ˆ</span></span><br><span class="line">            advanceTail(t, s);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹ ç­‰å¾…åŒ¹é…....</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> awaitFulfill(s, e, timed, nanos);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯´æ˜ã€å½“å‰ node çŠ¶æ€ä¸º å–æ¶ˆçŠ¶æ€ã€‘ï¼Œéœ€è¦åšå‡ºé˜Ÿé€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (x == s) &#123;</span><br><span class="line">                clean(t, s);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// è¯´æ˜å½“å‰ node ä»ç„¶åœ¨é˜Ÿåˆ—å†…ï¼ŒåŒ¹é…æˆåŠŸï¼Œéœ€è¦åšå‡ºé˜Ÿé€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (!s.isOffList()) &#123;</span><br><span class="line">                <span class="comment">// t æ˜¯å½“å‰ s èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œåˆ¤æ–­ t æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæ˜¯å°±æ›´æ–° dummy èŠ‚ç‚¹ä¸º s èŠ‚ç‚¹</span></span><br><span class="line">                advanceHead(t, s);</span><br><span class="line">                <span class="comment">// s èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿï¼Œæ‰€ä»¥éœ€è¦æŠŠå®ƒçš„ item åŸŸè®¾ç½®ä¸ºå®ƒè‡ªå·±ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸ªå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (x != <span class="literal">null</span>)</span><br><span class="line">                    s.item = s;</span><br><span class="line">                s.waiter = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (x != <span class="literal">null</span>) ? (E)x : e;</span><br><span class="line">		<span class="comment">// é˜Ÿå°¾èŠ‚ç‚¹ä¸å½“å‰è¯·æ±‚èŠ‚ç‚¹ã€äº’è¡¥åŒ¹é…ã€‘</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// h.next èŠ‚ç‚¹ï¼Œã€è¯·æ±‚èŠ‚ç‚¹ä¸é˜Ÿå°¾æ¨¡å¼ä¸åŒï¼Œéœ€è¦ä¸é˜Ÿå¤´å‘ç”ŸåŒ¹é…ã€‘ï¼ŒTransferQueue æ˜¯ä¸€ä¸ªã€å…¬å¹³æ¨¡å¼ã€‘</span></span><br><span class="line">            <span class="type">QNode</span> <span class="variable">m</span> <span class="operator">=</span> h.next;</span><br><span class="line">            <span class="comment">// å¹¶å‘å¯¼è‡´å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†é˜Ÿå°¾èŠ‚ç‚¹ï¼Œæˆ–è€…å·²ç»æŠŠ head.next åŒ¹é…èµ°äº†</span></span><br><span class="line">            <span class="keyword">if</span> (t != tail || m == <span class="literal">null</span> || h != head)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">// è·å–åŒ¹é…èŠ‚ç‚¹çš„æ•°æ®åŸŸä¿å­˜åˆ° x</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> m.item;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦åŒ¹é…æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (isData == (x != <span class="literal">null</span>) ||</span><br><span class="line">                x == m ||</span><br><span class="line">                !m.casItem(x, e)) &#123;</span><br><span class="line">                advanceHead(h, m);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// ã€åŒ¹é…å®Œæˆã€‘ï¼Œå°†å¤´èŠ‚ç‚¹å‡ºé˜Ÿï¼Œè®©è¿™ä¸ªæ–°çš„å¤´ç»“ç‚¹æˆä¸º dummy èŠ‚ç‚¹</span></span><br><span class="line">            advanceHead(h, m);</span><br><span class="line">            <span class="comment">// å”¤é†’è¯¥åŒ¹é…èŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">            LockSupport.unpark(m.waiter);</span><br><span class="line">            <span class="keyword">return</span> (x != <span class="literal">null</span>) ? (E)x : e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>awaitFulfill()ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¢«åŒ¹é…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">awaitFulfill</span><span class="params">(QNode s, E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºç­‰å¾…æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">w</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è‡ªé€‰æ£€æŸ¥çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">spins</span> <span class="operator">=</span> ((head.next == s) ? (timed ? maxTimedSpins : maxUntimedSpins) : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è¢«æ‰“æ–­å°±å–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (w.isInterrupted())</span><br><span class="line">            s.tryCancel(e);</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ Node æ•°æ®åŸŸ</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> s.item;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰è¯·æ±‚ä¸º DATA æ¨¡å¼æ—¶ï¼še è¯·æ±‚å¸¦æ¥çš„æ•°æ®</span></span><br><span class="line">        <span class="comment">// s.item ä¿®æ”¹ä¸º thisï¼Œè¯´æ˜å½“å‰ QNode å¯¹åº”çš„çº¿ç¨‹ å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// s.item ä¿®æ”¹ä¸º null è¡¨ç¤ºå·²ç»æœ‰åŒ¹é…èŠ‚ç‚¹äº†ï¼Œå¹¶ä¸”åŒ¹é…èŠ‚ç‚¹æ‹¿èµ°äº† item æ•°æ®</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰è¯·æ±‚ä¸º REQUEST æ¨¡å¼æ—¶ï¼še == null</span></span><br><span class="line">        <span class="comment">// s.item ä¿®æ”¹ä¸º thisï¼Œè¯´æ˜å½“å‰ QNode å¯¹åº”çš„çº¿ç¨‹ å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// s.item != null ä¸” item != this  è¡¨ç¤ºå½“å‰ REQUEST ç±»å‹çš„ Node å·²ç»åŒ¹é…åˆ° DATA äº†</span></span><br><span class="line">        <span class="keyword">if</span> (x != e)</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        <span class="comment">// è¶…æ—¶æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                s.tryCancel(e);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹æ¬¡æ•°å‡ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> (spins &gt; <span class="number">0</span>)</span><br><span class="line">            --spins;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†ï¼ŒæŠŠå½“å‰çº¿ç¨‹å°è£…è¿›å» waiter</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.waiter == <span class="literal">null</span>)</span><br><span class="line">            s.waiter = w;</span><br><span class="line">        <span class="comment">// é˜»å¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!timed)</span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; spinForTimeoutThreshold)</span><br><span class="line">            LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="æ“ä½œ-Pool">æ“ä½œ Pool</h3>
<h4 id="åˆ›å»ºæ–¹å¼">åˆ›å»ºæ–¹å¼</h4>
<h5 id="Executor">Executor</h5>
<p>å­˜æ”¾çº¿ç¨‹çš„å®¹å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br></pre></td></tr></table></figure>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>
<p>å‚æ•°ä»‹ç»ï¼š</p>
<ul>
<li>
<p>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡</p>
</li>
<li>
<p>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œå½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºçº¿ç¨‹å¹¶ç«‹å³æ‰§è¡Œæœ€æ–°çš„ä»»åŠ¡ï¼Œä¸æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹é—´çš„å·®å€¼åˆå«æ•‘æ€¥çº¿ç¨‹æ•°</p>
</li>
<li>
<p>keepAliveTimeï¼šæ•‘æ€¥çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº <code>corePoolSize</code> çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰åˆ° <code>keepAliveTime</code> æ—¶é—´è¶…è¿‡é”€æ¯</p>
</li>
<li>
<p>unitï¼š<code>keepAliveTime</code> å‚æ•°çš„æ—¶é—´å•ä½</p>
</li>
<li>
<p>workQueueï¼šé˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾è¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡</p>
</li>
<li>
<p>threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ—¶ç”¨åˆ°ï¼Œå¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·åå­—</p>
</li>
<li>
<p>handlerï¼šæ‹’ç»ç­–ç•¥ï¼Œçº¿ç¨‹åˆ°è¾¾æœ€å¤§çº¿ç¨‹æ•°ä»æœ‰æ–°ä»»åŠ¡æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥</p>
<p>RejectedExecutionHandler ä¸‹æœ‰ 4 ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li>AbortPolicyï¼šè®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œ<strong>é»˜è®¤ç­–ç•¥</strong></li>
<li>CallerRunsPolicyï¼šè®©è°ƒç”¨è€…è¿è¡Œçš„è°ƒèŠ‚æœºåˆ¶ï¼Œå°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…ï¼Œä»è€Œé™ä½æ–°ä»»åŠ¡çš„æµé‡</li>
<li>DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸</li>
<li>DiscardOldestPolicyï¼šæ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼ŒæŠŠå½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡</li>
</ul>
<p>è¡¥å……ï¼šå…¶ä»–æ¡†æ¶æ‹’ç»ç­–ç•¥</p>
<ul>
<li>Dubboï¼šåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸å‰è®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li>
<li>Nettyï¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li>
<li>ActiveMQï¼šå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—</li>
<li>PinPointï¼šå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li>
</ul>
</li>
</ul>
<p>å·¥ä½œåŸç†ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png" alt=""></p>
<ol>
<li>
<p>åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™æ—¶æ²¡æœ‰åˆ›å»ºçº¿ç¨‹ï¼ˆ<strong>æ‡’æƒ°</strong>ï¼‰ï¼Œç­‰å¾…æäº¤è¿‡æ¥çš„ä»»åŠ¡è¯·æ±‚ï¼Œè°ƒç”¨ execute æ–¹æ³•æ‰ä¼šåˆ›å»ºçº¿ç¨‹</p>
</li>
<li>
<p>å½“è°ƒç”¨ execute() æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<ul>
<li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡</li>
<li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº corePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—</li>
<li>å¦‚æœè¿™æ—¶é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äº maximumPoolSizeï¼Œé‚£ä¹ˆä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹<strong>ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡</strong>ï¼Œå¯¹äºé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸å…¬å¹³ã€‚è¿™æ˜¯å› ä¸ºåˆ›å»ºæ¯ä¸ª Workerï¼ˆçº¿ç¨‹ï¼‰å¯¹è±¡ä¼šç»‘å®šä¸€ä¸ªåˆå§‹ä»»åŠ¡ï¼Œå¯åŠ¨ Worker æ—¶ä¼šä¼˜å…ˆæ‰§è¡Œ</li>
<li>å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº maximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œ<strong>æ‹’ç»ç­–ç•¥</strong>æ¥æ‰§è¡Œ</li>
</ul>
</li>
<li>
<p>å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ</p>
</li>
<li>
<p>å½“ä¸€ä¸ªçº¿ç¨‹ç©ºé—²è¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼šå¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äº corePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ï¼Œæ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåæœ€ç»ˆä¼šæ”¶ç¼©åˆ° corePoolSize å¤§å°</p>
</li>
</ol>
<p>å›¾ç‰‡æ¥æºï¼š<a target="_blank" rel="noopener" href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p>
<hr>
<h5 id="Executors">Executors</h5>
<p>Executors æä¾›äº†å››ç§çº¿ç¨‹æ± çš„åˆ›å»ºï¼šnewCachedThreadPoolã€newFixedThreadPoolã€newSingleThreadExecutorã€newScheduledThreadPool</p>
<ul>
<li>
<p>newFixedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ n ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•° == æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´</li>
<li>LinkedBlockingQueue æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º <code>Integer.MAX_VALUE</code>ï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™ä¼šå¯¼è‡´ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰</li>
<li>é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„é•¿æœŸä»»åŠ¡</li>
</ul>
</li>
<li>
<p>newCachedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªå¯æ‰©å®¹çš„çº¿ç¨‹æ± </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ 29 ä¸ª 1ï¼Œå…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ <strong>OOM</strong></p>
</li>
<li>
<p>SynchronousQueue ä½œä¸ºé˜»å¡é˜Ÿåˆ—ï¼Œæ²¡æœ‰å®¹é‡ï¼Œå¯¹äºæ¯ä¸€ä¸ª take çš„çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ°æœ‰ä¸€ä¸ª put çš„çº¿ç¨‹æ”¾å…¥å…ƒç´ ä¸ºæ­¢ï¼ˆç±»ä¼¼ä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</p>
</li>
<li>
<p>é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p>
</li>
</ul>
</li>
<li>
<p>newSingleThreadExecutorï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ 1 ä¸ªçº¿ç¨‹çš„å•çº¿ç¨‹æ± </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,<span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§<strong>æŒ‡å®šé¡ºåºæ‰§è¡Œ</strong>ï¼Œçº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾</li>
</ul>
</li>
</ul>
<p>å¯¹æ¯”ï¼š</p>
<ul>
<li>
<p>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œçº¿ç¨‹æ± ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</p>
</li>
<li>
<p>Executors.newSingleThreadExecutor() çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º 1ï¼Œä¸èƒ½ä¿®æ”¹ã€‚FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•</p>
<p>åŸå› ï¼šçˆ¶ç±»ä¸èƒ½ç›´æ¥è°ƒç”¨å­ç±»ä¸­çš„æ–¹æ³•ï¼Œéœ€è¦åå°„æˆ–è€…åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨å­ç±»é™æ€æ–¹æ³•</p>
</li>
<li>
<p>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º 1ï¼Œå¯ä»¥ä¿®æ”¹ã€‚å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-newSingleThreadExecutor.png" alt=""></p>
<hr>
<h5 id="å¼€å‘è¦æ±‚">å¼€å‘è¦æ±‚</h5>
<p>é˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œè¦æ±‚ï¼š</p>
<ul>
<li>
<p><strong>çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹</strong></p>
<ul>
<li>ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜</li>
<li>å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…è¿‡åº¦åˆ‡æ¢çš„é—®é¢˜</li>
</ul>
</li>
<li>
<p>çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©</p>
<p>Executors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡å¼Šç«¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>FixedThreadPool å’Œ SingleThreadPoolï¼šè¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOM</li>
<li>CacheThreadPool å’Œ ScheduledThreadPoolï¼šå…è®¸åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå¯¼è‡´ OOM</li>
</ul>
</li>
</ul>
<p>åˆ›å»ºå¤šå¤§å®¹é‡çš„çº¿ç¨‹æ± åˆé€‚ï¼Ÿ</p>
<ul>
<li>
<p>ä¸€èˆ¬æ¥è¯´æ± ä¸­<strong>æ€»çº¿ç¨‹æ•°æ˜¯æ ¸å¿ƒæ± çº¿ç¨‹æ•°é‡ä¸¤å€</strong>ï¼Œç¡®ä¿å½“æ ¸å¿ƒæ± æœ‰çº¿ç¨‹åœæ­¢æ—¶ï¼Œæ ¸å¿ƒæ± å¤–æœ‰çº¿ç¨‹è¿›å…¥æ ¸å¿ƒæ± </p>
</li>
<li>
<p>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</p>
</li>
<li>
<p>è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</p>
<p>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ï¼Œä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
</li>
</ul>
<p>æ ¸å¿ƒçº¿ç¨‹æ•°å¸¸ç”¨å…¬å¼ï¼š</p>
<ul>
<li>
<p><strong>CPU å¯†é›†å‹ä»»åŠ¡ (N+1)ï¼š</strong> è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º N (CPU æ ¸å¿ƒæ•°) + 1ï¼Œæ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU æŸä¸ªæ ¸å¿ƒå°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´</p>
<p>CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œåˆ†æ</p>
</li>
<li>
<p><strong>I/O å¯†é›†å‹ä»»åŠ¡ï¼š</strong> è¿™ç§ç³»ç»Ÿ CPU å¤„äºé˜»å¡çŠ¶æ€ï¼Œç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ï¼Œå› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2N æˆ– CPU æ ¸æ•°/ (1-é˜»å¡ç³»æ•°)ï¼Œé˜»å¡ç³»æ•°åœ¨ 0.8~0.9 ä¹‹é—´</p>
<p>IO å¯†é›†å‹å°±æ˜¯æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–æ­¤ç±»ä»»åŠ¡ ï¼Œç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Š</p>
</li>
</ul>
<hr>
<h4 id="æäº¤æ–¹æ³•">æäº¤æ–¹æ³•</h4>
<p>ExecutorService ç±» APIï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>void execute(Runnable command)</td>
<td>æ‰§è¡Œä»»åŠ¡ï¼ˆExecutor ç±» APIï¼‰</td>
</tr>
<tr>
<td>Future&lt;?&gt; submit(Runnable task)</td>
<td>æäº¤ä»»åŠ¡ task()</td>
</tr>
<tr>
<td>Future submit(Callable<T> task)</td>
<td>æäº¤ä»»åŠ¡ taskï¼Œç”¨è¿”å›å€¼ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</td>
</tr>
<tr>
<td>List&lt;Future<T>&gt; invokeAll(Collection&lt;? extends Callable<T>&gt; tasks)</td>
<td>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡</td>
</tr>
<tr>
<td>List&lt;Future<T>&gt; invokeAll(Collection&lt;? extends Callable<T>&gt; tasks, long timeout, TimeUnit unit)</td>
<td>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œè¶…æ—¶æ—¶é—´é’ˆå¯¹æ‰€æœ‰ taskï¼Œè¶…æ—¶ä¼šå–æ¶ˆæ²¡æœ‰æ‰§è¡Œå®Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å‡ºè¶…æ—¶å¼‚å¸¸</td>
</tr>
<tr>
<td>T invokeAny(Collection&lt;? extends Callable<T>&gt; tasks)</td>
<td>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ</td>
</tr>
</tbody>
</table>
<p>execute å’Œ submit éƒ½å±äºçº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œå¯¹æ¯”ï¼š</p>
<ul>
<li>
<p>execute åªèƒ½æ‰§è¡Œ Runnable ç±»å‹çš„ä»»åŠ¡ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼› submit æ—¢èƒ½æäº¤ Runnable ç±»å‹ä»»åŠ¡ä¹Ÿèƒ½æäº¤ Callable ç±»å‹ä»»åŠ¡ï¼Œåº•å±‚æ˜¯<strong>å°è£…æˆ FutureTaskï¼Œç„¶åè°ƒç”¨ execute æ‰§è¡Œ</strong></p>
</li>
<li>
<p>execute ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ï¼Œsubmit ä¼šåæ‰å¼‚å¸¸ï¼Œå¯é€šè¿‡ Future çš„ get æ–¹æ³•å°†ä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸é‡æ–°æŠ›å‡º</p>
</li>
</ul>
<hr>
<h4 id="å…³é—­æ–¹æ³•">å…³é—­æ–¹æ³•</h4>
<p>ExecutorService ç±» APIï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>void shutdown()</td>
<td>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWNï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œåå…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œï¼Œè€Œä¸”ä¹Ÿå¯ä»¥æ·»åŠ çº¿ç¨‹ï¼ˆä¸ç»‘å®šä»»åŠ¡ï¼‰</td>
</tr>
<tr>
<td>List<Runnable> shutdownNow()</td>
<td>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOPï¼Œç”¨ interrupt ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç›´æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å›</td>
</tr>
<tr>
<td>boolean isShutdown()</td>
<td>ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ‰§è¡Œè€…å·²è¢«å…³é—­ï¼Œæ–¹æ³•è¿”å› true</td>
</tr>
<tr>
<td>boolean isTerminated()</td>
<td>çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATEDï¼Œå¦‚æœæ‰€æœ‰ä»»åŠ¡åœ¨å…³é—­åå®Œæˆï¼Œè¿”å› true</td>
</tr>
<tr>
<td>boolean awaitTermination(long timeout, TimeUnit unit)</td>
<td>è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="å¤„ç†å¼‚å¸¸">å¤„ç†å¼‚å¸¸</h4>
<p>execute ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ï¼Œsubmit ä¼šåæ‰å¼‚å¸¸ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•</p>
<p>æ–¹æ³• 1ï¼šä¸»åŠ¨æ‰å¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³• 2ï¼šä½¿ç”¨ Future å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">Future&lt;?&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(future.get());</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h3>
<h4 id="çŠ¶æ€ä¿¡æ¯">çŠ¶æ€ä¿¡æ¯</h4>
<p>ThreadPoolExecutor ä½¿ç”¨ int çš„<strong>é«˜ 3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ 29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡</strong>ã€‚è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctl ä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ CAS åŸå­æ“ä½œè¿›è¡Œèµ‹å€¼</p>
<ul>
<li>
<p>çŠ¶æ€è¡¨ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é«˜3ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œé™¤å»é«˜3ä½ä¹‹åçš„ä½ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­æ‰€æ‹¥æœ‰çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// è¡¨ç¤ºåœ¨ ctl ä¸­ï¼Œä½ COUNT_BITS ä½ï¼Œæ˜¯ç”¨äºå­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡çš„ä½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="comment">// ä½ COUNT_BITS ä½æ‰€èƒ½è¡¨è¾¾çš„æœ€å¤§æ•°å€¼ï¼Œ000 11111111111111111111 =&gt; 5äº¿å¤š</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span>   <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png" alt=""></p>
</li>
<li>
<p>å››ç§çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 111 000000000000000000ï¼Œè½¬æ¢æˆæ•´æ•°åå…¶å®å°±æ˜¯ä¸€ä¸ªã€è´Ÿæ•°ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 000 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 001 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 010 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 011 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>çŠ¶æ€</th>
<th>é«˜ 3 ä½</th>
<th>æ¥æ”¶æ–°ä»»åŠ¡</th>
<th>å¤„ç†é˜»å¡ä»»åŠ¡é˜Ÿåˆ—</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>RUNNING</td>
<td>111</td>
<td>Y</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>SHUTDOWN</td>
<td>000</td>
<td>N</td>
<td>Y</td>
<td>ä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ä»»åŠ¡</td>
</tr>
<tr>
<td>STOP</td>
<td>001</td>
<td>N</td>
<td>N</td>
<td>ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ—ä»»åŠ¡</td>
</tr>
<tr>
<td>TIDYING</td>
<td>010</td>
<td>-</td>
<td>-</td>
<td>ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0 å³å°†è¿›å…¥ç»ˆç»“</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>011</td>
<td>-</td>
<td>-</td>
<td>ç»ˆæ­¢çŠ¶æ€</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ~CAPACITY = ~000 11111111111111111111 = 111 000000000000000000000ï¼ˆå–åï¼‰</span></span><br><span class="line"><span class="comment">// c == ctl = 111 000000000000000000111</span></span><br><span class="line"><span class="comment">// 111 000000000000000000111</span></span><br><span class="line"><span class="comment">// 111 000000000000000000000</span></span><br><span class="line"><span class="comment">// 111 000000000000000000000	è·å–åˆ°äº†è¿è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–å½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        c = 111 000000000000000000111</span></span><br><span class="line"><span class="comment">// CAPACITY = 000 111111111111111111111</span></span><br><span class="line"><span class="comment">//            000 000000000000000000111 =&gt; 7</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡ç½®å½“å‰çº¿ç¨‹æ± çŠ¶æ€ ctlï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rs è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œwc è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­ workerï¼ˆçº¿ç¨‹ï¼‰æ•°é‡ï¼Œç›¸ä¸ä»¥åå°±æ˜¯åˆå¹¶åçš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼Œæ˜¯å¦å°äºæŸä¸ªçŠ¶æ€ s</span></span><br><span class="line"><span class="comment">// çŠ¶æ€å¯¹æ¯”ï¼šRUNNING &lt; SHUTDOWN &lt; STOP &lt; TIDYING &lt; TERMINATED</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateLessThan</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123; <span class="keyword">return</span> c &lt; s; &#125;</span><br><span class="line"><span class="comment">// æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼Œæ˜¯å¦å¤§äºç­‰äºæŸä¸ªçŠ¶æ€s</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateAtLeast</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123; <span class="keyword">return</span> c &gt;= s; &#125;</span><br><span class="line"><span class="comment">// å°äº SHUTDOWN çš„ä¸€å®šæ˜¯ RUNNINGï¼ŒSHUTDOWN == 0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">(<span class="type">int</span> c)</span> &#123; <span class="keyword">return</span> c &lt; SHUTDOWN; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¾ç½®çº¿ç¨‹æ±  ctlï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ CAS æ–¹å¼ è®© ctl å€¼ +1 ï¼ŒæˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndIncrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ CAS æ–¹å¼ è®© ctl å€¼ -1 ï¼ŒæˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndDecrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°† ctl å€¼å‡ä¸€ï¼Œdo while å¾ªç¯ä¼šä¸€ç›´é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">decrementWorkerCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (!compareAndDecrementWorkerCount(ctl.get()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æˆå‘˜å±æ€§-3">æˆå‘˜å±æ€§</h4>
<p>æˆå‘˜å˜é‡</p>
<ul>
<li>
<p><strong>çº¿ç¨‹æ± ä¸­å­˜æ”¾ Worker çš„å®¹å™¨</strong>ï¼šçº¿ç¨‹æ± æ²¡æœ‰åˆå§‹åŒ–ï¼Œç›´æ¥å¾€æ± ä¸­åŠ çº¿ç¨‹å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çº¿ç¨‹å…¨å±€é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¢åŠ å‡å°‘ worker æˆ–è€…æ—¶ä¿®æ”¹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€éœ€è¦æŒæœ‰ mainLock</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¯é‡å…¥é”çš„æ¡ä»¶å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ awaitTermination() æ–¹æ³•æ—¶ï¼Œä¼šç­‰å¾…å½“å‰çº¿ç¨‹æ± çŠ¶æ€ä¸º Termination ä¸ºæ­¢</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition()</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çº¿ç¨‹æ± ç›¸å…³å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> corePoolSize;				<span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> maximumPoolSize;			<span class="comment">// çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> keepAliveTime;			<span class="comment">// ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;	<span class="comment">// åˆ›å»ºçº¿ç¨‹æ—¶ä½¿ç”¨çš„çº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤æ˜¯ DefaultThreadFactory</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;<span class="comment">// ã€è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æäº¤ä»»åŠ¡å°±æ”¾å…¥ é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;	<span class="comment">// æ‹’ç»ç­–ç•¥ï¼ŒjucåŒ…æä¾›äº†4ä¸­æ–¹å¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RejectedExecutionHandler</span> <span class="variable">defaultHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AbortPolicy</span>();<span class="comment">// é»˜è®¤ç­–ç•¥</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®°å½•çº¿ç¨‹æ± ç›¸å…³å±æ€§çš„æ•°å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> largestPoolSize;		<span class="comment">// è®°å½•çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸå†…çº¿ç¨‹æ•°æœ€å¤§å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> completedTaskCount;	<span class="comment">// è®°å½•çº¿ç¨‹æ± æ‰€å®Œæˆä»»åŠ¡æ€»æ•°ï¼Œå½“æŸä¸ª worker é€€å‡ºæ—¶å°†å®Œæˆçš„ä»»åŠ¡ç´¯åŠ åˆ°è¯¥å±æ€§</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ§åˆ¶<strong>æ ¸å¿ƒçº¿ç¨‹æ•°é‡å†…çš„çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«å›æ”¶</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// falseï¼ˆé»˜è®¤ï¼‰ä»£è¡¨ä¸å¯ä»¥ï¼Œä¸º true æ—¶æ ¸å¿ƒçº¿ç¨‹ç©ºé—²è¶…è¿‡ keepAliveTime ä¹Ÿä¼šè¢«å›æ”¶</span></span><br><span class="line"><span class="comment">// allowCoreThreadTimeOut(boolean value) æ–¹æ³•å¯ä»¥è®¾ç½®è¯¥å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> allowCoreThreadTimeOut;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å†…éƒ¨ç±»ï¼š</p>
<ul>
<li>
<p>Worker ç±»ï¼š<strong>æ¯ä¸ª Worker å¯¹è±¡ä¼šç»‘å®šä¸€ä¸ªåˆå§‹ä»»åŠ¡</strong>ï¼Œå¯åŠ¨ Worker æ—¶ä¼˜å…ˆæ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯é€ æˆçº¿ç¨‹æ± ä¸å…¬å¹³çš„åŸå› ã€‚Worker ç»§æ‰¿è‡ª AQSï¼Œæœ¬èº«å…·æœ‰é”çš„ç‰¹æ€§ï¼Œé‡‡ç”¨ç‹¬å é”æ¨¡å¼ï¼Œstate = 0 è¡¨ç¤ºæœªè¢«å ç”¨ï¼Œ&gt; 0 è¡¨ç¤ºè¢«å ç”¨ï¼Œ&lt; 0 è¡¨ç¤ºåˆå§‹çŠ¶æ€ä¸èƒ½è¢«æŠ¢é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> Thread thread;			<span class="comment">// worker å†…éƒ¨å°è£…çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">    Runnable firstTask;				<span class="comment">// worker ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ™®é€šçš„ Runnable å®ç°ç±»æˆ–è€…æ˜¯ FutureTask</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;	<span class="comment">// è®°å½•å½“å‰ worker æ‰€å®Œæˆä»»åŠ¡æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®AQSç‹¬å æ¨¡å¼ä¸ºåˆå§‹åŒ–ä¸­çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸èƒ½è¢«æŠ¢å é”</span></span><br><span class="line">       	setState(-<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// firstTaskä¸ä¸ºç©ºæ—¶ï¼Œå½“workerå¯åŠ¨åï¼Œå†…éƒ¨çº¿ç¨‹ä¼šä¼˜å…ˆæ‰§è¡ŒfirstTaskï¼Œæ‰§è¡Œå®Œåä¼šåˆ°queueä¸­å»è·å–ä¸‹ä¸ªä»»åŠ¡</span></span><br><span class="line">        <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨çº¿ç¨‹å·¥å‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”ã€å°†å½“å‰workeræŒ‡å®šä¸ºRunnableã€‘ï¼Œæ‰€ä»¥threadå¯åŠ¨æ—¶ä¼šè°ƒç”¨ worker.run()</span></span><br><span class="line">        <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€ä¸å¯é‡å…¥é”ã€‘</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰ worker æŒ‡å®šä¸º thread çš„æ‰§è¡Œæ–¹æ³•ï¼Œçº¿ç¨‹è°ƒç”¨ start ä¼šè°ƒç”¨ r.run()</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(group, r, namePrefix + threadNumber.getAndIncrement(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">        t.setDaemon(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</span><br><span class="line">        t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‹’ç»ç­–ç•¥ç›¸å…³çš„å†…éƒ¨ç±»</p>
</li>
</ul>
<hr>
<h4 id="æˆå‘˜æ–¹æ³•-3">æˆå‘˜æ–¹æ³•</h4>
<h5 id="æäº¤æ–¹æ³•-2">æäº¤æ–¹æ³•</h5>
<ul>
<li>
<p>AbstractExecutorService#submit()ï¼šæäº¤ä»»åŠ¡ï¼Œ<strong>æŠŠ Runnable æˆ– Callable ä»»åŠ¡å°è£…æˆ FutureTask æ‰§è¡Œ</strong>ï¼Œå¯ä»¥é€šè¿‡æ–¹æ³•è¿”å›çš„ä»»åŠ¡å¯¹è±¡ï¼Œè°ƒç”¨ get é˜»å¡è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœæˆ–è€…å¼‚å¸¸ï¼Œæºç åˆ†æåœ¨ç¬”è®°çš„ Future éƒ¨åˆ†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">    <span class="comment">// ç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æŠŠ Runnable å°è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œæ‰§è¡Œç»“æœå°±æ˜¯ nullï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®š FutureTask#get è¿”å›æ•°æ®</span></span><br><span class="line">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æŠŠ Callable å°è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡</span></span><br><span class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="comment">// è¿”å›æœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œç”¨æ¥è·å–è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Runnable runnable, T value)</span> &#123;</span><br><span class="line">    <span class="comment">// Runnable å°è£…æˆ FutureTaskï¼Œã€æŒ‡å®šè¿”å›å€¼ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(runnable, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Callable&lt;T&gt; callable)</span> &#123;</span><br><span class="line">    <span class="comment">// Callable ç›´æ¥å°è£…æˆ FutureTask</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(callable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>execute()ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œ<strong>ä½†æ˜¯æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡åŠæ³•è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ</strong>ï¼Œå‡ºç°å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ã€‚æ ¹æ®çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œé€‰æ‹©æ·»åŠ ä»»åŠ¡æ—¶çš„å¤„ç†æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// command å¯ä»¥æ˜¯æ™®é€šçš„ Runnable å®ç°ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ FutureTaskï¼Œä¸èƒ½æ˜¯ Callable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">  	<span class="comment">// è·å– ctl æœ€æ–°å€¼èµ‹å€¼ç»™ cï¼Œctl é«˜ 3 ä½è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ä½è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ã€‚</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="comment">// ã€1ã€‘å½“å‰çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ­¤æ¬¡æäº¤ä»»åŠ¡ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ workerï¼Œçº¿ç¨‹æ± ä¸­å¤šäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="comment">// addWorker ä¸ºåˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œä¼šåˆ›å»º worker å¯¹è±¡å¹¶ä¸”å°† command ä½œä¸º firstTaskï¼Œä¼˜å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™æ¡è¯­å¥ï¼Œè¯´æ˜ addWorker ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œå­˜åœ¨å¹¶å‘ç°è±¡æˆ–è€…çº¿ç¨‹æ± çŠ¶æ€è¢«æ”¹å˜ï¼Œé‡æ–°è·å–çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// SHUTDOWN çŠ¶æ€ä¸‹ä¹Ÿæœ‰å¯èƒ½åˆ›å»ºæˆåŠŸï¼Œå‰æ firstTask == null è€Œä¸”å½“å‰ queue ä¸ä¸ºç©ºï¼ˆç‰¹æ®Šæƒ…å†µï¼‰</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€2ã€‘æ‰§è¡Œåˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ•°é‡å·²ç»è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°é‡ æˆ–è€… addWorker å¤±è´¥</span></span><br><span class="line">    <span class="comment">// 	åˆ¤æ–­å½“å‰çº¿ç¨‹æ± æ˜¯å¦å¤„äºrunningçŠ¶æ€ï¼Œæˆç«‹å°±å°è¯•å°† task æ”¾å…¥åˆ° workQueue ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€è¢«å¤–éƒ¨çº¿ç¨‹ç»™ä¿®æ”¹äº†ï¼Œå¯èƒ½æ˜¯æ‰§è¡Œäº† shutdown() æ–¹æ³•ï¼Œè¯¥çŠ¶æ€ä¸èƒ½æ¥æ”¶æ–°æäº¤çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥è¦æŠŠåˆšæäº¤çš„ä»»åŠ¡åˆ é™¤ï¼Œåˆ é™¤æˆåŠŸè¯´æ˜æäº¤ä¹‹åçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¿˜æœªæ¶ˆè´¹ï¼ˆå¤„ç†ï¼‰è¯¥ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            <span class="comment">// ä»»åŠ¡å‡ºé˜ŸæˆåŠŸï¼Œèµ°æ‹’ç»ç­–ç•¥</span></span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™è¯´æ˜çº¿ç¨‹æ± æ˜¯ running çŠ¶æ€ï¼Œè·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ 0</span></span><br><span class="line">        <span class="comment">// ã€æ‹…ä¿æœºåˆ¶ã€‘ï¼Œä¿è¯çº¿ç¨‹æ± åœ¨ running çŠ¶æ€ä¸‹ï¼Œæœ€èµ·ç å¾—æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€3ã€‘offerå¤±è´¥è¯´æ˜queueæ»¡äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœçº¿ç¨‹æ•°é‡å°šæœªè¾¾åˆ° maximumPoolSizeï¼Œä¼šåˆ›å»ºéæ ¸å¿ƒ worker çº¿ç¨‹ç›´æ¥æ‰§è¡Œ commandï¼Œã€è¿™ä¹Ÿæ˜¯ä¸å…¬å¹³çš„åŸå› ã€‘</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡è¾¾åˆ° maximumPoolSizï¼Œè¿™é‡Œ addWorker ä¹Ÿä¼šå¤±è´¥ï¼Œèµ°æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ·»åŠ çº¿ç¨‹">æ·»åŠ çº¿ç¨‹</h5>
<ul>
<li>
<p>prestartAllCoreThreads()ï¼š<strong>æå‰é¢„çƒ­</strong>ï¼Œåˆ›å»ºæ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">prestartAllCoreThreads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (addWorker(<span class="literal">null</span>, <span class="literal">true</span>))</span><br><span class="line">        ++n;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>addWorker()ï¼š<strong>æ·»åŠ çº¿ç¨‹åˆ°çº¿ç¨‹æ± </strong>ï¼Œè¿”å› true è¡¨ç¤ºåˆ›å»º Worker æˆåŠŸï¼Œä¸”çº¿ç¨‹å¯åŠ¨ã€‚é¦–å…ˆåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹ï¼Œå…è®¸å°±è®©çº¿ç¨‹æ•°é‡ + 1ï¼Œç„¶åå»åˆ›å»º Worker åŠ å…¥çº¿ç¨‹æ± </p>
<p>æ³¨æ„ï¼šSHUTDOWN çŠ¶æ€ä¹Ÿèƒ½æ·»åŠ çº¿ç¨‹ï¼Œä½†æ˜¯è¦æ±‚æ–°åŠ çš„ Woker æ²¡æœ‰ firstTaskï¼Œè€Œä¸”å½“å‰ queue ä¸ä¸ºç©ºï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¸®åŠ©çº¿ç¨‹æ± æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core == true è¡¨ç¤ºé‡‡ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œfalse è¡¨ç¤ºé‡‡ç”¨ maximumPoolSize</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹ã€åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å…è®¸åˆ›å»ºçº¿ç¨‹ã€‘ï¼Œå…è®¸å°±è®¾ç½®çº¿ç¨‹æ•°é‡ + 1</span></span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å– ctl çš„å€¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€ã€æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹ã€‘</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ± æ˜¯ SHUTDOWN çŠ¶æ€ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œé¢è¿˜æœ‰ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œéœ€è¦å¤„ç†å®Œ queue ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// ã€ä¸å…è®¸å†æäº¤æ–°çš„ taskï¼Œæ‰€ä»¥ firstTask ä¸ºç©ºï¼Œä½†æ˜¯å¯ä»¥ç»§ç»­æ·»åŠ  workerã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; !(rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span> &amp;&amp; !workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line">            <span class="comment">// æ¡ä»¶ä¸€ä¸€èˆ¬ä¸æˆç«‹ï¼ŒCAPACITYæ˜¯5äº¿å¤šï¼Œæ ¹æ® core åˆ¤æ–­ä½¿ç”¨å“ªä¸ªå¤§å°é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œè¶…è¿‡äº†è¿”å› false</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è®°å½•çº¿ç¨‹æ•°é‡å·²ç»åŠ  1ï¼Œç±»æ¯”äºç”³è¯·åˆ°äº†ä¸€å—ä»¤ç‰Œï¼Œæ¡ä»¶å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ•°é‡</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="comment">// ç”³è¯·æˆåŠŸï¼Œè·³å‡ºäº† retry è¿™ä¸ª for è‡ªæ—‹</span></span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            <span class="comment">// CAS å¤±è´¥ï¼Œæ²¡æœ‰æˆåŠŸçš„ç”³è¯·åˆ°ä»¤ç‰Œ</span></span><br><span class="line">            c = ctl.get();</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–ï¼Œè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œå¯èƒ½å…¶ä»–çº¿ç¨‹è°ƒç”¨äº† shutdown() æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="comment">// è¿”å›å¤–å±‚å¾ªç¯æ£€æŸ¥æ˜¯å¦èƒ½åˆ›å»ºçº¿ç¨‹ï¼Œåœ¨ if è¯­å¥ä¸­è¿”å› false</span></span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ã€ä»¤ç‰Œç”³è¯·æˆåŠŸï¼Œå¼€å§‹åˆ›å»ºçº¿ç¨‹ã€‘</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¿è¡Œæ ‡è®°ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ worker æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œfalseæœªå¯åŠ¨  trueå¯åŠ¨</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ æ ‡è®°ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ worker æ˜¯å¦æ·»åŠ åˆ°æ± å­ä¸­äº†ï¼Œé»˜è®¤falseæœªæ·»åŠ ï¼Œtrueæ˜¯æ·»åŠ ã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ã€åˆ›å»º Workerï¼Œåº•å±‚é€šè¿‡çº¿ç¨‹å·¥å‚ newThread æ–¹æ³•åˆ›å»ºæ‰§è¡Œçº¿ç¨‹ï¼ŒæŒ‡å®šäº†é¦–å…ˆæ‰§è¡Œçš„ä»»åŠ¡ã€‘</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        <span class="comment">// å°†æ–°åˆ›å»ºçš„ worker èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹èµ‹å€¼ç»™ t</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„åˆ¤æ–­ä¸ºäº†é˜²æ­¢ ç¨‹åºå‘˜è‡ªå®šä¹‰çš„ ThreadFactory å®ç°ç±»æœ‰ bugï¼Œåˆ›é€ ä¸å‡ºçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            <span class="comment">// åŠ äº’æ–¥é”ï¼Œè¦æ·»åŠ  worker äº†</span></span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–æœ€æ–°çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ä¿å­˜åˆ° rs</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line">				<span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸ºRUNNINGçŠ¶æ€ï¼Œä¸æ˜¯å†ã€åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºSHUTDOWNçŠ¶æ€ä¸”firstTaskä¸ºç©ºï¼Œç‰¹æ®Šæƒ…å†µã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="comment">// å½“çº¿ç¨‹startåï¼Œçº¿ç¨‹isAliveä¼šè¿”å›trueï¼Œè¿™é‡Œè¿˜æ²¡å¼€å§‹å¯åŠ¨çº¿ç¨‹ï¼Œå¦‚æœè¢«å¯åŠ¨äº†å°±éœ€è¦æŠ¥é”™</span></span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive())</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//ã€å°†æ–°å»ºçš„ Worker æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ã€‘</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">					<span class="comment">// å½“å‰æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯ä¸€ä¸ªæ–°é«˜ï¼Œæ›´æ–° largestPoolSize</span></span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    <span class="comment">// æ·»åŠ æ ‡è®°ç½®ä¸º true</span></span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è§£é”å•Š</span></span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ·»åŠ æˆåŠŸå°±ã€å¯åŠ¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                <span class="comment">// Thread ç±»ä¸­æŒæœ‰ Runnable ä»»åŠ¡å¯¹è±¡ï¼Œè°ƒç”¨çš„æ˜¯ Runnable çš„ run ï¼Œä¹Ÿå°±æ˜¯ FutureTask</span></span><br><span class="line">                t.start();</span><br><span class="line">                <span class="comment">// è¿è¡Œæ ‡è®°ç½®ä¸º true</span></span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¯åŠ¨çº¿ç¨‹å¤±è´¥ï¼Œåšæ¸…ç†å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›æ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å¯åŠ¨</span></span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>addWorkerFailed()ï¼šæ¸…ç†ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWorkerFailed</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// æŒæœ‰çº¿ç¨‹æ± å…¨å±€é”ï¼Œå› ä¸ºæ“ä½œçš„æ˜¯çº¿ç¨‹æ± ç›¸å…³çš„ä¸œè¥¿</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æ¡ä»¶æˆç«‹éœ€è¦å°† worker åœ¨ workers ä¸­æ¸…ç†å‡ºå»ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (w != <span class="literal">null</span>)</span><br><span class="line">            workers.remove(w);</span><br><span class="line">        <span class="comment">// å°†çº¿ç¨‹æ± è®¡æ•° -1ï¼Œç›¸å½“äºå½’è¿˜ä»¤ç‰Œã€‚</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line">        <span class="comment">// å°è¯•åœæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">        tryTerminate();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”ã€‚</span></span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="è¿è¡Œæ–¹æ³•">è¿è¡Œæ–¹æ³•</h5>
<ul>
<li>
<p>Worker#runï¼šWorker å®ç°äº† Runnable æ¥å£ï¼Œå½“çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨ Worker çš„ run() æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ThreadPoolExecutor#runWorker()</span></span><br><span class="line">    runWorker(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>runWorker()ï¼šçº¿ç¨‹å¯åŠ¨å°±è¦<strong>æ‰§è¡Œä»»åŠ¡</strong>ï¼Œä¼šä¸€ç›´ while å¾ªç¯è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å– worker çš„ firstTask</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    <span class="comment">// å¼•ç”¨ç½®ç©ºï¼Œã€é˜²æ­¢å¤ç”¨è¯¥çº¿ç¨‹æ—¶é‡å¤æ‰§è¡Œè¯¥ä»»åŠ¡ã€‘</span></span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– worker æ—¶è®¾ç½® state = -1ï¼Œè¡¨ç¤ºä¸å…è®¸æŠ¢å é”</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦è®¾ç½® state = 0 å’Œ exclusiveOwnerThread = nullï¼Œå¼€å§‹ç‹¬å æ¨¡å¼æŠ¢é”</span></span><br><span class="line">    w.unlock();</span><br><span class="line">    <span class="comment">// true è¡¨ç¤ºå‘ç”Ÿå¼‚å¸¸é€€å‡ºï¼Œfalse è¡¨ç¤ºæ­£å¸¸é€€å‡ºã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// firstTask ä¸æ˜¯ null å°±ç›´æ¥è¿è¡Œï¼Œå¦åˆ™å» queue ä¸­è·å–ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// ã€getTask å¦‚æœæ˜¯é˜»å¡è·å–ä»»åŠ¡ï¼Œä¼šä¸€ç›´é˜»å¡åœ¨takeæ–¹æ³•ï¼Œç›´åˆ°è·å–ä»»åŠ¡ï¼Œä¸ä¼šèµ°è¿”å›nullçš„é€»è¾‘ã€‘</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// worker åŠ é”ï¼Œshutdown æ—¶ä¼šåˆ¤æ–­å½“å‰ worker çŠ¶æ€ï¼Œã€æ ¹æ®ç‹¬å é”çŠ¶æ€åˆ¤æ–­æ˜¯å¦ç©ºé—²ã€‘</span></span><br><span class="line">            w.lock();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€å¤§äº STOPï¼Œç›®å‰å¤„äº STOP/TIDYING/TERMINATIONï¼Œæ­¤æ—¶ç»™çº¿ç¨‹ä¸€ä¸ªä¸­æ–­ä¿¡å·</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 <span class="comment">// è¯´æ˜çº¿ç¨‹å¤„äº RUNNING æˆ–è€… SHUTDOWN çŠ¶æ€ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">                 (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted())</span><br><span class="line">                <span class="comment">// ä¸­æ–­çº¿ç¨‹ï¼Œè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¸º true</span></span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// é’©å­æ–¹æ³•ï¼Œã€ä»»åŠ¡æ‰§è¡Œçš„å‰ç½®å¤„ç†ã€‘</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ã€æ‰§è¡Œä»»åŠ¡ã€‘</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">                 	<span class="comment">//.....</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é’©å­æ–¹æ³•ï¼Œã€ä»»åŠ¡æ‰§è¡Œçš„åç½®å¤„ç†ã€‘</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="literal">null</span>;		<span class="comment">// å°†å±€éƒ¨å˜é‡taskç½®ä¸ºnullï¼Œä»£è¡¨ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">                w.completedTasks++;	<span class="comment">// æ›´æ–°workerå®Œæˆä»»åŠ¡æ•°é‡</span></span><br><span class="line">                w.unlock();			<span class="comment">// è§£é”</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// getTask()æ–¹æ³•è¿”å›nullæ—¶ä¼šèµ°åˆ°è¿™é‡Œï¼Œè¡¨ç¤ºqueueä¸ºç©ºå¹¶ä¸”çº¿ç¨‹ç©ºé—²è¶…è¿‡ä¿æ´»æ—¶é—´ï¼Œã€å½“å‰çº¿ç¨‹æ‰§è¡Œé€€å‡ºé€»è¾‘ã€‘</span></span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ­£å¸¸é€€å‡º completedAbruptly = false</span></span><br><span class="line">       	<span class="comment">// å¼‚å¸¸é€€å‡º completedAbruptly = trueï¼Œã€ä» task.run() å†…éƒ¨æŠ›å‡ºå¼‚å¸¸ã€‘æ—¶ï¼Œè·³åˆ°è¿™ä¸€è¡Œ</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>unlock()ï¼šé‡ç½®é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123; release(<span class="number">1</span>); &#125;</span><br><span class="line"><span class="comment">// å¤–éƒ¨ä¸ä¼šç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³• è¿™ä¸ªæ–¹æ³•æ˜¯ AQS å†…è°ƒç”¨çš„ï¼Œå¤–éƒ¨è°ƒç”¨ unlock æ—¶è§¦å‘æ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    setExclusiveOwnerThread(<span class="literal">null</span>);		<span class="comment">// è®¾ç½®æŒæœ‰è€…ä¸º null</span></span><br><span class="line">    setState(<span class="number">0</span>);						<span class="comment">// è®¾ç½® state = 0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>getTask()ï¼šè·å–ä»»åŠ¡ï¼Œçº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTime å°±ä¼šè¢«å›æ”¶ï¼Œåˆ¤æ–­çš„ä¾æ®æ˜¯<strong>å½“å‰çº¿ç¨‹é˜»å¡è·å–ä»»åŠ¡è¶…è¿‡ä¿æ´»æ—¶é—´</strong>ï¼Œæ–¹æ³•è¿”å› null å°±ä»£è¡¨å½“å‰çº¿ç¨‹è¦è¢«å›æ”¶äº†ï¼Œè¿”å›åˆ° runWorker æ‰§è¡Œçº¿ç¨‹é€€å‡ºé€»è¾‘ã€‚çº¿ç¨‹æ± å…·æœ‰æ‹…ä¿æœºåˆ¶ï¼Œå¯¹äº RUNNING çŠ¶æ€ä¸‹çš„è¶…æ—¶å›æ”¶ï¼Œè¦ä¿è¯çº¿ç¨‹æ± ä¸­æœ€å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œæˆ–è€…ä»»åŠ¡é˜»å¡é˜Ÿåˆ—å·²ç»æ˜¯ç©º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¶…æ—¶æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–ä»»åŠ¡æ˜¯å¦è¶…æ—¶ï¼Œtrue è¡¨ç¤ºå·²è¶…æ—¶</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timedOut</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± å½“å‰è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€tryTerminateã€‘æ‰“æ–­çº¿ç¨‹åæ‰§è¡Œåˆ°è¿™ï¼Œæ­¤æ—¶çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPæˆ–è€…çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNå¹¶ä¸”é˜Ÿåˆ—å·²ç»æ˜¯ç©º</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ä¸‹é¢çš„ if æ¡ä»¶ä¸€å®šæ˜¯æˆç«‹çš„ï¼Œå¯ä»¥ç›´æ¥è¿”å› nullï¼Œçº¿ç¨‹å°±åº”è¯¥é€€å‡ºäº†</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ CAS è‡ªæ—‹çš„æ–¹å¼è®© ctl å€¼ -1</span></span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ²¡æœ‰æ˜ç¡®çš„åŒºåˆ†è°æ˜¯æ ¸å¿ƒæˆ–è€…éæ ¸å¿ƒçº¿ç¨‹ï¼Œæ˜¯æ ¹æ®å½“å‰æ± ä¸­çš„çº¿ç¨‹æ•°é‡åˆ¤æ–­</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// timed = false è¡¨ç¤ºå½“å‰è¿™ä¸ªçº¿ç¨‹ è·å–taskæ—¶ä¸æ”¯æŒè¶…æ—¶æœºåˆ¶çš„ï¼Œå½“å‰çº¿ç¨‹ä¼šä½¿ç”¨ queue.take() é˜»å¡è·å–</span></span><br><span class="line">        <span class="comment">// timed = true è¡¨ç¤ºå½“å‰è¿™ä¸ªçº¿ç¨‹ è·å–taskæ—¶æ”¯æŒè¶…æ—¶æœºåˆ¶ï¼Œä½¿ç”¨ queue.poll(xxx,xxx) è¶…æ—¶è·å–</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€ä»£è¡¨å…è®¸å›æ”¶æ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£å°±æ— æ‰€è°“äº†ï¼Œå…¨éƒ¨çº¿ç¨‹éƒ½æ‰§è¡Œè¶…æ—¶å›æ”¶</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶äºŒæˆç«‹è¯´æ˜çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“å‰çº¿ç¨‹è®¤ä¸ºæ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œæœ‰ä¿æ´»æ—¶é—´ï¼Œå»è¶…æ—¶è·å–ä»»åŠ¡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¦‚æœçº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œç›´æ¥å›æ”¶</span></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ã€å…è®¸è¶…æ—¶å›æ”¶å¹¶ä¸”å·²ç»è¶…æ—¶äº†ã€‘ï¼Œå°±åº”è¯¥è¢«å›æ”¶äº†ï¼Œç”±äºã€æ‹…ä¿æœºåˆ¶ã€‘è¿˜è¦åšåˆ¤æ–­ï¼š</span></span><br><span class="line">        <span class="comment">// 	  wc &gt; 1 è¯´æ˜çº¿ç¨‹æ± è¿˜ç”¨å…¶ä»–çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥ç›´æ¥å›æ”¶</span></span><br><span class="line">        <span class="comment">//    workQueue.isEmpty() å‰ç½®æ¡ä»¶æ˜¯ wc = 1ï¼Œã€å¦‚æœå½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ˜¯ç©ºäº†ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥é€€å‡ºã€‘</span></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ CAS æœºåˆ¶å°† ctl å€¼ -1 ,å‡ 1 æˆåŠŸçš„çº¿ç¨‹ï¼Œè¿”å› nullï¼Œä»£è¡¨å¯ä»¥é€€å‡º</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¶…æ—¶å›æ”¶ï¼Œã€é€‰æ‹©ä»é˜Ÿåˆ—è·å–ä»»åŠ¡çš„æ–¹æ³•ã€‘æ˜¯è¶…æ—¶è·å–æˆ–è€…é˜»å¡è·å–</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take();</span><br><span class="line">            <span class="comment">// è·å–åˆ°ä»»åŠ¡è¿”å›ä»»åŠ¡ï¼Œã€é˜»å¡è·å–ä¼šé˜»å¡åˆ°è·å–ä»»åŠ¡ä¸ºæ­¢ã€‘ï¼Œä¸ä¼šè¿”å› null</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            <span class="comment">// è·å–ä»»åŠ¡ä¸º null è¯´æ˜è¶…æ—¶äº†ï¼Œå°†è¶…æ—¶æ ‡è®°è®¾ç½®ä¸º trueï¼Œä¸‹æ¬¡è‡ªæ—‹æ—¶è¿” null</span></span><br><span class="line">            timedOut = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            <span class="comment">// é˜»å¡çº¿ç¨‹è¢«æ‰“æ–­åè¶…æ—¶æ ‡è®°ç½®ä¸º falseï¼Œã€è¯´æ˜è¢«æ‰“æ–­ä¸ç®—è¶…æ—¶ã€‘ï¼Œè¦ç»§ç»­è·å–ï¼Œç›´åˆ°è¶…æ—¶æˆ–è€…è·å–åˆ°ä»»åŠ¡</span></span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ±  SHUTDOWN çŠ¶æ€ä¸‹çš„æ‰“æ–­ï¼Œä¼šåœ¨å¾ªç¯è·å–ä»»åŠ¡å‰åˆ¤æ–­ï¼Œè¿”å› null</span></span><br><span class="line">            timedOut = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>processWorkerExit()ï¼š<strong>çº¿ç¨‹é€€å‡ºçº¿ç¨‹æ± </strong>ï¼Œä¹Ÿæœ‰æ‹…ä¿æœºåˆ¶ï¼Œä¿è¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¢«æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£å¸¸é€€å‡º completedAbruptly = falseï¼Œå¼‚å¸¸é€€å‡ºä¸º true</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkerExit</span><span class="params">(Worker w, <span class="type">boolean</span> completedAbruptly)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹ä»£è¡¨å½“å‰ worker æ˜¯å‘ç”Ÿå¼‚å¸¸é€€å‡ºçš„ï¼Œtask ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸äº†</span></span><br><span class="line">    <span class="keyword">if</span> (completedAbruptly)</span><br><span class="line">        <span class="comment">// ä»å¼‚å¸¸æ—¶åˆ°è¿™é‡Œ ctl ä¸€ç›´æ²¡æœ‰ -1ï¼Œéœ€è¦åœ¨è¿™é‡Œ -1</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰ worker å®Œæˆçš„ task æ•°é‡ï¼Œæ±‡æ€»åˆ°çº¿ç¨‹æ± çš„ completedTaskCount</span></span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line">		<span class="comment">// å°† worker ä»çº¿ç¨‹æ± ä¸­ç§»é™¤</span></span><br><span class="line">        workers.remove(w);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();	<span class="comment">// è§£é”</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// å°è¯•åœæ­¢çº¿ç¨‹æ± ï¼Œå”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    tryTerminate();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± ä¸æ˜¯åœæ­¢çŠ¶æ€å°±åº”è¯¥æœ‰çº¿ç¨‹è¿è¡Œã€æ‹…ä¿æœºåˆ¶ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">        <span class="comment">// æ­£å¸¸é€€å‡ºçš„é€»è¾‘ï¼Œæ˜¯å¯¹ç©ºé—²çº¿ç¨‹å›æ”¶ï¼Œä¸æ˜¯æ‰§è¡Œå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®æ˜¯å¦å›æ”¶æ ¸å¿ƒçº¿ç¨‹ç¡®å®šã€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æœ€å°å€¼ã€‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">            <span class="comment">// æœ€å°å€¼ä¸º 0ï¼Œä½†æ˜¯çº¿ç¨‹é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œéœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆä»»åŠ¡æ‹…ä¿æœºåˆ¶</span></span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; !workQueue.isEmpty())</span><br><span class="line">                min = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äºæœ€å°å€¼å¯ä»¥ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ task æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œæœ‰ä¸ªçº¿ç¨‹å› ä¸ºå¼‚å¸¸ç»ˆæ­¢äº†ï¼Œéœ€è¦æ·»åŠ </span></span><br><span class="line">        <span class="comment">// æˆ–è€…çº¿ç¨‹æ± ä¸­çš„æ•°é‡å°äºæœ€å°å€¼ï¼Œè¿™é‡Œè¦åˆ›å»ºä¸€ä¸ªæ–° worker åŠ è¿›çº¿ç¨‹æ± </span></span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="åœæ­¢æ–¹æ³•">åœæ­¢æ–¹æ³•</h5>
<ul>
<li>
<p>shutdown()ï¼šåœæ­¢çº¿ç¨‹æ± </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWNï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€å¤§äº SHUTDOWNï¼Œå°±ä¸ä¼šè®¾ç½®ç›´æ¥è¿”å›</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// ä¸­æ–­ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        <span class="comment">// ç©ºæ–¹æ³•ï¼Œå­ç±»å¯ä»¥æ‰©å±•</span></span><br><span class="line">        onShutdown();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>interruptIdleWorkers()ï¼šshutdown æ–¹æ³•ä¼š<strong>ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹</strong>ï¼Œæ ¹æ®æ˜¯å¦å¯ä»¥è·å– AQS ç‹¬å é”åˆ¤æ–­æ˜¯å¦å¤„äºå·¥ä½œçŠ¶æ€ã€‚çº¿ç¨‹ä¹‹æ‰€ä»¥ç©ºé—²æ˜¯å› ä¸ºé˜»å¡é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œä¸ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œæ‰€ä»¥ shutdown æ–¹æ³•ä¼šè®©æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onlyOne == true è¯´æ˜åªä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ ï¼Œfalse åˆ™ä¸­æ–­æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interruptIdleWorkers</span><span class="params">(<span class="type">boolean</span> onlyOne)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    / /æŒæœ‰å…¨å±€é”</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰ worker</span></span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰ worker çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">            <span class="comment">// æ¡ä»¶ä¸€æˆç«‹ï¼šè¯´æ˜å½“å‰è¿­ä»£çš„è¿™ä¸ªçº¿ç¨‹å°šæœªä¸­æ–­</span></span><br><span class="line">            <span class="comment">// æ¡ä»¶äºŒæˆç«‹ï¼šè¯´æ˜ã€å½“å‰workerå¤„äºç©ºé—²çŠ¶æ€ã€‘ï¼Œé˜»å¡åœ¨pollæˆ–è€…takeï¼Œå› ä¸ºworkeræ‰§è¡Œtaskæ—¶æ˜¯è¦åŠ é”çš„</span></span><br><span class="line">            <span class="comment">//           æ¯ä¸ªworkeræœ‰ä¸€ä¸ªç‹¬å é”ï¼Œw.tryLock()å°è¯•åŠ é”ï¼ŒåŠ é”æˆåŠŸè¿”å› true</span></span><br><span class="line">            <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ä¸­æ–­çº¿ç¨‹ï¼Œå¤„äº queue é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡è‡ªæ—‹ï¼Œè¿”å› nullï¼Œæ‰§è¡Œé€€å‡ºç›¸é€»è¾‘</span></span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾workerçš„ç‹¬å é”</span></span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// falseï¼Œä»£è¡¨ä¸­æ–­æ‰€æœ‰çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å…¨å±€é”</span></span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>shutdownNow()ï¼šç›´æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å€¼å¼•ç”¨</span></span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// ä¸­æ–­çº¿ç¨‹æ± ä¸­ã€æ‰€æœ‰çº¿ç¨‹ã€‘</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// ä»é˜»å¡é˜Ÿåˆ—ä¸­å¯¼å‡ºæœªå¤„ç†çš„task</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="comment">// è¿”å›å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ æœªå¤„ç†çš„ä»»åŠ¡ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>tryTerminate()ï¼šè®¾ç½®ä¸º TERMINATED çŠ¶æ€ if either (SHUTDOWN and pool and queue empty) or (STOP and pool empty)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">tryTerminate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å– ctl çš„å€¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± æ­£å¸¸ï¼Œæˆ–è€…æœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº†çŠ¶æ€è½¬æ¢çš„æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) || runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            <span class="comment">// çº¿ç¨‹æ± æ˜¯ SHUTDOWN å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸æ˜¯ç©ºï¼Œéœ€è¦å»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± çŠ¶æ€ä¸º STOP æˆ–è€…çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”é˜Ÿåˆ—å·²ç»æ˜¯ç©º</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€ä¸­æ–­ä¸€ä¸ªç©ºé—²çº¿ç¨‹ã€‘ï¼Œåœ¨ queue.take() | queue.poll() é˜»å¡ç©ºé—²</span></span><br><span class="line">            <span class="comment">// å”¤é†’åçš„çº¿ç¨‹ä¼šåœ¨getTask()æ–¹æ³•è¿”å›nullï¼Œ</span></span><br><span class="line">            <span class="comment">// æ‰§è¡Œ processWorkerExit é€€å‡ºé€»è¾‘æ—¶ä¼šå†æ¬¡è°ƒç”¨ tryTerminate() å”¤é†’ä¸‹ä¸€ä¸ªç©ºé—²çº¿ç¨‹</span></span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// æ± ä¸­çš„çº¿ç¨‹æ•°é‡ä¸º 0 æ¥åˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">        <span class="comment">// åŠ å…¨å±€é”</span></span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º TIDYING çŠ¶æ€ï¼Œçº¿ç¨‹æ•°é‡ä¸º 0</span></span><br><span class="line">            <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ç»“æŸçº¿ç¨‹æ± </span></span><br><span class="line">                    terminated();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºTERMINATEDçŠ¶æ€ã€‚</span></span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                    <span class="comment">// ã€å”¤é†’æ‰€æœ‰è°ƒç”¨ awaitTermination() æ–¹æ³•çš„çº¿ç¨‹ã€‘</span></span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="Future">Future</h4>
<h5 id="çº¿ç¨‹ä½¿ç”¨">çº¿ç¨‹ä½¿ç”¨</h5>
<p>FutureTask æœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œç»§æ‰¿ Runnableã€Future æ¥å£ï¼Œç”¨äºåŒ…è£… Callable å¯¹è±¡ï¼Œå®ç°ä»»åŠ¡çš„æäº¤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    FutureTask&lt;String&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(task).start();	<span class="comment">//å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> task.get();	<span class="comment">//è·å–è¿”å›ä»»åŠ¡æ•°æ®</span></span><br><span class="line">    System.out.println(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span>&#123;</span><br><span class="line">	<span class="built_in">this</span>.callable = callable;	<span class="comment">// å±æ€§æ³¨å…¥</span></span><br><span class="line">    <span class="built_in">this</span>.state = NEW; 			<span class="comment">// ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º new</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FutureTask</span><span class="params">(Runnable runnable, V result)</span> &#123;</span><br><span class="line">    <span class="comment">// é€‚é…å™¨æ¨¡å¼</span></span><br><span class="line">    <span class="built_in">this</span>.callable = Executors.callable(runnable, result);</span><br><span class="line">    <span class="built_in">this</span>.state = NEW;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Callable&lt;T&gt; <span class="title function_">callable</span><span class="params">(Runnable task, T result)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// ä½¿ç”¨è£…é¥°è€…æ¨¡å¼å°† runnable è½¬æ¢æˆ callable æ¥å£ï¼Œå¤–éƒ¨çº¿ç¨‹é€šè¿‡ get è·å–</span></span><br><span class="line">    <span class="comment">// å½“å‰ä»»åŠ¡æ‰§è¡Œç»“æœæ—¶ï¼Œç»“æœå¯èƒ½ä¸º null ä¹Ÿå¯èƒ½ä¸ºä¼ è¿›æ¥çš„å€¼ï¼Œã€ä¼ è¿›æ¥ä»€ä¹ˆè¿”å›ä»€ä¹ˆã€‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RunnableAdapter</span>&lt;T&gt;(task, result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RunnableAdapter</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> Runnable task;</span><br><span class="line">    <span class="keyword">final</span> T result;</span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    RunnableAdapter(Runnable task, T result) &#123;</span><br><span class="line">        <span class="built_in">this</span>.task = task;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å®åˆ™è°ƒç”¨ Runnable#run æ–¹æ³•</span></span><br><span class="line">        task.run();</span><br><span class="line">        <span class="comment">// è¿”å›å€¼ä¸ºæ„é€  FutureTask å¯¹è±¡æ—¶ä¼ å…¥çš„è¿”å›å€¼æˆ–è€…æ˜¯ null</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="æˆå‘˜å±æ€§-4">æˆå‘˜å±æ€§</h5>
<p>FutureTask ç±»çš„æˆå‘˜å±æ€§ï¼š</p>
<ul>
<li>
<p>ä»»åŠ¡çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰taskçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NEW</span>          <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡æ­£åœ¨ç»“æŸï¼Œå°šæœªå®Œå…¨ç»“æŸï¼Œä¸€ç§ä¸´ç•ŒçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COMPLETING</span>   <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡æ­£å¸¸ç»“æŸ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NORMAL</span>       <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå†…éƒ¨å°è£…çš„ callable.run() å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸äº†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCEPTIONAL</span>  <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡è¢«å–æ¶ˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span>    <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡ä¸­æ–­ä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTING</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡å·²ä¸­æ–­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTED</span>  <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»»åŠ¡å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Callable&lt;V&gt; callable;	<span class="comment">// Runnable ä½¿ç”¨è£…é¥°è€…æ¨¡å¼ä¼ªè£…æˆ Callable</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>å­˜å‚¨ä»»åŠ¡æ‰§è¡Œçš„ç»“æœ</strong>ï¼Œè¿™æ˜¯ run æ–¹æ³•è¿”å›å€¼æ˜¯ void ä¹Ÿå¯ä»¥è·å–åˆ°æ‰§è¡Œç»“æœçš„åŸå› ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£å¸¸æƒ…å†µä¸‹ï¼šä»»åŠ¡æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œoutcome ä¿å­˜æ‰§è¡Œç»“æœï¼Œcallable è¿”å›å€¼</span></span><br><span class="line"><span class="comment">// éæ­£å¸¸æƒ…å†µï¼šcallable å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œoutcome ä¿å­˜å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> Object outcome;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Thread runner;	<span class="comment">// å½“å‰ä»»åŠ¡è¢«çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œä¿å­˜å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡å¼•ç”¨</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>çº¿ç¨‹é˜»å¡é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šæœ‰å¾ˆå¤šçº¿ç¨‹å» get å½“å‰ä»»åŠ¡çš„ç»“æœï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ç§æ•°æ®ç»“æ„å¤´æ’å¤´å–ï¼ˆç±»ä¼¼æ ˆï¼‰çš„ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜æ‰€æœ‰çš„ get çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> WaitNode waiters;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å†…éƒ¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WaitNode</span> &#123;</span><br><span class="line">    <span class="comment">// å•å‘é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="keyword">volatile</span> WaitNode next;</span><br><span class="line">    WaitNode() &#123; thread = Thread.currentThread(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-4">æˆå‘˜æ–¹æ³•</h5>
<p>FutureTask ç±»çš„æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li>
<p><strong>FutureTask#run</strong>ï¼šä»»åŠ¡æ‰§è¡Œå…¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æ¡ä»¶ä¸€ï¼šæˆç«‹è¯´æ˜å½“å‰ task å·²ç»è¢«æ‰§è¡Œè¿‡äº†æˆ–è€…è¢« cancel äº†ï¼Œé NEW çŠ¶æ€çš„ä»»åŠ¡ï¼Œçº¿ç¨‹å°±ä¸éœ€è¦å¤„ç†äº†</span></span><br><span class="line">    <span class="comment">//æ¡ä»¶äºŒï¼šçº¿ç¨‹æ˜¯ NEW çŠ¶æ€ï¼Œå°è¯•è®¾ç½®å½“å‰ä»»åŠ¡å¯¹è±¡çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œè®¾ç½®å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹æŠ¢å äº†è¯¥ä»»åŠ¡ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, runnerOffset, <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå½“å‰ task ä¸€å®šæ˜¯ NEW çŠ¶æ€ï¼Œè€Œä¸”ã€å½“å‰çº¿ç¨‹ä¹ŸæŠ¢å  task æˆåŠŸã€‘</span></span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºç©ºï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼›åˆ¤æ–­ state çŠ¶æ€ï¼Œé˜²æ­¢å¤–éƒ¨çº¿ç¨‹åœ¨æ­¤æœŸé—´ cancel æ‰å½“å‰ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// ã€å› ä¸º task çš„æ‰§è¡Œè€…å·²ç»è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            <span class="comment">// true è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡ŒæˆåŠŸ æœªæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="comment">// false è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡Œå¤±è´¥ æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="type">boolean</span> ran;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// ã€è°ƒç”¨è‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œæ‰§è¡Œç»“æœèµ‹å€¼ç»™ resultã€‘</span></span><br><span class="line">                result = c.call();</span><br><span class="line">                <span class="comment">// æ²¡æœ‰å‡ºç°å¼‚å¸¸</span></span><br><span class="line">                ran = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œè¿”å›å€¼ç½®ç©ºï¼Œran ç½®ä¸º false</span></span><br><span class="line">                result = <span class="literal">null</span>;</span><br><span class="line">                ran = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// è®¾ç½®è¿”å›çš„å¼‚å¸¸</span></span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»£ç å—æ‰§è¡Œæ­£å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (ran)</span><br><span class="line">                <span class="comment">// è®¾ç½®è¿”å›çš„ç»“æœ</span></span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå–æ¶ˆçº¿ç¨‹çš„å¼•ç”¨ï¼Œhelp GC</span></span><br><span class="line">        runner = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯ä¸æ˜¯è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            <span class="comment">// æ‰§è¡Œä¸­æ–­å¤„ç†æ–¹æ³•</span></span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTask#setï¼šè®¾ç½®æ­£å¸¸è¿”å›å€¼ï¼Œé¦–å…ˆå°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º COMPLETING çŠ¶æ€ä»£è¡¨å®Œæˆä¸­ï¼Œé€»è¾‘æ‰§è¡Œå®Œè®¾ç½®ä¸º NORMAL çŠ¶æ€ä»£è¡¨ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆï¼Œæœ€åå”¤é†’ get() é˜»å¡çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(V v)</span> &#123;</span><br><span class="line">    <span class="comment">// CAS æ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆä¸­ï¼Œè®¾ç½®å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹å–æ¶ˆäº†è¯¥ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        <span class="comment">// ã€å°†ç»“æœèµ‹å€¼ç»™ outcomeã€‘</span></span><br><span class="line">        outcome = v;</span><br><span class="line">        <span class="comment">// å°†å½“å‰ä»»åŠ¡çŠ¶æ€ä¿®æ”¹ä¸º NORMAL æ­£å¸¸ç»“æŸçŠ¶æ€ã€‚</span></span><br><span class="line">        UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, NORMAL);</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTask#setExceptionï¼šè®¾ç½®å¼‚å¸¸è¿”å›å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setException</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        <span class="comment">// èµ‹å€¼ç»™è¿”å›ç»“æœï¼Œç”¨æ¥å‘ä¸Šå±‚æŠ›å‡ºæ¥çš„å¼‚å¸¸</span></span><br><span class="line">        outcome = t;</span><br><span class="line">        <span class="comment">// å°†å½“å‰ä»»åŠ¡çš„çŠ¶æ€ ä¿®æ”¹ä¸º EXCEPTIONAL</span></span><br><span class="line">        UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, EXCEPTIONAL);</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTask#finishCompletionï¼š<strong>å”¤é†’ get() é˜»å¡çº¿ç¨‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finishCompletion</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰çš„ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œq æŒ‡å‘å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="literal">null</span>;) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨casè®¾ç½® waiters ä¸º nullï¼Œé˜²æ­¢å¤–éƒ¨çº¿ç¨‹ä½¿ç”¨cancelå–æ¶ˆå½“å‰ä»»åŠ¡ï¼Œè§¦å‘finishCompletionæ–¹æ³•é‡å¤æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, waitersOffset, q, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">// è·å–å½“å‰ WaitNode èŠ‚ç‚¹å°è£…çš„ thread</span></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> q.thread;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹ä¸ä¸º nullï¼Œå”¤é†’å½“å‰ get() ç­‰å¾…è·å–æ•°æ®çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    q.thread = <span class="literal">null</span>;</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                <span class="type">WaitNode</span> <span class="variable">next</span> <span class="operator">=</span> q.next;</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹äº†</span></span><br><span class="line">                <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// æ–­å¼€é“¾è¡¨</span></span><br><span class="line">                q.next = <span class="literal">null</span>; <span class="comment">// help gc</span></span><br><span class="line">                q = next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    done();</span><br><span class="line">    callable = <span class="literal">null</span>;	<span class="comment">// help GC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTask#handlePossibleCancellationInterruptï¼šä»»åŠ¡ä¸­æ–­å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePossibleCancellationInterrupt</span><span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (s == INTERRUPTING)</span><br><span class="line">        <span class="comment">// ä¸­æ–­çŠ¶æ€ä¸­</span></span><br><span class="line">        <span class="keyword">while</span> (state == INTERRUPTING)</span><br><span class="line">            <span class="comment">// ç­‰å¾…ä¸­æ–­å®Œæˆ</span></span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>FutureTask#get</strong>ï¼šè·å–ä»»åŠ¡æ‰§è¡Œçš„è¿”å›å€¼ï¼Œæ‰§è¡Œ run å’Œ get çš„ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€èˆ¬æœ‰å¤šä¸ªçº¿ç¨‹ getï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰ä»»åŠ¡çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING)</span><br><span class="line">        <span class="comment">// è¿”å› task å½“å‰çŠ¶æ€ï¼Œå¯èƒ½å½“å‰çº¿ç¨‹åœ¨é‡Œé¢å·²ç»ç¡äº†ä¸€ä¼š</span></span><br><span class="line">        s = awaitDone(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">return</span> report(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTask#awaitDoneï¼š<strong>get çº¿ç¨‹å°è£…æˆ WaitNode å¯¹è±¡è¿›å…¥é˜»å¡é˜Ÿåˆ—é˜»å¡ç­‰å¾…</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">awaitDone</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 0 ä¸å¸¦è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// å¼•ç”¨å½“å‰çº¿ç¨‹ï¼Œå°è£…æˆ WaitNode å¯¹è±¡</span></span><br><span class="line">    <span class="type">WaitNode</span> <span class="variable">q</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰çº¿ç¨‹ waitNode å¯¹è±¡ï¼Œæ˜¯å¦è¿›å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">queued</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ã€ä¸‰æ¬¡è‡ªæ—‹å¼€å§‹ä¼‘çœ ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰ get() çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ‰“æ–­è¿”å› trueï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹å¯¹åº”çš„ç­‰å¾… node å‡ºé˜Ÿï¼Œ</span></span><br><span class="line">            removeWaiter(q);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// è·å–ä»»åŠ¡çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆå·²ç»æœ‰ç»“æœäº†</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å·²ç»ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºäº† WaitNodeï¼Œç½®ç©º help GC</span></span><br><span class="line">            <span class="keyword">if</span> (q != <span class="literal">null</span>)</span><br><span class="line">                q.thread = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// è¿”å›å½“å‰çš„çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ä»»åŠ¡æ¥è¿‘å®ŒæˆçŠ¶æ€ï¼Œè¿™é‡Œè®©å½“å‰çº¿ç¨‹é‡Šæ”¾ä¸€ä¸‹ cpu ï¼Œç­‰å¾…è¿›è¡Œä¸‹ä¸€æ¬¡æŠ¢å  cpu</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING)</span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">        <span class="comment">// ã€ç¬¬ä¸€æ¬¡è‡ªæ—‹ã€‘ï¼Œå½“å‰çº¿ç¨‹è¿˜æœªåˆ›å»º WaitNode å¯¹è±¡ï¼Œæ­¤æ—¶ä¸ºå½“å‰çº¿ç¨‹åˆ›å»º WaitNodeå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="literal">null</span>)</span><br><span class="line">            q = <span class="keyword">new</span> <span class="title class_">WaitNode</span>();</span><br><span class="line">        <span class="comment">// ã€ç¬¬äºŒæ¬¡è‡ªæ—‹ã€‘ï¼Œå½“å‰çº¿ç¨‹å·²ç»åˆ›å»º WaitNode å¯¹è±¡äº†ï¼Œä½†æ˜¯nodeå¯¹è±¡è¿˜æœªå…¥é˜Ÿ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</span><br><span class="line">            <span class="comment">// waiters æŒ‡å‘é˜Ÿé¦–ï¼Œè®©å½“å‰ WaitNode æˆä¸ºæ–°çš„é˜Ÿé¦–ï¼Œã€å¤´æ’æ³•ã€‘ï¼Œå¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ–°çš„é˜Ÿé¦–</span></span><br><span class="line">            queued = UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, waitersOffset, q.next = waiters, q);</span><br><span class="line">        <span class="comment">// ã€ç¬¬ä¸‰æ¬¡è‡ªæ—‹ã€‘ï¼Œä¼šåˆ°è¿™é‡Œï¼Œæˆ–è€… else å†…</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                removeWaiter(q);</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é˜»å¡æŒ‡å®šçš„æ—¶é—´</span></span><br><span class="line">            LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜éœ€è¦é˜»å¡</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// ã€å½“å‰ get æ“ä½œçš„çº¿ç¨‹è¢« park é˜»å¡ã€‘ï¼Œé™¤éæœ‰å…¶å®ƒçº¿ç¨‹å°†å”¤é†’æˆ–è€…å°†å½“å‰çº¿ç¨‹ä¸­æ–­</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FutureTask#reportï¼šå°è£…è¿è¡Œç»“æœï¼Œå¯ä»¥è·å– run() æ–¹æ³•ä¸­è®¾ç½®çš„æˆå‘˜å˜é‡ outcomeï¼Œ<strong>è¿™æ˜¯ run æ–¹æ³•çš„è¿”å›å€¼æ˜¯ void ä¹Ÿå¯ä»¥è·å–åˆ°ä»»åŠ¡æ‰§è¡Œçš„ç»“æœçš„åŸå› </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">report</span><span class="params">(<span class="type">int</span> s)</span> <span class="keyword">throws</span> ExecutionException &#123;</span><br><span class="line">    <span class="comment">// è·å–æ‰§è¡Œç»“æœï¼Œæ˜¯åœ¨ä¸€ä¸ª futuretask å¯¹è±¡ä¸­çš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥è·å–</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> outcome;</span><br><span class="line">    <span class="comment">// å½“å‰ä»»åŠ¡çŠ¶æ€æ­£å¸¸ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (s == NORMAL)</span><br><span class="line">        <span class="keyword">return</span> (V)x;	<span class="comment">// ç›´æ¥è¿”å› callable çš„é€»è¾‘ç»“æœ</span></span><br><span class="line">    <span class="comment">// å½“å‰ä»»åŠ¡è¢«å–æ¶ˆæˆ–è€…ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (s &gt;= CANCELLED)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CancellationException</span>();		<span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜è‡ªå®šä¹‰çš„ callable ä¸­çš„æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œä½¿ç”¨ outcome ä¸Šå±‚æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutionException</span>((Throwable)x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>FutureTask#cancelï¼šä»»åŠ¡å–æ¶ˆï¼Œæ‰“æ–­æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸€ï¼šè¡¨ç¤ºå½“å‰ä»»åŠ¡å¤„äºè¿è¡Œä¸­æˆ–è€…å¤„äºçº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶äºŒï¼šè¡¨ç¤ºä¿®æ”¹çŠ¶æ€ï¼ŒæˆåŠŸå¯ä»¥å»æ‰§è¡Œä¸‹é¢é€»è¾‘ï¼Œå¦åˆ™è¿”å› false è¡¨ç¤º cancel å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (!(state == NEW &amp;&amp;</span><br><span class="line">          UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW,</span><br><span class="line">                                   mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä»»åŠ¡å·²ç»è¢«æ‰§è¡Œï¼Œæ˜¯å¦å…è®¸æ‰“æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (mayInterruptIfRunning) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–æ‰§è¡Œå½“å‰ FutureTask çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> runner;</span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// æ‰“æ–­æ‰§è¡Œçš„çº¿ç¨‹</span></span><br><span class="line">                    t.interrupt();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®ä»»åŠ¡çŠ¶æ€ä¸ºã€ä¸­æ–­å®Œæˆã€‘</span></span><br><span class="line">                UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, INTERRUPTED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å”¤é†’æ‰€æœ‰ get() é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="ä»»åŠ¡è°ƒåº¦">ä»»åŠ¡è°ƒåº¦</h3>
<h4 id="Timer">Timer</h4>
<p>Timer å®ç°å®šæ—¶åŠŸèƒ½ï¼ŒTimer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task 1&quot;</span>);</span><br><span class="line">            <span class="comment">//int i = 1 / 0;//ä»»åŠ¡ä¸€çš„å‡ºé”™ä¼šå¯¼è‡´ä»»åŠ¡äºŒæ— æ³•æ‰§è¡Œ</span></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task 2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ timer æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line">	<span class="comment">// ä½†ç”±äº timer å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤ä»»åŠ¡1çš„å»¶æ—¶ï¼Œå½±å“äº†ä»»åŠ¡2çš„æ‰§è¡Œ</span></span><br><span class="line">    timer.schedule(task1, <span class="number">1000</span>);<span class="comment">//17:45:56 c.ThreadPool [Timer-0] - task 1</span></span><br><span class="line">    timer.schedule(task2, <span class="number">1000</span>);<span class="comment">//17:45:58 c.ThreadPool [Timer-0] - task 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Scheduled">Scheduled</h4>
<p>ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ±  ScheduledThreadPoolExecutor ç»§æ‰¿ ThreadPoolExecutorï¼š</p>
<ul>
<li>ä½¿ç”¨å†…éƒ¨ç±» ScheduledFutureTask å°è£…ä»»åŠ¡</li>
<li>ä½¿ç”¨å†…éƒ¨ç±» DelayedWorkQueue ä½œä¸ºçº¿ç¨‹æ± é˜Ÿåˆ—</li>
<li>é‡å†™ onShutdown æ–¹æ³•å»å¤„ç† shutdown åçš„ä»»åŠ¡</li>
<li>æä¾› decorateTask æ–¹æ³•ä½œä¸º ScheduledFutureTask çš„ä¿®é¥°æ–¹æ³•ï¼Œä»¥ä¾¿å¼€å‘è€…è¿›è¡Œæ‰©å±•</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š<code>Executors.newScheduledThreadPool(int corePoolSize)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ScheduledThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°å›ºå®šä¸º Integer.MAX_VALUEï¼Œä¿æ´»æ—¶é—´ keepAliveTime å›ºå®šä¸º 0</span></span><br><span class="line">    <span class="built_in">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">          <span class="comment">// é˜»å¡é˜Ÿåˆ—æ˜¯ DelayedWorkQueue</span></span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">DelayedWorkQueue</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>ScheduledFuture&lt;?&gt; schedule(Runnable/Callable&lt;V&gt;, long delay, TimeUnit u)</code>ï¼šå»¶è¿Ÿæ‰§è¡Œä»»åŠ¡</li>
<li><code>ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable/Callable&lt;V&gt;, long initialDelay, long period, TimeUnit unit)</code>ï¼šå®šæ—¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œä¸è€ƒè™‘æ‰§è¡Œçš„è€—æ—¶ï¼Œå‚æ•°ä¸ºåˆå§‹å»¶è¿Ÿæ—¶é—´ã€é—´éš”æ—¶é—´ã€å•ä½</li>
<li><code>ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable/Callable&lt;V&gt;, long initialDelay, long delay, TimeUnit unit)</code>ï¼šå®šæ—¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œè€ƒè™‘æ‰§è¡Œçš„è€—æ—¶ï¼Œå‚æ•°ä¸ºåˆå§‹å»¶è¿Ÿæ—¶é—´ã€é—´éš”æ—¶é—´ã€å•ä½</li>
</ul>
<p>åŸºæœ¬ä½¿ç”¨ï¼š</p>
<ul>
<li>
<p>å»¶è¿Ÿä»»åŠ¡ï¼Œä½†æ˜¯å‡ºç°å¼‚å¸¸å¹¶ä¸ä¼šåœ¨æ§åˆ¶å°æ‰“å°ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± å¤§å°ä¸º1æ—¶ä¹Ÿæ˜¯ä¸²è¡Œæ‰§è¡Œ</span></span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œéƒ½åœ¨ 1s ååŒæ—¶æ‰§è¡Œ</span></span><br><span class="line">    executor.schedule(() -&gt; &#123;</span><br><span class="line">    	System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//int i = 1 / 0;</span></span><br><span class="line">    	<span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    executor.schedule(() -&gt; &#123;</span><br><span class="line">    	System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å®šæ—¶ä»»åŠ¡ scheduleAtFixedRateï¼š<strong>ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨åˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨</strong>ä¹‹é—´åªè¦å¤§äºç­‰äºé—´éš”æ—¶é—´ï¼ŒæŠ¢å åˆ° CPU å°±ä¼šç«‹å³æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;start...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    pool.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;running...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*start...Sat Apr 24 18:08:12 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:08:13 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:08:15 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:08:17 CST 2021</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å®šæ—¶ä»»åŠ¡ scheduleWithFixedDelayï¼š<strong>ä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸåˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨ä¹‹é—´</strong>ç­‰äºé—´éš”æ—¶é—´ï¼ŒæŠ¢å åˆ° CPU å°±ä¼šç«‹å³æ‰§è¡Œï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„è®¾ç½®ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´çš„é—´éš”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">3</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;start...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    pool.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;running...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*start...Sat Apr 24 18:11:41 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:11:42 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:11:45 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:11:48 CST 2021</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æˆå‘˜å±æ€§-5">æˆå‘˜å±æ€§</h4>
<h5 id="æˆå‘˜å˜é‡-2">æˆå‘˜å˜é‡</h5>
<ul>
<li>
<p>shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> continueExistingPeriodicTasksAfterShutdown;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">executeExistingDelayedTasksAfterShutdown</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å–æ¶ˆæ–¹æ³•æ˜¯å¦å°†è¯¥ä»»åŠ¡ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ falseï¼Œä¸ç§»é™¤ï¼Œç­‰åˆ°çº¿ç¨‹æ‹¿åˆ°ä»»åŠ¡ä¹‹åæŠ›å¼ƒ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">removeOnCancel</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»»åŠ¡çš„åºåˆ—å·ï¼Œå¯ä»¥ç”¨æ¥æ¯”è¾ƒä¼˜å…ˆçº§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">sequencer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å»¶è¿Ÿä»»åŠ¡">å»¶è¿Ÿä»»åŠ¡</h5>
<p>ScheduledFutureTask ç»§æ‰¿ FutureTaskï¼Œå®ç° RunnableScheduledFuture æ¥å£ï¼Œå…·æœ‰å»¶è¿Ÿæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œè¦†ç›– FutureTask çš„ run æ–¹æ³•æ¥å®ç°å¯¹<strong>å»¶æ—¶æ‰§è¡Œã€å‘¨æœŸæ‰§è¡Œ</strong>çš„æ”¯æŒã€‚å¯¹äºå»¶æ—¶ä»»åŠ¡è°ƒç”¨ FutureTask#runï¼Œè€Œå¯¹äºå‘¨æœŸæ€§ä»»åŠ¡åˆ™è°ƒç”¨ FutureTask#runAndReset å¹¶ä¸”åœ¨æˆåŠŸä¹‹åæ ¹æ® fixed-delay/fixed-rate æ¨¡å¼æ¥è®¾ç½®ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´å¹¶é‡æ–°å°†ä»»åŠ¡å¡åˆ°å·¥ä½œé˜Ÿåˆ—</p>
<p>åœ¨è°ƒåº¦çº¿ç¨‹æ± ä¸­æ— è®ºæ˜¯ runnable è¿˜æ˜¯ callableï¼Œæ— è®ºæ˜¯å¦éœ€è¦å»¶è¿Ÿå’Œå®šæ—¶ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šè¢«å°è£…æˆ ScheduledFutureTask</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li>
<p>ä»»åŠ¡åºåˆ—å·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> sequenceNumber;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰§è¡Œæ—¶é—´ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> time;			<span class="comment">// ä»»åŠ¡å¯ä»¥è¢«æ‰§è¡Œçš„æ—¶é—´ï¼Œäº¤ä»˜æ—¶é—´ï¼Œä»¥çº³ç§’è¡¨ç¤º</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> period;	<span class="comment">// 0 è¡¨ç¤ºéå‘¨æœŸä»»åŠ¡ï¼Œæ­£æ•°è¡¨ç¤º fixed-rate æ¨¡å¼çš„å‘¨æœŸï¼Œè´Ÿæ•°è¡¨ç¤º fixed-delay æ¨¡å¼</span></span><br></pre></td></tr></table></figure>
<p>fixed-rateï¼šä¸¤æ¬¡å¼€å§‹å¯åŠ¨çš„é—´éš”ï¼Œfixed-delayï¼šä¸€æ¬¡æ‰§è¡Œç»“æŸåˆ°ä¸‹ä¸€æ¬¡å¼€å§‹å¯åŠ¨</p>
</li>
<li>
<p>å®é™…çš„ä»»åŠ¡å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunnableScheduledFuture&lt;V&gt; outerTask = <span class="built_in">this</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»»åŠ¡åœ¨é˜Ÿåˆ—æ•°ç»„ä¸­çš„ç´¢å¼•ä¸‹æ ‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DelayedWorkQueue åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯æœ€å°å †ï¼Œè®°å½•å½“å‰ä»»åŠ¡åœ¨å †ä¸­çš„ç´¢å¼•ï¼Œ-1 ä»£è¡¨åˆ é™¤</span></span><br><span class="line"><span class="type">int</span> heapIndex;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ScheduledFutureTask(Runnable r, V result, <span class="type">long</span> ns, <span class="type">long</span> period) &#123;</span><br><span class="line">    <span class="built_in">super</span>(r, result);</span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„è§¦å‘æ—¶é—´</span></span><br><span class="line">    <span class="built_in">this</span>.time = ns;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„å‘¨æœŸï¼Œå¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    <span class="built_in">this</span>.period = period;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„åºå·</span></span><br><span class="line">    <span class="built_in">this</span>.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>compareTo()ï¼šScheduledFutureTask æ ¹æ®æ‰§è¡Œæ—¶é—´ time æ­£åºæ’åˆ—ï¼Œå¦‚æœæ‰§è¡Œæ—¶é—´ç›¸åŒï¼Œåœ¨æŒ‰ç…§åºåˆ—å· sequenceNumber æ­£åºæ’åˆ—ï¼Œä»»åŠ¡éœ€è¦æ”¾å…¥ DelayedWorkQueueï¼Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­ä½¿ç”¨è¯¥æ–¹æ³•æŒ‰ç…§ä»å°åˆ°å¤§è¿›è¡Œæ’åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(Delayed other)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (other == <span class="built_in">this</span>) <span class="comment">// compare zero if same object</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (other <span class="keyword">instanceof</span> ScheduledFutureTask) &#123;</span><br><span class="line">        <span class="comment">// ç±»å‹å¼ºè½¬</span></span><br><span class="line">        ScheduledFutureTask&lt;?&gt; x = (ScheduledFutureTask&lt;?&gt;)other;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒè€… - è¢«æ¯”è¾ƒè€…çš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">diff</span> <span class="operator">=</span> time - x.time;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒè€…å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (diff &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// è¢«æ¯”è¾ƒè€…å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒè€…çš„åºåˆ—å·å°</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (sequenceNumber &lt; x.sequenceNumber)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸æ˜¯ ScheduledFutureTask ç±»å‹æ—¶ï¼Œæ ¹æ®å»¶è¿Ÿæ—¶é—´æ’åº</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">diff</span> <span class="operator">=</span> getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);</span><br><span class="line">    <span class="keyword">return</span> (diff &lt; <span class="number">0</span>) ? -<span class="number">1</span> : (diff &gt; <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>run()ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œéå‘¨æœŸä»»åŠ¡ç›´æ¥å®Œæˆç›´æ¥ç»“æŸï¼Œ<strong>å‘¨æœŸä»»åŠ¡æ‰§è¡Œå®Œåä¼šè®¾ç½®ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´ï¼Œé‡æ–°æ”¾å…¥çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—</strong>ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°‘äºæ ¸å¿ƒçº¿ç¨‹ï¼Œå°±ä¼šæ·»åŠ  Worker å¼€å¯æ–°çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å‘¨æœŸæ€§ï¼Œå°±æ˜¯åˆ¤æ–­ period æ˜¯å¦ä¸º 0</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">periodic</span> <span class="operator">=</span> isPeriodic();</span><br><span class="line">    <span class="comment">// æ ¹æ®æ˜¯å¦æ˜¯å‘¨æœŸä»»åŠ¡æ£€æŸ¥å½“å‰çŠ¶æ€èƒ½å¦æ‰§è¡Œä»»åŠ¡ï¼Œä¸èƒ½æ‰§è¡Œå°±å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (!canRunInCurrentRunState(periodic))</span><br><span class="line">        cancel(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// éå‘¨æœŸä»»åŠ¡ï¼Œç›´æ¥è°ƒç”¨ FutureTask#run æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!periodic)</span><br><span class="line">        ScheduledFutureTask.<span class="built_in">super</span>.run();</span><br><span class="line">    <span class="comment">// å‘¨æœŸä»»åŠ¡çš„æ‰§è¡Œï¼Œè¿”å› true è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ScheduledFutureTask.<span class="built_in">super</span>.runAndReset()) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å‘¨æœŸä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        setNextRunTime();</span><br><span class="line">        <span class="comment">// ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œå®‰æ’ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€å¯ä»¥æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶å¼€å¯æ–°çº¿ç¨‹</span></span><br><span class="line">        reExecutePeriodic(outerTask);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘¨æœŸä»»åŠ¡æ­£å¸¸å®Œæˆå<strong>ä»»åŠ¡çš„çŠ¶æ€ä¸ä¼šå˜åŒ–</strong>ï¼Œä¾æ—§æ˜¯ NEWï¼Œä¸ä¼šè®¾ç½® outcome å±æ€§ã€‚ä½†æ˜¯å¦‚æœæœ¬æ¬¡ä»»åŠ¡æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œä¼šè¿›å…¥ setException æ–¹æ³•å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸ºå¼‚å¸¸ï¼ŒæŠŠå¼‚å¸¸ä¿å­˜åœ¨ outcome ä¸­ï¼Œæ–¹æ³•è¿”å› falseï¼Œåç»­çš„è¯¥ä»»åŠ¡å°†ä¸ä¼šå†å‘¨æœŸçš„æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">runAndReset</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡ä¸æ˜¯æ–°å»ºçš„çŠ¶æ€äº†ï¼Œæˆ–è€…è¢«åˆ«çš„çº¿ç¨‹æ‰§è¡Œäº†ï¼Œç›´æ¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, runnerOffset, <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ran</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; s == NEW) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œæ–¹æ³•ï¼Œæ²¡æœ‰è¿”å›å€¼</span></span><br><span class="line">                c.call();</span><br><span class="line">                ran = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸ï¼ŒæŠŠä»»åŠ¡è®¾ç½®ä¸ºå¼‚å¸¸çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰çš„ get é˜»å¡çº¿ç¨‹</span></span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// æ‰§è¡Œå®ŒæˆæŠŠæ‰§è¡Œçº¿ç¨‹å¼•ç”¨ç½®ä¸º null</span></span><br><span class="line">        runner = <span class="literal">null</span>;</span><br><span class="line">        s = state;</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è¿›è¡Œä¸­æ–­å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œè¿”å› trueï¼Œå¹¶ä¸”ä»»åŠ¡çŠ¶æ€æ²¡æœ‰è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">return</span> ran &amp;&amp; s == NEW;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»»åŠ¡ä¸‹ä¸€æ¬¡çš„è§¦å‘æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setNextRunTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">p</span> <span class="operator">=</span> period;</span><br><span class="line">    <span class="keyword">if</span> (p &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// fixed-rate æ¨¡å¼ï¼Œã€æ—¶é—´è®¾ç½®ä¸ºä¸Šä¸€æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ + pã€‘ï¼Œä¸¤æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´å·®</span></span><br><span class="line">        time += p;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// fixed-delay æ¨¡å¼ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´æ˜¯ã€å½“å‰è¿™æ¬¡ä»»åŠ¡ç»“æŸçš„æ—¶é—´ï¼ˆå°±æ˜¯ç°åœ¨ï¼‰ + delay å€¼ã€‘</span></span><br><span class="line">        time = triggerTime(-p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>reExecutePeriodic()<strong>ï¼šå‡†å¤‡ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œï¼Œé‡æ–°æ”¾å…¥é˜»å¡ä»»åŠ¡é˜Ÿåˆ—</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ScheduledThreadPoolExecutor#reExecutePeriodic</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">reExecutePeriodic</span><span class="params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (canRunInCurrentRunState(<span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// ã€æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">        <span class="built_in">super</span>.getQueue().add(task);</span><br><span class="line">        <span class="comment">// å¦‚æœæäº¤å®Œä»»åŠ¡ä¹‹åï¼Œçº¿ç¨‹æ± çŠ¶æ€å˜ä¸ºäº† shutdown çŠ¶æ€ï¼Œéœ€è¦å†æ¬¡æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œ</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸èƒ½æ‰§è¡Œä¸”ä»»åŠ¡è¿˜åœ¨é˜Ÿåˆ—ä¸­æœªè¢«å–èµ°ï¼Œåˆ™å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (!canRunInCurrentRunState(<span class="literal">true</span>) &amp;&amp; remove(task))</span><br><span class="line">            task.cancel(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æ± çŠ¶æ€å¯ä»¥æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶ã€æ ¹æ®çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ç¡®å®šæ˜¯å¦å¼€å¯æ–°çº¿ç¨‹ã€‘</span></span><br><span class="line">            ensurePrestart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>cancel()ï¼šå–æ¶ˆä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±» FutureTask#cancel æ¥å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cancelled</span> <span class="operator">=</span> <span class="built_in">super</span>.cancel(mayInterruptIfRunning);</span><br><span class="line">    <span class="comment">// removeOnCancel ç”¨äºæ§åˆ¶ä»»åŠ¡å–æ¶ˆåæ˜¯å¦åº”è¯¥ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">    <span class="keyword">if</span> (cancelled &amp;&amp; removeOnCancel &amp;&amp; heapIndex &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ä»ç­‰å¾…é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶è°ƒç”¨ tryTerminate() åˆ¤æ–­æ˜¯å¦éœ€è¦åœæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">        remove(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> cancelled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å»¶è¿Ÿé˜Ÿåˆ—">å»¶è¿Ÿé˜Ÿåˆ—</h5>
<p>DelayedWorkQueue æ˜¯æ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œå†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— PriorityQueueï¼ˆå°æ ¹å †ã€æ»¡äºŒå‰æ ‘ï¼‰å­˜å‚¨å…ƒç´ </p>
<p>å…¶ä»–é˜»å¡é˜Ÿåˆ—å­˜å‚¨èŠ‚ç‚¹çš„æ•°æ®ç»“æ„å¤§éƒ½æ˜¯é“¾è¡¨ï¼Œ<strong>å»¶è¿Ÿé˜Ÿåˆ—æ˜¯æ•°ç»„</strong>ï¼Œæ‰€ä»¥å»¶è¿Ÿé˜Ÿåˆ—å‡ºé˜Ÿå¤´å…ƒç´ åéœ€è¦<strong>è®©å…¶ä»–å…ƒç´ ï¼ˆå°¾ï¼‰æ›¿æ¢åˆ°å¤´èŠ‚ç‚¹</strong>ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸</p>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li>
<p>å®¹é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;			<span class="comment">// åˆå§‹å®¹é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;									<span class="comment">// èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> RunnableScheduledFuture&lt;?&gt;[] queue =</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">RunnableScheduledFuture</span>&lt;?&gt;[INITIAL_CAPACITY];	<span class="comment">// å­˜æ”¾èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();	<span class="comment">// æ§åˆ¶å¹¶å‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">available</span> <span class="operator">=</span> lock.newCondition();<span class="comment">// æ¡ä»¶é˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é˜»å¡ç­‰å¾…å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ï¼šçº¿ç¨‹æ± å†…çš„æŸä¸ªçº¿ç¨‹å» take() è·å–ä»»åŠ¡æ—¶ï¼Œå¦‚æœå»¶è¿Ÿé˜Ÿåˆ—é¡¶å±‚èŠ‚ç‚¹ä¸ä¸º nullï¼ˆé˜Ÿåˆ—å†…æœ‰ä»»åŠ¡ï¼‰ï¼Œä½†æ˜¯èŠ‚ç‚¹ä»»åŠ¡è¿˜ä¸åˆ°è§¦å‘æ—¶é—´ï¼Œçº¿ç¨‹å°±å»æ£€æŸ¥<strong>é˜Ÿåˆ—çš„ leader å­—æ®µ</strong>æ˜¯å¦è¢«å ç”¨</p>
<ul>
<li>å¦‚æœæœªè¢«å ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹å ç”¨è¯¥å­—æ®µï¼Œç„¶åå½“å‰çº¿ç¨‹åˆ° available æ¡ä»¶é˜Ÿåˆ—æŒ‡å®šè¶…æ—¶æ—¶é—´ <code>å †é¡¶ä»»åŠ¡.time - now()</code> æŒ‚èµ·</li>
<li>å¦‚æœè¢«å ç”¨ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥åˆ° available æ¡ä»¶é˜Ÿåˆ—ä¸æŒ‡å®šè¶…æ—¶æ—¶é—´çš„æŒ‚èµ·</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// leader åœ¨ available æ¡ä»¶é˜Ÿåˆ—å†…æ˜¯é¦–å…ƒç´ ï¼Œå®ƒè¶…æ—¶ä¹‹åä¼šé†’è¿‡æ¥ï¼Œç„¶åå†æ¬¡å°†å †é¡¶å…ƒç´ è·å–èµ°ï¼Œè·å–èµ°ä¹‹åï¼Œtake()ç»“æŸä¹‹å‰ï¼Œä¼šè°ƒç”¨æ˜¯ available.signal() å”¤é†’ä¸‹ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„ç­‰å¾…è€…ï¼Œç„¶åé‡Šæ”¾ lockï¼Œä¸‹ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå»åˆ° AQS é˜Ÿåˆ—ï¼Œåš acquireQueue(node) é€»è¾‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Thread</span> <span class="variable">leader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æˆå‘˜æ–¹æ³•</p>
<ul>
<li>
<p>offer()ï¼šæ’å…¥èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Runnable x)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableScheduledFuture&lt;?&gt; e = (RunnableScheduledFuture&lt;?&gt;)x;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—é”ï¼Œå¢åŠ åˆ é™¤æ•°æ®æ—¶éƒ½è¦åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—æ•°é‡å¤§äºå­˜æ”¾èŠ‚ç‚¹çš„æ•°ç»„é•¿åº¦ï¼Œéœ€è¦æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">            <span class="comment">// æ‰©å®¹ä¸ºåŸæ¥é•¿åº¦çš„ 1.5 å€</span></span><br><span class="line">            grow();</span><br><span class="line">        size = i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å½“å‰æ˜¯ç¬¬ä¸€ä¸ªè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            queue[<span class="number">0</span>] = e;</span><br><span class="line">            <span class="comment">// ä¿®æ”¹ ScheduledFutureTask çš„ heapIndex å±æ€§ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡åœ¨é˜Ÿåˆ—é‡Œçš„ä¸‹æ ‡</span></span><br><span class="line">            setIndex(e, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å‘ä¸Šè°ƒæ•´å…ƒç´ çš„ä½ç½®ï¼Œå¹¶æ›´æ–° heapIndex</span></span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æƒ…å†µ1ï¼šå½“å‰ä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªåŠ å…¥åˆ° queue å†…çš„ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨å½“å‰ä»»åŠ¡åŠ å…¥åˆ° queue ä¹‹å‰ï¼Œtake() çº¿ç¨‹ä¼šç›´æ¥</span></span><br><span class="line">        <span class="comment">//		åˆ° available é˜Ÿåˆ—ä¸è®¾ç½®è¶…æ—¶çš„æŒ‚èµ·ï¼Œå¹¶ä¸ä¼šå»å ç”¨ leader å­—æ®µï¼Œè¿™æ—¶éœ€ä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ è®©å®ƒå»æ¶ˆè´¹</span></span><br><span class="line">       	<span class="comment">// æƒ…å†µ2ï¼šå½“å‰ä»»åŠ¡ã€ä¼˜å…ˆçº§æœ€é«˜ã€‘ï¼ŒåŸå †é¡¶ä»»åŠ¡å¯èƒ½è¿˜æœªåˆ°è§¦å‘æ—¶é—´ï¼Œleader çº¿ç¨‹è®¾ç½®è¶…æ—¶çš„åœ¨ available æŒ‚èµ·</span></span><br><span class="line">        <span class="comment">//		åŸå…ˆçš„ leader ç­‰å¾…çš„æ˜¯åŸå…ˆçš„å¤´èŠ‚ç‚¹ï¼Œæ‰€ä»¥ leader å·²ç»æ— æ•ˆï¼Œéœ€è¦å°† leader çº¿ç¨‹å”¤é†’ï¼Œ</span></span><br><span class="line">        <span class="comment">//		å”¤é†’ä¹‹åå®ƒä¼šæ£€æŸ¥å †é¡¶ï¼Œå¦‚æœå †é¡¶ä»»åŠ¡å¯ä»¥è¢«æ¶ˆè´¹ï¼Œåˆ™ç›´æ¥è·å–èµ°ï¼Œå¦åˆ™ç»§ç»­æˆä¸º leader ç­‰å¾…æ–°å †é¡¶ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (queue[<span class="number">0</span>] == e) &#123;</span><br><span class="line">            <span class="comment">// å°† leader è®¾ç½®ä¸º null</span></span><br><span class="line">            leader = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// ç›´æ¥éšä¾¿å”¤é†’ç­‰å¾…å¤´ç»“ç‚¹çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">            available.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’å…¥æ–°èŠ‚ç‚¹åå¯¹å †è¿›è¡Œè°ƒæ•´ï¼Œè¿›è¡ŒèŠ‚ç‚¹ä¸Šç§»ï¼Œä¿æŒå…¶ç‰¹æ€§ã€èŠ‚ç‚¹çš„å€¼å°äºå­èŠ‚ç‚¹çš„å€¼ã€‘ï¼Œå°é¡¶å †</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUp</span><span class="params">(<span class="type">int</span> k, RunnableScheduledFuture&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// çˆ¶èŠ‚ç‚¹ï¼Œå°±æ˜¯å †æ’åº</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        RunnableScheduledFuture&lt;?&gt; e = queue[parent];</span><br><span class="line">        <span class="comment">// key å’Œçˆ¶èŠ‚ç‚¹æ¯”ï¼Œå¦‚æœå¤§äºçˆ¶èŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±ç»§ç»­ä¸Šæµ®</span></span><br><span class="line">        <span class="keyword">if</span> (key.compareTo(e) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = e;</span><br><span class="line">        setIndex(e, k);</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = key;</span><br><span class="line">    setIndex(key, k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>poll()ï¼šéé˜»å¡è·å–å¤´ç»“ç‚¹ï¼Œ<strong>è·å–æ‰§è¡Œæ—¶é—´æœ€è¿‘å¹¶ä¸”å¯ä»¥æ‰§è¡Œçš„</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éé˜»å¡è·å–</span></span><br><span class="line"><span class="keyword">public</span> RunnableScheduledFuture&lt;?&gt; poll() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿå¤´èŠ‚ç‚¹ï¼Œå› ä¸ºæ˜¯å°é¡¶å †</span></span><br><span class="line">        RunnableScheduledFuture&lt;?&gt; first = queue[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// å¤´ç»“ç‚¹ä¸ºç©ºæˆ–è€…çš„å»¶è¿Ÿæ—¶é—´æ²¡åˆ°è¿”å› null</span></span><br><span class="line">        <span class="keyword">if</span> (first == <span class="literal">null</span> || first.getDelay(NANOSECONDS) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¤´ç»“ç‚¹è¾¾åˆ°å»¶è¿Ÿæ—¶é—´ï¼Œã€å°¾èŠ‚ç‚¹æˆä¸ºæ›¿ä»£èŠ‚ç‚¹ä¸‹ç§»è°ƒæ•´å †ç»“æ„ã€‘ï¼Œè¿”å›å¤´ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span> finishPoll(first);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RunnableScheduledFuture&lt;?&gt; finishPoll(RunnableScheduledFuture&lt;?&gt; f) &#123;</span><br><span class="line">    <span class="comment">// è·å–å°¾ç´¢å¼•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> --size;</span><br><span class="line">    <span class="comment">// è·å–å°¾èŠ‚ç‚¹</span></span><br><span class="line">    RunnableScheduledFuture&lt;?&gt; x = queue[s];</span><br><span class="line">    <span class="comment">// å°†å †ç»“æ„æœ€åä¸€ä¸ªèŠ‚ç‚¹å ç”¨çš„ slot è®¾ç½®ä¸º nullï¼Œå› ä¸ºè¯¥èŠ‚ç‚¹è¦å°è¯•å‡çº§æˆå †é¡¶ï¼Œä¼šæ ¹æ®ç‰¹æ€§ä¸‹è°ƒ</span></span><br><span class="line">    queue[s] = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// s == 0 è¯´æ˜ å½“å‰å †ç»“æ„åªæœ‰å †é¡¶ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸éœ€è¦åšä»»ä½•çš„äº‹æƒ…</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ä»ç´¢å¼•å¤„ 0 å¼€å§‹å‘ä¸‹è°ƒæ•´</span></span><br><span class="line">        siftDown(<span class="number">0</span>, x);</span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿçš„å…ƒç´ ç´¢å¼•è®¾ç½®ä¸º -1</span></span><br><span class="line">    setIndex(f, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>take()ï¼šé˜»å¡è·å–å¤´èŠ‚ç‚¹ï¼Œè¯»å–å½“å‰å †ä¸­æœ€å°çš„ä¹Ÿå°±æ˜¯è§¦å‘æ—¶é—´æœ€è¿‘çš„ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RunnableScheduledFuture&lt;?&gt; take() <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    <span class="comment">// ä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// å¤´èŠ‚ç‚¹</span></span><br><span class="line">            RunnableScheduledFuture&lt;?&gt; first = queue[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (first == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œç›´è‡³æœ‰ä»»åŠ¡é€šè¿‡ offer å…¥é˜Ÿå¹¶å”¤é†’</span></span><br><span class="line">                available.await();</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–å¤´èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¦åˆ°æ—¶</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> first.getDelay(NANOSECONDS);</span><br><span class="line">                <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">// åˆ°è¾¾è§¦å‘æ—¶é—´ï¼Œè·å–å¤´èŠ‚ç‚¹å¹¶è°ƒæ•´å †ï¼Œé‡æ–°é€‰æ‹©å»¶è¿Ÿæ—¶é—´æœ€å°çš„èŠ‚ç‚¹æ”¾å…¥å¤´éƒ¨</span></span><br><span class="line">                    <span class="keyword">return</span> finishPoll(first);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å¤´èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´è¿˜æ²¡åˆ°</span></span><br><span class="line">                first = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// è¯´æ˜æœ‰ leader çº¿ç¨‹åœ¨ç­‰å¾…è·å–å¤´èŠ‚ç‚¹ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥å»é˜»å¡ç­‰å¾…</span></span><br><span class="line">                <span class="keyword">if</span> (leader != <span class="literal">null</span>)</span><br><span class="line">                    available.await();</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// æ²¡æœ‰ leader çº¿ç¨‹ï¼Œã€å½“å‰çº¿ç¨‹ä½œä¸ºleaderçº¿ç¨‹ï¼Œå¹¶è®¾ç½®å¤´ç»“ç‚¹çš„å»¶è¿Ÿæ—¶é—´ä½œä¸ºé˜»å¡æ—¶é—´ã€‘</span></span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">thisThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                    leader = thisThread;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// åœ¨æ¡ä»¶é˜Ÿåˆ— available ä½¿ç”¨å¸¦è¶…æ—¶çš„æŒ‚èµ·ï¼ˆå †é¡¶ä»»åŠ¡.time - now() çº³ç§’å€¼..ï¼‰</span></span><br><span class="line">                        available.awaitNanos(delay);</span><br><span class="line">                        <span class="comment">// åˆ°è¾¾é˜»å¡æ—¶é—´æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šä»è¿™é‡Œé†’æ¥æ¥</span></span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// tå †é¡¶æ›´æ–°ï¼Œleader ç½®ä¸º nullï¼Œoffer æ–¹æ³•é‡Šæ”¾é”åï¼Œ</span></span><br><span class="line">                        <span class="comment">// æœ‰å…¶å®ƒçº¿ç¨‹é€šè¿‡ take/poll æ‹¿åˆ°é”,è¯»åˆ° leader == nullï¼Œç„¶åå°†è‡ªèº«æ›´æ–°ä¸ºleaderã€‚</span></span><br><span class="line">                        <span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">                            <span class="comment">// leader ç½®ä¸º null ç”¨ä»¥æ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’åç»§çº¿ç¨‹</span></span><br><span class="line">                            leader = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ leader çº¿ç¨‹ï¼Œå¤´ç»“ç‚¹ä¸ä¸º nullï¼Œå”¤é†’é˜»å¡è·å–å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œ</span></span><br><span class="line">        <span class="comment">// ã€å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œå°±ä¼šå‡ºç°æœ‰äº†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯æ²¡æœ‰çº¿ç¨‹å»æ‰§è¡Œã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (leader == <span class="literal">null</span> &amp;&amp; queue[<span class="number">0</span>] != <span class="literal">null</span>)</span><br><span class="line">            available.signal();</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>remove()ï¼šåˆ é™¤èŠ‚ç‚¹ï¼Œå †ç§»é™¤ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(log n)ï¼Œ<strong>å»¶è¿Ÿä»»åŠ¡ç»´æŠ¤äº† heapIndex</strong>ï¼Œç›´æ¥è®¿é—®çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œä»è€Œå¯ä»¥æ›´å¿«çš„ç§»é™¤å…ƒç´ ï¼Œä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­è¢«å–æ¶ˆåä¼šè¿›å…¥è¯¥é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object x)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾å¯¹è±¡åœ¨é˜Ÿåˆ—æ•°ç»„ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexOf(x);</span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿”å› false</span></span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="comment">// ä¿®æ”¹å…ƒç´ çš„ heapIndexï¼Œ-1 ä»£è¡¨åˆ é™¤</span></span><br><span class="line">        setIndex(queue[i], -<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// å°¾ç´¢å¼•æ˜¯é•¿åº¦-1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> --size;</span><br><span class="line">        <span class="comment">// å°¾èŠ‚ç‚¹ä½œä¸ºæ›¿ä»£èŠ‚ç‚¹</span></span><br><span class="line">        RunnableScheduledFuture&lt;?&gt; replacement = queue[s];</span><br><span class="line">        queue[s] = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// s == i è¯´æ˜å¤´èŠ‚ç‚¹å°±æ˜¯å°¾èŠ‚ç‚¹ï¼Œé˜Ÿåˆ—ç©ºäº†</span></span><br><span class="line">        <span class="keyword">if</span> (s != i) &#123;</span><br><span class="line">            <span class="comment">// å‘ä¸‹è°ƒæ•´</span></span><br><span class="line">            siftDown(i, replacement);</span><br><span class="line">            <span class="comment">// è¯´æ˜æ²¡å‘ç”Ÿè°ƒæ•´</span></span><br><span class="line">            <span class="keyword">if</span> (queue[i] == replacement)</span><br><span class="line">                <span class="comment">// ä¸Šç§»å’Œä¸‹ç§»ä¸å¯èƒ½åŒæ—¶å‘ç”Ÿï¼Œæ›¿ä»£èŠ‚ç‚¹å¤§äºå­èŠ‚ç‚¹æ—¶ä¸‹ç§»ï¼Œå¦åˆ™ä¸Šç§»</span></span><br><span class="line">                siftUp(i, replacement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æˆå‘˜æ–¹æ³•-5">æˆå‘˜æ–¹æ³•</h4>
<h5 id="æäº¤ä»»åŠ¡">æäº¤ä»»åŠ¡</h5>
<ul>
<li>
<p>schedule()ï¼šå»¶è¿Ÿæ‰§è¡Œæ–¹æ³•ï¼Œå¹¶æŒ‡å®šæ‰§è¡Œçš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯å½“å‰æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»¥é›¶å»¶æ—¶ä»»åŠ¡çš„å½¢å¼å®ç°</span></span><br><span class="line">    schedule(command, <span class="number">0</span>, NANOSECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command, <span class="type">long</span> delay, TimeUnit unit) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span> || unit == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œç›´æ¥å°† task è¿”å›ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç›®çš„æ˜¯ç”¨äºå­ç±»æ‰©å±•ï¼Œå¹¶ä¸”ã€æ ¹æ®å»¶è¿Ÿæ—¶é—´è®¾ç½®ä»»åŠ¡è§¦å‘çš„æ—¶é—´ç‚¹ã€‘</span></span><br><span class="line">    RunnableScheduledFuture&lt;?&gt; t = decorateTask(command, <span class="keyword">new</span> <span class="title class_">ScheduledFutureTask</span>&lt;Void&gt;(</span><br><span class="line">        											command, <span class="literal">null</span>, triggerTime(delay, unit)));</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿæ‰§è¡Œ</span></span><br><span class="line">    delayedExecute(t);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›ã€å½“å‰æ—¶é—´ + å»¶è¿Ÿæ—¶é—´ã€‘ï¼Œå°±æ˜¯è§¦å‘å½“å‰ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">triggerTime</span><span class="params">(<span class="type">long</span> delay, TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®è§¦å‘çš„æ—¶é—´</span></span><br><span class="line">    <span class="keyword">return</span> triggerTime(unit.toNanos((delay &lt; <span class="number">0</span>) ? <span class="number">0</span> : delay));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="title function_">triggerTime</span><span class="params">(<span class="type">long</span> delay)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ delay &lt; Long.Max_VALUE/2ï¼Œåˆ™ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ä¸ºå½“å‰æ—¶é—´ +delay</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ä¸ºäº†é¿å…é˜Ÿåˆ—ä¸­å‡ºç°ç”±äºæº¢å‡ºå¯¼è‡´çš„æ’åºç´Šä¹±,éœ€è¦è°ƒç”¨overflowFreeæ¥ä¿®æ­£ä¸€ä¸‹delay</span></span><br><span class="line">    <span class="keyword">return</span> now() + ((delay &lt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>)) ? delay : overflowFree(delay));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>overflowFree çš„åŸå› ï¼šå¦‚æœæŸä¸ªä»»åŠ¡çš„ delay ä¸ºè´Ÿæ•°ï¼Œè¯´æ˜å½“å‰å¯ä»¥æ‰§è¡Œï¼ˆå…¶å®æ—©è¯¥æ‰§è¡Œäº†ï¼‰ã€‚é˜»å¡é˜Ÿåˆ—ä¸­ç»´æŠ¤ä»»åŠ¡é¡ºåºæ˜¯åŸºäº compareTo æ¯”è¾ƒçš„ï¼Œæ¯”è¾ƒä¸¤ä¸ªä»»åŠ¡çš„é¡ºåºä¼šç”¨ time ç›¸å‡ã€‚é‚£ä¹ˆå¯èƒ½å‡ºç°ä¸€ä¸ª delay ä¸ºæ­£æ•°å‡å»å¦ä¸€ä¸ªä¸ºè´Ÿæ•°çš„ delayï¼Œç»“æœä¸Šæº¢ä¸ºè´Ÿæ•°ï¼Œåˆ™ä¼šå¯¼è‡´ compareTo äº§ç”Ÿé”™è¯¯çš„ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">overflowFree</span><span class="params">(<span class="type">long</span> delay)</span> &#123;</span><br><span class="line">    <span class="type">Delayed</span> <span class="variable">head</span> <span class="operator">=</span> (Delayed) <span class="built_in">super</span>.getQueue().peek();</span><br><span class="line">    <span class="keyword">if</span> (head != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">headDelay</span> <span class="operator">=</span> head.getDelay(NANOSECONDS);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä¸€ä¸‹é˜Ÿé¦–çš„delayæ˜¯ä¸æ˜¯è´Ÿæ•°ï¼Œå¦‚æœæ˜¯æ­£æ•°å°±ä¸ç”¨ç®¡ï¼Œæ€ä¹ˆå‡éƒ½ä¸ä¼šæº¢å‡º</span></span><br><span class="line">        <span class="comment">// å¦åˆ™æ‹¿å½“å‰ delay å‡å»é˜Ÿé¦–çš„ delay æ¥æ¯”è¾ƒçœ‹ï¼Œå¦‚æœä¸å‡ºç°ä¸Šæº¢ï¼Œæ’åºä¸ä¼šä¹±</span></span><br><span class="line">		<span class="comment">// ä¸ç„¶å°±æŠŠå½“å‰ delay å€¼ç»™è°ƒæ•´ä¸º Long.MAX_VALUE + é˜Ÿé¦– delay</span></span><br><span class="line">        <span class="keyword">if</span> (headDelay &lt; <span class="number">0</span> &amp;&amp; (delay - headDelay &lt; <span class="number">0</span>))</span><br><span class="line">            delay = Long.MAX_VALUE + headDelay;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> delay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>scheduleAtFixedRate()ï¼šå®šæ—¶æ‰§è¡Œï¼Œä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨åˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨çš„é—´éš”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> period,</span><br><span class="line">                                              TimeUnit unit) &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span> || unit == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="comment">// ä»»åŠ¡å°è£…ï¼Œã€æŒ‡å®šåˆå§‹çš„å»¶è¿Ÿæ—¶é—´å’Œå‘¨æœŸæ—¶é—´ã€‘</span></span><br><span class="line">    ScheduledFutureTask&lt;Void&gt; sft =<span class="keyword">new</span> <span class="title class_">ScheduledFutureTask</span>&lt;Void&gt;(command, <span class="literal">null</span>,</span><br><span class="line">                                      triggerTime(initialDelay, unit), unit.toNanos(period));</span><br><span class="line">    <span class="comment">// é»˜è®¤è¿”å›æœ¬èº«</span></span><br><span class="line">    RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);</span><br><span class="line">    sft.outerTask = t;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">    delayedExecute(t);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>scheduleWithFixedDelay()ï¼šå®šæ—¶æ‰§è¡Œï¼Œä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸåˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨çš„é—´éš”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> delay,</span><br><span class="line">                                                 TimeUnit unit) &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span> || unit == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="comment">// ä»»åŠ¡å°è£…ï¼Œã€æŒ‡å®šåˆå§‹çš„å»¶è¿Ÿæ—¶é—´å’Œå‘¨æœŸæ—¶é—´ã€‘ï¼Œå‘¨æœŸæ—¶é—´ä¸º - è¡¨ç¤ºæ˜¯ fixed-delay æ¨¡å¼</span></span><br><span class="line">    ScheduledFutureTask&lt;Void&gt; sft = <span class="keyword">new</span> <span class="title class_">ScheduledFutureTask</span>&lt;Void&gt;(command, <span class="literal">null</span>,</span><br><span class="line">                                      triggerTime(initialDelay, unit), unit.toNanos(-delay));</span><br><span class="line">    RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);</span><br><span class="line">    sft.outerTask = t;</span><br><span class="line">    delayedExecute(t);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="è¿è¡Œä»»åŠ¡">è¿è¡Œä»»åŠ¡</h5>
<ul>
<li>
<p>delayedExecute()ï¼š<strong>æ ¡éªŒçº¿ç¨‹æ± çŠ¶æ€</strong>ï¼Œå»¶è¿Ÿæˆ–å‘¨æœŸæ€§ä»»åŠ¡çš„ä¸»è¦æ‰§è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">delayedExecute</span><span class="params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± æ˜¯ SHUTDOWN çŠ¶æ€ï¼Œéœ€è¦æ‰§è¡Œæ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> (isShutdown())</span><br><span class="line">        reject(task);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æŠŠå½“å‰ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºéœ€è¦ã€è·å–æ‰§è¡Œæ—¶é—´æœ€è¿‘çš„ã€‘ï¼Œå½“å‰ä»»åŠ¡éœ€è¦æ¯”è¾ƒ</span></span><br><span class="line">        <span class="built_in">super</span>.getQueue().add(task);</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”ä¸å…è®¸æ‰§è¡Œä»»åŠ¡äº†ï¼Œå°±ä»é˜Ÿåˆ—åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶è®¾ç½®ä»»åŠ¡çš„çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (isShutdown() &amp;&amp; !canRunInCurrentRunState(task.isPeriodic()) &amp;&amp; remove(task))</span><br><span class="line">            task.cancel(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¯ä»¥æ‰§è¡Œ</span></span><br><span class="line">            ensurePrestart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ensurePrestart()ï¼š<strong>å¼€å¯çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreadPoolExecutor#ensurePrestart</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">ensurePrestart</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(ctl.get());</span><br><span class="line">    <span class="comment">// workeræ•°ç›®å°äºcorePoolSizeï¼Œåˆ™æ·»åŠ ä¸€ä¸ªworkerã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (wc &lt; corePoolSize)</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªå‚æ•° true è¡¨ç¤ºé‡‡ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œfalse è¡¨ç¤ºé‡‡ç”¨ maximumPoolSize</span></span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// corePoolSize = 0çš„æƒ…å†µï¼Œè‡³å°‘å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œã€æ‹…ä¿æœºåˆ¶ã€‘</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wc == <span class="number">0</span>)</span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>canRunInCurrentRunState()ï¼šä»»åŠ¡è¿è¡Œæ—¶éƒ½ä¼šè¢«è°ƒç”¨ä»¥æ ¡éªŒå½“å‰çŠ¶æ€æ˜¯å¦å¯ä»¥è¿è¡Œä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">canRunInCurrentRunState</span><span class="params">(<span class="type">boolean</span> periodic)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ˜¯å¦æ˜¯å‘¨æœŸä»»åŠ¡åˆ¤æ–­ï¼Œåœ¨çº¿ç¨‹æ±  shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œé»˜è®¤éå‘¨æœŸä»»åŠ¡æ˜¯ç»§ç»­æ‰§è¡Œçš„</span></span><br><span class="line">    <span class="keyword">return</span> isRunningOrShutdown(periodic ? continueExistingPeriodicTasksAfterShutdown :</span><br><span class="line">                               executeExistingDelayedTasksAfterShutdown);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>onShutdown()ï¼šåˆ é™¤å¹¶å–æ¶ˆå·¥ä½œé˜Ÿåˆ—ä¸­çš„ä¸éœ€è¦å†æ‰§è¡Œçš„ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">onShutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; q = <span class="built_in">super</span>.getQueue();</span><br><span class="line">    <span class="comment">// shutdown åæ˜¯å¦ä»ç„¶æ‰§è¡Œå»¶æ—¶ä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">keepDelayed</span> <span class="operator">=</span> getExecuteExistingDelayedTasksAfterShutdownPolicy();</span><br><span class="line">    <span class="comment">// shutdown åæ˜¯å¦ä»ç„¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">keepPeriodic</span> <span class="operator">=</span> getContinueExistingPeriodicTasksAfterShutdownPolicy();</span><br><span class="line">    <span class="comment">// å¦‚æœä¸¤è€…çš†ä¸å¯ï¼Œåˆ™å¯¹é˜Ÿåˆ—ä¸­ã€æ‰€æœ‰ä»»åŠ¡ã€‘è°ƒç”¨ cancel å–æ¶ˆå¹¶æ¸…ç©ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (!keepDelayed &amp;&amp; !keepPeriodic) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object e : q.toArray())</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RunnableScheduledFuture&lt;?&gt;)</span><br><span class="line">                ((RunnableScheduledFuture&lt;?&gt;) e).cancel(<span class="literal">false</span>);</span><br><span class="line">        q.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object e : q.toArray()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RunnableScheduledFuture) &#123;</span><br><span class="line">                RunnableScheduledFuture&lt;?&gt; t = (RunnableScheduledFuture&lt;?&gt;)e;</span><br><span class="line">                <span class="comment">// ä¸éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡åˆ é™¤å¹¶å–æ¶ˆï¼Œå·²ç»å–æ¶ˆçš„ä»»åŠ¡ä¹Ÿéœ€è¦ä»é˜Ÿåˆ—ä¸­åˆ é™¤</span></span><br><span class="line">                <span class="keyword">if</span> ((t.isPeriodic() ? !keepPeriodic : !keepDelayed) ||</span><br><span class="line">                    t.isCancelled()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (q.remove(t))</span><br><span class="line">                        t.cancel(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å› ä¸ºä»»åŠ¡è¢«ä»é˜Ÿåˆ—ä¸­æ¸…ç†æ‰ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ tryTerminate å°è¯•ã€æ”¹å˜çº¿ç¨‹æ± çš„çŠ¶æ€ã€‘</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="ForkJoin">ForkJoin</h3>
<p>Fork/Joinï¼šçº¿ç¨‹æ± çš„å®ç°ï¼Œä½“ç°æ˜¯åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ CPU å¯†é›†å‹è¿ç®—ï¼Œç”¨äº<strong>å¹¶è¡Œè®¡ç®—</strong></p>
<p>ä»»åŠ¡æ‹†åˆ†ï¼šå°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£</p>
<ul>
<li>
<p>Fork/Join åœ¨<strong>åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹</strong>ï¼ŒæŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œæå‡äº†è¿ç®—æ•ˆç‡</p>
</li>
<li>
<p>ForkJoin ä½¿ç”¨ ForkJoinPool æ¥å¯åŠ¨ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸ CPU æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± </p>
</li>
<li>
<p>ä»»åŠ¡æœ‰è¿”å›å€¼ç»§æ‰¿ RecursiveTaskï¼Œæ²¡æœ‰è¿”å›å€¼ç»§æ‰¿ RecursiveAction</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>);</span><br><span class="line">    System.out.println(pool.invoke(<span class="keyword">new</span> <span class="title class_">MyTask</span>(<span class="number">5</span>)));</span><br><span class="line">    <span class="comment">//æ‹†åˆ†  5 + MyTask(4) --&gt; 4 + MyTask(3) --&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1~ n ä¹‹é—´æ•´æ•°çš„å’Œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyTask</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.n = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MyTask&#123;&quot;</span> + <span class="string">&quot;n=&quot;</span> + n + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ n å·²ç»ä¸º 1ï¼Œå¯ä»¥æ±‚å¾—ç»“æœäº†</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†ä»»åŠ¡è¿›è¡Œæ‹†åˆ†(fork)</span></span><br><span class="line">        <span class="type">MyTask</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyTask</span>(n - <span class="number">1</span>);</span><br><span class="line">        t1.fork();</span><br><span class="line">        <span class="comment">// åˆå¹¶(join)ç»“æœ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> n + t1.join();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­æ‹†åˆ†ä¼˜åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AddTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="type">int</span> begin;</span><br><span class="line">    <span class="type">int</span> end;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddTask</span><span class="params">(<span class="type">int</span> begin, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.begin = begin;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> + begin + <span class="string">&quot;,&quot;</span> + end + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 5, 5</span></span><br><span class="line">        <span class="keyword">if</span> (begin == end) &#123;</span><br><span class="line">            <span class="keyword">return</span> begin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4, 5  é˜²æ­¢å¤šä½™çš„æ‹†åˆ†  æé«˜æ•ˆç‡</span></span><br><span class="line">        <span class="keyword">if</span> (end - begin == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> end + begin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1 5</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (end + begin) / <span class="number">2</span>; <span class="comment">// 3</span></span><br><span class="line">        <span class="type">AddTask</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddTask</span>(begin, mid); <span class="comment">// 1,3</span></span><br><span class="line">        t1.fork();</span><br><span class="line">        <span class="type">AddTask</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddTask</span>(mid + <span class="number">1</span>, end); <span class="comment">// 4,5</span></span><br><span class="line">        t2.fork();</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> t1.join() + t2.join();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ForkJoinPool å®ç°äº†<strong>å·¥ä½œçªƒå–ç®—æ³•</strong>æ¥æé«˜ CPU çš„åˆ©ç”¨ç‡ï¼š</p>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ª<strong>åŒç«¯é˜Ÿåˆ—</strong>ï¼Œç”¨æ¥å­˜å‚¨éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶å®ƒçº¿ç¨‹çš„åŒç«¯é˜Ÿåˆ—ä¸­çªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ</li>
<li>çªƒå–çš„å¿…é¡»æ˜¯<strong>æœ€æ™šçš„ä»»åŠ¡</strong>ï¼Œé¿å…å’Œé˜Ÿåˆ—æ‰€å±çº¿ç¨‹å‘ç”Ÿç«äº‰ï¼Œä½†æ˜¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶è¿˜æ˜¯ä¼šå‘ç”Ÿç«äº‰</li>
</ul>
<hr>
<h3 id="äº«å…ƒæ¨¡å¼">äº«å…ƒæ¨¡å¼</h3>
<p>äº«å…ƒæ¨¡å¼ï¼ˆFlyweight patternï¼‰ï¼š ç”¨äºå‡å°‘åˆ›å»ºå¯¹è±¡çš„æ•°é‡ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨å’Œæé«˜æ€§èƒ½ï¼Œè¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºç»“æ„å‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†å‡å°‘å¯¹è±¡æ•°é‡ä»è€Œæ”¹å–„åº”ç”¨æ‰€éœ€çš„å¯¹è±¡ç»“æ„çš„æ–¹å¼</p>
<p>å¼‚æ­¥æ¨¡å¼ï¼šè®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ï¼Œä¹Ÿå¯å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå…¸å‹å®ç°å°±æ˜¯çº¿ç¨‹æ± </p>
<p>å·¥ä½œæœºåˆ¶ï¼šäº«å…ƒæ¨¡å¼å°è¯•é‡ç”¨ç°æœ‰çš„åŒç±»å¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°åŒ¹é…çš„å¯¹è±¡ï¼Œåˆ™åˆ›å»ºæ–°å¯¹è±¡</p>
<p>è‡ªå®šä¹‰è¿æ¥æ± ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Pool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pool</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> pool.borrow();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            pool.free(con);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line">    <span class="comment">//è¿æ¥æ± çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="comment">//è¿æ¥å¯¹è±¡çš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> Connection[] connections;</span><br><span class="line">    <span class="comment">//è¿æ¥çŠ¶æ€æ•°ç»„ 0è¡¨ç¤ºç©ºé—²  1è¡¨ç¤ºç¹å¿™</span></span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray states;  <span class="comment">//int[] -&gt; AtomicIntegerArray</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">Connection</span>[poolSize];</span><br><span class="line">        <span class="built_in">this</span>.states = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="keyword">new</span> <span class="title class_">int</span>[poolSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> <span class="title class_">MockConnection</span>(<span class="string">&quot;è¿æ¥&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½¿ç”¨è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">borrow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (states.get(i) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; borrow &quot;</span> +  connections[i]);</span><br><span class="line">                        <span class="keyword">return</span> connections[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œå½“å‰çº¿ç¨‹ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; wait...&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½’è¿˜è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection con)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections[i] == con) &#123;<span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">                states.set(i, <span class="number">0</span>);<span class="comment">//ä¸ç”¨casçš„åŸå› æ˜¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨è¯¥è¿æ¥</span></span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; free &quot;</span> + con);</span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockConnection</span> <span class="keyword">implements</span> <span class="title class_">Connection</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="åŒæ­¥å™¨">åŒæ­¥å™¨</h2>
<h3 id="AQS">AQS</h3>
<h4 id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</h4>
<p>AQSï¼šAbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ï¼Œè®¸å¤šåŒæ­¥ç±»å®ç°éƒ½ä¾èµ–äºè¯¥åŒæ­¥å™¨</p>
<p>AQS ç”¨çŠ¶æ€å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†<strong>ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼</strong>ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é”</p>
<ul>
<li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œå¦‚ ReentrantLock</li>
<li>å…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æºï¼Œå¦‚ Semaphoreï¼ŒReentrantReadWriteLock æ˜¯ç»„åˆå¼</li>
</ul>
<p>AQS æ ¸å¿ƒæ€æƒ³ï¼š</p>
<ul>
<li>
<p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®é”å®šçŠ¶æ€</p>
</li>
<li>
<p>è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼ŒAQS ç”¨é˜Ÿåˆ—å®ç°çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</p>
<p>CLH æ˜¯ä¸€ç§åŸºäºå•å‘é“¾è¡¨çš„<strong>é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”</strong>ï¼ŒAQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-AQS%E5%8E%9F%E7%90%86%E5%9B%BE.png" style="zoom: 80%;" />
</li>
</ul>
<hr>
<h4 id="è®¾è®¡åŸç†">è®¾è®¡åŸç†</h4>
<p>è®¾è®¡åŸç†ï¼š</p>
<ul>
<li>
<p>è·å–é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(state çŠ¶æ€ä¸å…è®¸è·å–) &#123;	<span class="comment">// tryAcquire(arg)</span></span><br><span class="line">    <span class="keyword">if</span>(é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹) &#123;</span><br><span class="line">        å…¥é˜Ÿå¹¶é˜»å¡ park</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å½“å‰çº¿ç¨‹å‡ºé˜Ÿ</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡Šæ”¾é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state çŠ¶æ€å…è®¸äº†) &#123;	<span class="comment">// tryRelease(arg)</span></span><br><span class="line">	æ¢å¤é˜»å¡çš„çº¿ç¨‹(s) unpark</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>AbstractQueuedSynchronizer ä¸­ state è®¾è®¡ï¼š</p>
<ul>
<li>
<p>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œç‹¬å æ¨¡å¼ 0 è¡¨ç¤ºæœªåŠ é”çŠ¶æ€ï¼Œå¤§äº 0 è¡¨ç¤ºå·²ç»åŠ é”çŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>state <strong>ä½¿ç”¨ volatile ä¿®é¥°é…åˆ cas</strong> ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</p>
</li>
<li>
<p>state è¡¨ç¤º<strong>çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼ˆç‹¬å æ¨¡å¼ï¼‰æˆ–è€…å‰©ä½™è®¸å¯æ•°ï¼ˆå…±äº«æ¨¡å¼ï¼‰</strong></p>
</li>
<li>
<p>state APIï¼š</p>
<ul>
<li><code>protected final int getState()</code>ï¼šè·å– state çŠ¶æ€</li>
<li><code>protected final void setState(int newState)</code>ï¼šè®¾ç½® state çŠ¶æ€</li>
<li><code>protected final boolean compareAndSetState(int expect,int update)</code>ï¼š<strong>CAS</strong> å®‰å…¨è®¾ç½® state</li>
</ul>
</li>
</ul>
<p>å°è£…çº¿ç¨‹çš„ Node èŠ‚ç‚¹ä¸­ waitstate è®¾è®¡ï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨ <strong>volatile ä¿®é¥°é…åˆ CAS</strong> ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</p>
</li>
<li>
<p>è¡¨ç¤º Node èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ä¸º 0</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line"><span class="comment">// ç”±äºè¶…æ—¶æˆ–ä¸­æ–­ï¼Œæ­¤èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œä¸ä¼šå†æ”¹å˜çŠ¶æ€</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ­¤èŠ‚ç‚¹åé¢çš„èŠ‚ç‚¹å·²ï¼ˆæˆ–å³å°†ï¼‰è¢«é˜»æ­¢ï¼ˆé€šè¿‡parkï¼‰ï¼Œã€å½“å‰èŠ‚ç‚¹åœ¨é‡Šæ”¾æˆ–å–æ¶ˆæ—¶å¿…é¡»å”¤é†’åé¢çš„èŠ‚ç‚¹ã€‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ­¤èŠ‚ç‚¹å½“å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line"><span class="comment">// å°†releaseSharedä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>é˜»å¡æ¢å¤è®¾è®¡ï¼š</p>
<ul>
<li>ä½¿ç”¨ park &amp; unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå› ä¸ºå‘½ä»¤çš„å…ˆåé¡ºåºä¸å½±å“ç»“æœ</li>
<li>park &amp; unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li>
<li>park çº¿ç¨‹å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li>
</ul>
<p>é˜Ÿåˆ—è®¾è®¡ï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œ<strong>åŒæ­¥é˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨ï¼Œä¾¿äºå‡ºé˜Ÿå…¥é˜Ÿ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤´ç»“ç‚¹ï¼ŒæŒ‡å‘å“‘å…ƒèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"><span class="comment">// é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸åŒ…å«å¤´ç»“ç‚¹ï¼Œä» head.next â†’ tail è®¤ä¸ºæ˜¯é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="comment">// æšä¸¾ï¼šå…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">    <span class="comment">// æšä¸¾ï¼šç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// node éœ€è¦æ„å»ºæˆ FIFO é˜Ÿåˆ—ï¼Œprev æŒ‡å‘å‰ç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="comment">// next æŒ‡å‘åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line">    <span class="comment">// å½“å‰ node å°è£…çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="comment">// æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨ï¼Œåªæœ‰åç»§æŒ‡é’ˆï¼Œæ¡ä»¶é˜Ÿåˆ—ä½¿ç”¨è¯¥å±æ€§</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-AQS%E9%98%9F%E5%88%97%E8%AE%BE%E8%AE%A1.png" alt=""></p>
</li>
<li>
<p>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSetï¼Œ<strong>æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª node èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ª node èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æ¨¡æ¿å¯¹è±¡">æ¨¡æ¿å¯¹è±¡</h4>
<p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ˜¯åŸºäºç»§æ‰¿çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜æ¨¡æ¿ç»“æ„çš„å‰æä¸‹åœ¨å­ç±»ä¸­é‡æ–°å®šä¹‰æ¨¡æ¿ä¸­çš„å†…å®¹ä»¥å®ç°å¤ç”¨ä»£ç </p>
<ul>
<li>ä½¿ç”¨è€…ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•</li>
<li>å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•</li>
</ul>
<p>AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">isHeldExclusively()		<span class="comment">//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒ</span></span><br><span class="line">tryAcquire(<span class="type">int</span>)			<span class="comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span></span><br><span class="line">tryRelease(<span class="type">int</span>)			<span class="comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span></span><br><span class="line">tryAcquireShared(<span class="type">int</span>)	<span class="comment">//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸä¸”æœ‰å‰©ä½™èµ„æº</span></span><br><span class="line">tryReleaseShared(<span class="type">int</span>)	<span class="comment">//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span></span><br></pre></td></tr></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º <code>UnsupportedOperationException</code></li>
<li>è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„</li>
<li>AQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ final ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨</li>
</ul>
<hr>
<h4 id="è‡ªå®šä¹‰">è‡ªå®šä¹‰</h4>
<p>è‡ªå®šä¹‰ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="comment">//ç‹¬å é” ä¸å¯é‡å…¥</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MySync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// åŠ ä¸Šé” è®¾ç½® owner ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span>   <span class="comment">//è§£é”</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);<span class="comment">//volatile ä¿®é¥°çš„å˜é‡æ”¾åœ¨åé¢ï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span>   <span class="comment">//æ˜¯å¦æŒæœ‰ç‹¬å é”</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConditionObject</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">MySync</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySync</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//åŠ é”ï¼ˆä¸æˆåŠŸè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//åŠ é” å¯æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//å°è¯•åŠ é”ï¼Œå°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//å°è¯•åŠ é”ï¼Œå¸¦è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//è§£é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Re-Lock">Re-Lock</h3>
<h4 id="é”å¯¹æ¯”">é”å¯¹æ¯”</h4>
<p>ReentrantLock ç›¸å¯¹äº synchronized å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>é”çš„å®ç°ï¼šsynchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„</li>
<li>æ€§èƒ½ï¼šæ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒ</li>
<li>ä½¿ç”¨ï¼šReentrantLock éœ€è¦æ‰‹åŠ¨è§£é”ï¼Œsynchronized æ‰§è¡Œå®Œä»£ç å—è‡ªåŠ¨è§£é”</li>
<li><strong>å¯ä¸­æ–­</strong>ï¼šReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œ</li>
<li><strong>å…¬å¹³é”</strong>ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”
<ul>
<li>ReentrantLock å¯ä»¥è®¾ç½®å…¬å¹³é”ï¼Œsynchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„</li>
<li>ä¸å…¬å¹³é”çš„å«ä¹‰æ˜¯é˜»å¡é˜Ÿåˆ—å†…å…¬å¹³ï¼Œé˜Ÿåˆ—å¤–éå…¬å¹³</li>
</ul>
</li>
<li>é”è¶…æ—¶ï¼šå°è¯•è·å–é”ï¼Œè¶…æ—¶è·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—
<ul>
<li>ReentrantLock å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œsynchronized ä¼šä¸€ç›´ç­‰å¾…</li>
</ul>
</li>
<li>é”ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼šä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ï¼Œæ›´ç»†ç²’åº¦çš„å”¤é†’çº¿ç¨‹</li>
<li>ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</li>
</ol>
<hr>
<h4 id="ä½¿ç”¨é”-2">ä½¿ç”¨é”</h4>
<p>æ„é€ æ–¹æ³•ï¼š<code>ReentrantLock lock = new ReentrantLock();</code></p>
<p>ReentrantLock ç±» APIï¼š</p>
<ul>
<li>
<p><code>public void lock()</code>ï¼šè·å¾—é”</p>
<ul>
<li>
<p>å¦‚æœé”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œåˆ™å°†é”å®šè®¡æ•°è®¾ç½®ä¸º 1</p>
</li>
<li>
<p>å¦‚æœå½“å‰çº¿ç¨‹å·²ç»ä¿æŒé”å®šï¼Œåˆ™ä¿æŒè®¡æ•°å¢åŠ  1</p>
</li>
<li>
<p>å¦‚æœé”è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿æŒï¼Œåˆ™å½“å‰çº¿ç¨‹è¢«ç¦ç”¨çº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨é”å®šå·²è¢«è·å–ä¹‹å‰å¤„äºä¼‘çœ çŠ¶æ€</p>
</li>
</ul>
</li>
<li>
<p><code>public void unlock()</code>ï¼šå°è¯•é‡Šæ”¾é”</p>
<ul>
<li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¿æŒè®¡æ•°é€’å‡</li>
<li>å¦‚æœä¿æŒè®¡æ•°ç°åœ¨ä¸ºé›¶ï¼Œåˆ™é”å®šè¢«é‡Šæ”¾</li>
<li>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</li>
</ul>
</li>
</ul>
<p>åŸºæœ¬è¯­æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line">reentrantLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	<span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">	reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å…¬å¹³é”">å…¬å¹³é”</h4>
<h5 id="åŸºæœ¬ä½¿ç”¨-4">åŸºæœ¬ä½¿ç”¨</h5>
<p>æ„é€ æ–¹æ³•ï¼š<code>ReentrantLock lock = new ReentrantLock(true)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼šå…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦</p>
<hr>
<h5 id="éå…¬åŸç†">éå…¬åŸç†</h5>
<h6 id="åŠ é”">åŠ é”</h6>
<p>NonfairSync ç»§æ‰¿è‡ª AQS</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>æ²¡æœ‰ç«äº‰ï¼šExclusiveOwnerThread å±äº Thread-0ï¼Œstate è®¾ç½®ä¸º 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock.NonfairSync#lock</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºã€è·å¾—äº†ç‹¬å é”ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);<span class="comment">//å¤±è´¥è¿›å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°ï¼šThread-1 æ‰§è¡Œï¼ŒCAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œè¿›å…¥ acquire é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#acquire</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// tryAcquire å°è¯•è·å–é”å¤±è´¥æ—¶, ä¼šè°ƒç”¨ addWaiter å°†å½“å‰çº¿ç¨‹å°è£…æˆnodeå…¥é˜Ÿï¼ŒacquireQueued é˜»å¡å½“å‰çº¿ç¨‹ï¼Œ</span></span><br><span class="line">    <span class="comment">// acquireQueued è¿”å› true è¡¨ç¤ºæŒ‚èµ·è¿‡ç¨‹ä¸­çº¿ç¨‹è¢«ä¸­æ–­å”¤é†’è¿‡ï¼Œfalse è¡¨ç¤ºæœªè¢«ä¸­æ–­è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­äº†é€»è¾‘æ¥åˆ°è¿™ï¼Œå®Œæˆä¸€æ¬¡çœŸæ­£çš„æ‰“æ–­æ•ˆæœ</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%811.png" style="zoom:80%;" />
<ul>
<li>
<p>è¿›å…¥ tryAcquire å°è¯•è·å–é”é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯ 1ï¼Œç»“æœä»ç„¶å¤±è´¥ï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼ŒåŠ é”æˆåŠŸæœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å½“å‰ AQS å¤„äºæ— é”çŠ¶æ€</li>
<li>åŠ é”çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¯´æ˜å‘ç”Ÿäº†é”é‡å…¥</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock.NonfairSync#tryAcquire</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŠ¢å æˆåŠŸè¿”å› trueï¼ŒæŠ¢å å¤±è´¥è¿”å› false</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// state å€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰å¤„äºã€æ— é”çŠ¶æ€ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”ï¼Œå°è¯•ç”¨casè·å¾—ï¼Œè¿™é‡Œä½“ç°éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—æ˜¯å¦æœ‰é˜»å¡çº¿ç¨‹ç›´æ¥è·å–é”</span></span><br><span class="line">    	<span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">// è·å–é”æˆåŠŸè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å é”çº¿ç¨‹ã€‚</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">	&#125;</span><br><span class="line">   	<span class="comment">// å¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å¾—äº†é”, ç‹¬å é”çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºã€å‘ç”Ÿäº†é”é‡å…¥ã€‘</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°é”é‡å…¥çš„å€¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="comment">// è¶Šç•Œåˆ¤æ–­ï¼Œå½“é‡å…¥çš„æ·±åº¦å¾ˆæ·±æ—¶ï¼Œä¼šå¯¼è‡´ nextc &lt; 0ï¼Œintå€¼è¾¾åˆ°æœ€å¤§ä¹‹åå† + 1 å˜è´Ÿæ•°</span></span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// æ›´æ–° state çš„å€¼ï¼Œè¿™é‡Œä¸ä½¿ç”¨ cas æ˜¯å› ä¸ºå½“å‰çº¿ç¨‹æ­£åœ¨æŒæœ‰é”ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ“ä½œç›¸å½“äºåœ¨ä¸€ä¸ªç®¡ç¨‹å†…</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å¤±è´¥</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—ï¼ˆä¸æ˜¯é˜»å¡é˜Ÿåˆ—ï¼‰ï¼Œå‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹å ç”¨äº†é”</p>
<ul>
<li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤<strong>æ­£å¸¸çŠ¶æ€</strong></li>
<li>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º <strong>Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µ</strong>ï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#addWaiterï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„ node èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// å¿«é€Ÿå…¥é˜Ÿï¼Œå¦‚æœ tail ä¸ä¸º nullï¼Œè¯´æ˜å­˜åœ¨é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘ å°¾èŠ‚ç‚¹</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// é€šè¿‡ cas å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—ï¼Œæˆä¸ºå°¾èŠ‚ç‚¹ï¼Œã€å°¾æ’æ³•ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;<span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€… CAS å¤±è´¥è¿›å…¥è¿™é‡Œ</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#enq</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹å…¥é˜Ÿï¼Œå¿…é¡»å…¥é˜ŸæˆåŠŸæ‰ç»“æŸå¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// è¯´æ˜å½“å‰é”è¢«å ç”¨ï¼Œä¸”å½“å‰çº¿ç¨‹å¯èƒ½æ˜¯ã€ç¬¬ä¸€ä¸ªè·å–é”å¤±è´¥ã€‘çš„çº¿ç¨‹ï¼Œã€è¿˜æ²¡æœ‰å»ºç«‹é˜Ÿåˆ—ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸€ä¸ªã€å“‘å…ƒèŠ‚ç‚¹ã€‘ï¼Œå¤´å°¾æŒ‡é’ˆéƒ½æŒ‡å‘è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è‡ªæ—‹åˆ°è¿™ï¼Œæ™®é€šå…¥é˜Ÿæ–¹å¼ï¼Œé¦–å…ˆèµ‹å€¼å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ã€å°¾æ’æ³•ã€‘</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// ã€åœ¨è®¾ç½®å®Œå°¾èŠ‚ç‚¹åï¼Œæ‰æ›´æ–°çš„åŸå§‹å°¾èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶ä»å‰å¾€åéå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">//ã€æ­¤æ—¶ t.next  = nullï¼Œå¹¶ä¸”è¿™é‡Œå·²ç» CAS ç»“æŸï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯å®‰å…¨çš„ã€‘</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;	<span class="comment">// è¿”å›å½“å‰ node çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%812.png" style="zoom:80%;" />
</li>
<li>
<p>çº¿ç¨‹èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—æˆåŠŸï¼Œè¿›å…¥ AbstractQueuedSynchronizer#acquireQueued é€»è¾‘é˜»å¡çº¿ç¨‹</p>
<ul>
<li>
<p>acquireQueued ä¼šåœ¨ä¸€ä¸ªè‡ªæ—‹ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</p>
</li>
<li>
<p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯åœ¨ head èŠ‚ç‚¹åï¼Œä¼šå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œstate ä»ä¸º 1 åˆ™å¤±è´¥ï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// true è¡¨ç¤ºå½“å‰çº¿ç¨‹æŠ¢å é”å¤±è´¥ï¼Œfalse è¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸­æ–­æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å¾—å½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹æ˜¯ head, FIFO é˜Ÿåˆ—çš„ç‰¹æ€§è¡¨ç¤ºè½®åˆ°å½“å‰çº¿ç¨‹å¯ä»¥å»è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// è·å–æˆåŠŸ, è®¾ç½®å½“å‰çº¿ç¨‹è‡ªå·±çš„ node ä¸º head</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                <span class="comment">// è¡¨ç¤ºæŠ¢å é”æˆåŠŸ</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// è¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦åº”å½“ parkï¼Œè¿”å› false åéœ€è¦æ–°ä¸€è½®çš„å¾ªç¯ï¼Œè¿”å› true è¿›å…¥æ¡ä»¶äºŒé˜»å¡çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// æ¡ä»¶äºŒè¿”å›ç»“æœæ˜¯å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¢«æ‰“æ–­è¿”å› false ä¸è¿›å…¥è¿™é‡Œçš„é€»è¾‘</span></span><br><span class="line">                <span class="comment">// ã€å°±ç®—è¢«æ‰“æ–­äº†ï¼Œä¹Ÿä¼šç»§ç»­å¾ªç¯ï¼Œå¹¶ä¸ä¼šè¿”å›ã€‘</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ã€å¯æ‰“æ–­æ¨¡å¼ä¸‹æ‰ä¼šè¿›å…¥è¯¥é€»è¾‘ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œ<strong>å°†å‰é©± node çš„ waitStatus æ”¹ä¸º -1</strong>ï¼Œè¿”å› falseï¼›waitStatus ä¸º -1 çš„èŠ‚ç‚¹ç”¨æ¥å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå‰ç½®èŠ‚ç‚¹æ˜¯ä¸ªå¯ä»¥å”¤é†’å½“å‰èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œè¿”å› true</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€å¤„äºå–æ¶ˆçŠ¶æ€ï¼Œéœ€è¦ã€åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹ã€‘, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// è·å–åˆ°éå–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¿æ¥ä¸Šå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">        pred.next = node;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ node çš„ waitStatus æ˜¯ 0ï¼Œè¿›å…¥è¿™é‡Œçš„é€»è¾‘</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ã€è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNALã€‘ï¼Œè¿”å›å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›ä¸åº”è¯¥ parkï¼Œå†æ¬¡å°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œè¿™æ—¶ state ä»ä¸º 1 è·å–å¤±è´¥ï¼ˆç¬¬å››æ¬¡ï¼‰</li>
<li>å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1 äº†ï¼Œè¿”å› true</li>
<li>è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å†æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ç«äº‰å¤±è´¥åï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%813.png" alt=""></p>
</li>
</ul>
<hr>
<h6 id="è§£é”">è§£é”</h6>
<p>ReentrantLock#unlockï¼šé‡Šæ”¾é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ release æµç¨‹</p>
<ul>
<li>
<p>è¿›å…¥ tryReleaseï¼Œè®¾ç½® exclusiveOwnerThread ä¸º nullï¼Œstate = 0</p>
</li>
<li>
<p>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus = -1ï¼Œè¿›å…¥ unparkSuccessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#release</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”ï¼ŒtryRelease è¿”å› true è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»ã€å®Œå…¨é‡Šæ”¾é”ï¼Œé‡å…¥çš„é‡Šæ”¾äº†ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¤´èŠ‚ç‚¹ä»€ä¹ˆæ—¶å€™æ˜¯ç©ºï¼Ÿæ²¡æœ‰å‘ç”Ÿé”ç«äº‰ï¼Œæ²¡æœ‰ç«äº‰çº¿ç¨‹åˆ›å»ºå“‘å…ƒèŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜é˜»å¡é˜Ÿåˆ—æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’ head èŠ‚ç‚¹åé¢çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock.Sync#tryRelease</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">// å‡å»é‡Šæ”¾çš„å€¼ï¼Œå¯èƒ½é‡å…¥</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ç›´æ¥æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰å®Œå…¨é‡Šæ”¾é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹å°±æ˜¯æŒæœ‰é”çº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ›´æ–°é”ï¼Œä¸éœ€è¦ä½¿ç”¨ CAS</span></span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¿›å…¥ AbstractQueuedSynchronizer#unparkSuccessor æ–¹æ³•ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</p>
<ul>
<li>æ‰¾åˆ°é˜Ÿåˆ—ä¸­è·ç¦» head æœ€è¿‘çš„ä¸€ä¸ªæ²¡å–æ¶ˆçš„ Nodeï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</li>
<li>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ã€å°è¯•é‡ç½®çŠ¶æ€ä¸º 0ã€‘ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹è¦å®Œæˆå¯¹åç»­èŠ‚ç‚¹çš„å”¤é†’ä»»åŠ¡äº†ï¼Œä¸éœ€è¦ -1 äº†</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ª</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="comment">// å·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸èƒ½å”¤é†’ï¼Œéœ€è¦æ‰¾åˆ°è·ç¦»å¤´èŠ‚ç‚¹æœ€è¿‘çš„éå–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// AQS é˜Ÿåˆ—ã€ä»åè‡³å‰ã€‘æ‰¾éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œç›´åˆ° t == å½“å‰çš„ node ä¸ºæ­¢ï¼Œæ‰¾ä¸åˆ°å°±ä¸å”¤é†’äº†</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="comment">// è¯´æ˜å½“å‰çº¿ç¨‹çŠ¶æ€éœ€è¦è¢«å”¤é†’</span></span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// ç½®æ¢å¼•ç”¨</span></span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€æ‰¾åˆ°åˆé€‚çš„å¯ä»¥è¢«å”¤é†’çš„ nodeï¼Œåˆ™å”¤é†’çº¿ç¨‹ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä»åå‘å‰çš„å”¤é†’çš„åŸå› </strong>ï¼šenq æ–¹æ³•ä¸­ï¼ŒèŠ‚ç‚¹æ˜¯å°¾æ’æ³•ï¼Œé¦–å…ˆèµ‹å€¼çš„æ˜¯å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œæ­¤æ—¶å‰é©±èŠ‚ç‚¹çš„ next å¹¶æ²¡æœ‰æŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œä»å‰éå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹</p>
</li>
<li>
<p>å”¤é†’çš„çº¿ç¨‹ä¼šä» park ä½ç½®å¼€å§‹æ‰§è¡Œï¼Œå¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p>
<ul>
<li>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1</li>
<li>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node ä¼šæ¸…ç©º Thread</li>
<li>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶ï¼ˆå›¾ä¸­æœ‰é”™è¯¯ï¼ŒåŸæ¥çš„å¤´èŠ‚ç‚¹çš„ waitStatus è¢«æ”¹ä¸º 0 äº†ï¼‰</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%814.png" alt=""></p>
</li>
<li>
<p>å¦‚æœè¿™æ—¶æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰**ï¼ˆéå…¬å¹³ï¼‰**ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†å¹¶æŠ¢å äº†é”</p>
<ul>
<li>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1</li>
<li>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%815.png" alt=""></p>
</li>
</ul>
<hr>
<h5 id="å…¬å¹³åŸç†">å…¬å¹³åŸç†</h5>
<p>ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•ï¼šå…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ‰å» CAS ç«äº‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3000897897090466540L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="comment">// å¤´å°¾æŒ‡å‘ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé“¾è¡¨ä¸ºç©ºï¼Œè¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        <span class="comment">// å¤´å°¾ä¹‹é—´æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæ˜¯ä¸æ˜¯ç©º</span></span><br><span class="line">        <span class="comment">// ä¸æ˜¯ç©ºè¿›å…¥æœ€åçš„åˆ¤æ–­ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦æ˜¯æœ¬çº¿ç¨‹ï¼Œä¸æ˜¯è¿”å› trueï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æœ‰å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">        ((s = h.next) == <span class="literal">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å¯é‡å…¥">å¯é‡å…¥</h4>
<p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”ï¼Œå¦‚æœä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ï¼Œç›´æ¥é€ æˆæ­»é”</p>
<p>æºç è§£æå‚è€ƒï¼š<code>nonfairTryAcquire(int acquires)) </code> å’Œ <code>tryRelease(int releases)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    method1();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; execute method1&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; execute method2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Lock æ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p>
<ul>
<li>åŠ é”ä¸¤æ¬¡è§£é”ä¸¤æ¬¡ï¼šæ­£å¸¸æ‰§è¡Œ</li>
<li>åŠ é”ä¸¤æ¬¡è§£é”ä¸€æ¬¡ï¼šç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜<strong>ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”</strong></li>
<li>åŠ é”ä¸€æ¬¡è§£é”ä¸¤æ¬¡ï¼šè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getLock</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t get Lock&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">        <span class="comment">//lock.unlock();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å¯æ‰“æ–­">å¯æ‰“æ–­</h4>
<h5 id="åŸºæœ¬ä½¿ç”¨-5">åŸºæœ¬ä½¿ç”¨</h5>
<p><code>public void lockInterruptibly()</code>ï¼šè·å¾—å¯æ‰“æ–­çš„é”</p>
<ul>
<li>å¦‚æœæ²¡æœ‰ç«äº‰æ­¤æ–¹æ³•å°±ä¼šè·å– lock å¯¹è±¡é”</li>
<li>å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨ interrupt æ‰“æ–­</li>
</ul>
<p>æ³¨æ„ï¼šå¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…çŠ¶æ€ä¸­çš„çº¿ç¨‹ä¸­æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å°è¯•è·å–é”&quot;</span>);</span><br><span class="line">            lock.lockInterruptibly();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ²¡æœ‰è·å–åˆ°é”ï¼Œè¢«æ‰“æ–­ï¼Œç›´æ¥è¿”å›&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è·å–åˆ°é”&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è¿›è¡Œæ‰“æ–­é”&quot;</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å®ç°åŸç†-3">å®ç°åŸç†</h5>
<ul>
<li>
<p>ä¸å¯æ‰“æ–­æ¨¡å¼ï¼šå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œä¸€ç›´è¦<strong>ç­‰åˆ°è·å¾—é”åæ‰èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­</strong>äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))<span class="comment">//é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="comment">// å¦‚æœacquireQueuedè¿”å›trueï¼Œæ‰“æ–­çŠ¶æ€ interrupted = true</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selfInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// çŸ¥é“è‡ªå·±è¢«æ‰“æ–­äº†ï¼Œéœ€è¦é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­å®Œæˆä¸­æ–­æ•ˆæœ</span></span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())&#123;</span><br><span class="line">                <span class="comment">// æ¡ä»¶äºŒä¸­åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œè¢«æ‰“æ–­è¿”å›trueï¼Œè®¾ç½®ä¸­æ–­æ ‡è®°ä¸º trueï¼Œã€è·å–é”åè¿”å›ã€‘</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">     LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">     <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œè¢«æ‰“æ–­è¿”å›true</span></span><br><span class="line">     <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¯æ‰“æ–­æ¨¡å¼ï¼šAbstractQueuedSynchronizer#acquireInterruptiblyï¼Œ<strong>è¢«æ‰“æ–­åä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­äº†ç›´æ¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        <span class="comment">// æ²¡è·å–åˆ°é”ï¼Œè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å°è£…å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// ã€åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šæŠ›å‡ºå¼‚å¸¸ã€‘, è€Œä¸ä¼šå†æ¬¡è¿›å…¥å¾ªç¯è·å–é”åæ‰å®Œæˆæ‰“æ–­æ•ˆæœ</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æŠ›å‡ºå¼‚å¸¸å‰ä¼šè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            <span class="comment">// å–æ¶ˆå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span></span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿçš„é€»è¾‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cancelAcquire</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹å°è£…çš„ Thread ç½®ä¸ºç©º</span></span><br><span class="line">    node.thread = <span class="literal">null</span>;</span><br><span class="line">	<span class="comment">// è·å–å½“å‰å–æ¶ˆçš„ node çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> node.prev;</span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹ä¹Ÿè¢«å–æ¶ˆäº†ï¼Œå¾ªç¯æ‰¾åˆ°å‰é¢æœ€è¿‘çš„æ²¡è¢«å–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è·å–å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯å½“å‰ nodeï¼Œä¹Ÿå¯èƒ½æ˜¯ waitStatus &gt; 0 çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">predNext</span> <span class="operator">=</span> pred.next;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º ã€å–æ¶ˆçŠ¶æ€ 1ã€‘</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        <span class="comment">// æŠŠå‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ç½®ç©ºï¼Œè¿™é‡Œç›´æ¥æŠŠæ‰€æœ‰çš„å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿ</span></span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ tail èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">int</span> ws;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ head.next èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸æ˜¯ -1ï¼Œä¸æˆç«‹è¯´æ˜å‰é©±çŠ¶æ€å¯èƒ½æ˜¯ 0 æˆ–è€…åˆšè¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆæ’é˜Ÿäº†</span></span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             <span class="comment">// å¦‚æœçŠ¶æ€ä¸æ˜¯ -1ï¼Œè®¾ç½®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º -1</span></span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹çš„çº¿ç¨‹ä¸ä¸ºnull</span></span><br><span class="line">            pred.thread != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> node.next;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ˜¯æ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (next != <span class="literal">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// æŠŠ å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ è®¾ç½®ä¸º å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œã€ä»é˜Ÿåˆ—ä¸­åˆ é™¤äº†å½“å‰èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯ head.next èŠ‚ç‚¹ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="é”è¶…æ—¶">é”è¶…æ—¶</h4>
<h5 id="åŸºæœ¬ä½¿ç”¨-6">åŸºæœ¬ä½¿ç”¨</h5>
<p><code>public boolean tryLock()</code>ï¼šå°è¯•è·å–é”ï¼Œè·å–åˆ°è¿”å› trueï¼Œè·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—</p>
<p><code>public boolean tryLock(long timeout, TimeUnit unit)</code>ï¼šåœ¨ç»™å®šæ—¶é—´å†…è·å–é”ï¼Œè·å–ä¸åˆ°å°±é€€å‡º</p>
<p>æ³¨æ„ï¼štryLock æœŸé—´ä¹Ÿå¯ä»¥è¢«æ‰“æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!lock.tryLock(<span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è·å–ä¸åˆ°é”&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¢«æ‰“æ–­ï¼Œè·å–ä¸åˆ°é”&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è·å–åˆ°é”&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è·å–åˆ°é”&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å®ç°åŸç†-4">å®ç°åŸç†</h5>
<ul>
<li>
<p>æˆå‘˜å˜é‡ï¼šæŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">spinForTimeoutThreshold</span> <span class="operator">=</span> <span class="number">1000L</span>;</span><br></pre></td></tr></table></figure>
<p>è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œå› ä¸ºé˜»å¡åœ¨å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬</p>
</li>
<li>
<p>tryLock()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åªå°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> sync.nonfairTryAcquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>tryLock(long timeout, TimeUnit unit)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquireNanos</span><span class="params">(<span class="type">int</span> arg, <span class="type">long</span> nanosTimeout)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// tryAcquire å°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> tryAcquire(arg) || doAcquireNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">doAcquireNanos</span><span class="params">(<span class="type">int</span> arg, <span class="type">long</span> nanosTimeout)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å–æœ€åæœŸé™çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> System.nanoTime() + nanosTimeout;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="comment">// è®¡ç®—è¿˜éœ€ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)	<span class="comment">//æ—¶é—´å·²åˆ°</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                <span class="comment">// å¦‚æœ nanosTimeout å¤§äºè¯¥å€¼ï¼Œæ‰æœ‰é˜»å¡çš„æ„ä¹‰ï¼Œå¦åˆ™ç›´æ¥è‡ªæ—‹ä¼šå¥½ç‚¹</span></span><br><span class="line">                nanosTimeout &gt; spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">// ã€è¢«æ‰“æ–­ä¼šæŠ¥å¼‚å¸¸ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å“²å­¦å®¶å°±é¤">å“²å­¦å®¶å°±é¤</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1&quot;</span>);<span class="comment">//...</span></span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c3, c4).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;èµ«æ‹‰å…‹åˆ©ç‰¹&quot;</span>, c4, c5).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c5, c1).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">if</span> (left.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span></span><br><span class="line">                    <span class="keyword">if</span> (right.tryLock()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;eating...&quot;</span>);</span><br><span class="line">                            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            right.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    left.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç­·å­&#123;&quot;</span> + name + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</h4>
<h5 id="åŸºæœ¬ä½¿ç”¨-7">åŸºæœ¬ä½¿ç”¨</h5>
<p>synchronized çš„æ¡ä»¶å˜é‡ï¼Œæ˜¯å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ WaitSet ç­‰å¾…ï¼›ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</p>
<p>ReentrantLock ç±»è·å– Condition å¯¹è±¡ï¼š<code>public Condition newCondition()</code></p>
<p>Condition ç±» APIï¼š</p>
<ul>
<li><code>void await()</code>ï¼šå½“å‰çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é”</li>
<li><code>void signal()</code>ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…åœ¨ Condition ä¸Šçš„çº¿ç¨‹ï¼Œä½†æ˜¯å¿…é¡»è·å¾—ä¸è¯¥ Condition ç›¸å…³çš„é”</li>
</ul>
<p>ä½¿ç”¨æµç¨‹ï¼š</p>
<ul>
<li>
<p><strong>await / signal å‰éœ€è¦è·å¾—é”</strong></p>
</li>
<li>
<p>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”è¿›å…¥ ConditionObject ç­‰å¾…</p>
</li>
<li>
<p>await çš„çº¿ç¨‹è¢«å”¤é†’å»é‡æ–°ç«äº‰ lock é”</p>
</li>
<li>
<p><strong>çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸</strong></p>
</li>
<li>
<p>ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition1</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition2</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿›å…¥ç­‰å¾…&quot;</span>);</span><br><span class="line">            <span class="comment">//è¿›å…¥ä¼‘æ¯å®¤ç­‰å¾…</span></span><br><span class="line">            condition1.await();</span><br><span class="line">            System.out.println(<span class="string">&quot;è¢«å”¤é†’äº†&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//å«é†’</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">//å”¤é†’</span></span><br><span class="line">            condition2.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å®ç°åŸç†-5">å®ç°åŸç†</h5>
<h6 id="await">await</h6>
<p>æ€»ä½“æµç¨‹æ˜¯å°† await çº¿ç¨‹åŒ…è£…æˆ node èŠ‚ç‚¹æ”¾å…¥ ConditionObject çš„æ¡ä»¶é˜Ÿåˆ—ï¼Œå¦‚æœè¢«å”¤é†’å°±å°† node è½¬ç§»åˆ° AQS çš„æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é”ï¼Œ<strong>æ¯ä¸ª Condition å¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—</strong></p>
<ul>
<li>
<p>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œçº¿ç¨‹è¿›å…¥ ConditionObject ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­ï¼Œè°ƒç”¨ await æ–¹æ³•çš„çº¿ç¨‹éƒ½æ˜¯æŒé”çŠ¶æ€çš„ï¼Œæ‰€ä»¥è¯´é€»è¾‘é‡Œ<strong>ä¸å­˜åœ¨å¹¶å‘</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">     <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œæ˜¯å°±ç›´æ¥ç»™ä¸ªä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°†è°ƒç”¨ await çš„çº¿ç¨‹åŒ…è£…æˆ Nodeï¼Œæ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">    <span class="comment">// å®Œå…¨é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹å”¤é†’å½“å‰çº¿ç¨‹çš„å‰ææ˜¯ã€æŒæœ‰é”ã€‘</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ‰“æ–­æ¨¡å¼ä¸ºæ²¡æœ‰è¢«æ‰“æ–­ï¼ŒçŠ¶æ€ç ä¸º 0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜»å¡é˜Ÿåˆ—, park é˜»å¡ï¼Œç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœè¢«æ‰“æ–­ï¼Œé€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¯¹åº”çš„ node ã€ä¹Ÿä¼šè¢«è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘å°¾éƒ¨ï¼ŒçŠ¶æ€è®¾ç½®ä¸º 0</span></span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹é€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œè¿›å…¥ã€é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•æªé”ï¼Œé‡Šæ”¾äº†å¤šå°‘é”å°±ã€é‡æ–°è·å–å¤šå°‘é”ã€‘ï¼Œè·å–é”æˆåŠŸåˆ¤æ–­æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// node åœ¨æ¡ä»¶é˜Ÿåˆ—æ—¶ å¦‚æœè¢«å¤–éƒ¨çº¿ç¨‹ä¸­æ–­å”¤é†’ï¼Œä¼šåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¹¶æœªè®¾ nextWaiter = null</span></span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æŒ‚èµ·æœŸé—´å‘ç”Ÿè¿‡ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REINTERRUPT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THROW_IE</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F1.png" alt=""></p>
</li>
<li>
<p><strong>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰</strong>ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ¡ä»¶é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä¿å­˜åˆ°å±€éƒ¨å˜é‡ t ä¸­</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">    <span class="comment">// å½“å‰é˜Ÿåˆ—ä¸­ä¸æ˜¯ç©ºï¼Œå¹¶ä¸”èŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ CONDITIONï¼ˆ-2ï¼‰ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å‘ç”Ÿäº†ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        <span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// æ¸…ç†å®Œæˆé‡æ–°è·å– å°¾èŠ‚ç‚¹ çš„å¼•ç”¨</span></span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° node, è®¾ç½®çŠ¶æ€ä¸º CONDITION(-2)ï¼Œæ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">        firstWaiter = node;		<span class="comment">// ç©ºé˜Ÿåˆ—ç›´æ¥æ”¾åœ¨é˜Ÿé¦–ã€ä¸ç”¨CASå› ä¸ºæ‰§è¡Œçº¿ç¨‹æ˜¯æŒé”çº¿ç¨‹ï¼Œå¹¶å‘å®‰å…¨ã€‘</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;	<span class="comment">// éç©ºé˜Ÿåˆ—é˜Ÿå°¾è¿½åŠ </span></span><br><span class="line">    lastWaiter = node;			<span class="comment">// æ›´æ–°é˜Ÿå°¾çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆï¼ˆä¸æ˜¯CONDITIONï¼‰çš„ nodeï¼Œã€é“¾è¡¨åˆ é™¤çš„é€»è¾‘ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†ã€FIFOã€‘</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ­£å¸¸çš„ CONDITION èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">trail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ç©º</span></span><br><span class="line">    <span class="keyword">while</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> t.nextWaiter;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ t èŠ‚ç‚¹æ˜¯ä¸æ˜¯ CONDITION èŠ‚ç‚¹ï¼Œæ¡ä»¶é˜Ÿåˆ—å†…ä¸æ˜¯ CONDITION å°±ä¸æ˜¯æ­£å¸¸çš„</span></span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            <span class="comment">// ä¸æ˜¯æ­£å¸¸èŠ‚ç‚¹ï¼Œéœ€è¦ t ä¸ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ–­å¼€</span></span><br><span class="line">            t.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜éå†åˆ°çš„èŠ‚ç‚¹è¿˜æœªç¢°åˆ°è¿‡æ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (trail == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// æ›´æ–° firstWaiter æŒ‡é’ˆä¸ºä¸‹ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// è®©ä¸Šä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹æŒ‡å‘ å½“å‰å–æ¶ˆèŠ‚ç‚¹çš„ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œã€åˆ é™¤éæ­£å¸¸çš„èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            <span class="comment">// t æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œæ›´æ–° lastWaiter æŒ‡å‘æœ€åä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// trail æŒ‡å‘çš„æ˜¯æ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            trail = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠ t.next èµ‹å€¼ç»™ tï¼Œå¾ªç¯éå†</span></span><br><span class="line">        t = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ¥ä¸‹æ¥ Thread-0 è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullyRelease</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// å®Œå…¨é‡Šæ”¾é”æ˜¯å¦æˆåŠŸï¼Œfalse ä»£è¡¨æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹æ‰€æŒæœ‰çš„ state å€¼æ€»æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// release -&gt; tryRelease è§£é”é‡å…¥é”</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">            failed = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è¿”å›è§£é”çš„æ·±åº¦</span></span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è§£é”å¤±è´¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰é‡Šæ”¾æˆåŠŸï¼Œå°†å½“å‰ node è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>fullyRelease ä¸­ä¼š unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç«äº‰é”ï¼Œå‡è®¾ Thread-1 ç«äº‰æˆåŠŸ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F2.png" alt=""></p>
</li>
<li>
<p>Thread-0 è¿›å…¥ isOnSyncQueue é€»è¾‘åˆ¤æ–­èŠ‚ç‚¹<strong>æ˜¯å¦ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—</strong>ï¼Œæ²¡æœ‰å°± park é˜»å¡ Thread-0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isOnSyncQueue</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// node çš„çŠ¶æ€æ˜¯ CONDITIONï¼Œsignal æ–¹æ³•æ˜¯å…ˆä¿®æ”¹çŠ¶æ€å†è¿ç§»ï¼Œæ‰€ä»¥å‰é©±èŠ‚ç‚¹ä¸ºç©ºè¯æ˜è¿˜ã€æ²¡æœ‰å®Œæˆè¿ç§»ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æˆåŠŸå…¥é˜Ÿåˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸”å½“å‰èŠ‚ç‚¹åé¢å·²ç»æœ‰å…¶å®ƒ nodeï¼Œå› ä¸ºæ¡ä»¶é˜Ÿåˆ—çš„ next æŒ‡é’ˆä¸º null</span></span><br><span class="line">    <span class="keyword">if</span> (node.next != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="comment">// è¯´æ˜ã€å¯èƒ½åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯å°¾èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    <span class="comment">// ä»é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹å¼€å§‹å‘å‰ã€éå†æŸ¥æ‰¾ nodeã€‘ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°è¿”å› trueï¼ŒæŸ¥æ‰¾ä¸åˆ°è¿”å› false</span></span><br><span class="line">    <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>await çº¿ç¨‹ park åå¦‚æœè¢« unpark æˆ–è€…è¢«æ‰“æ–­ï¼Œéƒ½ä¼šè¿›å…¥ checkInterruptWhileWaiting åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼š<strong>åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­çš„çº¿ç¨‹éœ€è¦æŠ›å‡ºå¼‚å¸¸</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// Thread.interrupted() è¿”å›å½“å‰çº¿ç¨‹ä¸­æ–­æ ‡è®°ä½ï¼Œå¹¶ä¸”é‡ç½®å½“å‰æ ‡è®°ä½ ä¸º false</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¢«ä¸­æ–­äº†ï¼Œæ ¹æ®æ˜¯å¦åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«ä¸­æ–­çš„ï¼Œè®¾ç½®ä¸­æ–­çŠ¶æ€ç </span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted() ?(transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨çº¿ç¨‹æ˜¯è¢«æ‰“æ–­å”¤é†’æ—¶æ‰ä¼šè°ƒç”¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferAfterCancelledWait</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰nodeä¸€å®šæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…ï¼Œå› ä¸º signal è¿ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œä¼šå°†èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// æŠŠã€ä¸­æ–­å”¤é†’çš„ node åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‘</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…è¢«ä¸­æ–­äº†ï¼Œè®¾ç½®ä¸º THROW_IE ä¸º -1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µï¼š</span></span><br><span class="line">    <span class="comment">//1.å½“å‰nodeå·²ç»è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»åˆ° é˜»å¡é˜Ÿåˆ— å†…äº†</span></span><br><span class="line">    <span class="comment">//2.å½“å‰nodeæ­£åœ¨è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»è‡³ é˜»å¡é˜Ÿåˆ— è¿›è¡Œä¸­çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸€ç›´é‡Šæ”¾ CPU</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node))</span><br><span class="line">        Thread.<span class="keyword">yield</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹è¢«ä¸­æ–­å”¤é†’æ—¶ä¸åœ¨æ¡ä»¶é˜Ÿåˆ—äº†ï¼Œè®¾ç½®ä¸º REINTERRUPT ä¸º 1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœ€åå¼€å§‹å¤„ç†ä¸­æ–­çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reportInterruptAfterWait</span><span class="params">(<span class="type">int</span> interruptMode)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å†…å‘ç”Ÿè¿‡ä¸­æ–­ï¼Œæ­¤æ—¶ await æ–¹æ³•æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode == THROW_IE)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å¤–å‘ç”Ÿçš„ä¸­æ–­ï¼Œæ­¤æ—¶è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä½ä¸º trueã€‘</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</span><br><span class="line">        <span class="comment">// è¿›è¡Œä¸€æ¬¡è‡ªå·±æ‰“æ–­ï¼Œäº§ç”Ÿä¸­æ–­çš„æ•ˆæœ</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h6 id="signal">signal</h6>
<ul>
<li>
<p>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0ï¼Œè¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œ<strong>å–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node</strong>ï¼Œå³ Thread-0 æ‰€åœ¨ Nodeï¼Œå¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…çº¿ç¨‹å®‰å…¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç‹¬å é”æŒæœ‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">// è·å–æ¡ä»¶é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="comment">// ä¸ä¸ºç©ºå°±å°†ç¬¬è¯¥èŠ‚ç‚¹ã€è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’ - ã€å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—å°¾éƒ¨ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ nullï¼Œå½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œé˜Ÿåˆ—ä¸­åªæœ‰å½“å‰ä¸€ä¸ªèŠ‚ç‚¹äº†</span></span><br><span class="line">        <span class="keyword">if</span> ((firstWaiter = first.nextWaiter) == <span class="literal">null</span>)</span><br><span class="line">            lastWaiter = <span class="literal">null</span>;</span><br><span class="line">        first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—ï¼Œä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// signalAll() ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">    lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">        first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">        transferForSignal(first);</span><br><span class="line">        first = next;</span><br><span class="line">    <span class="comment">// å”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œéƒ½æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰§è¡Œ transferForSignalï¼Œ<strong>å…ˆå°†èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º 0ï¼Œç„¶ååŠ å…¥ AQS é˜»å¡é˜Ÿåˆ—å°¾éƒ¨</strong>ï¼Œå°† Thread-3 çš„ waitStatus æ”¹ä¸º -1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// CAS ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¿®æ”¹ä¸º 0ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹é©¬ä¸Šè¦è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ CONDITION, è¯´æ˜çº¿ç¨‹è¢«å–æ¶ˆï¼ˆawait é‡Šæ”¾å…¨éƒ¨é”å¤±è´¥ï¼‰æˆ–è€…è¢«ä¸­æ–­ï¼ˆå¯æ‰“æ–­ cancelAcquireï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="comment">// è¿”å›å‡½æ•°è°ƒç”¨å¤„ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ã€å…ˆæ”¹çŠ¶æ€ï¼Œå†è¿›è¡Œè¿ç§»ã€‘</span></span><br><span class="line">    <span class="comment">// å°†å½“å‰ node å…¥é˜»å¡é˜Ÿåˆ—ï¼Œp æ˜¯å½“å‰èŠ‚ç‚¹åœ¨é˜»å¡é˜Ÿåˆ—çš„ã€å‰é©±èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node);</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹è¢«å–æ¶ˆæˆ–è€…ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNALï¼Œå°± unpark å–æ¶ˆå½“å‰èŠ‚ç‚¹çº¿ç¨‹çš„é˜»å¡çŠ¶æ€,</span></span><br><span class="line">    <span class="comment">// è®© thread-0 çº¿ç¨‹ç«äº‰é”ï¼Œé‡æ–°åŒæ­¥çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F3.png" alt=""></p>
</li>
<li>
<p>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹</p>
</li>
</ul>
<hr>
<h3 id="ReadWrite">ReadWrite</h3>
<h4 id="è¯»å†™é”">è¯»å†™é”</h4>
<p>ç‹¬å é”ï¼šæŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå¯¹ ReentrantLock å’Œ Synchronized è€Œè¨€éƒ½æ˜¯ç‹¬å é”</p>
<p>å…±äº«é”ï¼šæŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹é”æŒæœ‰</p>
<p>ReentrantReadWriteLock å…¶<strong>è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”</strong></p>
<p>ä½œç”¨ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™</p>
<p>ä½¿ç”¨è§„åˆ™ï¼š</p>
<ul>
<li>
<p>åŠ é”è§£é”æ ¼å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">	r.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¯»-è¯»èƒ½å…±å­˜ã€è¯»-å†™ä¸èƒ½å…±å­˜ã€å†™-å†™ä¸èƒ½å…±å­˜</p>
</li>
<li>
<p>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</p>
</li>
<li>
<p><strong>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒ</strong>ï¼šæŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…ï¼Œéœ€è¦å…ˆé‡Šæ”¾è¯»ï¼Œå†å»è·å¾—å†™</p>
</li>
<li>
<p><strong>é‡å…¥æ—¶é™çº§æ”¯æŒ</strong>ï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”ï¼Œé€ æˆåªæœ‰å½“å‰çº¿ç¨‹ä¼šæŒæœ‰è¯»é”ï¼Œå› ä¸ºå†™é”ä¼šäº’æ–¥å…¶ä»–çš„é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">w.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    r.lock();<span class="comment">// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">    	w.unlock();<span class="comment">// è¦åœ¨å†™é”é‡Šæ”¾ä¹‹å‰è·å–è¯»é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">	r.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><code>public ReentrantReadWriteLock()</code>ï¼šé»˜è®¤æ„é€ æ–¹æ³•ï¼Œéå…¬å¹³é”</li>
<li><code>public ReentrantReadWriteLock(boolean fair)</code>ï¼štrue ä¸ºå…¬å¹³é”</li>
</ul>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>public ReentrantReadWriteLock.ReadLock readLock()</code>ï¼šè¿”å›è¯»é”</li>
<li><code>public ReentrantReadWriteLock.WriteLock writeLock()</code>ï¼šè¿”å›å†™é”</li>
<li><code>public void lock()</code>ï¼šåŠ é”</li>
<li><code>public void unlock()</code>ï¼šè§£é”</li>
<li><code>public boolean tryLock()</code>ï¼šå°è¯•è·å–é”</li>
</ul>
<p>è¯»è¯»å¹¶å‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ReentrantReadWriteLock</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">r</span> <span class="operator">=</span> rw.readLock();</span><br><span class="line">    ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">w</span> <span class="operator">=</span> rw.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1 running &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2 running &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ç¼“å­˜åº”ç”¨">ç¼“å­˜åº”ç”¨</h4>
<p>ç¼“å­˜æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ¸…ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“</p>
<ul>
<li>
<p>å…ˆæ¸…ç¼“å­˜ï¼šå¯èƒ½é€ æˆåˆšæ¸…ç†ç¼“å­˜è¿˜æ²¡æœ‰æ›´æ–°æ•°æ®åº“ï¼Œçº¿ç¨‹ç›´æ¥æŸ¥è¯¢äº†æ•°æ®åº“æ›´æ–°è¿‡æœŸæ•°æ®åˆ°ç¼“å­˜</p>
</li>
<li>
<p>å…ˆæ›´æ–°æ®åº“ï¼šå¯èƒ½é€ æˆåˆšæ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ²¡æ¸…ç©ºç¼“å­˜å°±æœ‰çº¿ç¨‹ä»ç¼“å­˜æ‹¿åˆ°äº†æ—§æ•°æ®</p>
</li>
<li>
<p>è¡¥å……æƒ…å†µï¼šæŸ¥è¯¢çº¿ç¨‹ A æŸ¥è¯¢æ•°æ®æ—¶æ°å¥½ç¼“å­˜æ•°æ®ç”±äºæ—¶é—´åˆ°æœŸå¤±æ•ˆï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantReadWriteLock%E7%BC%93%E5%AD%98.png" style="zoom:80%;" />
</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨è¯»å†™é”è¿›è¡Œæ“ä½œ</p>
<hr>
<h4 id="å®ç°åŸç†-6">å®ç°åŸç†</h4>
<h5 id="æˆå‘˜å±æ€§-6">æˆå‘˜å±æ€§</h5>
<p>è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ªï¼ŒåŸç†ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯<strong>å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</strong></p>
<ul>
<li>
<p>è¯»å†™é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ„é€ æ–¹æ³•ï¼šé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œå¯ä»¥æŒ‡å®šå‚æ•°åˆ›å»ºå…¬å¹³é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    <span class="comment">// true ä¸ºå…¬å¹³é”</span></span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">    <span class="comment">// è¿™ä¸¤ä¸ª lock å…±äº«åŒä¸€ä¸ª sync å®ä¾‹ï¼Œéƒ½æ˜¯ç”± ReentrantReadWriteLock çš„ sync æä¾›åŒæ­¥å®ç°</span></span><br><span class="line">    readerLock = <span class="keyword">new</span> <span class="title class_">ReadLock</span>(<span class="built_in">this</span>);</span><br><span class="line">    writerLock = <span class="keyword">new</span> <span class="title class_">WriteLock</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Sync ç±»çš„å±æ€§ï¼š</p>
<ul>
<li>
<p>ç»Ÿè®¡å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥ç§»ä½</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_SHIFT</span>   <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"><span class="comment">// é«˜16ä½çš„1</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_UNIT</span>    <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line"><span class="comment">// 65535ï¼Œ16ä¸ª1ï¼Œä»£è¡¨å†™é”çš„æœ€å¤§é‡å…¥æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_COUNT</span>      <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// ä½16ä½æ©ç ï¼š0b 1111 1111 1111 1111ï¼Œç”¨æ¥è·å–å†™é”é‡å…¥çš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCLUSIVE_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–è¯»å†™é”çš„æ¬¡æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–è¯»å†™é”çš„è¯»é”åˆ†é…çš„æ€»æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">sharedCount</span><span class="params">(<span class="type">int</span> c)</span>    &#123; <span class="keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; &#125;</span><br><span class="line"><span class="comment">// å†™é”ï¼ˆç‹¬å ï¼‰é”çš„é‡å…¥æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">exclusiveCount</span><span class="params">(<span class="type">int</span> c)</span> &#123; <span class="keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å†…éƒ¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®°å½•è¯»é”çº¿ç¨‹è‡ªå·±çš„æŒæœ‰è¯»é”çš„æ•°é‡ï¼ˆé‡å…¥æ¬¡æ•°ï¼‰ï¼Œå› ä¸º state é«˜16ä½è®°å½•çš„æ˜¯å…¨å±€èŒƒå›´å†…æ‰€æœ‰çš„è¯»çº¿ç¨‹è·å–è¯»é”çš„æ€»é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HoldCounter</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Use id, not reference, to avoid garbage retention</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">tid</span> <span class="operator">=</span> getThreadId(Thread.currentThread());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿ç¨‹å®‰å…¨çš„å­˜æ”¾çº¿ç¨‹å„è‡ªçš„ HoldCounter å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalHoldCounter</span> <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> HoldCounter <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HoldCounter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å†…éƒ¨ç±»å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹æŒæœ‰çš„å¯é‡å…¥è¯»é”çš„æ•°é‡ï¼Œè®¡æ•°ä¸º 0 æ—¶åˆ é™¤</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> ThreadLocalHoldCounter readHolds;</span><br><span class="line"><span class="comment">// è®°å½•æœ€åä¸€ä¸ªè·å–ã€è¯»é”ã€‘çº¿ç¨‹çš„ HoldCounter å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HoldCounter cachedHoldCounter;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é¦–æ¬¡è·å–é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">Thread</span> <span class="variable">firstReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// è®°å½•è¯¥çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°ï¼ˆè¯»é”é‡å…¥æ¬¡æ•°ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> firstReaderHoldCount;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Sync æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Sync() &#123;</span><br><span class="line">    readHolds = <span class="keyword">new</span> <span class="title class_">ThreadLocalHoldCounter</span>();</span><br><span class="line">    <span class="comment">// ç¡®ä¿å…¶ä»–çº¿ç¨‹çš„æ•°æ®å¯è§æ€§ï¼Œstate æ˜¯ volatile ä¿®é¥°çš„å˜é‡ï¼Œé‡å†™è¯¥å€¼ä¼šå°†çº¿ç¨‹æœ¬åœ°ç¼“å­˜æ•°æ®ã€åŒæ­¥è‡³ä¸»å­˜ã€‘</span></span><br><span class="line">    setState(getState());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="åŠ é”åŸç†">åŠ é”åŸç†</h5>
<ul>
<li>
<p>t1 çº¿ç¨‹ï¼šw.lockï¼ˆ<strong>å†™é”</strong>ï¼‰ï¼ŒæˆåŠŸä¸Šé” state = 0_1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock()  -&gt; sync.acquire(1);</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•è·å¾—å†™é”ï¼Œè·å¾—å†™é”å¤±è´¥ï¼Œå°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">    <span class="comment">// è¯´æ˜æœ‰è¯»é”æˆ–è€…å†™é”</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”ï¼Œã€è¯»é”ä¸èƒ½å‡çº§ã€‘ï¼Œç›´æ¥è¿”å› false</span></span><br><span class="line">        <span class="comment">// w != 0 è¯´æ˜æœ‰å†™é”ï¼Œå†™é”çš„æ‹¥æœ‰è€…ä¸æ˜¯è‡ªå·±ï¼Œè·å–å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œåªæœ‰ä¸€ç§æƒ…å†µï¼šã€å†™é”é‡å…¥ã€‘ï¼Œæ‰€ä»¥ä¸‹é¢å‡ è¡Œä»£ç ä¸å­˜åœ¨å¹¶å‘</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™é”é‡å…¥, è·å¾—é”æˆåŠŸï¼Œæ²¡æœ‰å¹¶å‘ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ CAS</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// c == 0ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•é”ï¼Œåˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡ï¼Œæ˜¯ false å°±å°è¯•è·å–é”ï¼Œå¤±è´¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() || !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å¾—é”æˆåŠŸï¼Œè®¾ç½®é”çš„æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…¬å¹³é”ä¼šæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>t2 r.lockï¼ˆ<strong>è¯»é”</strong>ï¼‰ï¼Œè¿›å…¥ tryAcquireShared æµç¨‹ï¼š</p>
<ul>
<li>è¿”å› -1 è¡¨ç¤ºå¤±è´¥</li>
<li>å¦‚æœè¿”å› 0 è¡¨ç¤ºæˆåŠŸ</li>
<li>è¿”å›æ­£æ•°è¡¨ç¤ºè¿˜æœ‰å¤šå°‘åç»§èŠ‚ç‚¹æ”¯æŒå…±äº«æ¨¡å¼ï¼Œè¯»å†™é”è¿”å› 1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.acquireShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è¯•ä»¥å…±äº«æ¨¡å¼è·å–</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// exclusiveCount(c) ä»£è¡¨ä½ 16 ä½, å†™é”çš„ stateï¼Œæˆç«‹è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span></span><br><span class="line">    <span class="comment">// å†™é”çš„æŒæœ‰è€…ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è·å–è¯»é”å¤±è´¥ï¼Œã€å†™é”å…è®¸é™çº§ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é«˜ 16 ä½ï¼Œä»£è¡¨è¯»é”çš„ stateï¼Œå…±äº«é”åˆ†é…å‡ºå»çš„æ€»æ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">    <span class="comment">// è¯»é”æ˜¯å¦åº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;	r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;	<span class="comment">// å°è¯•å¢åŠ è¯»é”è®¡æ•°</span></span><br><span class="line">        <span class="comment">// åŠ é”æˆåŠŸ</span></span><br><span class="line">        <span class="comment">// åŠ é”ä¹‹å‰è¯»é”ä¸º 0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">            firstReader = current;</span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹æ˜¯è‡ªå·±å°±å‘ç”Ÿäº†è¯»é”é‡å…¥</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// cachedHoldCounter è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹çš„ holdCounter å¯¹è±¡ï¼Œå³æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">            <span class="comment">// è¯´æ˜è¿˜æ²¡è®¾ç½® rh</span></span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„é”é‡å…¥çš„å¯¹è±¡ï¼Œèµ‹å€¼ç»™ cachedHoldCounter</span></span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="comment">// è¿˜æ²¡é‡å…¥</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            <span class="comment">// é‡å…¥ + 1</span></span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯»é”åŠ é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€»è¾‘åˆ°è¿™ åº”è¯¥é˜»å¡ï¼Œæˆ–è€… cas åŠ é”å¤±è´¥</span></span><br><span class="line">    <span class="comment">// ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡</span></span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éå…¬å¹³é” readerShouldBlock åå‘å†™é”ä¸€äº›ï¼Œçœ‹ AQS é˜»å¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”ï¼Œæ˜¯åˆ™é˜»å¡ï¼Œåä¹‹ä¸é˜»å¡</span></span><br><span class="line"><span class="comment">// é˜²æ­¢ä¸€ç›´æœ‰è¯»é”çº¿ç¨‹ï¼Œå¯¼è‡´å†™é”çº¿ç¨‹é¥¥é¥¿</span></span><br><span class="line"><span class="comment">// true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> apparentlyFirstQueuedIsExclusive();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullTryAcquireShared</span><span class="params">(Thread current)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰è¯»é”çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°å¯¹è±¡</span></span><br><span class="line">    <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span></span><br><span class="line">        <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å†™é”ä¸æ˜¯è‡ªå·±åˆ™è·å–é”å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readerShouldBlock()) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ firstReaderï¼Œå½“å‰é”æ˜¯è¯»å¿™ç¢ŒçŠ¶æ€ï¼Œè€Œä¸”å½“å‰çº¿ç¨‹ä¹Ÿæ˜¯è¯»é”é‡å…¥</span></span><br><span class="line">            <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                <span class="comment">// assert firstReaderHoldCount &gt; 0;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// æœ€åä¸€ä¸ªè¯»é”çš„ HoldCounter</span></span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                    <span class="comment">// è¯´æ˜å½“å‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æœ€åä¸€ä¸ªè¯»é”</span></span><br><span class="line">                    <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current)) &#123;</span><br><span class="line">                        <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ HoldCounter</span></span><br><span class="line">                        rh = readHolds.get();</span><br><span class="line">                        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ HoldCounter å¯¹è±¡æ˜¯ä¸Šä¸€æ­¥ä»£ç æ–°å»ºçš„</span></span><br><span class="line">                        <span class="comment">// å½“å‰çº¿ç¨‹ä¸æ˜¯é”é‡å…¥ï¼Œåœ¨ readerShouldBlock() è¿”å› true æ—¶éœ€è¦å»æ’é˜Ÿ</span></span><br><span class="line">                        <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                            <span class="comment">// é˜²æ­¢å†…å­˜æ³„æ¼</span></span><br><span class="line">                            readHolds.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¶Šç•Œåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (sharedCount(c) == MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// è¯»é”åŠ é”ï¼Œæ¡ä»¶å†…çš„é€»è¾‘ä¸ tryAcquireShared ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sharedCount(c) == <span class="number">0</span>) &#123;</span><br><span class="line">                firstReader = current;</span><br><span class="line">                firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                firstReaderHoldCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="literal">null</span>)</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                    rh = readHolds.get();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    readHolds.set(rh);</span><br><span class="line">                rh.count++;</span><br><span class="line">                cachedHoldCounter = rh; <span class="comment">// cache for release</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ sync.doAcquireShared(1) æµç¨‹å¼€å§‹é˜»å¡ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º Node.SHARED æ¨¡å¼è€Œé Node.EXCLUSIVE æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹å°±å¤´èŠ‚ç‚¹å°±å»å°è¯•è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†ä¸€æ¬¡å°è¯•è·å–è¯»é”</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="comment">// r &gt;= 0 è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//ã€è¿™é‡Œä¼šè®¾ç½®è‡ªå·±ä¸ºå¤´èŠ‚ç‚¹ï¼Œå”¤é†’ç›¸è¿çš„ååºçš„å…±äº«èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡      					 park å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;;) å¾ªç¯ä¸€æ¬¡ï¼ŒshouldParkAfterFailedAcquire å†…æŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€æ¬¡å°è¯• tryAcquireSharedï¼Œä¸æˆåŠŸåœ¨ parkAndCheckInterrupt() å¤„ park</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantReadWriteLock%E5%8A%A0%E9%94%811.png" style="zoom: 80%;" />
</li>
<li>
<p>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 r.lockï¼Œt4 w.lockï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantReadWriteLock%E5%8A%A0%E9%94%812.png" alt=""></p>
</li>
</ul>
<hr>
<h5 id="è§£é”åŸç†">è§£é”åŸç†</h5>
<ul>
<li>
<p>t1 w.unlockï¼Œ å†™é”è§£é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”ä¸æ˜¯ç­‰å¾…çŠ¶æ€ä¸æ˜¯ 0ï¼Œå”¤é†’åç»§çš„éå–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="comment">// å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (free)</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared çš„ parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œç»§ç»­å¾ªç¯ï¼Œæ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p>
</li>
<li>
<p>æ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼›è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œ<strong>å”¤é†’è¿ç»­çš„æ‰€æœ‰çš„å…±äº«èŠ‚ç‚¹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰ï¼Œä¸º 0 å°±æ²¡æœ‰èµ„æº</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ã€ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">	<span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="comment">// SIGNAL å”¤é†’åç»§</span></span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// å› ä¸ºè¯»é”å…±äº«ï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0</span></span><br><span class="line">            	<span class="comment">// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„ headï¼Œ</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h == head)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantReadWriteLock%E8%A7%A3%E9%94%811.png" style="zoom: 67%;" />
</li>
<li>
<p>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</p>
</li>
<li>
<p>t2 è¯»é”è§£é”ï¼Œè¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†è®¡æ•°è¿˜ä¸ä¸ºé›¶ï¼Œt3 åŒæ ·è®©è®¡æ•°å‡ä¸€ï¼Œè®¡æ•°ä¸ºé›¶ï¼Œè¿›å…¥ doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c - SHARED_UNIT;</span><br><span class="line">        <span class="comment">// è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹ï¼Œè®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// è¿”å›æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾äº†</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯å¤´èŠ‚ç‚¹çš„ä¸´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ReentrantReadWriteLock%E8%A7%A3%E9%94%812.png" style="zoom: 67%;" />
</li>
</ul>
<hr>
<h4 id="Stamped">Stamped</h4>
<p>StampedLockï¼šè¯»å†™é”ï¼Œè¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>
<p>åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆæˆ³ä½¿ç”¨</p>
</li>
<li>
<p>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡</p>
</li>
<li>
<p>StampedLock <strong>ä¸æ”¯æŒé‡å…¥</strong></p>
</li>
</ul>
<p>åŸºæœ¬ç”¨æ³•</p>
<ul>
<li>
<p>åŠ è§£è¯»é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);			<span class="comment">// ç±»ä¼¼äº unparkï¼Œè§£æŒ‡å®šçš„é”</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åŠ è§£å†™é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">lock.unlockWrite(stamp);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ <code>tryOptimisticRead()</code> æ–¹æ³•ï¼Œè¯»å–å®Œæ¯•ååšä¸€æ¬¡<strong>æˆ³æ ¡éªŒ</strong>ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line"><span class="comment">// éªŒæˆ³</span></span><br><span class="line"><span class="keyword">if</span>(!lock.validate(stamp))&#123;</span><br><span class="line">	<span class="comment">// é”å‡çº§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æä¾›ä¸€ä¸ªæ•°æ®å®¹å™¨ç±»å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•ï¼š</p>
<ul>
<li>è¯»-è¯»å¯ä»¥ä¼˜åŒ–</li>
<li>è¯»-å†™ä¼˜åŒ–è¯»ï¼Œè¡¥åŠ è¯»é”</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">DataContainerStamped</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainerStamped</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    	dataContainer.read(<span class="number">1000</span>);</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.write(<span class="number">1000</span>);</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainerStamped</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> readTime)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; optimistic read locking&quot;</span> + stamp);</span><br><span class="line">        Thread.sleep(readTime);</span><br><span class="line">        <span class="comment">// æˆ³æœ‰æ•ˆï¼Œç›´æ¥è¿”å›æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (lock.validate(stamp)) &#123;</span><br><span class="line">            Sout(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; optimistic read finish...&quot;</span> + stamp);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯´æ˜å…¶ä»–çº¿ç¨‹æ›´æ”¹äº†æˆ³ï¼Œéœ€è¦é”å‡çº§äº†ï¼Œä»ä¹è§‚è¯»å‡çº§åˆ°è¯»é”</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; updating to read lock&quot;</span> + stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; read lock&quot;</span> + stamp);</span><br><span class="line">            Thread.sleep(readTime);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; read finish...&quot;</span> + stamp);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; read unlock &quot;</span> +  stamp);</span><br><span class="line">            lock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> newData)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; write lock &quot;</span> + stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="built_in">this</span>.data = newData;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; write unlock &quot;</span> + stamp);</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="CountDown">CountDown</h3>
<h4 id="åŸºæœ¬ä½¿ç”¨-8">åŸºæœ¬ä½¿ç”¨</h4>
<p>CountDownLatchï¼šè®¡æ•°å™¨ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œ<strong>ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ</strong></p>
<p>æ„é€ å™¨ï¼š</p>
<ul>
<li><code>public CountDownLatch(int count)</code>ï¼šåˆå§‹åŒ–å”¤é†’éœ€è¦çš„ down å‡ æ­¥</li>
</ul>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>public void await() </code>ï¼šè®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œå¿…é¡» down å®Œåˆå§‹åŒ–çš„æ•°å­—æ‰å¯ä»¥è¢«å”¤é†’ï¼Œå¦åˆ™è¿›å…¥æ— é™ç­‰å¾…</li>
<li><code>public void countDown()</code>ï¼šè®¡æ•°å™¨è¿›è¡Œå‡ 1ï¼ˆdown 1ï¼‰</li>
</ul>
<p>åº”ç”¨ï¼šåŒæ­¥ç­‰å¾…å¤šä¸ª Rest è¿œç¨‹è°ƒç”¨ç»“æŸ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOL 10äººè¿›å…¥æ¸¸æˆå€’è®¡æ—¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    String[] all = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalJ</span> <span class="operator">=</span> j;<span class="comment">//å¸¸é‡</span></span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(random.nextInt(<span class="number">100</span>));	<span class="comment">//éšæœºä¼‘çœ </span></span><br><span class="line">                all[finalJ] = i + <span class="string">&quot;%&quot;</span>;</span><br><span class="line">                System.out.print(<span class="string">&quot;\r&quot;</span> + Arrays.toString(all));	<span class="comment">// \rä»£è¡¨è¦†ç›–</span></span><br><span class="line">            &#125;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.await();</span><br><span class="line">    System.out.println(<span class="string">&quot;\næ¸¸æˆå¼€å§‹&quot;</span>);</span><br><span class="line">    service.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]</span></span><br><span class="line"><span class="comment">æ¸¸æˆå¼€å§‹</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å®ç°åŸç†-7">å®ç°åŸç†</h4>
<p>é˜»å¡ç­‰å¾…ï¼š</p>
<ul>
<li>
<p>çº¿ç¨‹è°ƒç”¨ await() ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼šæ”¯æŒæ‰“æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AbstractQueuedSynchronizer#acquireSharedInterruptibly</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼ŒæŠ›å‡ºæ‰“æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°è¯•è·å–å…±äº«é”ï¼Œæ¡ä»¶æˆç«‹è¯´æ˜ state &gt; 0ï¼Œæ­¤æ—¶çº¿ç¨‹å…¥é˜Ÿé˜»å¡ç­‰å¾…ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹è·å–å…±äº«èµ„æº</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜ state = 0ï¼Œæ­¤æ—¶ä¸éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œç›´æ¥ç»“æŸå‡½æ•°è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CountDownLatch.Sync#tryAcquireShared</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çº¿ç¨‹è¿›å…¥ AbstractQueuedSynchronizer#doAcquireSharedInterruptibly å‡½æ•°é˜»å¡æŒ‚èµ·ï¼Œç­‰å¾… latch å˜ä¸º 0ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// å°†è°ƒç”¨latch.await()æ–¹æ³•çš„çº¿ç¨‹ åŒ…è£…æˆ SHARED ç±»å‹çš„ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹æ—¶å¤´èŠ‚ç‚¹å°±å¯ä»¥å°è¯•è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡å°è¯•è·å–é”ï¼Œè·å–æˆåŠŸè¿”å› 1</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// è·å–é”æˆåŠŸï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸”å‘åä¼ æ’­</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é˜»å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­åæŠ›å‡ºå¼‚å¸¸ï¼Œè¿›å…¥å–æ¶ˆèŠ‚ç‚¹çš„é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·å–å…±äº«é”æˆåŠŸï¼Œè¿›å…¥å”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­ä¸å¤´èŠ‚ç‚¹ç›¸è¿çš„ SHARED æ¨¡å¼çš„èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„ head èŠ‚ç‚¹ï¼Œå‰é©±èŠ‚ç‚¹å’ŒæŒæœ‰çº¿ç¨‹ç½®ä¸º null</span></span><br><span class="line">    setHead(node);</span><br><span class="line">	<span class="comment">// propagate = 1ï¼Œæ¡ä»¶ä¸€æˆç«‹</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> || (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶ next ä¸º nullï¼Œæˆ–è€…åç»§èŠ‚ç‚¹æ˜¯ SHARED å…±äº«æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            <span class="comment">// å”¤é†’æ‰€æœ‰çš„ç­‰å¾…å…±äº«é”çš„èŠ‚ç‚¹</span></span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>è®¡æ•°å‡ä¸€ï¼š</p>
<ul>
<li>
<p>çº¿ç¨‹è¿›å…¥ countDown() å®Œæˆè®¡æ•°å™¨å‡ä¸€ï¼ˆé‡Šæ”¾é”ï¼‰çš„æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countDown</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾å…±äº«é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”æˆåŠŸå¼€å§‹å”¤é†’é˜»å¡èŠ‚ç‚¹</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ›´æ–° state å€¼ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ï¼Œstate å€¼å‡ä¸€ï¼Œå½“ state -1 æ­£å¥½ä¸º 0 æ—¶ï¼Œè¿”å› true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å‰é¢ã€å·²ç»æœ‰çº¿ç¨‹è§¦å‘å”¤é†’æ“ä½œã€‘äº†ï¼Œè¿™é‡Œè¿”å› false</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// è®¡æ•°å™¨å‡ä¸€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨ä¸º 0 æ—¶è¿”å› true</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>state = 0 æ—¶ï¼Œå½“å‰çº¿ç¨‹éœ€è¦æ‰§è¡Œ<strong>å”¤é†’é˜»å¡èŠ‚ç‚¹çš„ä»»åŠ¡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ˜¯ç©ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="comment">// å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º signalï¼Œè¯´æ˜åç»§èŠ‚ç‚¹æ²¡æœ‰è¢«å”¤é†’è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// cas è®¾ç½®å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º 0ï¼Œè®¾ç½®å¤±è´¥ç»§ç»­è‡ªæ—‹</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å·²ç»è®¾ç½®äº†å¤´èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œé‡æ–°è®¾ç½®ä¸º PROPAGATE ä¼ æ’­å±æ€§</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„headï¼Œ</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h == head)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="CyclicBarrier">CyclicBarrier</h3>
<h4 id="åŸºæœ¬ä½¿ç”¨-9">åŸºæœ¬ä½¿ç”¨</h4>
<p>CyclicBarrierï¼šå¾ªç¯å±éšœï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ï¼Œæ‰èƒ½è§¦å‘è‡ªå·±æ‰§è¡Œ</p>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>public CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼šç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœ parties æ—¶ï¼Œæ‰§è¡Œ barrierAction
<ul>
<li>partiesï¼šä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡</li>
<li>barrierActionï¼šçº¿ç¨‹ä»»åŠ¡</li>
</ul>
</li>
<li><code>public int await()</code>ï¼šçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•é€šçŸ¥ CyclicBarrier æœ¬çº¿ç¨‹å·²ç»åˆ°è¾¾å±éšœ</li>
</ul>
<p>ä¸ CountDownLatch çš„åŒºåˆ«ï¼šCyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„</p>
<p>åº”ç”¨ï¼šå¯ä»¥å®ç°å¤šçº¿ç¨‹ä¸­ï¼ŒæŸä¸ªä»»åŠ¡åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä»¥åè§¦å‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>, () -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task1 task2 finish...&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123; <span class="comment">// å¾ªç¯é‡ç”¨</span></span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task1 begin...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                barrier.await();    <span class="comment">// 2 - 1 = 1</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task2 begin...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                barrier.await();    <span class="comment">// 1 - 1 = 0</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    service.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å®ç°åŸç†-8">å®ç°åŸç†</h4>
<h5 id="æˆå‘˜å±æ€§-7">æˆå‘˜å±æ€§</h5>
<ul>
<li>
<p>å…¨å±€é”ï¼šåˆ©ç”¨å¯é‡å…¥é”å®ç°çš„å·¥å…·ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// barrier å®ç°æ˜¯ä¾èµ–äºConditionæ¡ä»¶é˜Ÿåˆ—ï¼Œcondition æ¡ä»¶é˜Ÿåˆ—å¿…é¡»ä¾èµ–lockæ‰èƒ½ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">// çº¿ç¨‹æŒ‚èµ·å®ç°ä½¿ç”¨çš„ condition é˜Ÿåˆ—ï¼Œå½“å‰ä»£æ‰€æœ‰çº¿ç¨‹åˆ°ä½ï¼Œè¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">trip</span> <span class="operator">=</span> lock.newCondition();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çº¿ç¨‹æ•°é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> parties;	<span class="comment">// ä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> count;			<span class="comment">// è¡¨ç¤ºå½“å‰â€œä»£â€è¿˜æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æœªåˆ°ä½ï¼Œåˆå§‹å€¼ä¸º parties</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å½“å‰ä»£ä¸­æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½åè¦æ‰§è¡Œçš„äº‹ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable barrierCommand;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä»£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤º barrier å¯¹è±¡å½“å‰ ä»£</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Generation</span> <span class="variable">generation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Generation</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Generation</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰â€œä»£â€æ˜¯å¦è¢«æ‰“ç ´ï¼Œå¦‚æœè¢«æ‰“ç ´å†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ å°±ä¼šç›´æ¥æŠ›å‡º BrokenException å¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// ä¸”åœ¨è¿™ä¸€ä»£æŒ‚èµ·çš„çº¿ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œç„¶åæŠ›å‡º BrokerException å¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">broken</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CyclicBarrie</span><span class="params">(<span class="type">int</span> parties, Runnable barrierAction)</span> &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºå°äºç­‰äº 0 çš„ barrier æ²¡æœ‰ä»»ä½•æ„ä¹‰</span></span><br><span class="line">    <span class="keyword">if</span> (parties &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.parties = parties;</span><br><span class="line">    <span class="built_in">this</span>.count = parties;</span><br><span class="line">    <span class="comment">// å¯ä»¥ä¸º null</span></span><br><span class="line">    <span class="built_in">this</span>.barrierCommand = barrierAction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-CyclicBarrier%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png" style="zoom: 80%;" />
<hr>
<h5 id="æˆå‘˜æ–¹æ³•-6">æˆå‘˜æ–¹æ³•</h5>
<ul>
<li>
<p>await()ï¼šé˜»å¡ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°ä½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dowait(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(toe); <span class="comment">// cannot happen</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timedï¼šè¡¨ç¤ºå½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æŒ‡å®šäº†è¶…æ—¶æ—¶é•¿ï¼Œå¦‚æœ true è¡¨ç¤ºçº¿ç¨‹æ˜¯å“åº”è¶…æ—¶çš„</span></span><br><span class="line"><span class="comment">// nanosï¼šçº¿ç¨‹ç­‰å¾…è¶…æ—¶æ—¶é•¿ï¼Œå•ä½æ˜¯çº³ç§’</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">dowait</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ä»£</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Generation</span> <span class="variable">g</span> <span class="operator">=</span> generation;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€å¦‚æœå½“å‰ä»£æ˜¯å·²ç»è¢«æ‰“ç ´çŠ¶æ€ï¼Œåˆ™å½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºBrokenå¼‚å¸¸ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (g.broken)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BrokenBarrierException</span>();</span><br><span class="line">		<span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œåˆ™æ‰“ç ´å½“å‰ä»£ï¼Œç„¶åå½“å‰çº¿ç¨‹æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å½“å‰ä»£çš„çŠ¶æ€ä¸º broken çŠ¶æ€ï¼Œå”¤é†’åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹</span></span><br><span class="line">            breakBarrier();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜ï¼Œå½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€æ˜¯ falseï¼Œ å½“å‰ä»£çš„ broken ä¸º falseï¼ˆæœªæ‰“ç ´çŠ¶æ€ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡è®¾ parties ç»™çš„æ˜¯ 5ï¼Œé‚£ä¹ˆindexå¯¹åº”çš„å€¼ä¸º 4,3,2,1,0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> --count;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾ barrier çš„çº¿ç¨‹ï¼Œã€éœ€è¦å¼€å¯æ–°ä»£ï¼Œå”¤é†’é˜»å¡çº¿ç¨‹ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// æ …æ ä»»åŠ¡å¯åŠ¨æ ‡è®°</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">ranAction</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">command</span> <span class="operator">=</span> barrierCommand;</span><br><span class="line">                <span class="keyword">if</span> (command != <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// å¯åŠ¨è§¦å‘çš„ä»»åŠ¡</span></span><br><span class="line">                    command.run();</span><br><span class="line">                <span class="comment">// run()æœªæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œå¯åŠ¨æ ‡è®°è®¾ç½®ä¸º true</span></span><br><span class="line">                ranAction = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// å¼€å¯æ–°çš„ä¸€ä»£ï¼Œè¿™é‡Œä¼šã€å”¤é†’æ‰€æœ‰çš„é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">                nextGeneration();</span><br><span class="line">                <span class="comment">// è¿”å› 0 å› ä¸ºå½“å‰çº¿ç¨‹æ˜¯æ­¤ä»£æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œindex == 0</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ command.run() æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œä¼šè¿›å…¥åˆ°è¿™é‡Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‡ªæ—‹ï¼Œä¸€ç›´åˆ°æ¡ä»¶æ»¡è¶³ã€å½“å‰ä»£è¢«æ‰“ç ´ã€çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç­‰å¾…è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ ¹æ®æ˜¯å¦éœ€è¦è¶…æ—¶ç­‰å¾…é€‰æ‹©é˜»å¡æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                    <span class="comment">// å½“å‰çº¿ç¨‹é‡Šæ”¾æ‰ lockï¼Œã€è¿›å…¥åˆ° trip æ¡ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨æŒ‚èµ·è‡ªå·±ã€‘ï¼Œç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line">                    trip.await();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                <span class="comment">// è¢«ä¸­æ–­åæ¥åˆ°è¿™é‡Œçš„é€»è¾‘</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// å½“å‰ä»£æ²¡æœ‰å˜åŒ–å¹¶ä¸”æ²¡æœ‰è¢«æ‰“ç ´</span></span><br><span class="line">                <span class="keyword">if</span> (g == generation &amp;&amp; !g.broken) &#123;</span><br><span class="line">                    <span class="comment">// æ‰“ç ´å±éšœ</span></span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    <span class="comment">// node èŠ‚ç‚¹åœ¨ã€æ¡ä»¶é˜Ÿåˆ—ã€‘å†…æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">                    <span class="keyword">throw</span> ie;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ç­‰å¾…è¿‡ç¨‹ä¸­ä»£å˜åŒ–äº†ï¼Œå®Œæˆä¸€æ¬¡è‡ªæˆ‘æ‰“æ–­</span></span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// å”¤é†’åçš„çº¿ç¨‹ï¼Œã€åˆ¤æ–­å½“å‰ä»£å·²ç»è¢«æ‰“ç ´ï¼Œçº¿ç¨‹å”¤é†’åä¾æ¬¡æŠ›å‡º BrokenBarrier å¼‚å¸¸ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (g.broken)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BrokenBarrierException</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æŒ‚èµ·æœŸé—´ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½äº†ï¼Œç„¶åè§¦å‘äº†å¼€å¯æ–°çš„ä¸€ä»£çš„é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (g != generation)</span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line">			<span class="comment">// å½“å‰çº¿ç¨‹ trip ä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                <span class="comment">// æŠ›å‡ºè¶…æ—¶å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>breakBarrier()ï¼šæ‰“ç ´ Barrier å±éšœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">breakBarrier</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å°†ä»£ä¸­çš„ broken è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºè¿™ä¸€ä»£æ˜¯è¢«æ‰“ç ´äº†ï¼Œå†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    generation.broken = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// é‡ç½® count ä¸º parties</span></span><br><span class="line">    count = parties;</span><br><span class="line">    <span class="comment">// å°†åœ¨tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’ï¼Œå”¤é†’åçš„çº¿ç¨‹ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯æ‰“ç ´çš„ï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>nextGeneration()ï¼šå¼€å¯æ–°çš„ä¸‹ä¸€ä»£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">nextGeneration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å°†åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">    <span class="comment">// é‡ç½® count ä¸º parties</span></span><br><span class="line">    count = parties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å¯æ–°çš„ä¸€ä»£ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„generationå¯¹è±¡ï¼Œè¡¨ç¤ºæ–°çš„ä¸€ä»£ï¼Œæ–°çš„ä¸€ä»£å’Œä¸Šä¸€ä»£ã€æ²¡æœ‰ä»»ä½•å…³ç³»ã€‘</span></span><br><span class="line">    generation = <span class="keyword">new</span> <span class="title class_">Generation</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p>
<hr>
<h3 id="Semaphore">Semaphore</h3>
<h4 id="åŸºæœ¬ä½¿ç”¨-10">åŸºæœ¬ä½¿ç”¨</h4>
<p>synchronized å¯ä»¥èµ·åˆ°é”çš„ä½œç”¨ï¼Œä½†æŸä¸ªæ—¶é—´æ®µå†…ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</p>
<p>Semaphoreï¼ˆä¿¡å·é‡ï¼‰ç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ï¼Œéé‡å…¥é”</p>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><code>public Semaphore(int permits)</code>ï¼špermits è¡¨ç¤ºè®¸å¯çº¿ç¨‹çš„æ•°é‡ï¼ˆstateï¼‰</li>
<li><code>public Semaphore(int permits, boolean fair)</code>ï¼šfair è¡¨ç¤ºå…¬å¹³æ€§ï¼Œå¦‚æœè®¾ä¸º trueï¼Œä¸‹æ¬¡æ‰§è¡Œçš„çº¿ç¨‹ä¼šæ˜¯ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹</li>
</ul>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>public void acquire()</code>ï¼šè¡¨ç¤ºè·å–è®¸å¯</li>
<li><code>public void release()</code>ï¼šè¡¨ç¤ºé‡Šæ”¾è®¸å¯ï¼Œacquire() å’Œ release() æ–¹æ³•ä¹‹é—´çš„ä»£ç ä¸ºåŒæ­¥ä»£ç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºSemaphoreå¯¹è±¡</span></span><br><span class="line">    <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3. è·å–è®¸å¯</span></span><br><span class="line">                semaphore.acquire();</span><br><span class="line">                sout(Thread.currentThread().getName() + <span class="string">&quot; running...&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                sout(Thread.currentThread().getName() + <span class="string">&quot; end...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 4. é‡Šæ”¾è®¸å¯</span></span><br><span class="line">                semaphore.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å®ç°åŸç†-9">å®ç°åŸç†</h4>
<p>åŠ é”æµç¨‹ï¼š</p>
<ul>
<li>
<p>Semaphore çš„ permitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sync(<span class="type">int</span> <span class="keyword">permits</span>) &#123;</span><br><span class="line">    setState(<span class="keyword">permits</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 CAS ç«äº‰æˆåŠŸï¼Œpermits å˜ä¸º 0ï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ— park é˜»å¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// acquire() -&gt; sync.acquireSharedInterruptibly(1)ï¼Œå¯ä¸­æ–­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°è¯•è·å–é€šè¡Œè¯ï¼Œè·å–æˆåŠŸè¿”å› &gt;= 0çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// è·å–è®¸å¯è¯å¤±è´¥ï¼Œè¿›å…¥é˜»å¡</span></span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tryAcquireShared() -&gt; nonfairTryAcquireShared()</span></span><br><span class="line"><span class="comment">// éå…¬å¹³ï¼Œå…¬å¹³é”ä¼šåœ¨å¾ªç¯å†… hasQueuedPredecessors()æ–¹æ³•åˆ¤æ–­é˜»å¡é˜Ÿåˆ—æ˜¯å¦æœ‰ä¸´å¤´èŠ‚ç‚¹(ç¬¬äºŒä¸ªèŠ‚ç‚¹)</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nonfairTryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å– state ï¼Œstate è¿™é‡Œã€è¡¨ç¤ºé€šè¡Œè¯ã€‘</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// è®¡ç®—å½“å‰çº¿ç¨‹è·å–é€šè¡Œè¯å®Œæˆä¹‹åï¼Œé€šè¡Œè¯è¿˜å‰©ä½™æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥,</span></span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// è®¸å¯è¯è¶³å¤Ÿåˆ†é…çš„ï¼Œå¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†è°ƒç”¨ Semaphore.aquire æ–¹æ³•çš„çº¿ç¨‹ï¼ŒåŒ…è£…æˆ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="comment">// è·å–æ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹å¯ä»¥å†æ¬¡è·å–è®¸å¯</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡å°è¯•è·å–è®¸å¯ï¼Œã€è¿”å›å‰©ä½™çš„è®¸å¯è¯æ•°é‡ã€‘</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head</span></span><br><span class="line">                    <span class="comment">// r è¡¨ç¤ºã€å¯ç”¨èµ„æºæ•°ã€‘, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// è¢«æ‰“æ–­åè¿›å…¥è¯¥é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰ã€å…±äº«èµ„æºã€‘ï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATEï¼ŒdoReleaseShared å‡½æ•°ä¸­è®¾ç½®çš„</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-Semaphore%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B1.png" alt=""></p>
</li>
<li>
<p>è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// release() -&gt; releaseShared()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é”èµ„æºçš„å¯ç”¨è®¸å¯è¯æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">        <span class="comment">// ç´¢å¼•è¶Šç•Œåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (next &lt; current)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// PROPAGATE è¯¦è§£</span></span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-Semaphore%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B2.png" alt=""></p>
</li>
<li>
<p>æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸” unpark æ¥ä¸‹æ¥çš„å…±äº«çŠ¶æ€çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</p>
</li>
</ul>
<hr>
<h4 id="PROPAGATE">PROPAGATE</h4>
<p>å‡è®¾å­˜åœ¨æŸæ¬¡å¾ªç¯ä¸­é˜Ÿåˆ—é‡Œæ’é˜Ÿçš„ç»“ç‚¹æƒ…å†µä¸º <code>head(-1) â†’ t1(-1) â†’ t2(0)</code>ï¼Œå­˜åœ¨å°†è¦é‡Šæ”¾ä¿¡å·é‡çš„ T3 å’Œ T4ï¼Œé‡Šæ”¾é¡ºåºä¸ºå…ˆ T3 å T4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è€ç‰ˆæœ¬ä»£ç </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// æœ‰ç©ºé—²èµ„æº</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> &amp;&amp; node.waitStatus != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// ä¸‹ä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­£å¸¸æµç¨‹ï¼š</p>
<ul>
<li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li>
<li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œç„¶å T4 é‡Šæ”¾ï¼Œå”¤é†’ T2</li>
</ul>
<p>BUG æµç¨‹ï¼š</p>
<ul>
<li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li>
<li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰</li>
<li>T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared(1)ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤ä¸è°ƒç”¨ unparkSuccessor(head)</li>
<li>T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate(t1.node, 0) æ—¶ï¼Œå› ä¸ºä¸æ»¡è¶³ propagate &gt; 0ï¼ˆå‰©ä½™èµ„æºé‡ == 0ï¼‰ï¼Œä»è€Œä¸ä¼šå”¤é†’åç»§ç»“ç‚¹ï¼Œ <strong>T2 çº¿ç¨‹å¾—ä¸åˆ°å”¤é†’</strong></li>
</ul>
<p>æ›´æ–°åæµç¨‹ï¼š</p>
<ul>
<li>
<p>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</p>
</li>
<li>
<p>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰</p>
</li>
<li>
<p>T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared()ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œè°ƒç”¨ doReleaseShared() å°†ç­‰å¾…çŠ¶æ€ç½®ä¸º <strong>PROPAGATEï¼ˆ-3ï¼‰</strong></p>
</li>
<li>
<p>T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate æ—¶ï¼Œè¯»åˆ° h.waitStatus &lt; 0ï¼Œä»è€Œè°ƒç”¨ doReleaseShared() å”¤é†’ T2</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Exchanger">Exchanger</h3>
<p>Exchangerï¼šäº¤æ¢å™¨ï¼Œæ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ï¼Œç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢</p>
<p>å·¥ä½œæµç¨‹ï¼šä¸¤ä¸ªçº¿ç¨‹é€šè¿‡ exchange æ–¹æ³•äº¤æ¢æ•°æ®ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ exchange() æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œ exchange æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®</p>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>public Exchanger()</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ¢å™¨</li>
<li><code>public V exchange(V x)</code>ï¼šç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ­¤äº¤æ¢ç‚¹</li>
<li><code>public V exchange(V x, long timeout, TimeUnit unit)</code>ï¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExchangerDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºäº¤æ¢å¯¹è±¡ï¼ˆä¿¡ä½¿ï¼‰</span></span><br><span class="line">        Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadA</span>(exchanger).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadB</span>(exchanger).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadA</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Exchanger&lt;String&gt; <span class="title function_">exchanger</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadA</span><span class="params">(Exchanger&lt;String&gt; exchanger)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.exchanger = exchanger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹Aï¼Œåšå¥½äº†ç¤¼ç‰©Aï¼Œç­‰å¾…çº¿ç¨‹Bé€æ¥çš„ç¤¼ç‰©B&quot;</span>);</span><br><span class="line">            <span class="comment">//å¦‚æœç­‰å¾…äº†5sè¿˜æ²¡æœ‰äº¤æ¢å°±æ­»äº¡ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> exchanger.exchange(<span class="string">&quot;ç¤¼ç‰©A&quot;</span>,<span class="number">5</span>,TimeUnit.SECONDS);</span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹Aæ”¶åˆ°çº¿ç¨‹Bçš„ç¤¼ç‰©ï¼š&quot;</span> + s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹Aç­‰å¾…äº†5sï¼Œæ²¡æœ‰æ”¶åˆ°ç¤¼ç‰©,æœ€ç»ˆå°±æ‰§è¡Œç»“æŸäº†!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadB</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Exchanger&lt;String&gt; exchanger;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadB</span><span class="params">(Exchanger&lt;String&gt; exchanger)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exchanger = exchanger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹B,åšå¥½äº†ç¤¼ç‰©B,ç­‰å¾…çº¿ç¨‹Aé€æ¥çš„ç¤¼ç‰©A.....&quot;</span>);</span><br><span class="line">            <span class="comment">// å¼€å§‹äº¤æ¢ç¤¼ç‰©ã€‚å‚æ•°æ˜¯é€ç»™å…¶ä»–çº¿ç¨‹çš„ç¤¼ç‰©!</span></span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹Bæ”¶åˆ°çº¿ç¨‹Açš„ç¤¼ç‰©ï¼š&quot;</span> + exchanger.exchange(<span class="string">&quot;ç¤¼ç‰©B&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="å¹¶å‘åŒ…">å¹¶å‘åŒ…</h2>
<h3 id="ConHashMap">ConHashMap</h3>
<h4 id="å¹¶å‘é›†åˆ">å¹¶å‘é›†åˆ</h4>
<h5 id="é›†åˆå¯¹æ¯”">é›†åˆå¯¹æ¯”</h5>
<p>ä¸‰ç§é›†åˆï¼š</p>
<ul>
<li>HashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ€§èƒ½å¥½</li>
<li>Hashtable çº¿ç¨‹å®‰å…¨åŸºäº synchronizedï¼Œç»¼åˆæ€§èƒ½å·®ï¼Œå·²ç»è¢«æ·˜æ±°</li>
<li>ConcurrentHashMap ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½ï¼Œä¸æ­¢çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸”æ•ˆç‡é«˜ï¼Œæ€§èƒ½å¥½</li>
</ul>
<p>é›†åˆå¯¹æ¯”ï¼š</p>
<ol>
<li>Hashtable ç»§æ‰¿ Dictionary ç±»ï¼ŒHashMapã€ConcurrentHashMap ç»§æ‰¿ AbstractMapï¼Œå‡å®ç° Map æ¥å£</li>
<li>Hashtable åº•å±‚æ˜¯æ•°ç»„ + é“¾è¡¨ï¼ŒJDK8 ä»¥å HashMap å’Œ ConcurrentHashMap åº•å±‚æ˜¯æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</li>
<li>HashMap çº¿ç¨‹éå®‰å…¨ï¼ŒHashtable çº¿ç¨‹å®‰å…¨ï¼ŒHashtable çš„æ–¹æ³•éƒ½åŠ äº† synchronized å…³æ¥ç¡®ä¿çº¿ç¨‹åŒæ­¥</li>
<li>ConcurrentHashMapã€Hashtable <strong>ä¸å…è®¸ null å€¼</strong>ï¼ŒHashMap å…è®¸ null å€¼</li>
<li>ConcurrentHashMapã€HashMap çš„åˆå§‹å®¹é‡ä¸º 16ï¼ŒHashtable åˆå§‹å®¹é‡ä¸º 11ï¼Œå¡«å……å› å­é»˜è®¤éƒ½æ˜¯ 0.75ï¼Œä¸¤ç§ Map æ‰©å®¹æ˜¯å½“å‰å®¹é‡ç¿»å€ï¼šcapacity * 2ï¼ŒHashtable æ‰©å®¹æ—¶æ˜¯å®¹é‡ç¿»å€ + 1ï¼šcapacity*2 + 1</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--ConcurrentHashMap%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="ConcurrentHashMapæ•°æ®ç»“æ„"></p>
<p>å·¥ä½œæ­¥éª¤ï¼š</p>
<ol>
<li>
<p>åˆå§‹åŒ–ï¼Œä½¿ç”¨ cas æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ‡’æƒ°åˆå§‹åŒ– table</p>
</li>
<li>
<p>æ ‘åŒ–ï¼Œå½“ table.length &lt; 64 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹ï¼Œè¶…è¿‡ 64 æ—¶ï¼Œå¹¶ä¸” bin.length &gt; 8 æ—¶ï¼Œä¼šå°†<strong>é“¾è¡¨æ ‘åŒ–</strong>ï¼Œæ ‘åŒ–è¿‡ç¨‹ä¼šç”¨ synchronized é”ä½é“¾è¡¨å¤´</p>
<p>è¯´æ˜ï¼šé”ä½æŸä¸ªæ§½ä½çš„å¯¹è±¡å¤´ï¼Œæ˜¯ä¸€ç§å¾ˆå¥½çš„<strong>ç»†ç²’åº¦çš„åŠ é”</strong>æ–¹å¼ï¼Œç±»ä¼¼ MySQL ä¸­çš„è¡Œé”</p>
</li>
<li>
<p>putï¼Œå¦‚æœè¯¥ bin å°šæœªåˆ›å»ºï¼Œåªéœ€è¦ä½¿ç”¨ cas åˆ›å»º binï¼›å¦‚æœå·²ç»æœ‰äº†ï¼Œé”ä½é“¾è¡¨å¤´è¿›è¡Œåç»­ put æ“ä½œï¼Œå…ƒç´ æ·»åŠ è‡³ bin çš„å°¾éƒ¨</p>
</li>
<li>
<p>getï¼Œæ— é”æ“ä½œä»…éœ€è¦ä¿è¯å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ get æ“ä½œæ‹¿åˆ°çš„æ˜¯ ForwardingNode ä¼šè®© get æ“ä½œåœ¨æ–° table è¿›è¡Œæœç´¢</p>
</li>
<li>
<p>æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ä»¥ bin ä¸ºå•ä½è¿›è¡Œï¼Œéœ€è¦å¯¹ bin è¿›è¡Œ synchronizedï¼Œä½†è¿™æ—¶å…¶å®ƒç«äº‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æ— äº‹å¯åšï¼Œå®ƒä»¬ä¼šå¸®åŠ©æŠŠå…¶å®ƒ bin è¿›è¡Œæ‰©å®¹</p>
</li>
<li>
<p>sizeï¼Œå…ƒç´ ä¸ªæ•°ä¿å­˜åœ¨ baseCount ä¸­ï¼Œå¹¶å‘æ—¶çš„ä¸ªæ•°å˜åŠ¨ä¿å­˜åœ¨ CounterCell[] å½“ä¸­ï¼Œæœ€åç»Ÿè®¡æ•°é‡æ—¶ç´¯åŠ </p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éœ€æ±‚ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€HashMapå®¹å™¨ä¸­å­˜å…¥æ•°æ®ä¼šå‡ºç°å®‰å…¨é—®é¢˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentHashMapDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddMapDataThread</span>().start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddMapDataThread</span>().start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);<span class="comment">//ä¼‘æ¯5ç§’ï¼Œç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Mapå¤§å°ï¼š&quot;</span> + map.size());<span class="comment">//20ä¸‡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddMapDataThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">1000000</span> ; i++ )&#123;</span><br><span class="line">            ConcurrentHashMapDemo.map.put(<span class="string">&quot;é”®ï¼š&quot;</span>+i , <span class="string">&quot;å€¼&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="å¹¶å‘æ­»é“¾">å¹¶å‘æ­»é“¾</h5>
<p>JDK1.7 çš„ HashMap é‡‡ç”¨çš„å¤´æ’æ³•ï¼ˆæ‹‰é“¾æ³•ï¼‰è¿›è¡ŒèŠ‚ç‚¹çš„æ·»åŠ ï¼ŒHashMap çš„æ‰©å®¹é•¿åº¦ä¸ºåŸæ¥çš„ 2 å€</p>
<p>resize() ä¸­èŠ‚ç‚¹ï¼ˆEntryï¼‰è½¬ç§»çš„æºä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Entry[] newTable, <span class="type">boolean</span> rehash)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;<span class="comment">//å¾—åˆ°æ–°æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    <span class="comment">// éå†æ•´ä¸ªæ•°ç»„å¯¹åº”ä¸‹æ ‡ä¸‹çš„é“¾è¡¨ï¼Œeä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="comment">// å½“e == nullæ—¶ï¼Œåˆ™è¯¥é“¾è¡¨éå†å®Œäº†ï¼Œç»§ç»­éå†ä¸‹ä¸€æ•°ç»„ä¸‹æ ‡çš„é“¾è¡¨</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">null</span> != e) &#123;</span><br><span class="line">            <span class="comment">// å…ˆæŠŠeèŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹å­˜èµ·æ¥</span></span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;              <span class="comment">//å¾—åˆ°æ–°çš„hashå€¼</span></span><br><span class="line">                e.hash = <span class="literal">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åœ¨æ–°æ•°ç»„ä¸‹å¾—åˆ°æ–°çš„æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, newCapacity);</span><br><span class="line">             <span class="comment">// å°†eçš„nextæŒ‡é’ˆæŒ‡å‘æ–°æ•°ç»„ä¸‹æ ‡çš„ä½ç½®</span></span><br><span class="line">            e.next = newTable[i];</span><br><span class="line">            <span class="comment">// å°†è¯¥æ•°ç»„ä¸‹æ ‡çš„èŠ‚ç‚¹å˜ä¸ºeèŠ‚ç‚¹</span></span><br><span class="line">            newTable[i] = e;</span><br><span class="line">            <span class="comment">// éå†é“¾è¡¨çš„ä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JDK 8 è™½ç„¶å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œæ”¹ç”¨äº†å°¾æ’æ³•ï¼Œä½†ä»ä¸æ„å‘³ç€èƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹èƒ½å¤Ÿå®‰å…¨æ‰©å®¹ï¼Œè¿˜ä¼šå‡ºç°å…¶å®ƒé—®é¢˜ï¼ˆå¦‚æ‰©å®¹ä¸¢æ•°æ®ï¼‰</p>
<p>B ç«™è§†é¢‘è§£æï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1n541177Ea">https://www.bilibili.com/video/BV1n541177Ea</a></p>
<hr>
<h4 id="æˆå‘˜å±æ€§-8">æˆå‘˜å±æ€§</h4>
<h5 id="å˜é‡">å˜é‡</h5>
<ul>
<li>
<p>å­˜å‚¨æ•°ç»„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ•£åˆ—è¡¨çš„é•¿åº¦ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;	<span class="comment">// æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;			<span class="comment">// é»˜è®¤é•¿åº¦</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¹¶å‘çº§åˆ«ï¼ŒJDK7 é—ç•™ä¸‹æ¥ï¼Œ1.8 ä¸­ä¸ä»£è¡¨å¹¶å‘çº§åˆ«ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CONCURRENCY_LEVEL</span> <span class="operator">=</span> <span class="number">16</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è´Ÿè½½å› å­ï¼ŒJDK1.8 çš„ ConcurrentHashMap ä¸­æ˜¯å›ºå®šå€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é˜ˆå€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">8</span>;		<span class="comment">// é“¾è¡¨æ ‘åŒ–çš„é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNTREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">6</span>;	<span class="comment">// çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_TREEIFY_CAPACITY</span> <span class="operator">=</span> <span class="number">64</span>;	<span class="comment">// å½“æ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸”æŸä¸ªæ¡¶ä½ä¸­çš„é“¾è¡¨é•¿åº¦è¶…è¿‡8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰©å®¹ç›¸å…³ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_TRANSFER_STRIDE</span> <span class="operator">=</span> <span class="number">16</span>;	<span class="comment">// çº¿ç¨‹è¿ç§»æ•°æ®ã€æœ€å°æ­¥é•¿ã€‘ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡çš„æœ€å°åŒºé—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RESIZE_STAMP_BITS</span> <span class="operator">=</span> <span class="number">16</span>;			<span class="comment">// ç”¨æ¥è®¡ç®—æ‰©å®¹æ—¶ç”Ÿæˆçš„ã€æ ‡è¯†æˆ³ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_RESIZERS</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; (<span class="number">32</span> - RESIZE_STAMP_BITS)) - <span class="number">1</span>;<span class="comment">// 65535-1å¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESIZE_STAMP_SHIFT</span> <span class="operator">=</span> <span class="number">32</span> - RESIZE_STAMP_BITS;		<span class="comment">// æ‰©å®¹æ—¶ä½¿ç”¨</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>èŠ‚ç‚¹å“ˆå¸Œå€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MOVED</span>     <span class="operator">=</span> -<span class="number">1</span>; 			<span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯ FWD èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TREEBIN</span>   <span class="operator">=</span> -<span class="number">2</span>; 			<span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ–ï¼Œä¸”å½“å‰èŠ‚ç‚¹ä¸º TreeBin å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESERVED</span>  <span class="operator">=</span> -<span class="number">3</span>; 			<span class="comment">// è¡¨ç¤ºèŠ‚ç‚¹æ—¶ä¸´æ—¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_BITS</span> <span class="operator">=</span> <span class="number">0x7fffffff</span>; 	<span class="comment">// æ­£å¸¸èŠ‚ç‚¹çš„å“ˆå¸Œå€¼çš„å¯ç”¨çš„ä½æ•°</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰©å®¹è¿‡ç¨‹ï¼švolatile ä¿®é¥°ä¿è¯å¤šçº¿ç¨‹çš„å¯è§æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–° table èµ‹å€¼ç»™ nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸º null</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"><span class="comment">// è®°å½•æ‰©å®¹è¿›åº¦ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦ä» 0 - transferIndex ä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œç®€å•è¯´å°±æ˜¯è€è¡¨è½¬ç§»åˆ°å“ªäº†ï¼Œç´¢å¼•ä»é«˜åˆ°ä½è½¬ç§»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> transferIndex;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç´¯åŠ ç»Ÿè®¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶æˆ–è€…å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ° baseCount ä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> baseCount;</span><br><span class="line"><span class="comment">// LongAdder ä¸­çš„ cellsBuzyï¼Œ0 è¡¨ç¤ºå½“å‰ LongAdder å¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1 è¡¨ç¤ºå½“å‰ LongAdder å¯¹è±¡åŠ é”çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br><span class="line"><span class="comment">// LongAdder ä¸­çš„ cells æ•°ç»„ï¼Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ§åˆ¶å˜é‡ï¼š</p>
<p><strong>sizeCtl</strong> &lt; 0ï¼š</p>
<ul>
<li>
<p>-1 è¡¨ç¤ºå½“å‰ table æ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»º table æ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾…</p>
</li>
<li>
<p>å…¶ä»–è´Ÿæ•°è¡¨ç¤ºå½“å‰ map çš„ table æ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé«˜ 16 ä½è¡¨ç¤ºæ‰©å®¹çš„æ ‡è¯†æˆ³ï¼›ä½ 16 ä½è¡¨ç¤º (1 + nThread) å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ + 1</p>
</li>
</ul>
<p>sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»º table æ•°ç»„æ—¶ä½¿ç”¨ DEFAULT_CAPACITY ä¸ºæ•°ç»„å¤§å°</p>
<p>sizeCtl &gt; 0ï¼š</p>
<ul>
<li>å¦‚æœ table æœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å°</li>
<li>å¦‚æœ table å·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼Œå…ƒç´ ä¸ªæ•°ï¼Œä¸æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> sizeCtl;		<span class="comment">// volatile ä¿æŒå¯è§æ€§</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="å†…éƒ¨ç±»">å†…éƒ¨ç±»</h5>
<ul>
<li>
<p>Node èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Entry</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V val;</span><br><span class="line">    <span class="comment">// å•å‘é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>TreeBin èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeBin</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; root;</span><br><span class="line">    <span class="comment">// é“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> TreeNode&lt;K,V&gt; first;</span><br><span class="line">    <span class="comment">// ç­‰å¾…è€…çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> lockState;</span><br><span class="line">    <span class="comment">// å†™é”çŠ¶æ€ å†™é”æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ° TreeBin ä¸­çš„å†™çº¿ç¨‹åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WRITER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“ TreeBin ä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WAITER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// è¯»é”çŠ¶æ€æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBi å¯¹è±¡ä¸­è·å–æ•°æ®ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç»™ lockState + 4</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">READER</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>TreeNode èŠ‚ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;   <span class="comment">//åŒå‘é“¾è¡¨</span></span><br><span class="line">    <span class="type">boolean</span> red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ForwardingNode èŠ‚ç‚¹ï¼šè½¬ç§»èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">// æŒæœ‰æ‰©å®¹åæ–°çš„å“ˆå¸Œè¡¨çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">    ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">        <span class="comment">// ForwardingNode èŠ‚ç‚¹çš„ hash å€¼è®¾ä¸º -1</span></span><br><span class="line">        <span class="built_in">super</span>(MOVED, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.nextTable = tab;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="ä»£ç å—">ä»£ç å—</h5>
<ul>
<li>
<p>å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºsizeCtlå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> SIZECTL;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºtransferIndexå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> TRANSFERINDEX;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºbaseCountå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> BASECOUNT;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºcellsBusyå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> CELLSBUSY;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºcellValueå±æ€§åœ¨ CounterCell ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> CELLVALUE;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> ABASE;</span><br><span class="line"><span class="comment">// ç”¨ä½ç§»è¿ç®—æ›¿ä»£ä¹˜æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> ASHIFT;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>èµ‹å€¼æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°ï¼Œscale è¡¨ç¤º Node[] æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°ï¼Œint æ˜¯ 4 å­—èŠ‚</span></span><br><span class="line"><span class="type">int</span> <span class="variable">scale</span> <span class="operator">=</span> U.arrayIndexScale(ak);</span><br><span class="line"><span class="comment">// åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œæ¯”å¦‚ 8ï¼š1000 &amp; 0111 = 0000</span></span><br><span class="line"><span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;data type scale not a power of two&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// numberOfLeadingZeros(n)ï¼šè¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€èµ·</span></span><br><span class="line"><span class="comment">// 8 â†’ 1000 numberOfLeadingZeros(8) = 28</span></span><br><span class="line"><span class="comment">// 4 â†’ 100 numberOfLeadingZeros(4) = 29   int å€¼å°±æ˜¯å 4ä¸ªå­—èŠ‚</span></span><br><span class="line">ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ASHIFT = 31 - 29 = 2 ï¼Œint çš„å¤§å°å°±æ˜¯ 2 çš„ 2 æ¬¡æ–¹ï¼Œè·å–æ¬¡æ–¹æ•°</span></span><br><span class="line"><span class="comment">// ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ç”¨ä½ç§»è¿ç®—æ›¿ä»£äº†ä¹˜æ³•ï¼Œè·å– arr[5] çš„å€¼</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h4>
<ul>
<li>
<p>æ— å‚æ„é€ ï¼Œ æ•£åˆ—è¡¨ç»“æ„å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé»˜è®¤çš„æ•°ç»„å¤§å°æ˜¯ 16ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœ‰å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å®šå®¹é‡åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               <span class="comment">// å‡å¦‚ä¼ å…¥çš„å‚æ•°æ˜¯ 16ï¼Œ16 + 8 + 1 ï¼Œæœ€åå¾—åˆ° 32</span></span><br><span class="line">               <span class="comment">// ä¼ å…¥ 12ï¼Œ 12 + 6 + 1 = 19ï¼Œæœ€åå¾—åˆ° 32ï¼Œå°½å¯èƒ½çš„å¤§ï¼Œä¸ HashMapä¸ä¸€æ ·</span></span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// sizeCtl &gt; 0ï¼Œå½“ç›®å‰ table æœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtl è¡¨ç¤ºåˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> c - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HashMap éƒ¨åˆ†è¯¦è§£äº†è¯¥å‡½æ•°ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯<strong>æŠŠæœ€é«˜ä½æ˜¯ 1 çš„ä½ä»¥åŠå³è¾¹çš„ä½å…¨éƒ¨ç½® 1</strong>ï¼Œç»“æœåŠ  1 åå°±æ˜¯ 2 çš„ n æ¬¡å¹‚</p>
</li>
<li>
<p>å¤šä¸ªå‚æ•°æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="comment">// åˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)</span><br><span class="line">        <span class="comment">// æŠŠå¹¶å‘çº§åˆ«èµ‹å€¼ç»™åˆå§‹å®¹é‡</span></span><br><span class="line">        initialCapacity = concurrencyLevel;</span><br><span class="line">	<span class="comment">// loadFactor é»˜è®¤æ˜¯ 0.75</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">long</span>)(<span class="number">1.0</span> + (<span class="type">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> (size &gt;= (<span class="type">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="type">int</span>)size);</span><br><span class="line">    <span class="comment">// sizeCtl &gt; 0ï¼Œå½“ç›®å‰ table æœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtl è¡¨ç¤ºåˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é›†åˆæ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = DEFAULT_CAPACITY;	<span class="comment">// é»˜è®¤16</span></span><br><span class="line">    putAll(m);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•è§¦å‘æ‰©å®¹</span></span><br><span class="line">    tryPresize(m.size());</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;? <span class="keyword">extends</span> <span class="title class_">K</span>, ? <span class="keyword">extends</span> <span class="title class_">V</span>&gt; e : m.entrySet())</span><br><span class="line">        putVal(e.getKey(), e.getValue(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">tryPresize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰©å®¹ä¸ºå¤§äº 2 å€çš„æœ€å°çš„ 2 çš„ n æ¬¡å¹‚</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">    	tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="type">int</span> n;</span><br><span class="line">        <span class="comment">// æ•°ç»„è¿˜æœªåˆå§‹åŒ–ï¼Œã€ä¸€èˆ¬æ˜¯è°ƒç”¨é›†åˆæ„é€ æ–¹æ³•æ‰ä¼šæˆç«‹ï¼Œput åè°ƒç”¨è¯¥æ–¹æ³•éƒ½æ˜¯ä¸æˆç«‹çš„ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);<span class="comment">// æ‰©å®¹é˜ˆå€¼ï¼šn - 1/4 n</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;	<span class="comment">// æ‰©å®¹é˜ˆå€¼èµ‹å€¼ç»™sizeCtl</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœªè¾¾åˆ°æ‰©å®¹é˜ˆå€¼æˆ–è€…æ•°ç»„é•¿åº¦å·²ç»å¤§äºæœ€å¤§é•¿åº¦</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ä¸ addCount é€»è¾‘ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æˆå‘˜æ–¹æ³•-7">æˆå‘˜æ–¹æ³•</h4>
<h5 id="æ•°æ®è®¿å­˜">æ•°æ®è®¿å­˜</h5>
<ul>
<li>
<p>tabAt()ï¼šè·å–æ•°ç»„æŸä¸ªæ§½ä½çš„<strong>å¤´èŠ‚ç‚¹</strong>ï¼Œç±»ä¼¼äºæ•°ç»„ä¸­çš„ç›´æ¥å¯»å€ arr[i]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i æ˜¯æ•°ç»„ç´¢å¼•</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; Node&lt;K,V&gt; <span class="title function_">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="comment">// (i &lt;&lt; ASHIFT) + ABASE == ABASE + i * 4 ï¼ˆä¸€ä¸ª int å  4 ä¸ªå­—èŠ‚ï¼‰ï¼Œè¿™å°±ç›¸å½“äºå¯»å€ï¼Œæ›¿ä»£äº†ä¹˜æ³•</span></span><br><span class="line">    <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>casTabAt()ï¼šæŒ‡å®šæ•°ç»„ç´¢å¼•ä½ç½®ä¿®æ”¹åŸå€¼ä¸ºæŒ‡å®šçš„å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="type">boolean</span> <span class="title function_">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>setTabAt()ï¼šæŒ‡å®šæ•°ç»„ç´¢å¼•ä½ç½®è®¾ç½®å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="keyword">void</span> <span class="title function_">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i, Node&lt;K,V&gt; v)</span> &#123;</span><br><span class="line">    U.putObjectVolatile(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ·»åŠ æ–¹æ³•">æ·»åŠ æ–¹æ³•</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸‰ä¸ªå‚æ•° onlyIfAbsent ä¸º false è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­å­˜åœ¨ç›¸åŒçš„ key æ—¶ã€ç”¨å½“å‰æ•°æ®è¦†ç›–æ—§æ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>putVal()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€ConcurrentHashMap ä¸èƒ½å­˜æ”¾ null å€¼ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span> || value == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æ‰°åŠ¨è¿ç®—ï¼Œé«˜ä½ä½éƒ½å‚ä¸å¯»å€è¿ç®—</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰ k-v å°è£…æˆ node åæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// tab å¼•ç”¨å½“å‰ map çš„æ•°ç»„ tableï¼Œå¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        <span class="comment">// f è¡¨ç¤ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ï¼Œn è¡¨ç¤ºå“ˆå¸Œè¡¨æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">        <span class="comment">// i è¡¨ç¤º key é€šè¿‡å¯»å€è®¡ç®—åå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ï¼Œfh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„ hash å€¼</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘ï¼šè¡¨ç¤ºå½“å‰ map ä¸­çš„ table å°šæœªåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//ã€å»¶è¿Ÿåˆå§‹åŒ–ã€‘</span></span><br><span class="line">            tab = initTable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼ši è¡¨ç¤º key ä½¿ç”¨ã€å¯»å€ç®—æ³•ã€‘å¾—åˆ° key å¯¹åº”æ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹f</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¯¹åº”çš„æ•°ç»„ä¸º null è¯´æ˜æ²¡æœ‰å“ˆå¸Œå†²çªï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹æ·»åŠ åˆ°è¡¨ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šé€»è¾‘è¯´æ˜æ•°ç»„å·²ç»è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”å½“å‰ key å¯¹åº”çš„ä½ç½®ä¸ä¸º null</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ä¸º FWD ç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰ map æ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹ã€éœ€è¦å»å¸®åŠ©å“ˆå¸Œè¡¨å®Œæˆæ‰©å®¹ã€‘</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE4ã€‘ï¼šå“ˆå¸Œè¡¨æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œå½“å‰æ¡¶ä½å¯èƒ½æ˜¯é“¾è¡¨ä¹Ÿå¯èƒ½æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“æ’å…¥ key å­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™ oldVal è¿”å›</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// ã€é”ä½å½“å‰ key å¯»å€çš„æ¡¶ä½çš„å¤´èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œé‡æ–°è·å–ä¸€ä¸‹æ¡¶çš„å¤´èŠ‚ç‚¹æœ‰æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå› ä¸ºå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„è·å–</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// ã€å¤´èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å¤§äº 0 è¯´æ˜å½“å‰æ¡¶ä½æ˜¯æ™®é€šçš„é“¾è¡¨èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å½“å‰çš„æ’å…¥æ“ä½œæ²¡å‡ºç°é‡å¤çš„ keyï¼Œè¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ -1</span></span><br><span class="line">                        <span class="comment">// æ’å…¥çš„keyä¸é“¾è¡¨ä¸­çš„æŸä¸ªå…ƒç´ çš„ key ä¸€è‡´ï¼Œå˜æˆæ›¿æ¢æ“ä½œï¼ŒbinCount è¡¨ç¤ºç¬¬å‡ ä¸ªèŠ‚ç‚¹å†²çª</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œe æ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ï¼Œe åˆå§‹æ˜¯å¤´èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            <span class="comment">// å½“å‰å¾ªç¯èŠ‚ç‚¹ key</span></span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// key çš„å“ˆå¸Œå€¼ä¸å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œä¸€è‡´ï¼Œå¹¶ä¸” key çš„å€¼ä¹Ÿç›¸åŒ</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„ value èµ‹å€¼ç»™ oldVal</span></span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="comment">// å…è®¸è¦†ç›–</span></span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    <span class="comment">// æ–°æ•°æ®è¦†ç›–æ—§æ•°æ®</span></span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="comment">// è·³å‡ºå¾ªç¯</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="comment">// å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼ŒæŠŠæ•°æ®å°è£…æˆèŠ‚ç‚¹æ’å…¥é“¾è¡¨å°¾éƒ¨ï¼Œã€binCount ä»£è¡¨é•¿åº¦ - 1ã€‘</span></span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="literal">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å½“å‰æ¡¶ä½å¤´èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                              value)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ˜¯é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘</span></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ binCount &gt;= 8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ï¼Œè¯´æ˜é•¿åº¦æ˜¯ 9</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// æ ‘åŒ–</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡å½“å‰ table ä¸€å…±æœ‰å¤šå°‘æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹</span></span><br><span class="line">    <span class="comment">// binCount = 0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸º nullï¼Œnode å¯ä»¥ç›´æ¥æ”¾å…¥ï¼Œ2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>spread()ï¼šæ‰°åŠ¨å‡½æ•°</p>
<p>å°† hashCode æ— ç¬¦å·å³ç§» 16 ä½ï¼Œé«˜ 16bit å’Œä½ 16bit åšå¼‚æˆ–ï¼Œæœ€åä¸ HASH_BITS ç›¸ä¸å˜æˆæ­£æ•°ï¼Œ<strong>ä¸æ ‘åŒ–èŠ‚ç‚¹å’Œè½¬ç§»èŠ‚ç‚¹åŒºåˆ†</strong>ï¼ŒæŠŠé«˜ä½ä½éƒ½åˆ©ç”¨èµ·æ¥å‡å°‘å“ˆå¸Œå†²çªï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">spread</span><span class="params">(<span class="type">int</span> h)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS; <span class="comment">// 0111 1111 1111 1111 1111 1111 1111 1111</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>initTable()ï¼šåˆå§‹åŒ–æ•°ç»„ï¼Œå»¶è¿Ÿåˆå§‹åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    <span class="comment">// tab å¼•ç”¨ map.tableï¼Œsc å¼•ç”¨ sizeCtl</span></span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="comment">// table å°šæœªåˆå§‹åŒ–ï¼Œå¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// sc &lt; 0 è¯´æ˜ table æ­£åœ¨åˆå§‹åŒ–æˆ–è€…æ­£åœ¨æ‰©å®¹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥é‡Šæ”¾ CPU èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">        <span class="comment">// sizeCtl è®¾ç½®ä¸º -1ï¼Œç›¸å½“äºåŠ é”ï¼Œã€è®¾ç½®çš„æ˜¯ SIZECTL ä½ç½®çš„æ•°æ®ã€‘ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæ˜¯ sizeCtl æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥ sc ä¿å­˜çš„æ˜¯æ•°æ®çš„å‰¯æœ¬</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// çº¿ç¨‹å®‰å…¨çš„é€»è¾‘ï¼Œå†è¿›è¡Œä¸€æ¬¡åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// sc &gt; 0 åˆ›å»º table æ—¶ä½¿ç”¨ sc ä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºå“ˆå¸Œè¡¨æ•°ç»„</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">// æ‰©å®¹é˜ˆå€¼ï¼Œn &gt;&gt;&gt; 2  =&gt; ç­‰äº 1/4 n ï¼Œn - (1/4)n = 3/4 n =&gt; 0.75 * n</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è§£é”ï¼ŒæŠŠä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼èµ‹å€¼ç»™ sizeCtl</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>treeifyBin()ï¼šæ ‘åŒ–æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="type">int</span> n, sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹ï¼šã€è¯´æ˜å½“å‰ table æ•°ç»„é•¿åº¦æœªè¾¾åˆ° 64ï¼Œæ­¤æ—¶ä¸è¿›è¡Œæ ‘åŒ–æ“ä½œï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œã€‘</span></span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">// å½“å‰å®¹é‡çš„ 2 å€</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œä¸”æ˜¯æ™®é€š node æ•°æ®ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="literal">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€æ ‘åŒ–åŠ é”ã€‘</span></span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºåŠ é”æ²¡é—®é¢˜ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="literal">null</span>, tl = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;(e.hash, e.key, e.val,<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="literal">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>addCount()ï¼šæ·»åŠ è®¡æ•°ï¼Œ<strong>ä»£è¡¨å“ˆå¸Œè¡¨ä¸­çš„æ•°æ®æ€»é‡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addCount</span><span class="params">(<span class="type">long</span> x, <span class="type">int</span> check)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€ä¸Šé¢è¿™éƒ¨åˆ†çš„é€»è¾‘å°±æ˜¯ LongAdder çš„ç´¯åŠ é€»è¾‘ã€‘</span></span><br><span class="line">    CounterCell[] as; <span class="type">long</span> b, s;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç´¯åŠ æ•°ç»„ cells æ˜¯å¦åˆå§‹åŒ–ï¼Œæ²¡æœ‰å°±å»ç´¯åŠ  base åŸŸï¼Œç´¯åŠ å¤±è´¥è¿›å…¥æ¡ä»¶å†…é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="literal">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="type">long</span> v; <span class="type">int</span> m;</span><br><span class="line">        <span class="comment">// true æœªç«äº‰ï¼Œfalse å‘ç”Ÿç«äº‰</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ cells æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// å‰é¢çš„æ¡ä»¶ä¸º fasle è¯´æ˜ cells è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–ï¼Œé€šè¿‡ hash å¯»å€å¯¹åº”çš„æ§½ä½</span></span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// å°è¯•å»å¯¹åº”çš„æ§½ä½ç´¯åŠ ï¼Œç´¯åŠ å¤±è´¥è¿›å…¥ fullAddCount è¿›è¡Œé‡è¯•æˆ–è€…æ‰©å®¹</span></span><br><span class="line">            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            <span class="comment">// ä¸ Striped64#longAccumulate æ–¹æ³•ç›¸åŒ</span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ nullï¼Œæˆ–è€…ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    	<span class="comment">// ã€è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ã€‘ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼</span></span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºä¸€å®š ã€æ˜¯ä¸€ä¸ª put æ“ä½œè°ƒç”¨çš„ addCountã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="type">int</span> n, sc;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€ï¼štrue è¯´æ˜å½“å‰ sizeCtl å¯èƒ½ä¸ºä¸€ä¸ªè´Ÿæ•°è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­ï¼Œæˆ–è€… sizeCtl æ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">        <span class="comment">//        false è¡¨ç¤ºå“ˆå¸Œè¡¨çš„æ•°æ®çš„æ•°é‡æ²¡è¾¾åˆ°æ‰©å®¹æ¡ä»¶</span></span><br><span class="line">        <span class="comment">// ç„¶ååˆ¤æ–­å½“å‰ table æ•°ç»„æ˜¯å¦åˆå§‹åŒ–äº†ï¼Œå½“å‰ table é•¿åº¦æ˜¯å¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œå°±å¯ä»¥è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="type">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">// 16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011ï¼Œã€è´Ÿæ•°ï¼Œæ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ã€‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(n);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¡¨ç¤ºå½“å‰ tableï¼Œã€æ­£åœ¨æ‰©å®¹ã€‘ï¼Œsc é«˜ 16 ä½æ˜¯æ‰©å®¹æ ‡è¯†æˆ³ï¼Œä½ 16 ä½æ˜¯çº¿ç¨‹æ•° + 1</span></span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æ¡ä»¶ä¸€ï¼šåˆ¤æ–­æ‰©å®¹æ ‡è¯†æˆ³æ˜¯å¦ä¸€æ ·ï¼Œfasle ä»£è¡¨ä¸€æ ·</span></span><br><span class="line">                <span class="comment">// å‹˜è¯¯ä¸¤ä¸ªæ¡ä»¶ï¼š</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶äºŒæ˜¯ï¼šsc == (rs &lt;&lt; 16 ) + 1ï¼Œtrue ä»£è¡¨æ‰©å®¹å®Œæˆï¼Œå› ä¸ºä½16ä½æ˜¯1ä»£è¡¨æ²¡æœ‰çº¿ç¨‹æ‰©å®¹äº†</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶ä¸‰æ˜¯ï¼šsc == (rs &lt;&lt; 16) + MAX_RESIZERSï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¶…è¿‡æœ€å¤§å…è®¸çš„å¹¶å‘æ‰©å®¹çº¿ç¨‹æ•°</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶å››ï¼šåˆ¤æ–­æ–°è¡¨çš„å¼•ç”¨æ˜¯å¦æ˜¯ nullï¼Œä»£è¡¨æ‰©å®¹å®Œæˆ</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶äº”ï¼šã€æ‰©å®¹æ˜¯ä»é«˜ä½åˆ°ä½ä½è½¬ç§»ã€‘ï¼ŒtransferIndex &lt; 0 è¯´æ˜æ²¡æœ‰åŒºé—´éœ€è¦æ‰©å®¹äº†</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="literal">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹å‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå°† sc ä½ 16 ä½å€¼åŠ  1ï¼Œè¡¨ç¤ºå¤šä¸€ä¸ªçº¿ç¨‹å‚ä¸æ‰©å®¹</span></span><br><span class="line">                <span class="comment">// è®¾ç½®å¤±è´¥å…¶ä»–çº¿ç¨‹æˆ–è€… transfer å†…éƒ¨ä¿®æ”¹äº† sizeCtl å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    <span class="comment">//ã€ååŠ©æ‰©å®¹çº¿ç¨‹ã€‘ï¼ŒæŒæœ‰nextTableå‚æ•°</span></span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹æ•°é‡ + 2</span></span><br><span class="line">            <span class="comment">// 1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc,(rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                <span class="comment">//ã€è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ã€‘ï¼Œä¸æŒæœ‰ nextTableï¼Œåˆå§‹çº¿ç¨‹ä¼šæ–°å»º nextTable</span></span><br><span class="line">                transfer(tab, <span class="literal">null</span>);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>resizeStamp()ï¼šæ‰©å®¹æ ‡è¯†ç¬¦ï¼Œ<strong>æ¯æ¬¡æ‰©å®¹éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªï¼Œä¸æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½äº§ç”Ÿ</strong>ï¼Œ16 æ‰©å®¹åˆ° 32 äº§ç”Ÿä¸€ä¸ªï¼Œ32 æ‰©å®¹åˆ° 64 äº§ç”Ÿä¸€ä¸ª</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰©å®¹çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment"> * 16 -&gt; 32 ä»16æ‰©å®¹åˆ°32</span></span><br><span class="line"><span class="comment"> * numberOfLeadingZeros(16) =&gt; 1 0000 =&gt; 32 - 5 = 27 =&gt; 0000 0000 0001 1011</span></span><br><span class="line"><span class="comment"> * (1 &lt;&lt; (RESIZE_STAMP_BITS - 1)) =&gt; 1000 0000 0000 0000 =&gt; 32768</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * 0000 0000 0001 1011</span></span><br><span class="line"><span class="comment"> * 1000 0000 0000 0000</span></span><br><span class="line"><span class="comment"> * 1000 0000 0001 1011</span></span><br><span class="line"><span class="comment"> * æ°¸è¿œæ˜¯è´Ÿæ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">resizeStamp</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// æˆ–è¿ç®—</span></span><br><span class="line">    <span class="keyword">return</span> Integer.numberOfLeadingZeros(n) | (<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS - <span class="number">1</span>)); <span class="comment">// (16 -1 = 15)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ‰©å®¹æ–¹æ³•">æ‰©å®¹æ–¹æ³•</h5>
<p>æ‰©å®¹æœºåˆ¶ï¼š</p>
<ul>
<li>å½“é“¾è¡¨ä¸­å…ƒç´ ä¸ªæ•°è¶…è¿‡ 8 ä¸ªï¼Œæ•°ç»„çš„å¤§å°è¿˜æœªè¶…è¿‡ 64 æ—¶ï¼Œæ­¤æ—¶è¿›è¡Œæ•°ç»„çš„æ‰©å®¹ï¼Œå¦‚æœè¶…è¿‡åˆ™å°†é“¾è¡¨è½¬åŒ–æˆçº¢é»‘æ ‘</li>
<li>put æ•°æ®åè°ƒç”¨ addCount() æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰å“ˆå¸Œè¡¨çš„å®¹é‡è¶…è¿‡é˜ˆå€¼ sizeCtlï¼Œè¶…è¿‡è¿›è¡Œæ‰©å®¹</li>
<li>å¢åˆ æ”¹çº¿ç¨‹å‘ç°å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹ï¼Œå¸®å…¶æ‰©å®¹</li>
</ul>
<p>å¸¸è§æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>transfer()ï¼šæ•°æ®è½¬ç§»åˆ°æ–°è¡¨ä¸­ï¼Œå®Œæˆæ‰©å®¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> &#123;</span><br><span class="line">    <span class="comment">// n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ table æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> tab.length, stride;</span><br><span class="line">    <span class="comment">// stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ï¼Œé»˜è®¤å°±æ˜¯ 16</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œï¼Œã€ååŠ©çº¿ç¨‹ä¸åšè¿™ä¸€æ­¥ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªå®¹é‡æ˜¯ä¹‹å‰ã€äºŒå€çš„ table æ•°ç»„ã€‘</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠæ–°è¡¨èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTableï¼Œæ–¹ä¾¿å…¶ä»–çº¿ç¨‹è·å–æ–°è¡¨</span></span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">// è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ï¼ŒtransferIndex è®¡æ•°ä»1å¼€å§‹ä¸æ˜¯ 0ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯é•¿åº¦ï¼Œä¸æ˜¯é•¿åº¦-1</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextn</span> <span class="operator">=</span> nextTab.length;</span><br><span class="line">    <span class="comment">// å½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸º fwd èŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œå¯ä»¥ä»ä¸­è·å–åˆ°æ–°è¡¨</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="comment">// æ¨è¿›æ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">advance</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å®Œæˆæ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">finishing</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½</span></span><br><span class="line">    <span class="comment">// bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ï¼Œå› ä¸ºæ˜¯å€’åºè¿ç§»ï¼Œ16 è¿ç§»å®Œ è¿ç§» 15ï¼Œ15å®Œæˆå»è¿ç§»14</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> fh;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»™å½“å‰çº¿ç¨‹ã€åˆ†é…ä»»åŠ¡åŒºé—´ã€‘</span></span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="comment">// åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ï¼Œåˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡</span></span><br><span class="line">            <span class="type">int</span> nextIndex, nextBound;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// --i è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œtrueè¯´æ˜å½“å‰çš„è¿ç§»ä»»åŠ¡å°šæœªå®Œæˆï¼Œfalseè¯´æ˜çº¿ç¨‹å·²ç»å®Œæˆæˆ–è€…è¿˜æœªåˆ†é…</span></span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è¿ç§»çš„å¼€å§‹ä¸‹æ ‡ï¼Œå°äº0è¯´æ˜æ²¡æœ‰åŒºé—´éœ€è¦è¿ç§»äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„ i å˜é‡ä¸º -1 è·³å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜è¿˜æœ‰åŒºé—´éœ€è¦åˆ†é…ï¼Œç„¶åç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡ï¼Œ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      <span class="comment">// åˆ¤æ–­åŒºé—´æ˜¯å¦è¿˜å¤Ÿä¸€ä¸ªæ­¥é•¿ï¼Œä¸å¤Ÿå°±å…¨éƒ¨åˆ†é…</span></span><br><span class="line">                      nextBound = (nextIndex &gt; stride ? nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹çš„ç»“æŸä¸‹æ ‡</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹çš„å¼€å§‹ä¸‹æ ‡ï¼Œä¸Šä¸€ä¸ªçº¿ç¨‹ç»“æŸçš„ä¸‹æ ‡çš„ä¸‹ä¸€ä¸ªç´¢å¼•å°±æ˜¯è¿™ä¸ªçº¿ç¨‹å¼€å§‹çš„ä¸‹æ ‡</span></span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// ä»»åŠ¡åˆ†é…ç»“æŸï¼Œè·³å‡ºå¾ªç¯æ‰§è¡Œè¿ç§»æ“ä½œ</span></span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€åˆ†é…å®Œæˆï¼Œå¼€å§‹æ•°æ®è¿ç§»æ“ä½œã€‘</span></span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘ï¼ši &lt; 0 æˆç«‹è¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ï¼Œæˆ–è€…ä»»åŠ¡æ‰§è¡Œå®Œäº†</span></span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="type">int</span> sc;</span><br><span class="line">            <span class="comment">// å¦‚æœè¿ç§»å®Œæˆ</span></span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                nextTable = <span class="literal">null</span>;	<span class="comment">// help GC</span></span><br><span class="line">                table = nextTab;	<span class="comment">// æ–°è¡¨èµ‹å€¼ç»™å½“å‰å¯¹è±¡</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);<span class="comment">// æ‰©å®¹é˜ˆå€¼ä¸º 2n - n/2 = 3n/2 = 0.75*(2n)</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹å®Œæˆäº†åˆ†é…çš„ä»»åŠ¡åŒºé—´ï¼Œå¯ä»¥é€€å‡ºï¼Œå…ˆæŠŠ sizeCtl èµ‹å€¼ç»™ sc ä¿ç•™</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œä¸æ˜¯çš„è¯ç›´æ¥ returnï¼Œ</span></span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">// æ‰€ä»¥æœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼ŒsizeCtl çš„ä½ 16 ä½ä¸º 1</span></span><br><span class="line">                finishing = advance = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// ã€è¿™é‡Œè¡¨ç¤ºæœ€åä¸€ä¸ªçº¿ç¨‹éœ€è¦é‡æ–°æ£€æŸ¥ä¸€éæ˜¯å¦æœ‰æ¼æ‰çš„åŒºé—´ã€‘</span></span><br><span class="line">                i = n;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼šå½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸º fwd èŠ‚ç‚¹å³å¯ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="literal">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="literal">null</span>, fwd);</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½å³å¯</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// ã€CASE4ã€‘ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸” node èŠ‚ç‚¹ä¸æ˜¯ fwd èŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ã€é”ä½å¤´èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// äºŒæ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢å¤´èŠ‚ç‚¹å·²ç»è¢«ä¿®æ”¹äº†ï¼Œå› ä¸ºè¿™é‡Œæ‰æ˜¯çº¿ç¨‹å®‰å…¨çš„è®¿é—®</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// ã€è¿ç§»æ•°æ®çš„é€»è¾‘ï¼Œå’Œ HashMap ç›¸ä¼¼ã€‘</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨</span></span><br><span class="line">                    <span class="comment">// hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨</span></span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="comment">// å“ˆå¸Œ &gt; 0 è¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å’Œ HashMap çš„å¤„ç†æ–¹å¼ä¸€è‡´ï¼Œä¸è€æ•°ç»„é•¿åº¦ç›¸ä¸ï¼Œ16 æ˜¯ 10000</span></span><br><span class="line">                        <span class="comment">// åˆ¤æ–­å¯¹åº”çš„ 1 çš„ä½ç½®ä¸Šæ˜¯ 0 æˆ– 1 åˆ†æˆé«˜ä½ä½é“¾è¡¨</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">runBit</span> <span class="operator">=</span> fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="comment">// éå†é“¾è¡¨ï¼Œå¯»æ‰¾ã€é€†åºçœ‹ã€‘æœ€é•¿çš„å¯¹åº”ä½ç›¸åŒçš„é“¾è¡¨ï¼Œçœ‹ä¸‹é¢çš„å›¾æ›´å¥½çš„ç†è§£</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="literal">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œ ä¸ n</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> p.hash &amp; n;</span><br><span class="line">                            <span class="comment">// å¦‚æœå½“å‰å€¼ä¸å‰é¢èŠ‚ç‚¹çš„å€¼ å¯¹åº”ä½ ä¸åŒï¼Œåˆ™ä¿®æ”¹ runBitï¼ŒæŠŠ lastRun æŒ‡å‘å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// åˆ¤æ–­ç­›é€‰å‡ºçš„é“¾è¡¨æ˜¯ä½ä½çš„è¿˜æ˜¯é«˜ä½çš„</span></span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;	<span class="comment">// ln æŒ‡å‘è¯¥é“¾è¡¨</span></span><br><span class="line">                            hn = <span class="literal">null</span>;		<span class="comment">// hn ä¸º null</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// è¯´æ˜ lastRun å¼•ç”¨çš„é“¾è¡¨ä¸ºé«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘é«˜ä½é“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ä»å¤´å¼€å§‹éå†æ‰€æœ‰çš„é“¾è¡¨èŠ‚ç‚¹ï¼Œè¿­ä»£åˆ° p == lastRun èŠ‚ç‚¹è·³å‡ºå¾ªç¯</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">ph</span> <span class="operator">=</span> p.hash; <span class="type">K</span> <span class="variable">pk</span> <span class="operator">=</span> p.key; <span class="type">V</span> <span class="variable">pv</span> <span class="operator">=</span> p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                <span class="comment">// ã€å¤´æ’æ³•ã€‘ï¼Œä»å³å¾€å·¦çœ‹ï¼Œé¦–å…ˆ ln æŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">                                <span class="comment">// æ‰€ä»¥è¿™æ¬¡æ–°å»ºçš„èŠ‚ç‚¹çš„ next æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæ›´æ–° ln çš„å¼•ç”¨</span></span><br><span class="line">                                ln = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// é«˜ä½ä½é“¾è®¾ç½®åˆ°æ–°è¡¨ä¸­çš„æŒ‡å®šä½ç½®</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">// è€è¡¨ä¸­çš„è¯¥æ¡¶ä½è®¾ç½®ä¸º fwd èŠ‚ç‚¹</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ç»“ç‚¹</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">lc</span> <span class="operator">=</span> <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">// è¿­ä»£ TreeBin ä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹è‡³å°¾èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="comment">// è¿­ä»£çš„å½“å‰å…ƒç´ çš„ hash</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                            <span class="comment">// æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹å±äºä½ä½é“¾èŠ‚ç‚¹</span></span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="literal">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    <span class="comment">//ã€å°¾æ’æ³•ã€‘</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                <span class="comment">// loTail æŒ‡å‘å°¾èŠ‚ç‚¹</span></span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="literal">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// æ‹†æˆçš„é«˜ä½ä½ä½ä¸¤ä¸ªé“¾ï¼Œã€åˆ¤æ–­æ˜¯å¦éœ€è¦éœ€è¦è½¬åŒ–ä¸ºé“¾è¡¨ã€‘ï¼Œåä¹‹ä¿æŒæ ‘åŒ–</span></span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                        (hc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                        (lc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é“¾è¡¨å¤„ç†çš„ LastRun æœºåˆ¶ï¼Œ<strong>å¯ä»¥å‡å°‘èŠ‚ç‚¹çš„åˆ›å»º</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--JUC-ConcurrentHashMap-LastRun%E6%9C%BA%E5%88%B6.png" alt=""></p>
</li>
<li>
<p>helpTransfer()ï¼šå¸®åŠ©æ‰©å®¹æœºåˆ¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="comment">// æ•°ç»„ä¸ä¸ºç©ºï¼ŒèŠ‚ç‚¹æ˜¯è½¬å‘èŠ‚ç‚¹ï¼Œè·å–è½¬å‘èŠ‚ç‚¹æŒ‡å‘çš„æ–°è¡¨å¼€å§‹ååŠ©ä¸»çº¿ç¨‹æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="literal">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ‰©å®¹æ ‡è¯†æˆ³</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(tab.length);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ•°æ®è¿ç§»æ˜¯å¦å®Œæˆï¼Œè¿ç§»å®Œæˆä¼šæŠŠ æ–°è¡¨èµ‹å€¼ç»™ nextTable å±æ€§</span></span><br><span class="line">        <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// è®¾ç½®æ‰©å®¹çº¿ç¨‹æ•°é‡ + 1</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// ååŠ©æ‰©å®¹</span></span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="è·å–æ–¹æ³•">è·å–æ–¹æ³•</h5>
<p>ConcurrentHashMap ä½¿ç”¨ get() æ–¹æ³•è·å–æŒ‡å®š key çš„æ•°æ®</p>
<ul>
<li>
<p>get()ï¼šè·å–æŒ‡å®šæ•°æ®çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="type">int</span> n, eh; K ek;</span><br><span class="line">    <span class="comment">// æ‰°åŠ¨è¿ç®—ï¼Œè·å– key çš„å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰å“ˆå¸Œè¡¨çš„æ•°ç»„æ˜¯å¦åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// å¦‚æœ table å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œã€å“ˆå¸Œå¯»å€ã€‘ï¼Œæ˜ å°„åˆ°æ•°ç»„å¯¹åº”ç´¢å¼•å¤„ï¼Œè·å–è¯¥ç´¢å¼•å¤„çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯¹æ¯”å¤´ç»“ç‚¹ hash ä¸æŸ¥è¯¢ key çš„ hash æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="comment">// è¿›è¡Œå€¼çš„åˆ¤æ–­ï¼Œå¦‚æœæˆåŠŸå°±è¯´æ˜å½“å‰èŠ‚ç‚¹å°±æ˜¯è¦æŸ¥è¯¢çš„èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰æ§½ä½çš„ã€å“ˆå¸Œå€¼å°äº0ã€‘è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹æˆ–è€…æ˜¯æ­£åœ¨æ‰©å®¹çš„ fwd èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="literal">null</span> ? p.val : <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// å½“å‰æ¡¶ä½æ˜¯ã€é“¾è¡¨ã€‘ï¼Œå¾ªç¯éå†æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ForwardingNode#findï¼šè½¬ç§»èŠ‚ç‚¹çš„æŸ¥æ‰¾æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;K,V&gt; <span class="title function_">find</span><span class="params">(<span class="type">int</span> h, Object k)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ–°è¡¨çš„å¼•ç”¨</span></span><br><span class="line">    outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;)  &#123;</span><br><span class="line">        <span class="comment">// e è¡¨ç¤ºåœ¨æ‰©å®¹è€Œåˆ›å»ºæ–°è¡¨ä½¿ç”¨å¯»å€ç®—æ³•å¾—åˆ°çš„æ¡¶ä½å¤´ç»“ç‚¹ï¼Œn è¡¨ç¤ºä¸ºæ‰©å®¹è€Œåˆ›å»ºçš„æ–°è¡¨çš„é•¿åº¦</span></span><br><span class="line">        Node&lt;K,V&gt; e; <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span> || tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// åœ¨æ–°è¡¨ä¸­é‡æ–°å®šä½ hash å¯¹åº”çš„å¤´ç»“ç‚¹ï¼Œè¡¨ç¤ºåœ¨ oldTable ä¸­å¯¹åº”çš„æ¡¶ä½åœ¨è¿ç§»ä¹‹å‰å°±æ˜¯ null</span></span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> eh; K ek;</span><br><span class="line">            <span class="comment">// ã€å“ˆå¸Œç›¸åŒå€¼ä¹Ÿç›¸åŒã€‘ï¼Œè¡¨ç¤ºæ–°è¡¨å½“å‰å‘½ä¸­æ¡¶ä½ä¸­çš„æ•°æ®ï¼Œå³ä¸ºæŸ¥è¯¢æƒ³è¦æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp; ((ek = e.key) == k || (ek != <span class="literal">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// eh &lt; 0 è¯´æ˜å½“å‰æ–°è¡¨ä¸­è¯¥ç´¢å¼•çš„å¤´èŠ‚ç‚¹æ˜¯ TreeBin ç±»å‹ï¼Œæˆ–è€…æ˜¯ FWD ç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// åœ¨å¹¶å‘å¾ˆå¤§çš„æƒ…å†µä¸‹æ–°æ‰©å®¹çš„è¡¨è¿˜æ²¡å®Œæˆå¯èƒ½ã€å†æ¬¡æ‰©å®¹ã€‘ï¼Œåœ¨æ­¤æ–¹æ³•å¤„å†æ¬¡æ‹¿åˆ° FWD ç±»å‹</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                    <span class="comment">// ç»§ç»­è·å–æ–°çš„ fwd æŒ‡å‘çš„æ–°æ•°ç»„çš„åœ°å€ï¼Œé€’å½’äº†</span></span><br><span class="line">                    tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                    <span class="keyword">continue</span> outer;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// è¯´æ˜æ­¤æ¡¶ä½ä¸º TreeBin èŠ‚ç‚¹ï¼Œä½¿ç”¨TreeBin.find æŸ¥æ‰¾çº¢é»‘æ ‘ä¸­ç›¸åº”èŠ‚ç‚¹ã€‚</span></span><br><span class="line">                    <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰æ¡¶ä½æ˜¯é“¾è¡¨ï¼Œå°†å½“å‰å…ƒç´ æŒ‡å‘é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåˆ¤æ–­å½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜è¿­ä»£åˆ°é“¾è¡¨æœ«å°¾ï¼Œã€æœªæ‰¾åˆ°å¯¹åº”çš„æ•°æ®ï¼Œè¿”å› nullã€‘</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="åˆ é™¤æ–¹æ³•">åˆ é™¤æ–¹æ³•</h5>
<ul>
<li>
<p>remove()ï¼šåˆ é™¤æŒ‡å®šå…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> replaceNode(key, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>replaceNode()ï¼šæ›¿ä»£æŒ‡å®šçš„å…ƒç´ ï¼Œä¼šååŠ©æ‰©å®¹ï¼Œ<strong>å¢åˆ æ”¹ï¼ˆå†™ï¼‰éƒ½ä¼šååŠ©æ‰©å®¹ï¼ŒæŸ¥è¯¢ï¼ˆè¯»ï¼‰æ“ä½œä¸ä¼š</strong>ï¼Œå› ä¸ºè¯»æ“ä½œä¸æ¶‰åŠåŠ é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">replaceNode</span><span class="params">(Object key, V value, Object cv)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®— key æ‰°åŠ¨è¿ç®—åçš„ hash</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// å¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘ï¼štable è¿˜æœªåˆå§‹åŒ–æˆ–è€…å“ˆå¸Œå¯»å€çš„æ•°ç»„ç´¢å¼•å¤„ä¸º nullï¼Œç›´æ¥ç»“æŸè‡ªæ—‹ï¼Œè¿”å› null</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span> || (f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ table æ­£åœ¨æ‰©å®¹ï¼Œã€å½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ© table å®Œæˆæ‰©å®¹ã€‘</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šå½“å‰æ¡¶ä½å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¿ç•™æ›¿æ¢ä¹‹å‰æ•°æ®å¼•ç”¨</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// æ ¡éªŒæ ‡è®°</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">validated</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// ã€åŠ é”å½“å‰æ¡¶ä½å¤´ç»“ç‚¹ã€‘ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ä»£ç å—</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// åŒé‡æ£€æŸ¥</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯é“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        validated = <span class="literal">true</span>;</span><br><span class="line">                        <span class="comment">//éå†æ‰€æœ‰çš„èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="literal">null</span>;;) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// hash å’Œå€¼éƒ½ç›¸åŒï¼Œå®šä½åˆ°äº†å…·ä½“çš„èŠ‚ç‚¹</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">// å½“å‰èŠ‚ç‚¹çš„value</span></span><br><span class="line">                                <span class="type">V</span> <span class="variable">ev</span> <span class="operator">=</span> e.val;</span><br><span class="line">                                <span class="keyword">if</span> (cv == <span class="literal">null</span> || cv == ev ||</span><br><span class="line">                                    (ev != <span class="literal">null</span> &amp;&amp; cv.equals(ev))) &#123;</span><br><span class="line">                                    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ°</span></span><br><span class="line">                                    oldVal = ev;</span><br><span class="line">                                    <span class="keyword">if</span> (value != <span class="literal">null</span>)		<span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯æ›¿æ¢æ“ä½œ</span></span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    <span class="keyword">else</span> <span class="keyword">if</span> (pred != <span class="literal">null</span>)	<span class="comment">// éå¤´èŠ‚ç‚¹åˆ é™¤æ“ä½œï¼Œæ–­å¼€é“¾è¡¨</span></span><br><span class="line">                                        pred.next = e.next;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸ºå¤´ç»“ç‚¹ï¼Œå°†æ¡¶ä½å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºä»¥å‰å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                                        setTabAt(tab, i, e.next);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        validated = <span class="literal">true</span>;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                        <span class="keyword">if</span> ((r = t.root) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                            (p = r.findTreeNode(hash, key, <span class="literal">null</span>)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="type">V</span> <span class="variable">pv</span> <span class="operator">=</span> p.val;</span><br><span class="line">                            <span class="keyword">if</span> (cv == <span class="literal">null</span> || cv == pv ||</span><br><span class="line">                                (pv != <span class="literal">null</span> &amp;&amp; cv.equals(pv))) &#123;</span><br><span class="line">                                oldVal = pv;</span><br><span class="line">                                <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ›¿æ¢æ“ä½œ</span></span><br><span class="line">                                <span class="keyword">if</span> (value != <span class="literal">null</span>)</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                                <span class="comment">// åˆ é™¤æ“ä½œ</span></span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                    setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹é”é”™å¯¹è±¡ï¼Œvalidated ä¸º falseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡ for è‡ªæ—‹</span></span><br><span class="line">            <span class="keyword">if</span> (validated) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// æ›¿æ¢çš„å€¼ä¸º nullï¼Œã€è¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">                        addCount(-<span class="number">1L</span>, -<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p>
<hr>
<h4 id="JDK7-åŸç†">JDK7 åŸç†</h4>
<p>ConcurrentHashMap å¯¹é”ç²’åº¦è¿›è¡Œäº†ä¼˜åŒ–ï¼Œ<strong>åˆ†æ®µé”æŠ€æœ¯</strong>ï¼Œå°†æ•´å¼ è¡¨åˆ†æˆäº†å¤šä¸ªæ•°ç»„ï¼ˆSegmentï¼‰ï¼Œæ¯ä¸ªæ•°ç»„åˆæ˜¯ä¸€ä¸ªç±»ä¼¼ HashMap æ•°ç»„çš„ç»“æ„ã€‚å…è®¸å¤šä¸ªä¿®æ”¹æ“ä½œå¹¶å‘è¿›è¡Œï¼ŒSegment æ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œç»§æ‰¿ ReentrantLockï¼Œå¹¶å‘æ—¶é”ä½çš„æ˜¯æ¯ä¸ª Segmentï¼Œå…¶ä»– Segment è¿˜æ˜¯å¯ä»¥æ“ä½œçš„ï¼Œè¿™æ ·ä¸åŒ Segment ä¹‹é—´å°±å¯ä»¥å®ç°å¹¶å‘ï¼Œå¤§å¤§æé«˜æ•ˆç‡ã€‚</p>
<p>åº•å±‚ç»“æ„ï¼š <strong>Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨</strong>ï¼ˆæ•°ç»„ + é“¾è¡¨æ˜¯ HashMap çš„ç»“æ„ï¼‰</p>
<ul>
<li>
<p>ä¼˜ç‚¹ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ segmentï¼Œå®é™…æ˜¯æ²¡æœ‰å†²çªçš„ï¼Œè¿™ä¸ JDK8 ä¸­æ˜¯ç±»ä¼¼çš„</p>
</li>
<li>
<p>ç¼ºç‚¹ï¼šSegments æ•°ç»„é»˜è®¤å¤§å°ä¸º 16ï¼Œè¿™ä¸ªå®¹é‡åˆå§‹åŒ–æŒ‡å®šåå°±ä¸èƒ½æ”¹å˜äº†ï¼Œå¹¶ä¸”ä¸æ˜¯æ‡’æƒ°åˆå§‹åŒ–</p>
<p>![](<a target="_blank" rel="noopener" href="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentHashMap">https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentHashMap</a> 1.7 åº•å±‚ç»“æ„.png)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-13--image-20250930135035619.png" alt="image-20250930135035619"></p>
</li>
</ul>
<hr>
<h3 id="CopyOnWrite">CopyOnWrite</h3>
<h4 id="åŸç†åˆ†æ-2">åŸç†åˆ†æ</h4>
<p>CopyOnWriteArrayList é‡‡ç”¨äº†<strong>å†™å…¥æ—¶æ‹·è´</strong>çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œæ“ä½œï¼Œä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„<strong>å¹¶å‘è¯»ï¼Œè¯»å†™åˆ†ç¦»</strong></p>
<p>CopyOnWriteArraySet åº•å±‚å¯¹ CopyOnWriteArrayList è¿›è¡Œäº†åŒ…è£…ï¼Œè£…é¥°å™¨æ¨¡å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CopyOnWriteArraySet</span><span class="params">()</span> &#123;</span><br><span class="line">    al = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;E&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>å­˜å‚¨ç»“æ„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;	<span class="comment">// volatile ä¿è¯äº†è¯»å†™çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å…¨å±€é”ï¼šä¿è¯çº¿ç¨‹çš„æ‰§è¡Œå®‰å…¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">transient</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ–°å¢æ•°æ®ï¼šéœ€è¦åŠ é”ï¼Œ<strong>åˆ›å»ºæ–°çš„æ•°ç»„æ“ä½œ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æ—§çš„æ•°ç»„</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="comment">// ã€æ‹·è´æ–°çš„æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶å®ƒè¯»çº¿ç¨‹ï¼‰ã€‘</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æ·»åŠ æ–°å…ƒç´ </span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">// æ›¿æ¢æ—§çš„æ•°ç»„ï¼Œã€è¿™ä¸ªæ“ä½œä»¥åï¼Œå…¶ä»–çº¿ç¨‹è·å–æ•°ç»„å°±æ˜¯è·å–çš„æ–°æ•°ç»„äº†ã€‘</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¯»æ“ä½œï¼šä¸åŠ é”ï¼Œ<strong>åœ¨åŸæ•°ç»„ä¸Šæ“ä½œ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(getArray(), index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> E <span class="title function_">get</span><span class="params">(Object[] a, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€‚åˆè¯»å¤šå†™å°‘çš„åº”ç”¨åœºæ™¯</p>
</li>
<li>
<p>è¿­ä»£å™¨ï¼šCopyOnWriteArrayList åœ¨è¿”å›è¿­ä»£å™¨æ—¶ï¼Œ<strong>åˆ›å»ºä¸€ä¸ªå†…éƒ¨æ•°ç»„å½“å‰çš„å¿«ç…§ï¼ˆå¼•ç”¨ï¼‰</strong>ï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹æ›¿æ¢äº†åŸå§‹æ•°ç»„ï¼Œè¿­ä»£å™¨éå†çš„å¿«ç…§ä¾ç„¶å¼•ç”¨çš„æ˜¯åˆ›å»ºå¿«ç…§æ—¶çš„æ•°ç»„ï¼Œæ‰€ä»¥è¿™ç§å®ç°æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€å®šçš„æ•°æ®å»¶è¿Ÿæ€§ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¹¶è¡Œæ·»åŠ çš„æ•°æ®ä¸å¯è§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–åˆ°æ•°ç»„å¼•ç”¨ï¼Œæ•´ä¸ªéå†çš„è¿‡ç¨‹è¯¥æ•°ç»„éƒ½ä¸ä¼šå˜ï¼Œä¸€ç›´å¼•ç”¨çš„éƒ½æ˜¯è€æ•°ç»„ï¼Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">COWIterator</span>&lt;E&gt;(getArray(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨ä¼šåˆ›å»ºä¸€ä¸ªåº•å±‚arrayçš„å¿«ç…§ï¼Œæ•…ä¸»ç±»çš„ä¿®æ”¹ä¸å½±å“è¯¥å¿«ç…§</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">COWIterator</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">ListIterator</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">// å†…éƒ¨æ•°ç»„å¿«ç…§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] snapshot;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">COWIterator</span><span class="params">(Object[] elements, <span class="type">int</span> initialCursor)</span> &#123;</span><br><span class="line">        cursor = initialCursor;</span><br><span class="line">        <span class="comment">// æ•°ç»„çš„å¼•ç”¨åœ¨è¿­ä»£è¿‡ç¨‹ä¸ä¼šæ”¹å˜</span></span><br><span class="line">        snapshot = elements;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€ä¸æ”¯æŒå†™æ“ä½œã€‘ï¼Œå› ä¸ºæ˜¯åœ¨å¿«ç…§ä¸Šæ“ä½œï¼Œæ— æ³•åŒæ­¥å›å»</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å¼±ä¸€è‡´æ€§">å¼±ä¸€è‡´æ€§</h4>
<p>æ•°æ®ä¸€è‡´æ€§å°±æ˜¯è¯»åˆ°æœ€æ–°æ›´æ–°çš„æ•°æ®ï¼š</p>
<ul>
<li>
<p>å¼ºä¸€è‡´æ€§ï¼šå½“æ›´æ–°æ“ä½œå®Œæˆä¹‹åï¼Œä»»ä½•å¤šä¸ªåç»­è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼</p>
</li>
<li>
<p>å¼±ä¸€è‡´æ€§ï¼šç³»ç»Ÿå¹¶ä¸ä¿è¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼ï¼Œä¹Ÿä¸ä¼šæ‰¿è¯ºå¤šä¹…ä¹‹åå¯ä»¥è¯»åˆ°</p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-CopyOnWriteArrayList%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7.png" style="zoom:80%;" />
<table>
<thead>
<tr>
<th>æ—¶é—´ç‚¹</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Thread-0 getArray()</td>
</tr>
<tr>
<td>2</td>
<td>Thread-1 getArray()</td>
</tr>
<tr>
<td>3</td>
<td>Thread-1 setArray(arrayCopy)</td>
</tr>
<tr>
<td>4</td>
<td>Thread-0 array[index]</td>
</tr>
</tbody>
</table>
<p>Thread-0 è¯»åˆ°äº†è„æ•°æ®</p>
<p>ä¸ä¸€å®šå¼±ä¸€è‡´æ€§å°±ä¸å¥½</p>
<ul>
<li>æ•°æ®åº“çš„<strong>äº‹åŠ¡éš”ç¦»çº§åˆ«</strong>å°±æ˜¯å¼±ä¸€è‡´æ€§çš„è¡¨ç°</li>
<li>å¹¶å‘é«˜å’Œä¸€è‡´æ€§æ˜¯çŸ›ç›¾çš„ï¼Œéœ€è¦æƒè¡¡</li>
</ul>
<hr>
<h4 id="å®‰å…¨å¤±è´¥">å®‰å…¨å¤±è´¥</h4>
<p>åœ¨ java.util åŒ…çš„é›†åˆç±»å°±éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œè€Œ java.util.concurrent åŒ…ä¸‹çš„ç±»éƒ½æ˜¯å®‰å…¨å¤±è´¥</p>
<ul>
<li>
<p>å¿«é€Ÿå¤±è´¥ï¼šåœ¨ A çº¿ç¨‹ä½¿ç”¨<strong>è¿­ä»£å™¨</strong>å¯¹é›†åˆè¿›è¡Œéå†çš„è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶ B çº¿ç¨‹å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼ˆå¢åˆ æ”¹ï¼‰ï¼Œæˆ–è€… A çº¿ç¨‹åœ¨éå†è¿‡ç¨‹ä¸­å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼Œéƒ½ä¼šå¯¼è‡´ A çº¿ç¨‹æŠ›å‡º ConcurrentModificationException å¼‚å¸¸</p>
<ul>
<li>AbstractList ç±»ä¸­çš„æˆå‘˜å˜é‡ modCountï¼Œç”¨æ¥è®°å½• List ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°ï¼Œ<strong>ç»“æ„å‘ç”Ÿå˜åŒ–</strong>æ˜¯æŒ‡æ·»åŠ æˆ–è€…åˆ é™¤è‡³å°‘ä¸€ä¸ªå…ƒç´ çš„æ“ä½œï¼Œæˆ–è€…æ˜¯è°ƒæ•´å†…éƒ¨æ•°ç»„çš„å¤§å°ï¼Œä»…ä»…è®¾ç½®å…ƒç´ çš„å€¼ä¸ç®—ç»“æ„å‘ç”Ÿå˜åŒ–</li>
<li>åœ¨è¿›è¡Œåºåˆ—åŒ–æˆ–è€…è¿­ä»£ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒæ“ä½œå‰å modCount æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†æŠ›å‡º CME å¼‚å¸¸</li>
</ul>
</li>
<li>
<p>å®‰å…¨å¤±è´¥ï¼šé‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨<strong>è¿­ä»£å™¨</strong>éå†æ—¶ç›´æ¥åœ¨åŸé›†åˆæ•°ç»„å†…å®¹ä¸Šè®¿é—®ï¼Œä½†å…¶ä»–çº¿ç¨‹çš„å¢åˆ æ”¹éƒ½ä¼šæ–°å»ºæ•°ç»„è¿›è¡Œä¿®æ”¹ï¼Œå°±ç®—ä¿®æ”¹äº†é›†åˆåº•å±‚çš„æ•°ç»„å®¹å™¨ï¼Œè¿­ä»£å™¨ä¾ç„¶å¼•ç”¨ç€ä»¥å‰çš„æ•°ç»„ï¼ˆ<strong>å¿«ç…§æ€æƒ³</strong>ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¼‚å¸¸</p>
<p>ConcurrentHashMap ä¸ä¼šå‡ºç°å¹¶å‘æ—¶çš„è¿­ä»£å¼‚å¸¸ï¼Œå› ä¸ºåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ CHM çš„è¿­ä»£å™¨å¹¶æ²¡æœ‰åˆ¤æ–­ç»“æ„çš„å˜åŒ–ï¼Œè¿­ä»£å™¨è¿˜å¯ä»¥æ ¹æ®è¿­ä»£çš„èŠ‚ç‚¹çŠ¶æ€å»å¯»æ‰¾å¹¶å‘æ‰©å®¹æ—¶çš„æ–°è¡¨è¿›è¡Œè¿­ä»£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConcurrentHashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line"><span class="comment">// KeyIterator</span></span><br><span class="line"><span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> map.keySet().iterator();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Traverser(Node&lt;K,V&gt;[] tab, <span class="type">int</span> size, <span class="type">int</span> index, <span class="type">int</span> limit) &#123;</span><br><span class="line">    <span class="comment">// å¼•ç”¨è¿˜æ˜¯åŸæ¥é›†åˆçš„ Node æ•°ç»„ï¼Œæ‰€ä»¥å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®çš„ä¿®æ”¹æ˜¯å¯è§çš„</span></span><br><span class="line">    <span class="built_in">this</span>.tab = tab;</span><br><span class="line">    <span class="built_in">this</span>.baseSize = size;</span><br><span class="line">    <span class="built_in">this</span>.baseIndex = <span class="built_in">this</span>.index = index;</span><br><span class="line">    <span class="built_in">this</span>.baseLimit = limit;</span><br><span class="line">    <span class="built_in">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123; <span class="keyword">return</span> next != <span class="literal">null</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; p;</span><br><span class="line">    <span class="keyword">if</span> ((p = next) == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">    <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> p.key;</span><br><span class="line">    lastReturned = p;</span><br><span class="line">    <span class="comment">// åœ¨æ–¹æ³•ä¸­è¿›è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·å–ï¼Œä¼šè¿›è¡Œæ§½ä½å¤´èŠ‚ç‚¹çš„çŠ¶æ€åˆ¤æ–­</span></span><br><span class="line">    advance();</span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="Collections">Collections</h3>
<p>Collections ç±»æ˜¯ç”¨æ¥æ“ä½œé›†åˆçš„å·¥å…·ç±»ï¼Œæä¾›äº†é›†åˆè½¬æ¢æˆçº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Collection&lt;T&gt; <span class="title function_">synchronizedCollection</span><span class="params">(Collection&lt;T&gt; c)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SynchronizedCollection</span>&lt;&gt;(c);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; Map&lt;K,V&gt; <span class="title function_">synchronizedMap</span><span class="params">(Map&lt;K,V&gt; m)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SynchronizedMap</span>&lt;&gt;(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æºç ï¼šåº•å±‚ä¹Ÿæ˜¯å¯¹æ–¹æ³•è¿›è¡ŒåŠ é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> c.add(e);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="SkipListMap">SkipListMap</h3>
<h4 id="åº•å±‚ç»“æ„-2">åº•å±‚ç»“æ„</h4>
<p>è·³è¡¨ SkipList æ˜¯ä¸€ä¸ª<strong>æœ‰åºçš„é“¾è¡¨</strong>ï¼Œé»˜è®¤å‡åºï¼Œåº•å±‚æ˜¯é“¾è¡¨åŠ å¤šçº§ç´¢å¼•çš„ç»“æ„ã€‚è·³è¡¨å¯ä»¥å¯¹å…ƒç´ è¿›è¡Œå¿«é€ŸæŸ¥è¯¢ï¼Œç±»ä¼¼äºå¹³è¡¡æ ‘ï¼Œæ˜¯ä¸€ç§åˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç®—æ³•</p>
<p>å¯¹äºå•é“¾è¡¨ï¼Œå³ä½¿é“¾è¡¨æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæŸ¥æ‰¾æ•°æ®ä¹Ÿåªèƒ½ä»å¤´åˆ°å°¾éå†é“¾è¡¨ï¼Œæ‰€ä»¥é‡‡ç”¨é“¾è¡¨ä¸Šå»ºç´¢å¼•çš„æ–¹å¼æé«˜æ•ˆç‡ï¼Œè·³è¡¨çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯ <strong>O(logn)</strong>ï¼Œç©ºé—´å¤æ‚åº¦ O(n)</p>
<p>ConcurrentSkipListMap æä¾›äº†ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®çš„æ’åºæ˜ å°„è¡¨ï¼Œå†…éƒ¨æ˜¯è·³è¡¨ç»“æ„å®ç°ï¼Œé€šè¿‡ CAS + volatile ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<p>å¹³è¡¡æ ‘å’Œè·³è¡¨çš„åŒºåˆ«ï¼š</p>
<ul>
<li>å¯¹å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤å¾€å¾€å¾ˆå¯èƒ½å¯¼è‡´å¹³è¡¡æ ‘è¿›è¡Œä¸€æ¬¡å…¨å±€çš„è°ƒæ•´ï¼›è€Œå¯¹è·³è¡¨çš„æ’å…¥å’Œåˆ é™¤ï¼Œ<strong>åªéœ€è¦å¯¹æ•´ä¸ªç»“æ„çš„å±€éƒ¨è¿›è¡Œæ“ä½œ</strong></li>
<li>åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•´ä¸ªå¹³è¡¡æ ‘çš„çº¿ç¨‹å®‰å…¨éœ€è¦ä¸€ä¸ªå…¨å±€é”ï¼›å¯¹äºè·³è¡¨åˆ™åªéœ€è¦éƒ¨åˆ†é”ï¼Œæ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentSkipListMap%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt=""></p>
<p>BaseHeader å­˜å‚¨æ•°æ®ï¼ŒheadIndex å­˜å‚¨ç´¢å¼•ï¼Œçºµå‘ä¸Š<strong>æ‰€æœ‰ç´¢å¼•éƒ½æŒ‡å‘é“¾è¡¨æœ€ä¸‹é¢çš„èŠ‚ç‚¹</strong></p>
<hr>
<h4 id="æˆå‘˜å˜é‡-3">æˆå‘˜å˜é‡</h4>
<ul>
<li>
<p>æ ‡è¯†ç´¢å¼•å¤´èŠ‚ç‚¹ä½ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">BASE_HEADER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è·³è¡¨çš„é¡¶å±‚ç´¢å¼•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> HeadIndex&lt;K,V&gt; head;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ¯”è¾ƒå™¨ï¼Œä¸º null åˆ™ä½¿ç”¨è‡ªç„¶æ’åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Comparator&lt;? <span class="built_in">super</span> K&gt; comparator;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Node èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt;&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;  				<span class="comment">// key æ˜¯ final çš„, è¯´æ˜èŠ‚ç‚¹ä¸€æ—¦å®šä¸‹æ¥, é™¤äº†åˆ é™¤, ä¸€èˆ¬ä¸ä¼šæ”¹åŠ¨ key</span></span><br><span class="line">    <span class="keyword">volatile</span> Object value; 		<span class="comment">// å¯¹åº”çš„ value</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;K, V&gt; next; 	<span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå•å‘é“¾è¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç´¢å¼•èŠ‚ç‚¹ Indexï¼Œåªæœ‰å‘ä¸‹å’Œå‘å³çš„æŒ‡é’ˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Index</span>&lt;K, V&gt;&#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node; 		<span class="comment">// ç´¢å¼•æŒ‡å‘çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªéƒ½ä¼šæŒ‡å‘æ•°æ®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Index&lt;K, V&gt; down; 	<span class="comment">// ä¸‹è¾¹levelå±‚çš„Indexï¼Œåˆ†å±‚ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">volatile</span> Index&lt;K, V&gt; right; <span class="comment">// å³è¾¹çš„Indexï¼Œå•å‘</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ index æœ¬èº«å’Œ succ ä¹‹é—´æ’å…¥ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ newSucc</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">link</span><span class="params">(Index&lt;K, V&gt; succ, Index&lt;K, V&gt; newSucc)</span>&#123;</span><br><span class="line">        Node&lt;K, V&gt; n = node;</span><br><span class="line">        newSucc.right = succ;</span><br><span class="line">        <span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„å³æŒ‡é’ˆä» succ æ”¹ä¸º newSucc</span></span><br><span class="line">        <span class="keyword">return</span> n.value != <span class="literal">null</span> &amp;&amp; casRight(succ, newSucc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­å¼€å½“å‰èŠ‚ç‚¹å’Œ succ èŠ‚ç‚¹ï¼Œå°†å½“å‰çš„èŠ‚ç‚¹ index è®¾ç½®å…¶çš„ right ä¸º succ.rightï¼Œå°±æ˜¯æŠŠ succ åˆ é™¤</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">unlink</span><span class="params">(Index&lt;K, V&gt; succ)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.value != <span class="literal">null</span> &amp;&amp; casRight(succ, succ.right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¤´ç´¢å¼•èŠ‚ç‚¹ HeadIndex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HeadIndex</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Index</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> level;	<span class="comment">// è¡¨ç¤ºç´¢å¼•å±‚çº§ï¼Œæ‰€æœ‰çš„ HeadIndex éƒ½æŒ‡å‘åŒä¸€ä¸ª Base_header èŠ‚ç‚¹</span></span><br><span class="line">    HeadIndex(Node&lt;K,V&gt; node, Index&lt;K,V&gt; down, Index&lt;K,V&gt; right, <span class="type">int</span> level) &#123;</span><br><span class="line">        <span class="built_in">super</span>(node, down, right);</span><br><span class="line">        <span class="built_in">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="æˆå‘˜æ–¹æ³•-8">æˆå‘˜æ–¹æ³•</h4>
<h5 id="å…¶ä»–æ–¹æ³•">å…¶ä»–æ–¹æ³•</h5>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentSkipListMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.comparator = <span class="literal">null</span>;	<span class="comment">// comparator ä¸º nullï¼Œä½¿ç”¨ key çš„è‡ªç„¶åºï¼Œå¦‚å­—å…¸åº</span></span><br><span class="line">    initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">    keySet = <span class="literal">null</span>;</span><br><span class="line">    entrySet = <span class="literal">null</span>;</span><br><span class="line">    values = <span class="literal">null</span>;</span><br><span class="line">    descendingMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç´¢å¼•å¤´èŠ‚ç‚¹ï¼ŒNode çš„ key ä¸º nullï¼Œvalue ä¸º BASE_HEADER å¯¹è±¡ï¼Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º null</span></span><br><span class="line">    <span class="comment">// head çš„åˆ†å±‚ç´¢å¼• down ä¸º nullï¼Œé“¾è¡¨çš„åç»­ç´¢å¼• right ä¸º nullï¼Œå±‚çº§ level ä¸ºç¬¬ 1 å±‚</span></span><br><span class="line">    head = <span class="keyword">new</span> <span class="title class_">HeadIndex</span>&lt;K,V&gt;(<span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(<span class="literal">null</span>, BASE_HEADER, <span class="literal">null</span>), <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>cprï¼šæ’åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ã€€x æ˜¯æ¯”è¾ƒè€…ï¼Œy æ˜¯è¢«æ¯”è¾ƒè€…ï¼Œæ¯”è¾ƒè€…å¤§äºè¢«æ¯”è¾ƒè€… è¿”å›æ­£æ•°ï¼Œå°äºè¿”å›è´Ÿæ•°ï¼Œç›¸ç­‰è¿”å› 0</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">cpr</span><span class="params">(Comparator c, Object x, Object y)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (c != <span class="literal">null</span>) ? c.compare(x, y) : ((Comparable)x).compareTo(y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="æ·»åŠ æ–¹æ³•-2">æ·»åŠ æ–¹æ³•</h5>
<ul>
<li>
<p>findPredecessor()ï¼šå¯»æ‰¾å‰ç½®èŠ‚ç‚¹</p>
<p>ä»æœ€ä¸Šå±‚çš„å¤´ç´¢å¼•å¼€å§‹å‘å³æŸ¥æ‰¾ï¼ˆé“¾è¡¨çš„åç»­ç´¢å¼•ï¼‰ï¼Œå¦‚æœåç»­ç´¢å¼•çš„èŠ‚ç‚¹çš„ key å¤§äºè¦æŸ¥æ‰¾çš„ keyï¼Œåˆ™å¤´ç´¢å¼•ç§»åˆ°ä¸‹å±‚é“¾è¡¨ï¼Œåœ¨ä¸‹å±‚é“¾è¡¨æŸ¥æ‰¾ï¼Œä»¥æ­¤åå¤ï¼Œä¸€ç›´æŸ¥æ‰¾åˆ°æ²¡æœ‰ä¸‹å±‚çš„åˆ†å±‚ç´¢å¼•ä¸ºæ­¢ï¼Œè¿”å›è¯¥ç´¢å¼•çš„èŠ‚ç‚¹ã€‚å¦‚æœåç»­ç´¢å¼•çš„èŠ‚ç‚¹çš„ key å°äºè¦æŸ¥æ‰¾çš„ keyï¼Œåˆ™åœ¨è¯¥å±‚é“¾è¡¨ä¸­å‘åæŸ¥æ‰¾ã€‚ç”±äºæŸ¥æ‰¾çš„ key å¯èƒ½æ°¸è¿œå¤§äºç´¢å¼•èŠ‚ç‚¹çš„ keyï¼Œæ‰€ä»¥åªèƒ½æ‰¾åˆ°ç›®æ ‡çš„å‰ç½®ç´¢å¼•èŠ‚ç‚¹ã€‚å¦‚æœé‡åˆ°ç©ºå€¼ç´¢å¼•çš„å­˜åœ¨ï¼Œé€šè¿‡ CAS æ¥æ–­å¼€ç´¢å¼•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node&lt;K,V&gt; <span class="title function_">findPredecessor</span><span class="params">(Object key, Comparator&lt;? <span class="built_in">super</span> K&gt; cmp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(); <span class="comment">// don&#x27;t postpone errors</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 1.åˆå§‹æ•°æ® q æ˜¯ headï¼Œr æ˜¯æœ€é¡¶å±‚ h çš„å³ Index èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (Index&lt;K,V&gt; q = head, r = q.right, d;;) &#123;</span><br><span class="line">            <span class="comment">// 2.å³ç´¢å¼•èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œå‘ä¸‹æŸ¥æ‰¾</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt; n = r.node;</span><br><span class="line">                <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> n.key;</span><br><span class="line">                <span class="comment">// 3.n.value ä¸º null è¯´æ˜èŠ‚ç‚¹ n æ­£åœ¨åˆ é™¤çš„è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶ã€å½“å‰çº¿ç¨‹å¸®å…¶åˆ é™¤ç´¢å¼•ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (n.value == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨ index å±‚ç›´æ¥åˆ é™¤ r ç´¢å¼•èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (!q.unlink(r))</span><br><span class="line">                        <span class="comment">// åˆ é™¤å¤±è´¥é‡æ–°ä» head èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œbreak ä¸€ä¸ª for åˆ°æ­¥éª¤ 1ï¼Œåˆä»åˆå§‹å€¼å¼€å§‹</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// åˆ é™¤èŠ‚ç‚¹ r æˆåŠŸï¼Œè·å–æ–°çš„ r èŠ‚ç‚¹,</span></span><br><span class="line">                    r = q.right;</span><br><span class="line">                    <span class="comment">// å›åˆ°æ­¥éª¤ 2ï¼Œè¿˜æ˜¯ä»è¿™å±‚ç´¢å¼•å¼€å§‹å‘å³éå†</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 4.è‹¥å‚æ•° key &gt; r.node.keyï¼Œåˆ™ç»§ç»­å‘å³éå†, continue åˆ°æ­¥éª¤ 2 å¤„è·å–å³èŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">//   è‹¥å‚æ•° key &lt; r.node.keyï¼Œè¯´æ˜éœ€è¦è¿›å…¥ä¸‹å±‚ç´¢å¼•ï¼Œåˆ°æ­¥éª¤ 5</span></span><br><span class="line">                <span class="keyword">if</span> (cpr(cmp, key, k) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    q = r;</span><br><span class="line">                    r = r.right;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 5.å…ˆè®© d æŒ‡å‘ q çš„ä¸‹ä¸€å±‚ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ nullï¼Œæ˜¯åˆ™è¯´æ˜å·²ç»åˆ°äº†æ•°æ®å±‚ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€å±‚</span></span><br><span class="line">            <span class="keyword">if</span> ((d = q.down) == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> q.node;</span><br><span class="line">            <span class="comment">// 6.æœªåˆ°æ•°æ®å±‚, è¿›è¡Œé‡æ–°èµ‹å€¼å‘ä¸‹æ‰«æ</span></span><br><span class="line">            q = d;		<span class="comment">// q æŒ‡å‘ d</span></span><br><span class="line">            r = d.right;<span class="comment">// r æŒ‡å‘ q çš„åç»­ç´¢å¼•èŠ‚ç‚¹ï¼Œæ­¤æ—¶(q.key &lt; key &lt; r.key)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentSkipListMap-Put%E6%B5%81%E7%A8%8B.png" alt=""></p>
</li>
<li>
<p>put()ï¼šæ·»åŠ æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­ï¼Œvalueä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">return</span> doPut(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">doPut</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; z;</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­ï¼Œkey ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cmp = comparator;</span><br><span class="line">    <span class="comment">// outer å¾ªç¯ï¼Œã€æŠŠå¾…æ’å…¥æ•°æ®æ’å…¥åˆ°æ•°æ®å±‚çš„åˆé€‚çš„ä½ç½®ï¼Œå¹¶åœ¨æ‰«æè¿‡ç¨‹ä¸­å¤„ç†å·²åˆ é™¤(value = null)çš„æ•°æ®ã€‘</span></span><br><span class="line">    outer: <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//0.for (;;)</span></span><br><span class="line">        <span class="comment">//1.å°† key å¯¹åº”çš„å‰ç»§èŠ‚ç‚¹æ‰¾åˆ°, b ä¸ºå‰ç»§èŠ‚ç‚¹ï¼Œæ˜¯æ•°æ®å±‚çš„, n æ˜¯å‰ç»§èŠ‚ç‚¹çš„ next,</span></span><br><span class="line">		<span class="comment">//  è‹¥æ²¡å‘ç”Ÿæ¡ä»¶ç«äº‰ï¼Œæœ€ç»ˆ key åœ¨ b ä¸ n ä¹‹é—´ (æ‰¾åˆ°çš„ b åœ¨ base_level ä¸Š)</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            <span class="comment">// 2.n ä¸ä¸º null è¯´æ˜ b ä¸æ˜¯é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (n != <span class="literal">null</span>) &#123;</span><br><span class="line">                Object v; <span class="type">int</span> c;</span><br><span class="line">                <span class="comment">// 3.è·å– n çš„å³èŠ‚ç‚¹</span></span><br><span class="line">                Node&lt;K,V&gt; f = n.next;</span><br><span class="line">                <span class="comment">// 4.æ¡ä»¶ç«äº‰ï¼Œå¹¶å‘ä¸‹å…¶ä»–çº¿ç¨‹åœ¨ b ä¹‹åæ’å…¥èŠ‚ç‚¹æˆ–ç›´æ¥åˆ é™¤èŠ‚ç‚¹ n, break åˆ°æ­¥éª¤ 0</span></span><br><span class="line">                <span class="keyword">if</span> (n != b.next)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//  è‹¥èŠ‚ç‚¹ n å·²ç»åˆ é™¤, åˆ™è°ƒç”¨ helpDelete è¿›è¡Œã€å¸®åŠ©åˆ é™¤èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> ((v = n.value) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    n.helpDelete(b, f);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 5.èŠ‚ç‚¹ b è¢«åˆ é™¤ä¸­ï¼Œåˆ™ break åˆ°æ­¥éª¤ 0,</span></span><br><span class="line">				<span class="comment">//  ã€è°ƒç”¨findPredecessorå¸®åŠ©åˆ é™¤indexå±‚çš„æ•°æ®, nodeå±‚çš„æ•°æ®ä¼šé€šè¿‡helpDeleteæ–¹æ³•è¿›è¡Œåˆ é™¤ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (b.value == <span class="literal">null</span> || v == n)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// 6.è‹¥ key &gt; n.keyï¼Œåˆ™è¿›è¡Œå‘åæ‰«æ</span></span><br><span class="line">                <span class="comment">//   è‹¥ key &lt; n.keyï¼Œåˆ™è¯æ˜ key åº”è¯¥å­˜å‚¨åœ¨ b å’Œ n ä¹‹é—´</span></span><br><span class="line">                <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    b = n;</span><br><span class="line">                    n = f;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 7.key çš„å€¼å’Œ n.key ç›¸ç­‰ï¼Œåˆ™å¯ä»¥ç›´æ¥è¦†ç›–èµ‹å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// onlyIfAbsent é»˜è®¤ falseï¼Œ</span></span><br><span class="line">                    <span class="keyword">if</span> (onlyIfAbsent || n.casValue(v, value)) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">V</span> <span class="variable">vv</span> <span class="operator">=</span> (V)v;</span><br><span class="line">                        <span class="comment">// è¿”å›è¢«è¦†ç›–çš„å€¼</span></span><br><span class="line">                        <span class="keyword">return</span> vv;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// caså¤±è´¥ï¼Œbreak ä¸€å±‚å¾ªç¯ï¼Œè¿”å› 0 é‡è¯•</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// else c &lt; 0; fall through</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 8.æ­¤æ—¶çš„æƒ…å†µ b.key &lt; key &lt; n.keyï¼Œå¯¹åº”æµç¨‹å›¾1ä¸­çš„7ï¼Œåˆ›å»ºzèŠ‚ç‚¹æŒ‡å‘n</span></span><br><span class="line">            z = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(key, value, n);</span><br><span class="line">            <span class="comment">// 9.å°è¯•æŠŠ b.next ä» n è®¾ç½®æˆ z</span></span><br><span class="line">            <span class="keyword">if</span> (!b.casNext(n, z))</span><br><span class="line">                <span class="comment">// caså¤±è´¥ï¼Œè¿”å›åˆ°æ­¥éª¤0ï¼Œé‡è¯•</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 10.break outer å, ä¸Šé¢çš„ for å¾ªç¯ä¸ä¼šå†æ‰§è¡Œ, è€Œåæ‰§è¡Œä¸‹é¢çš„ä»£ç </span></span><br><span class="line">            <span class="keyword">break</span> outer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ã€ä»¥ä¸Šæ’å…¥èŠ‚ç‚¹å·²ç»å®Œæˆï¼Œå‰©ä¸‹çš„ä»»åŠ¡è¦æ ¹æ®éšæœºæ•°çš„å€¼æ¥è¡¨ç¤ºæ˜¯å¦å‘ä¸Šå¢åŠ å±‚æ•°ä¸ä¸Šå±‚ç´¢å¼•ã€‘</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšæœºæ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rnd</span> <span class="operator">=</span> ThreadLocalRandom.nextSecondarySeed();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéšæœºæ•°çš„äºŒè¿›åˆ¶ä¸ 10000000000000000000000000000001 è¿›è¡Œä¸è¿ç®—ä¸º 0</span></span><br><span class="line">    <span class="comment">// å³éšæœºæ•°çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸æœ€æœ«å°¾å¿…é¡»ä¸º 0ï¼Œå…¶ä»–ä½æ— æ‰€è°“ï¼Œå°±è¿›å…¥è¯¥å¾ªç¯</span></span><br><span class="line">    <span class="comment">// å¦‚æœéšæœºæ•°çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸æœ€æœ«ä½ä¸ä¸º 0ï¼Œä¸å¢åŠ æ–°èŠ‚ç‚¹çš„å±‚æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 11.åˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ  levelï¼Œ32 ä½</span></span><br><span class="line">    <span class="keyword">if</span> ((rnd &amp; <span class="number">0x80000001</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç´¢å¼•å±‚ levelï¼Œä» 1 å¼€å§‹ï¼Œå°±æ˜¯æœ€åº•å±‚</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> <span class="number">1</span>, max;</span><br><span class="line">        <span class="comment">// 12.åˆ¤æ–­æœ€ä½ä½å‰é¢æœ‰å‡ ä¸ª 1ï¼Œæœ‰å‡ ä¸ªleveå°±åŠ å‡ ï¼š0..0 0001 1110ï¼Œè¿™æ˜¯4ä¸ªï¼Œåˆ™1+4=5</span></span><br><span class="line">        <span class="comment">//    ã€æœ€å¤§æœ‰30ä¸ªå°±æ˜¯ 1 + 30 = 31</span></span><br><span class="line">        <span class="keyword">while</span> (((rnd &gt;&gt;&gt;= <span class="number">1</span>) &amp; <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">            ++level;</span><br><span class="line">        <span class="comment">// æœ€ç»ˆä¼šæŒ‡å‘ z èŠ‚ç‚¹ï¼Œå°±æ˜¯æ·»åŠ çš„èŠ‚ç‚¹</span></span><br><span class="line">        Index&lt;K,V&gt; idx = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// æŒ‡å‘å¤´ç´¢å¼•èŠ‚ç‚¹</span></span><br><span class="line">        HeadIndex&lt;K,V&gt; h = head;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 13.åˆ¤æ–­levelæ˜¯å¦æ¯”å½“å‰æœ€é«˜ç´¢å¼•å°ï¼Œå›¾ä¸­ max ä¸º 3</span></span><br><span class="line">        <span class="keyword">if</span> (level &lt;= (max = h.level)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= level; ++i)</span><br><span class="line">                <span class="comment">// æ ¹æ®å±‚æ•°levelä¸æ–­åˆ›å»ºæ–°å¢èŠ‚ç‚¹çš„ä¸Šå±‚ç´¢å¼•ï¼Œç´¢å¼•çš„åç»§ç´¢å¼•ç•™ç©º</span></span><br><span class="line">                <span class="comment">// ç¬¬ä¸€æ¬¡idxä¸ºnullï¼Œä¹Ÿå°±æ˜¯ä¸‹å±‚ç´¢å¼•ä¸ºç©ºï¼Œç¬¬äºŒæ¬¡æŠŠä¸Šæ¬¡çš„ç´¢å¼•ä½œä¸ºä¸‹å±‚ç´¢å¼•ï¼Œã€ç±»ä¼¼å¤´æ’æ³•ã€‘</span></span><br><span class="line">                idx = <span class="keyword">new</span> <span class="title class_">Index</span>&lt;K,V&gt;(z, idx, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// å¾ªç¯ä»¥åçš„ç´¢å¼•ç»“æ„</span></span><br><span class="line">            <span class="comment">// index-3	â† idx</span></span><br><span class="line">            <span class="comment">//   â†“</span></span><br><span class="line">            <span class="comment">// index-2</span></span><br><span class="line">            <span class="comment">//   â†“</span></span><br><span class="line">            <span class="comment">// index-1</span></span><br><span class="line">            <span class="comment">//   â†“</span></span><br><span class="line">            <span class="comment">//  z-node</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 14.è‹¥ level &gt; maxï¼Œåˆ™ã€åªå¢åŠ ä¸€å±‚ index ç´¢å¼•å±‚ã€‘ï¼Œ3 + 1 = 4</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            level = max + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ª index æ•°ç»„ï¼Œé•¿åº¦æ˜¯ level+1ï¼Œå‡è®¾ level æ˜¯ 4ï¼Œåˆ›å»ºçš„æ•°ç»„é•¿åº¦ä¸º 5</span></span><br><span class="line">            Index&lt;K,V&gt;[] idxs = (Index&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Index</span>&lt;?,?&gt;[level+<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// index[0]çš„æ•°ç»„ slot å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œåªä½¿ç”¨ [1,level] è¿™äº›æ•°ç»„çš„ slot</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= level; ++i)</span><br><span class="line">                idxs[i] = idx = <span class="keyword">new</span> <span class="title class_">Index</span>&lt;K,V&gt;(z, idx, <span class="literal">null</span>);</span><br><span class="line">              		<span class="comment">// index-4   â† idx</span></span><br><span class="line">                    <span class="comment">//   â†“</span></span><br><span class="line">                  	<span class="comment">// ......</span></span><br><span class="line">                    <span class="comment">//   â†“</span></span><br><span class="line">                    <span class="comment">// index-1</span></span><br><span class="line">                    <span class="comment">//   â†“</span></span><br><span class="line">                    <span class="comment">//  z-node</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                h = head;</span><br><span class="line">                <span class="comment">// è·å–å¤´ç´¢å¼•çš„å±‚æ•°ï¼Œ3</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">oldLevel</span> <span class="operator">=</span> h.level;</span><br><span class="line">                <span class="comment">// å¦‚æœ level &lt;= oldLevelï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹è¿›è¡Œäº† index å±‚å¢åŠ æ“ä½œï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (level &lt;= oldLevel)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// å®šä¹‰ä¸€ä¸ªæ–°çš„å¤´ç´¢å¼•èŠ‚ç‚¹</span></span><br><span class="line">                HeadIndex&lt;K,V&gt; newh = h;</span><br><span class="line">                <span class="comment">// è·å–å¤´ç´¢å¼•çš„èŠ‚ç‚¹ï¼Œå°±æ˜¯ BASE_HEADER</span></span><br><span class="line">                Node&lt;K,V&gt; oldbase = h.node;</span><br><span class="line">                <span class="comment">// å‡çº§ baseHeader ç´¢å¼•ï¼Œå‡é«˜ä¸€çº§ï¼Œå¹¶å‘ä¸‹å¯èƒ½å‡é«˜å¤šçº§</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> oldLevel + <span class="number">1</span>; j &lt;= level; ++j)</span><br><span class="line">                    <span class="comment">// å‚æ•°1ï¼šåº•å±‚nodeï¼Œå‚æ•°äºŒï¼šdownï¼Œä¸ºä»¥å‰çš„å¤´èŠ‚ç‚¹ï¼Œå‚æ•°ä¸‰ï¼šrightï¼Œæ–°å»º</span></span><br><span class="line">                    newh = <span class="keyword">new</span> <span class="title class_">HeadIndex</span>&lt;K,V&gt;(oldbase, newh, idxs[j], j);</span><br><span class="line">                <span class="comment">// æ‰§è¡Œå®Œforå¾ªç¯ä¹‹åï¼ŒbaseHeader ç´¢å¼•é•¿è¿™ä¸ªæ ·å­ï¼Œè¿™é‡Œåªå‡é«˜ä¸€çº§</span></span><br><span class="line">                <span class="comment">// index-4             â†’             index-4	â† idx</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// index-3                           index-3</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// index-2                           index-2</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// index-1                           index-1</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// baseHeader    â†’    ....      â†’     z-node</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// cas æˆåŠŸåï¼Œhead å­—æ®µæŒ‡å‘æœ€æ–°çš„ headIndexï¼ŒbaseHeader çš„ index-4</span></span><br><span class="line">                <span class="keyword">if</span> (casHead(h, newh)) &#123;</span><br><span class="line">                    <span class="comment">// h æŒ‡å‘æœ€æ–°çš„ index-4 èŠ‚ç‚¹</span></span><br><span class="line">                    h = newh;</span><br><span class="line">                    <span class="comment">// è®© idx æŒ‡å‘ z-node çš„ index-3 èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">					<span class="comment">// å› ä¸ºä» index-3 - index-1 çš„è¿™äº› z-node ç´¢å¼•èŠ‚ç‚¹ éƒ½æ²¡æœ‰æ’å…¥åˆ°ç´¢å¼•é“¾è¡¨</span></span><br><span class="line">                    idx = idxs[level = oldLevel];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 15.ã€æŠŠæ–°åŠ çš„ç´¢å¼•æ’å…¥ç´¢å¼•é“¾è¡¨ä¸­ã€‘ï¼Œæœ‰ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§ç´¢å¼•é«˜åº¦ä¸å˜ï¼Œå¦ä¸€ç§æ˜¯é«˜åº¦åŠ  1</span></span><br><span class="line">        <span class="comment">// è¦æ’å…¥çš„æ˜¯ç¬¬å‡ å±‚çš„ç´¢å¼•</span></span><br><span class="line">        splice: <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">insertionLevel</span> <span class="operator">=</span> level;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å¤´ç´¢å¼•çš„å±‚æ•°ï¼Œæƒ…å†µ 1 æ˜¯ 3ï¼Œæƒ…å†µ 2 æ˜¯ 4</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> h.level;</span><br><span class="line">            <span class="comment">// ã€éå† insertionLevel å±‚çš„ç´¢å¼•ï¼Œæ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ã€‘</span></span><br><span class="line">            <span class="keyword">for</span> (Index&lt;K,V&gt; q = h, r = q.right, t = idx;;) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå¤´ç´¢å¼•ä¸º null æˆ–è€…æ–°å¢èŠ‚ç‚¹ç´¢å¼•ä¸º nullï¼Œé€€å‡ºæ’å…¥ç´¢å¼•çš„æ€»å¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (q == <span class="literal">null</span> || t == <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// æ­¤å¤„è¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹åˆ é™¤äº†å¤´ç´¢å¼•æˆ–è€…æ–°å¢èŠ‚ç‚¹çš„ç´¢å¼•</span></span><br><span class="line">                    <span class="keyword">break</span> splice;</span><br><span class="line">                <span class="comment">// å¤´ç´¢å¼•çš„é“¾è¡¨åç»­ç´¢å¼•å­˜åœ¨ï¼Œå¦‚æœæ˜¯æ–°å±‚åˆ™ä¸ºæ–°èŠ‚ç‚¹ç´¢å¼•ï¼Œå¦‚æœæ˜¯è€å±‚åˆ™ä¸ºåŸç´¢å¼•</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// è·å–rçš„èŠ‚ç‚¹</span></span><br><span class="line">                    Node&lt;K,V&gt; n = r.node;</span><br><span class="line">                    <span class="comment">// æ’å…¥çš„keyå’Œn.keyçš„æ¯”è¾ƒå€¼</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> cpr(cmp, key, n.key);</span><br><span class="line">                    <span class="comment">// ã€åˆ é™¤ç©ºå€¼ç´¢å¼•ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (n.value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!q.unlink(r))</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        r = q.right;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// key &gt; r.node.keyï¼Œå‘å³æ‰«æ</span></span><br><span class="line">                    <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        q = r;</span><br><span class="line">                        r = r.right;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ key &lt; r.node.keyï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ j å±‚æ’å…¥æ–°å¢èŠ‚ç‚¹çš„å‰ç½®ç´¢å¼•</span></span><br><span class="line">                <span class="keyword">if</span> (j == insertionLevel) &#123;</span><br><span class="line">                    <span class="comment">// ã€å°†æ–°ç´¢å¼•èŠ‚ç‚¹ t æ’å…¥ q r ä¹‹é—´ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (!q.link(r, t))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ–°å¢èŠ‚ç‚¹çš„å€¼ä¸º nullï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤</span></span><br><span class="line">                    <span class="keyword">if</span> (t.node.value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ‰¾åˆ°è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                        findNode(key);</span><br><span class="line">                        <span class="keyword">break</span> splice;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ’å…¥å±‚é€å±‚è‡ªå‡ï¼Œå½“ä¸ºæœ€åº•å±‚æ—¶é€€å‡ºå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">if</span> (--insertionLevel == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span> splice;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">// å…¶ä»–èŠ‚ç‚¹éšç€æ’å…¥èŠ‚ç‚¹çš„å±‚æ•°ä¸‹ç§»è€Œä¸‹ç§»</span></span><br><span class="line">                <span class="keyword">if</span> (--j &gt;= insertionLevel &amp;&amp; j &lt; level)</span><br><span class="line">                    t = t.down;</span><br><span class="line">                q = q.down;</span><br><span class="line">                r = q.right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>findNode()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node&lt;K,V&gt; <span class="title function_">findNode</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// åŸç†ä¸doGetç›¸åŒï¼Œæ— éæ˜¯ findNode è¿”å›èŠ‚ç‚¹ï¼ŒdoGet è¿”å› value</span></span><br><span class="line">    <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="è·å–æ–¹æ³•-2">è·å–æ–¹æ³•</h5>
<ul>
<li>
<p>get(key)ï¼šè·å–å¯¹åº”çš„æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doGet(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>doGet()ï¼šæ‰«æè¿‡ç¨‹ä¼šå¯¹å·² value = null çš„å…ƒç´ è¿›è¡Œåˆ é™¤å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">doGet</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cmp = comparator;</span><br><span class="line">    outer: <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 1.æ‰¾åˆ°æœ€åº•å±‚èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; <span class="type">int</span> c;</span><br><span class="line">            <span class="comment">// 2.ã€å¦‚æœè¯¥å‰ç½®èŠ‚ç‚¹çš„é“¾è¡¨åç»­èŠ‚ç‚¹ä¸º nullï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">// b â†’ n â†’ f</span></span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            <span class="comment">// 3.å¦‚æœnä¸ä¸ºå‰ç½®èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åˆ é™¤äº†è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (n != b.next)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 4.å¦‚æœåç»­èŠ‚ç‚¹çš„å€¼ä¸ºnullï¼Œã€éœ€è¦å¸®åŠ©åˆ é™¤è¯¥èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> ((v = n.value) == <span class="literal">null</span>) &#123;</span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 5.å¦‚æœå‰ç½®èŠ‚ç‚¹å·²è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤ï¼Œé‡æ–°å¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (b.value == <span class="literal">null</span> || v == n)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">             <span class="comment">// 6.å¦‚æœè¦è·å–çš„keyä¸åç»­èŠ‚ç‚¹çš„keyç›¸ç­‰ï¼Œè¿”å›èŠ‚ç‚¹çš„value</span></span><br><span class="line">            <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">V</span> <span class="variable">vv</span> <span class="operator">=</span> (V)v;</span><br><span class="line">                <span class="keyword">return</span> vv;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 7.key &lt; n.keyï¼Œå› ä½ key &gt; b.keyï¼Œb å’Œ n ç›¸è¿ï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹æˆ–è€…è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤äº†</span></span><br><span class="line">            <span class="keyword">if</span> (c &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            b = n;</span><br><span class="line">            n = f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="åˆ é™¤æ–¹æ³•-2">åˆ é™¤æ–¹æ³•</h5>
<ul>
<li>
<p>remove()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doRemove(key, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">doRemove</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cmp = comparator;</span><br><span class="line">    outer: <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 1.æ‰¾åˆ°æœ€åº•å±‚ç›®æ ‡èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œb.key &lt; key</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; <span class="type">int</span> c;</span><br><span class="line">            <span class="comment">// 2.å¦‚æœè¯¥å‰ç½®èŠ‚ç‚¹çš„é“¾è¡¨åç»­èŠ‚ç‚¹ä¸º nullï¼Œé€€å‡ºå¾ªç¯ï¼Œè¯´æ˜ä¸å­˜åœ¨è¿™ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">// b â†’ n â†’ f</span></span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            <span class="keyword">if</span> (n != b.next)                    <span class="comment">// inconsistent read</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> ((v = n.value) == <span class="literal">null</span>) &#123;        <span class="comment">// n is deleted</span></span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (b.value == <span class="literal">null</span> || v == n)      <span class="comment">// b is deleted</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//3.key &lt; n.keyï¼Œè¯´æ˜è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤äº†ï¼Œæˆ–è€…ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">//4.key &gt; n.keyï¼Œç»§ç»­å‘åæ‰«æ</span></span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                b = n;</span><br><span class="line">                n = f;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5.åˆ°è¿™é‡Œæ˜¯ key = n.keyï¼Œvalue ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹åˆ¤æ–­ value å’Œ n.value æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; !value.equals(v))</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">//6.ã€æŠŠ n èŠ‚ç‚¹çš„ value ç½®ç©ºã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (!n.casValue(v, <span class="literal">null</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//7.ã€ç»™ n æ·»åŠ ä¸€ä¸ªåˆ é™¤æ ‡å¿— markã€‘ï¼Œmark.next = fï¼Œç„¶åæŠŠ b.next è®¾ç½®ä¸º fï¼ŒæˆåŠŸånå‡ºé˜Ÿ</span></span><br><span class="line">            <span class="keyword">if</span> (!n.appendMarker(f) || !b.casNext(n, f))</span><br><span class="line">                <span class="comment">// å¯¹ key å¯¹åº”çš„ index è¿›è¡Œåˆ é™¤ï¼Œè°ƒç”¨äº† findPredecessor æ–¹æ³•</span></span><br><span class="line">                findNode(key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è¿›è¡Œæ“ä½œå¤±è´¥åé€šè¿‡ findPredecessor ä¸­è¿›è¡Œ index çš„åˆ é™¤</span></span><br><span class="line">                findPredecessor(key, cmp);</span><br><span class="line">                <span class="keyword">if</span> (head.right == <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// è¿›è¡ŒheadIndex å¯¹åº”çš„index å±‚çš„åˆ é™¤</span></span><br><span class="line">                    tryReduceLevel();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">V</span> <span class="variable">vv</span> <span class="operator">=</span> (V)v;</span><br><span class="line">            <span class="keyword">return</span> vv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ findPredecessor() ä¸­çš„ unlink() åç´¢å¼•å·²ç»è¢«åˆ é™¤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentSkipListMap-remove%E6%B5%81%E7%A8%8B.png" alt=""></p>
</li>
<li>
<p>appendMarker()ï¼šæ·»åŠ åˆ é™¤æ ‡è®°èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">appendMarker</span><span class="params">(Node&lt;K,V&gt; f)</span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ CAS è®© n.next æŒ‡å‘ä¸€ä¸ª key ä¸º nullï¼Œvalue ä¸º thisï¼Œnext ä¸º f çš„æ ‡è®°èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> casNext(f, <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(f));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>helpDelete()ï¼šå°†æ·»åŠ äº†åˆ é™¤æ ‡è®°çš„èŠ‚ç‚¹æ¸…é™¤ï¼Œå‚æ•°æ˜¯è¯¥èŠ‚ç‚¹çš„å‰é©±å’Œåç»§èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">helpDelete</span><span class="params">(Node&lt;K,V&gt; b, Node&lt;K,V&gt; f)</span> &#123;</span><br><span class="line">    <span class="comment">// this èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹ä¸º fï¼Œä¸”æœ¬èº«ä¸º b çš„åç»­èŠ‚ç‚¹ï¼Œä¸€èˆ¬éƒ½æ˜¯æ­£ç¡®çš„ï¼Œé™¤éè¢«åˆ«çš„çº¿ç¨‹åˆ é™¤</span></span><br><span class="line">    <span class="keyword">if</span> (f == next &amp;&amp; <span class="built_in">this</span> == b.next) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ n è¿˜è¿˜æ²¡æœ‰è¢«æ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (f == <span class="literal">null</span> || f.value != f)</span><br><span class="line">            casNext(f, <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(f));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// é€šè¿‡ CASï¼Œå°† b çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ n å˜æˆ f.nextï¼Œå³æˆä¸ºå›¾ä¸­çš„æ ·å¼</span></span><br><span class="line">            b.casNext(<span class="built_in">this</span>, f.next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>tryReduceLevel()ï¼šåˆ é™¤ç´¢å¼•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">tryReduceLevel</span><span class="params">()</span> &#123;</span><br><span class="line">    HeadIndex&lt;K,V&gt; h = head;</span><br><span class="line">    HeadIndex&lt;K,V&gt; d;</span><br><span class="line">    HeadIndex&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> (h.level &gt; <span class="number">3</span> &amp;&amp;</span><br><span class="line">        (d = (HeadIndex&lt;K,V&gt;)h.down) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        (e = (HeadIndex&lt;K,V&gt;)d.down) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        e.right == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        d.right == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        h.right == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤´ç´¢å¼•</span></span><br><span class="line">        casHead(h, d) &amp;&amp;</span><br><span class="line">        <span class="comment">// é‡æ–°æ£€æŸ¥</span></span><br><span class="line">        h.right != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// é‡æ–°æ£€æŸ¥è¿”å›trueï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹å¢åŠ äº†ç´¢å¼•å±‚çº§ï¼ŒæŠŠç´¢å¼•å¤´èŠ‚ç‚¹è®¾ç½®å›æ¥</span></span><br><span class="line">        casHead(d, h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://my.oschina.net/u/3768341/blog/3135659">https://my.oschina.net/u/3768341/blog/3135659</a></p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Er4y1P7k1">https://www.bilibili.com/video/BV1Er4y1P7k1</a></p>
<hr>
<h3 id="NoBlocking">NoBlocking</h3>
<h4 id="éé˜»å¡é˜Ÿåˆ—">éé˜»å¡é˜Ÿåˆ—</h4>
<p>å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œéœ€è¦ç”¨åˆ°å®‰å…¨çš„é˜Ÿåˆ—ï¼Œå®ç°å®‰å…¨é˜Ÿåˆ—å¯ä»¥ä½¿ç”¨ 2 ç§æ–¹å¼ï¼š</p>
<ul>
<li>åŠ é”ï¼Œè¿™ç§å®ç°æ–¹å¼æ˜¯é˜»å¡é˜Ÿåˆ—</li>
<li>ä½¿ç”¨å¾ªç¯ CAS ç®—æ³•å®ç°ï¼Œè¿™ç§æ–¹å¼æ˜¯éé˜»å¡é˜Ÿåˆ—</li>
</ul>
<p>ConcurrentLinkedQueue æ˜¯ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œå½“æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå½“è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ </p>
<p>è¡¥å……ï¼šConcurrentLinkedDeque æ˜¯åŒå‘é“¾è¡¨ç»“æ„çš„æ— ç•Œå¹¶å‘é˜Ÿåˆ—</p>
<p>ConcurrentLinkedQueue ä½¿ç”¨çº¦å®šï¼š</p>
<ol>
<li>ä¸å…è®¸ null å…¥åˆ—</li>
<li>é˜Ÿåˆ—ä¸­æ‰€æœ‰æœªåˆ é™¤çš„èŠ‚ç‚¹çš„ item éƒ½ä¸èƒ½ä¸º null ä¸”éƒ½èƒ½ä» head èŠ‚ç‚¹éå†åˆ°</li>
<li>åˆ é™¤èŠ‚ç‚¹æ˜¯å°† item è®¾ç½®ä¸º nullï¼Œé˜Ÿåˆ—è¿­ä»£æ—¶è·³è¿‡ item ä¸º null èŠ‚ç‚¹</li>
<li>head èŠ‚ç‚¹è·Ÿ tail ä¸ä¸€å®šæŒ‡å‘å¤´èŠ‚ç‚¹æˆ–å°¾èŠ‚ç‚¹ï¼Œå¯èƒ½<strong>å­˜åœ¨æ»åæ€§</strong></li>
</ol>
<p>ConcurrentLinkedQueue ç”± head èŠ‚ç‚¹å’Œ tail èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±èŠ‚ç‚¹å…ƒç´ å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ç»„æˆï¼Œç»„æˆä¸€å¼ é“¾è¡¨ç»“æ„çš„é˜Ÿåˆ—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; head;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; tail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">volatile</span> E item;</span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;E&gt; next;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ„é€ æ–¹æ³•-2">æ„é€ æ–¹æ³•</h4>
<ul>
<li>
<p>æ— å‚æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentLinkedQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ head èŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä¸ºç©ºï¼Œdummy èŠ‚ç‚¹ï¼Œtail èŠ‚ç‚¹ç­‰äº head èŠ‚ç‚¹</span></span><br><span class="line">    head = tail = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æœ‰å‚æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentLinkedQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> &#123;</span><br><span class="line">    Node&lt;E&gt; h = <span class="literal">null</span>, t = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// éå†èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">        <span class="keyword">if</span> (h == <span class="literal">null</span>)</span><br><span class="line">            h = t = newNode;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å•å‘é“¾è¡¨</span></span><br><span class="line">            t.lazySetNext(newNode);</span><br><span class="line">            t = newNode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">null</span>)</span><br><span class="line">        h = t = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">    head = h;</span><br><span class="line">    tail = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="å…¥é˜Ÿæ–¹æ³•">å…¥é˜Ÿæ–¹æ³•</h4>
<p>ä¸ä¼ ç»Ÿçš„é“¾è¡¨ä¸åŒï¼Œå•çº¿ç¨‹å…¥é˜Ÿçš„å·¥ä½œæµç¨‹ï¼š</p>
<ul>
<li>å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆå½“å‰é˜Ÿåˆ—å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li>
<li>æ›´æ–° tail èŠ‚ç‚¹ï¼Œå¦‚æœ tail èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆ tail èŠ‚ç‚¹ï¼›å¦‚æœ tail èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆ tail çš„ next èŠ‚ç‚¹ï¼Œæ‰€ä»¥ tail èŠ‚ç‚¹ä¸æ€»æ˜¯å°¾èŠ‚ç‚¹ï¼Œ<strong>å­˜åœ¨æ»åæ€§</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå…¥é˜ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯ CAS ç›´åˆ°å…¥é˜ŸæˆåŠŸ</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</span><br><span class="line">        <span class="comment">// p ç”¨æ¥è¡¨ç¤ºé˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œåˆå§‹æƒ…å†µä¸‹ç­‰äº tail èŠ‚ç‚¹ï¼Œq æ˜¯ p çš„ next èŠ‚ç‚¹</span></span><br><span class="line">        Node&lt;E&gt; q = p.next;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ p æ˜¯å°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (q == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// p æ˜¯å°¾èŠ‚ç‚¹ï¼Œè®¾ç½® p èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">// è®¾ç½®æˆåŠŸåˆ™ casNext è¿”å› trueï¼Œå¦åˆ™è¿”å› falseï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡å°¾èŠ‚ç‚¹ï¼Œç»§ç»­å¯»æ‰¾å°¾èŠ‚ç‚¹ï¼Œç»§ç»­ CAS</span></span><br><span class="line">            <span class="keyword">if</span> (p.casNext(<span class="literal">null</span>, newNode)) &#123;</span><br><span class="line">                <span class="comment">// é¦–æ¬¡æ·»åŠ æ—¶ï¼Œp ç­‰äº tï¼Œä¸è¿›è¡Œå°¾èŠ‚ç‚¹æ›´æ–°ï¼Œæ‰€ä»¥å°¾èŠ‚ç‚¹å­˜åœ¨æ»åæ€§</span></span><br><span class="line">                <span class="keyword">if</span> (p != t)</span><br><span class="line">                    <span class="comment">// å°† tail è®¾ç½®æˆæ–°å…¥é˜Ÿçš„èŠ‚ç‚¹ï¼Œè®¾ç½®å¤±è´¥è¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ›´æ–°äº† tail èŠ‚ç‚¹</span></span><br><span class="line">                    casTail(t, newNode);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">            <span class="comment">// å½“ tail ä¸æŒ‡å‘æœ€åèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœæ‰§è¡Œå‡ºåˆ—æ“ä½œï¼Œå¯èƒ½å°† tail ä¹Ÿç§»é™¤ï¼Œtail ä¸åœ¨é“¾è¡¨ä¸­</span></span><br><span class="line">        	<span class="comment">// æ­¤æ—¶éœ€è¦å¯¹ tail èŠ‚ç‚¹è¿›è¡Œå¤ä½ï¼Œå¤ä½åˆ° head èŠ‚ç‚¹</span></span><br><span class="line">            p = (t != (t = tail)) ? t : head;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ¨åŠ¨ tail å°¾èŠ‚ç‚¹å¾€é˜Ÿå°¾ç§»åŠ¨</span></span><br><span class="line">            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›¾è§£å…¥é˜Ÿï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentLinkedQueue%E5%85%A5%E9%98%9F%E6%93%8D%E4%BD%9C1.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentLinkedQueue%E5%85%A5%E9%98%9F%E6%93%8D%E4%BD%9C2.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentLinkedQueue%E5%85%A5%E9%98%9F%E6%93%8D%E4%BD%9C3.png" alt=""></p>
<p>å½“ tail èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹çš„è·ç¦»<strong>å¤§äºç­‰äº 1</strong> æ—¶ï¼ˆæ¯å…¥é˜Ÿä¸¤æ¬¡ï¼‰æ›´æ–° tailï¼Œå¯ä»¥å‡å°‘ CAS æ›´æ–° tail èŠ‚ç‚¹çš„æ¬¡æ•°ï¼Œæé«˜å…¥é˜Ÿæ•ˆç‡</p>
<p>çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<ul>
<li>çº¿ç¨‹ 1 çº¿ç¨‹ 2 åŒæ—¶å…¥é˜Ÿï¼Œæ— è®ºä»å“ªä¸ªä½ç½®å¼€å§‹å¹¶å‘å…¥é˜Ÿï¼Œéƒ½å¯ä»¥å¾ªç¯ CASï¼Œç›´åˆ°å…¥é˜ŸæˆåŠŸï¼Œçº¿ç¨‹å®‰å…¨</li>
<li>çº¿ç¨‹ 1 éå†ï¼Œçº¿ç¨‹ 2 å…¥é˜Ÿï¼Œæ‰€ä»¥é€ æˆ ConcurrentLinkedQueue çš„ size æ˜¯å˜åŒ–ï¼Œéœ€è¦åŠ é”ä¿è¯å®‰å…¨</li>
<li>çº¿ç¨‹ 1 çº¿ç¨‹ 2 åŒæ—¶å‡ºåˆ—ï¼Œçº¿ç¨‹ä¹Ÿæ˜¯å®‰å…¨çš„</li>
</ul>
<hr>
<h4 id="å‡ºé˜Ÿæ–¹æ³•">å‡ºé˜Ÿæ–¹æ³•</h4>
<p>å‡ºé˜Ÿåˆ—çš„å°±æ˜¯ä»é˜Ÿåˆ—é‡Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹å…ƒç´ ï¼Œå¹¶æ¸…ç©ºè¯¥èŠ‚ç‚¹å¯¹å…ƒç´ çš„å¼•ç”¨ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡å‡ºé˜Ÿéƒ½æ›´æ–° head èŠ‚ç‚¹</p>
<ul>
<li>å½“ head èŠ‚ç‚¹é‡Œæœ‰å…ƒç´ æ—¶ï¼Œç›´æ¥å¼¹å‡º head èŠ‚ç‚¹é‡Œçš„å…ƒç´ ï¼Œè€Œä¸ä¼šæ›´æ–° head èŠ‚ç‚¹</li>
<li>å½“ head èŠ‚ç‚¹é‡Œæ²¡æœ‰å…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿæ“ä½œæ‰ä¼šæ›´æ–° head èŠ‚ç‚¹</li>
</ul>
<p><strong>æ‰¹å¤„ç†æ–¹å¼</strong>å¯ä»¥å‡å°‘ä½¿ç”¨ CAS æ›´æ–° head èŠ‚ç‚¹çš„æ¶ˆè€—ï¼Œä»è€Œæé«˜å‡ºé˜Ÿæ•ˆç‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// p èŠ‚ç‚¹è¡¨ç¤ºé¦–èŠ‚ç‚¹ï¼Œå³éœ€è¦å‡ºé˜Ÿçš„èŠ‚ç‚¹ï¼ŒFIFO</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> p.item;</span><br><span class="line">			<span class="comment">// å¦‚æœ p èŠ‚ç‚¹çš„å…ƒç´ ä¸ä¸º nullï¼Œåˆ™é€šè¿‡ CAS æ¥è®¾ç½® p èŠ‚ç‚¹å¼•ç”¨å…ƒç´ ä¸º nullï¼ŒæˆåŠŸè¿”å› item</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span> &amp;&amp; p.casItem(item, <span class="literal">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (p != h)</span><br><span class="line">                   	<span class="comment">// å¯¹ head è¿›è¡Œç§»åŠ¨</span></span><br><span class="line">                    updateHead(h, ((q = p.next) != <span class="literal">null</span>) ? q : p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">           	<span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å¤´èŠ‚ç‚¹çš„å…ƒç´ ä¸ºç©ºæˆ–å¤´èŠ‚ç‚¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå¤´èŠ‚ç‚¹è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†</span></span><br><span class="line">            <span class="comment">// é‚£ä¹ˆè·å– p èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœ p èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹ä¹Ÿä¸º nullï¼Œåˆ™è¡¨æ˜é˜Ÿåˆ—å·²ç»ç©ºäº†</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((q = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">      		<span class="comment">// ç¬¬ä¸€è½®æ“ä½œå¤±è´¥ï¼Œä¸‹ä¸€è½®ç»§ç»­ï¼Œè°ƒå›åˆ°å¾ªç¯å‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™å°†å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">updateHead</span><span class="params">(Node&lt;E&gt; h, Node&lt;E&gt; p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (h != p &amp;&amp; casHead(h, p))</span><br><span class="line">        <span class="comment">// å°†æ—§ç»“ç‚¹ h çš„ next åŸŸæŒ‡å‘ä¸º hï¼Œhelp gc</span></span><br><span class="line">        h.lazySetNext(h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ›´æ–°å®Œ head ä¹‹åï¼Œä¼šå°†æ—§çš„å¤´ç»“ç‚¹ h çš„ next åŸŸæŒ‡å‘ä¸º hï¼Œå›¾ä¸­æ‰€ç¤ºçš„è™šçº¿ä¹Ÿå°±è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹çš„è‡ªå¼•ç”¨ï¼Œè¢«ç§»åŠ¨çš„èŠ‚ç‚¹ï¼ˆitem ä¸º null çš„èŠ‚ç‚¹ï¼‰ä¼šè¢« GC å›æ”¶</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentLinkedQueue%E5%87%BA%E9%98%9F%E6%93%8D%E4%BD%9C1.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentLinkedQueue%E5%87%BA%E9%98%9F%E6%93%8D%E4%BD%9C2.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JUC-ConcurrentLinkedQueue%E5%87%BA%E9%98%9F%E6%93%8D%E4%BD%9C3.png" alt=""></p>
<p>å¦‚æœè¿™æ—¶ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ·»åŠ å…ƒç´ ï¼Œé€šè¿‡ tail è·å–çš„ next èŠ‚ç‚¹åˆ™ä»ç„¶æ˜¯å®ƒæœ¬èº«ï¼Œè¿™å°±å‡ºç°äº† p == q çš„æƒ…å†µï¼Œå‡ºç°è¯¥ç§æƒ…å†µä¹‹åï¼Œåˆ™ä¼šè§¦å‘æ‰§è¡Œ head çš„æ›´æ–°ï¼Œå°† p èŠ‚ç‚¹é‡æ–°æŒ‡å‘ä¸º head</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/231caf90f30b">https://www.jianshu.com/p/231caf90f30b</a></p>
<hr>
<h4 id="æˆå‘˜æ–¹æ³•-9">æˆå‘˜æ–¹æ³•</h4>
<ul>
<li>
<p>peek()ï¼šä¼šæ”¹å˜ head æŒ‡å‘ï¼Œæ‰§è¡Œ peek() æ–¹æ³•å head ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå…·æœ‰éç©ºå…ƒç´ çš„èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é“¾è¡¨çš„é¦–éƒ¨å…ƒç´ ï¼Œåªè¯»å–è€Œä¸ç§»é™¤</span></span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">peek</span><span class="params">()</span> &#123;</span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> p.item;</span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span> || (q = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ›´æ”¹hçš„ä½ç½®ä¸ºéç©ºå…ƒç´ èŠ‚ç‚¹</span></span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>size()ï¼šç”¨æ¥è·å–å½“å‰é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½æ²¡æœ‰åŠ é”ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­ä»è°ƒç”¨ size æ–¹æ³•åˆ°è¿”å›ç»“æœæœŸé—´æœ‰å¯èƒ½å¢åˆ å…ƒç´ ï¼Œå¯¼è‡´ç»Ÿè®¡çš„å…ƒç´ ä¸ªæ•°ä¸ç²¾ç¡®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// first() è·å–ç¬¬ä¸€ä¸ªå…·æœ‰éç©ºå…ƒç´ çš„èŠ‚ç‚¹ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œè¿”å› null</span></span><br><span class="line">    <span class="comment">// succ(p) æ–¹æ³•è·å– p çš„åç»§èŠ‚ç‚¹ï¼Œè‹¥ p == p.nextï¼Œåˆ™è¿”å› head</span></span><br><span class="line">    <span class="comment">// ç±»ä¼¼éå†é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="literal">null</span>; p = succ(p))</span><br><span class="line">        <span class="keyword">if</span> (p.item != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// æœ€å¤§è¿”å›Integer.MAX_VALUE</span></span><br><span class="line">            <span class="keyword">if</span> (++count == Integer.MAX_VALUE)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>remove()ï¼šç§»é™¤å…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ é™¤çš„å…ƒç´ ä¸èƒ½ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> (o != <span class="literal">null</span>) &#123;</span><br><span class="line">        Node&lt;E&gt; next, pred = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="literal">null</span>; pred = p, p = next) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> p.item;</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹å…ƒç´ ä¸ä¸ºnull</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è‹¥ä¸åŒ¹é…ï¼Œåˆ™è·å–nextèŠ‚ç‚¹ç»§ç»­åŒ¹é…</span></span><br><span class="line">                <span class="keyword">if</span> (!o.equals(item)) &#123;</span><br><span class="line">                    next = succ(p);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è‹¥åŒ¹é…ï¼Œåˆ™é€šè¿‡ CAS æ“ä½œå°†å¯¹åº”èŠ‚ç‚¹å…ƒç´ ç½®ä¸º null</span></span><br><span class="line">                removed = p.casItem(item, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è·å–åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">            next = succ(p);</span><br><span class="line">            <span class="comment">// å°†è¢«åˆ é™¤çš„èŠ‚ç‚¹ç§»é™¤é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (pred != <span class="literal">null</span> &amp;&amp; next != <span class="literal">null</span>) <span class="comment">// unlink</span></span><br><span class="line">                pred.casNext(p, next);</span><br><span class="line">            <span class="keyword">if</span> (removed)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1>NET</h1>
<h2 id="DES">DES</h2>
<h3 id="ç½‘ç»œç¼–ç¨‹">ç½‘ç»œç¼–ç¨‹</h3>
<p>ç½‘ç»œç¼–ç¨‹ï¼Œå°±æ˜¯åœ¨ä¸€å®šçš„åè®®ä¸‹ï¼Œå®ç°ä¸¤å°è®¡ç®—æœºçš„é€šä¿¡çš„æŠ€æœ¯</p>
<p>é€šä¿¡ä¸€å®šæ˜¯åŸºäºè½¯ä»¶ç»“æ„å®ç°çš„:</p>
<ul>
<li>C/S ç»“æ„ ï¼šå…¨ç§°ä¸º Client/Server ç»“æ„ï¼Œæ˜¯æŒ‡å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç»“æ„ï¼Œå¸¸è§ç¨‹åºæœ‰ QQã€IDEA ç­‰è½¯ä»¶</li>
<li>B/S ç»“æ„ ï¼šå…¨ç§°ä¸º Browser/Server ç»“æ„ï¼Œæ˜¯æŒ‡æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç»“æ„</li>
</ul>
<p>ä¸¤ç§æ¶æ„å„æœ‰ä¼˜åŠ¿ï¼Œä½†æ˜¯æ— è®ºå“ªç§æ¶æ„ï¼Œéƒ½ç¦»ä¸å¼€ç½‘ç»œçš„æ”¯æŒ</p>
<p>ç½‘ç»œé€šä¿¡çš„ä¸‰è¦ç´ ï¼š</p>
<ol>
<li>
<p>åè®®ï¼šè®¡ç®—æœºç½‘ç»œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡å¿…é¡»çº¦å®šå’Œå½¼æ­¤éµå®ˆçš„é€šä¿¡è§„åˆ™ï¼ŒHTTPã€FTPã€TCPã€UDPã€SMTP</p>
</li>
<li>
<p>IP åœ°å€ï¼šäº’è”ç½‘åè®®åœ°å€ï¼ˆInternet Protocol Addressï¼‰ï¼Œç”¨æ¥ç»™ä¸€ä¸ªç½‘ç»œä¸­çš„è®¡ç®—æœºè®¾å¤‡åšå”¯ä¸€çš„ç¼–å·</p>
<ul>
<li>
<p>IPv4ï¼š4 ä¸ªå­—èŠ‚ï¼Œ32 ä½ç»„æˆï¼Œ192.168.1.1</p>
</li>
<li>
<p>IPv6ï¼šå¯ä»¥å®ç°ä¸ºæ‰€æœ‰è®¾å¤‡åˆ†é… IPï¼Œ128 ä½</p>
</li>
<li>
<p>ipconfigï¼šæŸ¥çœ‹æœ¬æœºçš„ IP</p>
<ul>
<li>ping æ£€æŸ¥æœ¬æœºä¸æŸä¸ª IP æŒ‡å®šçš„æœºå™¨æ˜¯å¦è”é€šï¼Œæˆ–è€…è¯´æ˜¯æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿ã€‚</li>
<li>ping ç©ºæ ¼ IP åœ°å€ ï¼šping 220.181.57.216ï¼Œping <a target="_blank" rel="noopener" href="http://www.baidu.com">www.baidu.com</a></li>
</ul>
</li>
</ul>
<p>ç‰¹æ®Šçš„ IP åœ°å€ï¼š æœ¬æœº IP åœ°å€ï¼Œ<strong>127.0.0.1 == localhost</strong>ï¼Œå›ç¯æµ‹è¯•</p>
</li>
<li>
<p>ç«¯å£ï¼šç«¯å£å·å°±å¯ä»¥å”¯ä¸€æ ‡è¯†è®¾å¤‡ä¸­çš„è¿›ç¨‹ï¼ˆåº”ç”¨ç¨‹åºï¼‰ã€‚ç«¯å£å·æ˜¯ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ•´æ•°ï¼Œå–å€¼èŒƒå›´æ˜¯ 0-65535ï¼Œ0-1023 ä¹‹é—´çš„ç«¯å£å·ç”¨äºä¸€äº›çŸ¥åçš„ç½‘ç»œæœåŠ¡å’Œåº”ç”¨æ™®é€šçš„åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨ 1024 ä»¥ä¸Šçš„ç«¯å£å·ã€‚å¦‚æœç«¯å£å·è¢«å¦å¤–ä¸€ä¸ªæœåŠ¡æˆ–åº”ç”¨æ‰€å ç”¨ï¼Œä¼šå¯¼è‡´å½“å‰ç¨‹åºå¯åŠ¨å¤±è´¥ï¼ŒæŠ¥å‡ºç«¯å£è¢«å ç”¨å¼‚å¸¸</p>
</li>
</ol>
<p>åˆ©ç”¨<strong>åè®®+IP åœ°å€+ç«¯å£å·</strong>ä¸‰å…ƒç»„åˆï¼Œå°±å¯ä»¥æ ‡è¯†ç½‘ç»œä¸­çš„è¿›ç¨‹äº†ï¼Œé‚£ä¹ˆè¿›ç¨‹é—´çš„é€šä¿¡å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ ‡è¯†ä¸å…¶å®ƒè¿›ç¨‹è¿›è¡Œäº¤äº’</p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1kT4y1M7vt">https://www.bilibili.com/video/BV1kT4y1M7vt</a></p>
<hr>
<h3 id="é€šä¿¡åè®®">é€šä¿¡åè®®</h3>
<p>ç½‘ç»œé€šä¿¡åè®®ï¼šå¯¹è®¡ç®—æœºå¿…é¡»éµå®ˆçš„è§„åˆ™ï¼Œåªæœ‰éµå®ˆè¿™äº›è§„åˆ™ï¼Œè®¡ç®—æœºä¹‹é—´æ‰èƒ½è¿›è¡Œé€šä¿¡</p>
<p>é€šä¿¡<strong>æ˜¯è¿›ç¨‹ä¸è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</strong>ï¼Œä¸æ˜¯ä¸»æœºä¸ä¸»æœºä¹‹é—´çš„é€šä¿¡</p>
<p>TCP/IP åè®®ï¼šä¼ è¾“æ§åˆ¶åè®® (Transmission Control Protocol)</p>
<p>ä¼ è¾“æ§åˆ¶åè®® TCPï¼ˆTransmission Control Protocolï¼‰æ˜¯é¢å‘è¿æ¥çš„ï¼Œæä¾›å¯é äº¤ä»˜ï¼Œæœ‰æµé‡æ§åˆ¶ï¼Œæ‹¥å¡æ§åˆ¶ï¼Œæä¾›å…¨åŒå·¥é€šä¿¡ï¼Œé¢å‘å­—èŠ‚æµï¼Œæ¯ä¸€æ¡ TCP è¿æ¥åªèƒ½æ˜¯ç‚¹å¯¹ç‚¹çš„ï¼ˆä¸€å¯¹ä¸€ï¼‰</p>
<ul>
<li>åœ¨é€šä¿¡ä¹‹å‰å¿…é¡»ç¡®å®šå¯¹æ–¹åœ¨çº¿å¹¶ä¸”è¿æ¥æˆåŠŸæ‰å¯ä»¥é€šä¿¡</li>
<li>ä¾‹å¦‚ä¸‹è½½æ–‡ä»¶ã€æµè§ˆç½‘é¡µç­‰ï¼ˆè¦æ±‚å¯é ä¼ è¾“ï¼‰</li>
</ul>
<p>ç”¨æˆ·æ•°æ®æŠ¥åè®® UDPï¼ˆUser Datagram Protocolï¼‰æ˜¯æ— è¿æ¥çš„ï¼Œå°½æœ€å¤§å¯èƒ½äº¤ä»˜ï¼Œä¸å¯é ï¼Œæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œé¢å‘æŠ¥æ–‡ï¼Œæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€å’Œå¤šå¯¹å¤šçš„äº¤äº’é€šä¿¡</p>
<ul>
<li>ç›´æ¥å‘æ¶ˆæ¯ç»™å¯¹æ–¹ï¼Œä¸ç®¡å¯¹æ–¹æ˜¯å¦åœ¨çº¿ï¼Œå‘æ¶ˆæ¯åä¹Ÿä¸éœ€è¦ç¡®è®¤</li>
<li>æ— çº¿ï¼ˆè§†é¢‘ä¼šè®®ï¼Œé€šè¯ï¼‰ï¼Œæ€§èƒ½å¥½ï¼Œå¯èƒ½ä¸¢å¤±ä¸€äº›æ•°æ®</li>
</ul>
<hr>
<h3 id="Java-æ¨¡å‹">Java æ¨¡å‹</h3>
<p>ç›¸å…³æ¦‚å¿µï¼š</p>
<ul>
<li>åŒæ­¥ï¼šå½“å‰çº¿ç¨‹è¦è‡ªå·±è¿›è¡Œæ•°æ®çš„è¯»å†™æ“ä½œï¼ˆè‡ªå·±å»é“¶è¡Œå–é’±ï¼‰</li>
<li>å¼‚æ­¥ï¼šå½“å‰çº¿ç¨‹å¯ä»¥å»åšå…¶ä»–äº‹æƒ…ï¼ˆå§”æ‰˜åˆ«äººæ‹¿é“¶è¡Œå¡åˆ°é“¶è¡Œå–é’±ï¼Œç„¶åç»™ä½ ï¼‰</li>
<li>é˜»å¡ï¼šåœ¨æ•°æ®æ²¡æœ‰çš„æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯è¦ç»§ç»­ç­‰å¾…ç€è¯»ï¼ˆæ’é˜Ÿç­‰å¾…ï¼‰</li>
<li>éé˜»å¡ï¼šåœ¨æ•°æ®æ²¡æœ‰çš„æƒ…å†µä¸‹ï¼Œä¼šå»åšå…¶ä»–äº‹æƒ…ï¼Œä¸€æ—¦æœ‰äº†æ•°æ®å†æ¥è·å–ï¼ˆæŸœå°å–æ¬¾ï¼Œå–ä¸ªå·ï¼Œç„¶åååœ¨æ¤…å­ä¸Šåšå…¶å®ƒäº‹ï¼Œç­‰å·å¹¿æ’­ä¼šé€šçŸ¥ä½ åŠç†ï¼‰</li>
</ul>
<p>Java ä¸­çš„é€šä¿¡æ¨¡å‹:</p>
<ol>
<li>
<p>BIO è¡¨ç¤ºåŒæ­¥é˜»å¡å¼é€šä¿¡ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®¢æˆ·ç«¯æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨ç«¯å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹æ± æœºåˆ¶æ”¹å–„</p>
<p>åŒæ­¥é˜»å¡å¼æ€§èƒ½æå·®ï¼šå¤§é‡çº¿ç¨‹ï¼Œå¤§é‡é˜»å¡</p>
</li>
<li>
<p>ä¼ªå¼‚æ­¥é€šä¿¡ï¼šå¼•å…¥çº¿ç¨‹æ± ï¼Œä¸éœ€è¦ä¸€ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ç°çº¿ç¨‹å¤ç”¨æ¥å¤„ç†å¾ˆå¤šä¸ªå®¢æˆ·ç«¯ï¼Œçº¿ç¨‹å¯æ§</p>
<p>é«˜å¹¶å‘ä¸‹æ€§èƒ½è¿˜æ˜¯å¾ˆå·®ï¼šçº¿ç¨‹æ•°é‡å°‘ï¼Œæ•°æ®ä¾ç„¶æ˜¯é˜»å¡çš„ï¼Œæ•°æ®æ²¡æœ‰æ¥çº¿ç¨‹è¿˜æ˜¯è¦ç­‰å¾…</p>
</li>
<li>
<p>NIO è¡¨ç¤º<strong>åŒæ­¥éé˜»å¡ IO</strong>ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºè¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯å‘é€çš„è¿æ¥ä¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰ I/O è¯·æ±‚æ—¶æ‰å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†</p>
<p>å·¥ä½œåŸç†ï¼š1 ä¸ªä¸»çº¿ç¨‹ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯ï¼Œ1 ä¸ªçº¿ç¨‹è½®è¯¢æ‰€æœ‰çš„å®¢æˆ·ç«¯ï¼Œå‘æ¥äº†æ•°æ®æ‰ä¼šå¼€å¯çº¿ç¨‹å¤„ç†</p>
<p>åŒæ­¥ï¼šçº¿ç¨‹è¿˜è¦ä¸æ–­çš„æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œä»¥åŠå¤„ç†æ•°æ®</p>
<p>éé˜»å¡ï¼šå¦‚æœä¸€ä¸ªç®¡é“æ²¡æœ‰æ•°æ®ï¼Œä¸éœ€è¦ç­‰å¾…ï¼Œå¯ä»¥è½®è¯¢ä¸‹ä¸€ä¸ªç®¡é“æ˜¯å¦æœ‰æ•°æ®</p>
</li>
<li>
<p>AIO è¡¨ç¤ºå¼‚æ­¥éé˜»å¡ IOï¼ŒAIO å¼•å…¥å¼‚æ­¥é€šé“çš„æ¦‚å¿µï¼Œé‡‡ç”¨äº† Proactor æ¨¡å¼ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œç‰¹ç‚¹æ˜¯å…ˆç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å»å¤„ç†ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨</p>
<p>å¼‚æ­¥ï¼šæœåŠ¡ç«¯çº¿ç¨‹æ¥æ”¶åˆ°äº†å®¢æˆ·ç«¯ç®¡é“ä»¥åå°±äº¤ç»™åº•å±‚å¤„ç† IO é€šä¿¡ï¼Œçº¿ç¨‹å¯ä»¥åšå…¶ä»–äº‹æƒ…</p>
<p>éé˜»å¡ï¼šåº•å±‚ä¹Ÿæ˜¯å®¢æˆ·ç«¯æœ‰æ•°æ®æ‰ä¼šå¤„ç†ï¼Œæœ‰äº†æ•°æ®ä»¥åå¤„ç†å¥½é€šçŸ¥æœåŠ¡å™¨åº”ç”¨æ¥å¯åŠ¨çº¿ç¨‹è¿›è¡Œå¤„ç†</p>
</li>
</ol>
<p>å„ç§æ¨¡å‹åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>BIO é€‚ç”¨äºè¿æ¥æ•°ç›®æ¯”è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¯¥æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œç¨‹åºç®€å•</li>
<li>NIO é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œå¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼Œç¼–ç¨‹å¤æ‚ï¼ŒJDK 1.4 å¼€å§‹æ”¯æŒ</li>
<li>AIO é€‚ç”¨äºè¿æ¥æ•°ç›®å¤šä¸”è¿æ¥æ¯”è¾ƒé•¿ï¼ˆé‡æ“ä½œï¼‰çš„æ¶æ„ï¼Œå¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ†è°ƒç”¨æ“ä½œç³»ç»Ÿå‚ä¸å¹¶å‘æ“ä½œï¼ŒJDK 1.7 å¼€å§‹æ”¯æŒ</li>
</ul>
<hr>
<h2 id="I-O">I/O</h2>
<h3 id="IO-æ¨¡å‹">IO æ¨¡å‹</h3>
<h4 id="äº”ç§æ¨¡å‹">äº”ç§æ¨¡å‹</h4>
<p>å¯¹äºä¸€ä¸ªå¥—æ¥å­—ä¸Šçš„è¾“å…¥æ“ä½œï¼Œç¬¬ä¸€æ­¥æ˜¯ç­‰å¾…æ•°æ®ä»ç½‘ç»œä¸­åˆ°è¾¾ï¼Œå½“æ•°æ®åˆ°è¾¾æ—¶è¢«å¤åˆ¶åˆ°å†…æ ¸ä¸­çš„æŸä¸ªç¼“å†²åŒºã€‚ç¬¬äºŒæ­¥å°±æ˜¯æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒº</p>
<p>Linux æœ‰äº”ç§ I/O æ¨¡å‹ï¼š</p>
<ul>
<li>é˜»å¡å¼ I/O</li>
<li>éé˜»å¡å¼ I/O</li>
<li>I/O å¤ç”¨ï¼ˆselect å’Œ pollï¼‰</li>
<li>ä¿¡å·é©±åŠ¨å¼ I/Oï¼ˆSIGIOï¼‰</li>
<li>å¼‚æ­¥ I/Oï¼ˆAIOï¼‰</li>
</ul>
<p>äº”ç§æ¨¡å‹å¯¹æ¯”ï¼š</p>
<ul>
<li>åŒæ­¥ I/O åŒ…æ‹¬é˜»å¡å¼ I/Oã€éé˜»å¡å¼ I/Oã€I/O å¤ç”¨å’Œä¿¡å·é©±åŠ¨ I/O ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œéé˜»å¡å¼ I/O ã€ä¿¡å·é©±åŠ¨ I/O å’Œå¼‚æ­¥ I/O åœ¨ç¬¬ä¸€é˜¶æ®µä¸ä¼šé˜»å¡</li>
</ul>
<ul>
<li>åŒæ­¥ I/Oï¼šå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºçš„é˜¶æ®µï¼ˆç¬¬äºŒé˜¶æ®µï¼‰ï¼Œåº”ç”¨è¿›ç¨‹ä¼šé˜»å¡</li>
<li>å¼‚æ­¥ I/Oï¼šç¬¬äºŒé˜¶æ®µåº”ç”¨è¿›ç¨‹ä¸ä¼šé˜»å¡</li>
</ul>
<hr>
<h4 id="é˜»å¡å¼-IO">é˜»å¡å¼ IO</h4>
<p>åº”ç”¨è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ recvfrom æ¥æ”¶æ•°æ®ï¼Œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºä¸­æ‰è¿”å›ã€‚é˜»å¡ä¸æ„å‘³ç€æ•´ä¸ªæ“ä½œç³»ç»Ÿéƒ½è¢«é˜»å¡ï¼Œå…¶å®ƒåº”ç”¨è¿›ç¨‹è¿˜å¯ä»¥æ‰§è¡Œï¼Œåªæ˜¯å½“å‰é˜»å¡è¿›ç¨‹ä¸æ¶ˆè€— CPU æ—¶é—´ï¼Œè¿™ç§æ¨¡å‹çš„ CPU åˆ©ç”¨ç‡ä¼šæ¯”è¾ƒé«˜</p>
<p>recvfrom() ç”¨äº<strong>æ¥æ”¶ Socket ä¼ æ¥çš„æ•°æ®ï¼Œå¹¶å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒº buf ä¸­</strong>ï¼ŒæŠŠ recvfrom() å½“æˆç³»ç»Ÿè°ƒç”¨</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO%E6%A8%A1%E5%9E%8B-%E9%98%BB%E5%A1%9E%E5%BC%8FIO.png" alt=""></p>
<hr>
<h4 id="éé˜»å¡å¼">éé˜»å¡å¼</h4>
<p>åº”ç”¨è¿›ç¨‹é€šè¿‡ recvfrom è°ƒç”¨ä¸åœçš„å»å’Œå†…æ ¸äº¤äº’ï¼Œç›´åˆ°å†…æ ¸å‡†å¤‡å¥½æ•°æ®ã€‚å¦‚æœæ²¡æœ‰å‡†å¤‡å¥½æ•°æ®ï¼Œå†…æ ¸è¿”å›ä¸€ä¸ªé”™è¯¯ç ï¼Œè¿‡ä¸€æ®µæ—¶é—´åº”ç”¨è¿›ç¨‹å†æ‰§è¡Œ recvfrom ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨ä¸¤æ¬¡å‘é€è¯·æ±‚çš„æ—¶é—´æ®µï¼Œè¿›ç¨‹å¯ä»¥è¿›è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºè½®è¯¢ï¼ˆpollingï¼‰</p>
<p>ç”±äº CPU è¦å¤„ç†æ›´å¤šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤è¿™ç§æ¨¡å‹çš„ CPU åˆ©ç”¨ç‡æ¯”è¾ƒä½</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO%E6%A8%A1%E5%9E%8B-%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%BC%8FIO.png" alt=""></p>
<hr>
<h4 id="ä¿¡å·é©±åŠ¨">ä¿¡å·é©±åŠ¨</h4>
<p>åº”ç”¨è¿›ç¨‹ä½¿ç”¨ sigaction ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸ç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œç­‰å¾…æ•°æ®é˜¶æ®µåº”ç”¨è¿›ç¨‹æ˜¯éé˜»å¡çš„ã€‚å½“å†…æ ¸æ•°æ®å‡†å¤‡å°±ç»ªæ—¶å‘åº”ç”¨è¿›ç¨‹å‘é€ SIGIO ä¿¡å·ï¼Œåº”ç”¨è¿›ç¨‹æ”¶åˆ°ä¹‹ååœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­è°ƒç”¨ recvfrom å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ä¸­</p>
<p>ç›¸æ¯”äºéé˜»å¡å¼ I/O çš„è½®è¯¢æ–¹å¼ï¼Œä¿¡å·é©±åŠ¨ I/O çš„ CPU åˆ©ç”¨ç‡æ›´é«˜</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO%E6%A8%A1%E5%9E%8B-%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8IO.png" alt=""></p>
<hr>
<h4 id="IO-å¤ç”¨">IO å¤ç”¨</h4>
<p>IO å¤ç”¨æ¨¡å‹ä½¿ç”¨ select æˆ–è€… poll å‡½æ•°ç­‰å¾…æ•°æ®ï¼Œselect ä¼šç›‘å¬æ‰€æœ‰æ³¨å†Œå¥½çš„ IOï¼Œ<strong>ç­‰å¾…å¤šä¸ªå¥—æ¥å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªå˜ä¸ºå¯è¯»</strong>ï¼Œç­‰å¾…è¿‡ç¨‹ä¼šè¢«é˜»å¡ï¼Œå½“æŸä¸ªå¥—æ¥å­—å‡†å¤‡å¥½æ•°æ®å˜ä¸ºå¯è¯»æ—¶ select è°ƒç”¨å°±è¿”å›ï¼Œç„¶åè°ƒç”¨ recvfrom æŠŠæ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°è¿›ç¨‹ä¸­</p>
<p>IO å¤ç”¨è®©å•ä¸ªè¿›ç¨‹å…·æœ‰å¤„ç†å¤šä¸ª I/O äº‹ä»¶çš„èƒ½åŠ›ï¼Œåˆè¢«ç§°ä¸º Event Driven I/Oï¼Œå³<strong>äº‹ä»¶é©±åŠ¨ I/O</strong></p>
<p>å¦‚æœä¸€ä¸ª Web æœåŠ¡å™¨æ²¡æœ‰ I/O å¤ç”¨ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ª Socket è¿æ¥éƒ½è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œå¦‚æœåŒæ—¶æœ‰å‡ ä¸‡ä¸ªè¿æ¥ï¼Œå°±éœ€è¦åˆ›å»ºç›¸åŒæ•°é‡çš„çº¿ç¨‹ã€‚ç›¸æ¯”äºå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ï¼ŒI/O å¤ç”¨ä¸éœ€è¦è¿›ç¨‹çº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢çš„å¼€é”€ï¼Œç³»ç»Ÿå¼€é”€æ›´å°</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO%E6%A8%A1%E5%9E%8B-IO%E5%A4%8D%E7%94%A8%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<hr>
<h4 id="å¼‚æ­¥-IO">å¼‚æ­¥ IO</h4>
<p>åº”ç”¨è¿›ç¨‹æ‰§è¡Œ aio_read ç³»ç»Ÿè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œç»™å†…æ ¸ä¼ é€’æè¿°ç¬¦ã€ç¼“å†²åŒºæŒ‡é’ˆã€ç¼“å†²åŒºå¤§å°ç­‰ã€‚åº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œä¸ä¼šè¢«é˜»å¡ï¼Œå†…æ ¸ä¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆä¹‹åå‘åº”ç”¨è¿›ç¨‹å‘é€ä¿¡å·</p>
<p>å¼‚æ­¥ I/O ä¸ä¿¡å·é©±åŠ¨ I/O çš„åŒºåˆ«åœ¨äºï¼Œå¼‚æ­¥ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹ I/O å®Œæˆï¼Œè€Œä¿¡å·é©±åŠ¨ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹å¯ä»¥å¼€å§‹ I/O</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO%E6%A8%A1%E5%9E%8B-%E5%BC%82%E6%AD%A5IO%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<hr>
<h3 id="å¤šè·¯å¤ç”¨">å¤šè·¯å¤ç”¨</h3>
<h4 id="select">select</h4>
<h5 id="å‡½æ•°">å‡½æ•°</h5>
<p>Socket ä¸æ˜¯æ–‡ä»¶ï¼Œåªæ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œä½†æ˜¯ Unix æ“ä½œç³»ç»ŸæŠŠæ‰€æœ‰ä¸œè¥¿éƒ½<strong>çœ‹ä½œ</strong>æ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥ Socket è¯´æˆ file descriptorï¼Œä¹Ÿå°±æ˜¯ fd</p>
<p>select å…è®¸åº”ç”¨ç¨‹åºç›‘è§†ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ï¼Œç­‰å¾…ä¸€ä¸ªæˆ–è€…å¤šä¸ªæè¿°ç¬¦æˆä¸ºå°±ç»ªçŠ¶æ€ï¼Œä»è€Œå®Œæˆ I/O æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>fd_set ä½¿ç”¨ <strong>bitmap æ•°ç»„</strong>å®ç°ï¼Œæ•°ç»„å¤§å°ç”¨ FD_SETSIZE å®šä¹‰ï¼Œ<strong>å•è¿›ç¨‹</strong>åªèƒ½ç›‘å¬å°‘äº FD_SETSIZE æ•°é‡çš„æè¿°ç¬¦ï¼Œ32 ä½æœºé»˜è®¤æ˜¯ 1024 ä¸ªï¼Œ64 ä½æœºé»˜è®¤æ˜¯ 2048ï¼Œå¯ä»¥å¯¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸</p>
</li>
<li>
<p>fd_set æœ‰ä¸‰ç§ç±»å‹çš„æè¿°ç¬¦ï¼šreadsetã€writesetã€exceptsetï¼Œå¯¹åº”è¯»ã€å†™ã€å¼‚å¸¸æ¡ä»¶çš„æè¿°ç¬¦é›†åˆ</p>
</li>
<li>
<p>n æ˜¯ç›‘æµ‹çš„ socket çš„æœ€å¤§æ•°é‡</p>
</li>
<li>
<p>timeout ä¸ºè¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨ select ä¼šä¸€ç›´<strong>é˜»å¡</strong>ç›´åˆ°æœ‰æè¿°ç¬¦çš„äº‹ä»¶åˆ°è¾¾æˆ–è€…ç­‰å¾…çš„æ—¶é—´è¶…è¿‡ timeout</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>&#123;</span></span><br><span class="line">    <span class="type">long</span> tv_sec; 	<span class="comment">//ç§’</span></span><br><span class="line">    <span class="type">long</span> tv_usec;	<span class="comment">//å¾®ç§’</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>timeout == nullï¼šç­‰å¾…æ— é™é•¿çš„æ—¶é—´</li>
<li>tv_sec == 0 &amp;&amp; tv_usec == 0ï¼šè·å–åç›´æ¥è¿”å›ï¼Œä¸é˜»å¡ç­‰å¾…</li>
<li>tv_sec != 0 || tv_usec != 0ï¼šç­‰å¾…æŒ‡å®šæ—¶é—´</li>
</ul>
</li>
<li>
<p>æ–¹æ³•æˆåŠŸè°ƒç”¨è¿”å›ç»“æœä¸º<strong>å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°</strong>ï¼Œå‡ºé”™è¿”å›ç»“æœä¸º -1ï¼Œè¶…æ—¶è¿”å›ç»“æœä¸º 0</p>
</li>
</ul>
<p>Linux æä¾›äº†ä¸€ç»„å®ä¸º fd_set è¿›è¡Œèµ‹å€¼æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">FD_ZERO</span><span class="params">(fd_set *fdset)</span>;			<span class="comment">// å°†ä¸€ä¸ª fd_set ç±»å‹å˜é‡çš„æ‰€æœ‰å€¼éƒ½ç½®ä¸º 0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *fdset)</span>;	<span class="comment">// å°†ä¸€ä¸ª fd_set ç±»å‹å˜é‡çš„ fd ä½ç½®ä¸º 0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *fdset)</span>;	<span class="comment">// å°†ä¸€ä¸ª fd_set ç±»å‹å˜é‡çš„ fd ä½ç½®ä¸º 1</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *fdset)</span>;<span class="comment">// åˆ¤æ–­ fd ä½æ˜¯å¦è¢«ç½®ä¸º 1</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr)));</span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_port = htons(<span class="number">2000</span>);</span><br><span class="line">addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">bind(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr));<span class="comment">//ç»‘å®šè¿æ¥</span></span><br><span class="line">listen(sockfd, <span class="number">5</span>);<span class="comment">//ç›‘å¬5ä¸ªç«¯å£</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;client, e, <span class="keyword">sizeof</span>(client));</span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">	fds[i] = accept(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    <span class="comment">//å°†ç›‘å¬çš„å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦fdå­˜å…¥fdsï¼š[3,4,5,6,7]</span></span><br><span class="line">    <span class="keyword">if</span>(fds[i] &gt; max)</span><br><span class="line">		max = fds[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    FD_ZERO(&amp;rset);<span class="comment">//ç½®ä¸º0</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    	FD_SET(fds[i], &amp;rset);<span class="comment">//å¯¹åº”ä½ç½®1 [0001 1111 00.....]</span></span><br><span class="line">	&#125;</span><br><span class="line">	print(<span class="string">&quot;round again&quot;</span>);</span><br><span class="line">	select(max + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//ç›‘å¬</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(FD_ISSET(fds[i], &amp;rset)) &#123;<span class="comment">//åˆ¤æ–­ç›‘å¬å“ªä¸€ä¸ªç«¯å£</span></span><br><span class="line">            <span class="built_in">memset</span>(buffer, <span class="number">0</span>, MAXBUF);</span><br><span class="line">            read(fds[i], buffer, MAXBUF);<span class="comment">//è¿›å…¥å†…æ ¸æ€è¯»æ•°æ®</span></span><br><span class="line">            print(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19D4y1o797">https://www.bilibili.com/video/BV19D4y1o797</a></p>
<hr>
<h5 id="æµç¨‹">æµç¨‹</h5>
<p>select è°ƒç”¨æµç¨‹å›¾ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-select%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B.png" alt=""></p>
<ol>
<li>ä½¿ç”¨ copy_from_user ä»ç”¨æˆ·ç©ºé—´æ‹·è´ fd_set åˆ°å†…æ ¸ç©ºé—´ï¼Œè¿›ç¨‹é˜»å¡</li>
<li>æ³¨å†Œå›è°ƒå‡½æ•° _pollwait</li>
<li>éå†æ‰€æœ‰ fdï¼Œè°ƒç”¨å…¶å¯¹åº”çš„ poll æ–¹æ³•åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦å‡†å¤‡å°±ç»ªï¼Œå¯¹äº socketï¼Œè¿™ä¸ª poll æ–¹æ³•æ˜¯ sock_pollï¼Œsock_poll æ ¹æ®æƒ…å†µä¼šè°ƒç”¨åˆ° tcp_pollã€udp_poll æˆ–è€… datagram_pollï¼Œä»¥ tcp_poll ä¸ºä¾‹ï¼Œå…¶æ ¸å¿ƒå®ç°å°±æ˜¯ _pollwait</li>
<li>_pollwait æŠŠ **currentï¼ˆè°ƒç”¨ select çš„è¿›ç¨‹ï¼‰**æŒ‚åˆ°è®¾å¤‡çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸åŒè®¾å¤‡æœ‰ä¸åŒçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå¯¹äº tcp_poll ï¼Œå…¶ç­‰å¾…é˜Ÿåˆ—æ˜¯ sk â†’ sk_sleepï¼ˆæŠŠè¿›ç¨‹æŒ‚åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å¹¶ä¸ä»£è¡¨è¿›ç¨‹å·²ç»ç¡çœ ï¼‰ï¼Œåœ¨è®¾å¤‡æ”¶åˆ°æ¶ˆæ¯ï¼ˆç½‘ç»œè®¾å¤‡ï¼‰æˆ–å¡«å†™å®Œæ–‡ä»¶æ•°æ®ï¼ˆç£ç›˜è®¾å¤‡ï¼‰åï¼Œä¼šå”¤é†’è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ä¸Šç¡çœ çš„è¿›ç¨‹ï¼Œè¿™æ—¶ current ä¾¿è¢«å”¤é†’ï¼Œè¿›å…¥å°±ç»ªé˜Ÿåˆ—</li>
<li>poll æ–¹æ³•è¿”å›æ—¶ä¼šè¿”å›ä¸€ä¸ªæè¿°è¯»å†™æ“ä½œæ˜¯å¦å°±ç»ªçš„ mask æ©ç ï¼Œæ ¹æ®è¿™ä¸ª mask æ©ç ç»™ fd_set èµ‹å€¼</li>
<li>å¦‚æœéå†å®Œæ‰€æœ‰çš„ fdï¼Œè¿˜æ²¡æœ‰è¿”å›ä¸€ä¸ªå¯è¯»å†™çš„ mask æ©ç ï¼Œåˆ™ä¼šè°ƒç”¨ schedule_timeout è®© current è¿›ç¨‹è¿›å…¥ç¡çœ ã€‚å½“è®¾å¤‡é©±åŠ¨å‘ç”Ÿè‡ªèº«èµ„æºå¯è¯»å†™åï¼Œä¼šå”¤é†’å…¶ç­‰å¾…é˜Ÿåˆ—ä¸Šç¡çœ çš„è¿›ç¨‹ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„è¶…æ—¶æ—¶é—´ï¼ˆschedule_timeoutï¼‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹å”¤é†’ï¼Œåˆ™è°ƒç”¨ select çš„è¿›ç¨‹ä¼šé‡æ–°è¢«å”¤é†’è·å¾— CPUï¼Œè¿›è€Œé‡æ–°éå† fdï¼Œåˆ¤æ–­æœ‰æ²¡æœ‰å°±ç»ªçš„ fd</li>
<li>æŠŠ fd_set ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œé˜»å¡è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</li>
</ol>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/anker/p/3265058.html">https://www.cnblogs.com/anker/p/3265058.html</a></p>
<p>å…¶ä»–æµç¨‹å›¾ï¼š<a target="_blank" rel="noopener" href="https://www.processon.com/view/link/5f62b9a6e401fd2ad7e5d6d1">https://www.processon.com/view/link/5f62b9a6e401fd2ad7e5d6d1</a></p>
<hr>
<h4 id="poll">poll</h4>
<p>poll çš„åŠŸèƒ½ä¸ select ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç­‰å¾…ä¸€ç»„æè¿°ç¬¦ä¸­çš„ä¸€ä¸ªæˆä¸ºå°±ç»ªçŠ¶æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">unsigned</span> <span class="type">int</span> nfds, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure>
<p>poll ä¸­çš„æè¿°ç¬¦æ˜¯ pollfd ç±»å‹çš„æ•°ç»„ï¼Œpollfd çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>   fd;         <span class="comment">/* file descriptor */</span></span><br><span class="line">    <span class="type">short</span> events;     <span class="comment">/* requested events */</span></span><br><span class="line">    <span class="type">short</span> revents;    <span class="comment">/* returned events */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>select å’Œ poll å¯¹æ¯”ï¼š</p>
<ul>
<li>select ä¼šä¿®æ”¹æè¿°ç¬¦ï¼Œè€Œ poll ä¸ä¼š</li>
<li>select çš„æè¿°ç¬¦ç±»å‹ä½¿ç”¨æ•°ç»„å®ç°ï¼Œæœ‰æè¿°ç¬¦çš„é™åˆ¶ï¼›è€Œ poll ä½¿ç”¨<strong>é“¾è¡¨</strong>å®ç°ï¼Œæ²¡æœ‰æè¿°ç¬¦æ•°é‡çš„é™åˆ¶</li>
<li>poll æä¾›äº†æ›´å¤šçš„äº‹ä»¶ç±»å‹ï¼Œå¹¶ä¸”å¯¹æè¿°ç¬¦çš„é‡å¤åˆ©ç”¨ä¸Šæ¯” select é«˜</li>
</ul>
<ul>
<li>select å’Œ poll é€Ÿåº¦éƒ½æ¯”è¾ƒæ…¢ï¼Œ<strong>æ¯æ¬¡è°ƒç”¨</strong>éƒ½éœ€è¦å°†å…¨éƒ¨æè¿°ç¬¦æ•°ç»„ fd ä»åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºå¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒºï¼ŒåŒæ—¶æ¯æ¬¡éƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰ fd ï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li>
<li>å‡ ä¹æ‰€æœ‰çš„ç³»ç»Ÿéƒ½æ”¯æŒ selectï¼Œä½†æ˜¯åªæœ‰æ¯”è¾ƒæ–°çš„ç³»ç»Ÿæ”¯æŒ poll</li>
<li>select å’Œ poll çš„æ—¶é—´å¤æ‚åº¦ O(n)ï¼Œå¯¹ socket è¿›è¡Œæ‰«ææ—¶æ˜¯çº¿æ€§æ‰«æï¼Œå³é‡‡ç”¨è½®è¯¢çš„æ–¹æ³•ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå› ä¸ºå¹¶ä¸çŸ¥é“å…·ä½“æ˜¯å“ªä¸ª socket å…·æœ‰äº‹ä»¶ï¼Œæ‰€ä»¥éšç€ fd æ•°é‡çš„å¢åŠ ä¼šé€ æˆéå†é€Ÿåº¦æ…¢çš„<strong>çº¿æ€§ä¸‹é™</strong>æ€§èƒ½é—®é¢˜</li>
<li>poll è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯æ°´å¹³è§¦å‘ï¼Œå¦‚æœæŠ¥å‘Šäº† fd åï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡ poll æ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥ fd</li>
<li>å¦‚æœä¸€ä¸ªçº¿ç¨‹å¯¹æŸä¸ªæè¿°ç¬¦è°ƒç”¨äº† select æˆ–è€… pollï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å…³é—­äº†è¯¥æè¿°ç¬¦ï¼Œä¼šå¯¼è‡´è°ƒç”¨ç»“æœä¸ç¡®å®š</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md">https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md</a></p>
<hr>
<h4 id="epoll">epoll</h4>
<h5 id="å‡½æ•°-2">å‡½æ•°</h5>
<p>epoll ä½¿ç”¨äº‹ä»¶çš„å°±ç»ªé€šçŸ¥æ–¹å¼ï¼Œé€šè¿‡ epoll_ctl() å‘å†…æ ¸æ³¨å†Œæ–°çš„æè¿°ç¬¦æˆ–è€…æ˜¯æ”¹å˜æŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ã€‚å·²æ³¨å†Œçš„æè¿°ç¬¦åœ¨å†…æ ¸ä¸­ä¼šè¢«ç»´æŠ¤åœ¨ä¸€æ£µ<strong>çº¢é»‘æ ‘</strong>ä¸Šï¼Œä¸€æ—¦è¯¥ fd å°±ç»ªï¼Œ<strong>å†…æ ¸é€šè¿‡ callback å›è°ƒå‡½æ•°å°† I/O å‡†å¤‡å¥½çš„æè¿°ç¬¦åŠ å…¥åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­</strong>ç®¡ç†ï¼Œè¿›ç¨‹è°ƒç”¨ epoll_wait() ä¾¿å¯ä»¥å¾—åˆ°äº‹ä»¶å°±ç»ªçš„æè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span>ï¼›</span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event * events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>epall_createï¼šä¸€ä¸ªç³»ç»Ÿå‡½æ•°ï¼Œå‡½æ•°å°†åœ¨å†…æ ¸ç©ºé—´å†…åˆ›å»ºä¸€ä¸ª epoll æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç†è§£ä¸º epoll ç»“æ„ç©ºé—´ï¼Œè¿”å›å€¼ä¸º epoll çš„æ–‡ä»¶æè¿°ç¬¦ç¼–å·ï¼Œä»¥åæœ‰ client è¿æ¥æ—¶ï¼Œå‘è¯¥ epoll ç»“æ„ä¸­æ·»åŠ ç›‘å¬ï¼Œæ‰€ä»¥ epoll ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæè¿°ç¬¦</p>
</li>
<li>
<p>epall_ctlï¼šepoll çš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œselect å‡½æ•°æ˜¯è°ƒç”¨æ—¶æŒ‡å®šéœ€è¦ç›‘å¬çš„æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œepoll å…ˆå°†ç”¨æˆ·æ„Ÿå…´è¶£çš„æè¿°ç¬¦äº‹ä»¶æ³¨å†Œåˆ° epoll ç©ºé—´ã€‚æ­¤å‡½æ•°æ˜¯éé˜»å¡å‡½æ•°ï¼Œç”¨æ¥å¢åˆ æ”¹ epoll ç©ºé—´å†…çš„æè¿°ç¬¦ï¼Œå‚æ•°è§£é‡Šï¼š</p>
<ul>
<li>
<p>epfdï¼šepoll ç»“æ„çš„è¿›ç¨‹ fd ç¼–å·ï¼Œå‡½æ•°å°†ä¾é è¯¥ç¼–å·æ‰¾åˆ°å¯¹åº”çš„ epoll ç»“æ„</p>
</li>
<li>
<p>opï¼šè¡¨ç¤ºå½“å‰è¯·æ±‚ç±»å‹ï¼Œæœ‰ä¸‰ä¸ªå®å®šä¹‰ï¼š</p>
<ul>
<li>EPOLL_CTL_ADDï¼šæ³¨å†Œæ–°çš„ fd åˆ° epfd ä¸­</li>
<li>EPOLL_CTL_MODï¼šä¿®æ”¹å·²ç»æ³¨å†Œçš„ fd çš„ç›‘å¬äº‹ä»¶</li>
<li>EPOLL_CTI_DELï¼šä» epfd ä¸­åˆ é™¤ä¸€ä¸ª fd</li>
</ul>
</li>
<li>
<p>fdï¼šéœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€èˆ¬æŒ‡ socket_fd</p>
</li>
<li>
<p>eventï¼šå‘Šè¯‰å†…æ ¸å¯¹è¯¥ fd èµ„æºæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œepoll_event çš„ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line">    <span class="type">_uint32_t</span> events;	<span class="comment">/*epoll events*/</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data;	<span class="comment">/*user data variable*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>events å¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®é›†åˆï¼šEPOLLINã€EPOLOUTã€EPOLLPRIã€EPOLLERRã€EPOLLHUPï¼ˆæŒ‚æ–­ï¼‰ã€EPOLETï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰ã€EPOLLONESHOTï¼ˆåªç›‘å¬ä¸€æ¬¡ï¼Œäº‹ä»¶è§¦å‘åè‡ªåŠ¨æ¸…é™¤è¯¥ fdï¼Œä» epoll åˆ—è¡¨ï¼‰</p>
</li>
</ul>
</li>
<li>
<p>epoll_waitï¼šç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿï¼Œç±»ä¼¼äº select() è°ƒç”¨ï¼Œè¿”å›å€¼ä¸ºæœ¬æ¬¡å°±ç»ªçš„ fd ä¸ªæ•°ï¼Œç›´æ¥ä»å°±ç»ªé“¾è¡¨è·å–ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)</p>
<ul>
<li>epfdï¼š<strong>æŒ‡å®šæ„Ÿå…´è¶£çš„ epoll äº‹ä»¶åˆ—è¡¨</strong></li>
<li>eventsï¼šæŒ‡å‘ä¸€ä¸ª epoll_event ç»“æ„æ•°ç»„ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œå†…æ ¸ä¼šæŠŠå°±ç»ªçŠ¶æ€çš„æ•°æ®æ‹·è´åˆ°è¯¥æ•°ç»„</li>
<li>maxeventsï¼šæ ‡æ˜ epoll_event æ•°ç»„æœ€å¤šèƒ½æ¥æ”¶çš„æ•°æ®é‡ï¼Œå³æœ¬æ¬¡æ“ä½œæœ€å¤šèƒ½è·å–å¤šå°‘å°±ç»ªæ•°æ®</li>
<li>timeoutï¼šå•ä½ä¸ºæ¯«ç§’
<ul>
<li>0ï¼šè¡¨ç¤ºç«‹å³è¿”å›ï¼Œéé˜»å¡è°ƒç”¨</li>
<li>-1ï¼šé˜»å¡è°ƒç”¨ï¼Œç›´åˆ°æœ‰ç”¨æˆ·æ„Ÿå…´è¶£çš„äº‹ä»¶å°±ç»ªä¸ºæ­¢</li>
<li>å¤§äº 0ï¼šé˜»å¡è°ƒç”¨ï¼Œé˜»å¡æŒ‡å®šæ—¶é—´å†…å¦‚æœæœ‰äº‹ä»¶å°±ç»ªåˆ™æå‰è¿”å›ï¼Œå¦åˆ™ç­‰å¾…æŒ‡å®šæ—¶é—´åè¿”å›</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>epoll çš„æè¿°ç¬¦äº‹ä»¶æœ‰ä¸¤ç§è§¦å‘æ¨¡å¼ï¼šLTï¼ˆlevel triggerï¼‰å’Œ ETï¼ˆedge triggerï¼‰ï¼š</p>
<ul>
<li>LT æ¨¡å¼ï¼šå½“ epoll_wait() æ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œå°†æ­¤äº‹ä»¶é€šçŸ¥è¿›ç¨‹ï¼Œè¿›ç¨‹å¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶ï¼Œä¸‹æ¬¡è°ƒç”¨ epoll_wait() ä¼šå†æ¬¡é€šçŸ¥è¿›ç¨‹ï¼Œæ˜¯é»˜è®¤çš„ä¸€ç§æ¨¡å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒ Blocking å’Œ No-Blocking</li>
<li>ET æ¨¡å¼ï¼šé€šçŸ¥ä¹‹åè¿›ç¨‹å¿…é¡»ç«‹å³å¤„ç†äº‹ä»¶ï¼Œä¸‹æ¬¡å†è°ƒç”¨ epoll_wait() æ—¶ä¸ä¼šå†å¾—åˆ°äº‹ä»¶åˆ°è¾¾çš„é€šçŸ¥ã€‚å‡å°‘äº† epoll äº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå› æ­¤æ•ˆç‡è¦æ¯” LT æ¨¡å¼é«˜ï¼›åªæ”¯æŒ No-Blockingï¼Œä»¥é¿å…ç”±äºä¸€ä¸ª fd çš„é˜»å¡è¯»/é˜»å¡å†™æ“ä½œæŠŠå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡é¥¥é¥¿</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»º epoll æè¿°ç¬¦ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºåªéœ€è¦ä¸€ä¸ªï¼Œç”¨äºç›‘æ§æ‰€æœ‰å¥—æ¥å­—</span></span><br><span class="line"><span class="type">int</span> pollingfd = epoll_create(<span class="number">0xCAFE</span>);</span><br><span class="line"><span class="keyword">if</span> ( pollingfd &lt; <span class="number">0</span> )<span class="comment">// report error</span></span><br><span class="line"><span class="comment">// åˆå§‹åŒ– epoll ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è¿æ¥ç±»å®ä¾‹ä¸äº‹ä»¶ç›¸å…³è”ï¼Œå¯ä»¥å…³è”ä»»ä½•æƒ³è¦çš„ä¸œè¥¿</span></span><br><span class="line">ev.data.ptr = pConnection1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘è§†è¾“å…¥ï¼Œå¹¶ä¸”åœ¨äº‹ä»¶å‘ç”Ÿåä¸è‡ªåŠ¨é‡æ–°å‡†å¤‡æè¿°ç¬¦</span></span><br><span class="line">ev.events = EPOLLIN | EPOLLONESHOT;</span><br><span class="line"><span class="comment">// å°†æè¿°ç¬¦æ·»åŠ åˆ°ç›‘æ§åˆ—è¡¨ä¸­ï¼Œå³ä½¿å¦ä¸€ä¸ªçº¿ç¨‹åœ¨epoll_waitä¸­ç­‰å¾…ï¼Œæè¿°ç¬¦å°†è¢«æ­£ç¡®æ·»åŠ </span></span><br><span class="line"><span class="keyword">if</span> ( epoll_ctl( epollfd, EPOLL_CTL_ADD, pConnection1-&gt;getSocket(), &amp;ev) != <span class="number">0</span> )</span><br><span class="line">    <span class="comment">// report error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ€å¤šç­‰å¾… 20 ä¸ªäº‹ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">pevents</span>[20];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…10ç§’ï¼Œæ£€ç´¢20ä¸ªå¹¶å­˜å…¥epoll_eventæ•°ç»„</span></span><br><span class="line"><span class="type">int</span> ready = epoll_wait(pollingfd, pevents, <span class="number">20</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="comment">// æ£€æŸ¥epollæ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="keyword">if</span> ( ret == <span class="number">-1</span>)<span class="comment">// report error and abort</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( ret == <span class="number">0</span>)<span class="comment">// timeout; no event detected</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ready; i+ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( pevents[i].events &amp; EPOLLIN )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è·å–è¿æ¥æŒ‡é’ˆ</span></span><br><span class="line">            Connection * c = (Connection*) pevents[i].data.ptr;</span><br><span class="line">            c-&gt;handleReadEvent();</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµç¨‹å›¾ï¼š<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/blob/master/Java/IO-epoll%E5%8E%9F%E7%90%86%E5%9B%BE.jpg">https://gitee.com/seazean/images/blob/master/Java/IO-epollåŸç†å›¾.jpg</a></p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19D4y1o797">https://www.bilibili.com/video/BV19D4y1o797</a></p>
<hr>
<h5 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h5>
<p>epoll çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>
<p>epoll ä»…é€‚ç”¨äº Linux ç³»ç»Ÿ</p>
</li>
<li>
<p>epoll ä½¿ç”¨<strong>ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæè¿°ç¬¦</strong>ï¼Œå°†ç”¨æˆ·å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å­˜æ”¾åˆ°å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶è¡¨ï¼ˆä¸ªäººç†è§£æˆå“‘å…ƒèŠ‚ç‚¹ï¼‰</p>
</li>
<li>
<p>æ²¡æœ‰æœ€å¤§æè¿°ç¬¦æ•°é‡ï¼ˆå¹¶å‘è¿æ¥ï¼‰çš„é™åˆ¶ï¼Œæ‰“å¼€ fd çš„ä¸Šé™è¿œå¤§äº 1024ï¼ˆ1G å†…å­˜èƒ½ç›‘å¬çº¦ 10 ä¸‡ä¸ªç«¯å£ï¼‰</p>
</li>
<li>
<p>epoll çš„æ—¶é—´å¤æ‚åº¦ O(1)ï¼Œepoll ç†è§£ä¸º event pollï¼Œä¸åŒäºå¿™è½®è¯¢å’Œæ— å·®åˆ«è½®è¯¢ï¼Œè°ƒç”¨ epoll_wait <strong>åªæ˜¯è½®è¯¢å°±ç»ªé“¾è¡¨</strong>ã€‚å½“ç›‘å¬åˆ—è¡¨æœ‰è®¾å¤‡å°±ç»ªæ—¶è°ƒç”¨å›è°ƒå‡½æ•°ï¼ŒæŠŠå°±ç»ª fd æ”¾å…¥å°±ç»ªé“¾è¡¨ä¸­ï¼Œå¹¶å”¤é†’åœ¨ epoll_wait ä¸­é˜»å¡çš„è¿›ç¨‹ï¼Œæ‰€ä»¥ epoll å®é™…ä¸Šæ˜¯<strong>äº‹ä»¶é©±åŠ¨</strong>ï¼ˆæ¯ä¸ªäº‹ä»¶å…³è”ä¸Š fdï¼‰çš„ï¼Œé™ä½äº† system call çš„æ—¶é—´å¤æ‚åº¦</p>
</li>
<li>
<p>epoll å†…æ ¸ä¸­æ ¹æ®æ¯ä¸ª fd ä¸Šçš„ callback å‡½æ•°æ¥å®ç°ï¼Œåªæœ‰æ´»è·ƒçš„ socket æ‰ä¼šä¸»åŠ¨è°ƒç”¨ callbackï¼Œæ‰€ä»¥ä½¿ç”¨ epoll æ²¡æœ‰å‰é¢ä¸¤è€…çš„çº¿æ€§ä¸‹é™çš„æ€§èƒ½é—®é¢˜ï¼Œæ•ˆç‡æé«˜</p>
</li>
<li>
<p>epoll æ³¨å†Œæ–°çš„äº‹ä»¶æ˜¯æ³¨å†Œåˆ°åˆ°å†…æ ¸ä¸­ epoll å¥æŸ„ä¸­ï¼Œä¸éœ€è¦æ¯æ¬¡è°ƒç”¨ epoll_wait æ—¶é‡å¤æ‹·è´ï¼Œå¯¹æ¯”å‰é¢ä¸¤ç§åªéœ€è¦å°†æè¿°ç¬¦ä»è¿›ç¨‹ç¼“å†²åŒºå‘å†…æ ¸ç¼“å†²åŒº<strong>æ‹·è´ä¸€æ¬¡</strong>ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ <strong>mmap() æ–‡ä»¶æ˜ å°„å†…å­˜</strong>åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ï¼ˆåªæ˜¯å¯ä»¥ç”¨ï¼Œå¹¶æ²¡æœ‰ç”¨ï¼‰</p>
</li>
<li>
<p>å‰é¢ä¸¤è€…è¦æŠŠ current å¾€è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ä¸­æŒ‚ä¸€æ¬¡ï¼Œepoll ä¹ŸåªæŠŠ current å¾€ç­‰å¾…é˜Ÿåˆ—ä¸ŠæŒ‚ä¸€æ¬¡ï¼Œä½†æ˜¯è¿™é‡Œçš„ç­‰å¾…é˜Ÿåˆ—å¹¶ä¸æ˜¯è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ï¼Œåªæ˜¯ä¸€ä¸ª epoll å†…éƒ¨å®šä¹‰çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå¼€é”€</p>
</li>
<li>
<p>epoll å¯¹å¤šçº¿ç¨‹ç¼–ç¨‹æ›´æœ‰å‹å¥½ï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº† epoll_wait() å¦ä¸€ä¸ªçº¿ç¨‹å…³é—­äº†åŒä¸€ä¸ªæè¿°ç¬¦ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿåƒ select å’Œ poll çš„ä¸ç¡®å®šæƒ…å†µ</p>
</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dfd940e7fca2">https://www.jianshu.com/p/dfd940e7fca2</a></p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/anker/p/3265058.html">https://www.cnblogs.com/anker/p/3265058.html</a></p>
<hr>
<h4 id="åº”ç”¨">åº”ç”¨</h4>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>
<p>select åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>select çš„ timeout å‚æ•°ç²¾åº¦ä¸ºå¾®ç§’ï¼Œpoll å’Œ epoll ä¸ºæ¯«ç§’ï¼Œå› æ­¤ select é€‚ç”¨<strong>å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜</strong>çš„åœºæ™¯ï¼Œæ¯”å¦‚æ ¸ååº”å †çš„æ§åˆ¶</li>
<li>select å¯ç§»æ¤æ€§æ›´å¥½ï¼Œå‡ ä¹è¢«æ‰€æœ‰ä¸»æµå¹³å°æ‰€æ”¯æŒ</li>
</ul>
</li>
<li>
<p>poll åº”ç”¨åœºæ™¯ï¼špoll æ²¡æœ‰æœ€å¤§æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ï¼Œé€‚ç”¨äºå¹³å°æ”¯æŒå¹¶ä¸”å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„æƒ…å†µ</p>
</li>
<li>
<p>epoll åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>è¿è¡Œåœ¨ Linux å¹³å°ä¸Šï¼Œæœ‰å¤§é‡çš„æè¿°ç¬¦éœ€è¦åŒæ—¶è½®è¯¢ï¼Œå¹¶ä¸”è¿™äº›è¿æ¥æœ€å¥½æ˜¯<strong>é•¿è¿æ¥</strong></li>
<li>éœ€è¦åŒæ—¶ç›‘æ§å°äº 1000 ä¸ªæè¿°ç¬¦ï¼Œæ²¡å¿…è¦ä½¿ç”¨ epollï¼Œå› ä¸ºè¿™ä¸ªåº”ç”¨åœºæ™¯ä¸‹å¹¶ä¸èƒ½ä½“ç° epoll çš„ä¼˜åŠ¿</li>
<li>éœ€è¦ç›‘æ§çš„æè¿°ç¬¦çŠ¶æ€å˜åŒ–å¤šï¼Œè€Œä¸”æ˜¯éå¸¸çŸ­æš‚çš„ï¼Œå°±æ²¡æœ‰å¿…è¦ä½¿ç”¨ epollã€‚å› ä¸º epoll ä¸­çš„æ‰€æœ‰æè¿°ç¬¦éƒ½å­˜å‚¨åœ¨å†…æ ¸ä¸­ï¼Œæ¯æ¬¡å¯¹æè¿°ç¬¦çš„çŠ¶æ€æ”¹å˜éƒ½éœ€è¦é€šè¿‡ epoll_ctl() è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œé¢‘ç¹ç³»ç»Ÿè°ƒç”¨é™ä½æ•ˆç‡ï¼Œå¹¶ä¸” epoll çš„æè¿°ç¬¦å­˜å‚¨åœ¨å†…æ ¸ï¼Œä¸å®¹æ˜“è°ƒè¯•</li>
</ul>
</li>
</ul>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md">https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md</a></p>
<hr>
<h3 id="ç³»ç»Ÿè°ƒç”¨">ç³»ç»Ÿè°ƒç”¨</h3>
<h4 id="å†…æ ¸æ€">å†…æ ¸æ€</h4>
<p>ç”¨æˆ·ç©ºé—´ï¼šç”¨æˆ·ä»£ç ã€ç”¨æˆ·å †æ ˆ</p>
<p>å†…æ ¸ç©ºé—´ï¼šå†…æ ¸ä»£ç ã€å†…æ ¸è°ƒåº¦ç¨‹åºã€è¿›ç¨‹æè¿°ç¬¦ï¼ˆå†…æ ¸å †æ ˆã€thread_info è¿›ç¨‹æè¿°ç¬¦ï¼‰</p>
<ul>
<li>è¿›ç¨‹æè¿°ç¬¦å’Œç”¨æˆ·çš„è¿›ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„</li>
<li>SYS_API ç³»ç»Ÿè°ƒç”¨ï¼šå¦‚ readã€writeï¼Œç³»ç»Ÿè°ƒç”¨å°±æ˜¯ 0X80 ä¸­æ–­</li>
<li>è¿›ç¨‹æè¿°ç¬¦ pdï¼šè¿›ç¨‹ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ—¶ï¼Œéœ€è¦<strong>ä¿å­˜ç”¨æˆ·æ€æ—¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯åœ¨ PCB ä¸­</strong></li>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·ç¨‹åºåŸºåœ°å€ï¼Œç¨‹åºè®¡æ•°å™¨ã€cpu cacheã€å¯„å­˜å™¨ç­‰ï¼Œæ–¹ä¾¿ç¨‹åºåˆ‡å›ç”¨æˆ·æ€æ—¶æ¢å¤ç°åœº</li>
<li>å†…æ ¸å †æ ˆï¼š**ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¹Ÿæ˜¯è¦åˆ›å»ºå˜é‡çš„ï¼Œ**è¿™äº›å˜é‡åœ¨å†…æ ¸å †æ ˆä¸Šåˆ†é…</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81.png" alt=""></p>
<hr>
<h4 id="80-ä¸­æ–­">80 ä¸­æ–­</h4>
<p>åœ¨ç”¨æˆ·ç¨‹åºä¸­è°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„æ ¸å¿ƒæ€çº§åˆ«çš„å­åŠŸèƒ½ï¼Œä¸ºäº†ç³»ç»Ÿå®‰å…¨éœ€è¦è¿›è¡Œç”¨æˆ·æ€å’Œå†…æ ¸æ€è½¬æ¢ï¼ŒçŠ¶æ€çš„è½¬æ¢éœ€è¦è¿›è¡Œ CPU ä¸­æ–­ï¼Œä¸­æ–­åˆ†ä¸ºç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­ï¼š</p>
<ul>
<li>ç¡¬ä¸­æ–­ï¼šå¦‚ç½‘ç»œä¼ è¾“ä¸­ï¼Œæ•°æ®åˆ°è¾¾ç½‘å¡åï¼Œç½‘å¡ç»è¿‡ä¸€ç³»åˆ—æ“ä½œåå‘èµ·ç¡¬ä»¶ä¸­æ–­</li>
<li>è½¯ä¸­æ–­ï¼šå¦‚ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æœ¬èº«äº§ç”Ÿçš„ä¸€äº›ä¸­æ–­
<ul>
<li>å‘èµ· <code>0X80</code> ä¸­æ–­</li>
<li>ç¨‹åºæ‰§è¡Œç¢°åˆ°é™¤ 0 å¼‚å¸¸</li>
</ul>
</li>
</ul>
<p>ç³»ç»Ÿè°ƒç”¨ system_call å‡½æ•°æ‰€å¯¹åº”çš„ä¸­æ–­æŒ‡ä»¤ç¼–å·æ˜¯ 0X80ï¼ˆåè¿›åˆ¶æ˜¯ 8Ã—16=128ï¼‰ï¼Œè€Œè¯¥æŒ‡ä»¤ç¼–å·å¯¹åº”çš„å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ç¨‹åºçš„å…¥å£ï¼Œæ‰€ä»¥ç§°ç³»ç»Ÿè°ƒç”¨ä¸º 80 ä¸­æ–­</p>
<p>ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹ï¼š</p>
<ul>
<li>åœ¨ CPU å¯„å­˜å™¨é‡Œå­˜ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·ï¼Œè¡¨ç¤ºå“ªä¸ªç³»ç»Ÿå‡½æ•°ï¼Œæ¯”å¦‚ read</li>
<li>å°† CPU çš„ä¸´æ—¶æ•°æ®éƒ½ä¿å­˜åˆ° thread_info ä¸­</li>
<li>æ‰§è¡Œ 80 ä¸­æ–­å¤„ç†ç¨‹åºï¼Œæ‰¾åˆ°åˆšåˆšå­˜çš„ç³»ç»Ÿè°ƒç”¨å·ï¼ˆreadï¼‰ï¼Œå…ˆæ£€æŸ¥ç¼“å­˜ä¸­æœ‰æ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œæ²¡æœ‰å°±å»ç£ç›˜ä¸­åŠ è½½åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li>
<li>æœ€åæ¢å¤åˆ°ç”¨æˆ·æ€ï¼Œé€šè¿‡ thread_info æ¢å¤ç°åœºï¼Œç”¨æˆ·æ€ç»§ç»­æ‰§è¡Œ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E8%BF%87%E7%A8%8B.jpg" alt=""></p>
<p>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19D4y1o797">https://www.bilibili.com/video/BV19D4y1o797</a></p>
<hr>
<h3 id="é›¶æ‹·è´">é›¶æ‹·è´</h3>
<h4 id="DMA">DMA</h4>
<p>DMA (Direct Memory Access) ï¼šç›´æ¥å­˜å‚¨å™¨è®¿é—®ï¼Œè®©å¤–éƒ¨è®¾å¤‡ä¸é€šè¿‡ CPU ç›´æ¥ä¸ç³»ç»Ÿå†…å­˜äº¤æ¢æ•°æ®çš„æ¥å£æŠ€æœ¯</p>
<p>ä½œç”¨ï¼šå¯ä»¥è§£å†³æ‰¹é‡æ•°æ®çš„è¾“å…¥/è¾“å‡ºé—®é¢˜ï¼Œä½¿æ•°æ®çš„ä¼ é€é€Ÿåº¦å–å†³äºå­˜å‚¨å™¨å’Œå¤–è®¾çš„å·¥ä½œé€Ÿåº¦</p>
<p>æŠŠå†…å­˜æ•°æ®ä¼ è¾“åˆ°ç½‘å¡ç„¶åå‘é€ï¼š</p>
<ul>
<li>æ²¡æœ‰ DMAï¼šCPU è¯»å†…å­˜æ•°æ®åˆ° CPU é«˜é€Ÿç¼“å­˜ï¼Œå†å†™åˆ°ç½‘å¡ï¼Œè¿™æ ·å°±æŠŠ CPU çš„é€Ÿåº¦æ‹‰ä½åˆ°å’Œç½‘å¡ä¸€ä¸ªé€Ÿåº¦</li>
<li>ä½¿ç”¨ DMAï¼šæŠŠæ•°æ®è¯»åˆ° Socket å†…æ ¸ç¼“å­˜åŒºï¼ˆCPU å¤åˆ¶ï¼‰ï¼ŒCPU åˆ†é…ç»™ DMA å¼€å§‹<strong>å¼‚æ­¥</strong>æ“ä½œï¼ŒDMA è¯»å– Socket ç¼“å†²åŒºåˆ° DMA ç¼“å†²åŒºï¼Œç„¶åå†™åˆ°ç½‘å¡ã€‚DMA æ‰§è¡Œå®Œå<strong>ä¸­æ–­</strong>ï¼ˆå°±æ˜¯é€šçŸ¥ï¼‰ CPUï¼Œè¿™æ—¶ Socket å†…æ ¸ç¼“å†²åŒºä¸ºç©ºï¼ŒCPU ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œæ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºï¼Œå°†éœ€è¦ä½¿ç”¨ Socket ç¼“å†²åŒºçš„é˜»å¡è¿›ç¨‹ç§»åˆ°å°±ç»ªé˜Ÿåˆ—</li>
</ul>
<p>ä¸€ä¸ªå®Œæ•´çš„ DMA ä¼ è¾“è¿‡ç¨‹å¿…é¡»ç»å† DMA è¯·æ±‚ã€DMA å“åº”ã€DMA ä¼ è¾“ã€DMA ç»“æŸå››ä¸ªæ­¥éª¤ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-DMA.png" style="zoom: 50%;" />
<p>DMA æ–¹å¼æ˜¯ä¸€ç§å®Œå…¨ç”±ç¡¬ä»¶è¿›è¡Œä¿¡æ¯ä¼ é€çš„æ§åˆ¶æ–¹å¼ï¼Œé€šå¸¸ç³»ç»Ÿæ€»çº¿ç”± CPU ç®¡ç†ï¼Œåœ¨ DMA æ–¹å¼ä¸­ï¼ŒCPU çš„ä¸»å­˜æ§åˆ¶ä¿¡å·è¢«ç¦æ­¢ä½¿ç”¨ï¼ŒCPU æŠŠæ€»çº¿ï¼ˆåœ°å€æ€»çº¿ã€æ•°æ®æ€»çº¿ã€æ§åˆ¶æ€»çº¿ï¼‰è®©å‡ºæ¥ç”± DMA æ§åˆ¶å™¨æ¥ç®¡ï¼Œç”¨æ¥æ§åˆ¶ä¼ é€çš„å­—èŠ‚æ•°ã€åˆ¤æ–­ DMA æ˜¯å¦ç»“æŸã€ä»¥åŠå‘å‡º DMA ç»“æŸä¿¡å·ï¼Œæ‰€ä»¥ DMA æ§åˆ¶å™¨å¿…é¡»æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>æ¥å—å¤–è®¾å‘å‡ºçš„ DMA è¯·æ±‚ï¼Œå¹¶å‘ CPU å‘å‡ºæ€»çº¿æ¥ç®¡è¯·æ±‚</li>
<li>å½“ CPU å‘å‡ºå…è®¸æ¥ç®¡ä¿¡å·åï¼Œè¿›å…¥ DMA æ“ä½œå‘¨æœŸ</li>
<li>ç¡®å®šä¼ é€æ•°æ®çš„ä¸»å­˜å•å…ƒåœ°å€åŠé•¿åº¦ï¼Œå¹¶è‡ªåŠ¨ä¿®æ”¹ä¸»å­˜åœ°å€è®¡æ•°å’Œä¼ é€é•¿åº¦è®¡æ•°</li>
<li>è§„å®šæ•°æ®åœ¨ä¸»å­˜å’Œå¤–è®¾é—´çš„ä¼ é€æ–¹å‘ï¼Œå‘å‡ºè¯»å†™ç­‰æ§åˆ¶ä¿¡å·ï¼Œæ‰§è¡Œæ•°æ®ä¼ é€æ“ä½œ</li>
<li>åˆ¤æ–­ DMA ä¼ é€æ˜¯å¦ç»“æŸï¼Œå‘å‡º DMA ç»“æŸä¿¡å·ï¼Œä½¿ CPU æ¢å¤æ­£å¸¸å·¥ä½œçŠ¶æ€ï¼ˆä¸­æ–­ï¼‰</li>
</ul>
<hr>
<h4 id="BIO">BIO</h4>
<p>ä¼ ç»Ÿçš„ I/O æ“ä½œè¿›è¡Œäº† 4 æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ 4 æ¬¡æ•°æ®æ‹·è´ï¼š</p>
<ul>
<li>JVM å‘å‡º read ç³»ç»Ÿè°ƒç”¨ï¼ŒOS ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ï¼ˆåˆ‡æ¢ 1ï¼‰å¹¶å°†æ•°æ®ä»ç½‘å¡æˆ–ç¡¬ç›˜ç­‰è®¾å¤‡é€šè¿‡ DMA è¯»å–åˆ°å†…æ ¸ç©ºé—´ç¼“å†²åŒºï¼ˆæ‹·è´ 1ï¼‰ï¼Œå†…æ ¸ç¼“å†²åŒºå®é™…ä¸Šæ˜¯<strong>ç£ç›˜é«˜é€Ÿç¼“å­˜ï¼ˆPageCacheï¼‰</strong></li>
<li>OS å†…æ ¸å°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºï¼ˆæ‹·è´ 2ï¼‰ï¼Œç„¶å read ç³»ç»Ÿè°ƒç”¨è¿”å›ï¼Œåˆä¼šå¯¼è‡´ä¸€æ¬¡å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆåˆ‡æ¢ 2ï¼‰</li>
<li>JVM å¤„ç†ä»£ç é€»è¾‘å¹¶å‘é€ write() ç³»ç»Ÿè°ƒç”¨ï¼ŒOS ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ï¼ˆåˆ‡æ¢ 3ï¼‰å¹¶ä»ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºå¤åˆ¶æ•°æ®åˆ°å†…æ ¸ç©ºé—´ç¼“å†²åŒºï¼ˆæ‹·è´ 3ï¼‰</li>
<li>å°†å†…æ ¸ç©ºé—´ç¼“å†²åŒºä¸­çš„æ•°æ®å†™åˆ° hardwareï¼ˆæ‹·è´ 4ï¼‰ï¼Œwrite ç³»ç»Ÿè°ƒç”¨è¿”å›ï¼Œå¯¼è‡´å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„å†æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆåˆ‡æ¢ 4ï¼‰</li>
</ul>
<p>æµç¨‹å›¾ä¸­çš„ç®­å¤´åè¿‡æ¥ä¹Ÿæˆç«‹ï¼Œå¯ä»¥ä»ç½‘å¡è·å–æ•°æ®</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-BIO%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>read è°ƒç”¨å›¾ç¤ºï¼šreadã€write éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-%E7%BC%93%E5%86%B2%E5%8C%BA%E8%AF%BB%E5%86%99.png" style="zoom: 67%;" />
<hr>
<h4 id="mmap">mmap</h4>
<p>mmapï¼ˆMemory Mapped Filesï¼‰å†…å­˜æ˜ å°„åŠ  write å®ç°é›¶æ‹·è´ï¼Œ<strong>é›¶æ‹·è´å°±æ˜¯æ²¡æœ‰æ•°æ®ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´</strong></p>
<p>ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´éƒ½ä½¿ç”¨å†…å­˜ï¼Œæ‰€ä»¥å¯ä»¥å…±äº«åŒä¸€å—ç‰©ç†å†…å­˜åœ°å€ï¼Œçœå»ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„æ‹·è´ã€‚å†™ç½‘å¡æ—¶ï¼Œå…±äº«ç©ºé—´çš„å†…å®¹æ‹·è´åˆ° Socket ç¼“å†²åŒºï¼Œç„¶åäº¤ç»™ DMA å‘é€åˆ°ç½‘å¡ï¼Œåªéœ€è¦ 3 æ¬¡å¤åˆ¶</p>
<p>è¿›è¡Œäº† 4 æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ 3 æ¬¡æ•°æ®æ‹·è´ï¼ˆ2 æ¬¡ DMAï¼Œä¸€æ¬¡ CPU å¤åˆ¶ï¼‰ï¼š</p>
<ul>
<li>å‘å‡º mmap ç³»ç»Ÿè°ƒç”¨ï¼ŒDMA æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œæ˜ å°„åˆ°å…±äº«ç¼“å†²åŒºï¼›mmap ç³»ç»Ÿè°ƒç”¨è¿”å›ï¼Œæ— éœ€æ‹·è´</li>
<li>å‘å‡º write ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ Socket ç¼“å†²åŒºï¼›write ç³»ç»Ÿè°ƒç”¨è¿”å›ï¼ŒDMA å°†å†…æ ¸ç©ºé—´ Socket ç¼“å†²åŒºä¸­çš„æ•°æ®ä¼ é€’åˆ°åè®®å¼•æ“</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-mmap%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>åŸç†ï¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„ Page æ¥å®ç°æ–‡ä»¶åˆ°ç‰©ç†å†…å­˜çš„ç›´æ¥æ˜ å°„ï¼Œå®Œæˆæ˜ å°„åå¯¹ç‰©ç†å†…å­˜çš„æ“ä½œä¼š<strong>è¢«åŒæ­¥</strong>åˆ°ç¡¬ç›˜ä¸Š</p>
<p>ç¼ºç‚¹ï¼šä¸å¯é ï¼Œå†™åˆ° mmap ä¸­çš„æ•°æ®å¹¶æ²¡æœ‰è¢«çœŸæ­£çš„å†™åˆ°ç¡¬ç›˜ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨ç¨‹åºä¸»åŠ¨è°ƒç”¨ flush çš„æ—¶å€™æ‰æŠŠæ•°æ®çœŸæ­£çš„å†™åˆ°ç¡¬ç›˜</p>
<p>Java NIO æä¾›äº† <strong>MappedByteBuffer</strong> ç±»å¯ä»¥ç”¨æ¥å®ç° mmap å†…å­˜æ˜ å°„ï¼ŒMappedByteBuffer ç±»å¯¹è±¡<strong>åªèƒ½é€šè¿‡è°ƒç”¨ <code>FileChannel.map()</code> è·å–</strong></p>
<hr>
<h4 id="sendfile">sendfile</h4>
<p>sendfile å®ç°é›¶æ‹·è´ï¼Œæ‰“å¼€æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ fd å’Œ socket çš„ fd ä¼ é€’ç»™ sendfileï¼Œç„¶åç»è¿‡ 3 æ¬¡å¤åˆ¶å’Œ 2 æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢</p>
<p>åŸç†ï¼šæ•°æ®æ ¹æœ¬ä¸ç»è¿‡ç”¨æˆ·æ€ï¼Œç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºè¿›å…¥åˆ° Socket Bufferï¼Œç”±äºå’Œç”¨æˆ·æ€å®Œå…¨æ— å…³ï¼Œå°±å‡å°‘äº†ä¸¤æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
<p>è¯´æ˜ï¼šé›¶æ‹·è´æŠ€æœ¯æ˜¯ä¸å…è®¸è¿›ç¨‹å¯¹æ–‡ä»¶å†…å®¹ä½œè¿›ä¸€æ­¥çš„åŠ å·¥çš„ï¼Œæ¯”å¦‚å‹ç¼©æ•°æ®å†å‘é€</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--IO-sendfile%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>sendfile2.4 ä¹‹åï¼Œsendfile å®ç°äº†æ›´ç®€å•çš„æ–¹å¼ï¼Œæ–‡ä»¶åˆ°è¾¾å†…æ ¸ç¼“å†²åŒºåï¼Œä¸å¿…å†å°†æ•°æ®å…¨éƒ¨å¤åˆ¶åˆ° socket buffer ç¼“å†²åŒºï¼Œè€Œæ˜¯åª<strong>å°†è®°å½•æ•°æ®ä½ç½®å’Œé•¿åº¦ç›¸å…³ç­‰æè¿°ç¬¦ä¿¡æ¯</strong>ä¿å­˜åˆ° socket bufferï¼ŒDMA æ ¹æ® Socket ç¼“å†²åŒºä¸­æè¿°ç¬¦æä¾›çš„ä½ç½®å’Œåç§»é‡ä¿¡æ¯ç›´æ¥å°†å†…æ ¸ç©ºé—´ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°åè®®å¼•æ“ä¸Šï¼ˆ2 æ¬¡å¤åˆ¶ 2 æ¬¡åˆ‡æ¢ï¼‰</p>
<p>Java NIO å¯¹ sendfile çš„æ”¯æŒæ˜¯ <code>FileChannel.transferTo()/transferFrom()</code>ï¼ŒæŠŠç£ç›˜æ–‡ä»¶è¯»å– OS å†…æ ¸ç¼“å†²åŒºåçš„ fileChannelï¼Œç›´æ¥è½¬ç»™ socketChannel å‘é€ï¼Œåº•å±‚å°±æ˜¯ sendfile</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/hancoder/article/details/112149121">https://blog.csdn.net/hancoder/article/details/112149121</a></p>
<hr>
<h2 id="BIO-2">BIO</h2>
<h3 id="Inet">Inet</h3>
<p>ä¸€ä¸ª InetAddress ç±»çš„å¯¹è±¡å°±ä»£è¡¨ä¸€ä¸ª IP åœ°å€å¯¹è±¡</p>
<p>æˆå‘˜æ–¹æ³•ï¼š</p>
<ul>
<li><code>static InetAddress getLocalHost()</code>ï¼šè·å¾—æœ¬åœ°ä¸»æœº IP åœ°å€å¯¹è±¡</li>
<li><code>static InetAddress getByName(String host)</code>ï¼šæ ¹æ® IP åœ°å€å­—ç¬¦ä¸²æˆ–ä¸»æœºåè·å¾—å¯¹åº”çš„ IP åœ°å€å¯¹è±¡</li>
<li><code>String getHostName()</code>ï¼šè·å–ä¸»æœºå</li>
<li><code>String getHostAddress()</code>ï¼šè·å¾— IP åœ°å€å­—ç¬¦ä¸²</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InetAddressDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.è·å–æœ¬æœºåœ°å€å¯¹è±¡</span></span><br><span class="line">        <span class="type">InetAddress</span> <span class="variable">ip</span> <span class="operator">=</span> InetAddress.getLocalHost();</span><br><span class="line">        System.out.println(ip.getHostName());<span class="comment">//DESKTOP-NNMBHQR</span></span><br><span class="line">        System.out.println(ip.getHostAddress());<span class="comment">//192.168.11.1</span></span><br><span class="line">        <span class="comment">// 2.è·å–åŸŸåipå¯¹è±¡</span></span><br><span class="line">        <span class="type">InetAddress</span> <span class="variable">ip2</span> <span class="operator">=</span> InetAddress.getByName(<span class="string">&quot;www.baidu.com&quot;</span>);</span><br><span class="line">        System.out.println(ip2.getHostName());<span class="comment">//www.baidu.com</span></span><br><span class="line">        System.out.println(ip2.getHostAddress());<span class="comment">//14.215.177.38</span></span><br><span class="line">        <span class="comment">// 3.è·å–å…¬ç½‘IPå¯¹è±¡ã€‚</span></span><br><span class="line">        <span class="type">InetAddress</span> <span class="variable">ip3</span> <span class="operator">=</span> InetAddress.getByName(<span class="string">&quot;182.61.200.6&quot;</span>);</span><br><span class="line">        System.out.println(ip3.getHostName());<span class="comment">//182.61.200.6</span></span><br><span class="line">        System.out.println(ip3.getHostAddress());<span class="comment">//182.61.200.6</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­æ˜¯å¦èƒ½é€šï¼š ping  5sä¹‹å‰æµ‹è¯•æ˜¯å¦å¯é€š</span></span><br><span class="line">        System.out.println(ip2.isReachable(<span class="number">5000</span>)); <span class="comment">// pingç™¾åº¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="UDP">UDP</h3>
<h4 id="åŸºæœ¬ä»‹ç»-3">åŸºæœ¬ä»‹ç»</h4>
<p>UDPï¼ˆUser Datagram Protocolï¼‰åè®®çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>é¢å‘æ— è¿æ¥çš„åè®®ï¼Œå‘é€ç«¯åªç®¡å‘é€ï¼Œä¸ç¡®è®¤å¯¹æ–¹æ˜¯å¦èƒ½æ”¶åˆ°ï¼Œé€Ÿåº¦å¿«ï¼Œä½†æ˜¯ä¸å¯é ï¼Œä¼šä¸¢å¤±æ•°æ®</li>
<li>å°½æœ€å¤§åŠªåŠ›äº¤ä»˜ï¼Œæ²¡æœ‰æ‹¥å¡æ§åˆ¶</li>
<li>åŸºäºæ•°æ®åŒ…è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œå‘é€æ•°æ®çš„åŒ…çš„å¤§å°é™åˆ¶ <strong>64KB</strong> ä»¥å†…</li>
<li>æ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šçš„äº¤äº’é€šä¿¡</li>
</ul>
<p>UDP åè®®çš„ä½¿ç”¨åœºæ™¯ï¼šåœ¨çº¿è§†é¢‘ã€ç½‘ç»œè¯­éŸ³ã€ç”µè¯</p>
<hr>
<h4 id="å®ç°-UDP">å®ç° UDP</h4>
<p>UDP åè®®ç›¸å…³çš„ä¸¤ä¸ªç±»ï¼š</p>
<ul>
<li>DatagramPacketï¼ˆæ•°æ®åŒ…å¯¹è±¡ï¼‰ï¼šç”¨æ¥å°è£…è¦å‘é€æˆ–è¦æ¥æ”¶çš„æ•°æ®ï¼Œæ¯”å¦‚ï¼šé›†è£…ç®±</li>
<li>DatagramSocketï¼ˆå‘é€å¯¹è±¡ï¼‰ï¼šç”¨æ¥å‘é€æˆ–æ¥æ”¶æ•°æ®åŒ…ï¼Œæ¯”å¦‚ï¼šç å¤´</li>
</ul>
<p><strong>DatagramPacket</strong>ï¼š</p>
<ul>
<li>
<p>DatagramPacket ç±»ï¼š</p>
<p><code>public new DatagramPacket(byte[] buf, int length, InetAddress address, int port)</code>ï¼šåˆ›å»ºå‘é€ç«¯æ•°æ®åŒ…å¯¹è±¡</p>
<ul>
<li>bufï¼šè¦å‘é€çš„å†…å®¹ï¼Œå­—èŠ‚æ•°ç»„</li>
<li>lengthï¼šè¦å‘é€å†…å®¹çš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚</li>
<li>addressï¼šæ¥æ”¶ç«¯çš„ IP åœ°å€å¯¹è±¡</li>
<li>portï¼šæ¥æ”¶ç«¯çš„ç«¯å£å·</li>
</ul>
<p><code>public new DatagramPacket(byte[] buf, int length)</code>ï¼šåˆ›å»ºæ¥æ”¶ç«¯çš„æ•°æ®åŒ…å¯¹è±¡</p>
<ul>
<li>bufï¼šç”¨æ¥å­˜å‚¨æ¥æ”¶åˆ°å†…å®¹</li>
<li>lengthï¼šèƒ½å¤Ÿæ¥æ”¶å†…å®¹çš„é•¿åº¦</li>
</ul>
</li>
<li>
<p>DatagramPacket ç±»å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>public int getLength()</code>ï¼šè·å¾—å®é™…æ¥æ”¶åˆ°çš„å­—èŠ‚ä¸ªæ•°</li>
<li><code>public byte[] getData()</code>ï¼šè¿”å›æ•°æ®ç¼“å†²åŒº</li>
</ul>
</li>
</ul>
<p><strong>DatagramSocket</strong>ï¼š</p>
<ul>
<li>DatagramSocket ç±»æ„é€ æ–¹æ³•ï¼š
<ul>
<li><code>protected DatagramSocket()</code>ï¼šåˆ›å»ºå‘é€ç«¯çš„ Socket å¯¹è±¡ï¼Œç³»ç»Ÿä¼šéšæœºåˆ†é…ä¸€ä¸ªç«¯å£å·</li>
<li><code>protected DatagramSocket(int port)</code>ï¼šåˆ›å»ºæ¥æ”¶ç«¯çš„ Socket å¯¹è±¡å¹¶æŒ‡å®šç«¯å£å·</li>
</ul>
</li>
<li>DatagramSocket ç±»æˆå‘˜æ–¹æ³•ï¼š
<ul>
<li><code>public void send(DatagramPacket dp)</code>ï¼šå‘é€æ•°æ®åŒ…</li>
<li><code>public void receive(DatagramPacket p)</code>ï¼šæ¥æ”¶æ•°æ®åŒ…</li>
<li><code>public void close()</code>ï¼šå…³é—­æ•°æ®æŠ¥å¥—æ¥å­—</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UDPClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;===å¯åŠ¨å®¢æˆ·ç«¯===&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.åˆ›å»ºä¸€ä¸ªé›†è£…ç®±å¯¹è±¡ï¼Œç”¨äºå°è£…éœ€è¦å‘é€çš„æ•°æ®åŒ…!</span></span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="string">&quot;æˆ‘å­¦Java&quot;</span>.getBytes();</span><br><span class="line">        <span class="type">DatagramPacket</span> <span class="variable">packet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(buffer,bubffer.length,InetAddress.getLoclHost,<span class="number">8000</span>);</span><br><span class="line">        <span class="comment">// 2.åˆ›å»ºä¸€ä¸ªç å¤´å¯¹è±¡</span></span><br><span class="line">        <span class="type">DatagramSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>();</span><br><span class="line">        <span class="comment">// 3.å¼€å§‹å‘é€æ•°æ®åŒ…å¯¹è±¡</span></span><br><span class="line">        socket.send(packet);</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UDPServerDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;==å¯åŠ¨æœåŠ¡ç«¯ç¨‹åº==&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.åˆ›å»ºä¸€ä¸ªæ¥æ”¶å®¢æˆ·éƒ½ç«¯çš„æ•°æ®åŒ…å¯¹è±¡ï¼ˆé›†è£…ç®±ï¼‰</span></span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>*<span class="number">64</span>];</span><br><span class="line">        <span class="type">DatagramPacket</span> <span class="variable">packet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(buffer, bubffer.length);</span><br><span class="line">        <span class="comment">// 2.åˆ›å»ºä¸€ä¸ªæ¥æ”¶ç«¯çš„ç å¤´å¯¹è±¡</span></span><br><span class="line">        <span class="type">DatagramSocket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramSocket</span>(<span class="number">8000</span>);</span><br><span class="line">        <span class="comment">// 3.å¼€å§‹æ¥æ”¶</span></span><br><span class="line">        socket.receive(packet);</span><br><span class="line">        <span class="comment">// 4.ä»é›†è£…ç®±ä¸­è·å–æœ¬æ¬¡è¯»å–çš„æ•°æ®é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> packet.getLength();</span><br><span class="line">        <span class="comment">// 5.è¾“å‡ºæ•°æ®</span></span><br><span class="line">        <span class="comment">// String rs = new String(socket.getData(), 0, len)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer , <span class="number">0</span> , len);</span><br><span class="line">        System.out.println(rs);</span><br><span class="line">        <span class="comment">// 6.æœåŠ¡ç«¯è¿˜å¯ä»¥è·å–å‘æ¥ä¿¡æ¯çš„å®¢æˆ·ç«¯çš„IPå’Œç«¯å£ã€‚</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> packet.getAddress().getHostAdress();</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> packet.getPort();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="é€šè®¯æ–¹å¼">é€šè®¯æ–¹å¼</h4>
<p>UDP é€šä¿¡æ–¹å¼ï¼š</p>
<ul>
<li>
<p>å•æ’­ï¼šç”¨äºä¸¤ä¸ªä¸»æœºä¹‹é—´çš„ç«¯å¯¹ç«¯é€šä¿¡</p>
</li>
<li>
<p>ç»„æ’­ï¼šç”¨äºå¯¹ä¸€ç»„ç‰¹å®šçš„ä¸»æœºè¿›è¡Œé€šä¿¡</p>
<p>IP : 224.0.1.0</p>
<p>Socket å¯¹è±¡ : MulticastSocket</p>
</li>
<li>
<p>å¹¿æ’­ï¼šç”¨äºä¸€ä¸ªä¸»æœºå¯¹æ•´ä¸ªå±€åŸŸç½‘ä¸Šæ‰€æœ‰ä¸»æœºä¸Šçš„æ•°æ®é€šä¿¡</p>
<p>IP : 255.255.255.255</p>
<p>Socket å¯¹è±¡ : DatagramSocket</p>
</li>
</ul>
<hr>
<h3 id="TCP">TCP</h3>
<h4 id="åŸºæœ¬ä»‹ç»-4">åŸºæœ¬ä»‹ç»</h4>
<p>TCP/IP (Transfer Control Protocol) åè®®ï¼Œä¼ è¾“æ§åˆ¶åè®®</p>
<p>TCP/IP åè®®çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>é¢å‘è¿æ¥çš„åè®®ï¼Œæä¾›å¯é äº¤äº’ï¼Œé€Ÿåº¦æ…¢</li>
<li>ç‚¹å¯¹ç‚¹çš„å…¨åŒå·¥é€šä¿¡</li>
<li>é€šè¿‡<strong>ä¸‰æ¬¡æ¡æ‰‹</strong>å»ºç«‹è¿æ¥ï¼Œè¿æ¥æˆåŠŸå½¢æˆæ•°æ®ä¼ è¾“é€šé“ï¼›é€šè¿‡<strong>å››æ¬¡æŒ¥æ‰‹</strong>æ–­å¼€è¿æ¥</li>
<li>åŸºäºå­—èŠ‚æµè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¼ è¾“æ•°æ®å¤§å°æ²¡æœ‰é™åˆ¶</li>
</ul>
<p>TCP åè®®çš„ä½¿ç”¨åœºæ™¯ï¼šæ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½ã€é‚®ä»¶å‘é€å’Œæ¥æ”¶ã€è¿œç¨‹ç™»å½•</p>
<p>æ³¨æ„ï¼š<strong>TCP ä¸ä¼šä¸ºæ²¡æœ‰æ•°æ®çš„ ACK è¶…æ—¶é‡ä¼ </strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="ä¸‰æ¬¡æ¡æ‰‹" style="zoom: 50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpeg" alt="å››æ¬¡æŒ¥æ‰‹" style="zoom: 67%;" />
<p>æ¨èé˜…è¯»ï¼š<a target="_blank" rel="noopener" href="https://yuanrengu.com/2020/77eef79f.html">https://yuanrengu.com/2020/77eef79f.html</a></p>
<hr>
<h4 id="Socket">Socket</h4>
<p>TCP é€šä¿¡ä¹Ÿå« <strong>Socket ç½‘ç»œç¼–ç¨‹</strong>ï¼Œåªè¦ä»£ç åŸºäº Socket å¼€å‘ï¼Œåº•å±‚å°±æ˜¯åŸºäºäº†å¯é ä¼ è¾“çš„ TCP é€šä¿¡</p>
<p>åŒå‘é€šä¿¡ï¼šJava Socket æ˜¯å…¨åŒå·¥çš„ï¼Œåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨ <code>A -&gt; B</code> å’Œ <code>B -&gt; A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ï¼Œå³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™ä¹Ÿæ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</p>
<p>TCP åè®®ç›¸å…³çš„ç±»ï¼š</p>
<ul>
<li>Socketï¼šä¸€ä¸ªè¯¥ç±»çš„å¯¹è±¡å°±ä»£è¡¨ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºã€‚</li>
<li>ServerSocketï¼šä¸€ä¸ªè¯¥ç±»çš„å¯¹è±¡å°±ä»£è¡¨ä¸€ä¸ªæœåŠ¡å™¨ç«¯ç¨‹åºã€‚</li>
</ul>
<p>Socket ç±»ï¼š</p>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li>
<p><code>Socket(InetAddress address,int port)</code>ï¼šåˆ›å»ºæµå¥—æ¥å­—å¹¶å°†å…¶è¿æ¥åˆ°æŒ‡å®š IP æŒ‡å®šç«¯å£å·</p>
</li>
<li>
<p><code>Socket(String host, int port)</code>ï¼šæ ¹æ® IP åœ°å€å­—ç¬¦ä¸²å’Œç«¯å£å·åˆ›å»ºå®¢æˆ·ç«¯ Socket å¯¹è±¡</p>
<p>æ³¨æ„äº‹é¡¹ï¼š<strong>æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œå°±ä¼šç«‹å³è¿æ¥æŒ‡å®šçš„æœåŠ¡å™¨ï¼Œè¿æ¥æˆåŠŸï¼Œåˆ™è¡¨ç¤ºä¸‰æ¬¡æ¡æ‰‹é€šè¿‡</strong>ï¼Œåä¹‹æŠ›å‡ºå¼‚å¸¸</p>
</li>
</ul>
</li>
<li>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>OutputStream getOutputStream()</code>ï¼šè·å¾—å­—èŠ‚è¾“å‡ºæµå¯¹è±¡</li>
<li><code>InputStream getInputStream()</code>ï¼šè·å¾—å­—èŠ‚è¾“å…¥æµå¯¹è±¡</li>
<li><code>void shutdownInput()</code>ï¼šåœæ­¢æ¥å—</li>
<li><code>void shutdownOutput()</code>ï¼šåœæ­¢å‘é€æ•°æ®ï¼Œç»ˆæ­¢é€šä¿¡</li>
<li><code>SocketAddress getRemoteSocketAddress() </code>ï¼šè¿”å›å¥—æ¥å­—è¿æ¥åˆ°çš„ç«¯ç‚¹çš„åœ°å€ï¼Œæœªè¿æ¥è¿”å› null</li>
</ul>
</li>
</ul>
<p>ServerSocket ç±»ï¼š</p>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼š<code>public ServerSocket(int port)</code></p>
</li>
<li>
<p>å¸¸ç”¨ APIï¼š<code>public Socket accept()</code>ï¼Œ<strong>é˜»å¡ç­‰å¾…</strong>æ¥æ”¶ä¸€ä¸ªå®¢æˆ·ç«¯çš„ Socket ç®¡é“è¿æ¥è¯·æ±‚ï¼Œè¿æ¥æˆåŠŸè¿”å›ä¸€ä¸ª Socket å¯¹è±¡</p>
<p>ä¸‰æ¬¡æ¡æ‰‹å TCP è¿æ¥å»ºç«‹æˆåŠŸï¼ŒæœåŠ¡å™¨å†…æ ¸ä¼šæŠŠè¿æ¥ä» SYN åŠè¿æ¥é˜Ÿåˆ—ï¼ˆä¸€æ¬¡æ¡æ‰‹æ—¶åœ¨æœåŠ¡ç«¯å»ºç«‹çš„é˜Ÿåˆ—ï¼‰ä¸­ç§»å‡ºï¼Œç§»å…¥ accept å…¨è¿æ¥é˜Ÿåˆ—ï¼Œç­‰å¾…è¿›ç¨‹è°ƒç”¨ accept å‡½æ•°æ—¶æŠŠè¿æ¥å–å‡ºã€‚å¦‚æœè¿›ç¨‹ä¸èƒ½åŠæ—¶è°ƒç”¨ accept å‡½æ•°ï¼Œå°±ä¼šé€ æˆ accept é˜Ÿåˆ—æº¢å‡ºï¼Œæœ€ç»ˆå¯¼è‡´å»ºç«‹å¥½çš„ TCP è¿æ¥è¢«ä¸¢å¼ƒ</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--Netty-TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" style="zoom:67%;" />
</li>
</ul>
<p><strong>ç›¸å½“äº</strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªæ•°æ®ç®¡é“ï¼ˆè™šè¿æ¥ï¼Œä¸æ˜¯çœŸæ­£çš„ç‰©ç†è¿æ¥ï¼‰ï¼Œç®¡é“ä¸€èˆ¬ä¸ç”¨ close</p>
<hr>
<h4 id="å®ç°-TCP">å®ç° TCP</h4>
<h5 id="å¼€å‘æµç¨‹">å¼€å‘æµç¨‹</h5>
<p>å®¢æˆ·ç«¯çš„å¼€å‘æµç¨‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯è¦è¯·æ±‚äºæœåŠ¡ç«¯çš„ Socket ç®¡é“è¿æ¥</li>
<li>ä» Socket é€šä¿¡ç®¡é“ä¸­å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµ</li>
<li>é€šè¿‡å­—èŠ‚è¾“å‡ºæµç»™æœåŠ¡ç«¯å†™å‡ºæ•°æ®</li>
</ol>
<p>æœåŠ¡ç«¯çš„å¼€å‘æµç¨‹ï¼š</p>
<ol>
<li>ç”¨ ServerSocket æ³¨å†Œç«¯å£</li>
<li>æ¥æ”¶å®¢æˆ·ç«¯çš„ Socket ç®¡é“è¿æ¥</li>
<li>ä» Socket é€šä¿¡ç®¡é“ä¸­å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å…¥æµ</li>
<li>ä»å­—èŠ‚è¾“å…¥æµä¸­è¯»å–å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--BIO%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--TCP-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<ul>
<li>å¦‚æœè¾“å‡ºç¼“å†²åŒºç©ºé—´ä¸å¤Ÿå­˜æ”¾ä¸»æœºå‘é€çš„æ•°æ®ï¼Œåˆ™ä¼šè¢«é˜»å¡ï¼Œè¾“å…¥ç¼“å†²åŒºåŒç†</li>
<li>ç¼“å†²åŒºä¸å±äºåº”ç”¨ç¨‹åºï¼Œå±äºå†…æ ¸</li>
<li>TCP ä»è¾“å‡ºç¼“å†²åŒºè¯»å–æ•°æ®ä¼šåŠ é”é˜»å¡çº¿ç¨‹</li>
</ul>
<hr>
<h5 id="å®ç°é€šä¿¡">å®ç°é€šä¿¡</h5>
<p>éœ€æ±‚ä¸€ï¼šå®¢æˆ·ç«¯å‘é€ä¸€è¡Œæ•°æ®ï¼ŒæœåŠ¡ç«¯æ¥æ”¶ä¸€è¡Œæ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.å®¢æˆ·ç«¯è¦è¯·æ±‚äºæœåŠ¡ç«¯çš„socketç®¡é“è¿æ¥ã€‚</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// 2.ä»socketé€šä¿¡ç®¡é“ä¸­å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµ</span></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="comment">// 3.æŠŠä½çº§çš„å­—èŠ‚è¾“å‡ºæµåŒ…è£…æˆé«˜çº§çš„æ‰“å°æµã€‚</span></span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(os);</span><br><span class="line">        <span class="comment">// 4.å¼€å§‹å‘æ¶ˆæ¯å‡ºå»</span></span><br><span class="line">        ps.println(<span class="string">&quot;æˆ‘æ˜¯å®¢æˆ·ç«¯&quot;</span>);</span><br><span class="line">        ps.flush();<span class="comment">//ä¸€èˆ¬ä¸å…³é—­IOæµ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å‘é€å®Œæ¯•~~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----æœåŠ¡ç«¯å¯åŠ¨----&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.æ³¨å†Œç«¯å£: public ServerSocket(int port)</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// 2.å¼€å§‹ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯çš„Socketç®¡é“è¿æ¥ã€‚</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">        <span class="comment">// 3.ä»socketé€šä¿¡ç®¡é“ä¸­å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å…¥æµã€‚</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">        <span class="comment">// 4.æŠŠå­—èŠ‚è¾“å…¥æµè½¬æ¢æˆå­—ç¬¦è¾“å…¥æµ</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">        <span class="comment">// 6.æŒ‰ç…§è¡Œè¯»å–æ¶ˆæ¯ ã€‚</span></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">if</span>((line = br.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éœ€æ±‚äºŒï¼šå®¢æˆ·ç«¯å¯ä»¥åå¤å‘é€æ•°æ®ï¼ŒæœåŠ¡ç«¯å¯ä»¥åå¤æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.å®¢æˆ·ç«¯è¦è¯·æ±‚äºæœåŠ¡ç«¯çš„socketç®¡é“è¿æ¥ã€‚</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// 2.ä»socketé€šä¿¡ç®¡é“ä¸­å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµ</span></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="comment">// 3.æŠŠä½çº§çš„å­—èŠ‚è¾“å‡ºæµåŒ…è£…æˆé«˜çº§çš„æ‰“å°æµã€‚</span></span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(os);</span><br><span class="line">        <span class="comment">// 4.å¼€å§‹å‘æ¶ˆæ¯å‡ºå»</span></span><br><span class="line">         <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.print(<span class="string">&quot;è¯·è¯´ï¼š&quot;</span>);</span><br><span class="line">            ps.println(sc.nextLine());</span><br><span class="line">            ps.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----æœåŠ¡ç«¯å¯åŠ¨----&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.æ³¨å†Œç«¯å£: public ServerSocket(int port)</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// 2.å¼€å§‹ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯çš„Socketç®¡é“è¿æ¥ã€‚</span></span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">        <span class="comment">// 3.ä»socketé€šä¿¡ç®¡é“ä¸­å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å…¥æµã€‚</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">        <span class="comment">// 4.æŠŠå­—èŠ‚è¾“å…¥æµè½¬æ¢æˆå­—ç¬¦è¾“å…¥æµ</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">        <span class="comment">// 6.æŒ‰ç…§è¡Œè¯»å–æ¶ˆæ¯ ã€‚</span></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éœ€æ±‚ä¸‰ï¼šå®ç°ä¸€ä¸ªæœåŠ¡ç«¯å¯ä»¥åŒæ—¶æ¥æ”¶å¤šä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8080</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">socket</span>.getOutputStream();</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(os);</span><br><span class="line">		<span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.print(<span class="string">&quot;è¯·è¯´ï¼š&quot;</span>);</span><br><span class="line">            ps.println(sc.nextLine());</span><br><span class="line">            ps.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----æœåŠ¡ç«¯å¯åŠ¨----&quot;</span>);</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// å¼€å§‹ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯çš„Socketç®¡é“è¿æ¥ã€‚</span></span><br><span class="line">             <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            <span class="comment">// æ¯æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯å¿…é¡»ä¸ºè¿™ä¸ªå®¢æˆ·ç«¯ç®¡é“åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¥å¤„ç†ä¸ä¹‹é€šä¿¡ã€‚</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServerReaderThread</span>(socket).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerReaderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    privat Socket socket;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServerReaderThread</span><span class="params">(Socket socket)</span>&#123;<span class="built_in">this</span>.socket = socket;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">           	<span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is))</span><br><span class="line">           )&#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span>((line = br.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">                sout(socket.getRemoteSocketAddress() + <span class="string">&quot;:&quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            sout(socket.getRemoteSocketAddress() + <span class="string">&quot;ä¸‹çº¿äº†~~~~~~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="ä¼ªå¼‚æ­¥">ä¼ªå¼‚æ­¥</h5>
<p>ä¸€ä¸ªå®¢æˆ·ç«¯è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å‘è¶Šé«˜ç³»ç»Ÿç˜«ç—ªçš„è¶Šå¿«ï¼Œå¯ä»¥åœ¨æœåŠ¡ç«¯å¼•å…¥çº¿ç¨‹æ± ï¼Œä½¿ç”¨çº¿ç¨‹æ± æ¥å¤„ç†ä¸å®¢æˆ·ç«¯çš„æ¶ˆæ¯é€šä¿¡</p>
<ul>
<li>
<p>ä¼˜åŠ¿ï¼šä¸ä¼šå¼•èµ·ç³»ç»Ÿçš„æ­»æœºï¼Œå¯ä»¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡</p>
</li>
<li>
<p>åŠ£åŠ¿ï¼šåŒæ—¶å¯ä»¥å¹¶å‘çš„çº¿ç¨‹å°†å—åˆ°é™åˆ¶</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BIOServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//çº¿ç¨‹æ± æœºåˆ¶</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¦‚æœæœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯(å•ç‹¬å†™ä¸€ä¸ªæ–¹æ³•)</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">newCachedThreadPool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//åˆ›å»ºServerSocket</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6666</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨å¯åŠ¨äº†&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹åå­— = &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="comment">//ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…è¿æ¥....&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿æ¥åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯&quot;</span>);</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯</span></span><br><span class="line">            newCachedThreadPool.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">//å¯ä»¥å’Œå®¢æˆ·ç«¯é€šè®¯</span></span><br><span class="line">                    handler(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼–å†™ä¸€ä¸ªhandleræ–¹æ³•ï¼Œå’Œå®¢æˆ·ç«¯é€šè®¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹åå­— = &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="comment">//é€šè¿‡socketè·å–è¾“å…¥æµ</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="comment">//å¾ªç¯çš„è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">            <span class="keyword">while</span> ((len = inputStream.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹åå­— = &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                <span class="comment">//è¾“å‡ºå®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, read));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å…³é—­å’Œclientçš„è¿æ¥&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ–‡ä»¶ä¼ è¾“">æ–‡ä»¶ä¼ è¾“</h4>
<h5 id="å­—èŠ‚æµ">å­—èŠ‚æµ</h5>
<p>å®¢æˆ·ç«¯ï¼šæœ¬åœ°å›¾ç‰‡: â€ªE:\seazean\å›¾ç‰‡èµ„æº\beautiful.jpg<br>
æœåŠ¡ç«¯ï¼šæœåŠ¡å™¨è·¯å¾„ï¼šE:\seazean\å›¾ç‰‡æœåŠ¡å™¨</p>
<p>UUID. randomUUID() : æ–¹æ³•ç”Ÿæˆéšæœºçš„æ–‡ä»¶å</p>
<p><strong>socket.shutdownOutput()</strong>ï¼šè¿™ä¸ªå¿…é¡»æ‰§è¡Œï¼Œä¸ç„¶æœåŠ¡å™¨ä¼šä¸€ç›´å¾ªç¯ç­‰å¾…æ•°æ®ï¼Œæœ€åæ–‡ä»¶æŸåï¼Œç¨‹åºæŠ¥é”™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¸¸é‡åŒ…</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Constants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SRC_IMAGE</span> <span class="operator">=</span> <span class="string">&quot;D:\\seazean\\å›¾ç‰‡èµ„æº\\beautiful.jpg&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVER_DIR</span> <span class="operator">=</span> <span class="string">&quot;D:\\seazean\\å›¾ç‰‡æœåŠ¡å™¨\\&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVER_IP</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SERVER_PORT</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(Constants.ERVER_IP,Constants.SERVER_PORT);</span><br><span class="line">        BufferedOutputStream bos=<span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(socket.getOutputStream());</span><br><span class="line">        <span class="comment">//æå–æœ¬æœºçš„å›¾ç‰‡ä¸Šä¼ ç»™æœåŠ¡ç«¯ã€‚Constants.SRC_IMAGE</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>());</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> len ;</span><br><span class="line">        <span class="keyword">while</span>((len = bis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bos.write(buffer, <span class="number">0</span> ,len);</span><br><span class="line">        &#125;</span><br><span class="line">        bos.flush();<span class="comment">// åˆ·æ–°å›¾ç‰‡æ•°æ®åˆ°æœåŠ¡ç«¯ï¼ï¼</span></span><br><span class="line">        socket.shutdownOutput();<span class="comment">// å‘Šè¯‰æœåŠ¡ç«¯æˆ‘çš„æ•°æ®å·²ç»å‘é€å®Œæ¯•ï¼Œä¸è¦åœ¨ç­‰æˆ‘äº†ï¼</span></span><br><span class="line">        bis.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç­‰å¾…ç€æœåŠ¡ç«¯çš„å“åº”æ•°æ®ï¼ï¼</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(</span><br><span class="line">           				 <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">        System.out.println(<span class="string">&quot;æ”¶åˆ°æœåŠ¡ç«¯å“åº”ï¼š&quot;</span>+br.readLine());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----æœåŠ¡ç«¯å¯åŠ¨----&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.æ³¨å†Œç«¯å£:</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(Constants.SERVER_PORT);</span><br><span class="line">        <span class="comment">// 2.å®šä¹‰ä¸€ä¸ªå¾ªç¯ä¸æ–­çš„æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 3.å¼€å§‹ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯çš„Socketç®¡é“è¿æ¥ã€‚</span></span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            <span class="comment">// 4.æ¯æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯å¿…é¡»ä¸ºè¿™ä¸ªå®¢æˆ·ç«¯ç®¡é“åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¥å¤„ç†ä¸ä¹‹é€šä¿¡ã€‚</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServerReaderThread</span>(socket).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerReaderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket ;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServerReaderThread</span><span class="params">(Socket socket)</span>&#123;<span class="built_in">this</span>.socket = socket;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">           	<span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(is);</span><br><span class="line">            <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">FileOutputStream</span></span><br><span class="line">                (Constants.SERVER_DIR+UUID.randomUUID().toString()+<span class="string">&quot;.jpg&quot;</span>));</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">while</span>((len = bis.read(buffer)) != -<span class="number">1</span>)&#123;</span><br><span class="line">                bos.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">            &#125;</span><br><span class="line">            bos.close();</span><br><span class="line">            System.out.println(<span class="string">&quot;æœåŠ¡ç«¯æ¥æ”¶å®Œæ¯•äº†ï¼&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">            <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(socket.getOutputStream());</span><br><span class="line">            ps.println(<span class="string">&quot;æ‚¨å¥½ï¼Œå·²æˆåŠŸæ¥æ”¶æ‚¨ä¸Šä¼ çš„å›¾ç‰‡ï¼&quot;</span>);</span><br><span class="line">            ps.flush();</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            sout(socket.getRemoteSocketAddress() + <span class="string">&quot;ä¸‹çº¿äº†&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="æ•°æ®æµ">æ•°æ®æµ</h5>
<p>æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li><code>DataOutputStream(OutputStream out)</code> : åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®è¾“å‡ºæµï¼Œä»¥å°†æ•°æ®å†™å…¥æŒ‡å®šçš„åº•å±‚è¾“å‡ºæµ</li>
<li><code>DataInputStream(InputStream in) </code> : åˆ›å»ºä½¿ç”¨æŒ‡å®šçš„åº•å±‚ InputStream çš„ DataInputStream</li>
</ul>
<p>å¸¸ç”¨ APIï¼š</p>
<ul>
<li><code>final void writeUTF(String str)</code> : ä½¿ç”¨æœºå™¨æ— å…³çš„æ–¹å¼ä½¿ç”¨ UTF-8 ç¼–ç å°†å­—ç¬¦ä¸²å†™å…¥åº•å±‚è¾“å‡ºæµ</li>
<li><code>final String readUTF()</code> : è¯»å–ä»¥ modified UTF-8 æ ¼å¼ç¼–ç çš„ Unicode å­—ç¬¦ä¸²ï¼Œè¿”å› String ç±»å‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line">            <span class="comment">//  1ã€è¯·æ±‚ä¸æœåŠ¡ç«¯çš„Socketé“¾æ¥</span></span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span> , <span class="number">8888</span>);</span><br><span class="line">            <span class="comment">//  2ã€æŠŠå­—èŠ‚è¾“å‡ºæµåŒ…è£…æˆä¸€ä¸ªæ•°æ®è¾“å‡ºæµ</span></span><br><span class="line">            <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(socket.getOutputStream());</span><br><span class="line">            <span class="comment">//  3ã€å…ˆå‘é€ä¸Šä¼ æ–‡ä»¶çš„åç¼€ç»™æœåŠ¡ç«¯</span></span><br><span class="line">            dos.writeUTF(<span class="string">&quot;.png&quot;</span>);</span><br><span class="line">            <span class="comment">//  4ã€æŠŠæ–‡ä»¶æ•°æ®å‘é€ç»™æœåŠ¡ç«¯è¿›è¡Œæ¥æ”¶</span></span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">while</span>((len = is.read(buffer)) &gt; <span class="number">0</span> )&#123;</span><br><span class="line">                dos.write(buffer , <span class="number">0</span> , len);</span><br><span class="line">            &#125;</span><br><span class="line">            dos.flush();</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8888</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> ss.accept();</span><br><span class="line"> 		<span class="comment">// 1ã€å¾—åˆ°ä¸€ä¸ªæ•°æ®è¾“å…¥æµè¯»å–å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®</span></span><br><span class="line">		<span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(socket.getInputStream());</span><br><span class="line">		<span class="comment">// 2ã€è¯»å–å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ–‡ä»¶ç±»å‹</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> dis.readUTF();</span><br><span class="line">		<span class="comment">// 3ã€å®šä¹‰ä¸€ä¸ªå­—èŠ‚è¾“å‡ºç®¡é“è´Ÿè´£æŠŠå®¢æˆ·ç«¯å‘æ¥çš„æ–‡ä»¶æ•°æ®å†™å‡ºå»</span></span><br><span class="line">		<span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;path&quot;</span>+</span><br><span class="line">                    UUID.randomUUID().toString()+suffix);</span><br><span class="line">		<span class="comment">// 4ã€ä»æ•°æ®è¾“å…¥æµä¸­è¯»å–æ–‡ä»¶æ•°æ®ï¼Œå†™å‡ºåˆ°å­—èŠ‚è¾“å‡ºæµä¸­å»</span></span><br><span class="line">		<span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">		<span class="type">int</span> len;</span><br><span class="line">		<span class="keyword">while</span>((len = dis.read(buffer)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line"> 			os.write(buffer,<span class="number">0</span>, len);</span><br><span class="line">		&#125;</span><br><span class="line">		os.close();</span><br><span class="line">		System.out.println(<span class="string">&quot;æœåŠ¡ç«¯æ¥æ”¶æ–‡ä»¶ä¿å­˜æˆåŠŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="NIO">NIO</h2>
<h3 id="åŸºæœ¬ä»‹ç»-5">åŸºæœ¬ä»‹ç»</h3>
<p><strong>NIO çš„ä»‹ç»</strong>ï¼š</p>
<p>Java NIOï¼ˆNew IOã€Java non-blocking IOï¼‰ï¼Œä» Java 1.4 ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªæ–°çš„ IO APIï¼Œå¯ä»¥æ›¿ä»£æ ‡å‡†çš„ Java IO APIï¼ŒNIO æ”¯æŒé¢å‘ç¼“å†²åŒºçš„ã€åŸºäºé€šé“çš„ IO æ“ä½œï¼Œä»¥æ›´åŠ é«˜æ•ˆçš„æ–¹å¼è¿›è¡Œæ–‡ä»¶çš„è¯»å†™æ“ä½œ</p>
<ul>
<li>NIO æœ‰ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼š<strong>Channelï¼ˆé€šé“ï¼‰ï¼ŒBufferï¼ˆç¼“å†²åŒºï¼‰ï¼ŒSelectorï¼ˆé€‰æ‹©å™¨ï¼‰</strong></li>
<li>NIO æ˜¯éé˜»å¡ IOï¼Œä¼ ç»Ÿ IO çš„ read å’Œ write åªèƒ½é˜»å¡æ‰§è¡Œï¼Œçº¿ç¨‹åœ¨è¯»å†™ IO æœŸé—´ä¸èƒ½å¹²å…¶ä»–äº‹æƒ…ï¼Œæ¯”å¦‚è°ƒç”¨ socket.accept()ï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ•°æ®ä¼ è¾“è¿‡æ¥ï¼Œçº¿ç¨‹å°±ä¸€ç›´é˜»å¡ï¼Œè€Œ NIO ä¸­å¯ä»¥é…ç½® Socket ä¸ºéé˜»å¡æ¨¡å¼</li>
<li>NIO å¯ä»¥åšåˆ°ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªæ“ä½œçš„ã€‚å‡è®¾æœ‰ 1000 ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œæ ¹æ®å®é™…æƒ…å†µå¯ä»¥åˆ†é… 20 æˆ–è€… 80 ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œä¸åƒä¹‹å‰çš„é˜»å¡ IO é‚£æ ·åˆ†é… 1000 ä¸ª</li>
</ul>
<p>NIO å’Œ BIO çš„æ¯”è¾ƒï¼š</p>
<ul>
<li>
<p>BIO ä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€Œ NIO ä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œå— I/O çš„æ•ˆç‡æ¯”æµ I/O é«˜å¾ˆå¤š</p>
</li>
<li>
<p>BIO æ˜¯é˜»å¡çš„ï¼ŒNIO åˆ™æ˜¯éé˜»å¡çš„</p>
</li>
<li>
<p>BIO åŸºäºå­—èŠ‚æµå’Œå­—ç¬¦æµè¿›è¡Œæ“ä½œï¼Œè€Œ NIO åŸºäº Channel å’Œ Buffer è¿›è¡Œæ“ä½œï¼Œæ•°æ®ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæˆ–è€…ä»ç¼“å†²åŒºå†™å…¥åˆ°é€šé“ä¸­ã€‚Selector ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šè¿æ¥è¯·æ±‚ï¼Œæ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œå› æ­¤ä½¿ç”¨å•ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯é€šé“</p>
<table>
<thead>
<tr>
<th>NIO</th>
<th>BIO</th>
</tr>
</thead>
<tbody>
<tr>
<td>é¢å‘ç¼“å†²åŒºï¼ˆBufferï¼‰</td>
<td>é¢å‘æµï¼ˆStreamï¼‰</td>
</tr>
<tr>
<td>éé˜»å¡ï¼ˆNon Blocking IOï¼‰</td>
<td>é˜»å¡ IO(Blocking IO)</td>
</tr>
<tr>
<td>é€‰æ‹©å™¨ï¼ˆSelectorsï¼‰</td>
<td></td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr>
<h3 id="å®ç°åŸç†-10">å®ç°åŸç†</h3>
<p>NIO ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼šChannel (é€šé“)ã€Buffer (ç¼“å†²åŒº)ã€Selector (é€‰æ‹©å™¨)</p>
<ul>
<li>
<p>Buffer ç¼“å†²åŒº</p>
<p>ç¼“å†²åŒºæœ¬è´¨æ˜¯ä¸€å—å¯ä»¥å†™å…¥æ•°æ®ã€è¯»å–æ•°æ®çš„å†…å­˜ï¼Œ<strong>åº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„</strong>ï¼Œè¿™å—å†…å­˜è¢«åŒ…è£…æˆ NIO Buffer å¯¹è±¡ï¼Œå¹¶ä¸”æä¾›äº†æ–¹æ³•ç”¨æ¥æ“ä½œè¿™å—å†…å­˜ï¼Œç›¸æ¯”è¾ƒç›´æ¥å¯¹æ•°ç»„çš„æ“ä½œï¼ŒBuffer çš„ API æ›´åŠ å®¹æ˜“æ“ä½œå’Œç®¡ç†</p>
</li>
<li>
<p>Channel é€šé“</p>
<p>Java NIO çš„é€šé“ç±»ä¼¼æµï¼Œä¸åŒçš„æ˜¯æ—¢å¯ä»¥ä»é€šé“ä¸­è¯»å–æ•°æ®ï¼Œåˆå¯ä»¥å†™æ•°æ®åˆ°é€šé“ï¼Œæµçš„è¯»å†™é€šå¸¸æ˜¯å•å‘çš„ï¼Œé€šé“å¯ä»¥éé˜»å¡è¯»å–å’Œå†™å…¥é€šé“ï¼Œæ”¯æŒè¯»å–æˆ–å†™å…¥ç¼“å†²åŒºï¼Œä¹Ÿæ”¯æŒå¼‚æ­¥åœ°è¯»å†™</p>
</li>
<li>
<p>Selector é€‰æ‹©å™¨</p>
<p>Selector æ˜¯ä¸€ä¸ª Java NIO ç»„ä»¶ï¼Œèƒ½å¤Ÿæ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ª NIO é€šé“ï¼Œå¹¶ç¡®å®šå“ªäº›é€šé“å·²ç»å‡†å¤‡å¥½è¿›è¡Œè¯»å–æˆ–å†™å…¥ï¼Œè¿™æ ·ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ª channelï¼Œä»è€Œç®¡ç†å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œæé«˜æ•ˆç‡</p>
</li>
</ul>
<p>NIO çš„å®ç°æ¡†æ¶ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--NIO%E6%A1%86%E6%9E%B6.png" alt=""></p>
<ul>
<li>æ¯ä¸ª Channel å¯¹åº”ä¸€ä¸ª Buffer</li>
<li>ä¸€ä¸ªçº¿ç¨‹å¯¹åº” Selector ï¼Œ ä¸€ä¸ª Selector å¯¹åº”å¤šä¸ª Channelï¼ˆè¿æ¥ï¼‰</li>
<li>ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª Channel æ˜¯ç”±äº‹ä»¶å†³å®šçš„ï¼ŒEvent æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µ</li>
<li>Selector ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨å„ä¸ªé€šé“ä¸Šåˆ‡æ¢</li>
<li>Buffer æ˜¯ä¸€ä¸ªå†…å­˜å— ï¼Œ åº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„</li>
<li>æ•°æ®çš„è¯»å–å†™å…¥æ˜¯é€šè¿‡ Buffer å®Œæˆçš„ , BIO ä¸­è¦ä¹ˆæ˜¯è¾“å…¥æµï¼Œæˆ–è€…æ˜¯è¾“å‡ºæµï¼Œä¸èƒ½åŒå‘ï¼ŒNIO çš„ Buffer æ˜¯å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œ flip() åˆ‡æ¢ Buffer çš„å·¥ä½œæ¨¡å¼</li>
</ul>
<p>Java NIO ç³»ç»Ÿçš„æ ¸å¿ƒåœ¨äºï¼šé€šé“å’Œç¼“å†²åŒºï¼Œé€šé“è¡¨ç¤ºæ‰“å¼€çš„ IO è®¾å¤‡ï¼ˆä¾‹å¦‚ï¼šæ–‡ä»¶ã€ å¥—æ¥å­—ï¼‰çš„è¿æ¥ã€‚è‹¥è¦ä½¿ç”¨ NIO ç³»ç»Ÿï¼Œè·å–ç”¨äºè¿æ¥ IO è®¾å¤‡çš„é€šé“ä»¥åŠç”¨äºå®¹çº³æ•°æ®çš„ç¼“å†²åŒºï¼Œç„¶åæ“ä½œç¼“å†²åŒºï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒChannel è´Ÿè´£ä¼ è¾“ï¼Œ Buffer è´Ÿè´£å­˜å–æ•°æ®</p>
<hr>
<h3 id="ç¼“å†²åŒº">ç¼“å†²åŒº</h3>
<h4 id="åŸºæœ¬ä»‹ç»-6">åŸºæœ¬ä»‹ç»</h4>
<p>ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼šç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å¯ä»¥è¯»å†™æ•°æ®çš„å†…å­˜å—</strong>ï¼Œç”¨äºç‰¹å®šåŸºæœ¬æ•°æ®ç±»å‹çš„å®¹å™¨ï¼Œç”¨äºä¸ NIO é€šé“è¿›è¡Œäº¤äº’ï¼Œæ•°æ®æ˜¯ä»é€šé“è¯»å…¥ç¼“å†²åŒºï¼Œä»ç¼“å†²åŒºå†™å…¥é€šé“ä¸­çš„</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--NIO-Buffer.png" alt=""></p>
<p><strong>Buffer åº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„</strong>ï¼Œå¯ä»¥ä¿å­˜å¤šä¸ªç›¸åŒç±»å‹çš„æ•°æ®ï¼Œæ ¹æ®æ•°æ®ç±»å‹ä¸åŒ ï¼Œæœ‰ä»¥ä¸‹ Buffer å¸¸ç”¨å­ç±»ï¼šByteBufferã€CharBufferã€ShortBufferã€IntBufferã€LongBufferã€FloatBufferã€DoubleBuffer</p>
<hr>
<h4 id="åŸºæœ¬å±æ€§">åŸºæœ¬å±æ€§</h4>
<ul>
<li>
<p>å®¹é‡ï¼ˆcapacityï¼‰ï¼šä½œä¸ºä¸€ä¸ªå†…å­˜å—ï¼ŒBuffer å…·æœ‰å›ºå®šå¤§å°ï¼Œç¼“å†²åŒºå®¹é‡ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”åˆ›å»ºåä¸èƒ½æ›´æ”¹</p>
</li>
<li>
<p>é™åˆ¶ ï¼ˆlimitï¼‰ï¼šè¡¨ç¤ºç¼“å†²åŒºä¸­å¯ä»¥æ“ä½œæ•°æ®çš„å¤§å°ï¼ˆlimit åæ•°æ®ä¸èƒ½è¿›è¡Œè¯»å†™ï¼‰ï¼Œç¼“å†²åŒºçš„é™åˆ¶ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”ä¸èƒ½å¤§äºå…¶å®¹é‡ã€‚å†™å…¥æ¨¡å¼ï¼Œlimit ç­‰äº buffer çš„å®¹é‡ï¼›è¯»å–æ¨¡å¼ä¸‹ï¼Œlimit ç­‰äºå†™å…¥çš„æ•°æ®é‡</p>
</li>
<li>
<p>ä½ç½®ï¼ˆpositionï¼‰ï¼š<strong>ä¸‹ä¸€ä¸ªè¦è¯»å–æˆ–å†™å…¥çš„æ•°æ®çš„ç´¢å¼•</strong>ï¼Œç¼“å†²åŒºçš„ä½ç½®ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”ä¸èƒ½å¤§äºå…¶é™åˆ¶</p>
</li>
<li>
<p>æ ‡è®°ï¼ˆmarkï¼‰ä¸é‡ç½®ï¼ˆresetï¼‰ï¼šæ ‡è®°æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œé€šè¿‡ Buffer ä¸­çš„ mark() æ–¹æ³•æŒ‡å®š Buffer ä¸­ä¸€ä¸ªç‰¹å®šçš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ reset() æ–¹æ³•æ¢å¤åˆ°è¿™ä¸ª position</p>
</li>
<li>
<p>ä½ç½®ã€é™åˆ¶ã€å®¹é‡éµå®ˆä»¥ä¸‹ä¸å˜å¼ï¼š <strong>0 &lt;= position &lt;= limit &lt;= capacity</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--NIO-Buffer%E6%93%8D%E4%BD%9C.png" style="zoom:67%;" />
</li>
</ul>
<hr>
<h4 id="å¸¸ç”¨-API-2">å¸¸ç”¨ API</h4>
<p><code>static XxxBuffer allocate(int capacity)</code>ï¼šåˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º capacity çš„ XxxBuffer å¯¹è±¡</p>
<p>Buffer åŸºæœ¬æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public Buffer clear()</td>
<td>æ¸…ç©ºç¼“å†²åŒºï¼Œä¸æ¸…ç©ºå†…å®¹ï¼Œå°†ä½ç½®è®¾ç½®ä¸ºé›¶ï¼Œé™åˆ¶è®¾ç½®ä¸ºå®¹é‡</td>
</tr>
<tr>
<td>public Buffer flip()</td>
<td>ç¿»è½¬ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºçš„ç•Œé™è®¾ç½®ä¸ºå½“å‰ä½ç½®ï¼Œposition ç½® 0</td>
</tr>
<tr>
<td>public int capacity()</td>
<td>è¿”å› Buffer çš„ capacity å¤§å°</td>
</tr>
<tr>
<td>public final int limit()</td>
<td>è¿”å› Buffer çš„ç•Œé™ limit çš„ä½ç½®</td>
</tr>
<tr>
<td>public Buffer limit(int n)</td>
<td>è®¾ç½®ç¼“å†²åŒºç•Œé™ä¸º n</td>
</tr>
<tr>
<td>public Buffer mark()</td>
<td>åœ¨æ­¤ä½ç½®å¯¹ç¼“å†²åŒºè®¾ç½®æ ‡è®°</td>
</tr>
<tr>
<td>public final int position()</td>
<td>è¿”å›ç¼“å†²åŒºçš„å½“å‰ä½ç½® position</td>
</tr>
<tr>
<td>public Buffer position(int n)</td>
<td>è®¾ç½®ç¼“å†²åŒºçš„å½“å‰ä½ç½®ä¸º n</td>
</tr>
<tr>
<td>public Buffer reset()</td>
<td>å°†ä½ç½® position é‡ç½®ä¸ºå…ˆå‰ mark æ ‡è®°çš„ä½ç½®</td>
</tr>
<tr>
<td>public Buffer rewind()</td>
<td>å°†ä½ç½®è®¾ä¸ºä¸º 0ï¼Œå–æ¶ˆè®¾ç½®çš„ mark</td>
</tr>
<tr>
<td>public final int remaining()</td>
<td>è¿”å›å½“å‰ä½ç½® position å’Œ limit ä¹‹é—´çš„å…ƒç´ ä¸ªæ•°</td>
</tr>
<tr>
<td>public final boolean hasRemaining()</td>
<td>åˆ¤æ–­ç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰å…ƒç´ </td>
</tr>
<tr>
<td>public static ByteBuffer wrap(byte[] array)</td>
<td>å°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„åŒ…è£…åˆ°ç¼“å†²åŒºä¸­</td>
</tr>
<tr>
<td>abstract ByteBuffer asReadOnlyBuffer()</td>
<td>åˆ›å»ºä¸€ä¸ªæ–°çš„åªè¯»å­—èŠ‚ç¼“å†²åŒº</td>
</tr>
<tr>
<td>public abstract ByteBuffer compact()</td>
<td>ç¼“å†²åŒºå½“å‰ä½ç½®ä¸å…¶é™åˆ¶ï¼ˆå¦‚æœæœ‰ï¼‰ä¹‹é—´çš„å­—èŠ‚è¢«å¤åˆ¶åˆ°ç¼“å†²åŒºçš„å¼€å¤´</td>
</tr>
</tbody>
</table>
<p>Buffer æ•°æ®æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public abstract byte get()</td>
<td>è¯»å–è¯¥ç¼“å†²åŒºå½“å‰ä½ç½®çš„å•ä¸ªå­—èŠ‚ï¼Œç„¶åä½ç½® + 1</td>
</tr>
<tr>
<td>public ByteBuffer get(byte[] dst)</td>
<td>è¯»å–å¤šä¸ªå­—èŠ‚åˆ°å­—èŠ‚æ•°ç»„ dst ä¸­</td>
</tr>
<tr>
<td>public abstract byte get(int index)</td>
<td>è¯»å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å­—èŠ‚ï¼Œä¸ç§»åŠ¨ position</td>
</tr>
<tr>
<td>public abstract ByteBuffer put(byte b)</td>
<td>å°†ç»™å®šå•ä¸ªå­—èŠ‚å†™å…¥ç¼“å†²åŒºçš„å½“å‰ä½ç½®ï¼Œposition+1</td>
</tr>
<tr>
<td>public final ByteBuffer put(byte[] src)</td>
<td>å°† src å­—èŠ‚æ•°ç»„å†™å…¥ç¼“å†²åŒºçš„å½“å‰ä½ç½®</td>
</tr>
<tr>
<td>public abstract ByteBuffer put(int index, byte b)</td>
<td>å°†æŒ‡å®šå­—èŠ‚å†™å…¥ç¼“å†²åŒºçš„ç´¢å¼•ä½ç½®ï¼Œä¸ç§»åŠ¨ position</td>
</tr>
</tbody>
</table>
<p>æç¤ºï¼šâ€œ\nâ€ï¼Œå ç”¨ä¸¤ä¸ªå­—èŠ‚</p>
<hr>
<h4 id="è¯»å†™æ•°æ®">è¯»å†™æ•°æ®</h4>
<p>ä½¿ç”¨ Buffer è¯»å†™æ•°æ®ä¸€èˆ¬éµå¾ªä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>å†™å…¥æ•°æ®åˆ° Buffer</li>
<li>è°ƒç”¨ flip()æ–¹æ³•ï¼Œè½¬æ¢ä¸ºè¯»å–æ¨¡å¼</li>
<li>ä» Buffer ä¸­è¯»å–æ•°æ®</li>
<li>è°ƒç”¨ buffer.clear() æ–¹æ³•æ¸…é™¤ç¼“å†²åŒºï¼ˆä¸æ˜¯æ¸…ç©ºäº†æ•°æ®ï¼Œåªæ˜¯é‡ç½®æŒ‡é’ˆï¼‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBuffer</span> &#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;seazean&quot;</span>;</span><br><span class="line">		<span class="comment">//1. åˆ†é…ä¸€ä¸ªæŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span></span><br><span class="line">		<span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;-----------------allocate()----------------&quot;</span>);</span><br><span class="line">		System.out.println(bufferf.position());<span class="comment">//0</span></span><br><span class="line">		System.out.println(buffer.limit());<span class="comment">//1024</span></span><br><span class="line">		System.out.println(buffer.capacity());<span class="comment">//1024</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. åˆ©ç”¨ put() å­˜å…¥æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">      	buffer.put(str.getBytes());</span><br><span class="line">     	System.out.println(<span class="string">&quot;-----------------put()----------------&quot;</span>);</span><br><span class="line">		System.out.println(bufferf.position());<span class="comment">//7</span></span><br><span class="line">		System.out.println(buffer.limit());<span class="comment">//1024</span></span><br><span class="line">		System.out.println(buffer.capacity());<span class="comment">//1024</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. åˆ‡æ¢è¯»å–æ•°æ®æ¨¡å¼</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------flip()----------------&quot;</span>);</span><br><span class="line">        System.out.println(buffer.position());<span class="comment">//0</span></span><br><span class="line">        System.out.println(buffer.limit());<span class="comment">//7</span></span><br><span class="line">        System.out.println(buffer.capacity());<span class="comment">//1024</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. åˆ©ç”¨ get() è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®</span></span><br><span class="line">        <span class="type">byte</span>[] dst = <span class="keyword">new</span> <span class="title class_">byte</span>[buffer.limit()];</span><br><span class="line">        buffer.get(dst);</span><br><span class="line">        System.out.println(dst.length);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(dst, <span class="number">0</span>, dst.length));</span><br><span class="line">        System.out.println(buffer.position());<span class="comment">//7</span></span><br><span class="line">        System.out.println(buffer.limit());<span class="comment">//7</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. clear() : æ¸…ç©ºç¼“å†²åŒº. ä½†æ˜¯ç¼“å†²åŒºä¸­çš„æ•°æ®ä¾ç„¶å­˜åœ¨ï¼Œä½†æ˜¯å¤„äºâ€œè¢«é—å¿˜â€çŠ¶æ€</span></span><br><span class="line">        System.out.println(buffer.hasRemaining());<span class="comment">//true</span></span><br><span class="line">        buffer.clear();</span><br><span class="line">        System.out.println(buffer.hasRemaining());<span class="comment">//true</span></span><br><span class="line">      	System.out.println(<span class="string">&quot;-----------------clear()----------------&quot;</span>);</span><br><span class="line">      	System.out.println(buffer.position());<span class="comment">//0</span></span><br><span class="line">      	System.out.println(buffer.limit());<span class="comment">//1024</span></span><br><span class="line">      	System.out.println(buffer.capacity());<span class="comment">//1024</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ç²˜åŒ…æ‹†åŒ…">ç²˜åŒ…æ‹†åŒ…</h4>
<p>ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ \n è¿›è¡Œåˆ†éš”ï¼Œä½†è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hello,world\n</span></span><br><span class="line"><span class="comment">// I&#x27;m zhangsan\n</span></span><br><span class="line"><span class="comment">// How are you?\n</span></span><br><span class="line">------ &gt; é»åŒ…ï¼ŒåŠåŒ…</span><br><span class="line"><span class="comment">// Hello,world\nI&#x27;m zhangsan\nHo</span></span><br><span class="line"><span class="comment">// w are you?\n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">source</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">32</span>);</span><br><span class="line">    <span class="comment">//                     11            24</span></span><br><span class="line">    source.put(<span class="string">&quot;Hello,world\nI&#x27;m zhangsan\nHo&quot;</span>.getBytes());</span><br><span class="line">    split(source);</span><br><span class="line"></span><br><span class="line">    source.put(<span class="string">&quot;w are you?\nhaha!\n&quot;</span>.getBytes());</span><br><span class="line">    split(source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">split</span><span class="params">(ByteBuffer source)</span> &#123;</span><br><span class="line">    source.flip();</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldLimit</span> <span class="operator">=</span> source.limit();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldLimit; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source.get(i) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®æ•°æ®çš„é•¿åº¦è®¾ç½®ç¼“å†²åŒº</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">target</span> <span class="operator">=</span> ByteBuffer.allocate(i + <span class="number">1</span> - source.position());</span><br><span class="line">            <span class="comment">// 0 ~ limit</span></span><br><span class="line">            source.limit(i + <span class="number">1</span>);</span><br><span class="line">            target.put(source); <span class="comment">// ä»source è¯»ï¼Œå‘ target å†™</span></span><br><span class="line">            <span class="comment">// debugAll(target); è®¿é—® buffer çš„æ–¹æ³•</span></span><br><span class="line">            source.limit(oldLimit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¿é—®è¿‡çš„æ•°æ®å¤åˆ¶åˆ°å¼€å¤´</span></span><br><span class="line">    source.compact();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="ç›´æ¥å†…å­˜">ç›´æ¥å†…å­˜</h3>
<h4 id="åŸºæœ¬ä»‹ç»-7">åŸºæœ¬ä»‹ç»</h4>
<p>Byte Buffer æœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯åŸºäºç›´æ¥å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯éå †å†…å­˜ï¼‰ï¼Œå¦ä¸€ç§æ˜¯éç›´æ¥å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯å †å†…å­˜ï¼‰</p>
<p>Direct Memory ä¼˜ç‚¹ï¼š</p>
<ul>
<li>Java çš„ NIO åº“å…è®¸ Java ç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œä½¿ç”¨ native å‡½æ•°ç›´æ¥åˆ†é…å †å¤–å†…å­˜</li>
<li><strong>è¯»å†™æ€§èƒ½é«˜</strong>ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜</li>
<li>å¤§å¤§æé«˜ IO æ€§èƒ½ï¼Œé¿å…äº†åœ¨ Java å †å’Œ native å †æ¥å›å¤åˆ¶æ•°æ®</li>
</ul>
<p>ç›´æ¥å†…å­˜ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸èƒ½ä½¿ç”¨å†…æ ¸ç¼“å†²åŒº Page Cache çš„ç¼“å­˜ä¼˜åŠ¿ï¼Œæ— æ³•ç¼“å­˜æœ€è¿‘è¢«è®¿é—®çš„æ•°æ®å’Œä½¿ç”¨é¢„è¯»åŠŸèƒ½</li>
<li>åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜ï¼Œä¸å— JVM å†…å­˜å›æ”¶ç®¡ç†</li>
<li>å¯èƒ½å¯¼è‡´ OutOfMemoryError å¼‚å¸¸ï¼šOutOfMemoryError: Direct buffer memory</li>
<li>å›æ”¶ä¾èµ– System.gc() çš„è°ƒç”¨ï¼Œä½†è¿™ä¸ªè°ƒç”¨ JVM ä¸ä¿è¯æ‰§è¡Œã€ä¹Ÿä¸ä¿è¯ä½•æ—¶æ‰§è¡Œï¼Œè¡Œä¸ºæ˜¯ä¸å¯æ§çš„ã€‚ç¨‹åºä¸€èˆ¬éœ€è¦è‡ªè¡Œç®¡ç†ï¼Œæˆå¯¹å»è°ƒç”¨ mallocã€free</li>
</ul>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä¼ è¾“å¾ˆå¤§çš„æ•°æ®æ–‡ä»¶ï¼Œæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸå¾ˆé•¿ï¼Œå¯¼è‡´ Page Cache æ²¡æœ‰èµ·åˆ°ç¼“å­˜çš„ä½œç”¨ï¼Œä¸€èˆ¬é‡‡ç”¨ç›´æ¥ IO çš„æ–¹å¼</li>
<li>é€‚åˆé¢‘ç¹çš„ IO æ“ä½œï¼Œæ¯”å¦‚ç½‘ç»œå¹¶å‘åœºæ™¯</li>
</ul>
<p>æ•°æ®æµçš„è§’åº¦ï¼š</p>
<ul>
<li>éç›´æ¥å†…å­˜çš„ä½œç”¨é“¾ï¼šæœ¬åœ° IO â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ï¼ˆJVMï¼‰ç¼“å†²åŒº â†’ å†…æ ¸ç¼“å†²åŒº â†’ æœ¬åœ° IO</li>
<li>ç›´æ¥å†…å­˜æ˜¯ï¼šæœ¬åœ° IO â†’ ç›´æ¥å†…å­˜ â†’ æœ¬åœ° IO</li>
</ul>
<p>JVM ç›´æ¥å†…å­˜å›¾è§£ï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JVM-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E7%9B%B4%E6%8E%A5%E7%BC%93%E5%86%B2%E5%8C%BA.png" style="zoom: 50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--JVM-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E9%9D%9E%E7%9B%B4%E6%8E%A5%E7%BC%93%E5%86%B2%E5%8C%BA.png" style="zoom:50%;" />
<hr>
<h4 id="é€šä¿¡åŸç†">é€šä¿¡åŸç†</h4>
<p>å †å¤–å†…å­˜ä¸å— JVM GC æ§åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨å †å¤–å†…å­˜è¿›è¡Œé€šä¿¡ï¼Œé˜²æ­¢ GC åç¼“å†²åŒºä½ç½®å‘ç”Ÿå˜åŒ–çš„æƒ…å†µ</p>
<p>NIO ä½¿ç”¨çš„ SocketChannel ä¹Ÿæ˜¯ä½¿ç”¨çš„å †å¤–å†…å­˜ï¼Œæºç è§£æï¼š</p>
<ul>
<li>
<p>SocketChannel#write(java.nio.ByteBuffer) â†’ SocketChannelImpl#write(java.nio.ByteBuffer)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(ByteBuffer var1)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">     <span class="keyword">do</span> &#123;</span><br><span class="line">         var3 = IOUtil.write(<span class="built_in">this</span>.fd, var1, -<span class="number">1L</span>, nd);</span><br><span class="line">     &#125; <span class="keyword">while</span>(var3 == -<span class="number">3</span> &amp;&amp; <span class="built_in">this</span>.isOpen());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>IOUtil#write(java.io.FileDescriptor, java.nio.ByteBuffer, long, sun.nio.ch.NativeDispatcher)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(FileDescriptor var0, ByteBuffer var1, <span class="type">long</span> var2, NativeDispatcher var4)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€åˆ¤æ–­æ˜¯å¦æ˜¯ç›´æ¥å†…å­˜ï¼Œæ˜¯åˆ™ç›´æ¥å†™å‡ºï¼Œä¸æ˜¯åˆ™å°è£…åˆ°ç›´æ¥å†…å­˜ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> DirectBuffer) &#123;</span><br><span class="line">        <span class="keyword">return</span> writeFromNativeBuffer(var0, var1, var2, var4);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">        <span class="comment">// ä»å †å†…bufferæ‹·è´åˆ°å †å¤–buffer</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">var8</span> <span class="operator">=</span> Util.getTemporaryDirectBuffer(var7);</span><br><span class="line">        var8.put(var1);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">// ä»å †å¤–å†™åˆ°å†…æ ¸ç¼“å†²åŒº</span></span><br><span class="line">		<span class="type">int</span> <span class="variable">var9</span> <span class="operator">=</span> writeFromNativeBuffer(var0, var8, var2, var4);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¯»æ“ä½œç›¸åŒ</p>
</li>
</ul>
<hr>
<h4 id="åˆ†é…å›æ”¶">åˆ†é…å›æ”¶</h4>
<p>ç›´æ¥å†…å­˜åˆ›å»º Buffer å¯¹è±¡ï¼š<code>static XxxBuffer allocateDirect(int capacity)</code></p>
<p>DirectByteBuffer æºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DirectByteBuffer(<span class="type">int</span> cap) &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…ç›´æ¥å†…å­˜</span></span><br><span class="line">        base = unsafe.allocateMemory(size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†…å­˜èµ‹å€¼</span></span><br><span class="line">    unsafe.setMemory(base, size, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</span><br><span class="line">        address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        address = base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå›æ”¶å‡½æ•°</span></span><br><span class="line">    cleaner = Cleaner.create(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">Deallocator</span>(base, size, cap));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Deallocator</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        unsafe.freeMemory(address);</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ†é…å’Œå›æ”¶åŸç†</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨äº† Unsafe å¯¹è±¡çš„ allocateMemory æ–¹æ³•å®Œæˆç›´æ¥å†…å­˜çš„åˆ†é…ï¼ŒsetMemory æ–¹æ³•å®Œæˆèµ‹å€¼</li>
<li>ByteBuffer çš„å®ç°ç±»å†…éƒ¨ï¼Œä½¿ç”¨äº† Cleanerï¼ˆè™šå¼•ç”¨ï¼‰æ¥ç›‘æµ‹ ByteBuffer å¯¹è±¡ï¼Œä¸€æ—¦ ByteBuffer å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆ ReferenceHandler çº¿ç¨‹é€šè¿‡ Cleaner çš„ clean æ–¹æ³•è°ƒç”¨ Deallocator çš„ run æ–¹æ³•ï¼Œæœ€åé€šè¿‡ freeMemory æ¥é‡Šæ”¾ç›´æ¥å†…å­˜</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç›´æ¥å†…å­˜åˆ†é…çš„åº•å±‚åŸç†ï¼šUnsafe</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_27</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_1Gb</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> getUnsafe();</span><br><span class="line">        <span class="comment">// åˆ†é…å†…å­˜</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> unsafe.allocateMemory(_1Gb);</span><br><span class="line">        unsafe.setMemory(base, _1Gb, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line">        unsafe.freeMemory(base);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span> unsafe;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="å…±äº«å†…å­˜">å…±äº«å†…å­˜</h4>
<p>FileChannel æä¾› map æ–¹æ³•è¿”å› MappedByteBuffer å¯¹è±¡ï¼ŒæŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œé€šå¸¸æƒ…å†µå¯ä»¥æ˜ å°„æ•´ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶æ¯”è¾ƒå¤§ï¼Œå¯ä»¥è¿›è¡Œåˆ†æ®µæ˜ å°„ï¼Œå®Œæˆæ˜ å°„åå¯¹ç‰©ç†å†…å­˜çš„æ“ä½œä¼šè¢«<strong>åŒæ­¥</strong>åˆ°ç¡¬ç›˜ä¸Š</p>
<p>FileChannel ä¸­çš„æˆå‘˜å±æ€§ï¼š</p>
<ul>
<li>
<p>MapMode.modeï¼šå†…å­˜æ˜ åƒæ–‡ä»¶è®¿é—®çš„æ–¹å¼ï¼Œå…±ä¸‰ç§ï¼š</p>
<ul>
<li><code>MapMode.READ_ONLY</code>ï¼šåªè¯»ï¼Œä¿®æ”¹å¾—åˆ°çš„ç¼“å†²åŒºå°†å¯¼è‡´æŠ›å‡ºå¼‚å¸¸</li>
<li><code>MapMode.READ_WRITE</code>ï¼šè¯»/å†™ï¼Œå¯¹ç¼“å†²åŒºçš„æ›´æ”¹æœ€ç»ˆå°†å†™å…¥æ–‡ä»¶ï¼Œä½†æ­¤æ¬¡ä¿®æ”¹å¯¹æ˜ å°„åˆ°åŒä¸€æ–‡ä»¶çš„å…¶ä»–ç¨‹åºä¸ä¸€å®šæ˜¯å¯è§</li>
<li><code>MapMode.PRIVATE</code>ï¼šç§ç”¨ï¼Œå¯è¯»å¯å†™ï¼Œä½†æ˜¯ä¿®æ”¹çš„å†…å®¹ä¸ä¼šå†™å…¥æ–‡ä»¶ï¼Œåªæ˜¯ buffer è‡ªèº«çš„æ”¹å˜</li>
</ul>
</li>
<li>
<p><code>public final FileLock lock()</code>ï¼šè·å–æ­¤æ–‡ä»¶é€šé“çš„æ’ä»–é”</p>
</li>
</ul>
<p>MappedByteBufferï¼Œå¯ä»¥è®©æ–‡ä»¶åœ¨ç›´æ¥å†…å­˜ï¼ˆå †å¤–å†…å­˜ï¼‰ä¸­è¿›è¡Œä¿®æ”¹ï¼Œè¿™ç§æ–¹å¼å«åš<strong>å†…å­˜æ˜ å°„</strong>ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ç³»ç»Ÿåº•å±‚çš„ç¼“å­˜ï¼Œæ²¡æœ‰ JVM å’Œ OS ä¹‹é—´çš„å¤åˆ¶æ“ä½œï¼Œæé«˜äº†ä¼ è¾“æ•ˆç‡ï¼Œä½œç”¨ï¼š</p>
<ul>
<li><strong>å¯ä»¥ç”¨äºè¿›ç¨‹é—´çš„é€šä¿¡ï¼Œèƒ½è¾¾åˆ°å…±äº«å†…å­˜é¡µçš„ä½œç”¨</strong>ï¼Œä½†åœ¨é«˜å¹¶å‘ä¸‹è¦å¯¹æ–‡ä»¶å†…å­˜è¿›è¡ŒåŠ é”ï¼Œé˜²æ­¢å‡ºç°è¯»å†™å†…å®¹æ··ä¹±å’Œä¸ä¸€è‡´æ€§ï¼ŒJava æä¾›äº†æ–‡ä»¶é” FileLockï¼Œä½†åœ¨çˆ¶/å­è¿›ç¨‹ä¸­é”å®šåå¦ä¸€è¿›ç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼Œæ•ˆç‡ä¸é«˜</li>
<li>è¯»å†™é‚£äº›å¤ªå¤§è€Œä¸èƒ½æ”¾è¿›å†…å­˜ä¸­çš„æ–‡ä»¶ï¼Œ<strong>åˆ†æ®µæ˜ å°„</strong></li>
</ul>
<p>MappedByteBuffer è¾ƒä¹‹ ByteBuffer æ–°å¢çš„ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>final MappedByteBuffer force()</code>ï¼šç¼“å†²åŒºæ˜¯ READ_WRITE æ¨¡å¼ä¸‹ï¼Œå¯¹ç¼“å†²åŒºå†…å®¹çš„ä¿®æ”¹<strong>å¼ºåˆ¶å†™å…¥æ–‡ä»¶</strong></li>
<li><code>final MappedByteBuffer load()</code>ï¼šå°†ç¼“å†²åŒºçš„å†…å®¹è½½å…¥ç‰©ç†å†…å­˜ï¼Œå¹¶è¿”å›è¯¥ç¼“å†²åŒºçš„å¼•ç”¨</li>
<li><code>final boolean isLoaded()</code>ï¼šå¦‚æœç¼“å†²åŒºçš„å†…å®¹åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œåˆ™è¿”å›çœŸï¼Œå¦åˆ™è¿”å›å‡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MappedByteBufferTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è¯»å†™æ¨¡å¼</span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">ra</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">&quot;1.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–å¯¹åº”çš„é€šé“</span></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ra.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å‚æ•°1	FileChannel.MapMode.READ_WRITE ä½¿ç”¨çš„è¯»å†™æ¨¡å¼</span></span><br><span class="line"><span class="comment">         * å‚æ•°2	0: æ–‡ä»¶æ˜ å°„æ—¶çš„èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="comment">         * å‚æ•°3	5: æ˜¯æ˜ å°„åˆ°å†…å­˜çš„å¤§å°ï¼ˆä¸æ˜¯ç´¢å¼•ä½ç½®ï¼‰ï¼Œå³å°† 1.txt çš„å¤šå°‘ä¸ªå­—èŠ‚æ˜ å°„åˆ°å†…å­˜</span></span><br><span class="line"><span class="comment">         * å¯ä»¥ç›´æ¥ä¿®æ”¹çš„èŒƒå›´å°±æ˜¯ 0-5</span></span><br><span class="line"><span class="comment">         * å®é™…ç±»å‹ DirectByteBuffer</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">MappedByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> channel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        buffer.put(<span class="number">0</span>, (<span class="type">byte</span>) <span class="string">&#x27;H&#x27;</span>);</span><br><span class="line">        buffer.put(<span class="number">3</span>, (<span class="type">byte</span>) <span class="string">&#x27;9&#x27;</span>);</span><br><span class="line">        buffer.put(<span class="number">5</span>, (<span class="type">byte</span>) <span class="string">&#x27;Y&#x27;</span>);	<span class="comment">//IndexOutOfBoundsException</span></span><br><span class="line"></span><br><span class="line">        ra.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¿®æ”¹æˆåŠŸ~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ç¡¬ç›˜ä¸Šå°†æ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œè¦ç»è¿‡æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ•°æ®æ‹·è´ï¼Œæ‹·è´æ“ä½œæ˜¯ç”±æ–‡ä»¶ç³»ç»Ÿå’Œç¡¬ä»¶é©±åŠ¨å®ç°ã€‚é€šè¿‡å†…å­˜æ˜ å°„çš„æ–¹æ³•è®¿é—®ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œæ‹·è´æ•°æ®çš„æ•ˆç‡è¦æ¯” read å’Œ write ç³»ç»Ÿè°ƒç”¨é«˜ï¼š</p>
<ul>
<li>read() æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆå°†æ–‡ä»¶ä»ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œå†å°†è¿™äº›æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå®é™…ä¸Šè¿›è¡Œäº†ä¸¤æ¬¡æ•°æ®æ‹·è´</li>
<li>mmap() ä¹Ÿæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ²¡æœ‰è¿›è¡Œæ•°æ®æ‹·è´ï¼Œå½“ç¼ºé¡µä¸­æ–­å‘ç”Ÿæ—¶ï¼Œç›´æ¥å°†æ–‡ä»¶ä»ç¡¬ç›˜æ‹·è´åˆ°å…±äº«å†…å­˜ï¼Œåªè¿›è¡Œäº†ä¸€æ¬¡æ•°æ®æ‹·è´</li>
</ul>
<p>æ³¨æ„ï¼šmmap çš„æ–‡ä»¶æ˜ å°„ï¼Œåœ¨ Full GC æ—¶æ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œå¦‚æœéœ€è¦æ‰‹åŠ¨æ¸…é™¤å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå¯ä»¥åå°„è°ƒç”¨ sun.misc.Cleaner æ–¹æ³•</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f90866dcbffc">https://www.jianshu.com/p/f90866dcbffc</a></p>
<hr>
<h3 id="é€šé“">é€šé“</h3>
<h4 id="åŸºæœ¬ä»‹ç»-8">åŸºæœ¬ä»‹ç»</h4>
<p>é€šé“ï¼ˆChannelï¼‰ï¼šè¡¨ç¤º IO æºä¸ç›®æ ‡æ‰“å¼€çš„è¿æ¥ï¼ŒChannel ç±»ä¼¼äºä¼ ç»Ÿçš„æµï¼Œåªä¸è¿‡ Channel æœ¬èº«ä¸èƒ½ç›´æ¥è®¿é—®æ•°æ®ï¼ŒChannel åªèƒ½ä¸ Buffer <strong>è¿›è¡Œäº¤äº’</strong></p>
<ol>
<li>
<p>NIO çš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™</li>
<li>é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ®</li>
<li>é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†²</li>
</ul>
</li>
<li>
<p>BIO ä¸­çš„ Stream æ˜¯å•å‘çš„ï¼ŒNIO ä¸­çš„ Channel æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¯»æ“ä½œï¼Œä¹Ÿå¯ä»¥å†™æ“ä½œ</p>
</li>
<li>
<p>Channel åœ¨ NIO ä¸­æ˜¯ä¸€ä¸ªæ¥å£ï¼š<code>public interface Channel extends Closeable&#123;&#125;</code></p>
</li>
</ol>
<p>Channel å®ç°ç±»ï¼š</p>
<ul>
<li>
<p>FileChannelï¼šç”¨äºè¯»å–ã€å†™å…¥ã€æ˜ å°„å’Œæ“ä½œæ–‡ä»¶çš„é€šé“ï¼Œ<strong>åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹</strong></p>
<ul>
<li>é€šè¿‡ FileInputStream è·å–çš„ Channel åªèƒ½è¯»</li>
<li>é€šè¿‡ FileOutputStream è·å–çš„ Channel åªèƒ½å†™</li>
<li>é€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š</li>
</ul>
</li>
<li>
<p>DatagramChannelï¼šé€šè¿‡ UDP è¯»å†™ç½‘ç»œä¸­çš„æ•°æ®é€šé“</p>
</li>
<li>
<p>SocketChannelï¼šé€šè¿‡ TCP è¯»å†™ç½‘ç»œä¸­çš„æ•°æ®</p>
</li>
<li>
<p>ServerSocketChannelï¼šå¯ä»¥<strong>ç›‘å¬</strong>æ–°è¿›æ¥çš„ TCP è¿æ¥ï¼Œå¯¹æ¯ä¸€ä¸ªæ–°è¿›æ¥çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ª SocketChannel</p>
<p>æç¤ºï¼šServerSocketChanne ç±»ä¼¼ ServerSocketã€SocketChannel ç±»ä¼¼ Socket</p>
</li>
</ul>
<hr>
<h4 id="å¸¸ç”¨-API-3">å¸¸ç”¨ API</h4>
<p>è·å– Channel æ–¹å¼ï¼š</p>
<ul>
<li>å¯¹æ”¯æŒé€šé“çš„å¯¹è±¡è°ƒç”¨ <code>getChannel()</code> æ–¹æ³•</li>
<li>é€šè¿‡é€šé“çš„é™æ€æ–¹æ³• <code>open()</code> æ‰“å¼€å¹¶è¿”å›æŒ‡å®šé€šé“</li>
<li>ä½¿ç”¨ Files ç±»çš„é™æ€æ–¹æ³• <code>newByteChannel()</code> è·å–å­—èŠ‚é€šé“</li>
</ul>
<p>Channel åŸºæœ¬æ“ä½œï¼š<strong>è¯»å†™éƒ½æ˜¯ç›¸å¯¹äºå†…å­˜æ¥çœ‹ï¼Œä¹Ÿå°±æ˜¯ç¼“å†²åŒº</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public abstract int read(ByteBuffer dst)</td>
<td>ä» Channel ä¸­è¯»å–æ•°æ®åˆ° ByteBufferï¼Œä» position å¼€å§‹å‚¨å­˜</td>
</tr>
<tr>
<td>public final long read(ByteBuffer[] dsts)</td>
<td>å°† Channel ä¸­çš„æ•°æ®åˆ†æ•£åˆ° ByteBuffer[]</td>
</tr>
<tr>
<td>public abstract int write(ByteBuffer src)</td>
<td>å°† ByteBuffer ä¸­çš„æ•°æ®å†™å…¥ Channelï¼Œä» position å¼€å§‹å†™å‡º</td>
</tr>
<tr>
<td>public final long write(ByteBuffer[] srcs)</td>
<td>å°† ByteBuffer[] åˆ°ä¸­çš„æ•°æ®èšé›†åˆ° Channel</td>
</tr>
<tr>
<td>public abstract long position()</td>
<td>è¿”å›æ­¤é€šé“çš„æ–‡ä»¶ä½ç½®</td>
</tr>
<tr>
<td>FileChannel position(long newPosition)</td>
<td>è®¾ç½®æ­¤é€šé“çš„æ–‡ä»¶ä½ç½®</td>
</tr>
<tr>
<td>public abstract long size()</td>
<td>è¿”å›æ­¤é€šé“çš„æ–‡ä»¶çš„å½“å‰å¤§å°</td>
</tr>
</tbody>
</table>
<p><strong>SelectableChannel çš„æ“ä½œ API</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>SocketChannel accept()</td>
<td>å¦‚æœé€šé“å¤„äºéé˜»å¡æ¨¡å¼ï¼Œæ²¡æœ‰è¯·æ±‚è¿æ¥æ—¶æ­¤æ–¹æ³•å°†ç«‹å³è¿”å› NULLï¼Œå¦åˆ™å°†é˜»å¡ç›´åˆ°æœ‰æ–°çš„è¿æ¥æˆ–å‘ç”Ÿ I/O é”™è¯¯ï¼Œ<strong>é€šè¿‡è¯¥æ–¹æ³•è¿”å›çš„å¥—æ¥å­—é€šé“å°†å¤„äºé˜»å¡æ¨¡å¼</strong></td>
</tr>
<tr>
<td>SelectionKey register(Selector sel, int ops)</td>
<td>å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šï¼Œå¹¶æŒ‡å®šç›‘å¬äº‹ä»¶</td>
</tr>
<tr>
<td>SelectionKey register(Selector sel, int ops, Object att)</td>
<td>å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šï¼Œå¹¶åœ¨å½“å‰é€šé“<strong>ç»‘å®šä¸€ä¸ªé™„ä»¶å¯¹è±¡</strong>ï¼ŒObject ä»£è¡¨å¯ä»¥æ˜¯ä»»ä½•ç±»å‹</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="æ–‡ä»¶è¯»å†™">æ–‡ä»¶è¯»å†™</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"> 		<span class="comment">// 1ã€å­—èŠ‚è¾“å‡ºæµé€šå‘ç›®æ ‡æ–‡ä»¶</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;data01.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 2ã€å¾—åˆ°å­—èŠ‚è¾“å‡ºæµå¯¹åº”çš„é€šé“  ã€FileChannelã€‘</span></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">        <span class="comment">// 3ã€åˆ†é…ç¼“å†²åŒº</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        buffer.put(<span class="string">&quot;hello,é»‘é©¬Javaç¨‹åºå‘˜ï¼&quot;</span>.getBytes());</span><br><span class="line">        <span class="comment">// 4ã€æŠŠç¼“å†²åŒºåˆ‡æ¢æˆå†™å‡ºæ¨¡å¼</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        channel.write(buffer);</span><br><span class="line">        channel.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;å†™æ•°æ®åˆ°æ–‡ä»¶ä¸­ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1ã€å®šä¹‰ä¸€ä¸ªæ–‡ä»¶å­—èŠ‚è¾“å…¥æµä¸æºæ–‡ä»¶æ¥é€š</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;data01.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// 2ã€éœ€è¦å¾—åˆ°æ–‡ä»¶å­—èŠ‚è¾“å…¥æµçš„æ–‡ä»¶é€šé“</span></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">        <span class="comment">// 3ã€å®šä¹‰ä¸€ä¸ªç¼“å†²åŒº</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// 4ã€è¯»å–æ•°æ®åˆ°ç¼“å†²åŒº</span></span><br><span class="line">        channel.read(buffer);</span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="comment">// 5ã€è¯»å–å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶è¾“å‡ºå³å¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(),<span class="number">0</span>,buffer.remaining());</span><br><span class="line">        System.out.println(rs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="æ–‡ä»¶å¤åˆ¶">æ–‡ä»¶å¤åˆ¶</h4>
<p>Channel çš„æ–¹æ³•ï¼š<strong>sendfile å®ç°é›¶æ‹·è´</strong></p>
<ul>
<li>
<p><code>abstract long transferFrom(ReadableByteChannel src, long position, long count)</code>ï¼šä»ç»™å®šçš„å¯è¯»å­—èŠ‚é€šé“å°†å­—èŠ‚ä¼ è¾“åˆ°è¯¥é€šé“çš„æ–‡ä»¶ä¸­</p>
<ul>
<li>srcï¼šæºé€šé“</li>
<li>positionï¼šæ–‡ä»¶ä¸­è¦è¿›è¡Œä¼ è¾“çš„ä½ç½®ï¼Œå¿…é¡»æ˜¯éè´Ÿçš„</li>
<li>countï¼šè¦ä¼ è¾“çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œå¿…é¡»æ˜¯éè´Ÿçš„</li>
</ul>
</li>
<li>
<p><code>abstract long transferTo(long position, long count, WritableByteChannel target)</code>ï¼šå°†è¯¥é€šé“æ–‡ä»¶çš„å­—èŠ‚ä¼ è¾“åˆ°ç»™å®šçš„å¯å†™å­—èŠ‚é€šé“ã€‚</p>
<ul>
<li>positionï¼šä¼ è¾“å¼€å§‹çš„æ–‡ä»¶ä¸­çš„ä½ç½®; å¿…é¡»æ˜¯éè´Ÿçš„</li>
<li>countï¼šè¦ä¼ è¾“çš„æœ€å¤§å­—èŠ‚æ•°; å¿…é¡»æ˜¯éè´Ÿçš„</li>
<li>targetï¼šç›®æ ‡é€šé“</li>
</ul>
</li>
</ul>
<p>æ–‡ä»¶å¤åˆ¶çš„ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>Buffer</li>
<li>ä½¿ç”¨ä¸Šè¿°ä¸¤ç§æ–¹æ³•</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--NIO-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copy1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\å£çº¸.jpg&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">destFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\Users\\å£çº¸new.jpg&quot;</span>);</span><br><span class="line">        <span class="comment">// å¾—åˆ°ä¸€ä¸ªå­—èŠ‚å­—èŠ‚è¾“å…¥æµ</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(srcFile);</span><br><span class="line">        <span class="comment">// å¾—åˆ°ä¸€ä¸ªå­—èŠ‚è¾“å‡ºæµ</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destFile);</span><br><span class="line">        <span class="comment">// å¾—åˆ°çš„æ˜¯æ–‡ä»¶é€šé“</span></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">isChannel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">osChannel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">        <span class="comment">// åˆ†é…ç¼“å†²åŒº</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// å¿…é¡»å…ˆæ¸…ç©ºç¼“å†²ç„¶åå†å†™å…¥æ•°æ®åˆ°ç¼“å†²åŒº</span></span><br><span class="line">            buffer.clear();</span><br><span class="line">            <span class="comment">// å¼€å§‹è¯»å–ä¸€æ¬¡æ•°æ®</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> isChannel.read(buffer);</span><br><span class="line">            <span class="keyword">if</span>(flag == -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å·²ç»è¯»å–äº†æ•°æ® ï¼ŒæŠŠç¼“å†²åŒºçš„æ¨¡å¼åˆ‡æ¢æˆå¯è¯»æ¨¡å¼</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">// æŠŠæ•°æ®å†™å‡ºåˆ°</span></span><br><span class="line">            osChannel.write(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        isChannel.close();</span><br><span class="line">        osChannel.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;å¤åˆ¶å®Œæˆï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copy02</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    	<span class="comment">// 1ã€å­—èŠ‚è¾“å…¥ç®¡é“</span></span><br><span class="line">   	 	<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;data01.txt&quot;</span>);</span><br><span class="line">   	 	<span class="type">FileChannel</span> <span class="variable">isChannel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">    	<span class="comment">// 2ã€å­—èŠ‚è¾“å‡ºæµç®¡é“</span></span><br><span class="line">    	<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;data03.txt&quot;</span>);</span><br><span class="line">    	<span class="type">FileChannel</span> <span class="variable">osChannel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">    	<span class="comment">// 3ã€å¤åˆ¶</span></span><br><span class="line">    	osChannel.transferFrom(isChannel,isChannel.position(),isChannel.size());</span><br><span class="line">    	isChannel.close();</span><br><span class="line">    	osChannel.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copy03</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    	<span class="comment">// 1ã€å­—èŠ‚è¾“å…¥ç®¡é“</span></span><br><span class="line">    	<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;data01.txt&quot;</span>);</span><br><span class="line">    	<span class="type">FileChannel</span> <span class="variable">isChannel</span> <span class="operator">=</span> fis.getChannel();</span><br><span class="line">    	<span class="comment">// 2ã€å­—èŠ‚è¾“å‡ºæµç®¡é“</span></span><br><span class="line">    	<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;data04.txt&quot;</span>);</span><br><span class="line">    	<span class="type">FileChannel</span> <span class="variable">osChannel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">    	<span class="comment">// 3ã€å¤åˆ¶</span></span><br><span class="line">    	isChannel.transferTo(isChannel.position() , isChannel.size() , osChannel);</span><br><span class="line">    	isChannel.close();</span><br><span class="line">    	osChannel.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="åˆ†æ•£èšé›†">åˆ†æ•£èšé›†</h4>
<p>åˆ†æ•£è¯»å–ï¼ˆScatter ï¼‰ï¼šæ˜¯æŒ‡æŠŠ Channel é€šé“çš„æ•°æ®è¯»å…¥åˆ°å¤šä¸ªç¼“å†²åŒºä¸­å»</p>
<p>èšé›†å†™å…¥ï¼ˆGathering ï¼‰ï¼šæ˜¯æŒ‡å°†å¤šä¸ª Buffer ä¸­çš„æ•°æ®èšé›†åˆ° Channel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChannelTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    	<span class="comment">// 1ã€å­—èŠ‚è¾“å…¥ç®¡é“</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;data01.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">isChannel</span> <span class="operator">=</span> is.getChannel();</span><br><span class="line">        <span class="comment">// 2ã€å­—èŠ‚è¾“å‡ºæµç®¡é“</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;data02.txt&quot;</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">osChannel</span> <span class="operator">=</span> fos.getChannel();</span><br><span class="line">        <span class="comment">// 3ã€å®šä¹‰å¤šä¸ªç¼“å†²åŒºåšæ•°æ®åˆ†æ•£</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer1</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer2</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        ByteBuffer[] buffers = &#123;buffer1 , buffer2&#125;;</span><br><span class="line">        <span class="comment">// 4ã€ä»é€šé“ä¸­è¯»å–æ•°æ®åˆ†æ•£åˆ°å„ä¸ªç¼“å†²åŒº</span></span><br><span class="line">        isChannel.read(buffers);</span><br><span class="line">        <span class="comment">// 5ã€ä»æ¯ä¸ªç¼“å†²åŒºä¸­æŸ¥è¯¢æ˜¯å¦æœ‰æ•°æ®è¯»å–åˆ°äº†</span></span><br><span class="line">        <span class="keyword">for</span>(ByteBuffer buffer : buffers)&#123;</span><br><span class="line">            buffer.flip();<span class="comment">// åˆ‡æ¢åˆ°è¯»æ•°æ®æ¨¡å¼</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array() , <span class="number">0</span> , buffer.remaining()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6ã€èšé›†å†™å…¥åˆ°é€šé“</span></span><br><span class="line">        osChannel.write(buffers);</span><br><span class="line">        isChannel.close();</span><br><span class="line">        osChannel.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;æ–‡ä»¶å¤åˆ¶~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="é€‰æ‹©å™¨">é€‰æ‹©å™¨</h3>
<h4 id="åŸºæœ¬ä»‹ç»-9">åŸºæœ¬ä»‹ç»</h4>
<p>é€‰æ‹©å™¨ï¼ˆSelectorï¼‰ æ˜¯ SelectableChannle å¯¹è±¡çš„<strong>å¤šè·¯å¤ç”¨å™¨</strong>ï¼ŒSelector å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªé€šé“çš„çŠ¶å†µï¼Œåˆ©ç”¨ Selector å¯ä½¿ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ç®¡ç†å¤šä¸ª Channelï¼Œ<strong>Selector æ˜¯éé˜»å¡ IO çš„æ ¸å¿ƒ</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2025/09/30-14--NIO-Selector.png" alt=""></p>
<ul>
<li>Selector èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆå¤šä¸ª Channel ä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ª Selector)ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå°±è·å–äº‹ä»¶ç„¶åé’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥å’Œè¯·æ±‚</li>
<li>åªæœ‰åœ¨è¿æ¥/é€šé“çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç”¨å»ç»´æŠ¤å¤šä¸ªçº¿ç¨‹</li>
<li>é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€</li>
</ul>
<hr>
<h4 id="å¸¸ç”¨-API-4">å¸¸ç”¨ API</h4>
<p>åˆ›å»º Selectorï¼š<code>Selector selector = Selector.open();</code></p>
<p>å‘é€‰æ‹©å™¨æ³¨å†Œé€šé“ï¼š<code>SelectableChannel.register(Selector sel, int ops, Object att)</code></p>
<ul>
<li>å‚æ•°ä¸€ï¼šé€‰æ‹©å™¨ï¼ŒæŒ‡å®šå½“å‰ Channel æ³¨å†Œåˆ°çš„é€‰æ‹©å™¨</li>
<li>å‚æ•°äºŒï¼šé€‰æ‹©å™¨å¯¹é€šé“çš„ç›‘å¬äº‹ä»¶ï¼Œç›‘å¬çš„äº‹ä»¶ç±»å‹ç”¨å››ä¸ªå¸¸é‡è¡¨ç¤º
<ul>
<li>è¯» : SelectionKey.OP_READ ï¼ˆ1ï¼‰</li>
<li>å†™ : SelectionKey.OP_WRITE ï¼ˆ4ï¼‰</li>
<li>è¿æ¥ : SelectionKey.OP_CONNECT ï¼ˆ8ï¼‰</li>
<li>æ¥æ”¶ : SelectionKey.OP_ACCEPT ï¼ˆ16ï¼‰</li>
<li>è‹¥ä¸æ­¢ç›‘å¬ä¸€ä¸ªäº‹ä»¶ï¼Œä½¿ç”¨ä½æˆ–æ“ä½œç¬¦è¿æ¥ï¼š<code>int interest = SelectionKey.OP_READ | SelectionKey.OP_WRITE</code></li>
</ul>
</li>
<li>å‚æ•°ä¸‰ï¼šå¯ä»¥å…³è”ä¸€ä¸ªé™„ä»¶ï¼Œå¯ä»¥æ˜¯ä»»ä½•å¯¹è±¡</li>
</ul>
<p><strong>Selector API</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public static Selector open()</td>
<td>æ‰“å¼€é€‰æ‹©å™¨</td>
</tr>
<tr>
<td>public abstract void close()</td>
<td>å…³é—­æ­¤é€‰æ‹©å™¨</td>
</tr>
<tr>
<td>public abstract int select()</td>
<td><strong>é˜»å¡</strong>é€‰æ‹©ä¸€ç»„é€šé“å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œçš„é”®</td>
</tr>
<tr>
<td>public abstract int select(long timeout)</td>
<td><strong>é˜»å¡</strong>ç­‰å¾… timeout æ¯«ç§’</td>
</tr>
<tr>
<td>public abstract int selectNow()</td>
<td>è·å–ä¸€ä¸‹ï¼Œ<strong>ä¸é˜»å¡</strong>ï¼Œç«‹åˆ»è¿”å›</td>
</tr>
<tr>
<td>public abstract Selector wakeup()</td>
<td>å”¤é†’æ­£åœ¨é˜»å¡çš„ selector</td>
</tr>
<tr>
<td>public abstract Set<SelectionKey> selectedKeys()</td>
<td>è¿”å›æ­¤é€‰æ‹©å™¨çš„é€‰æ‹©é”®é›†</td>
</tr>
</tbody>
</table>
<p>SelectionKey API:</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public abstract void cancel()</td>
<td>å–æ¶ˆè¯¥é”®çš„é€šé“ä¸å…¶é€‰æ‹©å™¨çš„æ³¨å†Œ</td>
</tr>
<tr>
<td>public abstract SelectableChannel channel()</td>
<td>è¿”å›åˆ›å»ºæ­¤é”®çš„é€šé“ï¼Œè¯¥æ–¹æ³•åœ¨å–æ¶ˆé”®ä¹‹åä»å°†è¿”å›é€šé“</td>
</tr>
<tr>
<td>public final Object attachment()</td>
<td>è¿”å›å½“å‰ key å…³è”çš„é™„ä»¶</td>
</tr>
<tr>
<td>public final boolean isAcceptable()</td>
<td>æ£€æµ‹æ­¤å¯†é’¥çš„é€šé“æ˜¯å¦å·²å‡†å¤‡å¥½æ¥å—æ–°çš„å¥—æ¥å­—è¿æ¥</td>
</tr>
<tr>
<td>public final boolean isConnectable()</td>
<td>æ£€æµ‹æ­¤å¯†é’¥çš„é€šé“æ˜¯å¦å·²å®Œæˆæˆ–æœªå®Œæˆå…¶å¥—æ¥å­—è¿æ¥æ“ä½œ</td>
</tr>
<tr>
<td>public final boolean isReadable()</td>
<td>æ£€æµ‹æ­¤å¯†é’¥çš„é¢‘é“æ˜¯å¦å¯ä»¥é˜…è¯»</td>
</tr>
<tr>
<td>public final boolean isWritable()</td>
<td>æ£€æµ‹æ­¤å¯†é’¥çš„é€šé“æ˜¯å¦å‡†å¤‡å¥½è¿›è¡Œå†™å…¥</td>
</tr>
</tbody>
</table>
<p>åŸºæœ¬æ­¥éª¤ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.è·å–é€šé“</span></span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">ssChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line"><span class="comment">//2.åˆ‡æ¢éé˜»å¡æ¨¡å¼</span></span><br><span class="line">ssChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//3.ç»‘å®šè¿æ¥</span></span><br><span class="line">ssChannel.bin(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>));</span><br><span class="line"><span class="comment">//4.è·å–é€‰æ‹©å™¨</span></span><br><span class="line"><span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"><span class="comment">//5.å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šï¼Œå¹¶ä¸”æŒ‡å®šâ€œç›‘å¬æ¥æ”¶äº‹ä»¶â€</span></span><br><span class="line">ssChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="NIO-å®ç°">NIO å®ç°</h3>
<h4 id="å¸¸ç”¨-API-5">å¸¸ç”¨ API</h4>
<ul>
<li>
<p>SelectableChannel_API</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public final SelectableChannel configureBlocking(boolean block)</td>
<td>è®¾ç½®æ­¤é€šé“çš„é˜»å¡æ¨¡å¼</td>
</tr>
<tr>
<td>public final SelectionKey register(Selector sel, int ops)</td>
<td>å‘ç»™å®šçš„é€‰æ‹©å™¨æ³¨å†Œæ­¤é€šé“ï¼Œå¹¶é€‰æ‹©å…³æ³¨çš„çš„äº‹ä»¶</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>SocketChannel_APIï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">public static SocketChannel open()</td>
<td>æ‰“å¼€å¥—æ¥å­—é€šé“</td>
</tr>
<tr>
<td style="text-align:left">public static SocketChannel open(SocketAddress remote)</td>
<td>æ‰“å¼€å¥—æ¥å­—é€šé“å¹¶è¿æ¥åˆ°è¿œç¨‹åœ°å€</td>
</tr>
<tr>
<td style="text-align:left">public abstract boolean connect(SocketAddress remote)</td>
<td>è¿æ¥æ­¤é€šé“çš„åˆ°è¿œç¨‹åœ°å€</td>
</tr>
<tr>
<td style="text-align:left">public abstract SocketChannel bind(SocketAddress local)</td>
<td>å°†é€šé“çš„å¥—æ¥å­—ç»‘å®šåˆ°æœ¬åœ°åœ°å€</td>
</tr>
<tr>
<td style="text-align:left">public abstract SocketAddress getLocalAddress()</td>
<td>è¿”å›å¥—æ¥å­—ç»‘å®šçš„æœ¬åœ°å¥—æ¥å­—åœ°å€</td>
</tr>
<tr>
<td style="text-align:left">public abstract SocketAddress getRemoteAddress()</td>
<td>è¿”å›å¥—æ¥å­—è¿æ¥çš„è¿œç¨‹å¥—æ¥å­—åœ°å€</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>ServerSocketChannel_APIï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>public static ServerSocketChannel open()</td>
<td>æ‰“å¼€æœåŠ¡å™¨å¥—æ¥å­—é€šé“</td>
</tr>
<tr>
<td>public final ServerSocketChannel bind(SocketAddress local)</td>
<td>å°†é€šé“çš„å¥—æ¥å­—ç»‘å®šåˆ°æœ¬åœ°åœ°å€ï¼Œå¹¶é…ç½®å¥—æ¥å­—ä»¥ç›‘å¬è¿æ¥</td>
</tr>
<tr>
<td>public abstract SocketChannel accept()</td>
<td>æ¥å—ä¸æ­¤é€šé“å¥—æ¥å­—çš„è¿æ¥ï¼Œé€šè¿‡æ­¤æ–¹æ³•è¿”å›çš„å¥—æ¥å­—é€šé“å°†å¤„äºé˜»å¡æ¨¡å¼</td>
</tr>
</tbody>
</table>
<ul>
<li>å¦‚æœ ServerSocketChannel å¤„äºéé˜»å¡æ¨¡å¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‚èµ·è¿æ¥ï¼Œåˆ™æ­¤æ–¹æ³•å°†ç«‹å³è¿”å› null</li>
<li>å¦‚æœé€šé“å¤„äºé˜»å¡æ¨¡å¼ï¼Œå¦‚æœæ²¡æœ‰æŒ‚èµ·è¿æ¥å°†æ— é™æœŸåœ°é˜»å¡ï¼Œç›´åˆ°æœ‰æ–°çš„è¿æ¥æˆ–å‘ç”Ÿ I/O é”™è¯¯</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ä»£ç å®ç°">ä»£ç å®ç°</h4>
<p>æœåŠ¡ç«¯ ï¼š</p>
<ol>
<li>
<p>è·å–é€šé“ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šé€šè¿‡ <code>ServerSocketChannel.accept</code> å¾—åˆ° SocketChannel</p>
</li>
<li>
<p>åˆ‡æ¢éé˜»å¡æ¨¡å¼</p>
</li>
<li>
<p>ç»‘å®šè¿æ¥</p>
</li>
<li>
<p>è·å–é€‰æ‹©å™¨</p>
</li>
<li>
<p>å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šï¼Œå¹¶ä¸”æŒ‡å®šç›‘å¬æ¥æ”¶äº‹ä»¶</p>
</li>
<li>
<p><strong>è½®è¯¢å¼</strong>çš„è·å–é€‰æ‹©å™¨ä¸Šå·²ç»å‡†å¤‡å°±ç»ªçš„äº‹ä»¶</p>
</li>
</ol>
<p>å®¢æˆ·ç«¯ï¼š</p>
<ol>
<li>è·å–é€šé“ï¼š<code>SocketChannel sc = SocketChannel.open(new InetSocketAddress(HOST, PORT))</code></li>
<li>åˆ‡æ¢éé˜»å¡æ¨¡å¼</li>
<li>åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒºï¼š<code>ByteBuffer buffer = ByteBuffer.allocate(1024)</code></li>
<li>å‘é€æ•°æ®ç»™æœåŠ¡ç«¯</li>
</ol>
<p>37 è¡Œä»£ç ï¼Œå¦‚æœåˆ¤æ–­æ¡ä»¶æ”¹ä¸º !=-1ï¼Œéœ€è¦å®¢æˆ·ç«¯ close ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="comment">// 1ã€è·å–é€šé“</span></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        <span class="comment">// 2ã€åˆ‡æ¢ä¸ºéé˜»å¡æ¨¡å¼</span></span><br><span class="line">        serverSocketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 3ã€ç»‘å®šè¿æ¥çš„ç«¯å£</span></span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">9999</span>));</span><br><span class="line">        <span class="comment">// 4ã€è·å–é€‰æ‹©å™¨Selector</span></span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="comment">// 5ã€å°†é€šé“éƒ½æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šå»ï¼Œå¹¶ä¸”å¼€å§‹æŒ‡å®šç›‘å¬æ¥æ”¶äº‹ä»¶</span></span><br><span class="line">        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">		<span class="comment">// 6ã€ä½¿ç”¨Selectoré€‰æ‹©å™¨é˜»å¡ç­‰å¾…è½®å·²ç»å°±ç»ªå¥½çš„äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">while</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;----å¼€å§‹æ–°ä¸€è½®çš„æ—¶é—´å¤„ç†----&quot;</span>);</span><br><span class="line">            <span class="comment">// 7ã€è·å–é€‰æ‹©å™¨ä¸­çš„æ‰€æœ‰æ³¨å†Œçš„é€šé“ä¸­å·²ç»å°±ç»ªå¥½çš„äº‹ä»¶</span></span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; it = selectionKeys.iterator();</span><br><span class="line">            <span class="comment">// 8ã€å¼€å§‹éå†è¿™äº›å‡†å¤‡å¥½çš„äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> it.next();<span class="comment">// æå–å½“å‰è¿™ä¸ªäº‹ä»¶</span></span><br><span class="line">                <span class="comment">// 9ã€åˆ¤æ–­è¿™ä¸ªäº‹ä»¶å…·ä½“æ˜¯ä»€ä¹ˆ</span></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    <span class="comment">// 10ã€ç›´æ¥è·å–å½“å‰æ¥å…¥çš„å®¢æˆ·ç«¯é€šé“</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                    <span class="comment">// 11 ã€åˆ‡æ¢æˆéé˜»å¡æ¨¡å¼</span></span><br><span class="line">                    socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     ByteBuffer buffer = ByteBuffer.allocate(16);</span></span><br><span class="line"><span class="comment">                	 // å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶ã€å…³è”ã€‘åˆ° selectionKey ä¸Š</span></span><br><span class="line"><span class="comment">                	 SelectionKey scKey = sc.register(selector, 0, buffer);</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    <span class="comment">// 12ã€å°†æœ¬å®¢æˆ·ç«¯é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨</span></span><br><span class="line">                    socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    <span class="comment">// 13ã€è·å–å½“å‰é€‰æ‹©å™¨ä¸Šçš„è¯»å°±ç»ªäº‹ä»¶</span></span><br><span class="line">                    <span class="type">SelectableChannel</span> <span class="variable">channel</span> <span class="operator">=</span> key.channel();</span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> (SocketChannel) channel;</span><br><span class="line">                    <span class="comment">// 14ã€è¯»å–æ•°æ®</span></span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                    <span class="comment">// è·å–å…³è”çš„é™„ä»¶</span></span><br><span class="line">                    <span class="comment">// ByteBuffer buffer = (ByteBuffer) key.attachment();</span></span><br><span class="line">                    <span class="type">int</span> len;</span><br><span class="line">                    <span class="keyword">while</span> ((len = socketChannel.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        buffer.flip();</span><br><span class="line">                        System.out.println(socketChannel.getRemoteAddress() + <span class="string">&quot;:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, len));</span><br><span class="line">                        buffer.clear();<span class="comment">// æ¸…é™¤ä¹‹å‰çš„æ•°æ®</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ é™¤å½“å‰çš„ selectionKeyï¼Œé˜²æ­¢é‡å¤æ“ä½œ</span></span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1ã€è·å–é€šé“</span></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> SocketChannel.open(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9999</span>));</span><br><span class="line">        <span class="comment">// 2ã€åˆ‡æ¢æˆéé˜»å¡æ¨¡å¼</span></span><br><span class="line">        socketChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 3ã€åˆ†é…æŒ‡å®šç¼“å†²åŒºå¤§å°</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// 4ã€å‘é€æ•°æ®ç»™æœåŠ¡ç«¯</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            System.out.print(<span class="string">&quot;è¯·è¯´ï¼š&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> sc.nextLine();</span><br><span class="line">            buffer.put((<span class="string">&quot;Clientï¼š&quot;</span> + msg).getBytes());</span><br><span class="line">            buffer.flip();</span><br><span class="line">            socketChannel.write(buffer);</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="AIO">AIO</h2>
<p>Java AIO(NIO.2) ï¼š AsynchronousI/Oï¼Œå¼‚æ­¥éé˜»å¡ï¼Œé‡‡ç”¨äº† Proactor æ¨¡å¼ã€‚æœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªæœ‰æ•ˆè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯çš„ I/O è¯·æ±‚éƒ½æ˜¯ç”± OS å…ˆå®Œæˆäº†å†é€šçŸ¥æœåŠ¡å™¨åº”ç”¨å»å¯åŠ¨çº¿ç¨‹è¿›è¡Œå¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AIOå¼‚æ­¥éé˜»å¡ï¼ŒåŸºäºNIOçš„ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºNIO2<span class="number">.0</span></span><br><span class="line">  BIO                     NIO                                AIO</span><br><span class="line">Socket                SocketChannel                    AsynchronousSocketChannel</span><br><span class="line">ServerSocket          ServerSocketChannel	       AsynchronousServerSocketChannel</span><br></pre></td></tr></table></figure>
<p>å½“è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œè°ƒç”¨ API çš„ read æˆ– write æ–¹æ³•ï¼Œè¿™ä¸¤ç§æ–¹æ³•å‡ä¸ºå¼‚æ­¥çš„ï¼Œå®Œæˆåä¼šä¸»åŠ¨è°ƒç”¨å›è°ƒå‡½æ•°ï¼š</p>
<ul>
<li>å¯¹äºè¯»æ“ä½œï¼Œå½“æœ‰æµå¯è¯»å–æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†å¯è¯»çš„æµä¼ å…¥ read æ–¹æ³•çš„ç¼“å†²åŒº</li>
<li>å¯¹äºå†™æ“ä½œï¼Œå½“æ“ä½œç³»ç»Ÿå°† write æ–¹æ³•ä¼ é€’çš„æµå†™å…¥å®Œæ¯•æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¸»åŠ¨é€šçŸ¥åº”ç”¨ç¨‹åº</li>
</ul>
<p>åœ¨ JDK1.7 ä¸­ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¢«ç§°ä½œ NIO.2ï¼Œä¸»è¦åœ¨ Java.nio.channels åŒ…ä¸‹å¢åŠ äº†ä¸‹é¢å››ä¸ªå¼‚æ­¥é€šé“ï¼š<br>
AsynchronousSocketChannelã€AsynchronousServerSocketChannelã€AsynchronousFileChannelã€AsynchronousDatagramChannel</p>
<hr>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>å¹¶å‘ç¼–ç¨‹</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://angus9823.github.io/posts/498cfd8e.html">https://angus9823.github.io/posts/498cfd8e.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>AngusğŸ¥</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2025-09-30</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2025-09-30</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>å¹¶å‘ç¼–ç¨‹</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/iOne/weixinshoukuan.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/iOne/weixinshoukuan.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/iOne/zfbshoukuan.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/iOne/zfbshoukuan.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/undefined.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/TheCoverOfTheArticle/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230323110559.jpg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">AIå¤§æ¨¡å‹å¼€å‘å…¥é—¨-Pythoné‡ç‚¹ç¬”è®°</div></div></a></div><div class="next-post pull-right"><a href="/posts/undefined.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0145.WEBP" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Netty01-nio</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">JUC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B"><span class="toc-text">è¿›ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-text">å¯¹æ¯”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-text">çº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="toc-text">åˆ›å»ºçº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Thread"><span class="toc-text">Thread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Runnable"><span class="toc-text">Runnable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Callable"><span class="toc-text">Callable</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-text">çº¿ç¨‹æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API"><span class="toc-text">API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#run-start"><span class="toc-text">run start</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep-yield"><span class="toc-text">sleep yield</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#join"><span class="toc-text">join</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#interrupt"><span class="toc-text">interrupt</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E6%96%AD%E7%BA%BF%E7%A8%8B"><span class="toc-text">æ‰“æ–­çº¿ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E6%96%AD-park"><span class="toc-text">æ‰“æ–­ park</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="toc-text">ç»ˆæ­¢æ¨¡å¼</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#daemon"><span class="toc-text">daemon</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E6%8E%A8%E8%8D%90"><span class="toc-text">ä¸æ¨è</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%8E%9F%E7%90%86"><span class="toc-text">çº¿ç¨‹åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="toc-text">è¿è¡Œæœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6"><span class="toc-text">çº¿ç¨‹è°ƒåº¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AA%E6%9D%A5%E4%BC%98%E5%8C%96"><span class="toc-text">æœªæ¥ä¼˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="toc-text">çº¿ç¨‹çŠ¶æ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B"><span class="toc-text">æŸ¥çœ‹çº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5"><span class="toc-text">åŒæ­¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E7%95%8C%E5%8C%BA"><span class="toc-text">ä¸´ç•ŒåŒº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#syn-ed"><span class="toc-text">syn-ed</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%94%81"><span class="toc-text">ä½¿ç”¨é”</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%9D%97"><span class="toc-text">åŒæ­¥å—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95"><span class="toc-text">åŒæ­¥æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%85%AB%E9%94%81"><span class="toc-text">çº¿ç¨‹å…«é”</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">é”åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Monitor"><span class="toc-text">Monitor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-text">å­—èŠ‚ç </span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E5%8D%87%E7%BA%A7"><span class="toc-text">é”å‡çº§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B"><span class="toc-text">å‡çº§è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-text">åå‘é”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-text">è½»é‡çº§é”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%81%E8%86%A8%E8%83%80"><span class="toc-text">é”è†¨èƒ€</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E4%BC%98%E5%8C%96"><span class="toc-text">é”ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-text">è‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%81%E6%B6%88%E9%99%A4"><span class="toc-text">é”æ¶ˆé™¤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%81%E7%B2%97%E5%8C%96"><span class="toc-text">é”ç²—åŒ–</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%8A%8A%E9%94%81"><span class="toc-text">å¤šæŠŠé”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B4%BB%E8%B7%83%E6%80%A7"><span class="toc-text">æ´»è·ƒæ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-text">æ­»é”</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BD%A2%E6%88%90"><span class="toc-text">å½¢æˆ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D"><span class="toc-text">å®šä½</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B4%BB%E9%94%81"><span class="toc-text">æ´»é”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF"><span class="toc-text">é¥¥é¥¿</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-ify"><span class="toc-text">wait-ify</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="toc-text">ä»£ç ä¼˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#park-un"><span class="toc-text">park-un</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-text">å®‰å…¨åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F"><span class="toc-text">åŒæ­¥æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C"><span class="toc-text">ä¿æŠ¤æ€§æš‚åœ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%BB%BB%E5%8A%A1%E7%89%88"><span class="toc-text">å•ä»»åŠ¡ç‰ˆ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%89%88"><span class="toc-text">å¤šä»»åŠ¡ç‰ˆ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E8%BE%93%E5%87%BA"><span class="toc-text">é¡ºåºè¾“å‡º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%9B%BF%E8%BE%93%E5%87%BA"><span class="toc-text">äº¤æ›¿è¾“å‡º</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F"><span class="toc-text">å¼‚æ­¥æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%89%88"><span class="toc-text">ä¼ ç»Ÿç‰ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E7%89%88"><span class="toc-text">æ”¹è¿›ç‰ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97"><span class="toc-text">é˜»å¡é˜Ÿåˆ—</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98"><span class="toc-text">å†…å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JMM"><span class="toc-text">JMM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-text">å†…å­˜æ¨¡å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BA%A4%E4%BA%92"><span class="toc-text">å†…å­˜äº¤äº’</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E5%A4%A7%E7%89%B9%E6%80%A7"><span class="toc-text">ä¸‰å¤§ç‰¹æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-text">å¯è§æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-text">åŸå­æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-text">æœ‰åºæ€§</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cache"><span class="toc-text">cache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-text">ç¼“å­˜æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%BB%93%E6%9E%84"><span class="toc-text">ç¼“å­˜ç»“æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8"><span class="toc-text">ç¼“å­˜ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E5%85%B1%E4%BA%AB"><span class="toc-text">ä¼ªå…±äº«</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4"><span class="toc-text">ç¼“å­˜ä¸€è‡´</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-text">å¤„ç†æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile"><span class="toc-text">volatile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="toc-text">åŒæ­¥æœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92"><span class="toc-text">æŒ‡ä»¤é‡æ’</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-text">åº•å±‚åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4-2"><span class="toc-text">ç¼“å­˜ä¸€è‡´</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C"><span class="toc-text">å†…å­˜å±éšœ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%A4%E4%BA%92%E8%A7%84%E5%88%99"><span class="toc-text">äº¤äº’è§„åˆ™</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E7%AB%AF%E6%A3%80%E9%94%81"><span class="toc-text">åŒç«¯æ£€é”</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A3%80%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-text">æ£€é”æœºåˆ¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DCL-%E9%97%AE%E9%A2%98"><span class="toc-text">DCL é—®é¢˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-text">è§£å†³æ–¹æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ha-be"><span class="toc-text">ha-be</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-text">è®¾è®¡æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F-2"><span class="toc-text">ç»ˆæ­¢æ¨¡å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Balking"><span class="toc-text">Balking</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E9%94%81"><span class="toc-text">æ— é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS"><span class="toc-text">CAS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-text">ä¹è§‚é”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Atomic"><span class="toc-text">Atomic</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8-API"><span class="toc-text">å¸¸ç”¨ API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-text">åŸç†åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E5%BC%95%E7%94%A8"><span class="toc-text">åŸå­å¼•ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B0%E7%BB%84"><span class="toc-text">åŸå­æ•°ç»„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%9B%B4%E6%96%B0%E5%99%A8"><span class="toc-text">åŸå­æ›´æ–°å™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E7%B4%AF%E5%8A%A0%E5%99%A8"><span class="toc-text">åŸå­ç´¯åŠ å™¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adder"><span class="toc-text">Adder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-text">ä¼˜åŒ–æœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E5%85%B1%E4%BA%AB-2"><span class="toc-text">ä¼ªå…±äº«</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text">æºç è§£æ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABA"><span class="toc-text">ABA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unsafe"><span class="toc-text">Unsafe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#final"><span class="toc-text">final</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-text">ä¸å¯å˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#State"><span class="toc-text">State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Local"><span class="toc-text">Local</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-2"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">å¸¸ç”¨æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">åº”ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84"><span class="toc-text">åº•å±‚ç»“æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-text">æˆå‘˜å˜é‡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalMap"><span class="toc-text">LocalMap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-2"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E6%96%B9%E6%B3%95"><span class="toc-text">æ¸…ç†æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-text">å†…å­˜æ³„æ¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E4%BC%A0%E9%80%92"><span class="toc-text">å˜é‡ä¼ é€’</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-3"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-2"><span class="toc-text">å®ç°åŸç†</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">åŸºæœ¬æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97-2"><span class="toc-text">é˜»å¡é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-2"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="toc-text">æ ¸å¿ƒæ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E8%A1%A8%E9%98%9F%E5%88%97"><span class="toc-text">é“¾è¡¨é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A5%E9%98%9F%E5%87%BA%E9%98%9F"><span class="toc-text">å…¥é˜Ÿå‡ºé˜Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="toc-text">åŠ é”åˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83"><span class="toc-text">æ€§èƒ½æ¯”è¾ƒ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97"><span class="toc-text">åŒæ­¥é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-2"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E5%85%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">éå…¬å®ç°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E5%AE%9E%E7%8E%B0"><span class="toc-text">å…¬å¹³å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-Pool"><span class="toc-text">æ“ä½œ Pool</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F"><span class="toc-text">åˆ›å»ºæ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Executor"><span class="toc-text">Executor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Executors"><span class="toc-text">Executors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E8%A6%81%E6%B1%82"><span class="toc-text">å¼€å‘è¦æ±‚</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E6%96%B9%E6%B3%95"><span class="toc-text">æäº¤æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E6%96%B9%E6%B3%95"><span class="toc-text">å…³é—­æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8"><span class="toc-text">å¤„ç†å¼‚å¸¸</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">å·¥ä½œåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF"><span class="toc-text">çŠ¶æ€ä¿¡æ¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-3"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-3"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E6%96%B9%E6%B3%95-2"><span class="toc-text">æäº¤æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%BA%BF%E7%A8%8B"><span class="toc-text">æ·»åŠ çº¿ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%96%B9%E6%B3%95"><span class="toc-text">è¿è¡Œæ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E6%96%B9%E6%B3%95"><span class="toc-text">åœæ­¢æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Future"><span class="toc-text">Future</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%BD%BF%E7%94%A8"><span class="toc-text">çº¿ç¨‹ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-4"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-4"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-text">ä»»åŠ¡è°ƒåº¦</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Timer"><span class="toc-text">Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Scheduled"><span class="toc-text">Scheduled</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-5"><span class="toc-text">æˆå‘˜å±æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F-2"><span class="toc-text">æˆå‘˜å˜é‡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1"><span class="toc-text">å»¶è¿Ÿä»»åŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-text">å»¶è¿Ÿé˜Ÿåˆ—</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-5"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-text">æäº¤ä»»åŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-text">è¿è¡Œä»»åŠ¡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ForkJoin"><span class="toc-text">ForkJoin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">äº«å…ƒæ¨¡å¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%99%A8"><span class="toc-text">åŒæ­¥å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS"><span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3"><span class="toc-text">æ ¸å¿ƒæ€æƒ³</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-text">è®¾è®¡åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%AF%B9%E8%B1%A1"><span class="toc-text">æ¨¡æ¿å¯¹è±¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-text">è‡ªå®šä¹‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Re-Lock"><span class="toc-text">Re-Lock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E5%AF%B9%E6%AF%94"><span class="toc-text">é”å¯¹æ¯”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%94%81-2"><span class="toc-text">ä½¿ç”¨é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-text">å…¬å¹³é”</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-4"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E5%85%AC%E5%8E%9F%E7%90%86"><span class="toc-text">éå…¬åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E9%94%81"><span class="toc-text">åŠ é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E9%94%81"><span class="toc-text">è§£é”</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E5%8E%9F%E7%90%86"><span class="toc-text">å…¬å¹³åŸç†</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5"><span class="toc-text">å¯é‡å…¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD"><span class="toc-text">å¯æ‰“æ–­</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-5"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-3"><span class="toc-text">å®ç°åŸç†</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E8%B6%85%E6%97%B6"><span class="toc-text">é”è¶…æ—¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-6"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-4"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90"><span class="toc-text">å“²å­¦å®¶å°±é¤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-text">æ¡ä»¶å˜é‡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-7"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-5"><span class="toc-text">å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#await"><span class="toc-text">await</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#signal"><span class="toc-text">signal</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReadWrite"><span class="toc-text">ReadWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-text">è¯»å†™é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%BA%94%E7%94%A8"><span class="toc-text">ç¼“å­˜åº”ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-6"><span class="toc-text">å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-6"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">åŠ é”åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">è§£é”åŸç†</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stamped"><span class="toc-text">Stamped</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CountDown"><span class="toc-text">CountDown</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-8"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-7"><span class="toc-text">å®ç°åŸç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CyclicBarrier"><span class="toc-text">CyclicBarrier</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-9"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-8"><span class="toc-text">å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-7"><span class="toc-text">æˆå‘˜å±æ€§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-6"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore"><span class="toc-text">Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-10"><span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-9"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PROPAGATE"><span class="toc-text">PROPAGATE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exchanger"><span class="toc-text">Exchanger</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E5%8C%85"><span class="toc-text">å¹¶å‘åŒ…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConHashMap"><span class="toc-text">ConHashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E9%9B%86%E5%90%88"><span class="toc-text">å¹¶å‘é›†åˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E5%AF%B9%E6%AF%94"><span class="toc-text">é›†åˆå¯¹æ¯”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%AD%BB%E9%93%BE"><span class="toc-text">å¹¶å‘æ­»é“¾</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-8"><span class="toc-text">æˆå‘˜å±æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-text">å˜é‡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%B1%BB"><span class="toc-text">å†…éƒ¨ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="toc-text">ä»£ç å—</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-7"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%AE%BF%E5%AD%98"><span class="toc-text">æ•°æ®è®¿å­˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95"><span class="toc-text">æ·»åŠ æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E6%96%B9%E6%B3%95"><span class="toc-text">æ‰©å®¹æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95"><span class="toc-text">è·å–æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95"><span class="toc-text">åˆ é™¤æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK7-%E5%8E%9F%E7%90%86"><span class="toc-text">JDK7 åŸç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CopyOnWrite"><span class="toc-text">CopyOnWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-2"><span class="toc-text">åŸç†åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">å¼±ä¸€è‡´æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%A4%B1%E8%B4%A5"><span class="toc-text">å®‰å…¨å¤±è´¥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Collections"><span class="toc-text">Collections</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SkipListMap"><span class="toc-text">SkipListMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84-2"><span class="toc-text">åº•å±‚ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F-3"><span class="toc-text">æˆå‘˜å˜é‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-8"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95"><span class="toc-text">å…¶ä»–æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95-2"><span class="toc-text">æ·»åŠ æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%96%B9%E6%B3%95-2"><span class="toc-text">è·å–æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95-2"><span class="toc-text">åˆ é™¤æ–¹æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NoBlocking"><span class="toc-text">NoBlocking</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97"><span class="toc-text">éé˜»å¡é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95-2"><span class="toc-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E9%98%9F%E6%96%B9%E6%B3%95"><span class="toc-text">å…¥é˜Ÿæ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BA%E9%98%9F%E6%96%B9%E6%B3%95"><span class="toc-text">å‡ºé˜Ÿæ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95-9"><span class="toc-text">æˆå‘˜æ–¹æ³•</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">NET</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DES"><span class="toc-text">DES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="toc-text">ç½‘ç»œç¼–ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE"><span class="toc-text">é€šä¿¡åè®®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E6%A8%A1%E5%9E%8B"><span class="toc-text">Java æ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-O"><span class="toc-text">I&#x2F;O</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-%E6%A8%A1%E5%9E%8B"><span class="toc-text">IO æ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E7%A7%8D%E6%A8%A1%E5%9E%8B"><span class="toc-text">äº”ç§æ¨¡å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E5%BC%8F-IO"><span class="toc-text">é˜»å¡å¼ IO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%BC%8F"><span class="toc-text">éé˜»å¡å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8"><span class="toc-text">ä¿¡å·é©±åŠ¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-%E5%A4%8D%E7%94%A8"><span class="toc-text">IO å¤ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5-IO"><span class="toc-text">å¼‚æ­¥ IO</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-text">å¤šè·¯å¤ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#select"><span class="toc-text">select</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-text">å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-text">æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#poll"><span class="toc-text">poll</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#epoll"><span class="toc-text">epoll</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0-2"><span class="toc-text">å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-text">ç‰¹ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-text">ç³»ç»Ÿè°ƒç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%80%81"><span class="toc-text">å†…æ ¸æ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#80-%E4%B8%AD%E6%96%AD"><span class="toc-text">80 ä¸­æ–­</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-text">é›¶æ‹·è´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DMA"><span class="toc-text">DMA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BIO"><span class="toc-text">BIO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mmap"><span class="toc-text">mmap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sendfile"><span class="toc-text">sendfile</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BIO-2"><span class="toc-text">BIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Inet"><span class="toc-text">Inet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP"><span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-3"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-UDP"><span class="toc-text">å®ç° UDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F"><span class="toc-text">é€šè®¯æ–¹å¼</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP"><span class="toc-text">TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-4"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Socket"><span class="toc-text">Socket</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-TCP"><span class="toc-text">å®ç° TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-text">å¼€å‘æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%80%9A%E4%BF%A1"><span class="toc-text">å®ç°é€šä¿¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%AA%E5%BC%82%E6%AD%A5"><span class="toc-text">ä¼ªå¼‚æ­¥</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-text">æ–‡ä»¶ä¼ è¾“</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E6%B5%81"><span class="toc-text">å­—èŠ‚æµ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="toc-text">æ•°æ®æµ</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NIO"><span class="toc-text">NIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-5"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-10"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-text">ç¼“å†²åŒº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-6"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%B1%9E%E6%80%A7"><span class="toc-text">åŸºæœ¬å±æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8-API-2"><span class="toc-text">å¸¸ç”¨ API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E6%95%B0%E6%8D%AE"><span class="toc-text">è¯»å†™æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%98%E5%8C%85%E6%8B%86%E5%8C%85"><span class="toc-text">ç²˜åŒ…æ‹†åŒ…</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98"><span class="toc-text">ç›´æ¥å†…å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-7"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86"><span class="toc-text">é€šä¿¡åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E5%9B%9E%E6%94%B6"><span class="toc-text">åˆ†é…å›æ”¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-text">å…±äº«å†…å­˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%81%93"><span class="toc-text">é€šé“</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-8"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8-API-3"><span class="toc-text">å¸¸ç”¨ API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99"><span class="toc-text">æ–‡ä»¶è¯»å†™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6"><span class="toc-text">æ–‡ä»¶å¤åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%95%A3%E8%81%9A%E9%9B%86"><span class="toc-text">åˆ†æ•£èšé›†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-text">é€‰æ‹©å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-9"><span class="toc-text">åŸºæœ¬ä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8-API-4"><span class="toc-text">å¸¸ç”¨ API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NIO-%E5%AE%9E%E7%8E%B0"><span class="toc-text">NIO å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8-API-5"><span class="toc-text">å¸¸ç”¨ API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AIO"><span class="toc-text">AIO</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/nav/">ç½‘å€å¯¼èˆª</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://angus9823.github.io/assets/loading3.gif" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/gaoxiao.gif" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2023-2026</b></span><span><b>&nbsp;&nbsp;By AngusğŸ¥</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/08/30-14--hexo.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/08/30-14--butterfly.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/èŒICPå¤‡-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/08/30-14--github.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><script defer src="/js/emoji.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/canvas-nest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-heart.min.js" async="async" mobile="false"></script><script id="click-show-text" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-show-text.min.js" data-mobile="false" data-text="è‡­,å®" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://angus9823.github.io/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ å°è¢ã®ç®—æ³•å­¦ä¹ ç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://angus9823.github.io/categories/é­”æ”¹æ•™ç¨‹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ å°è¢ã®åšå®¢é­”æ”¹æ•™ç¨‹ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://angus9823.github.io/categories/Javaåç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ å°è¢ã®Javaåç«¯ç¬”è®° (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://angus9823.github.io/categories/æ¼”ç¤º/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ å°è¢ã®æ¡ˆä¾‹æ¼”ç¤ºç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://angus9823.github.io/categories/åŸºç¡€è¯­æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ å°è¢ã®åŸºç¡€è¯­æ³•ç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://angus9823.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/undefined.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0060.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-08-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/undefined.html&quot;);" href="javascript:void(0);" alt="">é»‘é©¬å‡½æ•°å¼ç¼–ç¨‹</a><div class="blog-slider__text">ã€Lambdaè¡¨è¾¾å¼ã€Streamæµã€å‡½æ•°å¼ç¼–ç¨‹ã€‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/undefined.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/13756432.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-15--IMG_0035.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-07-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/13756432.html&quot;);" href="javascript:void(0);" alt="">C++æé«˜ç¼–ç¨‹</a><div class="blog-slider__text">ã€æ¨¡æ¿ã€STLã€‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/13756432.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/218758f6.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0085.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/218758f6.html&quot;);" href="javascript:void(0);" alt="">C++æ ¸å¿ƒç¼–ç¨‹</a><div class="blog-slider__text">ã€å¼•ç”¨ã€ç±»å’Œå¯¹è±¡ã€å‡½æ•°ã€æ–‡ä»¶æ“ä½œã€‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/218758f6.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/dacacf22.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0058.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-05-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/dacacf22.html&quot;);" href="javascript:void(0);" alt="">CPP_åŸºç¡€å…¥é—¨</a><div class="blog-slider__text">ã€è®°å½•ä¸€ä¸‹23/5/18,å…¥èŒæ¾ä¸‹ã€åŠªåŠ›å·CPPã€‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/dacacf22.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/b44ebf5e.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0192.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/b44ebf5e.html&quot;);" href="javascript:void(0);" alt="">Javaé«˜çº§ç¼–ç¨‹</a><div class="blog-slider__text">Javaã€åŸºç¡€ä¸ç¨³ åœ°åŠ¨å±±æ‘‡ï¼ï¼ï¼ã€å¤šçº¿ç¨‹ã€Javaå¸¸ç”¨ç±»ã€æšä¸¾ç±»å’Œæ³¨è§£ã€Javaé›†åˆã€æ³›å‹ã€IOæµã€ç½‘ç»œç¼–ç¨‹ã€Javaåå°„æœºåˆ¶ã€Java8çš„å…¶ä»–æ–°ç‰¹æ€§ã€‘</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/b44ebf5e.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/499433c3.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0057.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-23</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/499433c3.html&quot;);" href="javascript:void(0);" alt="">JavaåŸºç¡€ç¼–ç¨‹</a><div class="blog-slider__text">Javaã€åŸºç¡€ä¸ç¨³ åœ°åŠ¨å±±æ‘‡ï¼ï¼ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/499433c3.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/4b0178e0.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-15--IMG_0042.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-24</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/4b0178e0.html&quot;);" href="javascript:void(0);" alt="">æ•°æ®ç»“æ„ä¸ç®—æ³•</a><div class="blog-slider__text">ç§ƒå¤´å°å®è´ã€å¿«æ¥å§ã€æ•°æ®ç»“æ„ä¸ç®—æ³•ã€</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/4b0178e0.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/37833df0.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0188.WEBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-21</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/37833df0.html&quot;);" href="javascript:void(0);" alt="">MySQLå†™åœ¨å‰é¢</a><div class="blog-slider__text">MySQLå‚è€ƒã€å­¦ä¹ å»ºè®®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/37833df0.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog-pic-rep.oss-cn-beijing.aliyuncs.com/2023/img/avatarOne.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">æµ‹è¯• Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">æµ‹è¯•åšå®¢ ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/924b0f3b.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora-picgo-repo.oss-cn-hangzhou.aliyuncs.com/uPicForMyBlog/2024/09/01-16--IMG_0050 (1).EBP" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/924b0f3b.html&quot;);" href="javascript:void(0);" alt="">æµ‹è¯•first æ–‡ç« </a><div class="blog-slider__text">æµ‹è¯•first æ–‡ç« </div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/924b0f3b.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>